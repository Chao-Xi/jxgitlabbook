
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Gitlab Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxgitlabbook/chap5/1gitlab-runner-install/">
      
      
        <link rel="prev" href="../../chap4/5gitlba_mon/">
      
      
        <link rel="next" href="../2gitlab_k8s/">
      
      
      <link rel="icon" href="../../images/logo.jpeg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>1 基于K8S安装部署Runner - Jacob GitLab Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="purple" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-k8srunner" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob GitLab Book" class="md-header__button md-logo" aria-label="Jacob GitLab Book" data-md-component="logo">
      
  <img src="../../images/logo.jpeg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob GitLab Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              1 基于K8S安装部署Runner
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxgitlabbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    jxgitlabbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob GitLab Book" class="md-nav__button md-logo" aria-label="Jacob GitLab Book" data-md-component="logo">
      
  <img src="../../images/logo.jpeg" alt="logo">

    </a>
    Jacob GitLab Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxgitlabbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    jxgitlabbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    GitLab Fundamentals
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            GitLab Fundamentals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap0/1proj/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project and Repositoires
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap0/4issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gitlab Issues and Timelines
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab 简介
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Gitlab 简介
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1gitlab_cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 Gitlab 基本介绍（CI/CD)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/2gitlab_branch_strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Gitlab branch Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/3gitlab_install_quick/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 安装配置Gitlab
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/4gitlab_install_k8s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 在Kubernetes上安装Gitlab
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab Runner配置&安装
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Gitlab Runner配置&安装
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/1gitruner_intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 GitLab Runner 简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/2gitrunner_install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 GitLab Runner安装注册配置管理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline 核心语法
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Pipeline 核心语法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/1gitlab_pip1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitLabCI系列之流水线语法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/2gitlab_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Gitlab CI 流水线构建优化 + Runner构建优化（持久化）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/3gitlab_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 配置复杂的 Gitlab CI/CD Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab工具链集成
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Gitlab工具链集成
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/1git_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 模板库设计Maven+NPM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/2git_sonar_pr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Gitlab 工具链集成-代码质量平台集成
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/3gitlab_artifact_docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 工具链集成-制品库集成
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/4gitlab_jemeter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 Gitlab 自动化测试集成
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/5gitlba_mon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 GitLabCI/CD Prom构建数据采集与监控
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab + Kubernetes集成
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Gitlab + Kubernetes集成
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    1 基于K8S安装部署Runner
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    1 基于K8S安装部署Runner
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chart" class="md-nav__link">
    <span class="md-ellipsis">
      配置Chart存储库
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      更新配置信息
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chart_1" class="md-nav__link">
    <span class="md-ellipsis">
      部署 chart
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k8s" class="md-nav__link">
    <span class="md-ellipsis">
      发布应用到K8S环境
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-k8s" class="md-nav__link">
    <span class="md-ellipsis">
      2 在 K8S 中发布应用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 在 K8S 中发布应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gitlabci-cidevops-java-servicegitlab-ciyml" class="md-nav__link">
    <span class="md-ellipsis">
      gitlabci-cidevops-java-service/.gitlab-ci.yml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-runner" class="md-nav__link">
    <span class="md-ellipsis">
      2 配置Runner 持久化构建缓存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 配置Runner 持久化构建缓存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gitlab-runner" class="md-nav__link">
    <span class="md-ellipsis">
      重建gitlab-runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      跑一个传统的打包流水线
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      解决构建缓存问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3 解决构建制品问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 解决构建制品问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valuesyaml" class="md-nav__link">
    <span class="md-ellipsis">
      values.yaml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#templatesconfigmapyml" class="md-nav__link">
    <span class="md-ellipsis">
      编辑templates/configmap.yml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2gitlab_k8s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Kubernetes 容器流水线
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3gitlab_notification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 Kubernetes 流水线构建消息通知
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4gitlab_distri_storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 Gitlab + minio 配置使用分布式缓存
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab流水线最佳实践
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Gitlab流水线最佳实践
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/1pip_init/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 流水线设计及提交
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/2pip_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 提交流水线设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/3pip_run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 流水线运行
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/4pip_secret/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 如何将Secrets扫描加入到GitLab Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    项目交付流水线
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            项目交付流水线
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/1deploy_pip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 项目交付流水线优化后模板库配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/2deploy_projs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 项目流水线(JAVA+NPM+安卓)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    gitlab Certified CICD
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            gitlab Certified CICD
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1cer_prep1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitLab Certified CI/CD Specialist Training
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2pip_prep1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Anatomy of a Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3Gitlab_pip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gitlab Pipeline 复习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/4Final_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gitlab 认证考题
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    gitlab Project Management
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            gitlab Project Management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/1Gitlab_branch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L1 Gitlab branch Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/2gitlab_workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L2 Gitflow Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/3Gitlab_branch_action/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L3 Gitlab branch Settup Action
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/4gitlab_project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L4 Agile Planning with GitLab
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/4gitlab_project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L4 Agile Planning with GitLab
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ArgoCD Project
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            ArgoCD Project
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/0gitops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0 GitOps 常用工具盘点
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/1argo2023_gitops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 使用 Argo CD 进行 GitOps 流水线改造- 2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/2Argo_Rollouts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 使用 Argo Rollouts 实现应用渐进式发布
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/3argo_dr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 DevOps中的Argo CD — 灾难恢复
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/4argo_rollouts_ab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 A/B测试: 如何使用Argo Rollouts 进行渐进式交付
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/6gitops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 GitOps 简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/7k8s_yaml_cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6 K8S YAML 资源清单管理方案
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../argo1/8cd_image_updater/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    7 ArgoCD Image Updater
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Github Action
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Github Action
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/1action_docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    基于GitHubActions同步Docker镜像实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/2action_workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitHub Action - CI/CD Pipeline with Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/3action_events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitHub Actions basic learning
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#chart" class="md-nav__link">
    <span class="md-ellipsis">
      配置Chart存储库
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      更新配置信息
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#chart_1" class="md-nav__link">
    <span class="md-ellipsis">
      部署 chart
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k8s" class="md-nav__link">
    <span class="md-ellipsis">
      发布应用到K8S环境
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-k8s" class="md-nav__link">
    <span class="md-ellipsis">
      2 在 K8S 中发布应用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 在 K8S 中发布应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gitlabci-cidevops-java-servicegitlab-ciyml" class="md-nav__link">
    <span class="md-ellipsis">
      gitlabci-cidevops-java-service/.gitlab-ci.yml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-runner" class="md-nav__link">
    <span class="md-ellipsis">
      2 配置Runner 持久化构建缓存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 配置Runner 持久化构建缓存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gitlab-runner" class="md-nav__link">
    <span class="md-ellipsis">
      重建gitlab-runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      跑一个传统的打包流水线
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      解决构建缓存问题
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3 解决构建制品问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 解决构建制品问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valuesyaml" class="md-nav__link">
    <span class="md-ellipsis">
      values.yaml
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#templatesconfigmapyml" class="md-nav__link">
    <span class="md-ellipsis">
      编辑templates/configmap.yml
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="1-k8srunner"><strong>1 基于K8S安装部署Runner</strong></h1>
<h3 id="chart"><strong>配置Chart存储库</strong></h3>
<pre><code>helm repo add gitlab https://charts.gitlab.io

helm repo list

$ helm repo list | grep gitlab
gitlab  https://charts.gitlab.io 


helm search repo -l gitlab/gitlab-runner
</code></pre>
<pre><code>helm fetch gitlab/gitlab-runner --version=0.44.0

tar zxvf gitlab-runner-0.44.0.tgz

$ tree gitlab-runner
gitlab-runner
├── CHANGELOG.md
├── CONTRIBUTING.md
├── Chart.yaml
├── LICENSE
├── Makefile
├── NOTICE
├── README.md
├── templates
│   ├── NOTES.txt
│   ├── _cache.tpl
│   ├── _env_vars.tpl
│   ├── _helpers.tpl
│   ├── configmap.yaml
│   ├── deployment.yaml
│   ├── hpa.yaml
│   ├── role-binding.yaml
│   ├── role.yaml
│   ├── secrets.yaml
│   ├── service-account.yaml
│   ├── service-session-server.yaml
│   ├── service.yaml
│   └── servicemonitor.yaml
└── values.yaml

1 directory, 22 files
</code></pre>
<h3 id="_1"><strong>更新配置信息</strong></h3>
<p><strong>values.yaml</strong></p>
<pre><code>image:
  registry: registry.gitlab.com
  image: gitlab-org/gitlab-runner
  # tag: alpine-v11.6.0

## 镜像下载策略
imagePullPolicy: IfNotPresent

## Gitlab服务器地址
gitlabUrl: http://127.0.0.1:32220

## runner注册token
runnerRegistrationToken: &quot;nzTshoYwsnCttkyzZBxE&quot;

## 终止之前注销所有跑步者
unregisterRunner: true

## 当停止管道时等待其作业终止时间
terminationGracePeriodSeconds: 3600

## 配置最大井发作业数
concurrent: 10

## 新作业检查间隔
checkInterval: 30

## GitlabRunner日志级别 debug, info, warn, error, fatal, panic
logLevel: info


sessionServer:
  enabled: false

## For RBAC support:
rbac:
  create: true
  resources: [&quot;pods&quot;, &quot;pods/exec&quot;, &quot;secrets&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;patch&quot;, &quot;delete&quot;]

 podSecurityPolicy:
    enabled: false
    resourceNames:
    - gitlab-runner

metrics:
  enabled: true

  portName: metrics

  port: 9252

  serviceMonitor:
    enabled: false

service:
  enabled: false

  type: ClusterIP
  locked: false
  tags: &quot;kubernetes-runner, k8s&quot;
</code></pre>
<blockquote>
<p>未创建rbac</p>
<p>ERROR: Job failed (system failure): pods is forbidden:
User "system:serviceaccount:gitlab-runner:default" cannot create resource "pods" in API group
in the namespace "gitlab-runner"</p>
</blockquote>
<pre><code>$ kubectl create ns gitlab-runner
namespace/gitlab-runner created
</code></pre>
<h3 id="chart_1"><strong>部署  chart</strong></h3>
<pre><code>helm3 template --dry-run k8s-runner gitlab-runner/ -n devops

$ helm3 install gitlab-runner gitlab-runner/ -n devops

NAME: gitlab-runner
LAST DEPLOYED: Fri Aug 26 23:21:45 2022
NAMESPACE: devops
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Your GitLab Runner should now be registered against the GitLab instance reachable at: &quot;http://127.0.0.1:32220&quot;

Runner namespace &quot;devops&quot; was found in runners.config template.
</code></pre>
<pre><code>helm upgrade gitlab-runner gitlab-runner -namespace devops
</code></pre>
<h3 id="k8s"><strong>发布应用到K8S环境</strong></h3>
<p><strong>运行流水线测试</strong>            </p>
<pre><code>image: maven:3.6.3-jdk-8

before_script:
    - ls

services:
    - name: mysql: latest
    - alias: mysql-1

build:
    image: maven: 3.6.3-jdk-8
    stage: build
    tags:
        - k8s
    script:
     - ls
   - sleep 2
   - echo &quot;mvn clean &quot;
   - sleep 10

deploy:
    stage: deploy
    tags:
        - k8s
    script:
        - echo &quot;deploy&quot;
    environment:
        name: production
        url: http://www.baidu.com
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_1_1.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_2.png" title="Body image" /></p>
<h2 id="2-k8s"><strong>2 在 K8S 中发布应用</strong></h2>
<h3 id="_2"><strong>准备工作</strong></h3>
<pre><code>kubectl create secret docker-registry cidevops
    --docker-server=registry.cn-beijing.aliyuncs.com\
    --docker-username=XXXX \
    --docker-password=xxxx\
    --docker-email=test@test.com -n cidevops
</code></pre>
<h3 id="_3"><strong>准备工作</strong></h3>
<p>创建名称空间</p>
<pre><code>kubectl create ns cidevops
</code></pre>
<p><strong><code>cidevops-gitlabci-service/jobs/deploy.yml</code></strong></p>
<pre><code>.deploy-k8s:
  stage: deploy
  tags:
    - build
  script:
    - sed -i &quot;s#__namespace__#${NAMESPACE}#g&quot; deployment.yaml 
    - sed -i &quot;s#__appname__#${APP_NAME}#g&quot; deployment.yaml 
    - sed -i &quot;s#__containerport__#${CONTAINER_PORT}#g&quot; deployment.yaml 
    - sed -i &quot;s#__nodeport__#${NODE_PORT}#g&quot; deployment.yaml 
    - sed -i &quot;s#__imagename__#${IMAGE_NAME}#g&quot; deployment.yaml 
    - kubectl apply -f deployment.yaml
  after_script:
   - sleep 10
   - kubectl get pod  -n $NAMESPACE
</code></pre>
<p><strong><code>cidevops-gitlabci-service/templates/k8s-java-pipeline.yml</code></strong></p>
<ul>
<li><code>stage: deploy</code></li>
</ul>
<pre><code>deploy_k8s:
  stage: deploy
  extends: .deploy-k8s
  rules:
    - if: &quot; $RUN_DEPLOY == 'no' &quot;
      when: never
    - if: &quot; $MANUAL_BRANCH  == 'master' &quot;
      when: manual
    - when: always
  environment:
    name: $ENV_NAME
    url: $ENV_URL
</code></pre>
<ul>
<li>完整： <strong><code>k8s-java-pipeline.yml</code></strong></li>
</ul>
<pre><code>include:
  - project: 'cidevops/cidevops-gitlabci-service'
    ref: master
    file: 'jobs/build.yml'
  - project: 'cidevops/cidevops-gitlabci-service'
    ref: master
    file: 'jobs/test.yml'
  - project: 'cidevops/cidevops-gitlabci-service'
    ref: master
    file: 'jobs/codeanalysis.yml'
  - project: 'cidevops/cidevops-gitlabci-service'
    ref: master
    file: 'jobs/deploy.yml'

variables:
  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID
  GIT_CHECKOUT: &quot;false&quot;
  MVN_OPTS: &quot;-Dmaven.repo.local=/home/gitlab-runner/m2&quot;
  BUILD_SHELL: 'mvn clean package  -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  --settings=./settings.xml'  ##构建命令
  TEST_SHELL : 'mvn test -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  --settings=./settings.xml'                        ##测试命令
  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##单元测试报告

  # 代码扫描
  SCANNER_HOME : &quot;&quot;
  SCAN_DIR : &quot;src&quot;
  ARTIFACT_PATH : 'target/*.jar'                            ##制品目录

  #上传制品库
  ARTIFACTORY_URL: &quot;http://192.168.1.200:30082/artifactory&quot;
  ARTIFACTORY_NAME: &quot;cidevops&quot;
  TARGET_FILE_PATH: &quot;$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID&quot;
  TARGET_ARTIFACT_NAME: &quot;$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID.jar&quot;

  #构建镜像
  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'
  CI_REGISTRY_USER: '610556220zy'
  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'
  IMAGE_NAME: &quot;$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID&quot;
  DOCKER_FILE_PATH: &quot;./Dockerfile&quot;

  #部署k8s
  RUN_DEPLOY: &quot;yes&quot;
  APP_NAME: &quot;$CI_PROJECT_NAME&quot;
  CONTAINER_PORT: 8081
  NODE_PORT: 30185
  ENV_NAME: &quot;staging&quot;
  ENV_URL: &quot;http://192.168.1.200:30185&quot;
  NAMESPACE: &quot;$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG&quot;



image: docker:latest


stages:
  - build
  - test
  - parallel01
  - down_artifact
  - deploy
  - interface_test

before_script:
  - ls /home/gitlab-runner/ci-build-cache/builds/
  - echo  $CI_BUILDS_DIR
  - echo  $KUBE_URL $KUBE_TOKEN $KUBE_CA_PEM $KUBE_CA_PEM_FILE
  - export


build:
  variables:
    GIT_CHECKOUT: &quot;true&quot;
  tags:
    - k8s
  image: maven:3.6.3-jdk-8
  stage: build
  extends: .build
  rules:
    - when: on_success
  after_script:
    - ls target/

test:
  before_script:
    - ls target/
  tags:
    - k8s
  image: maven:3.6.3-jdk-8
  stage: test
  extends: .test
  rules:
    - when: on_success
  after_script:
    - ls target/

code_analysis:
  tags:
    - k8s
  image: sonarsource/sonar-scanner-cli:latest
  stage: parallel01
  script:
    - ls target/
    - echo $CI_MERGE_REQUEST_IID $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - &quot;sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \
                  -Dsonar.projectName=${CI_PROJECT_NAME} \
                  -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \
                  -Dsonar.ws.timeout=30 \
                  -Dsonar.projectDescription=${CI_PROJECT_TITLE} \
                  -Dsonar.links.homepage=${CI_PROJECT_URL} \
                  -Dsonar.sources=${SCAN_DIR} \
                  -Dsonar.sourceEncoding=UTF-8 \
                  -Dsonar.java.binaries=target/classes \
                  -Dsonar.java.test.binaries=target/test-classes \
                  -Dsonar.java.surefire.report=target/surefire-reports \
                  -Dsonar.host.url=http://192.168.1.200:30090 \
                  -Dsonar.login=ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b \
                  -Dsonar.branch.name=${CI_COMMIT_REF_NAME}&quot; 

build_image:
  before_script:
    - ls target/
  tags:
    - k8s
  image: docker:latest
  services:
    - name: docker:dind
  stage: parallel01
  extends: .build-docker


deploy_k8s:
  image: lucj/kubectl:1.17.2
  tags:
    - k8s
    - kubernetes-runner
  stage: deploy
  script:
    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=&quot;${KUBE_CA_PEM_FILE}&quot;
    - kubectl config set-credentials admin --token=${KUBE_TOKEN}
    - sed -i &quot;s#__namespace__#${NAMESPACE}#g&quot; deployment.yaml 
    - sed -i &quot;s#__appname__#${APP_NAME}#g&quot; deployment.yaml 
    - sed -i &quot;s#__containerport__#${CONTAINER_PORT}#g&quot; deployment.yaml 
    - sed -i &quot;s#__nodeport__#${NODE_PORT}#g&quot; deployment.yaml 
    - sed -i &quot;s#__imagename__#${IMAGE_NAME}#g&quot; deployment.yaml 
    - sed -i &quot;s#__CI_ENVIRONMENT_SLUG__#${CI_ENVIRONMENT_SLUG}#g&quot; deployment.yaml 
    - sed -i &quot;s#__CI_PROJECT_PATH_SLUG__#${CI_PROJECT_PATH_SLUG}#g&quot; deployment.yaml
    - cat deployment.yaml
    - kubectl apply -f deployment.yaml  
  environment:
    name: $ENV_NAME
    url: $ENV_URL


interfact_test:
  inherit:
    variables: false
  stage: interface_test
  extends: .interfacetest
</code></pre>
<p><strong><code>gitlabci-cidevops-java-service/deployment.yaml</code></strong></p>
<pre><code>kind: Deployment
apiVersion: apps/v1
metadata:
  labels:
    k8s-app: __appname__
    app.gitlab.com/env: __CI_ENVIRONMENT_SLUG__
    app.gitlab.com/app: __CI_PROJECT_PATH_SLUG__
  name: __appname__
  namespace: __namespace__
  annotations:
    app.gitlab.com/env: __CI_ENVIRONMENT_SLUG__
    app.gitlab.com/app: __CI_PROJECT_PATH_SLUG__
spec:
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      k8s-app: __appname__
  template:
    metadata:
      labels:
        k8s-app: __appname__
        app.gitlab.com/env: __CI_ENVIRONMENT_SLUG__
        app.gitlab.com/app: __CI_PROJECT_PATH_SLUG__
      namespace: __namespace__
      name: __appname__
    spec:
      containers:
        - name: __appname__
          image: __imagename__
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: __containerport__
              name: web
              protocol: TCP
      serviceAccountName: __appname__
      imagePullSecrets:
        - name: __namespace__
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: __appname__
  name: __appname__
  namespace: __namespace__
---
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: __appname__
  name: __appname__
  namespace: __namespace__
spec:
  type: NodePort
  ports:
    - name: web
      port: __containerport__
      targetPort: __containerport__
      nodePort: __nodeport__
  selector:
    k8s-app: __appname__
</code></pre>
<h3 id="gitlabci-cidevops-java-servicegitlab-ciyml"><strong><code>gitlabci-cidevops-java-service/.gitlab-ci.yml</code></strong></h3>
<pre><code>include:
    - project: 'cidevops/cidevops-gitlabci-service'
      ref: master
      file: 'templates/k8s-java-pipeline.yml'


variables:
  BUILD_SHELL: 'mvn clean package  -DskipTests'  
</code></pre>
<p>最终效果</p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_3.png" title="Body image" /></p>
<h2 id="2-runner"><strong>2 配置Runner 持久化构建缓存</strong></h2>
<h3 id="_4"><strong>准备工作</strong></h3>
<p>runner配置信息可以通过参数指定，也可以以环境变量方式设置。详细内容可以通过 <code>gitlab-runner register -h</code> 获取到相关参数和变量名称。</p>
<p>在使用官方提供的runner镜像注册runner，默认的runner配置文件在<code>/home/gitlab-runner/.gitlab-runner/config.toml</code></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_4.png" title="Body image" /></p>
<p><strong>参考文档</strong></p>
<p><a href="https://docs.gitlab.com/charts/advanced/persistent-volumes/#make-changes-to-the-persistentvolumeclaim">https://docs.gitlab.com/charts/advanced/persistent-volumes/#make-changes-to-the-persistentvolumeclaim</a></p>
<h3 id="gitlab-runner"><strong>重建gitlab-runner</strong></h3>
<p><strong>values.yml</strong></p>
<pre><code>## GitLab Runner Image
##
## By default it's using gitlab/gitlab-runner:alpine-v{VERSION}
## where {VERSION} is taken from Chart.yaml from appVersion field
##
## ref: https://hub.docker.com/r/gitlab/gitlab-runner/tags/
##
image: gitlab/gitlab-runner:alpine-v12.9.0

## 镜像下载策略
imagePullPolicy: IfNotPresent

## Gitlab服务器地址
gitlabUrl: http://192.168.1.200:32220/

## runner注册token
runnerRegistrationToken: &quot;JRzzw2j1Ji6aBjwvkxAv&quot;

## 终止之前注销所有跑步者
unregisterRunners: true


## 当停止管道时等待其作业终止时间
terminationGracePeriodSeconds: 3600

## Set the certsSecretName in order to pass custom certficates for GitLab Runner to use
## Provide resource name for a Kubernetes Secret Object in the same namespace,
## this is used to populate the /home/gitlab-runner/.gitlab-runner/certs/ directory
## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates
##
# certsSecretName:


## 配置最大并发作业数
concurrent: 10

## 新作业检查间隔
checkInterval: 30

## GitlabRunner日志级别 debug, info, warn, error, fatal, panic
logLevel: info

## Configure GitLab Runner's logging format. Available values are: runner, text, json
## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section
##
# logFormat:

## For RBAC support:
rbac:
  create: true
  ## Define specific rbac permissions.
  resources: [&quot;pods&quot;, &quot;pods/exec&quot;, &quot;secrets&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;patch&quot;, &quot;delete&quot;]

  ## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs
  ## cluster-wide or only within namespace
  clusterWideAccess: false

  ## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)
  ##
  # serviceAccountName: default

  ## Specify annotations for Service Accounts, useful for annotations such as eks.amazonaws.com/role-arn
  ##
  ## ref: https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html
  ##
  # serviceAccountAnnotations: {}

## Configure integrated Prometheus metrics exporter
## ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server
metrics:
  enabled: true

## Configuration for the Pods that that the runner launches for each new job
##
runners:
  ## Default container image to use for builds when none is specified
  ##
  image: ubuntu:16.04

  ## Specify one or more imagePullSecrets
  ##
  ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
  ##
  # imagePullSecrets: []

  ## Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.
  ##
  imagePullPolicy: &quot;if-not-present&quot;

  ## Defines number of concurrent requests for new job from GitLab
  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section
  ## 限制来自GitLab的对新作业的并发请求数
  requestConcurrency: 1

  ## Specify whether the runner should be locked to a specific project: true, false. Defaults to true.
  ##
  locked: false

  ## Specify the tags associated with the runner. Comma-separated list of tags.
  ##
  ## ref: https://docs.gitlab.com/ce/ci/runners/#using-tags
  ##
  tags: &quot;kubernetes-runner,k8s&quot;

  ## Specify if jobs without tags should be run.
  ## If not specified, Runner will default to true if no tags were specified. In other case it will
  ## default to false.
  ##
  ## ref: https://docs.gitlab.com/ce/ci/runners/#allowing-runners-with-tags-to-pick-jobs-without-tags
  ##
  runUntagged: true

  ## Specify whether the runner should only run protected branches.
  ## Defaults to False.
  ##
  ## ref: https://docs.gitlab.com/ee/ci/runners/#protected-runners
  ##
  protected: false

  ## Run all containers with the privileged flag enabled
  ## This will allow the docker:dind image to run if you need to run Docker
  ## commands. Please read the docs before turning this on:
  ## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind
  ##
  privileged: true

  ## The name of the secret containing runner-token and runner-registration-token
  # secret: gitlab-runner

  ## Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)
  ##
  # namespace:

  ## The amount of time, in seconds, that needs to pass before the runner will
  ## timeout attempting to connect to the container it has just created.
  ## ref: https://docs.gitlab.com/runner/executors/kubernetes.html
  pollTimeout: 180

  ## Set maximum build log size in kilobytes, by default set to 4096 (4MB)
  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section
  outputLimit: 4096

  ## Distributed runners caching
  ## ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching
  ##
  ## If you want to use s3 based distributing caching:
  ## First of all you need to uncomment General settings and S3 settings sections.
  ##
  ## Create a secret 's3access' containing 'accesskey' &amp; 'secretkey'
  ## ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/
  ##
  ## $ kubectl create secret generic s3access \
  ##   --from-literal=accesskey=&quot;YourAccessKey&quot; \
  ##   --from-literal=secretkey=&quot;YourSecretKey&quot;
  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/
  ##
  ## If you want to use gcs based distributing caching:
  ## First of all you need to uncomment General settings and GCS settings sections.
  ##
  ## Access using credentials file:
  ## Create a secret 'google-application-credentials' containing your application credentials file.
  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section
  ## You could configure
  ## $ kubectl create secret generic google-application-credentials \
  ##   --from-file=gcs-application-credentials-file=./path-to-your-google-application-credentials-file.json
  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/
  ##
  ## Access using access-id and private-key:
  ## Create a secret 'gcsaccess' containing 'gcs-access-id' &amp; 'gcs-private-key'.
  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-cache-gcs-section
  ## You could configure
  ## $ kubectl create secret generic gcsaccess \
  ##   --from-literal=gcs-access-id=&quot;YourAccessID&quot; \
  ##   --from-literal=gcs-private-key=&quot;YourPrivateKey&quot;
  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/
  cache: {}
    ## General settings
    # cacheType: s3
    # cachePath: &quot;gitlab_runner&quot;
    # cacheShared: true

    ## S3 settings
    # s3ServerAddress: s3.amazonaws.com
    # s3BucketName:
    # s3BucketLocation:
    # s3CacheInsecure: false
    # secretName: s3access

    ## GCS settings
    # gcsBucketName:
    ## Use this line for access using access-id and private-key
    # secretName: gcsaccess
    ## Use this line for access using google-application-credentials file
    # secretName: google-application-credentials

  ## Build Container specific configuration
  ##
  builds: {}
    # cpuLimit: 200m
    # memoryLimit: 256Mi
    # cpuRequests: 100m
    # memoryRequests: 128Mi

  ## Service Container specific configuration
  ##
  services: {}
    # cpuLimit: 200m
    # memoryLimit: 256Mi
    # cpuRequests: 100m
    # memoryRequests: 128Mi

  ## Helper Container specific configuration
  ##
  helpers: {}
    # cpuLimit: 200m
    # memoryLimit: 256Mi
    # cpuRequests: 100m
    # memoryRequests: 128Mi
    # image: gitlab/gitlab-runner-helper:x86_64-latest

  ## Service Account to be used for runners
  ##
  # serviceAccountName:

  ## If Gitlab is not reachable through $CI_SERVER_URL
  ##
  # cloneUrl:

  ## Specify node labels for CI job pods assignment
  ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/
  ##
  # nodeSelector: {}

  ## Specify pod labels for CI job pods
  ##
  # podLabels: {}

  ## Specify annotations for job pods, useful for annotations such as iam.amazonaws.com/role
  # podAnnotations: {}

  ## Configure environment variables that will be injected to the pods that are created while
  ## the build is running. These variables are passed as parameters, i.e. `--env &quot;NAME=VALUE&quot;`,
  ## to `gitlab-runner register` command.
  ##
  ## Note that `envVars` (see below) are only present in the runner pod, not the pods that are
  ## created for each build.
  ##
  ## ref: https://docs.gitlab.com/runner/commands/#gitlab-runner-register
  ##
  # env:
  #   NAME: VALUE


## Configure securitycontext
## ref: http://kubernetes.io/docs/user-guide/security-context/
##
securityContext:
  fsGroup: 65533
  runAsUser: 100


## Configure resource requests and limits
## ref: http://kubernetes.io/docs/user-guide/compute-resources/
##
resources: {}
  # limits:
  #   memory: 256Mi
  #   cpu: 200m
  # requests:
  #   memory: 128Mi
  #   cpu: 100m

## Affinity for pod assignment
## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
##
affinity: {}

## Node labels for pod assignment
## Ref: https://kubernetes.io/docs/user-guide/node-selection/
##
nodeSelector: {}
  # Example: The gitlab runner manager should not run on spot instances so you can assign
  # them to the regular worker nodes only.
  # node-role.kubernetes.io/worker: &quot;true&quot;

## List of node taints to tolerate (requires Kubernetes &gt;= 1.6)
## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/
##
tolerations: []
  # Example: Regular worker nodes may have a taint, thus you need to tolerate the taint
  # when you assign the gitlab runner manager with nodeSelector or affinity to the nodes.
  # - key: &quot;node-role.kubernetes.io/worker&quot;
  #   operator: &quot;Exists&quot;

## Configure environment variables that will be present when the registration command runs
## This provides further control over the registration process and the config.toml file
## ref: `gitlab-runner register --help`
## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html
##
# envVars:
#   - name: RUNNER_EXECUTOR
#     value: kubernetes

## list of hosts and IPs that will be injected into the pod's hosts file
hostAliases: []
  # Example:
  # - ip: &quot;127.0.0.1&quot;
  #   hostnames:
  #   - &quot;foo.local&quot;
  #   - &quot;bar.local&quot;
  # - ip: &quot;10.1.2.3&quot;
  #   hostnames:
  #   - &quot;foo.remote&quot;
  #   - &quot;bar.remote&quot;

## Annotations to be added to manager pod
##
podAnnotations: {}
  # Example:
  # iam.amazonaws.com/role: &lt;my_role_arn&gt;

## Labels to be added to manager pod
##
podLabels: {}
  # Example:
  # owner.team: &lt;my_cool_team&gt;

## HPA support for custom metrics:
## This section enables runners to autoscale based on defined custom metrics.
## In order to use this functionality, Need to enable a custom metrics API server by
## implementing &quot;custom.metrics.k8s.io&quot; using supported third party adapter
## Example: https://github.com/directxman12/k8s-prometheus-adapter
##
#hpa: {}
  # minReplicas: 1
  # maxReplicas: 10
  # metrics:
  # - type: Pods
  #   pods:
  #     metricName: gitlab_runner_jobs
  #     targetAverageValue: 400m
</code></pre>
<pre><code>## 更新
helm upgrade gitlab-runner --namespace gitlab-runner ./gitlab-runner
</code></pre>
<h3 id="_5"><strong>跑一个传统的打包流水线</strong></h3>
<p><code>.gitlba-ci.yaml</code></p>
<pre><code>image: maven:3.6.3-jdk-8

before_script:
    - ls

services:
    - name: mysql:latest
        alias: mysql-1

build:
    image: maven:3.6.3-jdk-8
    stage: build
    tags:
        - k8s
    script:
        - ls
        - sleep 2
        - mvn clean package -DskipTests
        - sleep 10

deploy:
    stage: deploy
    tags:
        - k8s
    script:
        - echo &quot;deploy&quot;
    environment:
        name: production
        ur: http://www.baidu.com
</code></pre>
<p><strong>下载依赖包将会花费大量的时间</strong></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_5.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_6.png" title="Body image" /></p>
<h3 id="_6"><strong>解决构建缓存问题</strong></h3>
<p>所谓的构建缓存就是我们在进行maven/npm等构建工具打包时所依赖的包。默认会在私服中获取，加快构建速度可以在本地缓存一份。</p>
<p>在此，我们需要创建PVC来持久化构建缓存，加速构建速度。为了节省存储空间决定不在每个项目中存储构建缓存，而是配置全局缓存。</p>
<p>准备本机缓存目录</p>
<pre><code>/opt/ci-build-cache
[ci-build-cache]# ls
builds    maven 
</code></pre>
<p>首先，创建一个PVC用于挂载到pod中使用。</p>
<p><strong><code>buildcache-pvc.yml</code></strong></p>
<pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: ci-build-cache-pv
  namespace: gitlab-runner
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/opt/ci-build-cache&quot;
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ci-build-cache-pvc
  namespace: gitlab-runner
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
</code></pre>
<p>使用命令查看验证</p>
<pre><code>kubect1 create -f buildcache-pvc.yml
</code></pre>
<pre><code># kubectl get pvc -n gitlab-runner
NAME                 STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE
ci-build-cache-pvc   Bound    ci-build-cache-pv   10Gi       RWO            manual     5h41m
</code></pre>
<p>vc准备好了，考虑到不能每次部署runner都手动挂载pvc，需要自定义gitlab-runner chart，优化runner配置。</p>
<ul>
<li><strong>第一步：编辑value.yml文件，添加构建缓存信息配置。</strong></li>
</ul>
<p><code>gitlab-runner/value.yml</code></p>
<pre><code>## configure build cache
cibuild:
  cache:
    pvcName: ci-build-cache-pvc
    mountPath: /home/gitlab-runner/ci-build-cache
</code></pre>
<p>第二步：编辑<code>templates/configmap.yml</code>文件，<code>entrypoint</code>部分添加<code>runner</code>配置。在start之前添加，这样runner在创建构建pod的时候会根据配置挂载pvc。</p>
<pre><code>...

# add build cache
cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF
  [[runners.kubernetes.volumes.pvc]]
  name = &quot;{{.Values.cibuild.cache.pvcName}}&quot;
  mount_path = &quot;{{.Values.cibuild.cache.mountPath}}&quot;
EOF

# Start the runner
exec /entrypoint run --user=gitlab-runner \
  --working-directory=/home/gitlab-runner
</code></pre>
<p>到此gitlab-runner chart部分配置就完成了，接下来可以通过Helm命令进行创建和更新了。</p>
<pre><code>helm install gitlab-runner04 ./gitlab-runner --namespace gitlab-runner
helm upgrade gitlab-runner04 ./gitlab-runner --namespace gitlab-runner
</code></pre>
<p>使用以上命令部署完成后，可以在gitlab admin页面和k8s面板查看runner的状态，确保部署成功。查看pod配置。</p>
<pre><code>cat /home/gitlab-runner/.gitlab-runner/config.toml

....
[[runners.kubernetes.volumes.pvc]]
name =  &quot;ci-build-cache-pvc&quot;
mount_path = &quot;/home/gitlab-runner/ci-build-cache&quot;
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_1_7.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_8.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_9.png" title="Body image" /></p>
<p>部署完成了，后续使用构建工具打包时添加指定缓存目录。例如：maven</p>
<pre><code>mvn clean package  -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  
</code></pre>
<p><code>.gitlba-ci.yaml</code></p>
<pre><code>image: maven:3.6.3-jdk-8

before_script:
    - ls

services:
    - name: mysql:latest
        alias: mysql-1

build:
    image: maven:3.6.3-jdk-8
    stage: build
    tags:
        - k8s
    script:
        - ls
        - sleep 2
        - mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  
        - sleep 10

deploy:
    stage: deploy
    tags:
        - k8s
    script:
        - echo &quot;deploy&quot;
    environment:
        name: production
        ur: http://www.baidu.com
</code></pre>
<p><strong>发现构建速度很快证明已经完成构建缓存配置</strong>。可以配合查看本地缓存目录是否有更新。</p>
<blockquote>
<p>会产生一个新的runner 而非原来的gitlab-runner</p>
</blockquote>
<p><img alt="Alt Image Text" src="../../images/chap5_1_10.png" title="Body image" /></p>
<p><strong><code>cd  /ci-build-cache/maven</code></strong></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_11.png" title="Body image" /></p>
<p><strong>打包可以快速结束</strong></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_12.png" title="Body image" /></p>
<h2 id="3"><strong>3 解决构建制品问题</strong></h2>
<p>在kubernetes中对cache支持一般，我们可以使用artifacts进行代替。但是考虑到artifacts收集制品会占用存储空间，所以准备研究下如何配置统一的缓存。实际上我们可以将repo目录做成持久化。</p>
<pre><code>...
build:
    image: maven:3.6.3-jdk-8
    stage: build
    tags:
        - k8s
    script:
        - ls
        - sleep 2
        - mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  
        - ls target/

test:
    image: maven:3.6.3-jdk-8
    stage: test
    tags:
        - k8s
    script:
        - ls target/
        - sleep 2
        - mvn test -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  
        - sleep 10
</code></pre>
<p><strong>Test之前已经被clean掉了， test失败</strong></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_13.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_14.png" title="Body image" /></p>
<p><strong><code>demo-maven-service</code></strong></p>
<pre><code>test:
    variables:
        GIT_CHECKOUT: &quot;false&quot;
    image: maven:3.6.3-jdk-8
    stage: test
    tags:
        - k8s
    script:
        - ls target/
        - sleep 2
        - mvn test -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  
        - sleep 10
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_1_15.png" title="Body image" /></p>
<p><strong>经过测试，在使用kubernetes执行器创建的构建pod会默认挂载一个空目录。</strong></p>
<p><strong>此目录用于存储每次下载的代码，因为是空目录的原因导致后续测试pod无法获取需要重新下载代码</strong>，这还不要紧，重要的是构建生成的文件target目录都不存在了导致后续步骤接连失败。</p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_16.png" title="Body image" /></p>
<p>由于yaml文件都是有官方默认配置的，问题不好定位。这其实是个两年前的问题了。 <a href="https://gitlab.com/gitlab-org/gitlab-runner/-/issues/3148">https://gitlab.com/gitlab-org/gitlab-runner/-/issues/3148</a> 。最后经过分析直接将持久化的pvc挂载到空目录中的某个目录中。</p>
<p><strong>需要配置runner自定义构建目录，但是构建目录必须是在<code>$CI_BUILD_DIRS</code>目录里面。</strong></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_17.png" title="Body image" /></p>
<p>准备本地的工作目录</p>
<pre><code>/opt/ci-build-dir
</code></pre>
<p>创建repo持久化pvc</p>
<pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  name: ci-build-dir-pv
  namespace: gitlab-runner
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: &quot;/opt/ci-build-dir&quot;
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ci-build-dir-pvc
  namespace: gitlab-runner
spec:
  storageClassName: manual
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
</code></pre>
<p>使用命令验证</p>
<pre><code># kubectl get pvc -n gitlab-runner
NAME                 STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE
ci-build-cache-pvc   Bound    ci-build-cache-pv   10Gi       RWO            manual         6h41m
ci-build-dir-pvc     Bound    ci-build-dir-pv     10Gi       RWO            manual         3h11m
</code></pre>
<h3 id="valuesyaml"><code>values.yaml</code></h3>
<ul>
<li>编译<code>values.yaml</code>文件添加注册配置变量。</li>
<li><code>RUNNER_BUILDS_DIR</code>定义构建目录。</li>
<li><code>CUSTOM_BUILD_DIR_ENABLED</code>开启自定义构建目录配置。</li>
</ul>
<pre><code>envVars:
  - name: RUNNER_BUILDS_DIR
    value: &quot;/home/gitlab-runner/ci-build-dir/&quot;
  - name: CUSTOM_BUILD_DIR_ENABLED
    value: true
</code></pre>
<p>添加repo目录缓存配置，我们把自定义的构建目录放到默认构建目录的下面builds目录中。</p>
<pre><code>## configure build cache
cibuild:
  cache:
    pvcName: ci-build-cache-pvc
    mountPath: /home/gitlab-runner/ci-build-cache
  builds:
    pvcName: ci-build-dir-pvc
    mountPath: /home/gitlab-runner/ci-build-dir/builds
</code></pre>
<h3 id="templatesconfigmapyml"><strong>编辑<code>templates/configmap.yml</code></strong></h3>
<p><strong><code>gitlab-runner/templates/configmap.yaml</code></strong></p>
<pre><code>    # add build cache
    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF
      [[runners.kubernetes.volumes.pvc]]
      name = &quot;{{.Values.cibuild.cache.pvcName}}&quot;
      mount_path = &quot;{{.Values.cibuild.cache.mountPath}}&quot;
      [[runners.kubernetes.volumes.pvc]]
      name = &quot;{{.Values.cibuild.builds.pvcName}}&quot;
      mount_path = &quot;{{.Values.cibuild.builds.mountPath}}&quot;
    EOF
</code></pre>
<p><strong>更新runner</strong></p>
<pre><code>helm install gitlab-runner04 ./gitlab-runner --namespace gitlab-runner
helm upgrade gitlab-runner04 ./gitlab-runner --namespace gitlab-runner
</code></pre>
<pre><code>bash-5.0$ cat /home/gitlab-runner/.gitlab-runner/config.toml

[[runners]]
    name = &quot;gitlab-runner-gitlab-runner-7dcbd59€74-nxdnm
    output limit = 4096
    request_concurrency = 1
    url = &quot;http://192.168.1.200:30088/&quot;
    token = &quot;ywKfhgyp9AQkkc-bMjgC&quot;
    executor = &quot;kubernetes&quot;
    builds_dir = &quot;home/gitlab-runner/ci-build-dir/&quot;
    [runners.custom_build_dir]
        enabled = true
    [runners.cache]
        [runners.cache.s3]
        [runners.cache.gcs]
    ....
    [[runners.kubernetes.volumes.pvc]]
    name = &quot;ci-build-cache-pvc&quot;
    mount_path =  &quot;/home/gitlab-runner/ci-build-cache&quot;
    [[runners.kubernetes.volumes.pvc]]
    name = &quot;ci-build-cache-pvc&quot;
    mount_path =  &quot;/home/gitlab-runner/ci-build-dir/builds&quot;
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_1_18.png" title="Body image" /></p>
<p><code>.gitlab-ci.yaml</code></p>
<pre><code>variables:
  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_I
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_1_19.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap5_1_20.png" title="Body image" /></p>
<p>经过测试在本地的pv中能够看到，下载的代码文件。但是默认每次每个job运行的时候都会获取远程最新的代码，会把构建目录删除掉，此时就需要配置git checkout策略了。其实按照我们目前的场景，不需要每个作业都下载代码。只要第一个作业下载好最新的代码，然后运行流水线即可。当在运行流水线的过程中遇到新代码提交可以放到下次流水线执行。</p>
<p>需要在ci文件中定义<code>GIT_CHECKOUT</code>变量，默认值为true，即每次都需要代码下载。我们将全局配置为false然后在build作业中配置为true。也就实现了只在build作业下载最新代码了。</p>
<pre><code>GIT_CHECKOUT: &quot;false&quot; 
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap5_1_21.png" title="Body image" /></p>
<ul>
<li>参考链接：http://s0docs0gitlab0com.icopy.site/ee/ci/yaml/README.html#git-checkout</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>