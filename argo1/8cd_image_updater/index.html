
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Gitlab Tutorial Book">
      
      
        <meta name="author" content="Jacob Xi">
      
      
        <link rel="canonical" href="https://chao-xi.github.io/jxgitlabbook/argo1/8cd_image_updater/">
      
      
        <link rel="prev" href="../7k8s_yaml_cicd/">
      
      
        <link rel="next" href="../../chap10/1action_docker/">
      
      
      <link rel="icon" href="../../images/logo.jpeg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>7 ArgoCD Image Updater - Jacob GitLab Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="purple" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#argocd-image-updater" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob GitLab Book" class="md-header__button md-logo" aria-label="Jacob GitLab Book" data-md-component="logo">
      
  <img src="../../images/logo.jpeg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob GitLab Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              7 ArgoCD Image Updater
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxgitlabbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    jxgitlabbook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob GitLab Book" class="md-nav__button md-logo" aria-label="Jacob GitLab Book" data-md-component="logo">
      
  <img src="../../images/logo.jpeg" alt="logo">

    </a>
    Jacob GitLab Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxgitlabbook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    jxgitlabbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    GitLab Fundamentals
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            GitLab Fundamentals
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap0/1proj/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Project and Repositoires
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap0/4issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gitlab Issues and Timelines
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab 简介
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Gitlab 简介
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1gitlab_cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 Gitlab 基本介绍（CI/CD)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/2gitlab_branch_strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Gitlab branch Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/3gitlab_install_quick/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 安装配置Gitlab
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/4gitlab_install_k8s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 在Kubernetes上安装Gitlab
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab Runner配置&安装
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Gitlab Runner配置&安装
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/1gitruner_intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 GitLab Runner 简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2/2gitrunner_install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 GitLab Runner安装注册配置管理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline 核心语法
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Pipeline 核心语法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/1gitlab_pip1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitLabCI系列之流水线语法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/2gitlab_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Gitlab CI 流水线构建优化 + Runner构建优化（持久化）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap3/3gitlab_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 配置复杂的 Gitlab CI/CD Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab工具链集成
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Gitlab工具链集成
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/1git_template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 模板库设计Maven+NPM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/2git_sonar_pr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Gitlab 工具链集成-代码质量平台集成
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/3gitlab_artifact_docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 工具链集成-制品库集成
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/4gitlab_jemeter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 Gitlab 自动化测试集成
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap4/5gitlba_mon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 GitLabCI/CD Prom构建数据采集与监控
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab + Kubernetes集成
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Gitlab + Kubernetes集成
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/1gitlab-runner-install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 基于K8S安装部署Runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/2gitlab_k8s/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Kubernetes 容器流水线
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/3gitlab_notification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 Kubernetes 流水线构建消息通知
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap5/4gitlab_distri_storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 Gitlab + minio 配置使用分布式缓存
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gitlab流水线最佳实践
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Gitlab流水线最佳实践
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/1pip_init/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 流水线设计及提交
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/2pip_design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 提交流水线设计
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/3pip_run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 流水线运行
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap6/4pip_secret/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 如何将Secrets扫描加入到GitLab Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    项目交付流水线
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            项目交付流水线
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/1deploy_pip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 项目交付流水线优化后模板库配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap7/2deploy_projs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 项目流水线(JAVA+NPM+安卓)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    gitlab Certified CICD
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            gitlab Certified CICD
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/1cer_prep1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitLab Certified CI/CD Specialist Training
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/2pip_prep1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Anatomy of a Pipeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/3Gitlab_pip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gitlab Pipeline 复习
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap8/4Final_test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gitlab 认证考题
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    gitlab Project Management
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            gitlab Project Management
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/1Gitlab_branch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L1 Gitlab branch Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/2gitlab_workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L2 Gitflow Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/3Gitlab_branch_action/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L3 Gitlab branch Settup Action
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/4gitlab_project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L4 Agile Planning with GitLab
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap9/4gitlab_project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    L4 Agile Planning with GitLab
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" checked>
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ArgoCD Project
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            ArgoCD Project
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../0gitops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0 GitOps 常用工具盘点
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1argo2023_gitops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 使用 Argo CD 进行 GitOps 流水线改造- 2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2Argo_Rollouts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 使用 Argo Rollouts 实现应用渐进式发布
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3argo_dr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 DevOps中的Argo CD — 灾难恢复
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../4argo_rollouts_ab/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 A/B测试: 如何使用Argo Rollouts 进行渐进式交付
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../6gitops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 GitOps 简介
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../7k8s_yaml_cicd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6 K8S YAML 资源清单管理方案
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    7 ArgoCD Image Updater
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    7 ArgoCD Image Updater
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      它是如何运作的？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      特征
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      安装
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      配置
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Github Action
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Github Action
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/1action_docker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    基于GitHubActions同步Docker镜像实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/2action_workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitHub Action - CI/CD Pipeline with Docker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chap10/3action_events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GitHub Actions basic learning
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      它是如何运作的？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      特征
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      安装
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      配置
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="argocd-image-updater">ArgoCD Image Updater</h1>
<p>Argo CD Image Updater 是一种自动更新由 Argo CD 管理的 Kubernetes 工作负载的容器镜像的工具。 </p>
<p>该工具可以检查与 Kubernetes 工作负载一起部署的容器镜像的新版本，并使用 Argo CD 自动将其更新到允许的最新版本。</p>
<p>它通过为 Argo CD 应用程序设置适当的应用程序参数来工作，类似于 <code>argocd app set --helm-set image.tag=v1.0.1</code>，但以完全自动化的方式。</p>
<p>Argo CD Image Updater 会定期轮询 Argo CD 中配置的应用程序，并查询相应的镜像仓库以获取可能的新版本。</p>
<p>如果在仓库中找到新版本的镜像，并且满足版本约束，Argo CD 镜像更新程序将指示 Argo CD 使用新版本的镜像更新应用程序。</p>
<p>根据您的应用程序自动同步策略，<strong>Argo CD 将自动部署新的镜像版本或将应用程序标记为不同步，您可以通过同步应用程序来手动触发镜像更新</strong></p>
<h2 id="_1">它是如何运作的？</h2>
<p>Image Updater 程序通过读取 ArgoCD 应用程序资源中的 <strong>annotations</strong> 来工作，这些注解指定应自动更新哪些镜像。</p>
<p>它会检查指定镜像仓库中是否有较新的标签，如果它们与预定义的模式或规则匹配，则使用这些较新的标签更新应用程序清单。此自动化过程可确保您的应用程序始终运行最新版本的镜像，遵循 GitOps 的一致性和可追溯性原则</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_1.png" title="Body image" /></p>
<p>Image Updater 基本的工作流程如下所示：</p>
<ol>
<li><strong>Annotation 配置</strong>：开发人员注解 <strong>ArgoCD 应用程序以告诉 Image Updater 要跟踪哪些镜像</strong>，包括<strong>标签过滤和更新策略的规则</strong>。</li>
<li><strong>镜像仓库轮询</strong>：Image Updater 定期轮询配置的镜像仓库以查找符合指定条件的新标签。</li>
<li><strong>自动更新</strong>：当找到新的匹配标签时，<strong>Image Updater 会自动更新应用程序的 Kubernetes 清单中的镜像标签，并将更改提交回源 Git 存储库</strong>。</li>
<li><strong>同步变更</strong>：<strong>ArgoCD 检测到提交的更改，同步更新的清单</strong>，并将它们应用到 Kubernetes 集群。</li>
</ol>
<h2 id="_2">特征</h2>
<ul>
<li>更新由 Argo CD 管理且由 Helm 或 Kustomize 工具生成的应用程序镜像</li>
<li>根据不同的更新策略更新应用镜像<ul>
<li>semver：根据给定的镜像约束更新到允许的最高版本</li>
<li>latest：更新到最近创建的镜像标签</li>
<li>name：更新到按字母顺序排序的列表中的最后一个标签</li>
<li>digest：更新到可变标签的最新推送版本</li>
</ul>
</li>
<li>支持广泛使用的容器镜像仓库</li>
<li>通过配置支持私有容器镜像仓库</li>
<li>可以将更改写回 Git</li>
<li>能够使用匹配器函数过滤镜像仓库返回的标签列表</li>
<li>在 Kubernetes 集群中运行，或者可以从命令行独立使用</li>
<li>能够执行应用程序的并行更新</li>
</ul>
<p>另外需要注意的是使用该工具目前有几个限制：</p>
<ul>
<li>想要更新容器镜像的应用程序必须使用 Argo CD 进行管理。<strong>不支持未使用 Argo CD 管理的工作负载</strong>。</li>
<li>Argo CD 镜像更新程序只能更新其清单使用 Kustomize 或 Helm 呈现的应用程序的容器镜像，<strong>特别是在 Helm 的情况下，模板需要支持使用参数（即image.tag）</strong>。</li>
<li><strong>镜像拉取密钥必须存在于 Argo CD Image Updater 运行（或有权访问）的同一 Kubernetes 集群中</strong>。目前无法从其他集群获取这些机密信息</li>
</ul>
<h2 id="_3">安装</h2>
<p>建议在运行 Argo CD 的同一个 Kubernetes 命名空间集群中运行 Argo CD Image Updater，但这不是必需的。</p>
<p>事实上，甚至不需要在 Kubernetes 集群中运行 Argo CD Image Updater 或根本不需要访问任何 Kubernetes 集群。但如果不访问 Kubernetes，某些功能可能无法使用，所以强烈建议使用第一种安装方法。</p>
<p>运行镜像更新程序的最直接方法是将其作为 Kubernetes 工作负载安装到运行 Argo CD 的命名空间中。这样就不需要任何配置，也不会对你的工作负载产生任何影响。</p>
<pre><code>kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/stable/manifests/install.yaml
</code></pre>
<p>安装完成后我们就可以在 Argo CD 中看到 Argo CD Image Updater 组件了：</p>
<pre><code>$ kubectl get pods -n argocd
NAME                                                READY   STATUS    RESTARTS      AGE
argocd-notifications-controller-7f85bc8d8-sdqcd     1/1     Running   1 (13d ago)   14d
argocd-applicationset-controller-5f7687fbb4-jl6hf   1/1     Running   1 (13d ago)   14d
argocd-dex-server-665cfbbc8b-nqjf7                  1/1     Running   1 (13d ago)   14d
argocd-server-84cb8fdcdc-g4wmt                      1/1     Running   1 (13d ago)   14d
argocd-application-controller-0                     1/1     Running   1 (13d ago)   14d
argocd-repo-server-bb5d9cc8b-c8f6b                  1/1     Running   1 (13d ago)   14d
argocd-redis-5f87c6b5d7-n9d6v                       1/1     Running   1 (13d ago)   14d
argocd-image-updater-57b64976b-kgtkf                1/1     Running   0             20s
</code></pre>
<p>现在我们就可以直接去监听镜像是否发生了变化，而不需要在 CI 流水线中去手动提交修改资源清单到代码仓库了。</p>
<h2 id="_4">配置</h2>
<p>要充分利用 ArgoCD 镜像更新程序，将其配置连接到镜像仓库至关重要，尤其是在使用私有仓库或公共仓库上的私有存储库时。以下是如何配置必要的凭据并了解可用的不同方法。</p>
<p>ArgoCD Image Updater 可以使用以下方法获取凭据</p>
<ul>
<li>从 Kubernetes Secret 中获取凭据：标准的 Docker Pull Secret 或自定义 Secret，凭证格式为 <code>&lt;username&gt;:&lt;password&gt;</code> ，比如我们可以用下面的命令来创建一个</li>
</ul>
<pre><code>kubectl create -n argocd secret docker-registry dockerhub-secret \
  --docker-username someuser \
  --docker-password s0m3p4ssw0rd \
  --docker-server &quot;https://registry-1.docker.io&quot;
</code></pre>
<p>这个 secret 可以被引用为 <code>pullsecret:&lt;namespace&gt;/&lt;secret_name&gt; (pullsecret:argocd/dockerhub-secret)</code>。</p>
<p>通用 <code>Secret：</code>通用 Secret 是包含单个键值对的 <code>Secret</code>，键值对可以是任何格式，比如我们可以用下面的命令来创建一个：</p>
<pre><code>kubectl create -n argocd secret generic some-secret \
  --from-literal=creds=someuser:s0m3p4ssw0rd
</code></pre>
<p>该 secret 可以用 <code>env:&lt;name_of_environment_variable&gt;</code> (<code>env:DOCKER_HUB_CREDS</code>) 的方式引用</p>
<ul>
<li>环境变量：将凭证存储在环境变量中，该变量可以传递到 ArgoCD Image Updater pod，我们可以在 pod 的配置中设置</li>
</ul>
<pre><code>env:
  - name: DOCKER_HUB_CREDS
    value: &quot;someuser:s0m3p4ssw0rd&quot;
</code></pre>
<ul>
<li>Script 脚本：使用以 <code>&lt;username&gt;:&lt;password&gt;</code> 格式输出凭据的脚本。</li>
</ul>
<pre><code>#!/bin/sh
echo &quot;someuser:s0m3p4ssw0rd&quot;
</code></pre>
<p>将其引用为 <code>ext:&lt;full_path_to_script&gt;</code>。</p>
<p><strong>我们这里就以 Github 的 Container Registry 为例，来演示下如何使用 ArgoCD Image Updater 来更新镜像。</strong></p>
<p>首先我们在 Github 个人设置页面中创建一个个人访问令牌，如下图所示：</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_2.png" title="Body image" /></p>
<p>这个 Token 的权限要包括 <code>write:packages</code>和 <code>read:packages</code>，这样我们才能推送和拉取镜像，创建后会得到一个 Token。</p>
<p>然后我们可以在终端或命令行中，使用 GitHub 用户名和 GitHub 的个人访问令牌（PAT）登录 GitHub Container Registry。</p>
<pre><code>
export PAT=&lt;your-token&gt;
echo $PAT | docker login ghcr.io -u &lt;your-github-username&gt; --password-stdin
</code></pre>
<p>将替换为个人访问令牌，将替换为 GitHub 用户名。</p>
<p>登录成功后我们可以使用以下命令将 Docker 镜像标记为 GitHub Container Registry 镜像：</p>
<pre><code>docker tag &lt;your-image-name&gt;:&lt;tag&gt; ghcr.io/&lt;your-github-username&gt;/&lt;your-image-name&gt;:&lt;tag&gt;
</code></pre>
<p>将 <code>&lt;your-image-name&gt;:&lt;tag&gt;</code> 替换为本地 Docker 镜像名与 tag 名，将 <code>&lt;your-github-username&gt;</code> 替换为 GitHub 用户名，<code>&lt;tag&gt;</code> 替换想要使用的标签（例如默认的 latest 标签）。</p>
<p>然后使用以下命令将 Docker 镜像推送到 GitHub Container Registry 即可：</p>
<pre><code>docker push ghcr.io/&lt;your-github-username&gt;/&lt;your-image-name&gt;:&lt;tag&gt;
</code></pre>
<p>完成以上步骤后，就可以在 GitHub 个人账号的 的 Packages 部分看到 Docker 镜像了，但是该镜像默认为 private 镜像，Pull 使用时需要先登录</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_3.png" title="Body image" /></p>
<pre><code>kubectl create -n argocd secret docker-registry ghcr-secret \
  --docker-username=cnych \
  --docker-password=$PAT \
  --docker-server=&quot;https://ghcr.io&quot;
</code></pre>
<p>设置凭据后，将它们配置在 ArgoCD 镜像更新程序的配置中，以通过镜像仓库进行身份验证，我们可以修改镜像更新程序的配置：</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-image-updater-config
  namespace: argocd
data:
  registries.conf: |
    registries:
      - name: ghcr-hub
        api_url: https://ghcr.io # 镜像仓库地址
        credentials: pullsecret:argocd/ghcr-secret # 凭据
        defaultns: library # 默认命名空间
        default: true # 默认仓库
</code></pre>
<p>上面配置中我们指定了 GitHub 镜像仓库的凭据为 <code>pullsecret:argocd/ghcr-secret</code>，这样 ArgoCD Image Updater 在访问 ghcr.io 时就会使用这个凭据。</p>
<p>接下来我们还需要将 ArgoCD Image Updater 与 Git 集成，这也是重点，这样 ArgoCD Image Updater 就可以将镜像更新直接提交回源 Git 仓库。</p>
<p>我们可以在 ArgoCD 的 Dashboard 中先添加一个 Git 仓库 <code>https://github.com/test/k8s-devops-gitops-demo</code>：</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_4.png" title="Body image" /></p>
<p>接下来我们可以按照正常使用方式创建一个新的 Application 对象，对应的资源清单文件如下所示：</p>
<pre><code>apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gitops-demo
  namespace: argocd
spec:
  destination:
    namespace: gitops-demo
    server: https://kubernetes.default.svc
  project: default
  source:
    path: helm # 从 Helm 存储库创建应用程序时，chart 必须指定 path
    repoURL: https://github.com/cnych/k8s-devops-gitops-demo.git
    targetRevision: master
    helm:
      parameters:
        - name: replicaCount
          value: &quot;2&quot;
      valueFiles:
        - my-values.yaml
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
</code></pre>
<p>直接创建上面的资源清单文件后，ArgoCD 会自动创建一个 Application 资源对象，并且会自动同步到 Git 仓库中，我们可以在 Git 仓库中看到对应的资源清单文件</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_5.png" title="Body image" /></p>
<p>如果该应用出现了如下所示的错误信息：</p>
<pre><code>Namespace                gitops-demo                            SyncFailed        resource :Namespace is not permitted in project default
</code></pre>
<p>则表面当前使用的 project 没有权限创建 namespace，我们只需要为其添加对应的权限即可：</p>
<pre><code>apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: default
  namespace: argocd
spec:
  clusterResourceWhitelist: # 白名单，表示允许访问的资源
    - group: &quot;*&quot;
      kind: &quot;*&quot;
  destinations:
    - name: &quot;*&quot;
      namespace: &quot;*&quot;
      server: &quot;*&quot;
  sourceRepos:
    - &quot;*&quot;
</code></pre>
<p>我们可以使用 argocd app get 命令来查看 Application 资源对象的状态：</p>
<pre><code>$ argocd app get argocd/gitops-demo
Name:               argocd/gitops-demo
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          gitops-demo
URL:                https://grpc.argocd.k8s.local/applications/gitops-demo
Source:
- Repo:             https://github.com/cnych/k8s-devops-gitops-demo.git
  Target:           master
  Path:             helm
  Helm Values:      my-values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated (Prune)
Sync Status:        Synced to master (53d91ed)
Health Status:      Progressing

GROUP              KIND        NAMESPACE    NAME                        STATUS     HEALTH       HOOK  MESSAGE
                   Namespace                gitops-demo                 Running    Synced             namespace/gitops-demo created
apps               Deployment  default      gitops-demo-helm-guestbook  Succeeded  Pruned             pruned
                   Service     default      gitops-demo-helm-guestbook  Succeeded  Pruned             pruned
                   Service     gitops-demo  gitops-demo-devops-demo     Synced     Healthy            service/gitops-demo-devops-demo created
apps               Deployment  gitops-demo  gitops-demo-devops-demo     Synced     Progressing        deployment.apps/gitops-demo-devops-demo created
networking.k8s.io  Ingress     gitops-demo  gitops-demo-devops-demo     Synced     Progressing        ingress.networking.k8s.io/gitops-demo-devops-demo created
</code></pre>
<blockquote>
<p>需要注意要在目标命名空间中添加 Image Pull Secret。</p>
</blockquote>
<p>正常我们这个应用就可以运行了：</p>
<pre><code>$ curl http://gitops-demo.k8s.local/
{&quot;msg&quot;:&quot;Hello Tekton On GitLab With ArgoCD&quot;}
</code></pre>
<p>但是在 Dashboard 中我们可以看到应用虽然已经是 Synced 状态，但是 APP HEALTH 一直显示为 Progressing 状态。</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_6.png" title="Body image" /></p>
<p>这是因为 ArgoCD 的健康状态机制引起的，我们可以在源码 </p>
<p><a href="https://github.com/argoproj/gitops-engine/blob/master/pkg/health/health_ingress.go#L7">https://github.com/argoproj/gitops-engine/blob/master/pkg/health/health_ingress.go#L7</a></p>
<p>中看到健康状态的检查逻辑。</p>
<pre><code>func getIngressHealth(obj *unstructured.Unstructured) (*HealthStatus, error) {
 ingresses, _, _ := unstructured.NestedSlice(obj.Object, &quot;status&quot;, &quot;loadBalancer&quot;, &quot;ingress&quot;)
 health := HealthStatus{}
 if len(ingresses) &gt; 0 {
  health.Status = HealthStatusHealthy
 } else {
  health.Status = HealthStatusProgressing
 }
 return &amp;health, nil
}
</code></pre>
<p>他需要检查 Ingress 资源对象的 <code>status.loadBalancer.ingress</code> 字段是否为空，如果为空则表示健康状态为 <code>Progressing</code>，否则为 Healthy，但实际情况却是并不是所有的 <code>Ingress</code> 资源对象都会自动生成 <code>status.loadBalancer.ingress</code> 字段，比如我们这里就并没有生成。</p>
<p>这个时候我们可以通过配置 argocd-cm 的配置资源来修改健康状态检查逻辑，添加如下所示的配置：</p>
<pre><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  resource.customizations: |
    networking.k8s.io/Ingress:
      health.lua: |
        hs = {}
        if obj.metadata ~= nil and obj.metadata.creationTimestamp ~= nil then
          hs.status = &quot;Healthy&quot;
          hs.message = &quot;Ingress 已创建&quot;
        else
          hs.status = &quot;Progressing&quot;
          hs.message = &quot;Ingress 正在创建中&quot;
        end
        return hs
</code></pre>
<p>上面的配置表示如果 Ingress 资源对象的 <code>metadata.creationTimestamp</code> 字段不为空，则表示健康状态为 Healthy，否则为 Progressing，更新上面的配置后，我们再次查看应用的健康状态就会发现已经变成了 Healthy 状态：</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_7.png" title="Body image" /></p>
<p>接下来我们就可以使用 ArgoCD Image Updater 来更新镜像了，修改上面的 Application 资源清单文件，我们需要添加一些注解来指定需要更新的镜像规则策略，如下所示：</p>
<pre><code>apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: gitops-demo
  namespace: argocd
  annotations:
    argocd-image-updater.argoproj.io/image-list: myalias=ghcr.io/cnych/gitops-demo # 指定镜像仓库
    argocd-image-updater.argoproj.io/myalias.allow-tags: regexp:^.*$ # 允许所有标签
    argocd-image-updater.argoproj.io/myalias.pull-secret: pullsecret:argocd/ghcr-secret # 指定凭据
    argocd-image-updater.argoproj.io/myalias.update-strategy: latest # 指定更新策略
    # argocd-image-updater.argoproj.io/myalias.ignore-tags: latest, master # 指定忽略的标签
    argocd-image-updater.argoproj.io/write-back-method: git # 指定写回方法
    argocd-image-updater.argoproj.io/git-branch: master # 指定 Git 分支
    argocd-image-updater.argoproj.io/myalias.force-update: &quot;true&quot; # 强制更新
spec:
  destination:
    namespace: gitops-demo
    server: https://kubernetes.default.svc
  project: default
  source:
    path: helm # 从 Helm 存储库创建应用程序时，chart 必须指定 path
    repoURL: https://github.com/cnych/k8s-devops-gitops-demo.git
    targetRevision: master
    helm:
      parameters:
        - name: replicaCount
          value: &quot;2&quot;
      valueFiles:
        - my-values.yaml
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
</code></pre>
<p>这个新的资源对象中，我们添加了一些注释，这些注释用于配置 Argo CD Image Updater。这些配置用于指定自动更新容器镜像的策略、参数和相关信息。以下是对这些注释的详细解释：</p>
<ul>
<li><code>argocd-image-updater.argoproj.io/image-list</code>: 这个注解定义了应用中使用的镜像列表。</li>
<li><code>argocd-image-updater.argoproj.io/allow-tags</code>: 这个注解指定了允许更新的镜像标签，可以使用正则表达式的方式。</li>
<li><code>argocd-image-updater.argoproj.io/&lt;alias&gt;.pull-secret</code>: 这个注解指定了用于拉取镜像的 Secret。</li>
<li>
<p><code>argocd-image-updater.argoproj.io/update-strategy:</code> 这个注解定义了镜像更新策略。这里的值是 latest，表示使用最新的镜像标签进行更新，还可以指定的值包括：digest、name、semver。</p>
<ul>
<li>latest: 使用最新的镜像标签进行更新。</li>
<li>digest: 使用镜像的 digest 进行更新。</li>
<li>name: 使用镜像的名称进行更新。</li>
<li>semver: 使用 semver 进行更新</li>
</ul>
</li>
</ul>
<p><code>argocd-image-updater.argoproj.io/write-back-method</code>: 这个注解定义了更新后的配置写回方法。git 表示将更新后的配置写回到 Git 仓库。</p>
<ul>
<li>git: 将更新后的配置写回到 Git 仓库。</li>
<li>patch: 使用 kubectl patch 命令更新资源。</li>
<li>
<p>replace: 使用 kubectl replace 命令更新资源。</p>
</li>
<li>
<p><code>argocd-image-updater.argoproj.io/git-branch</code>: 这个注解定义了更新后的配置写回到 Git 仓库的分支。</p>
</li>
</ul>
<p>现在我们重新更新 Application 资源对象即可。接下来我们只需要重新推送一个新的镜像到 GitHub Container Registry 即可自动触发 ArgoCD Image Updater 更新镜像。</p>
<p>我们更新下仓库中的 main.go 文件：</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_8.png" title="Body image" /></p>
<p>现在我们重新构建一个新的镜像并推送到 GitHub Container Registry：</p>
<pre><code>docker build --platform linux/amd64 -t ghcr.io/cnych/gitops-demo:v0.1.1 .
docker push ghcr.io/cnych/gitops-demo:v0.1.1
</code></pre>
<p>推送新的镜像后，然后 Argo CD Image Updater 将会每 2 分钟从镜像仓库去检索镜像版本变化，一旦发现有新的镜像版本，它将自动使用新版本来更新集群内工作负载的镜像，并将镜像版本回写到 Git 仓库中去，我们可以去查看 Argo CD Image Updater 的日志变化：</p>
<pre><code>$ kubectl logs -f argocd-image-updater-57b788886d-d4qh5 -n argocd
time=&quot;2024-09-27T06:51:32Z&quot; level=info msg=&quot;argocd-image-updater v0.14.0+af844fe starting [loglevel:INFO, interval:2m0s, healthport:8080]&quot;
time=&quot;2024-09-27T06:51:32Z&quot; level=warning msg=&quot;commit message template at /app/config/commit.template does not exist, using default&quot;
time=&quot;2024-09-27T08:35:39Z&quot; level=warning msg=&quot;\&quot;latest\&quot; strategy has been renamed to \&quot;newest-build\&quot;. Please switch to the new convention as support for the old naming convention will be removed in future versions.&quot; image_alias=myalias image_name=ghcr.io/cnych/gitops-demo registry_url=ghcr.io
time=&quot;2024-09-27T08:35:40Z&quot; level=info msg=&quot;Processing results: applications=1 images_considered=1 images_skipped=0 images_updated=0 errors=0&quot;
xxxxxxxxxxxxxxtime=&quot;2024-09-27T08:37:40Z&quot; level=info msg=&quot;Starting image update cycle, considering 1 annotated application(s) for update&quot;
time=&quot;2024-09-27T08:37:40Z&quot; level=warning msg=&quot;\&quot;latest\&quot; strategy has been renamed to \&quot;newest-build\&quot;. Please switch to the new convention as support for the old naming convention will be removed in future versions.&quot; image_alias=myalias image_name=ghcr.io/cnych/gitops-demo registry_url=ghcr.io
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;Setting new image to ghcr.io/cnych/gitops-demo:v0.1.1&quot; alias=myalias application=gitops-demo image_name=cnych/gitops-demo image_tag=latest registry=ghcr.io
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;Successfully updated image 'ghcr.io/cnych/gitops-demo:latest' to 'ghcr.io/cnych/gitops-demo:v0.1.1', but pending spec update (dry run=false)&quot; alias=myalias application=gitops-demo image_name=cnych/gitops-demo image_tag=latest registry=ghcr.io
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;Committing 1 parameter update(s) for application gitops-demo&quot; application=gitops-demo
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;Starting configmap/secret informers&quot;
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;Configmap/secret informer synced&quot;
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;Initializing https://github.com/cnych/k8s-devops-gitops-demo.git to /tmp/git-gitops-demo1873820104&quot;
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;secrets informer cancelled&quot;
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;configmap informer cancelled&quot;
time=&quot;2024-09-27T08:37:44Z&quot; level=info msg=&quot;git fetch origin --tags --force --prune&quot; dir=/tmp/git-gitops-demo1873820104 execID=acebc
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=Trace args=&quot;[git fetch origin --tags --force --prune]&quot; dir=/tmp/git-gitops-demo1873820104 operation_name=&quot;exec git&quot; time_ms=1640.146246
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=&quot;git config user.name argocd-image-updater&quot; dir=/tmp/git-gitops-demo1873820104 execID=7ec2d
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=Trace args=&quot;[git config user.name argocd-image-updater]&quot; dir=/tmp/git-gitops-demo1873820104 operation_name=&quot;exec git&quot; time_ms=1.5687190000000002
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=&quot;git config user.email noreply@argoproj.io&quot; dir=/tmp/git-gitops-demo1873820104 execID=6e796
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=Trace args=&quot;[git config user.email noreply@argoproj.io]&quot; dir=/tmp/git-gitops-demo1873820104 operation_name=&quot;exec git&quot; time_ms=1.688394
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=&quot;git checkout --force master&quot; dir=/tmp/git-gitops-demo1873820104 execID=403bb
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=Trace args=&quot;[git checkout --force master]&quot; dir=/tmp/git-gitops-demo1873820104 operation_name=&quot;exec git&quot; time_ms=4.522311
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=&quot;git clean -ffdx&quot; dir=/tmp/git-gitops-demo1873820104 execID=b3f03
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=Trace args=&quot;[git clean -ffdx]&quot; dir=/tmp/git-gitops-demo1873820104 operation_name=&quot;exec git&quot; time_ms=1.429556
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=&quot;git -c gpg.format=openpgp commit -a -F /tmp/image-updater-commit-msg441967746&quot; dir=/tmp/git-gitops-demo1873820104 execID=0efc6
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=Trace args=&quot;[git -c gpg.format=openpgp commit -a -F /tmp/image-updater-commit-msg441967746]&quot; dir=/tmp/git-gitops-demo1873820104 operation_name=&quot;exec git&quot; time_ms=5.239213
time=&quot;2024-09-27T08:37:46Z&quot; level=info msg=&quot;git push origin master&quot; dir=/tmp/git-gitops-demo1873820104 execID=fcd1f
time=&quot;2024-09-27T08:37:47Z&quot; level=info msg=Trace args=&quot;[git push origin master]&quot; dir=/tmp/git-gitops-demo1873820104 operation_name=&quot;exec git&quot; time_ms=1934.14529
time=&quot;2024-09-27T08:37:47Z&quot; level=info msg=&quot;Successfully updated the live application spec&quot; application=gitops-demo
time=&quot;2024-09-27T08:37:47Z&quot; level=info msg=&quot;Processing results: applications=1 images_considered=1 images_skipped=0 images_updated=1 errors=0&quot;
</code></pre>
<p>然后在 Git 仓库中我们也可以看到有一条新的 commit 提交记录，可以看到在回写时，ArgoCD Image Updater 并不会直接修改仓库的 <code>values.yaml</code> 文件，而是会创建一个专门用于覆盖 <code>Helm Chart values.yaml</code> 的 <code>.argocd-source-devops-demo.yaml</code> 文件。</p>
<p><img alt="Alt Image Text" src="../../images/argo1_8_9.png" title="Body image" /></p>
<p>自动提交变更后，Argo CD 就会自动同步部署应用了。</p>
<p>当然现在访问应用结果就是我们更改后的内容了：</p>
<pre><code>$ curl http://gitops-demo.k8s.local/
{&quot;msg&quot;:&quot;Hello ArgoCD With Image Updater&quot;}
</code></pre>
<p><img alt="Alt Image Text" src="../../images/argo1_8_10.png" title="Body image" /></p>
<p>另外我们可以注意到每次 Git 提交都与作者的姓名和电子邮件地址相关联。如果未配置，Argo CD 镜像更新程序执行的提交将使用 <code>argocd-image-updater &lt;noreply@argoproj.io&gt;</code> 作为作者。</p>
<p>您可以使用 <code>--git-commit-user</code> 和 <code>--git-commit-email</code>命令行开关覆盖作者，或在 <code>argocd-image-updater-config ConfigMap</code> 中设置 <code>git.user</code> 和 <code>git.email</code> 即可。</p>
<p>同样我们可以将 Argo CD Image Updater 使用的默认提交消息更改为适合你的方式。可以创建一个简单的模板（使用 Golang Template），并通过将 <code>argocd-image-updater-config ConfigMap</code> 中的密钥 <code>git.commit-message-template</code> 设置为模板的内容来使其可用，例如：</p>
<pre><code>data:
  git.commit-message-template: |
    build: automatic update of {{ .AppName }}

    {{ range .AppChanges -}}
    updates image {{ .Image }} tag '{{ .OldTag }}' to '{{ .NewTag }}'
    {{ end -}}
</code></pre>
<p>模板中提供了两个顶级变量：</p>
<ul>
<li><code>.AppName</code> 是正在更新的应用程序的名称</li>
<li>
<p><code>.AppChanges</code> 是更新所执行的更改的列表。此列表中的每个条目都是一个结构体，为每个更改提供以下信息：</p>
<ul>
<li><code>.Image</code> 保存已更新图像的全名</li>
<li><code>.OldTag</code> 保存更新之前的标签名称或 SHA 摘要</li>
<li><code>.NewTag</code> 保存更新为的标签名称或 SHA 摘要</li>
</ul>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>