{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u624b\u6478\u624b Gitlab CICD &amp; Project Management\u6559\u7a0b","text":"<p>Started at July 9th, 2022 By Jacob Xi</p>"},{"location":"#jxs-chit-chat","title":"JX's chit-chat","text":"<p>Hi, this part is fucking new and freshing\ud83e\udd14</p> <p>\u8bb0\u5f55\u4e00\u4e0b\u751f\u6d3b\uff0c\u4eca\u65e5Aug 21st 2022\u3002\u8fd1\u65e5\u53d1\u73b0\uff0c\u4e0d\u61c2\u6280\u672f\u7684\u4eba\uff0c\u53ea\u80fd\u505a\u4e8c\u4f20\u624b\uff0c\u6ca1\u6709\u80fd\u529b\u7684\u4eba\uff0c\u53ea\u4f1a\u53bb\u5435\u67b6\u3002\u4eba\u5c31\u662f\u8fd9\u6837\uff0c\u522b\u603b\u63d0\u81ea\u5df1\u62e5\u6709\u8f6f\u5b9e\u529b\uff0c\u90a3\u771f\u7684\u5c31\u662f\u8f6f\u3002\u6ca1\u6709\u672c\u4e8b\u7684\u4eba\uff0c\u53ea\u4f1a\u778eBBB\u3002</p> <p>PS: \u4eca\u5e74\u7b2c\u4e00\u4e2a\u8bc1\u4e66\uff0cDP900 \u8fd8\u4f1a\u8fdc\u5417</p> <p>\u8bf4\u8bf4\u6700\u8fd1\u770b\u7684\u65b0\u5267\u548c\u5c0f\u8bf4\u5427</p> <ul> <li>\u8d5b\u535a\u670b\u514b\uff1a\u8fb9\u7f18\u8dd1\u624b Cyberpunk: Edgerunners, CDPR YYDS</li> <li>House of the Dragon \u8840\u9f99\u72c2\u821e YYDS</li> </ul>"},{"location":"#badge","title":"\u8bc1\u4e66 &amp; Badge:","text":"<p>https://www.credly.com/badges/5ed43677-e884-413a-882d-3bd206832889/public_url</p> <p></p>"},{"location":"#_1","title":"\u5185\u5bb9\u7b80\u4ecb","text":"<ul> <li>Gitlab \u7b80\u4ecb\uff0cbranch Strategy\uff0c\u57fa\u4e8e\u865a\u62df\u673a\u548cK8S\u73af\u5883\u7684\u5b89\u88c5</li> <li>GitLab Runner\u5b89\u88c5\u6ce8\u518c\u914d\u7f6e\u7ba1\u7406</li> <li>GitLabCI\u7cfb\u5217\u4e4b\u6d41\u6c34\u7ebf\u8bed\u6cd5 (Hands On Assessment)</li> <li>Gitlab\u5de5\u5177\u94fe\u96c6\u6210\uff08\u6a21\u677f\u5e93\u8bbe\u8ba1Maven+NPM\uff0c\u4ee3\u7801\u8d28\u91cf\u5e73\u53f0SonarQube\uff0cJFrog Artifactory \u4ed3\u5e93\u96c6\u6210\uff0c \u81ea\u52a8\u5316\u6d4b\u8bd5\u96c6\u6210Jmeter\uff09</li> <li>Gitlab + Kubernetes\u96c6\u6210</li> <li>Gitlab\u6d41\u6c34\u7ebf\u6700\u4f73\u5b9e\u8df5\uff0c\u9879\u76ee\u4ea4\u4ed8\u6d41\u6c34\u7ebf</li> <li>Gitlab Project Management</li> </ul>"},{"location":"#previous-on-my-technolog-book","title":"Previous on my Technolog book","text":"<p>\u624b\u6478\u624bPrometheus&amp;Thanos\u76d1\u63a7\u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09</p> <p>\u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Redis \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Chef &amp; Ansible \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b\u5206\u5e03\u5f0f\u4e0e\u6d41\u5f0f\u7cfb\u7edf (In progress)</p> <p>Azure 103&amp;900 Tutorial (In progress)</p> <p>\u624b\u6478\u624b Linux Performance &amp; \u9762\u8bd5\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Databases \u5168\u6559\u7a0b</p> <p>AWS Certified Data Analytics Tutorial</p> <p>Istio &amp; Service Mesh \u6218\u672f\u6559\u7a0b</p> <p>AWS Certification Solutions Architect Book</p> <p>\u624b\u6478\u624bPrometheus&amp;Thanos\u76d1\u63a7\u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>Distributed Message System Book(Kafka)</p>"},{"location":"#salut-cest-moi","title":"Salut! C'est Moi","text":"<p>Do or Do not, there is no try</p> <p>Hello, this is me, Jacob. Currently, I'm working as IT Cloud Architect in UBS, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins &amp; Gitlab CI/CD and ElasticStack enthusiast.</p> <p>I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021.</p> <p>If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002</p> <p>Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur iT Cloud Architect dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD.</p> <p>Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e.</p>"},{"location":"#to-be-continue","title":"To be continue","text":"<p>I will start working on Fintech book later on and in future, I will put more effort do finish \"Hashicorp Book\".\ud83d\ude42</p> <p></p>"},{"location":"argo1/0gitops/","title":"GitOps \u5e38\u7528\u5de5\u5177\u76d8\u70b9","text":"<p>Kubernetes \u7684\u4f18\u52bf\u4e3b\u8981\u5728\u4e8e\u5b83\u7684\u58f0\u660e\u5f0f\u6027\u8d28\u4e0e\u63a7\u5236\u5faa\u73af\u76f8\u7ed3\u5408\uff0c\u5e76\u901a\u8fc7\u8fd9\u4e9b\u63a7\u5236\u5faa\u73af\u6301\u7eed\u76d1\u63a7\u96c6\u7fa4\u7684\u6d3b\u52a8\u72b6\u6001\uff0c\u786e\u4fdd\u5b83\u4e0e etcd \u4e2d\u5b58\u50a8\u7684\u671f\u671b\u72b6\u6001\u4fdd\u6301\u4e00\u81f4\u3002</p> <p>\u8fd9\u79cd\u65b9\u5f0f\u975e\u5e38\u5f3a\u5927\uff0c\u4f46\u540c\u65f6\u5176\u6570\u636e\u5e93\u4e5f\u88ab\u9650\u5236\u4e3aetcd(etcd\u4ec5\u63d0\u4f9b\u4e86\u6709\u9650\u7684\u53ef\u89c2\u5bdf\u6027)\uff0c\u5e76\u5f71\u54cd\u5230\u4e86\u96c6\u7fa4\u53d8\u66f4\u65f6\u7684\u8d23\u4efb\u6027\u548c\u5ba1\u8ba1\u6027\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a\u7f3a\u70b9\u662f\u5c06etcd\u548c\u4ee3\u7801\u4ed3\u5e93\u4f5c\u4e3a\u4e24\u4e2aSOT(sources of truth)\uff0c\u6709\u53ef\u80fd\u4f1a\u5bfc\u81f4\u914d\u7f6e\u6f02\u79fb\uff0c\u9020\u6210\u7ba1\u7406\u4e0a\u7684\u56f0\u96be\u3002</p> <p>\u5f00\u53d1\u8005\u4f7f\u7528\u4ee3\u7801\u4ed3\u5e93\u8fd9\u79cd\u5b89\u5168\u4e14\u53ef\u8ffd\u6eaf\u7684\u65b9\u5f0f\u6765\u4fdd\u5b58\u4ee3\u7801\uff0c\u5e76\u5f00\u53d1\u51fa\u4e86 Workflows \u8fd9\u79cd\u65b9\u5f0f\u6765\u9ad8\u6548\u5730\u7ba1\u7406\u4e2d\u592e\u4ed3\u5e93\uff0c\u4e0d\u540c\u7684\u56e2\u961f\u53ef\u4ee5\u5e76\u884c\u5de5\u4f5c\uff0c\u4e14\u4e0d\u4f1a\u4ea7\u751f\u8fc7\u591a\u7684\u51b2\u7a81\uff0c\u540c\u65f6\u4fdd\u8bc1\u5bf9\u6240\u6709\u53d8\u66f4\u8fdb\u884c\u5ba1\u6838\uff0c\u5e76\u652f\u6301\u8ffd\u6eaf\u548c\u56de\u6eda\u3002</p> <p>\u5982\u679c\u6211\u4eec\u80fd\u591f\u4ece\u56f4\u7ed5 Git \u4ed3\u5e93\u521b\u5efa\u7684\u6d41\u7a0b\u4e2d\u83b7\u5f97\u8fd9\u4e9b\u4f18\u52bf\uff0c\u5e76\u5c06\u5b83\u4eec\u6269\u5c55\u5230\u57fa\u7840\u8bbe\u65bd\u6216\u662f kubernetes \u4e2d\uff0c\u90a3\u4e0d\u662f\u5f88\u597d\u5417\uff1f</p>"},{"location":"argo1/0gitops/#gitops_1","title":"\u4ec0\u4e48\u662f GitOps\uff1f","text":"<p>GitOps \u7684\u76ee\u7684\u662f\u5c06 etcd \u7684\u8fd9\u79cd\u58f0\u660e\u5f0f\u7279\u6027\u6269\u5c55\u5230(\u4fdd\u5b58\u4ee3\u7801\u7684) Git \u4ed3\u5e93\uff0c\u5e76\u4f5c\u4e3a SSOT(single source of truth)\u3002</p> <p>\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 Git \u5e26\u6765\u7684\u4f18\u52bf\uff0c\u5982\u4ee3\u7801\u76d1\u89c6\u3001\u5386\u53f2\u53d8\u66f4\u3001\u5feb\u901f\u56de\u6eda\u3001\u53ef\u8ffd\u6eaf\u6027\u7b49\u7b49\u3002</p> <p>GitOps \u7684\u6838\u5fc3\u89c2\u70b9\u662f\u4f7f\u7528\u5305\u542b\u5f53\u524d\u671f\u671b\u7684(\u751f\u4ea7\u73af\u5883\u57fa\u7840\u8bbe\u65bd\u7684)\u58f0\u660e\u5f0f\u63cf\u8ff0\u7684 GIt \u4ed3\u5e93\uff0c\u5e76\u901a\u8fc7\u81ea\u52a8\u5316\u6d41\u7a0b\u6765\u786e\u4fdd\u751f\u4ea7\u73af\u5883\u4e0e\u4ed3\u5e93\u4e2d\u7684\u671f\u671b\u72b6\u6001\u4fdd\u6301\u4e00\u81f4\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u8981\u90e8\u7f72\u4e00\u4e2a\u65b0\u7684\u5e94\u7528\u6216\u66f4\u65b0\u4e00\u4e2a\u73b0\u6709\u7684\u5e94\u7528\uff0c\u53ea\u9700\u8981\u66f4\u65b0\u76f8\u5e94\u7684\u4ed3\u5e93\u5373\u53ef(\u81ea\u52a8\u5316\u6d41\u7a0b\u4f1a\u5904\u7406\u540e\u7eed\u7684\u4e8b\u60c5)\u3002\u8fd9\u5c31\u50cf\u5728\u751f\u4ea7\u4e2d\u4f7f\u7528\u5de1\u822a\u63a7\u5236\u6765\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u4e00\u6837\u3002</p> <p>GitOps \u4e0d\u4ec5\u9650\u4e8e Kubernetes\uff0c\u5b9e\u9645\u4e0a\u5b83\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5c06 \u57fa\u7840\u8bbe\u65bd\u4f5c\u4e3a\u4ee3\u7801 \u4fdd\u5b58\u5230GIt\u4ed3\u5e93\u4e2d\u6765\u5c06\u5e94\u7528\u4ee3\u7801\u5ef6\u4f38\u5230\u57fa\u7840\u8bbe\u65bd\u4e2d\uff0c\u8fd9\u901a\u5e38\u662f\u901a\u8fc7 Terraform \u8fd9\u6837\u7684\u5de5\u5177\u8fdb\u884c\u666e\u53ca\u7684\u3002</p> <p>\u58f0\u660e\u5f0f\u57fa\u7840\u8bbe\u65bd\u65e2\u4ee3\u7801 \u5728\u5b9e\u73b0GitOps\u4e2d\u626e\u6f14\u7740\u4e00\u4e2a\u91cd\u8981\u7684\u4f5c\u7528\uff0c\u4f46\u4e0d\u4ec5\u9650\u4e8e\u6b64\u3002</p> <p>GitOps\u56f4\u7ed5Git\u6784\u5efa\u4e86\u6574\u4e2a\u751f\u6001\u7cfb\u7edf\u548c\u5de5\u5177\uff0c\u5e76\u5c06\u5176\u5e94\u7528\u5230\u57fa\u7840\u8bbe\u65bd\uff0c\u4ec5\u4ec5\u5728Git\u4e2d\u4f7f\u7528Terraform\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u57fa\u7840\u8bbe\u65bd\u7684\u72b6\u6001\u80fd\u591f\u4e0e\u751f\u4ea7\u73af\u5883\u4fdd\u6301\u4e00\u81f4\uff0c\u8fd8\u9700\u8981\u6301\u7eed\u8fd0\u884cTerraform\u547d\u4ee4(terraform apply)\u6765\u76d1\u63a7\u5b9e\u65f6\u7248\u672c\u7684\u53d8\u5316\uff0c\u4ee5\u53ca\u5728\u6d41\u6c34\u7ebf\u4e2d\u5b9e\u73b0\u624b\u52a8\u5ba1\u6279\u7b49\u529f\u80fd\u3002</p>"},{"location":"argo1/0gitops/#kubernetes-gitops","title":"Kubernetes \u4e2d\u7684 Gitops","text":"<p>Kubernetes \u4ece\u4e00\u5f00\u59cb\u5c31\u6709\u63a7\u5236\u5faa\u73af\u7684\u60f3\u6cd5\uff0c\u8fd9\u610f\u5473\u7740 Kunernetes \u603b\u662f\u4f1a\u76d1\u63a7\u96c6\u7fa4\u7684\u72b6\u6001\u6765\u4fdd\u8bc1\u8fbe\u5230\u671f\u671b\u72b6\u6001\u3002\u4f8b\u5982\uff0c\u4f7f\u8fd0\u884c\u7684\u526f\u672c\u6570\u4e0e\u671f\u671b\u7684\u526f\u672c\u6570\u5339\u914d\u3002\u5c06 GitOps \u7684\u7406\u5ff5\u5ef6\u7533\u5230\u5e94\u7528\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5c06\u670d\u52a1\u5b9a\u4e49\u4e3a\u4ee3\u7801\uff0c\u4f8b\u5982\uff0c\u901a\u8fc7\u5b9a\u4e49 Helm Charts\uff0c\u5e76\u4f7f\u7528\u4e00\u4e2a\u901a\u8fc7K8s\u63d0\u4f9b\u7684\u529f\u80fd\u6765\u76d1\u63a7App\u72b6\u6001\u7684\u5de5\u5177\u6765\u8c03\u6574\u5bf9\u5e94\u7684\u96c6\u7fa4\u72b6\u6001\uff0c\u5373\uff0c\u66f4\u65b0\u4e86\u4ee3\u7801\u4ed3\u5e93\uff0c\u6216\u66f4\u65b0\u4e86\u751f\u4ea7\u96c6\u7fa4\u7684 helm chart\u3002\u8fd9\u624d\u662f\u771f\u6b63\u7684\u6301\u7eed\u90e8\u7f72\u3002\u5176\u4e2d\u7684\u6838\u5fc3\u539f\u5219\u662f\uff0c\u5e94\u7528\u90e8\u7f72\u548c\u751f\u547d\u5468\u671f\u7ba1\u7406\u5e94\u8be5\u662f\u81ea\u52a8\u5316\u7684\u3001\u53ef\u5ba1\u8ba1\u5e76\u6613\u4e8e\u7406\u89e3\u7684\u3002</p> <p>\u6bcf\u4e2a\u73af\u5883\u90fd\u5e94\u8be5\u6709\u4e00\u4e2a\u4ee3\u7801\u4ed3\u5e93\uff0c\u7528\u4e8e\u5b9a\u4e49\u7ed9\u5b9a\u96c6\u7fa4\u7684\u671f\u671b\u72b6\u6001\u3002\u7136\u540e Kubernetes Operators \u4f1a\u6301\u7eed\u76d1\u63a7\u7279\u5b9a\u5206\u652f(\u901a\u5e38\u662fmaster\u5206\u652f)\uff0c\u5e76\u5728\u63a2\u6d4b\u5230 Git \u53d1\u751f\u53d8\u66f4\u540e\uff0c\u5c06\u6b64\u6b21\u53d8\u66f4\u4f20\u9012\u5230\u96c6\u7fa4\uff0c\u5e76\u66f4\u65b0etcd\u4e2d\u7684\u72b6\u6001\u3002\u5728\u8fd9\u79cd\u65b9\u5f0f\u4e2d\uff0cetcd\u53ea\u4f5c\u4e3a\u4e00\u4e2a\u6570\u636e\u5e93\uff0c\u4e14\u4e0d\u662f\u552f\u4e00\u7684SOT\u3002</p> <p>\u53ef\u4ee5\u5728\u5305\u542b\u58f0\u660e\u5f0fKubernetes\u57fa\u7840\u8bbe\u65bd\u7684Git\u4ed3\u5e93\u4e2d\u5b9a\u4e49\u5e94\u7528\u7684Helm chart\u3002\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u94fe\u63a5\u5b58\u50a8\u5e93\uff0c\u8fd9\u6837\u4e00\u4e2a\u5b58\u50a8\u5e93\u53ef\u4ee5\u76d1\u89c6\u53e6\u4e00\u4e2a\u5b58\u50a8\u5e93\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</p> <p>Kubernetes GitOps\u5de5\u5177\u53ef\u4ee5\u76d1\u63a7\u5176\u4ed6\u4ed3\u5e93(\u5982Helm Chart\u4ed3\u5e93)\u7684\u72b6\u6001\uff0c\u8fd9\u6837\u4f60\u7684\u96c6\u7fa4\u73af\u5883\u4ed3\u5e93\u4e2d\u65e0\u9700\u5305\u542bHelm Chart\uff0c\u53ea\u9700\u8981\u4e00\u6761\u5230Helm \u4ed3\u5e93\u7684\u8fde\u63a5\uff0c\u5e76\u4f7f\u7528\u8be5\u94fe\u63a5\u76d1\u63a7\u5176\u53d8\u66f4\u5373\u53ef\uff0c\u8fd9\u6837\u5f53\u4f60\u53d1\u5e03\u7684\u4e00\u4e2a\u65b0\u7684chart\u65f6\uff0c\u540e\u7eed\u4f1a\u5c06\u8be5chart\u81ea\u52a8\u90e8\u7f72\u5230\u96c6\u7fa4\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u81ea\u52a8\u6267\u884c\u7aef\u5230\u7aef\u7684\u58f0\u660e\u5f0fCI/CD\u6d41\u6c34\u7ebf\u3002</p>"},{"location":"argo1/0gitops/#gitops_2","title":"\u58f0\u660e\u5f0f GitOps \u5de5\u5177","text":""},{"location":"argo1/0gitops/#argocd","title":"ArgoCD","text":"<p>Kubernetes \u4e0a\u6700\u597d\u7684 GitOps \u5de5\u5177\u5c31\u662f ArgoCD[9] \u3002ArgoCD \u662fArgo\u751f\u6001\u7cfb\u7edf\u7684\u4e00\u90e8\u5206\uff0c\u8be5\u751f\u6001\u7cfb\u7edf\u5305\u542b\u4e86\u5f88\u591a\u5f88\u597d\u7684\u5de5\u5177\uff0c\u540e\u7eed\u4f1a\u8fdb\u884c\u8ba8\u8bba\u3002</p> <p>\u4f7f\u7528 ArgoCD\uff0c\u53ef\u4ee5\u5728\u4ee3\u7801\u5e93\u4e2d\u5b9a\u4e49\u6bcf\u4e2a\u73af\u5883\u7684\u6240\u6709\u914d\u7f6e\u3002Argo CD \u4f1a\u5728\u7279\u5b9a\u7684\u76ee\u6807\u73af\u5883\u4e2d\u81ea\u52a8\u90e8\u7f72\u6240\u9700\u7684\u5e94\u7528\u72b6\u6001\u3002</p> <p></p> <p>Argo CD \u4f5c\u4e3a\u4e00\u4e2a kubernetes controller\uff0c\u6301\u7eed\u76d1\u63a7\u8fd0\u884c\u7684\u5e94\u7528\uff0c\u5e76\u5c06\u5f53\u524d\u7684\u6d3b\u52a8\u72b6\u6001\u4e0e\u6240\u9700\u7684\u76ee\u6807\u72b6\u6001(\u5982 Git repo \u4e2d\u63cf\u8ff0\u7684\u72b6\u6001)\u8fdb\u884c\u6bd4\u8f83\u3002Argo CD \u4f1a\u62a5\u544a\u5e76\u5448\u73b0\u8fd9\u79cd\u5dee\u5f02\uff0c\u5e76\u901a\u8fc7\u81ea\u52a8\u6216\u624b\u52a8\u7684\u65b9\u5f0f\u5c06\u5b9e\u65f6\u72b6\u6001\u540c\u6b65\u5230\u671f\u671b\u7684\u76ee\u6807\u72b6\u6001</p> <p></p> <p>ArgoCD \u6709\u4e00\u4e2a\u975e\u5e38\u68d2\u7684 UI\uff0c\u652f\u6301 SSO\uff0c\u5b83\u662f\u5b89\u5168\u3001\u53ef\u6269\u5c55\u4e14\u6613\u4e8e\u4f7f\u7528\u7684\u3002</p> <p>Flux</p> <p>Flux \u662f\u9664 ArgoCD \u5916\u53e6\u4e00\u4e2a\u975e\u5e38\u6709\u540d\u9879\u76ee\u3002\u6700\u8fd1\u7684\u7248\u672c\u5305\u542b\u5f88\u591a\u6539\u8fdb\uff0c\u529f\u80fd\u4e0a\u975e\u5e38\u63a5\u8fd1 ArgoCD\uff0cFlux \u662f CNCF \u5b75\u5316\u9879\u76ee</p> <p></p>"},{"location":"argo1/0gitops/#gitops_3","title":"GitOps \u5de5\u5177","text":""},{"location":"argo1/0gitops/#helm","title":"helm","text":"<p>Helm \u65e0\u9700\u591a\u8a00\uff0c\u5b83\u662f Kubernetes \u4e0a\u6700\u8457\u540d\u7684\u5305\u7ba1\u7406\u5668\uff0c\u5f53\u7136\uff0c\u4f60\u5e94\u8be5\u50cf\u5728\u7f16\u7a0b\u8bed\u8a00\u4e2d\u4f7f\u7528\u5305\u4e00\u6837\uff0c\u5728K8s\u4e2d\u4f7f\u7528\u5305\u7ba1\u7406\u5668\u3002Helm \u5141\u8bb8\u4f7f\u7528 Charts \u7684\u65b9\u5f0f\u6253\u5305\u5e94\u7528\uff0c\u5c06\u590d\u6742\u7684\u5e94\u7528\u62bd\u8c61\u4e3a\u53ef\u91cd\u7528\u7684\u7b80\u5355\u7ec4\u4ef6\uff0c\u4fbf\u4e8e\u5b9a\u4e49\u3001\u5b89\u88c5\u548c\u5347\u7ea7\u3002</p> <p>\u5b83\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u6a21\u677f\u5f15\u64ce\uff0cHelm \u5df2\u7ecf\u5f88\u6210\u719f\uff0c\u5b83\u5305\u542b\u5f88\u591a\u9884\u5b9a\u4e49\u7684charts\uff0c\u652f\u6301\u6027\u5f3a\uff0c\u4f7f\u7528\u65b9\u4fbf\u3002</p> <p>Helm \u53ef\u4ee5\u5f88\u597d\u5730\u96c6\u6210\u5230 ArgoCD \u6216 Flux\uff0c\u540e\u8005\u53ef\u4ee5\u76d1\u63a7 Helm \u4ed3\u5e93\u7684\u53d8\u5316\uff0c\u5e76\u5728\u53d1\u5e03\u65b0\u7684 charts \u65f6\u8fdb\u884c\u90e8\u7f72\u3002\u5b9e\u73b0\u601d\u8def\u662f\u5c06 ArgoCD \u6216 Flux \u6307\u5411 Helm \u4ed3\u5e93\uff0c\u5e76\u6307\u5b9a\u4e00\u4e2a\u7279\u5b9a\u7684\u7248\u672c\u6216\u901a\u914d\u7248\u672c\u3002</p> <p>\u5982\u679c\u4f7f\u7528\u901a\u914d\u7248\u672c\uff0c\u4e00\u65e6\u53d1\u5e03\u4e86\u65b0\u7684\u7248\u672c\uff0c\u5c31\u4f1a\u8fdb\u884c\u81ea\u52a8\u90e8\u7f72\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e3b\u7248\u672c\u6216\u6b21\u7248\u672c\u7684\u65b9\u5f0f\u8fdb\u884c\u547d\u540d\u3002\u6211\u901a\u5e38\u503e\u5411\u4e8e\u5c06\u5e94\u7528\u6253\u5305\u5230 charts \u4e2d\uff0c\u5c06\u5176\u4f5c\u4e3a CI/CD \u7684\u4e00\u90e8\u5206\u8fdb\u884c\u6784\u5efa\uff0c\u5e76\u8ba9 ArgoCD \u76d1\u63a7\u7279\u5b9a\u7684\u4ed3\u5e93\u3002\u8fd9\u79cd\u5173\u6ce8\u70b9\u5206\u79bb\u5141\u8bb8\u5f00\u53d1\u8005\u5728\u72ec\u7acb\u4e8e\u73af\u5883\u7684\u4ed3\u5e93\u4e2d\u7ba1\u7406\u5e94\u7528\uff0c\u5e76\u8ba9 ArgoCD \u9009\u62e9\u5728\u54ea\u4e2a\u73af\u5883\u4e2d\u90e8\u7f72\u54ea\u4e2a charts\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u591a\u4e2a Helm \u4ed3\u5e93\u5e76\u6839\u636e\u4e0d\u540c\u7684\u73af\u5883\u63a8\u9001\u53d8\u66f4\u3002</p> <p>\u4f8b\u5982\uff0c\u5728\u5408\u5e76\u4e00\u4e2a PR \u540e\uff0c\u53ef\u4ee5\u6267\u884c\u4e00\u6b21 \"bronce\" \u6784\u5efa\uff0c\u8be5\u6784\u5efa\u4f1a\u5c06 Helm chart \u53d1\u5e03\u5230\u4e00\u4e2a\u540d\u4e3a \"bronce\" \u7684\u4ed3\u5e93\u4e2d\u3002dev \u73af\u5883\u7684 ArgoCD \u4ed3\u5e93\u6307\u5411 \"bronce\" \u4ed3\u5e93\uff0c\u5e76\u5728\u53ef\u7528\u65f6\u90e8\u7f72\u65b0\u7248\u672c\u3002staging \u73af\u5883\u7684 ArgoCD \u4ed3\u5e93\u4f1a\u6307\u5411\u540d\u4e3a \"silver\" \u4ed3\u5e93\uff0c\u800c production \u73af\u5883\u5219\u6307\u5411\u540d\u4e3a \"gold\" \u7684\u4ed3\u5e93\u3002\u5f53\u9700\u8981\u5411 staging \u6216 production \u73af\u5883\u63a8\u9001\u67d0\u4e9b\u5185\u5bb9\u65f6\uff0cCI/CD \u53ea\u9700\u5c06\u8be5 chart \u53d1\u5e03\u5230\u4e0b\u4e00\u4e2a\u4ed3\u5e93\u5373\u53ef\u3002</p> <p>ArgoCD \u53ef\u4ee5\u8986\u76d6\u4efb\u4f55\u73af\u5883\u7684\u7279\u5b9a Helm \u503c\u3002</p> <p>Kustomize \u662f\u4e00\u4e2a\u65b0\u7684 helm \u7684\u66ff\u4ee3\u54c1\uff0c\u5b83\u4e0d\u9700\u8981\u6a21\u677f\u5f15\u64ce\uff0c\u800c\u4f7f\u7528\u4e86\u4e00\u4e2a overlay \u5f15\u64ce\uff0c\u4e4b\u4e0a\u6709\u57fa\u672c\u5b9a\u4e49\u548c overlays \u3002</p>"},{"location":"argo1/0gitops/#argo-workflows-argo-events","title":"Argo Workflows \u548c Argo Events","text":"<p>\u5728 Kubernetes \u4e2d\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u8fd0\u884c\u6279\u91cf\u4efb\u52a1\u6216\u590d\u6742\u7684\u5de5\u4f5c\u6d41\uff0c\u4f5c\u4e3a\u6570\u636e\u5904\u7406\u6d41\u7a0b\u3001\u5f02\u6b65\u5904\u7406\u6216 CI/CD \u7684\u4e00\u90e8\u5206\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u8fd0\u884c\u9a71\u52a8\u5fae\u670d\u52a1\u6765\u54cd\u5e94\u7279\u5b9a\u7684\u4e8b\u4ef6\uff0c\u5982\u6587\u4ef6\u4e0a\u4f20\u6216\u53d1\u9001\u6d88\u606f\u5230\u67d0\u4e2a\u961f\u5217\u3002\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e9b\u529f\u80fd\uff0c\u53ef\u4ee5\u4f7f\u7528 Argo Workflows\u548c Argo Events\u3002</p> <p>\u867d\u7136\u5b83\u4eec\u662f\u72ec\u7acb\u7684\u9879\u76ee\uff0c\u4f46\u8d8b\u5411\u4e8e\u90e8\u7f72\u5230\u4e00\u8d77\u3002</p> <p>Argo Workflows \u662f\u4e00\u4e2a\u7c7b\u4f3c Apache Airflow \u7684\u7f16\u6392\u5f15\u64ce\uff0c\u4f46\u5929\u7136\u9002\u7528\u4e8eKubernetes\u3002</p> <p>\u5b83\u4f7f\u7528CRDs\u6765\u5b9a\u4e49\u590d\u6742\u7684workflows(\u4f7f\u7528YAML\u8868\u793a\u7684steps\u6216 DAGs[15] \u6765\u8868\u8fbe\u5de5\u4f5c\u6d41)\u3002\u5b83\u8fd8\u6709\u4e2a\u4e0d\u9519\u7684UI\uff0c\u652f\u6301\u91cd\u8bd5\u673a\u5236\uff0c\u5b9a\u65f6\u4efb\u52a1\uff0c\u8f93\u5165\u8f93\u51fa\u8ddf\u8e2a\u7b49\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u5b83\u6765\u7f16\u6392\u6570\u636e\u5904\u7406\u6d41\u6c34\u7ebf\u548c\u6279\u91cf\u4efb\u52a1\u7b49\u3002</p> <p>\u6709\u65f6\u4f60\u53ef\u80fd\u5e0c\u671b\u5c06\u6d41\u6c34\u7ebf\u4e0e\u5f02\u6b65\u670d\u52a1(\u5982 Kafka\u3001\u961f\u5217\u3001webhook \u6216\u5e95\u5c42\u5b58\u50a8\u670d\u52a1)\u96c6\u6210\u5230\u4e00\u8d77\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u5bf9\u4e0a\u4f20\u6587\u4ef6\u5230S3\u8fd9\u6837\u7684\u4e8b\u4ef6\u505a\u51fa\u54cd\u5e94\uff0c\u6b64\u65f6\u4f60\u53ef\u4ee5\u4f7f\u7528 Argo Events\u3002</p> <p></p> <p>\u4e0a\u8ff0\u4e24\u79cd\u5de5\u5177\u4e3a\u9700\u8981 CI/CD \u6d41\u6c34\u7ebf\u63d0\u4f9b\u4e86\u7b80\u5355\u4e14\u5f3a\u5927\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u53ef\u4ee5\u5728 Kubernetes \u4e0a\u8fd0\u884c CI/CD \u6d41\u6c34\u7ebf\u3002</p> <p>\u7531\u4e8e\u6240\u6709 workflows \u5b9a\u4e49\u90fd\u53ef\u4ee5\u6253\u5305\u5230 Helm charts \u4e2d\uff0c\u56e0\u6b64 Argo Workflows \u53ef\u4ee5\u5f88\u597d\u5730\u96c6\u6210\u5230 ArgoCD\u3002</p> <p>\u5bf9\u4e8e ML \u6d41\u6c34\u7ebf\uff0c\u53ef\u4ee5\u4f7f\u7528 Kubeflow \u5b9e\u73b0\u76f8\u540c\u7684\u76ee\u7684\u3002</p> <p>\u5bf9\u4e8e CI/CD \u6d41\u6c34\u7ebf\uff0c\u53ef\u4ee5\u4f7f\u7528 Tekton\u3002</p>"},{"location":"argo1/0gitops/#istio","title":"Istio","text":"<p>Istio \u662f\u5e02\u9762\u4e0a\u6700\u8457\u540d\u7684 \u670d\u52a1\u7f51\u683c \uff0c\u5b83\u662f\u5f00\u6e90\u7684\uff0c\u4e14\u975e\u5e38\u6d41\u884c\u3002\u7531\u4e8e\u670d\u52a1\u7f51\u683c\u5185\u5bb9\u5e9e\u5927\uff0c\u56e0\u6b64\u8fd9\u91cc\u4e0d\u4f1a\u8ba8\u8bba\u7ec6\u8282\uff0c\u4f46\u5982\u679c\u4f60\u5728\u6784\u5efa\u5fae\u670d\u52a1\uff0c\u6709\u53ef\u80fd\u4f60\u4f1a\u9700\u8981\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u6765\u7ba1\u7406\u901a\u4fe1\u3001\u53ef\u89c2\u6d4b\u6027\u3001\u9519\u8bef\u5904\u7406\u3001\u5b89\u5168\u4ee5\u53ca(\u4f5c\u4e3a\u5fae\u670d\u52a1\u67b6\u6784\u4e00\u90e8\u5206\u7684)\u5176\u4ed6\u4ea4\u53c9\u65b9\u9762\u3002\u4f7f\u7528\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u907f\u514d\u56e0\u4e3a\u91cd\u590d\u7684\u903b\u8f91\u800c\u6c61\u67d3\u5fae\u670d\u52a1\u7684\u4ee3\u7801\u3002</p> <p></p> <p>\u7b80\u800c\u8a00\u4e4b\uff0c\u4e00\u4e2a\u670d\u52a1\u7f51\u683c\u5c31\u662f\u4e00\u4e2a\u7279\u5b9a\u7684\u57fa\u7840\u8bbe\u65bd\u5c42\uff0c\u4f60\u53ef\u4ee5\u5728\u4e0a\u9762\u6dfb\u52a0\u5e94\u7528\uff0c\u5b83\u5141\u8bb8\u900f\u660e\u5730\u6dfb\u52a0\u53ef\u89c2\u6d4b\u6027\u3001\u6d41\u91cf\u7ba1\u7406\u548c\u5b89\u5168\uff0c\u800c\u65e0\u9700\u81ea\u5df1\u5b9e\u73b0\u8fd9\u4e9b\u529f\u80fd\u3002</p> <p>Istio \u4f7f\u7528 CRDs \u6765\u5b9e\u73b0\u5176\u6240\u6709\u529f\u80fd\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06virtual services\u3001gateways\u3001policies\u7b49\u4f5c\u4e3a\u4ee3\u7801\u6253\u5305\u5728Helm charts\u4e2d\uff0c\u5e76\u4f7f\u7528ArgoCD\u6216Flux\u6765\u8ba9Istio\u53d8\u5f97GitOps\u53cb\u597d(\u867d\u7136\u4e0d\u662f\u90a3\u4e48\u5f3a\u5927)\u3002</p> <p>\u8fd8\u53ef\u4ee5\u4f7f\u7528 Linkerd \u6216 Consul \u66ff\u4ee3Istio\u3002</p>"},{"location":"argo1/0gitops/#argo-rollouts","title":"Argo Rollouts","text":"<p>\u4e0a\u9762\u5df2\u7ecf\u63d0\u5230\u8fc7\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u6765\u8fd0\u884c\u4f7f\u7528Argo Workflows \u6216\u7c7b\u4f3c\u5de5\u5177\u7684 CI/CD \u6d41\u6c34\u7ebf\u3002\u4e0b\u4e00\u6b65\u903b\u8f91\u4e0a\u662f\u6267\u884c\u6301\u7eed\u90e8\u7f72\uff0c\u4f46\u5728\u73b0\u5b9e\u573a\u666f\u4e2d\uff0c\u7531\u4e8e\u5176\u98ce\u9669\u8f83\u9ad8\uff0c\u56e0\u6b64\u5927\u90e8\u5206\u516c\u53f8\u53ea\u505a\u4e86\u6301\u7eed\u4ea4\u4ed8\uff0c\u8fd9\u610f\u5473\u7740\u4ed6\u4eec\u53ef\u4ee5\u5b9e\u73b0\u81ea\u52a8\u5316\uff0c\u4f46\u4ecd\u7136\u91c7\u7528\u624b\u52a8\u65b9\u5f0f\u8fdb\u884c\u5ba1\u6279\u548c\u6821\u9a8c\uff0c\u8fd9\u7c7b\u624b\u52a8\u6b65\u9aa4\u7684\u6839\u56e0\u662f\u8fd9\u4e9b\u56e2\u961f\u65e0\u6cd5\u5b8c\u5168\u4fe1\u4efb\u5176\u81ea\u52a8\u5316\u3002</p> <p>\u90a3\u4e48\u8be5\u5982\u4f55\u6784\u5efa\u8fd9\u79cd\u4fe1\u4efb\u5ea6\u6765\u907f\u514d\u4f7f\u7528\u811a\u672c\uff0c\u8fdb\u800c\u5b9e\u73b0\u4ece\u4ee3\u7801\u5230\u751f\u4ea7\u7684\u5b8c\u5168\u81ea\u52a8\u5316\u3002\u7b54\u6848\u662f\uff1a\u53ef\u89c2\u6d4b\u6027\u3002\u4f60\u9700\u8981\u5173\u6ce8\u8d44\u6e90\u7684\u6307\u6807\uff0c\u5e76\u901a\u8fc7\u91c7\u96c6\u6240\u6709\u7684\u6570\u636e\u6765\u7cbe\u786e\u5730\u4f20\u8fbe\u5e94\u7528\u7684\u72b6\u6001\uff0c\u5373\u4f7f\u7528\u4e00\u7ec4\u6307\u6807\u6765\u6784\u5efa\u4fe1\u4efb\u5ea6\u3002\u5982\u679c Prometheus \u4e2d\u5305\u542b\u6240\u6709\u7684\u6570\u636e\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u5b9e\u73b0\u81ea\u52a8\u5316\u90e8\u7f72\uff0c\u56e0\u4e3a\u6b64\u65f6\u4f60\u53ef\u4ee5\u6839\u636e\u6307\u6807\u6765\u5b9e\u73b0\u6eda\u52a8\u66f4\u65b0\u5e94\u7528\u3002</p> <p>\u7b80\u5355\u5730\u8bf4\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 K8s \u63d0\u4f9b\u7684\u5f00\u7bb1\u5373\u7528\u7684\u9ad8\u7ea7\u90e8\u7f72\u6280\u672f-- \u6eda\u52a8\u5347\u7ea7\u3002\u6211\u4eec\u9700\u8981\u4f7f\u7528\u91d1\u4e1d\u96c0\u90e8\u7f72\u6765\u5b9e\u73b0\u6e10\u8fdb\u5f0f\u53d1\u5e03\uff0c\u76ee\u7684\u662f\u5c06\u6d41\u91cf\u9010\u6b65\u8def\u7531\u5230\u65b0\u7248\u672c\u7684\u5e94\u7528\uff0c\u7b49\u5f85\u6307\u6807\u91c7\u96c6\uff0c\u7136\u540e\u8fdb\u884c\u5206\u6790\u5e76\u4e8e\u9884\u5148\u5b9a\u4e49\u7684\u89c4\u5219\u8fdb\u884c\u5339\u914d\u3002\u5982\u679c\u68c0\u67e5\u6b63\u5e38\uff0c\u5219\u589e\u52a0\u6d41\u91cf\uff1b\u5982\u679c\u53d1\u73b0\u95ee\u9898\uff0c\u5219\u56de\u6eda\u90e8\u7f72\u3002</p> <p>\u5728 Kubernetes \u4e0a\u53ef\u4ee5\u4f7f\u7528 Argo Rollouts \u6765\u5b9e\u73b0\u91d1\u4e1d\u96c0\u53d1\u5e03\u3002</p> <p>Argo Rollouts \u662f\u4e00\u4e2a Kubernetes controller\uff0c\u5b83\u4f7f\u7528\u4e00\u7ec4 CRDs \u6765\u63d0\u4f9b\u9ad8\u7ea7\u90e8\u7f72\u80fd\u529b\uff0c\u5982\u84dd\u7eff\u3001\u91d1\u4e1d\u96c0\u3001\u91d1\u4e1d\u96c0\u5206\u6790\u3001\u5b9e\u9a8c\u7b49\uff0c\u5e76\u5411Kubernetes\u63d0\u4f9b\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u529f\u80fd\u3002</p> <p>\u867d\u7136\u50cf Istio \u8fd9\u6837\u7684\u670d\u52a1\u7f51\u683c\u53ef\u4ee5\u63d0\u4f9b\u91d1\u4e1d\u96c0\u53d1\u5e03\uff0c\u4f46Argo Rollouts\u7b80\u5316\u4e86\u5904\u7406\u6d41\u7a0b\uff0c\u4e14\u4ee5\u5f00\u53d1\u8005\u4e3a\u4e2d\u5fc3\u3002\u9664\u6b64\u4e4b\u5916\uff0cArgo Rollouts\u8fd8\u53ef\u4ee5\u96c6\u6210\u5230\u4efb\u4f55\u670d\u52a1\u7f51\u683c\u4e2d\u3002</p> <p>Argo Rollouts \u662f GitOps \u53cb\u597d\u7684\uff0c\u4e14\u80fd\u5f88\u597d\u5730\u4e0e Argo Workflows \u548c ArgoCD \u8fdb\u884c\u96c6\u6210\u3002\u4f7f\u7528\u8fd9\u4e09\u79cd\u5de5\u5177\u53ef\u4ee5\u4e3a\u90e8\u7f72\u521b\u5efa\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u58f0\u660e\u5f0f\u5de5\u5177\u96c6\u3002</p> <p>Flagger \u548cArgo Rollouts\u975e\u5e38\u7c7b\u4f3c\uff0c\u53ef\u4ee5\u5f88\u597d\u5730\u4e0e Flux \u8fdb\u884c\u96c6\u6210\uff0c\u56e0\u6b64\u5982\u679c\u4f60\u6b63\u5728\u4f7f\u7528Flux\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528Flagger\u3002</p>"},{"location":"argo1/0gitops/#crossplane","title":"Crossplane","text":"<p>Crossplane \u5b83\u586b\u8865\u4e86Kubernetes\u7684\u4e00\u4e2a\u5173\u952e\u7a7a\u767d\uff1a\u50cf\u7ba1\u7406K8s\u8d44\u6e90\u4e00\u6837\u7ba1\u7406\u7b2c\u4e09\u65b9\u670d\u52a1\u3002\u8fd9\u610f\u5473\u7740\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528YAML\u4e2d\u5b9a\u4e49\u7684K8s\u8d44\u6e90\uff0c\u50cf\u5728K8s\u4e2d\u914d\u7f6e\u6570\u636e\u5e93\u4e00\u6837\u914d\u7f6eAWS RDS\u6216GCP cloud SQL\u7b49\u4e91\u4f9b\u5e94\u5546\u7684\u6570\u636e\u5e93\u3002</p> <p>Crossplane \u6269\u5c55\u4e86 Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u7528 CRDs \u6765\u63d0\u4f9b\u57fa\u7840\u8bbe\u65bd\u6216\u7ba1\u7406\u4e91\u670d\u52a1\u3002\u518d\u8005\uff0c\u76f8\u6bd4\u4e8e Terraform \u8fd9\u6837\u7684\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u5b8c\u5168\u5b9e\u73b0\u81ea\u52a8\u90e8\u7f72\u3002Crossplane \u4f7f\u7528\u73b0\u6210\u7684 K8s \u80fd\u529b\uff0c\u5982\u4f7f\u7528\u63a7\u5236\u5faa\u73af\u6765\u6301\u7eed\u76d1\u63a7\u96c6\u7fa4\uff0c\u5e76\u81ea\u52a8\u68c0\u6d4b\u914d\u7f6e\u6f02\u79fb\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u53ef\u7ba1\u7406\u7684\u6570\u636e\u5e93\u5b9e\u4f8b\uff0c\u540e\u7eed\u6709\u4eba\u624b\u52a8\u8fdb\u884c\u4e86\u53d8\u66f4\uff0cCrossplane \u4f1a\u81ea\u52a8\u68c0\u6d4b\u8be5\u95ee\u9898\uff0c\u5e76\u5c06\u5176\u8bbe\u7f6e\u56de\u5148\u524d\u7684\u503c\u3002\u5b83\u5c06\u57fa\u7840\u8bbe\u65bd\u4f5c\u4e3a\u4ee3\u7801\u5e76\u6309\u7167 GitOps \u539f\u5219\u6765\u6267\u884c\u3002</p> <p>Crossplane \u53ef\u4ee5\u4e0e ArgoCD \u914d\u5408\u8d77\u6765\uff0c\u76d1\u63a7\u6e90\u4ee3\u7801\uff0c\u5e76\u4fdd\u8bc1\u4ee3\u7801\u5e93\u662f\u552f\u4e00\u7684\u4fe1\u4efb\u6e90(SOT)\uff0c\u4ee3\u7801\u4e2d\u7684\u4efb\u4f55\u53d8\u66f4\u90fd\u4f1a\u4f20\u9012\u5230\u96c6\u7fa4\u4ee5\u53ca\u5916\u90e8\u4e91\u670d\u52a1\u3002</p> <p>\u5982\u679c\u6ca1\u6709 Crossplane\uff0c\u4f60\u53ef\u4ee5\u5728 K8s \u670d\u52a1\u4e2d\u5b9e\u73b0 GitOps\uff0c\u4f46\u65e0\u6cd5\u5728\u6ca1\u6709\u989d\u5916\u5904\u7406\u7684\u524d\u63d0\u4e0b\u5b9e\u73b0\u4e91\u670d\u52a1\u7684GitOps\u3002</p>"},{"location":"argo1/0gitops/#schema-hero","title":"Schema Hero","text":"<p>\u8f6f\u4ef6\u5f00\u53d1\u4e2d\u53e6\u4e00\u79cd\u5e38\u89c1\u7684\u7684\u5904\u7406\u6d41\u7a0b\u662f\u5728\u4f7f\u7528\u5173\u7cfb\u578b\u6570\u636e\u5e93\u65f6\uff0c\u9700\u8981\u7ba1\u7406 schema \u7684\u6f14\u8fdb\u3002</p> <p></p> <p>SchemaHero \u662f\u4e00\u4e2a\u5f00\u6e90\u6570\u636e\u5e93\u7684schema\u8fc1\u79fb\u5de5\u5177\uff0c\u53ef\u4ee5\u5c06schema\u5b9a\u4e49\u8f6c\u5316\u4e3a\u53ef\u4ee5\u5728\u4efb\u4f55\u73af\u5883\u8fd0\u884c\u7684\u8fc1\u79fb\u811a\u672c\u3002\u5b83\u4f7f\u7528\u4e86Kubernetes\u7684\u58f0\u660e\u7279\u6027\u6765\u7ba1\u7406\u6570\u636e\u5e93schema\u7684\u8fc1\u79fb\u3002\u4f60\u53ef\u4ee5\u6307\u5b9a\u671f\u671b\u7684\u72b6\u6001\uff0c\u5e76\u8ba9 SchemaHero \u7ba1\u7406\u5269\u4e0b\u7684\u5de5\u4f5c\u3002</p>"},{"location":"argo1/0gitops/#bitnami-sealed-secrets","title":"Bitnami Sealed Secrets","text":"<p>\u81f3\u6b64\uff0c\u6211\u4eec\u5df2\u7ecf\u6db5\u76d6\u4e86\u5f88\u591a GitOps \u5de5\u5177\uff0c\u6211\u4eec\u7684\u76ee\u6807\u662f\u5c06\u6240\u6709\u5185\u5bb9\u4fdd\u5b58\u5230 Git\uff0c\u5e76\u4f7f\u7528 Kubernetes \u7684\u58f0\u660e\u7279\u6027\u6765\u8ba9\u73af\u5883\u4fdd\u6301\u540c\u6b65\u3002\u6211\u4eec\u53ef\u4ee5\uff08\u4e5f\u5e94\u8be5\uff09\u5728 Git \u4e2d\u4fdd\u8bc1 SOT\uff0c\u5e76\u8ba9\u81ea\u52a8\u5316\u6d41\u7a0b\u5904\u7406\u914d\u7f6e\u66f4\u6539\u3002</p> <p>\u6709\u4e00\u79cd\u8d44\u6e90\u901a\u5e38\u96be\u4ee5\u4fdd\u5b58\u5230 Git \u4e2d\uff0c\u5373 secret\uff0c\u5982 DB \u5bc6\u7801\u6216 API \u5bc6\u94a5\u3002\u4e00\u79cd\u5e38\u89c1\u7684\u89e3\u51b3\u65b9\u6848\u662f\u4f7f\u7528\u5916\u90e8\"\u4fdd\u9669\u5e93\"\uff0c\u5982 AWS Secret Manager \u6216 HashiCorp Vault \u6765\u4fdd\u5b58\u8fd9\u4e9bsecret\uff0c\u4f46\u8fd9\u6837\u4e5f\u4ea7\u751f\u4e86\u51b2\u7a81\uff0c\u4f60\u9700\u8981\u4e00\u4e2a\u5355\u72ec\u7684\u6d41\u7a0b\u6765\u5904\u7406secrets\u3002</p> <p>\u7406\u60f3\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5e0c\u671b\u901a\u8fc7\u67d0\u79cd\u65b9\u5f0f\u5c06secrets\u50cf\u5176\u4ed6\u8d44\u6e90\u4e00\u6837\u5b89\u5168\u5730\u4fdd\u5b58\u5230Git\u4e2d\u3002</p> <p>Sealed Secrets \u5c31\u662f\u7528\u6765\u89e3\u51b3\u8fd9\u79cd\u95ee\u9898\u7684\uff0c\u5b83\u5141\u8bb8\u4f60\u5c06\u654f\u611f\u6570\u636e\u901a\u8fc7\u5f3a\u52a0\u5bc6\u4fdd\u5b58\u5230Git\u4e2d\uff0cBitnami Sealed Secrets\u5929\u7136\u96c6\u6210\u8fdb\u4e86Kubernetes\u4e2d\uff0c\u53ef\u4ee5\u4f7f\u7528Kubernetes\u4e2d\u8fd0\u884c\u7684Kubernetes controller\u6765\u89e3\u5bc6secret\uff0c\u800c\u65e0\u9700\u4f9d\u8d56\u5176\u4ed6\u7ec4\u4ef6\u3002</p> <p>controller\u53ef\u4ee5\u89e3\u5bc6\u6570\u636e\u5e76\u521b\u5efa\u539f\u751f\u7684K8s secrets\u8d44\u6e90\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5c06\u6240\u6709\u5185\u5bb9\u4f5c\u4e3a\u4ee3\u7801\u4fdd\u5b58\u5230\u4ed3\u5e93\u4e2d\uff0c\u8fdb\u800c\u53ef\u4ee5\u5b89\u5168\u5730\u6267\u884c\u6301\u7eed\u90e8\u7f72\uff0c\u4e0d\u9700\u8981\u4f9d\u8d56\u5916\u90e8\u8d44\u6e90\u3002</p> <p>Sealed Secrets \u5305\u542b\u4e24\u90e8\u5206\uff1a</p> <ul> <li>\u96c6\u7fa4\u4fa7\u7684\u63a7\u5236\u5668</li> <li>\u5ba2\u6237\u7aef\u4fa7\u7a0b\u5e8f\uff1akubeseal</li> </ul> <p>kubeseal \u7a0b\u5e8f\u4f7f\u7528\u975e\u5bf9\u79f0\u52a0\u5bc6\u6765\u5bf9 secrets \u8fdb\u884c\u52a0\u5bc6\uff0c\u4e14\u53ea\u6709 controller \u53ef\u4ee5\u89e3\u5bc6\u3002\u8fd9\u4e9b\u52a0\u5bc6\u7684 secrets \u88ab\u7f16\u7801\u5230\u4e86 K8s \u7684 SealedSecret \u8d44\u6e90\u4e2d(\u53ef\u4ee5\u4fdd\u5b58\u5230 Git \u4e2d)\u3002</p>"},{"location":"argo1/0gitops/#capsule","title":"Capsule","text":"<p>\u5f88\u591a\u516c\u53f8\u4f7f\u7528\u591a\u79df\u6237\u6765\u7ba1\u7406\u4e0d\u540c\u7684\u5ba2\u6237\uff0c\u8fd9\u5728\u8f6f\u4ef6\u5f00\u53d1\u4e2d\u5f88\u5e38\u89c1\uff0c\u4f46\u5f88\u96be\u5728 Kubernetes \u4e2d\u5b9e\u73b0\u3002\u4e00\u79cd\u65b9\u5f0f\u662f\u901a\u8fc7 \u547d\u540d\u7a7a\u95f4 \u5c06\u96c6\u7fa4\u5212\u5206\u4e3a\u72ec\u7acb\u7684\u903b\u8f91\u5206\u533a\uff0c\u4f46\u65e0\u6cd5\u5b8c\u5168\u9694\u79bb\u7528\u6237\uff0c\u8fd8\u9700\u8981\u5f15\u5165\u7f51\u7edc\u7b56\u7565\u3001\u914d\u989d\u7b49\u7b49\u3002\u4f60\u53ef\u4ee5\u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u7f51\u7edc\u7b56\u7565\u548c\u89c4\u5219\uff0c\u4f46\u8fd9\u662f\u4e00\u4e2a\u8ba9\u4eba\u4e4f\u5473\u7684\u8fc7\u7a0b\uff0c\u4e14\u65e0\u6cd5\u6269\u5c55\uff0c\u800c\u4e14\u79df\u6237\u65e0\u6cd5\u4f7f\u7528\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u8fd9\u662f\u4e00\u4e2a\u5f88\u5927\u7684\u9650\u5236\u3002</p> <p>\u5206\u5c42\u547d\u540d\u7a7a\u95f4 \u53ef\u4ee5\u7528\u6765\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u3002\u65b9\u6cd5\u662f\u4e3a\u6bcf\u4e2a\u79df\u6237\u5206\u914d\u5206\u914d\u4e00\u4e2a\u7236\u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u4e3a\u8be5\u79df\u6237\u914d\u7f6e\u901a\u7528\u7684\u7f51\u7edc\u7b56\u7565\u548c\u914d\u989d\uff0c\u5e76\u5141\u8bb8\u521b\u5efa\u5b50\u547d\u540d\u7a7a\u95f4\u3002\u8fd9\u662f\u4e00\u4e2a\u5f88\u5927\u7684\u6539\u8fdb\uff0c\u4f46\u5728\u79df\u6237\u5c42\u9762\uff0c\u7f3a\u5c11\u5b89\u5168\u6027\u548c\u6cbb\u7406\u65b9\u9762\u7684\u539f\u751f\u652f\u6301\u3002\u6b64\u5916\uff0c\u5b83\u8fd8\u6ca1\u6709\u8fbe\u5230\u751f\u4ea7\u72b6\u6001\uff0c\u4f46\u9884\u8ba1\u5c06\u5728\u672a\u6765\u51e0\u4e2a\u6708\u53d1\u5e031.0\u7248\u672c\u3002</p> <p>\u4e00\u79cd\u5e38\u89c1\u7684\u65b9\u5f0f\u662f\u4e3a\u6bcf\u4e2a\u5ba2\u6237\u521b\u5efa\u4e00\u4e2a\u96c6\u7fa4\uff0c\u8fd9\u6837\u505a\u76f8\u5bf9\u6bd4\u8f83\u5b89\u5168\uff0c\u5e76\u7ed9\u79df\u6237\u63d0\u4f9b\u4e86\u6240\u9700\u7684\u4e00\u5207\u5185\u5bb9\uff0c\u4f46\u8fd9\u79cd\u65b9\u5f0f\u5f88\u96be\u7ba1\u7406\uff0c\u8d39\u7528\u4e5f\u5f88\u9ad8\u3002</p> <p>Capsule \u662f\u4e00\u79cd\u5728\u5355\u4e2a\u96c6\u7fa4\u4e2d\u4e3aKubernetes\u63d0\u4f9b\u591a\u79df\u6237\u529f\u80fd\u7684\u5de5\u5177\u3002\u4f7f\u7528Capsule\uff0c\u4f60\u53ef\u4ee5\u5c06\u6240\u6709\u79df\u6237\u653e\u5230\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u3002Capsul\u4f1a\u4e3a\u79df\u6237\u63d0\u4f9b\u4e00\u4e2a\"\u8fd1\u4e4e\"\u539f\u751f\u7684\u4f53\u9a8c(\u867d\u7136\u6709\u4e00\u4e9b\u5c0f\u5c0f\u7684\u9650\u5236)\uff0c\u79df\u6237\u53ef\u4ee5\u5728\u5176\u96c6\u7fa4\u4e2d\u521b\u5efa\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\u3002\u8fd9\u79cd\u65b9\u5f0f\u9690\u85cf\u4e86\u591a\u79df\u6237\u5171\u4eab\u5e95\u5c42\u96c6\u7fa4\u7684\u4e8b\u5b9e\u3002</p> <p></p> <p>\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\uff0cCapsule \u63a7\u5236\u5668\u5c06\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\u805a\u5408\u5230\u4e00\u8d77\uff0c\u62bd\u8c61\u4e3a\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684 Kubernetes\uff0c\u79f0\u4e3a\u79df\u6237\uff0c\u5b83\u662f\u4e00\u7ec4 Kubernetes \u547d\u540d\u7a7a\u95f4\u3002</p> <p>\u5728\u6bcf\u4e2a\u79df\u6237\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u521b\u5efa\u5176\u547d\u540d\u7a7a\u95f4\u5e76\u5171\u4eab\u5206\u914d\u5230\u7684\u8d44\u6e90\uff0cPolicy Engine \u4fdd\u8bc1\u79df\u6237\u95f4\u7684\u9694\u79bb\u6027\u3002</p> <p>\u7f51\u7edc\u548c\u5b89\u5168\u7b56\u7565\u3001\u8d44\u6e90\u914d\u989d\u3001LimitRanges\u3001RBAC \u548c\u5728\u79df\u6237\u7ea7\u522b\u5b9a\u4e49\u7684\u5176\u4ed6\u7b56\u7565\u7531\u79df\u6237\u4e2d\u7684\u6240\u6709\u547d\u540d\u7a7a\u95f4\u81ea\u52a8\u7ee7\u627f\uff0c\u7c7b\u4f3c\u4e8e\u5206\u5c42\u547d\u540d\u7a7a\u95f4\u3002\u7136\u540e\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u4e3b\u5730\u64cd\u4f5c\u79df\u6237\uff0c\u800c\u65e0\u9700\u96c6\u7fa4\u7ba1\u7406\u5458\u7684\u5e72\u9884\u3002</p> <p>Capsel \u662f GitOps \u7684\uff0c\u56e0\u4e3a\u5b83\u662f\u58f0\u660e\u6027\u7684\uff0c\u6240\u6709\u7684\u914d\u7f6e\u90fd\u53ef\u4ee5\u5b58\u50a8\u5728 Git \u4e2d\u3002</p>"},{"location":"argo1/1argo2023_gitops/","title":"1 \u4f7f\u7528 Argo CD \u8fdb\u884c GitOps \u6d41\u6c34\u7ebf\u6539\u9020 2024","text":"<p>Argo CD \u662f\u4e00\u4e2a\u4e3a Kubernetes \u800c\u751f\u7684\uff0c\u9075\u5faa\u58f0\u660e\u5f0f GitOps \u7406\u5ff5\u7684\u6301\u7eed\u90e8\u7f72\u5de5\u5177\u3002</p> <p>Argo CD \u53ef\u5728 Git \u5b58\u50a8\u5e93\u66f4\u6539\u65f6\u81ea\u52a8\u540c\u6b65\u548c\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>Argo CD \u9075\u5faa GitOps \u6a21\u5f0f\uff0c\u4f7f\u7528 Git \u4ed3\u5e93\u4f5c\u4e3a\u5b9a\u4e49\u6240\u9700\u5e94\u7528\u7a0b\u5e8f\u72b6\u6001\u7684\u771f\u5b9e\u6765\u6e90\uff0cArgo CD \u652f\u6301\u591a\u79cd Kubernetes \u6e05\u5355</p> <ul> <li>kustomize</li> <li>helm charts</li> <li>ksonnet applications</li> <li>jsonnet files</li> <li>Plain directory of YAML/json manifests</li> <li>Any custom config management tool configured as a config management plugin</li> </ul> <p>Argo CD \u53ef\u5728\u6307\u5b9a\u7684\u76ee\u6807\u73af\u5883\u4e2d\u81ea\u52a8\u90e8\u7f72\u6240\u9700\u7684\u5e94\u7528\u7a0b\u5e8f\u72b6\u6001\uff0c\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u53ef\u4ee5\u5728 Git \u63d0\u4ea4\u65f6\u8ddf\u8e2a\u5bf9\u5206\u652f\u3001\u6807\u7b7e\u7684\u66f4\u65b0\uff0c\u6216\u56fa\u5b9a\u5230\u6e05\u5355\u7684\u6307\u5b9a\u7248\u672c\u3002</p>"},{"location":"argo1/1argo2023_gitops/#_1","title":"\u67b6\u6784","text":"<p>Argo CD \u662f\u901a\u8fc7 Kubernetes \u63a7\u5236\u5668\u6765\u5b9e\u73b0\u7684\uff0c\u5b83\u6301\u7eed watch \u6b63\u5728\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u5e76\u5c06\u5f53\u524d\u7684\u5b9e\u65f6\u72b6\u6001\u4e0e\u6240\u9700\u7684\u76ee\u6807\u72b6\u6001\uff08 Git \u5b58\u50a8\u5e93\u4e2d\u6307\u5b9a\u7684\uff09\u8fdb\u884c\u6bd4\u8f83\u3002\u5df2\u7ecf\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5b9e\u9645\u72b6\u6001\u4e0e\u76ee\u6807\u72b6\u6001\u6709\u5dee\u5f02\uff0c\u5219\u88ab\u8ba4\u4e3a\u662f OutOfSync \u72b6\u6001\uff0cArgo CD \u4f1a\u62a5\u544a\u663e\u793a\u8fd9\u4e9b\u5dee\u5f02\uff0c\u540c\u65f6\u63d0\u4f9b\u5de5\u5177\u6765\u81ea\u52a8\u6216\u624b\u52a8\u5c06\u72b6\u6001\u540c\u6b65\u5230\u671f\u671b\u7684\u76ee\u6807\u72b6\u6001\u3002\u5728 Git \u4ed3\u5e93\u4e2d\u5bf9\u671f\u671b\u76ee\u6807\u72b6\u6001\u6240\u505a\u7684\u4efb\u4f55\u4fee\u6539\u90fd\u53ef\u4ee5\u81ea\u52a8\u5e94\u7528\u53cd\u9988\u5230\u6307\u5b9a\u7684\u76ee\u6807\u73af\u5883\u4e2d\u53bb\u3002</p> <p>\u4e0b\u9762\u7b80\u5355\u4ecb\u7ecd\u4e0b Argo CD \u4e2d\u7684\u51e0\u4e2a\u4e3b\u8981\u7ec4\u4ef6\uff1a</p> <p>API \u670d\u52a1\uff1aAPI \u670d\u52a1\u662f\u4e00\u4e2a gRPC/REST \u670d\u52a1\uff0c\u5b83\u66b4\u9732\u4e86 Web UI\u3001CLI \u548c CI/CD \u7cfb\u7edf\u4f7f\u7528\u7684\u63a5\u53e3\uff0c\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u529f\u80fd\uff1a</p> <ul> <li>\u5e94\u7528\u7a0b\u5e8f\u7ba1\u7406\u548c\u72b6\u6001\u62a5\u544a</li> <li>\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u64cd\u4f5c\uff08\u4f8b\u5982\u540c\u6b65\u3001\u56de\u6eda\u3001\u7528\u6237\u5b9a\u4e49\u7684\u64cd\u4f5c\uff09</li> <li>\u5b58\u50a8\u4ed3\u5e93\u548c\u96c6\u7fa4\u51ed\u636e\u7ba1\u7406\uff08\u5b58\u50a8\u4e3a K8s Secrets \u5bf9\u8c61\uff09</li> <li>\u8ba4\u8bc1\u548c\u6388\u6743\u7ed9\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u8005</li> <li>RBAC</li> <li>Git webhook \u4e8b\u4ef6\u7684\u4fa6\u542c\u5668/\u8f6c\u53d1\u5668</li> </ul> <p>\u4ed3\u5e93\u670d\u52a1\uff1a\u5b58\u50a8\u4ed3\u5e93\u670d\u52a1\u662f\u4e00\u4e2a\u5185\u90e8\u670d\u52a1\uff0c\u8d1f\u8d23\u7ef4\u62a4\u4fdd\u5b58\u5e94\u7528\u7a0b\u5e8f\u6e05\u5355 Git \u4ed3\u5e93\u7684\u672c\u5730\u7f13\u5b58\u3002\u5f53\u63d0\u4f9b\u4ee5\u4e0b\u8f93\u5165\u65f6\uff0c\u5b83\u8d1f\u8d23\u751f\u6210\u5e76\u8fd4\u56de Kubernetes \u6e05\u5355\uff1a</p> <ul> <li>\u5b58\u50a8 URL</li> <li>revision \u7248\u672c\uff08commit\u3001tag\u3001branch\uff09</li> <li>\u5e94\u7528\u8def\u5f84</li> <li>\u6a21\u677f\u914d\u7f6e\uff1a\u53c2\u6570\u3001ksonnet \u73af\u5883\u3001helm values.yaml \u7b49</li> </ul> <p>\u5e94\u7528\u63a7\u5236\u5668\uff1a\u5e94\u7528\u63a7\u5236\u5668\u662f\u4e00\u4e2a Kubernetes \u63a7\u5236\u5668\uff0c\u5b83\u6301\u7eed watch \u6b63\u5728\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u5e76\u5c06\u5f53\u524d\u7684\u5b9e\u65f6\u72b6\u6001\u4e0e\u6240\u671f\u671b\u7684\u76ee\u6807\u72b6\u6001\uff08repo \u4e2d\u6307\u5b9a\u7684\uff09\u8fdb\u884c\u6bd4\u8f83\u3002</p> <p>\u5b83\u68c0\u6d4b\u5e94\u7528\u7a0b\u5e8f\u7684 OutOfSync \u72b6\u6001\uff0c\u5e76\u91c7\u53d6\u4e00\u4e9b\u63aa\u65bd\u6765\u540c\u6b65\u72b6\u6001\uff0c\u5b83\u8d1f\u8d23\u8c03\u7528\u4efb\u4f55\u7528\u6237\u5b9a\u4e49\u7684\u751f\u547d\u5468\u671f\u4e8b\u4ef6\u7684\u94a9\u5b50\uff08PreSync\u3001Sync\u3001PostSync\uff09\u3002</p>"},{"location":"argo1/1argo2023_gitops/#_2","title":"\u5b89\u88c5","text":"<p>\u5f53\u7136\u524d\u63d0\u662f\u9700\u8981\u6709\u4e00\u4e2a kubectl \u53ef\u8bbf\u95ee\u7684 Kubernetes \u7684\u96c6\u7fa4\uff0c\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\uff0c\u8fd9\u91cc\u6211\u4eec\u5b89\u88c5\u6700\u65b0\u7684 v2.8.4 \u7248\u672c\uff1a</p> <pre><code>$ kubectl create namespace argocd\n$ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.8.4/manifests/install.yaml\n</code></pre> <p>\u5982\u679c\u4f60\u8981\u7528\u5728\u751f\u4ea7\u73af\u5883\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u90e8\u7f72\u4e00\u4e2a HA \u9ad8\u53ef\u7528\u7684\u7248\u672c\uff1a</p> <pre><code>$ kubectl create namespace argocd\n$ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.8.4/manifests/ha/install.yaml\n</code></pre> <p>\u8fd9\u5c06\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u547d\u540d\u7a7a\u95f4 argocd\uff0cArgo CD \u7684\u670d\u52a1\u548c\u5e94\u7528\u8d44\u6e90\u90fd\u5c06\u90e8\u7f72\u5230\u8be5\u547d\u540d\u7a7a\u95f4\u3002</p> <pre><code>\n$ kubectl get pods -n argocd\nNAME                                                READY   STATUS    RESTARTS   AGE\nargocd-application-controller-0                     1/1     Running   0          103s\nargocd-applicationset-controller-68b9bdbd8b-jzcpf   1/1     Running   0          103s\nargocd-dex-server-6b7745757-6mxwk                   1/1     Running   0          103s\nargocd-notifications-controller-5b56f6f7bb-jqpng    1/1     Running   0          103s\nargocd-redis-f4cdbff57-dr8jc                        1/1     Running   0          103s\nargocd-repo-server-c4f79b4d6-7nh6n                  1/1     Running   0          103s\nargocd-server-895675597-fr42g                       1/1     Running   0          103s\n</code></pre> <p>\u5982\u679c\u4f60\u5bf9 UI\u3001SSO\u3001\u591a\u96c6\u7fa4\u7ba1\u7406\u8fd9\u4e9b\u7279\u6027\u4e0d\u611f\u5174\u8da3\uff0c\u53ea\u60f3\u628a\u5e94\u7528\u53d8\u66f4\u540c\u6b65\u5230\u96c6\u7fa4\u4e2d\uff0c\u90a3\u4e48\u53ef\u4ee5\u76f4\u63a5\u5b89\u88c5\u6838\u5fc3\u7ec4\u4ef6\u5373\u53ef\uff1akubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.8.4/manifests/core-install.yaml\u3002</p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5728\u672c\u5730\uff08\u9009\u62e9\u5bf9\u5e94\u7684\u7248\u672c\uff09\u5b89\u88c5 CLI \u5de5\u5177\u65b9\u4fbf\u64cd\u4f5c Argo CD\uff1a</p> <pre><code>$ curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.8.4/argocd-linux-amd64\n</code></pre> <p>\u4e3a argocd CLI \u8d4b\u4e88\u53ef\u6267\u884c\u6743\u9650\uff1a</p> <pre><code>$ chmod +x /usr/local/bin/argocd\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 argocd \u547d\u4ee4\u4e86\u3002</p> <p>\u5982\u679c\u4f60\u662f Mac\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>brew install argocd</code> \u8fdb\u884c\u5b89\u88c5\u3002</p> <p>Argo CD \u4f1a\u8fd0\u884c\u4e00\u4e2a gRPC \u670d\u52a1\uff08\u7531 CLI \u4f7f\u7528\uff09\u548c HTTP/HTTPS \u670d\u52a1\uff08\u7531 UI \u4f7f\u7528\uff09\uff0c\u8fd9\u4e24\u79cd\u534f\u8bae\u90fd\u7531 argocd-server \u670d\u52a1\u5728\u4ee5\u4e0b\u7aef\u53e3\u8fdb\u884c\u66b4\u9732\uff1a</p> <ul> <li>443 - gRPC/HTTPS</li> <li>80 - HTTP\uff08\u91cd\u5b9a\u5411\u5230 HTTPS\uff09</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e Ingress \u7684\u65b9\u5f0f\u6765\u5bf9\u5916\u66b4\u9732\u670d\u52a1\uff0c\u5176\u4ed6 Ingress \u63a7\u5236\u5668\u7684\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863 https://argo-cd.readthedocs.io/en/stable/operator-manual/ingress/ \u8fdb\u884c\u914d\u7f6e\u3002</p> <p>Argo CD \u5728\u540c\u4e00\u7aef\u53e3 (443) \u4e0a\u63d0\u4f9b\u591a\u4e2a\u534f\u8bae (gRPC/HTTPS)\uff0c\u6240\u4ee5\u5f53\u6211\u4eec\u4e3a argocd \u670d\u52a1\u5b9a\u4e49\u5355\u4e2a nginx ingress \u5bf9\u8c61\u548c\u89c4\u5219\u7684\u65f6\u5019\u6709\u70b9\u9ebb\u70e6\uff0c\u56e0\u4e3a <code>nginx.ingress.kubernetes.io/backend-protocol</code> \u8fd9\u4e2a annotation \u53ea\u80fd\u63a5\u53d7\u4e00\u4e2a\u540e\u7aef\u534f\u8bae\uff08\u4f8b\u5982 HTTP\u3001HTTPS\u3001GRPC\u3001GRPCS\uff09\u3002</p> <p>\u4e3a\u4e86\u4f7f\u7528\u5355\u4e2a ingress \u89c4\u5219\u548c\u4e3b\u673a\u540d\u6765\u66b4\u9732 Argo CD APIServer\uff0c\u5fc5\u987b\u4f7f\u7528 <code>nginx.ingress.kubernetes.io/ssl-passthrough</code> \u8fd9\u4e2a annotation \u6765\u4f20\u9012 TLS \u8fde\u63a5\u5e76\u6821\u9a8c <code>Argo CD APIServer</code> \u4e0a\u7684 TLS\u3002</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd-server-ingress\n  namespace: argocd\n  annotations:\n    nginx.ingress.kubernetes.io/force-ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/ssl-passthrough: \"true\"\nspec:\n  ingressClassName: nginx\n  rules:\n    - host: argocd.k8s.local\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: argocd-server\n                port:\n                  name: https\n</code></pre> <p>\u4e0a\u8ff0\u89c4\u5219\u5728 Argo CD APIServer \u4e0a\u6821\u9a8c TLS\uff0c\u8be5\u670d\u52a1\u5668\u68c0\u6d4b\u5230\u6b63\u5728\u4f7f\u7528\u7684\u534f\u8bae\uff0c\u5e76\u505a\u51fa\u9002\u5f53\u7684\u54cd\u5e94\u3002\u8bf7\u6ce8\u610f\uff0c<code>nginx.ingress.kubernetes.io/ssl-passthrough</code> \u6ce8\u89e3\u8981\u6c42\u5c06 <code>--enable-ssl-passthrough</code> \u6807\u5fd7\u6dfb\u52a0\u5230 nginx-<code>ingress-controller</code> \u7684\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u3002</p> <p>\u7531\u4e8e <code>ingress-nginx</code> \u7684\u6bcf\u4e2a Ingress \u5bf9\u8c61\u4ec5\u652f\u6301\u4e00\u4e2a\u534f\u8bae\uff0c\u56e0\u6b64\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u5b9a\u4e49\u4e24\u4e2a Ingress \u5bf9\u8c61\u3002</p> <p>\u4e00\u4e2a\u7528\u4e8e <code>HTTP/HTTPS</code>\uff0c\u53e6\u4e00\u4e2a\u7528\u4e8e <code>gRPC</code>\u3002</p> <p>\u5982\u4e0b\u6240\u793a\u4e3a HTTP/HTTPS \u7684 Ingress \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd-server-http-ingress\n  namespace: argocd\n  annotations:\n    nginx.ingress.kubernetes.io/force-ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/backend-protocol: \"HTTP\"\nspec:\n  ingressClassName: nginx\n  rules:\n    - http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: argocd-server\n                port:\n                  name: http\n      host: argocd.k8s.local\n  tls:\n    - hosts:\n        - argocd.k8s.local\n      secretName: argocd-secret # do not change, this is provided by Argo CD\n</code></pre> <p>gRPC \u534f\u8bae\u5bf9\u5e94\u7684 Ingress \u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: argocd-server-grpc-ingress\n  namespace: argocd\n  annotations:\n    nginx.ingress.kubernetes.io/backend-protocol: \"GRPC\"\nspec:\n  ingressClassName: nginx\n  rules:\n    - http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                name: argocd-server\n                port:\n                  name: https\n      host: grpc.argocd.k8s.local\n  tls:\n    - hosts:\n        - grpc.argocd.k8s.local\n      secretName: argocd-secret # do not change, this is provided by Argo CD\n</code></pre> <pre><code>$ kubectl get ingress -n argocd \nNAME                         CLASS   HOSTS                   ADDRESS   PORTS     AGE\nargocd-server-http-ingress   nginx   argocd.k8s.local                  80, 443   10h\nargocd-server-grpc-ingress   nginx   grpc.argocd.k8s.local             80, 443   10h\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u9700\u8981\u5728\u7981\u7528 TLS \u7684\u60c5\u51b5\u4e0b\u8fd0\u884c APIServer\u3002</p> <p>\u7f16\u8f91 <code>argocd-server</code> \u8fd9\u4e2a Deployment \u4ee5\u5c06 <code>--insecure</code> \u6807\u5fd7\u6dfb\u52a0\u5230 <code>argocd-server</code> \u547d\u4ee4\uff0c\u6216\u8005\u7b80\u5355\u5730\u5728 <code>argocd-cmd-params-cm</code> ConfigMap \u4e2d\u8bbe\u7f6e <code>server.insecure: \"true\"</code> \u5373\u53ef\u3002</p> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 <code>argocd.k8s.local</code> \u6765\u8bbf\u95ee Argo CD \u670d\u52a1\u4e86\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u6211\u4eec\u8fd9\u91cc\u914d\u7f6e\u7684\u8bc1\u4e66\u662f\u81ea\u7b7e\u540d\u7684\uff0c\u6240\u4ee5\u5728\u7b2c\u4e00\u6b21\u8bbf\u95ee\u7684\u65f6\u5019\u4f1a\u63d0\u793a\u4e0d\u5b89\u5168\uff0c\u5f3a\u5236\u8df3\u8f6c\u5373\u53ef\u3002</p> <pre><code>grep -rnw \"argocd\" /etc/hosts\n/etc/hosts:23:192.168.194.11 argocd.k8s.local\n/etc/hosts:24:192.168.194.11 grpc.argocd.k8s.local\n</code></pre> <p><code>https://argocd.k8s.local:80/</code></p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b <code>admin</code> \u5e10\u53f7\u7684\u521d\u59cb\u5bc6\u7801\u662f\u81ea\u52a8\u751f\u6210\u7684\uff0c\u4f1a\u4ee5\u660e\u6587\u7684\u5f62\u5f0f\u5b58\u50a8\u5728 Argo CD \u5b89\u88c5\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u540d\u4e3a <code>argocd-initial-admin-secret</code> \u7684 <code>Secret</code> \u5bf9\u8c61\u4e0b\u7684 <code>password</code> \u5b57\u6bb5\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d &amp;&amp; echo\n</code></pre> <p>\u4f7f\u7528\u7528\u6237\u540d admin \u548c\u4e0a\u9762\u8f93\u51fa\u7684\u5bc6\u7801\u5373\u53ef\u767b\u5f55 Dashboard\u3002</p> <p></p> <p>\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 ArgoCD CLI \u547d\u4ee4\u884c\u5de5\u5177\u8fdb\u884c\u767b\u5f55\uff1a</p> <pre><code>$ argocd login grpc.argocd.k8s.local:80\nWARNING: server certificate had error: tls: failed to verify certificate: x509: certificate signed by unknown authority. Proceed insecurely (y/n)? y\nUsername: admin\nPassword: \n'admin:login' logged in successfully\nContext 'grpc.argocd.k8s.local:80' updated\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u91cc\u767b\u5f55\u7684\u5730\u5740\u4e3a gRPC \u66b4\u9732\u7684\u670d\u52a1\u5730\u5740\u3002</p> <p>CLI \u767b\u5f55\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u547d\u4ee4\u66f4\u6539\u5bc6\u7801\uff1a</p> <pre><code>$ argocd account update-password\n*** Enter current password: \n*** Enter new password:       admin123  \n*** Confirm new password:     admin123\nPassword updated\nContext 'argocd.k8s.local' updated\n\n\n$ argocd version\nargocd: v2.12.3+6b9cd82\n  BuildDate: 2024-08-27T15:48:18Z\n  GitCommit: 6b9cd828c6e9807398869ad5ac44efd2c28422d6\n  GitTreeState: clean\n  GoVersion: go1.23.0\n  Compiler: gc\n  Platform: darwin/amd64\nargocd-server: v2.12.3+6b9cd82\n  BuildDate: 2024-08-27T11:57:48Z\n  GitCommit: 6b9cd828c6e9807398869ad5ac44efd2c28422d6\n  GitTreeState: clean\n  GoVersion: go1.22.4\n  Compiler: gc\n  Platform: linux/amd64\n  Kustomize Version: v5.4.2 2024-05-22T15:19:38Z\n  Helm Version: v3.15.2+g1a500d5\n  Kubectl Version: v0.29.6\n  Jsonnet Version: v0.20.0\n</code></pre>"},{"location":"argo1/1argo2023_gitops/#_3","title":"\u914d\u7f6e\u96c6\u7fa4","text":"<p>\u7531\u4e8e Argo CD \u652f\u6301\u90e8\u7f72\u5e94\u7528\u5230\u591a\u96c6\u7fa4\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u8981\u5c06\u5e94\u7528\u90e8\u7f72\u5230\u5916\u90e8\u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u9700\u8981\u5148\u5c06\u5916\u90e8\u96c6\u7fa4\u7684\u8ba4\u8bc1\u4fe1\u606f\u6ce8\u518c\u5230 Argo CD \u4e2d\uff0c\u5982\u679c\u662f\u5728\u5185\u90e8\u90e8\u7f72\uff08\u8fd0\u884c Argo CD \u7684\u540c\u4e00\u4e2a\u96c6\u7fa4\uff0c\u9ed8\u8ba4\u4e0d\u9700\u8981\u914d\u7f6e\uff09\uff0c\u76f4\u63a5\u4f7f\u7528 <code>https://kubernetes.default.svc</code> \u4f5c\u4e3a\u5e94\u7528\u7684 <code>K8S APIServer</code> \u5730\u5740\u5373\u53ef\u3002</p> <p>\u9996\u5148\u5217\u51fa\u5f53\u524d kubeconfig \u4e2d\u7684\u6240\u6709\u96c6\u7fa4\u4e0a\u4e0b\u6587\uff1a</p> <pre><code>$ kubectl config get-contexts -o name\ndocker-desktop\norbstack\n</code></pre> <p>\u4ece\u5217\u8868\u4e2d\u9009\u62e9\u4e00\u4e2a\u4e0a\u4e0b\u6587\u540d\u79f0\u5e76\u5c06\u5176\u63d0\u4f9b\u7ed9 <code>argocd cluster add CONTEXTNAME</code>\uff0c\u6bd4\u5982\u5bf9\u4e8e orbstack \u4e0a\u4e0b\u6587\uff0c\u8fd0\u884c\uff1a</p> <pre><code>$ argocd cluster list\nSERVER                          NAME        VERSION  STATUS   MESSAGE                                                  PROJECT\nhttps://kubernetes.default.svc  in-cluster           Unknown  Cluster has no applications and is not being monitored.  \n\n$ argocd cluster add orbstack --in-cluster -y --upsert\n\n\nINFO[0000] ServiceAccount \"argocd-manager\" already exists in namespace \"kube-system\" \nINFO[0000] ClusterRole \"argocd-manager-role\" updated    \nINFO[0000] ClusterRoleBinding \"argocd-manager-role-binding\" updated \nCluster 'https://kubernetes.default.svc' added\n</code></pre> <p></p>"},{"location":"argo1/1argo2023_gitops/#_4","title":"\u521b\u5efa\u5e94\u7528","text":"<p>Git \u4ed3\u5e93 https://github.com/argoproj/argocd-example-apps.git \u662f\u4e00\u4e2a\u5305\u542b\u7559\u8a00\u7c3f\u5e94\u7528\u7a0b\u5e8f\u7684\u793a\u4f8b\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u8be5\u5e94\u7528\u6765\u6f14\u793a Argo CD \u7684\u5de5\u4f5c\u539f\u7406</p> <p>Or https://gitee.com/cnych/argocd-example-apps</p>"},{"location":"argo1/1argo2023_gitops/#cli","title":"\u901a\u8fc7 CLI \u521b\u5efa\u5e94\u7528","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 argocd app create xxx \u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a\u5e94\u7528\uff1a</p> <pre><code>$ argocd app create --help\nCreate an application\n\nUsage:\n  argocd app create APPNAME [flags]\n\nExamples:\n\n        # Create a directory app\n        argocd app create guestbook --repo https://github.com/argoproj/argocd-example-apps.git --path guestbook --dest-namespace default --dest-server https://kubernetes.default.svc --directory-recurse\n\n        # Create a Jsonnet app\n        argocd app create jsonnet-guestbook --repo https://github.com/argoproj/argocd-example-apps.git --path jsonnet-guestbook --dest-namespace default --dest-server https://kubernetes.default.svc --jsonnet-ext-str replicas=2\n\n        # Create a Helm app\n        argocd app create helm-guestbook --repo https://github.com/argoproj/argocd-example-apps.git --path helm-guestbook --dest-namespace default --dest-server https://kubernetes.default.svc --helm-set replicaCount=2\n\n        # Create a Helm app from a Helm repo\n        argocd app create nginx-ingress --repo https://charts.helm.sh/stable --helm-chart nginx-ingress --revision 1.24.3 --dest-namespace default --dest-server https://kubernetes.default.svc\n\n        # Create a Kustomize app\n        argocd app create kustomize-guestbook --repo https://github.com/argoproj/argocd-example-apps.git --path kustomize-guestbook --dest-namespace default --dest-server https://kubernetes.default.svc --kustomize-image gcr.io/heptio-images/ks-guestbook-demo:0.1\n\n        # Create a app using a custom tool:\n        argocd app create kasane --repo https://github.com/argoproj/argocd-example-apps.git --path plugins/kasane --dest-namespace default --dest-server https://kubernetes.default.svc --config-management-plugin kasane\n\n\nFlags:\n......\n</code></pre> <p>\u76f4\u63a5\u6267\u884c\u5982\u4e0b\u6240\u793a\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ argocd app create guestbook --repo https://github.com/argoproj/argocd-example-apps.git --path guestbook --dest-server https://kubernetes.default.svc --dest-namespace default\napplication 'guestbook' created\n</code></pre> <p></p>"},{"location":"argo1/1argo2023_gitops/#ui","title":"\u901a\u8fc7 UI \u521b\u5efa\u5e94\u7528","text":"<p>\u9664\u4e86\u53ef\u4ee5\u901a\u8fc7 CLI \u5de5\u5177\u6765\u521b\u5efa\u5e94\u7528\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7 UI \u754c\u9762\u6765\u521b\u5efa\uff0c\u5b9a\u4f4d\u5230 argocd.k8s.local \u9875\u9762\uff0c\u767b\u5f55\u540e\uff0c\u70b9\u51fb <code>+New App</code> \u65b0\u5efa\u5e94\u7528\u6309\u94ae\uff0c\u5982\u4e0b\u56fe\uff1a</p> <p></p> <p>\u5c06\u5e94\u7528\u547d\u540d\u4e3a guestbook\uff0c\u4f7f\u7528 default project\uff0c\u5e76\u5c06\u540c\u6b65\u7b56\u7565\u8bbe\u7f6e\u4e3a Manual\uff1a</p> <p></p> <p>\u7136\u540e\u5728\u4e0b\u9762\u914d\u7f6e Repository URL \u4e3a https://github.com/argoproj/argocd-example-apps.git\uff0c\u7531\u4e8e\u67d0\u4e9b\u539f\u56e0\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Gitee \u4ed3\u5e93\u5730\u5740 https://gitee.com/cnych/argocd-example-apps\uff0c\u5c06 Revision \u8bbe\u7f6e\u4e3a HEAD\uff0c\u5e76\u5c06\u8def\u5f84\u8bbe\u7f6e\u4e3a guestbook\u3002</p> <p>\u7136\u540e\u4e0b\u9762\u7684 Destination \u90e8\u5206\uff0c\u5c06 cluster \u8bbe\u7f6e\u4e3a inCluster \u548c namespace \u4e3a default\uff1a</p> <p></p> <p>\u586b\u5199\u5b8c\u4ee5\u4e0a\u4fe1\u606f\u540e\uff0c\u70b9\u51fb\u9875\u9762\u4e0a\u65b9\u7684 Create \u5b89\u88c5\uff0c\u5373\u53ef\u521b\u5efa guestbook \u5e94\u7528\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u53ef\u4ee5\u770b\u5230\u5f53\u524d\u5e94\u7528\u7684\u5904\u4e8e OutOfSync \u72b6\u6001\uff1a</p> <p></p> <p>Argo CD \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6bcf 3 \u5206\u949f\u4f1a\u68c0\u6d4b Git \u4ed3\u5e93\u4e00\u6b21\uff0c\u7528\u4e8e\u5224\u65ad\u5e94\u7528\u5b9e\u9645\u72b6\u6001\u662f\u5426\u548c Git \u4e2d\u58f0\u660e\u7684\u671f\u671b\u72b6\u6001\u4e00\u81f4\uff0c\u5982\u679c\u4e0d\u4e00\u81f4\uff0c\u72b6\u6001\u5c31\u8f6c\u6362\u4e3a OutOfSync\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5e76\u4e0d\u4f1a\u89e6\u53d1\u66f4\u65b0\uff0c\u9664\u975e\u901a\u8fc7 syncPolicy \u914d\u7f6e\u4e86\u81ea\u52a8\u540c\u6b65\u3002 </p>"},{"location":"argo1/1argo2023_gitops/#crd","title":"\u901a\u8fc7 CRD \u521b\u5efa","text":"<p>\u9664\u4e86\u53ef\u4ee5\u901a\u8fc7 CLI \u548c Dashboard \u53ef\u4ee5\u521b\u5efa Application \u4e4b\u5916\uff0c\u5176\u5b9e\u4e5f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u58f0\u660e\u4e00\u4e2a Application \u7684\u8d44\u6e90\u5bf9\u8c61\u6765\u521b\u5efa\u4e00\u4e2a\u5e94\u7528\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>\napiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: guestbook\nspec:\n  destination:\n    namespace: default\n    server: \"https://kubernetes.default.svc\"\n  source:\n    path: guestbook\n    repoURL: \"https://github.com/cnych/argocd-example-apps\"\n    targetRevision: HEAD\n  project: default\n  syncPolicy:\n    automated: null\n</code></pre>"},{"location":"argo1/1argo2023_gitops/#_5","title":"\u90e8\u7f72\u5e94\u7528","text":"<p>\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u5728\u521b\u5efa\u5e94\u7528\u7684\u65f6\u5019\u4f7f\u7528\u7684\u540c\u6b65\u7b56\u7565\u4e3a Manual\uff0c\u6240\u4ee5\u5e94\u7528\u521b\u5efa\u5b8c\u6210\u540e\u6ca1\u6709\u81ea\u52a8\u90e8\u7f72\uff0c\u9700\u8981\u6211\u4eec\u624b\u52a8\u53bb\u90e8\u7f72\u5e94\u7528\u3002\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 CLI \u548c UI \u754c\u9762\u4e24\u79cd\u540c\u6b65\u65b9\u5f0f\u3002</p>"},{"location":"argo1/1argo2023_gitops/#cli_1","title":"\u4f7f\u7528 CLI \u540c\u6b65","text":"<p>\u5e94\u7528\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6240\u793a\u547d\u4ee4\u67e5\u770b\u5176\u72b6\u6001\uff1a</p> <pre><code>$ argocd app get argocd/guestbook\nName:               argocd/guestbook\nProject:            default\nServer:             https://kubernetes.default.svc\nNamespace:          default\nURL:                https://grpc.argocd.k8s.local/applications/guestbook\nRepo:               https://gitee.com/cnych/argocd-example-apps\nTarget:             HEAD\nPath:               guestbook\nSyncWindow:         Sync Allowed\nSync Policy:        &lt;none&gt;\nSync Status:        OutOfSync from HEAD (f3736e6)\nHealth Status:      Missing\n\nGROUP  KIND        NAMESPACE  NAME          STATUS     HEALTH   HOOK  MESSAGE\n       Service     default    guestbook-ui  OutOfSync  Missing\napps   Deployment  default    guestbook-ui  OutOfSync  Missing\n</code></pre> <p>\u5e94\u7528\u7a0b\u5e8f\u72b6\u6001\u4e3a\u521d\u59cb OutOfSync \u72b6\u6001\uff0c\u56e0\u4e3a\u5e94\u7528\u7a0b\u5e8f\u5c1a\u672a\u90e8\u7f72\uff0c\u5e76\u4e14\u5c1a\u672a\u521b\u5efa\u4efb\u4f55 Kubernetes \u8d44\u6e90\u3002\u8981\u540c\u6b65\uff08\u90e8\u7f72\uff09\u5e94\u7528\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u6267\u884c\u5982\u4e0b\u6240\u793a\u547d\u4ee4\uff1a</p> <pre><code>$ argocd app sync argocd/guestbook\n</code></pre> <p>\u6b64\u547d\u4ee4\u4ece Git \u4ed3\u5e93\u4e2d\u68c0\u7d22\u8d44\u6e90\u6e05\u5355\u5e76\u6267\u884c kubectl apply \u90e8\u7f72\u5e94\u7528\uff0c\u6267\u884c\u4e0a\u9762\u547d\u4ee4\u540e guestbook \u5e94\u7528\u4fbf\u4f1a\u8fd0\u884c\u5728\u96c6\u7fa4\u4e2d\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u67e5\u770b\u5176\u8d44\u6e90\u7ec4\u4ef6\u3001\u65e5\u5fd7\u3001\u4e8b\u4ef6\u548c\u8bc4\u4f30\u5176\u5065\u5eb7\u72b6\u6001\u4e86\u3002</p>"},{"location":"argo1/1argo2023_gitops/#ui_1","title":"\u901a\u8fc7 UI \u540c\u6b65","text":"<p>\u76f4\u63a5\u6dfb\u52a0 UI \u754c\u9762\u4e0a\u5e94\u7528\u7684 Sync \u6309\u94ae\u5373\u53ef\u5f00\u59cb\u540c\u6b65\uff1a</p> <p></p> <p>\u540c\u6b65\u5b8c\u6210\u540e\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684\u8d44\u6e90\u72b6\u6001\uff0c\u751a\u81f3\u8fd8\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u5e94\u7528\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <p></p> <p>\u4e5f\u53ef\u4ee5\u901a\u8fc7 kubectl \u67e5\u770b\u5230\u6211\u4eec\u90e8\u7f72\u7684\u8d44\u6e90\uff1a</p> <pre><code>$ kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nguestbook-ui-6b7f6d9874-fsgsj   1/1     Running   0          17m\n\n$ kubectl get svc\nNAME           TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)   AGE\nkubernetes     ClusterIP   192.168.194.129   &lt;none&gt;        443/TCP   12h\nguestbook-ui   ClusterIP   192.168.194.195   &lt;none&gt;        80/TCP    23m\n</code></pre> <p>\u548c\u6211\u4eec\u4ece Git \u4ed3\u5e93\u4e2d\u540c\u6b65 guestbook \u76ee\u5f55\u4e0b\u9762\u7684\u8d44\u6e90\u72b6\u6001\u4e5f\u662f\u540c\u6b65\u7684\uff0c\u8bc1\u660e\u540c\u6b65\u6210\u529f\u4e86\u3002</p>"},{"location":"argo1/1argo2023_gitops/#helm","title":"Helm \u9879\u76ee","text":"<p>\u5982\u679c\u6709\u591a\u4e2a\u56e2\u961f\uff0c\u6bcf\u4e2a\u56e2\u961f\u90fd\u8981\u7ef4\u62a4\u5927\u91cf\u7684\u5e94\u7528\uff0c\u5c31\u9700\u8981\u7528\u5230 Argo CD \u7684\u53e6\u4e00\u4e2a\u6982\u5ff5\uff1a\u9879\u76ee\uff08Project\uff09\u3002Argo CD \u4e2d\u7684\u9879\u76ee\uff08Project\uff09\u53ef\u4ee5\u7528\u6765\u5bf9 Application \u8fdb\u884c\u5206\u7ec4\uff0c\u4e0d\u540c\u7684\u56e2\u961f\u4f7f\u7528\u4e0d\u540c\u7684\u9879\u76ee\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u591a\u79df\u6237\u73af\u5883\u3002\u9879\u76ee\u8fd8\u652f\u6301\u66f4\u7ec6\u7c92\u5ea6\u7684\u8bbf\u95ee\u6743\u9650\u63a7\u5236\uff1a</p> <ul> <li>\u9650\u5236\u90e8\u7f72\u5185\u5bb9\uff08\u53d7\u4fe1\u4efb\u7684 Git \u4ed3\u5e93\uff09\uff1b</li> <li>\u9650\u5236\u76ee\u6807\u90e8\u7f72\u73af\u5883\uff08\u76ee\u6807\u96c6\u7fa4\u548c namespace\uff09\uff1b</li> <li>\u9650\u5236\u90e8\u7f72\u7684\u8d44\u6e90\u7c7b\u578b\uff08\u4f8b\u5982 RBAC\u3001CRD\u3001DaemonSets\u3001NetworkPolicy \u7b49\uff09\uff1b</li> <li>\u5b9a\u4e49\u9879\u76ee\u89d2\u8272\uff0c\u4e3a Application \u63d0\u4f9b RBAC\uff08\u4f8b\u5982 OIDC group \u6216\u8005 JWT \u4ee4\u724c\u7ed1\u5b9a\uff09\u3002</li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a demo \u7684\u9879\u76ee\uff0c\u5c06\u8be5\u5e94\u7528\u521b\u5efa\u5230\u8be5\u9879\u76ee\u4e0b\uff0c\u53ea\u9700\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 AppProject \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: AppProject\nmetadata:\n  # \u9879\u76ee\u540d\n  name: demo\n  namespace: argocd\nspec:\n  # \u76ee\u6807\n  destinations:\n    # \u6b64\u9879\u76ee\u7684\u670d\u52a1\u5141\u8bb8\u90e8\u7f72\u7684 namespace\uff0c\u8fd9\u91cc\u4e3a\u5168\u90e8\n    - namespace: \"*\"\n      # \u6b64\u9879\u76ee\u5141\u8bb8\u90e8\u7f72\u7684\u96c6\u7fa4\uff0c\u8fd9\u91cc\u4e3a\u9ed8\u8ba4\u96c6\u7fa4\uff0c\u5373\u4e3aArgo CD\u90e8\u7f72\u7684\u5f53\u524d\u96c6\u7fa4\n      server: https://kubernetes.default.svc\n  # \u5141\u8bb8\u7684\u6570\u636e\u6e90\n  sourceRepos:\n    - https://github.com/argoproj/argocd-example-apps\n</code></pre> <p>\u8be5\u5bf9\u8c61\u4e2d\u6709\u51e0\u4e2a\u6838\u5fc3\u7684\u5c5e\u6027\uff1a</p> <ul> <li>sourceRepos\uff1a\u9879\u76ee\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4ece\u4e2d\u83b7\u53d6\u6e05\u5355\u7684\u4ed3\u5e93\u5f15\u7528</li> <li>destinations\uff1a\u9879\u76ee\u4e2d\u7684\u5e94\u7528\u53ef\u4ee5\u90e8\u7f72\u5230\u7684\u96c6\u7fa4\u548c\u547d\u540d\u7a7a\u95f4</li> <li>roles\uff1a\u9879\u76ee\u5185\u8d44\u6e90\u8bbf\u95ee\u5b9a\u4e49\u7684\u89d2\u8272</li> </ul> <p>\u76f4\u63a5\u521b\u5efa\u8be5\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$  kubectl get appproject -n argocd\nNAME      AGE\ndefault   12h\ndemo      20s\n</code></pre> <p>\u66f4\u591a\u914d\u7f6e\u4fe1\u606f\u53ef\u4ee5\u524d\u5f80\u6587\u6863 https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/ \u67e5\u770b\uff0c\u9879\u76ee\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5728\u8be5\u9879\u76ee\u4e0b\u521b\u5efa\u4e00\u4e2a Application\uff0c\u4ee3\u8868\u73af\u5883\u4e2d\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u3002</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: gitops-demo\n  namespace: argocd\nspec:\n  destination:\n    namespace: default\n    server: \"https://kubernetes.default.svc\"\n  project: demo\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n  source:\n    path: helm-guestbook # \u4ece Helm \u5b58\u50a8\u5e93\u521b\u5efa\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0cchart \u5fc5\u987b\u6307\u5b9a path\n    repoURL: \"https://github.com/argoproj/argocd-example-apps.git\"\n    targetRevision: HEAD\n    helm:\n      parameters:\n        - name: replicaCount\n          value: \"2\"\n      valueFiles:\n        - values.yaml\n</code></pre> <pre><code>$ kubectl apply -f gitops.yaml \napplication.argoproj.io/gitops-demo created\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a gitop-demo \u7684\u5e94\u7528\uff0c\u5e94\u7528\u6e90\u6765\u81ea\u4e8e helm \u8def\u5f84\uff0c\u4f7f\u7528\u7684\u662f <code>values.yaml</code> \u6587\u4ef6\uff0c\u6b64\u5916\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>source.helm.parameters</code> \u6765\u914d\u7f6e\u53c2\u6570\u3002</p> <p>\u540c\u6b65\u7b56\u7565\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528\u81ea\u52a8\u7684\u65b9\u5f0f\uff0c\u8be5\u7b56\u7565\u4e0b\u9762\u8fd8\u6709\u4e24\u4e2a\u5c5e\u6027\u53ef\u4ee5\u914d\u7f6e\uff1a</p> <ul> <li><code>PRUNE RESOURCES</code>\uff1a\u5f00\u542f\u540e Git Repo \u4e2d\u5220\u9664\u8d44\u6e90\u4f1a\u81ea\u52a8\u5728\u73af\u5883\u4e2d\u5220\u9664\u5bf9\u5e94\u7684\u8d44\u6e90\u3002</li> </ul> <p></p> <ul> <li>SELF HEAL\uff1a\u81ea\u52a8\u75ca\u6108\uff0c\u5f3a\u5236\u4ee5 Git Repo \u72b6\u6001\u4e3a\u51c6\uff0c\u624b\u52a8\u5728\u73af\u5883\u4e2d\u4fee\u6539\u4e0d\u4f1a\u751f\u6548</li> </ul> <p></p> <p>\u6b63\u5e38\u521b\u5efa\u540e\u8fd9\u4e2a\u5e94\u7528\u5c31\u4f1a\u81ea\u52a8\u90e8\u7f72\u4e86\uff0c\u6839\u636e\u6211\u4eec\u914d\u7f6e\u4f1a\u751f\u6210\u4e24\u4e2a\u526f\u672c\u3002</p> <p></p> <p>\u7531\u4e8e Argo CD \u9ed8\u8ba4\u5e76\u4e0d\u662f\u5b9e\u65f6\u53bb\u76d1\u6d4b Config Repo \u7684\u53d8\u5316\u7684\uff0c\u5982\u679c\u8981\u66f4\u5feb\u7684\u68c0\u6d4b\u5230\u53d8\u5316\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Git Webhook \u7684\u65b9\u5f0f\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Argo CD \u6bcf\u4e09\u5206\u949f\u8f6e\u8be2\u4e00\u6b21 Git \u5b58\u50a8\u5e93\uff0c\u4ee5\u68c0\u6d4b\u6e05\u5355\u7684\u66f4\u6539\u3002\u4e3a\u4e86\u6d88\u9664\u8f6e\u8be2\u5ef6\u8fdf\uff0c\u53ef\u4ee5\u5c06 API \u670d\u52a1\u5668\u914d\u7f6e\u4e3a\u63a5\u6536 Webhook \u4e8b\u4ef6\u3002Argo CD \u652f\u6301\u6765\u81ea GitHub\u3001GitLab\u3001Bitbucket\u3001Bitbucket Server \u548c Gogs \u7684 Git webhook \u901a\u77e5\u3002</p> <p>\u540c\u6837\u65b9\u5f0f\u6211\u4eec\u53ef\u4ee5\u5728 <code>k8s-devops-demo-config</code> \u4ed3\u5e93\u4e0b\u9762\u521b\u5efa\u4e00\u4e2a <code>Webhook</code>\uff0cGit \u63d0\u4f9b\u7a0b\u5e8f\u4e2d\u914d\u7f6e\u7684\u6709\u6548\u8d1f\u8f7d URL \u5e94\u4f7f\u7528 Argo CD \u5b9e\u4f8b\u7684 <code>/api/webhook</code> \u7aef\u70b9\uff08\u4f8b\u5982 https://argocd.example.com/api/webhook\uff09\u3002</p> <p></p> <pre><code>$ kubectl edit secret argocd-secret -n argocd\napiVersion: v1\nkind: Secret\nmetadata:\n  name: argocd-secret\n  namespace: argocd\ntype: Opaque\ndata:\n...\n\nstringData:\n  # github webhook secret\n  webhook.github.secret: shhhh! it's a GitHub secret\n\n  # gitlab webhook secret\n  webhook.gitlab.secret: shhhh! it's a GitLab secret\n\n  # bitbucket webhook secret\n  webhook.bitbucket.uuid: your-bitbucket-uuid\n\n  # bitbucket server webhook secret\n  webhook.bitbucketserver.secret: shhhh! it's a Bitbucket server secret\n\n  # gogs server webhook secret\n  webhook.gogs.secret: shhhh! it's a gogs server secret\n</code></pre> <p>\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>stringData</code> \u6765\u914d\u7f6e secret\uff0c\u8fd9\u6837\u5c31\u4e0d\u7528\u53bb\u624b\u52a8\u7f16\u7801\u4e86\u3002</p> <p>\u56e0\u4e3a GitOps \u7684\u6838\u5fc3\u662f Git\uff0c\u6240\u4ee5\u6211\u4eec\u4e00\u5b9a\u8981\u5c06\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5168\u90fd\u6258\u7ba1\u5230 Git \u4ed3\u5e93\u4e2d\uff0c\u8fd9\u6837\u624d\u80fd\u5b9e\u73b0 GitOps \u7684\u81ea\u52a8\u540c\u6b65\u90e8\u7f72\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u662f\u5728 CI \u6d41\u6c34\u7ebf\u4e2d\u53bb\u4fee\u6539 Git \u4ed3\u5e93\u4e2d\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5176\u5b9e\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u65b9\u5f0f\u53bb\u4fee\u6539\uff0c\u6bd4\u5982 Argo CD \u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b0\u7684\u5de5\u5177 Argo CD Image Updater\u3002</p>"},{"location":"argo1/1argo2023_gitops/#applicationset","title":"ApplicationSet","text":"<p>ApplicationSet \u7528\u4e8e\u7b80\u5316\u591a\u96c6\u7fa4\u5e94\u7528\u7f16\u6392\uff0c\u5b83\u53ef\u4ee5\u57fa\u4e8e\u5355\u4e00\u5e94\u7528\u7f16\u6392\u5e76\u6839\u636e\u7528\u6237\u7684\u7f16\u6392\u5185\u5bb9\u81ea\u52a8\u751f\u6210\u4e00\u4e2a\u6216\u591a\u4e2a Application\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 ApplicationSet \u8d44\u6e90\u5bf9\u8c61</p> <pre><code> applicationset.yaml\napiVersion: argoproj.io/v1alpha1\nkind: ApplicationSet\nmetadata:\n  name: guestbook\nspec:\n  goTemplate: true # \u4f7f\u7528 go template \u6a21\u677f\n  goTemplateOptions: [\"missingkey=error\"] # \u5f53\u6a21\u677f\u4e2d\u7f3a\u5c11\u952e\u65f6\uff0c\u629b\u51fa\u9519\u8bef\n  generators: # \u751f\u6210\u5668\uff0c\u7528\u4e8e\u751f\u6210\u53c2\u6570\n    - list: # \u5217\u8868\u751f\u6210\u5668\n        elements: # \u5143\u7d20\n          - cluster: dev\n            url: https://1.2.3.4\n          - cluster: staging\n            url: https://9.8.7.6\n          - cluster: prod\n            url: https://kubernetes.default.svc\n  template:\n    metadata:\n      name: \"{{.cluster}}-guestbook\"\n    spec:\n      project: demo\n      source:\n        repoURL: https://gitee.com/cnych/argocd-example-apps\n        targetRevision: HEAD\n        path: helm-guestbook\n        helm:\n          valueFiles:\n            - \"{{.cluster}}.yaml\"\n      syncPolicy:\n        syncOptions:\n          - CreateNamespace=true\n      destination:\n        server: \"{{.url}}\"\n        namespace: guestbook\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a ApplicationSet \u8d44\u6e90\u5bf9\u8c61\uff0c\u5176\u4e2d\u4f7f\u7528\u4e86\u6a21\u677f\u548c\u751f\u6210\u5668\uff1a</p> <ul> <li><code>goTemplate: true</code>\uff1a\u8868\u793a\u4f7f\u7528 <code>go template</code> \u7684\u6a21\u677f</li> <li><code>goTemplateOptions: [\"missingkey=error\"]</code>\uff1a\u5f53\u6a21\u677f\u4e2d\u7f3a\u5c11\u952e\u65f6\uff0c\u629b\u51fa\u9519\u8bef</li> <li> <p><code>generators</code>\uff1a\u751f\u6210\u5668\uff0c\u7528\u4e8e\u751f\u6210\u53c2\u6570\uff0cApplicationSet \u63a7\u5236\u5668\u5f53\u524d\u652f\u6301\u591a\u79cd\u751f\u6210\u5668\uff1a</p> <ul> <li>\u5305\u542b JSON \u503c\u7684\u6587\u4ef6\u5c06\u88ab\u89e3\u6790\u5e76\u8f6c\u6362\u4e3a\u6a21\u677f\u53c2\u6570\u3002</li> <li>Git \u5b58\u50a8\u5e93\u4e2d\u7684\u5404\u4e2a\u76ee\u5f55\u8def\u5f84\u4e5f\u53ef\u4ee5\u7528\u4f5c\u53c2\u6570\u503c\u3002</li> <li>\u5217\u8868\u751f\u6210\u5668\uff1a\u6839\u636e\u96c6\u7fa4\u540d\u79f0/URL \u503c\u7684\u56fa\u5b9a\u5217\u8868\u751f\u6210\u53c2\u6570\uff0c\u5982\u4e0a\u4f8b\u6240\u793a\u3002</li> <li>\u96c6\u7fa4\u751f\u6210\u5668\uff1a\u96c6\u7fa4\u751f\u6210\u5668\u4e0d\u662f\u57fa\u4e8e clusters \u7684\u5b57\u9762\u5217\u8868\uff08\u4e0e\u5217\u8868\u751f\u6210\u5668\u4e00\u6837\uff09\uff0c\u800c\u662f\u6839\u636e Argo CD \u4e2d\u5b9a\u4e49\u7684\u96c6\u7fa4\u81ea\u52a8\u751f\u6210\u96c6\u7fa4\u53c2\u6570\u3002</li> <li>Git \u751f\u6210\u5668\uff1aGit \u751f\u6210\u5668\u6839\u636e\u751f\u6210\u5668\u8d44\u6e90\u4e2d\u5b9a\u4e49\u7684 Git \u5b58\u50a8\u5e93\u4e2d\u5305\u542b\u7684\u6587\u4ef6\u6216\u6587\u4ef6\u5939\u751f\u6210\u53c2\u6570\u3002</li> <li>\u77e9\u9635\u751f\u6210\u5668\uff1a\u77e9\u9635\u751f\u6210\u5668\u7ed3\u5408\u4e86\u5176\u4ed6\u4e24\u4e2a\u751f\u6210\u5668\u751f\u6210\u7684\u53c2\u6570\u3002</li> </ul> </li> <li> <p>template\uff1a\u6a21\u677f\uff0c\u7528\u4e8e\u751f\u6210 Application \u8d44\u6e90\u5bf9\u8c61</p> </li> </ul> <p>\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7\u5217\u8868\u751f\u6210\u5668\u5b9a\u4e49\u4e86\u591a\u4e2a\u751f\u6210\u5668\u5143\u7d20\uff0c\u91cc\u9762\u5305\u542b cluster \u548c url \u4e24\u4e2a\u53c2\u6570\uff0cApplicationSet \u63a7\u5236\u5668\u4f1a\u6839\u636e\u8fd9\u4e9b\u53c2\u6570\u751f\u6210\u591a\u4e2a Application \u8d44\u6e90\u5bf9\u8c61\uff0c\u6bcf\u4e2a Application \u8d44\u6e90\u5bf9\u8c61\u90fd\u4f1a\u90e8\u7f72\u5230\u5bf9\u5e94\u7684\u96c6\u7fa4\u548c\u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u6bcf\u4e2a Application \u8d44\u6e90\u5c31\u662f\u901a\u8fc7\u8fd9\u4e9b\u53c2\u6570\u5c06\u6a21\u677f\u4e2d\u7684\u5185\u5bb9\u6e32\u67d3\u751f\u6210\u3002</p> <p>\u8bba\u4f7f\u7528\u54ea\u4e2a\u751f\u6210\u5668\uff0c\u751f\u6210\u5668\u751f\u6210\u7684\u53c2\u6570\u90fd\u4f1a\u66ff\u6362\u4e3a ApplicationSet \u8d44\u6e90\u7684 template: \u90e8\u5206\u4e2d\u7684 <code>{{parameter name}}</code>\u503c\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u5217\u8868\u751f\u6210\u5668\u5b9a\u4e49\u4e86 cluster \u548c url \u53c2\u6570\uff0c\u7136\u540e\u5c06\u5b83\u4eec\u5206\u522b\u66ff\u6362\u4e3a\u6a21\u677f\u7684 <code>{{cluster}}</code> \u548c <code>{{url}}</code>\u503c\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 argocd appset \u547d\u4ee4\u6765\u521b\u5efa\uff1a</p> <pre><code>$ argocd appset create applicationset.yaml\nApplicationSet 'guestbook' created\n$ argocd appset list\nNAME              PROJECT  SYNCPOLICY  CONDITIONS                                                                                                                                                                                                                                     REPO                                         PATH            TARGET\nargocd/guestbook  demo     nil         [{ParametersGenerated Successfully generated parameters for all Applications 2024-09-08 11:48:52 +0800 CST True ParametersGenerated} {ResourcesUpToDate ApplicationSet up to date 2024-09-08 11:48:52 +0800 CST True ApplicationSetUpToDate}]  https://gitee.com/cnych/argocd-example-apps  helm-guestbook  HEAD\n</code></pre> <p>\u5efa\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7 <code>argocd appset list</code> \u67e5\u770b ApplicationSet \u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\uff0c\u4ece\u4e0a\u9762\u8f93\u51fa\u53ef\u4ee5\u770b\u5230 <code>ApplicationSet</code> \u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u4e3a <code>ParametersGenerated</code>\uff0c\u8868\u793a\u53c2\u6570\u5df2\u7ecf\u751f\u6210\u6210\u529f\uff0c\u4e5f\u5c31\u662f\u5df2\u7ecf\u5c06 <code>ApplicationSet</code>\u8d44\u6e90\u5bf9\u8c61\u4e2d\u7684\u5185\u5bb9\u6e32\u67d3\u751f\u6210\u591a\u4e2a <code>Application</code> \u8d44\u6e90\u5bf9\u8c61\u4e86\u3002</p> <p>\u67e5\u770b\u4e0b Application \u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u5373\u53ef</p> <pre><code>$ argocd argocd app list\nNAME                      CLUSTER                         NAMESPACE  PROJECT  STATUS     HEALTH   SYNCPOLICY  CONDITIONS           REPO                                             PATH            TARGET\nargocd/dev-guestbook      https://1.2.3.4                 guestbook  demo     Unknown    Unknown  Manual      InvalidSpecError(2)  https://gitee.com/cnych/argocd-example-apps      helm-guestbook  HEAD\nargocd/prod-guestbook     https://kubernetes.default.svc  guestbook  demo     OutOfSync  Missing  Manual      &lt;none&gt;               https://gitee.com/cnych/argocd-example-apps      helm-guestbook  HEAD\nargocd/staging-guestbook  https://9.8.7.6                 guestbook  demo     Unknown  \n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u6e32\u67d3\u4e86 3 \u4e2a Application \u8d44\u6e90\u5bf9\u8c61\uff0c\u548c\u6211\u4eec\u524d\u9762\u5728 ApplicationSet \u8d44\u6e90\u5bf9\u8c61\u4e2d\u5b9a\u4e49\u7684\u96c6\u7fa4\u548c URL \u662f\u4e00\u4e00\u5bf9\u5e94\u7684\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 Dashboard \u754c\u9762\u4e2d\u67e5\u770b\uff1a</p> <p></p>"},{"location":"argo1/1argo2023_gitops/#2023","title":"\u6d41\u6c34\u7ebf\u6539\u9020 2023","text":"<p>\u524d\u9762\u6211\u4eec\u901a\u8fc7 Jenkins Pipeline \u5df2\u7ecf\u6210\u529f\u7684\u5c06\u5e94\u7528\u90e8\u7f72\u5230\u4e86\u96c6\u7fa4\u4e2d\u4e86\uff0c\u4f46\u662f\u6211\u4eec\u4f7f\u7528\u7684\u662f\u4f20\u7edf\u7684\u4e3b\u52a8 push \u65b9\u5f0f\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u5c06\u8fd9\u4e2a\u6d41\u7a0b\u6539\u9020\u6210\u4e3a\u4e00\u4e2a GitOps \u7684\u6d41\u6c34\u7ebf\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 Git \u6765\u7ba1\u7406\u5e94\u7528\u7684\u90e8\u7f72\u4e86\u3002</p> <p>\u4f7f\u7528\u5230\u7684\u4ee3\u7801\u4ed3\u5e93\u4f4d\u4e8e https://github.com/cnych/drone-k8s-demo\uff0c\u7136\u540e\u8fc1\u79fb\u5230\u5185\u90e8\u7684 gitlab \u73af\u5883\u4e0a\u5b9e\u9a8c\u3002</p> <p>\u524d\u9762 Jenkins Pipeline \u4e2d\u6211\u4eec\u5728\u53d1\u5e03\u5e94\u7528\u7684\u65f6\u5019\u662f\u901a\u8fc7 helm \u65b9\u5f0f\u6765\u90e8\u7f72\u7684\uff0c\u73b0\u5728\u6211\u4eec\u53ea\u9700\u8981\u5c06\u6d41\u6c34\u7ebf\u7684 CD \u90e8\u5206\u8fdb\u884c\u6539\u9020\uff0c\u6bd4\u5982\u5c06\u955c\u50cf\u6784\u5efa\u540e\u63a8\u9001\u5230\u955c\u50cf\u4ed3\u5e93\uff0c\u7136\u540e\u53bb\u4fee\u6539 git \u4ed3\u5e93\u4e2d\u7684 values \u6587\u4ef6\uff0cArgo CD \u6765\u540c\u6b65\u90e8\u7f72\u5e94\u7528\u5373\u53ef\u3002</p> <p>\u9996\u5148\u6211\u4eec\u5c06\u5e94\u7528\u7684\u90e8\u7f72\u8d44\u6e90\u6e05\u5355\u5355\u72ec\u653e\u4e00\u4e2a config \u7684\u4ed3\u5e93\u4e0b\u9762 http://gitlab.k8s.local/cnych/k8s-devops-demo-config.git\uff0c\u5c06\u524d\u9762\u5e94\u7528\u7684 helm \u76ee\u5f55\u4e0a\u4f20\u5230\u8be5\u4ed3\u5e93\u4e2d\u3002\u8fd9\u6837\u65b9\u4fbf\u548c Argo CD \u8fdb\u884c\u5bf9\u63a5\uff0c\u6574\u4e2a\u9879\u76ee\u4e0b\u9762\u53ea\u6709\u7528\u4e8e\u5e94\u7528\u90e8\u7f72\u7684 Helm Chart \u6a21\u677f\u3002</p> <p></p> <p>\u5982\u679c\u6709\u591a\u4e2a\u56e2\u961f\uff0c\u6bcf\u4e2a\u56e2\u961f\u90fd\u8981\u7ef4\u62a4\u5927\u91cf\u7684\u5e94\u7528\uff0c\u5c31\u9700\u8981\u7528\u5230 Argo CD \u7684\u53e6\u4e00\u4e2a\u6982\u5ff5\uff1a\u9879\u76ee\uff08Project\uff09\u3002Argo CD \u4e2d\u7684\u9879\u76ee\uff08Project\uff09\u53ef\u4ee5\u7528\u6765\u5bf9 Application \u8fdb\u884c\u5206\u7ec4\uff0c\u4e0d\u540c\u7684\u56e2\u961f\u4f7f\u7528\u4e0d\u540c\u7684\u9879\u76ee\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u591a\u79df\u6237\u73af\u5883\u3002\u9879\u76ee\u8fd8\u652f\u6301\u66f4\u7ec6\u7c92\u5ea6\u7684\u8bbf\u95ee\u6743\u9650\u63a7\u5236\uff1a</p> <ul> <li>\u9650\u5236\u90e8\u7f72\u5185\u5bb9\uff08\u53d7\u4fe1\u4efb\u7684 Git \u4ed3\u5e93\uff09\uff1b</li> <li>\u9650\u5236\u76ee\u6807\u90e8\u7f72\u73af\u5883\uff08\u76ee\u6807\u96c6\u7fa4\u548c namespace\uff09\uff1b</li> <li>\u9650\u5236\u90e8\u7f72\u7684\u8d44\u6e90\u7c7b\u578b\uff08\u4f8b\u5982 RBAC\u3001CRD\u3001DaemonSets\u3001NetworkPolicy \u7b49\uff09\uff1b</li> <li>\u5b9a\u4e49\u9879\u76ee\u89d2\u8272\uff0c\u4e3a Application \u63d0\u4f9b RBAC\uff08\u4f8b\u5982 OIDC group \u6216\u8005 JWT \u4ee4\u724c\u7ed1\u5b9a\uff09\u3002</li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a demo \u7684\u9879\u76ee\uff0c\u5c06\u8be5\u5e94\u7528\u521b\u5efa\u5230\u8be5\u9879\u76ee\u4e0b\uff0c\u53ea\u9700\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 AppProject \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: AppProject\nmetadata:\n  # \u9879\u76ee\u540d\n  name: demo\n  namespace: argocd\nspec:\n  # \u76ee\u6807\n  destinations:\n    # \u6b64\u9879\u76ee\u7684\u670d\u52a1\u5141\u8bb8\u90e8\u7f72\u7684 namespace\uff0c\u8fd9\u91cc\u4e3a\u5168\u90e8\n    - namespace: \"*\"\n      # \u6b64\u9879\u76ee\u5141\u8bb8\u90e8\u7f72\u7684\u96c6\u7fa4\uff0c\u8fd9\u91cc\u4e3a\u9ed8\u8ba4\u96c6\u7fa4\uff0c\u5373\u4e3aArgo CD\u90e8\u7f72\u7684\u5f53\u524d\u96c6\u7fa4\n      server: https://kubernetes.default.svc\n  # \u5141\u8bb8\u7684\u6570\u636e\u6e90\n  sourceRepos:\n    - http://gitlab.k8s.local/cnych/k8s-devops-demo-config.git\n</code></pre> <p>\u8be5\u5bf9\u8c61\u4e2d\u6709\u51e0\u4e2a\u6838\u5fc3\u7684\u5c5e\u6027\uff1a</p> <ul> <li>sourceRepos\uff1a\u9879\u76ee\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4ece\u4e2d\u83b7\u53d6\u6e05\u5355\u7684\u4ed3\u5e93\u5f15\u7528</li> <li>destinations\uff1a\u9879\u76ee\u4e2d\u7684\u5e94\u7528\u53ef\u4ee5\u90e8\u7f72\u5230\u7684\u96c6\u7fa4\u548c\u547d\u540d\u7a7a\u95f4</li> <li>roles\uff1a\u9879\u76ee\u5185\u8d44\u6e90\u8bbf\u95ee\u5b9a\u4e49\u7684\u89d2\u8272</li> </ul> <p>\u76f4\u63a5\u521b\u5efa\u8be5\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl get appproject -n argocd\nNAME      AGE\ndefault   47h\ndemo      6s\n</code></pre> <p>\u7136\u540e\u524d\u5f80 Argo CD \u7684 Settings \u9875\u9762\u70b9\u51fb + CONNECT REPO \u6dfb\u52a0\u4ed3\u5e93\uff1a</p> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u91cc\u7684\u5bc6\u7801\u9700\u8981\u4f7f\u7528 AccessToken\uff0c \u6211\u4eec\u53ef\u4ee5\u524d\u5f80 GitLab \u7684\u9875\u9762 <code>http://gitlab.k8s.local/-/profile/personal_access_tokens</code> \u521b\u5efa\u3002</p> <p></p> <p>\u66f4\u591a\u914d\u7f6e\u4fe1\u606f\u53ef\u4ee5\u524d\u5f80\u6587\u6863 https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/ \u67e5\u770b\uff0c\u9879\u76ee\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5728\u8be5\u9879\u76ee\u4e0b\u521b\u5efa\u4e00\u4e2a Application\uff0c\u4ee3\u8868\u73af\u5883\u4e2d\u90e8\u7f72\u7684\u5e94\u7528\u7a0b\u5e8f\u5b9e\u4f8b\u3002</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: devops-demo\n  namespace: argocd\nspec:\n  destination:\n    namespace: default\n    server: \"https://kubernetes.default.svc\"\n  project: demo\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n  source:\n    path: helm # \u4ece Helm \u5b58\u50a8\u5e93\u521b\u5efa\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0cchart \u5fc5\u987b\u6307\u5b9a path\n    repoURL: \"http://gitlab.k8s.local/cnych/k8s-devops-demo-config.git\"\n    targetRevision: HEAD\n    helm:\n      parameters:\n        - name: replicaCount\n          value: \"2\"\n      valueFiles:\n        - my-values.yaml\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a devops-demo \u7684\u5e94\u7528\uff0c\u5e94\u7528\u6e90\u6765\u81ea\u4e8e helm \u8def\u5f84\uff0c\u4f7f\u7528\u7684\u662f <code>my-values.yaml</code> \u6587\u4ef6\uff0c\u6b64\u5916\u8fd8\u53ef\u4ee5\u901a\u8fc7 source.helm.parameters \u6765\u914d\u7f6e\u53c2\u6570\u3002</p> <p>\u540c\u6b65\u7b56\u7565\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528\u81ea\u52a8\u7684\u65b9\u5f0f\uff0c\u8be5\u7b56\u7565\u4e0b\u9762\u8fd8\u6709\u4e24\u4e2a\u5c5e\u6027\u53ef\u4ee5\u914d\u7f6e\uff1a</p> <p></p> <p>\u6b63\u5e38\u521b\u5efa\u540e\u8fd9\u4e2a\u5e94\u7528\u4f1a\u51fa\u73b0 Degraded \u7684\u9519\u8bef\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec Values \u4e2d\u7684\u955c\u50cf\u9ed8\u8ba4\u4e3a latest\uff0c\u800c\u6211\u4eec\u6ca1\u6709\u5c06\u955c\u50cf\u63a8\u9001\u5230\u955c\u50cf\u4ed3\u5e93\uff0c\u6240\u4ee5\u4f1a\u51fa\u73b0\u9519\u8bef\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u53bb\u4fee\u6539 Jenkins Pipeline \u7684\u6d41\u6c34\u7ebf\uff0c\u5c06 CD \u90e8\u5206\u8fdb\u884c\u4fee\u6539\u3002</p> <pre><code>podTemplate(cloud: \"Kubernetes\", nodeSelector: \"kubernetes.io/hostname=node2\", containers: [\n  containerTemplate(name: 'golang', image: 'golang:1.18.3-alpine3.16', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'docker', image: 'docker:latest', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'kubectl', image: 'cnych/kubectl', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'helm', image: 'cnych/helm', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'yq', image: 'cnych/yq-jq:git', command: 'cat', ttyEnabled: true)\n], serviceAccount: 'jenkins', envVars: [\n  envVar(key: 'DOCKER_HOST', value: 'tcp://docker-dind:2375')  // \u73af\u5883\u53d8\u91cf\n]) {\n  node(POD_LABEL) {\n    def myRepo = checkout scm\n    def gitConfigRepo = \"gitlab.k8s.local/cnych/k8s-devops-demo-config.git\"\n    def gitCommit = myRepo.GIT_COMMIT\n    def gitBranch = myRepo.GIT_BRANCH\n\n    // \u83b7\u53d6 git commit id \u4f5c\u4e3a\u955c\u50cf\u6807\u7b7e\n    def imageTag = sh(script: \"git rev-parse --short HEAD\", returnStdout: true).trim()\n    // \u4ed3\u5e93\u5730\u5740\n    def registryUrl = \"harbor.k8s.local\"\n    def imageEndpoint = \"course/devops-demo\"\n    // \u955c\u50cf\n    def image = \"${registryUrl}/${imageEndpoint}:${imageTag}\"\n\n    stage('\u5355\u5143\u6d4b\u8bd5') {\n      echo \"\u6d4b\u8bd5\u9636\u6bb5\"\n    }\n    stage('\u4ee3\u7801\u7f16\u8bd1\u6253\u5305') {\n        try {\n            container('golang') {\n            echo \"2.\u4ee3\u7801\u7f16\u8bd1\u6253\u5305\u9636\u6bb5\"\n            sh \"\"\"\n                export GOPROXY=https://goproxy.io\n                GOOS=linux GOARCH=amd64 go build -v -o demo-app\n                \"\"\"\n            }\n        } catch (exc) {\n            println \"\u6784\u5efa\u5931\u8d25 - ${currentBuild.fullDisplayName}\"\n            throw(exc)\n        }\n    }\n    stage('\u6784\u5efa Docker \u955c\u50cf') {\n        withCredentials([[$class: 'UsernamePasswordMultiBinding',\n            credentialsId: 'docker-auth',\n            usernameVariable: 'DOCKER_USER',\n            passwordVariable: 'DOCKER_PASSWORD']]) {\n            container('docker') {\n                echo \"3. \u6784\u5efa Docker \u955c\u50cf\u9636\u6bb5\"\n                sh \"\"\"\n                docker login ${registryUrl} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}\n                docker build -t ${image} .\n                docker push ${image}\n                \"\"\"\n            }\n        }\n    }\n    stage('\u4fee\u6539 Config Repo') {\n        withCredentials([[$class: 'UsernamePasswordMultiBinding',\n            credentialsId: 'gitlab-auth',\n            usernameVariable: 'GIT_USER',\n            passwordVariable: 'GIT_PASSWORD']]) {\n                container('yq') {\n                    echo \"3. \u4fee\u6539 Config Repo \u4ed3\u5e93 Values\"\n                    // Bed6gAYq\n                    sh \"\"\"\n                    git clone http://${GIT_USER}:${GIT_PASSWORD}@${gitConfigRepo}\n                    cd k8s-devops-demo-config\n                    yq write -i -y helm/my-values.yaml image.tag \"${imageTag}\"\n\n                    git add helm/my-values.yaml\n\n                    git config --global user.name \"cnych\"\n                    git config --global user.email \"cnych@youdianzhishi.com\"\n\n                    git commit -m \"update image tag to ${imageTag}\"\n\n                    git push http://${GIT_USER}:${GIT_PASSWORD}@${gitConfigRepo}\n                    \"\"\"\n                }\n        }\n\n    }\n    stage('\u8fd0\u884c Kubectl') {\n        withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG')]) {\n            container('kubectl') {\n                sh \"mkdir -p ~/.kube &amp;&amp; cp ${KUBECONFIG} ~/.kube/config\"\n                echo \"5.\u67e5\u770b\u5e94\u7528\"\n                sh \"kubectl get all -n kube-ops -l app=devops-demo\"\n            }\n        }\n    }\n\n  }\n}\n</code></pre> <p>\u4e0a\u9762\u7684\u6d41\u6c34\u7ebf\u4e2d\u6211\u4eec\u5728\u5e94\u7528\u6784\u5efa\u6210\u955c\u50cf\u540e\uff0c\u76f4\u63a5\u53bb\u4fee\u6539\u4e86 Config Repo \u4ed3\u5e93\u4e2d\u7684 values \u6587\u4ef6\uff0c\u7136\u540e\u63d0\u4ea4\u5230\u4ed3\u5e93\u4e2d\uff0c\u8fd9\u6837 Argo CD \u5c31\u4f1a\u81ea\u52a8\u540c\u6b65\u90e8\u7f72\u5e94\u7528\u4e86\u3002</p> <p>\u7531\u4e8e Argo CD \u9ed8\u8ba4\u5e76\u4e0d\u662f\u5b9e\u65f6\u53bb\u76d1\u6d4b Config Repo \u7684\u53d8\u5316\u7684\uff0c\u5982\u679c\u8981\u66f4\u5feb\u7684\u68c0\u6d4b\u5230\u53d8\u5316\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Git Webhook \u7684\u65b9\u5f0f\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Argo CD \u6bcf\u4e09\u5206\u949f\u8f6e\u8be2\u4e00\u6b21 Git \u5b58\u50a8\u5e93\uff0c\u4ee5\u68c0\u6d4b\u6e05\u5355\u7684\u66f4\u6539\u3002\u4e3a\u4e86\u6d88\u9664\u8f6e\u8be2\u5ef6\u8fdf\uff0c\u53ef\u4ee5\u5c06 API \u670d\u52a1\u5668\u914d\u7f6e\u4e3a\u63a5\u6536 Webhook \u4e8b\u4ef6\u3002Argo CD \u652f\u6301\u6765\u81ea GitHub\u3001GitLab\u3001Bitbucket\u3001Bitbucket Server \u548c Gogs \u7684 Git webhook \u901a\u77e5\u3002</p> <p>\u540c\u6837\u65b9\u5f0f\u6211\u4eec\u53ef\u4ee5\u5728 <code>k8s-devops-demo-config</code> \u4ed3\u5e93\u4e0b\u9762\u521b\u5efa\u4e00\u4e2a <code>Webhook</code>\uff0cGit \u63d0\u4f9b\u7a0b\u5e8f\u4e2d\u914d\u7f6e\u7684\u6709\u6548\u8d1f\u8f7d URL \u5e94\u4f7f\u7528 Argo CD \u5b9e\u4f8b\u7684 <code>/api/webhook</code> \u7aef\u70b9\uff08\u4f8b\u5982 https://argocd.example.com/api/webhook\uff09\u3002</p> <p></p> <pre><code>$ kubectl edit secret argocd-secret -n argocd\napiVersion: v1\nkind: Secret\nmetadata:\n  name: argocd-secret\n  namespace: argocd\ntype: Opaque\ndata:\n...\n\nstringData:\n  # github webhook secret\n  webhook.github.secret: shhhh! it's a GitHub secret\n\n  # gitlab webhook secret\n  webhook.gitlab.secret: shhhh! it's a GitLab secret\n\n  # bitbucket webhook secret\n  webhook.bitbucket.uuid: your-bitbucket-uuid\n\n  # bitbucket server webhook secret\n  webhook.bitbucketserver.secret: shhhh! it's a Bitbucket server secret\n\n  # gogs server webhook secret\n  webhook.gogs.secret: shhhh! it's a gogs server secret\n</code></pre> <p>\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 stringData \u6765\u914d\u7f6e secret\uff0c\u8fd9\u6837\u5c31\u4e0d\u7528\u53bb\u624b\u52a8\u7f16\u7801\u4e86\u3002</p> <p></p> <p>\u56e0\u4e3a GitOps \u7684\u6838\u5fc3\u662f Git\uff0c\u6240\u4ee5\u6211\u4eec\u4e00\u5b9a\u8981\u5c06\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5168\u90fd\u6258\u7ba1\u5230 Git \u4ed3\u5e93\u4e2d\uff0c\u8fd9\u6837\u624d\u80fd\u5b9e\u73b0 GitOps \u7684\u81ea\u52a8\u540c\u6b65\u90e8\u7f72\u3002\u4e0a\u9762\u6211\u4eec\u662f\u5728 CI \u6d41\u6c34\u7ebf\u4e2d\u53bb\u4fee\u6539 Git \u4ed3\u5e93\u4e2d\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u5176\u5b9e\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u65b9\u5f0f\u53bb\u4fee\u6539\uff0c\u6bd4\u5982 Argo CD \u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b0\u7684\u5de5\u5177 Argo CD Image Updater\u3002</p>"},{"location":"argo1/1argo2023_gitops/#argo-cd-image-updater","title":"Argo CD Image Updater","text":"<p>Argo CD Image Updater \u662f\u4e00\u79cd\u81ea\u52a8\u66f4\u65b0\u7531 Argo CD \u7ba1\u7406\u7684 Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u7684\u5bb9\u5668\u955c\u50cf\u7684\u5de5\u5177\u3002 </p> <p>\u8be5\u5de5\u5177\u53ef\u4ee5\u68c0\u67e5\u4e0e Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u4e00\u8d77\u90e8\u7f72\u7684\u5bb9\u5668\u955c\u50cf\u7684\u65b0\u7248\u672c\uff0c\u5e76\u4f7f\u7528 Argo CD \u81ea\u52a8\u5c06\u5176\u66f4\u65b0\u5230\u5141\u8bb8\u7684\u6700\u65b0\u7248\u672c\u3002</p> <p>\u5b83\u901a\u8fc7\u4e3a Argo CD \u5e94\u7528\u7a0b\u5e8f\u8bbe\u7f6e\u9002\u5f53\u7684\u5e94\u7528\u7a0b\u5e8f\u53c2\u6570\u6765\u5de5\u4f5c\uff0c\u7c7b\u4f3c\u4e8e <code>argocd app set --helm-set image.tag=v1.0.1</code>\uff0c\u4f46\u4ee5\u5b8c\u5168\u81ea\u52a8\u5316\u7684\u65b9\u5f0f\u3002</p> <p>Argo CD Image Updater \u4f1a\u5b9a\u671f\u8f6e\u8be2 Argo CD \u4e2d\u914d\u7f6e\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e76\u67e5\u8be2\u76f8\u5e94\u7684\u955c\u50cf\u4ed3\u5e93\u4ee5\u83b7\u53d6\u53ef\u80fd\u7684\u65b0\u7248\u672c\u3002\u5982\u679c\u5728\u4ed3\u5e93\u4e2d\u627e\u5230\u65b0\u7248\u672c\u7684\u955c\u50cf\uff0c\u5e76\u4e14\u6ee1\u8db3\u7248\u672c\u7ea6\u675f\uff0cArgo CD \u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u5c06\u6307\u793a Argo CD \u4f7f\u7528\u65b0\u7248\u672c\u7684\u955c\u50cf\u66f4\u65b0\u5e94\u7528\u7a0b\u5e8f\u3002</p>"},{"location":"argo1/1argo2023_gitops/#_6","title":"\u7279\u5f81","text":"<ul> <li>\u66f4\u65b0\u7531 Argo CD \u7ba1\u7406\u4e14\u7531 Helm \u6216 Kustomize \u5de5\u5177\u751f\u6210\u7684\u5e94\u7528\u7a0b\u5e8f\u955c\u50cf</li> <li> <p>\u6839\u636e\u4e0d\u540c\u7684\u66f4\u65b0\u7b56\u7565\u66f4\u65b0\u5e94\u7528\u955c\u50cf</p> <ul> <li>semver\uff1a\u6839\u636e\u7ed9\u5b9a\u7684\u955c\u50cf\u7ea6\u675f\u66f4\u65b0\u5230\u5141\u8bb8\u7684\u6700\u9ad8\u7248\u672c</li> <li>latest\uff1a\u66f4\u65b0\u5230\u6700\u8fd1\u521b\u5efa\u7684\u955c\u50cf\u6807\u7b7e</li> <li>name\uff1a\u66f4\u65b0\u5230\u6309\u5b57\u6bcd\u987a\u5e8f\u6392\u5e8f\u7684\u5217\u8868\u4e2d\u7684\u6700\u540e\u4e00\u4e2a\u6807\u7b7e</li> <li>digest\uff1a\u66f4\u65b0\u5230\u53ef\u53d8\u6807\u7b7e\u7684\u6700\u65b0\u63a8\u9001\u7248\u672c</li> </ul> </li> <li> <p>\u652f\u6301\u5e7f\u6cdb\u4f7f\u7528\u7684\u5bb9\u5668\u955c\u50cf\u4ed3\u5e93</p> </li> <li>\u901a\u8fc7\u914d\u7f6e\u652f\u6301\u79c1\u6709\u5bb9\u5668\u955c\u50cf\u4ed3\u5e93</li> <li>\u53ef\u4ee5\u5c06\u66f4\u6539\u5199\u56de Git</li> <li>\u80fd\u591f\u4f7f\u7528\u5339\u914d\u5668\u51fd\u6570\u8fc7\u6ee4\u955c\u50cf\u4ed3\u5e93\u8fd4\u56de\u7684\u6807\u7b7e\u5217\u8868</li> <li>\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u6216\u8005\u53ef\u4ee5\u4ece\u547d\u4ee4\u884c\u72ec\u7acb\u4f7f\u7528</li> <li>\u80fd\u591f\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7684\u5e76\u884c\u66f4\u65b0</li> </ul> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u4f7f\u7528\u8be5\u5de5\u5177\u76ee\u524d\u6709\u51e0\u4e2a\u9650\u5236\uff1a</p> <ul> <li>\u60f3\u8981\u66f4\u65b0\u5bb9\u5668\u955c\u50cf\u7684\u5e94\u7528\u7a0b\u5e8f\u5fc5\u987b\u4f7f\u7528 Argo CD \u8fdb\u884c\u7ba1\u7406\u3002\u4e0d\u652f\u6301\u672a\u4f7f\u7528 Argo CD \u7ba1\u7406\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002</li> <li>Argo CD \u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u53ea\u80fd\u66f4\u65b0\u5176\u6e05\u5355\u4f7f\u7528 Kustomize \u6216 Helm \u5448\u73b0\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u7279\u522b\u662f\u5728 Helm \u7684\u60c5\u51b5\u4e0b\uff0c\u6a21\u677f\u9700\u8981\u652f\u6301\u4f7f\u7528\u53c2\u6570\uff08\u5373<code>image.tag</code>\uff09\u3002</li> <li>\u955c\u50cf\u62c9\u53d6\u5bc6\u94a5\u5fc5\u987b\u5b58\u5728\u4e8e Argo CD Image Updater \u8fd0\u884c\uff08\u6216\u6709\u6743\u8bbf\u95ee\uff09\u7684\u540c\u4e00 Kubernetes \u96c6\u7fa4\u4e2d\u3002\u76ee\u524d\u65e0\u6cd5\u4ece\u5176\u4ed6\u96c6\u7fa4\u83b7\u53d6\u8fd9\u4e9b\u673a\u5bc6\u4fe1\u606f\u3002</li> </ul>"},{"location":"argo1/1argo2023_gitops/#_7","title":"\u5b89\u88c5","text":"<p>\u5efa\u8bae\u5728\u8fd0\u884c Argo CD \u7684\u540c\u4e00\u4e2a Kubernetes \u547d\u540d\u7a7a\u95f4\u96c6\u7fa4\u4e2d\u8fd0\u884c Argo CD Image Updater\uff0c\u4f46\u8fd9\u4e0d\u662f\u5fc5\u9700\u7684\u3002\u4e8b\u5b9e\u4e0a\uff0c\u751a\u81f3\u4e0d\u9700\u8981\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c Argo CD Image Updater \u6216\u6839\u672c\u4e0d\u9700\u8981\u8bbf\u95ee\u4efb\u4f55 Kubernetes \u96c6\u7fa4\u3002\u4f46\u5982\u679c\u4e0d\u8bbf\u95ee Kubernetes\uff0c\u67d0\u4e9b\u529f\u80fd\u53ef\u80fd\u65e0\u6cd5\u4f7f\u7528\uff0c\u6240\u4ee5\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528\u7b2c\u4e00\u79cd\u5b89\u88c5\u65b9\u6cd5\u3002</p> <p>\u8fd0\u884c\u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u7684\u6700\u76f4\u63a5\u65b9\u6cd5\u662f\u5c06\u5176\u4f5c\u4e3a Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u5b89\u88c5\u5230\u8fd0\u884c Argo CD \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u3002\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u4efb\u4f55\u914d\u7f6e\uff0c\u4e5f\u4e0d\u4f1a\u5bf9\u4f60\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ea7\u751f\u4efb\u4f55\u5f71\u54cd\u3002</p> <pre><code>kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/stable/manifests/install.yaml\n</code></pre> <p>Argo CD Image Updater \u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u53bb\u76d1\u542c\u955c\u50cf\u662f\u5426\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u800c\u4e0d\u9700\u8981\u5728 CI \u6d41\u6c34\u7ebf\u4e2d\u53bb\u624b\u52a8\u63d0\u4ea4\u4fee\u6539\u8d44\u6e90\u6e05\u5355\u5230\u4ee3\u7801\u4ed3\u5e93\u4e86\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5148\u53bb\u5220\u9664\u524d\u9762\u7684 app\uff1a</p> <pre><code>$ argocd app delete devops-demo --cascade\nAre you sure you want to delete 'devops-demo' and all its resources? [y/n] y\napplication 'devops-demo' deleted\n</code></pre> <p>\u7136\u540e\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Application \u5bf9\u8c61\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># demo-app2.yaml\napiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: devops-demo2\n  annotations:\n    argocd-image-updater.argoproj.io/image-list: myalias=cnych/devops-demo # Write repository name\n    argocd-image-updater.argoproj.io/myalias.allow-tags: regexp:^.*$\n    argocd-image-updater.argoproj.io/myalias.pull-secret: pullsecret:argocd/dockerhub-secret\n    argocd-image-updater.argoproj.io/myalias.update-strategy: latest # There are several ways to update the image, but I'm using digest.\n    argocd-image-updater.argoproj.io/write-back-method: git\n    argocd-image-updater.argoproj.io/git-branch: main\n    argocd-image-updater.argoproj.io/myalias.force-update: \"true\"\n  namespace: argocd\nspec:\n  destination:\n    namespace: argocd\n    server: https://kubernetes.default.svc\n  project: demo\n  source:\n    path: helm # \u4ece Helm \u5b58\u50a8\u5e93\u521b\u5efa\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0cchart \u5fc5\u987b\u6307\u5b9a path\n    repoURL: http://gitlab.k8s.local/cnych/k8s-devops-demo-config.git\n    targetRevision: main\n    helm:\n      parameters:\n        - name: replicaCount\n          value: \"2\"\n      valueFiles:\n        - my-values.yaml\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n    syncOptions:\n      - CreateNamespace=true\n</code></pre> <p>\u8fd9\u4e2a\u65b0\u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\uff0c\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e9b\u6ce8\u91ca\uff0c\u8fd9\u4e9b\u6ce8\u91ca\u7528\u4e8e\u914d\u7f6e Argo CD Image Updater\u3002</p> <p>\u8fd9\u4e9b\u914d\u7f6e\u7528\u4e8e\u6307\u5b9a\u81ea\u52a8\u66f4\u65b0\u5bb9\u5668\u955c\u50cf\u7684\u7b56\u7565\u3001\u53c2\u6570\u548c\u76f8\u5173\u4fe1\u606f\u3002\u4ee5\u4e0b\u662f\u5bf9\u8fd9\u4e9b\u6ce8\u91ca\u7684\u8be6\u7ec6\u89e3\u91ca\uff1a</p> <ul> <li><code>argocd-image-updater.argoproj.io/image-list</code>: \u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u5e94\u7528\u4e2d\u4f7f\u7528\u7684\u955c\u50cf\u5217\u8868\u3002</li> <li><code>argocd-image-updater.argoproj.io/allow-tags</code>: \u8fd9\u4e2a\u6ce8\u89e3\u6307\u5b9a\u4e86\u5141\u8bb8\u66f4\u65b0\u7684\u955c\u50cf\u6807\u7b7e\uff0c\u53ef\u4ee5\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u65b9\u5f0f\u3002-</li> <li><code>argocd-image-updater.argoproj.io/&lt;alias&gt;.pull-secret</code>: \u8fd9\u4e2a\u6ce8\u89e3\u6307\u5b9a\u4e86\u7528\u4e8e\u62c9\u53d6\u955c\u50cf\u7684 Secret\u3002</li> <li><code>argocd-image-updater.argoproj.io/update-strategy</code>: \u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u955c\u50cf\u66f4\u65b0\u7b56\u7565\u3002\u8fd9\u91cc\u7684\u503c\u662f latest\uff0c\u8868\u793a\u4f7f\u7528\u6700\u65b0\u7684\u955c\u50cf\u6807\u7b7e\u8fdb\u884c\u66f4\u65b0\uff0c\u8fd8\u53ef\u4ee5\u6307\u5b9a\u7684\u503c\u5305\u62ec\uff1adigest\u3001name\u3001semver\u3002</li> <li><code>argocd-image-updater.argoproj.io/write-back-method</code>: \u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u5199\u56de\u65b9\u6cd5\u3002git \u8868\u793a\u5c06\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u5199\u56de\u5230 Git \u4ed3\u5e93\u3002</li> <li><code>argocd-image-updater.argoproj.io/git-branch</code>\uff1a\u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u5199\u56de\u5230 Git \u4ed3\u5e93\u7684\u5206\u652f\u3002</li> </ul> <p>\u6ce8\u610f\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u4e86\u4e00\u4e2a pull-secret \u7684\u6ce8\u89e3\uff0c\u5982\u679c\u4f7f\u7528\u7684\u662f docker hub\uff0c\u9700\u8981\u5728\u4e2a\u4eba\u4e2d\u5fc3\u53bb\u521b\u5efa\u4e00\u4e2a access token\uff1a</p> <p></p> <p>\u7136\u540e\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a secret\uff1a</p> <pre><code>kubectl create -n argocd secret docker-registry dockerhub-secret \\\n  --docker-username xxxx \\\n  --docker-password xxxx \\\n  --docker-server \"https://registry-1.docker.io\"\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa\u8fd9\u4e2a\u5e94\u7528\u4e86\uff1a</p> <pre><code>$ kubectl apply -f demo-app2.yaml\n</code></pre> <p>\u521b\u5efa\u540e\u6b63\u5e38\u7b2c\u4e00\u6b21\u4f1a\u53bb\u540c\u6b65\u90e8\u7f72\u5e94\u7528\u3002\u7136\u540e\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u53bb\u4fee\u6539 Jenkins Pipeline \u7684\u6d41\u6c34\u7ebf\uff0c\u53ea\u9700\u8981\u4fdd\u7559\u5230\u955c\u50cf\u6784\u5efa\u7684\u90e8\u5206\u5373\u53ef\uff0c\u5176\u4ed6\u7684\u90e8\u5206\u90fd\u53ef\u4ee5\u53bb\u6389\u4e86\u3002</p> <pre><code>podTemplate(cloud: \"Kubernetes\", containers: [\n  containerTemplate(name: 'golang', image: 'golang:1.18.3-alpine3.16', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'docker', image: 'docker:latest', command: 'cat', ttyEnabled: true),\n  containerTemplate(name: 'kubectl', image: 'cnych/kubectl', command: 'cat', ttyEnabled: true)\n], serviceAccount: 'jenkins', envVars: [\n  envVar(key: 'DOCKER_HOST', value: 'tcp://docker-dind:2375')  // \u73af\u5883\u53d8\u91cf\n]) {\n  node(POD_LABEL) {\n    def myRepo = checkout scm\n    def gitCommit = myRepo.GIT_COMMIT\n    def gitBranch = myRepo.GIT_BRANCH\n\n    // \u83b7\u53d6 git commit id \u4f5c\u4e3a\u955c\u50cf\u6807\u7b7e\n    def imageTag = sh(script: \"git rev-parse --short HEAD\", returnStdout: true).trim()\n    // \u4ed3\u5e93\u5730\u5740\n    def registryUrl = \"docker.io\"\n    def imageEndpoint = \"cnych/devops-demo\"\n    // \u955c\u50cf\n    def image = \"${registryUrl}/${imageEndpoint}:${imageTag}\"\n\n    stage('\u5355\u5143\u6d4b\u8bd5') {\n      echo \"\u6d4b\u8bd5\u9636\u6bb5\"\n    }\n    stage('\u4ee3\u7801\u7f16\u8bd1\u6253\u5305') {\n        try {\n            container('golang') {\n            echo \"2.\u4ee3\u7801\u7f16\u8bd1\u6253\u5305\u9636\u6bb5\"\n            sh \"\"\"\n                export GOPROXY=https://goproxy.io\n                GOOS=linux GOARCH=amd64 go build -v -o demo-app\n                \"\"\"\n            }\n        } catch (exc) {\n            println \"\u6784\u5efa\u5931\u8d25 - ${currentBuild.fullDisplayName}\"\n            throw(exc)\n        }\n    }\n    stage('\u6784\u5efa Docker \u955c\u50cf') {\n        withCredentials([[$class: 'UsernamePasswordMultiBinding',\n            credentialsId: 'docker-auth',\n            usernameVariable: 'DOCKER_USER',\n            passwordVariable: 'DOCKER_PASSWORD']]) {\n            container('docker') {\n                echo \"3. \u6784\u5efa Docker \u955c\u50cf\u9636\u6bb5\"\n                sh \"\"\"\n                docker login ${registryUrl} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}\n                docker build -t ${image} .\n                docker push ${image}\n                \"\"\"\n            }\n        }\n    }\n}\n</code></pre> <p>\u91cd\u65b0\u63d0\u4ea4\u4e0a\u9762\u7684\u6d41\u6c34\u7ebf\u8fc7\u540e\uff0c\u6700\u7ec8\u6211\u4eec\u4f1a\u5c06\u5e94\u7528\u955c\u50cf\u63a8\u9001\u5230\u955c\u50cf\u4ed3\u5e93\u4e2d\u53bb\u3002</p> <p>\u7136\u540e Argo CD Image Updater \u5c06\u4f1a\u6bcf 2 \u5206\u949f\u4ece\u955c\u50cf\u4ed3\u5e93\u53bb\u68c0\u7d22\u955c\u50cf\u7248\u672c\u53d8\u5316\uff0c\u4e00\u65e6\u53d1\u73b0\u6709\u65b0\u7684\u955c\u50cf\u7248\u672c\uff0c\u5b83\u5c06\u81ea\u52a8\u4f7f\u7528\u65b0\u7248\u672c\u6765\u66f4\u65b0\u96c6\u7fa4\u5185\u5de5\u4f5c\u8d1f\u8f7d\u7684\u955c\u50cf\uff0c\u5e76\u5c06\u955c\u50cf\u7248\u672c\u56de\u5199\u5230 Git \u4ed3\u5e93\u91cd\u53bb\u3002\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b Argo CD Image Updater \u7684\u65e5\u5fd7\u53d8\u5316\uff1a</p> <pre><code>$ kubectl logs -f argocd-image-updater-56d94c674d-npgqp -n argocd\n# ......\ntime=\"2023-09-19T06:39:12Z\" level=info msg=\"Starting image update cycle, considering 1 annotated application(s) for update\"\ntime=\"2023-09-19T06:39:16Z\" level=info msg=\"Setting new image to cnych/devops-demo:a6268b3\" alias=myalias application=devops-demo2 image_name=cnych/devops-demo image_tag=739a588 registry=\ntime=\"2023-09-19T06:39:16Z\" level=info msg=\"Successfully updated image 'cnych/devops-demo:739a588' to 'cnych/devops-demo:a6268b3', but pending spec update (dry run=false)\" alias=myalias application=devops-demo2 image_name=cnych/devops-demo image_tag=739a588 registry=\ntime=\"2023-09-19T06:39:16Z\" level=info msg=\"Committing 1 parameter update(s) for application devops-demo2\" application=devops-demo2\ntime=\"2023-09-19T06:39:16Z\" level=info msg=\"Starting configmap/secret informers\"\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"Configmap/secret informer synced\"\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"Initializing http://gitlab.k8s.local/cnych/k8s-demo-config.git to /tmp/git-devops-demo23205764981\"\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"rm -rf /tmp/git-devops-demo23205764981\" dir= execID=14972\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"secrets informer cancelled\"\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"configmap informer cancelled\"\ntime=\"2023-09-19T06:39:17Z\" level=info msg=Trace args=\"[rm -rf /tmp/git-devops-demo23205764981]\" dir= operation_name=\"exec rm\" time_ms=4.474982\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"git fetch origin --tags --force\" dir=/tmp/git-devops-demo23205764981 execID=08213\ntime=\"2023-09-19T06:39:17Z\" level=info msg=Trace args=\"[git fetch origin --tags --force]\" dir=/tmp/git-devops-demo23205764981 operation_name=\"exec git\" time_ms=492.78976600000004\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"git config user.name argocd-image-updater\" dir=/tmp/git-devops-demo23205764981 execID=35e12\ntime=\"2023-09-19T06:39:17Z\" level=info msg=Trace args=\"[git config user.name argocd-image-updater]\" dir=/tmp/git-devops-demo23205764981 operation_name=\"exec git\" time_ms=1.4469750000000001\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"git config user.email noreply@argoproj.io\" dir=/tmp/git-devops-demo23205764981 execID=6515c\ntime=\"2023-09-19T06:39:17Z\" level=info msg=Trace args=\"[git config user.email noreply@argoproj.io]\" dir=/tmp/git-devops-demo23205764981 operation_name=\"exec git\" time_ms=1.593801\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"git checkout --force main\" dir=/tmp/git-devops-demo23205764981 execID=e5492\ntime=\"2023-09-19T06:39:17Z\" level=info msg=Trace args=\"[git checkout --force main]\" dir=/tmp/git-devops-demo23205764981 operation_name=\"exec git\" time_ms=5.05169\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"git clean -fdx\" dir=/tmp/git-devops-demo23205764981 execID=5cca4\ntime=\"2023-09-19T06:39:17Z\" level=info msg=Trace args=\"[git clean -fdx]\" dir=/tmp/git-devops-demo23205764981 operation_name=\"exec git\" time_ms=1.8230989999999998\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"git commit -a -F /tmp/image-updater-commit-msg2911699728\" dir=/tmp/git-devops-demo23205764981 execID=ac1b3\ntime=\"2023-09-19T06:39:17Z\" level=info msg=Trace args=\"[git commit -a -F /tmp/image-updater-commit-msg2911699728]\" dir=/tmp/git-devops-demo23205764981 operation_name=\"exec git\" time_ms=7.143674\ntime=\"2023-09-19T06:39:17Z\" level=info msg=\"git push origin main\" dir=/tmp/git-devops-demo23205764981 execID=136ad\ntime=\"2023-09-19T06:39:18Z\" level=info msg=Trace args=\"[git push origin main]\" dir=/tmp/git-devops-demo23205764981 operation_name=\"exec git\" time_ms=874.7453360000001\ntime=\"2023-09-19T06:39:18Z\" level=info msg=\"Successfully updated the live application spec\" application=devops-demo2\ntime=\"2023-09-19T06:39:18Z\" level=info msg=\"Processing results: applications=1 images_considered=1 images_skipped=0 images_updated=1 errors=0\"\ntime=\"2023-09-19T06:41:18Z\" level=info msg=\"Starting image update cycle, considering 1 annotated application(s) for update\"\ntime=\"2023-09-19T06:41:21Z\" level=info msg=\"Processing results: applications=1 images_considered=1 images_skipped=0 images_updated=0 errors=0\"\ntime=\"2023-09-19T06:43:21Z\" level=info msg=\"Starting image update cycle, considering 1 annotated application(s) for update\"\n# ......\n</code></pre> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u56de\u5199\u65f6\uff0cArgoCD Image Updater \u5e76\u4e0d\u4f1a\u76f4\u63a5\u4fee\u6539\u4ed3\u5e93\u7684 <code>values.yaml</code> \u6587\u4ef6\uff0c\u800c\u662f\u4f1a\u521b\u5efa\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u8986\u76d6 Helm Chart values.yaml \u7684 <code>.argocd-source-devops-demo2.yaml</code> \u6587\u4ef6\u3002</p> <p></p> <p>\u81ea\u52a8\u63d0\u4ea4\u53d8\u66f4\u540e\uff0cArgo CD \u5c31\u4f1a\u81ea\u52a8\u540c\u6b65\u90e8\u7f72\u5e94\u7528\u4e86\u3002</p> <p></p>"},{"location":"argo1/2Argo_Rollouts/","title":"2 \u4f7f\u7528 Argo Rollouts \u5b9e\u73b0\u5e94\u7528\u6e10\u8fdb\u5f0f\u53d1\u5e03","text":"<p>Argo Rollouts \u662f\u4e00\u4e2a Kubernetes Operator \u5b9e\u73b0\uff0c\u5b83\u4e3a Kubernetes \u63d0\u4f9b\u66f4\u52a0\u9ad8\u7ea7\u7684\u90e8\u7f72\u80fd\u529b\uff0c\u5982\u84dd\u7eff\u3001\u91d1\u4e1d\u96c0\u3001\u91d1\u4e1d\u96c0\u5206\u6790\u3001\u5b9e\u9a8c\u548c\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u529f\u80fd\uff0c\u4e3a\u4e91\u539f\u751f\u5e94\u7528\u548c\u670d\u52a1\u5b9e\u73b0\u81ea\u52a8\u5316\u3001\u57fa\u4e8e GitOps \u7684\u9010\u6b65\u4ea4\u4ed8\u3002</p> <p>\u652f\u6301\u5982\u4e0b\u7279\u6027\uff1a</p> <ul> <li>\u84dd\u7eff\u66f4\u65b0\u7b56\u7565</li> <li>\u91d1\u4e1d\u96c0\u66f4\u65b0\u7b56\u7565</li> <li>\u66f4\u52a0\u7ec6\u7c92\u5ea6\u3001\u52a0\u6743\u6d41\u91cf\u62c6\u5206</li> <li>\u81ea\u52a8\u56de\u6eda</li> <li>\u624b\u52a8\u5224\u65ad</li> <li>\u53ef\u5b9a\u5236\u7684\u6307\u6807\u67e5\u8be2\u548c\u4e1a\u52a1 KPI \u5206\u6790</li> <li>Ingress \u63a7\u5236\u5668\u96c6\u6210\uff1aNGINX\uff0cALB</li> <li>\u670d\u52a1\u7f51\u683c\u96c6\u6210\uff1aIstio\uff0cLinkerd\uff0cSMI</li> <li>Metrics \u6307\u6807\u96c6\u6210\uff1aPrometheus\u3001Wavefront\u3001Kayenta\u3001Web\u3001Kubernetes Jobs\u3001Datadog\u3001New Relic\u3001Graphite\u3001InfluxDB</li> </ul> <p>\u5b9e\u73b0\u539f\u7406</p> <p>\u4e0e Deployment \u5bf9\u8c61\u7c7b\u4f3c\uff0cArgo Rollouts \u63a7\u5236\u5668\u5c06\u7ba1\u7406 <code>ReplicaSets</code> \u7684\u521b\u5efa\u3001\u7f29\u653e\u548c\u5220\u9664\uff0c\u8fd9\u4e9b <code>ReplicaSet</code> \u7531 <code>Rollout</code> \u8d44\u6e90\u4e2d\u7684 <code>spec.template</code> \u5b9a\u4e49\uff0c\u4f7f\u7528\u4e0e <code>Deployment</code> \u5bf9\u8c61\u76f8\u540c\u7684 pod \u6a21\u677f\u3002</p> <p>\u5f53 <code>spec.template</code> \u53d8\u66f4\u65f6\uff0c\u8fd9\u4f1a\u5411 <code>Argo Rollouts</code> \u63a7\u5236\u5668\u53d1\u51fa\u4fe1\u53f7\uff0c\u8868\u793a\u5c06\u5f15\u5165\u65b0\u7684 <code>ReplicaSet</code>\uff0c\u63a7\u5236\u5668\u5c06\u4f7f\u7528 <code>spec.strategy</code> \u5b57\u6bb5\u5185\u7684\u7b56\u7565\u6765\u786e\u5b9a\u4ece\u65e7 <code>ReplicaSet</code> \u5230\u65b0 <code>ReplicaSet</code> \u7684 <code>rollout</code> \u5c06\u5982\u4f55\u8fdb\u884c\uff0c\u4e00\u65e6\u8fd9\u4e2a\u65b0\u7684 ReplicaSet \u88ab\u653e\u5927\uff08\u53ef\u4ee5\u9009\u62e9\u901a\u8fc7\u4e00\u4e2a Analysis\uff09\uff0c\u63a7\u5236\u5668\u4f1a\u5c06\u5176\u6807\u8bb0\u4e3a\u7a33\u5b9a\u3002</p> <p>\u5982\u679c\u5728 <code>spec.template</code> \u4ece\u7a33\u5b9a\u7684 <code>ReplicaSet</code> \u8fc7\u6e21\u5230\u65b0\u7684 <code>ReplicaSet</code> \u7684\u8fc7\u7a0b\u4e2d\u53d1\u751f\u4e86\u53e6\u4e00\u6b21\u53d8\u66f4\uff08\u5373\u5728\u53d1\u5e03\u8fc7\u7a0b\u4e2d\u66f4\u6539\u4e86\u5e94\u7528\u7a0b\u5e8f\u7248\u672c\uff09\uff0c\u90a3\u4e48\u4e4b\u524d\u7684\u65b0 <code>ReplicaSet</code> \u5c06\u7f29\u5c0f\uff0c\u5e76\u4e14\u63a7\u5236\u5668\u5c06\u5c1d\u8bd5\u53d1\u5e03\u53cd\u6620\u66f4\u65b0 <code>spec.template</code> \u5b57\u6bb5\u7684 <code>ReplicasSet</code>\u3002</p> <p></p>"},{"location":"argo1/2Argo_Rollouts/#_1","title":"\u76f8\u5173\u6982\u5ff5","text":"<p>\u5728\u7ee7\u7eed\u4e4b\u524d\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e00\u4e9b\u57fa\u672c\u7684\u6982\u5ff5\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#rollout","title":"Rollout(\u6eda\u52a8)","text":"<p>Rollout \u662f\u4e00\u4e2a Kubernetes \u7684 CRD \u8d44\u6e90\uff0c\u76f8\u5f53\u4e8e Kubernetes Deployment \u5bf9\u8c61\uff0c\u5728\u9700\u8981\u66f4\u9ad8\u7ea7\u7684\u90e8\u7f72\u6216\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u5b83\u65e8\u5728\u53d6\u4ee3 Deployment \u5bf9\u8c61\uff0cRollout \u63d0\u4f9b\u4e86 Kubernetes Deployment \u6240\u4e0d\u80fd\u63d0\u4f9b\u7684\u529f\u80fd\u3002</p> <ul> <li>\u84dd\u7eff\u90e8\u7f72</li> <li>\u91d1\u4e1d\u96c0\u90e8\u7f72</li> <li>\u4e0e Ingress \u63a7\u5236\u5668\u548c\u670d\u52a1\u7f51\u683c\u6574\u5408\uff0c\u5b9e\u73b0\u9ad8\u7ea7\u6d41\u91cf\u8def\u7531</li> <li>\u4e0e\u7528\u4e8e\u84dd\u7eff\u548c\u91d1\u4e1d\u96c0\u5206\u6790\u7684\u6307\u6807\u63d0\u4f9b\u8005\u96c6\u6210</li> <li>\u6839\u636e\u6210\u529f\u6216\u5931\u8d25\u7684\u6307\u6807\uff0c\u81ea\u52a8\u53d1\u5e03\u6216\u56de\u6eda</li> </ul> <p>\u6e10\u8fdb\u5f0f\u4ea4\u4ed8</p> <p>\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u662f\u4ee5\u53d7\u63a7\u548c\u6e10\u8fdb\u7684\u65b9\u5f0f\u53d1\u5e03\u4ea7\u54c1\u66f4\u65b0\u7684\u8fc7\u7a0b\uff0c\u4ece\u800c\u964d\u4f4e\u53d1\u5e03\u7684\u98ce\u9669\uff0c\u901a\u5e38\u5c06\u81ea\u52a8\u5316\u548c\u6307\u6807\u5206\u6790\u7ed3\u5408\u8d77\u6765\u4ee5\u9a71\u52a8\u66f4\u65b0\u7684\u81ea\u52a8\u5347\u7ea7\u6216\u56de\u6eda\u3002</p> <p></p> <p>\u90e8\u7f72\u7b56\u7565</p> <p>\u4e3a\u4e86\u660e\u786e Argo Rollouts \u7684\u884c\u4e3a\u65b9\u5f0f\uff0c\u4ee5\u4e0b\u662f Argo Rollouts \u63d0\u4f9b\u7684\u5404\u79cd\u90e8\u7f72\u7b56\u7565\u5b9e\u65bd\u7684\u63cf\u8ff0\u3002</p> <ul> <li>RollingUpdate(\u6eda\u52a8\u66f4\u65b0) \uff1a\u6162\u6162\u5730\u7528\u65b0\u7248\u672c\u66ff\u6362\u65e7\u7248\u672c\uff0c\u968f\u7740\u65b0\u7248\u672c\u7684\u51fa\u73b0\uff0c\u65e7\u7248\u672c\u4f1a\u6162\u6162\u7f29\u51cf\uff0c\u4ee5\u4fdd\u6301\u5e94\u7528\u7a0b\u5e8f\u7684\u603b\u6570\u91cf\u3002\u8fd9\u662f Deployment \u5bf9\u8c61\u7684\u9ed8\u8ba4\u7b56\u7565\u3002</li> <li>Recreate(\u91cd\u65b0\u521b\u5efa) \uff1aRecreate \u4f1a\u5728\u542f\u52a8\u65b0\u7248\u672c\u4e4b\u524d\u5220\u9664\u65e7\u7248\u672c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u8fd9\u53ef\u786e\u4fdd\u5e94\u7528\u7a0b\u5e8f\u7684\u4e24\u4e2a\u7248\u672c\u6c38\u8fdc\u4e0d\u4f1a\u540c\u65f6\u8fd0\u884c\uff0c\u4f46\u5728\u90e8\u7f72\u671f\u95f4\u4f1a\u51fa\u73b0\u505c\u673a\u65f6\u95f4\u3002</li> <li>Blue-Green(\u84dd\u7eff) \uff1a\u84dd\u7eff\u53d1\u5e03\u6307\u540c\u65f6\u90e8\u7f72\u4e86\u65b0\u65e7\u4e24\u4e2a\u7248\u672c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5728\u6b64\u671f\u95f4\uff0c\u53ea\u6709\u65e7\u7248\u672c\u7684\u5e94\u7528\u7a0b\u5e8f\u4f1a\u6536\u5230\u751f\u4ea7\u6d41\u91cf\uff0c\u8fd9\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u5728\u5c06\u5b9e\u65f6\u6d41\u91cf\u5207\u6362\u5230\u65b0\u7248\u672c\u4e4b\u524d\u9488\u5bf9\u65b0\u7248\u672c\u8fdb\u884c\u6d4b\u8bd5\u3002</li> </ul> <p></p> <p>Canary(\u91d1\u4e1d\u96c0) \uff1a\u91d1\u4e1d\u96c0\u53d1\u5e03\u6307\u5c06\u4e00\u90e8\u5206\u7528\u6237\u66b4\u9732\u5728\u65b0\u7248\u672c\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u800c\u5c06\u5176\u4f59\u6d41\u91cf\u63d0\u4f9b\u7ed9\u65e7\u7248\u672c\uff0c\u4e00\u65e6\u65b0\u7248\u672c\u88ab\u9a8c\u8bc1\u662f\u6b63\u786e\u7684\uff0c\u65b0\u7248\u672c\u53ef\u4ee5\u9010\u6e10\u53d6\u4ee3\u65e7\u7248\u672c\u3002Ingress \u63a7\u5236\u5668\u548c\u670d\u52a1\u7f51\u683c\uff0c\u5982 NGINX Ingress \u548c Istio\uff0c\u53ef\u4ee5\u4f7f\u91d1\u4e1d\u96c0\u7684\u6d41\u91cf\u62c6\u5206\u6a21\u5f0f\u6bd4\u539f\u751f\u7684\u66f4\u590d\u6742\uff08\u4f8b\u5982\uff0c\u5b9e\u73b0\u975e\u5e38\u7ec6\u7c92\u5ea6\u7684\u6d41\u91cf\u5206\u5272\uff0c\u6216\u57fa\u4e8e HTTP \u5934\u7684\u5206\u5272\uff09\u3002</p> <p></p> <p>\u4e0a\u56fe\u663e\u793a\u4e86\u4e00\u4e2a\u6709\u4e24\u4e2a\u9636\u6bb5\u7684\u91d1\u4e1d\u96c0\uff0810%\u548c 33%\u7684\u6d41\u91cf\u8fdb\u5165\u65b0\u7248\u672c\uff09\uff0c\u901a\u8fc7\u4f7f\u7528 Argo Rollouts\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u5b9e\u9645\u7684\u4f7f\u7528\u60c5\u51b5\u5b9a\u4e49\u786e\u5207\u7684\u9636\u6bb5\u6570\u548c\u6d41\u91cf\u767e\u5206\u6bd4\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#_2","title":"\u67b6\u6784","text":"<p>\u4e0b\u9762\u5c55\u793a\u4e86\u7531 Argo Rollouts \u7ba1\u7406\u7684 Deployment \u7684\u6240\u6709\u7ec4\u4ef6\u3002</p> <p></p>"},{"location":"argo1/2Argo_Rollouts/#rollout-controller","title":"Rollout Controller","text":"<p>\u8fd9\u662f\u4e3b\u63a7\u5236\u5668\uff0c\u7528\u4e8e\u76d1\u89c6\u96c6\u7fa4\u7684\u4e8b\u4ef6\u5e76\u5728 Rollout \u7c7b\u578b\u7684\u8d44\u6e90\u53d1\u751f\u66f4\u6539\u65f6\u505a\u51fa\u53cd\u5e94\u3002\u63a7\u5236\u5668\u5c06\u8bfb\u53d6 rollout \u7684\u6240\u6709\u8be6\u7ec6\u4fe1\u606f\uff0c\u5e76\u4f7f\u96c6\u7fa4\u5904\u4e8e rollout \u5b9a\u4e49\u4e2d\u63cf\u8ff0\u7684\u76f8\u540c\u72b6\u6001\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0cArgo Rollouts \u4e0d\u4f1a\u7be1\u6539\u6216\u54cd\u5e94\u6b63\u5e38 Deployment \u8d44\u6e90\u4e0a\u53d1\u751f\u7684\u4efb\u4f55\u53d8\u66f4\uff0c\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u5728\u4e00\u4e2a\u4f7f\u7528\u5176\u4ed6\u65b9\u6cd5\u90e8\u7f72\u5e94\u7528\u7684\u96c6\u7fa4\u4e2d\u5b89\u88c5 Argo Rollouts\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#rollout_1","title":"Rollout \u8d44\u6e90","text":"<p>Rollout \u8d44\u6e90\u662f Argo Rollouts \u5f15\u5165\u548c\u7ba1\u7406\u7684\u4e00\u79cd\u81ea\u5b9a\u4e49 Kubernetes \u8d44\u6e90\uff0c\u5b83\u4e0e\u539f\u751f\u7684 Kubernetes Deployment \u8d44\u6e90\u57fa\u672c\u517c\u5bb9\uff0c\u4f46\u6709\u989d\u5916\u7684\u5b57\u6bb5\u6765\u63a7\u5236\u66f4\u52a0\u9ad8\u7ea7\u7684\u90e8\u7f72\u65b9\u6cd5\uff0c\u5982\u91d1\u4e1d\u96c0\u548c\u84dd/\u7eff\u90e8\u7f72\u3002</p> <p>Argo Rollouts \u63a7\u5236\u5668\u5c06\u53ea\u5bf9 Rollout \u8d44\u6e90\u4e2d\u7684\u53d8\u5316\u505a\u51fa\u53cd\u5e94\uff0c\u4e0d\u4f1a\u5bf9\u6b63\u5e38\u7684 Deployment \u8d44\u6e90\u505a\u4efb\u4f55\u4e8b\u60c5\uff0c\u6240\u4ee5\u5982\u679c\u4f60\u60f3\u7528 Argo Rollouts \u7ba1\u7406\u4f60\u7684 Deployment\uff0c\u4f60\u9700\u8981\u5c06\u4f60\u7684 Deployment \u8fc1\u79fb\u5230 Rollouts\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#analysistemplate-analysisrun","title":"AnalysisTemplate \u4e0e AnalysisRun","text":"<p>Analysis \u662f\u4e00\u79cd\u81ea\u5b9a\u4e49 Kubernetes \u8d44\u6e90\uff0c\u5b83\u5c06 Rollout \u8fde\u63a5\u5230\u6307\u6807\u63d0\u4f9b\u7a0b\u5e8f\uff0c\u5e76\u4e3a\u67d0\u4e9b\u6307\u6807\u5b9a\u4e49\u7279\u5b9a\u9608\u503c\uff0c\u8fd9\u4e9b\u9608\u503c\u5c06\u51b3\u5b9a Rollout \u662f\u5426\u6210\u529f\u3002</p> <p>\u5bf9\u4e8e\u6bcf\u4e2a Analysis\uff0c\u4f60\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u6216\u591a\u4e2a\u6307\u6807\u67e5\u8be2\u53ca\u5176\u9884\u671f\u7ed3\u679c\uff0c\u5982\u679c\u6307\u6807\u67e5\u8be2\u6b63\u5e38\uff0c\u5219 Rollout \u5c06\u7ee7\u7eed\u53d1\u5e03\uff1b\u5982\u679c\u6307\u6807\u663e\u793a\u5931\u8d25\uff0c\u5219\u81ea\u52a8\u56de\u6eda\uff1b\u5982\u679c\u6307\u6807\u65e0\u6cd5\u63d0\u4f9b\u6210\u529f/\u5931\u8d25\u7684\u7ed3\u679c\uff0c\u5219\u6682\u505c\u53d1\u5e03\u3002</p> <p>\u4e3a\u4e86\u6267\u884c\u5206\u6790\uff0cArgo Rollouts \u63d0\u4f9b\u4e86\u4e24\u4e2a\u81ea\u5b9a\u4e49\u7684 Kubernetes \u8d44\u6e90\uff1aAnalysisTemplate \u548c AnalysisRun\u3002</p> <p>AnalysisTemplate \u5305\u542b\u6709\u5173\u8981\u67e5\u8be2\u54ea\u4e9b\u6307\u6807\u7684\u8bf4\u660e\u3002\u9644\u52a0\u5230 Rollout \u7684\u5b9e\u9645\u7ed3\u679c\u662f AnalysisRun \u81ea\u5b9a\u4e49\u8d44\u6e90\uff0c\u53ef\u4ee5\u5728\u7279\u5b9a \u7684 Rollout \u4e0a\u5b9a\u4e49 AnalysisTemplate\uff0c\u4e5f\u53ef\u4ee5\u5728\u96c6\u7fa4\u4e0a\u5b9a\u4e49\u5168\u5c40\u7684 AnalysisTemplate\uff0c\u4ee5\u4f9b\u591a\u4e2a Rollout \u5171\u4eab\u4f5c\u4e3a ClusterAnalysisTemplate\uff0c\u800c AnalysisRun \u8d44\u6e90\u7684\u8303\u56f4\u4ec5\u9650\u4e8e\u7279\u5b9a\u7684 rollout\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u5728 Rollout \u4e2d\u4f7f\u7528\u5206\u6790\u548c\u6307\u6807\u662f\u5b8c\u5168\u53ef\u9009\u7684\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7 API \u6216 CLI \u624b\u52a8\u6682\u505c\u548c\u7ee7\u7eed\u53d1\u5e03\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u5916\u90e8\u65b9\u6cd5\uff08\u4f8b\u5982\u5192\u70df\u6d4b\u8bd5\uff09\u3002\u4f60\u4e0d\u9700\u8981\u4ec5\u4f7f\u7528 Argo Rollouts \u7684\u6307\u6807\u89e3\u51b3\u65b9\u6848\uff0c\u4f60\u8fd8\u53ef\u4ee5\u5728 Rollout \u4e2d\u6df7\u5408\u81ea\u52a8\uff08\u5373\u57fa\u4e8e\u5206\u6790\uff09\u548c\u624b\u52a8\u6b65\u9aa4\u3002</p> <p>\u9664\u4e86\u6307\u6807\u4e4b\u5916\uff0c\u4f60\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c Kubernetes Job \u6216\u8fd0\u884c webhook \u6765\u51b3\u5b9a\u53d1\u5e03\u7684\u6210\u529f\u4e0e\u5426\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#metric-providers","title":"Metric Providers","text":"<p>Argo Rollouts \u5305\u62ec\u591a\u4e2a\u6d41\u884c\u6307\u6807\u63d0\u4f9b\u7a0b\u5e8f\u7684\u672c\u673a\u96c6\u6210\uff0c\u60a8\u53ef\u4ee5\u5728\u5206\u6790\u8d44\u6e90\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u63d0\u4f9b\u7a0b\u5e8f\u6765\u81ea\u52a8\u5347\u7ea7\u6216\u56de\u6eda\u90e8\u7f72\u3002\u6709\u5173\u7279\u5b9a\u8bbe\u7f6e\u9009\u9879\uff0c\u8bf7\u53c2\u9605\u6bcf\u4e2a\u63d0\u4f9b\u5546\u7684\u6587\u6863\u3002</p> <p>Argo Rollouts \u5305\u62ec\u51e0\u4e2a\u6d41\u884c\u7684\u6307\u6807\u63d0\u4f9b\u8005\u7684\u96c6\u6210\uff0c\u4f60\u53ef\u4ee5\u5728\u5206\u6790\u8d44\u6e90\u4e2d\u4f7f\u7528\uff0c\u6765\u81ea\u52a8\u5347\u7ea7\u6216\u56de\u6eda\u53d1\u5e03\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#_3","title":"\u5b89\u88c5","text":"<p>\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5b89\u88c5 Argo Rollouts\uff1a</p> <pre><code>$ kubectl create namespace argo-rollouts\n$ kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/download/v1.6.0/install.yaml\n</code></pre> <p>\u8fd9\u91cc\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a argo-rollouts \u7684\u547d\u540d\u7a7a\u95f4\uff0cArgo Rollouts \u63a7\u5236\u5668\u8fd0\u884c\u5728\u4e0a\u9762\u3002</p> <pre><code>$ kubectl get pods -n argo-rollouts\nNAME                            READY   STATUS    RESTARTS   AGE\nargo-rollouts-b9bbbc884-5h5jz   1/1     Running   0          7m21s\n\n$ kubectl get crd | grep argo\nanalysisruns.argoproj.io               2023-09-21T06:20:34Z\nanalysistemplates.argoproj.io          2023-09-21T06:20:34Z\nclusteranalysistemplates.argoproj.io   2023-09-21T06:20:34Z\nexperiments.argoproj.io                2023-09-21T06:20:35Z\nrollouts.argoproj.io    \n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5b89\u88c5\u4e00\u4e2a kubectl \u63d2\u4ef6\uff0c\u5bf9\u4e8e\u547d\u4ee4\u884c\u7ba1\u7406\u548c\u53ef\u89c6\u5316\u53d1\u5e03\u975e\u5e38\u65b9\u4fbf\u3002\u4f7f\u7528 curl \u5b89\u88c5 <code>Argo Rollouts kubectl</code> \u63d2\u4ef6\uff1a</p> <pre><code># https://ghproxy.com/https://github.com//argoproj/argo-rollouts/releases/download/v1.6.0/kubectl-argo-rollouts-linux-amd64\n$ curl -LO https://github.com/argoproj/argo-rollouts/releases/download/v1.6.0/kubectl-argo-rollouts-linux-amd64\n</code></pre> <p>\u7136\u540e\u8d4b\u4e88 kubectl-argo-rollouts \u4e8c\u8fdb\u5236\u6587\u4ef6\u53ef\u6267\u884c\u6743\u9650\uff1a</p> <pre><code>$ chmod +x ./kubectl-argo-rollouts-linux-amd64\n</code></pre> <p>\u5c06\u8be5\u4e8c\u8fdb\u5236\u6587\u4ef6\u79fb\u52a8\u5230\u4f60\u7684 PATH \u8def\u5f84\u4e0b\u9762\u53bb\uff1a</p> <pre><code>$ sudo mv ./kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts\n</code></pre> <p>\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u9a8c\u8bc1\u63d2\u4ef6\u662f\u5426\u5b89\u88c5\u6210\u529f\uff1a</p> <pre><code>$ kubectl argo rollouts version\nkubectl-argo-rollouts: v1.6.0+7eae71e\n  BuildDate: 2023-09-06T18:36:42Z\n  GitCommit: 7eae71ed89f1a3769864435bddebe3ca05384df3\n  GitTreeState: clean\n  GoVersion: go1.20.7\n  Compiler: gc\n  Platform: linux/amd64\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#_4","title":"\u91d1\u4e1d\u96c0\u53d1\u5e03","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7\u51e0\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u6765\u8bf4\u660e Rollout \u7684\u90e8\u7f72\u3001\u5347\u7ea7\u3001\u53d1\u5e03\u548c\u4e2d\u65ad\u7b49\u64cd\u4f5c\uff0c\u4ee5\u6b64\u6765\u5c55\u793a Rollouts \u7684\u5404\u79cd\u529f\u80fd\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#1-rollout","title":"1. \u90e8\u7f72 Rollout","text":"<p>\u9996\u5148\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a Rollout \u8d44\u6e90\u548c\u4e00\u4e2a\u9488\u5bf9\u8be5\u8d44\u6e90\u7684 Kubernetes Service \u5bf9\u8c61\uff0c\u8fd9\u91cc\u6211\u4eec\u793a\u4f8b\u4e2d\u7684 Rollout \u91c7\u7528\u4e86\u91d1\u4e1d\u96c0\u7684\u66f4\u65b0\u7b56\u7565\uff0c\u5c06 20% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u91d1\u4e1d\u96c0\u4e0a\uff0c\u7136\u540e\u624b\u52a8\u53d1\u5e03\uff0c\u6700\u540e\u5728\u5347\u7ea7\u7684\u5269\u4f59\u65f6\u95f4\u5185\u9010\u6e10\u81ea\u52a8\u589e\u5927\u6d41\u91cf\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u6240\u793a\u7684 Rollout \u6765\u63cf\u8ff0\u8fd9\u4e2a\u7b56\u7565\uff1a</p> <pre><code># basic-rollout.yaml\napiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: rollouts-demo\nspec:\n  replicas: 5 # \u5b9a\u4e495\u4e2a\u526f\u672c\n  strategy: # \u5b9a\u4e49\u5347\u7ea7\u7b56\u7565\n    canary: # \u91d1\u4e1d\u96c0\u53d1\u5e03\n      steps: # \u53d1\u5e03\u7684\u8282\u594f\n        - setWeight: 20\n        - pause: {} # \u4f1a\u4e00\u76f4\u6682\u505c\n        - setWeight: 40\n        - pause: { duration: 10 } # \u6682\u505c10s\n        - setWeight: 60\n        - pause: { duration: 10 }\n        - setWeight: 80\n        - pause: { duration: 10 }\n  revisionHistoryLimit: 2 # \u4e0b\u9762\u90e8\u5206\u5176\u5b9e\u662f\u548c Deployment \u517c\u5bb9\u7684\n  selector:\n    matchLabels:\n      app: rollouts-demo\n  template:\n    metadata:\n      labels:\n        app: rollouts-demo\n    spec:\n      containers:\n        - name: rollouts-demo\n          image: argoproj/rollouts-demo:blue\n          ports:\n            - name: http\n              containerPort: 8080\n              protocol: TCP\n          resources:\n            requests:\n              memory: 32Mi\n              cpu: 5m\n</code></pre> <p>\u8fd8\u5305\u62ec\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 Service \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code># basic-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: rollouts-demo\nspec:\n  ports:\n    - port: 80\n      targetPort: http\n      protocol: TCP\n      name: http\n  selector:\n    app: rollouts-demo\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f basic-rollout.yaml\n$ kubectl apply -f basic-service.yaml\n</code></pre> <p>\u4efb\u4f55 Rollout \u7684\u521d\u59cb\u521b\u5efa\u90fd\u4f1a\u7acb\u5373\u5c06\u526f\u672c\u6269\u5c55\u5230 100%\uff08\u8df3\u8fc7\u4efb\u4f55\u91d1\u4e1d\u96c0\u5347\u7ea7\u6b65\u9aa4\u3001\u5206\u6790\u7b49...\uff09\uff0c\u56e0\u4e3a\u8fd8\u6ca1\u6709\u53d1\u751f\u5347\u7ea7\u3002</p> <pre><code>$ kubectl get pods -l app=rollouts-demo\nNAME                             READY   STATUS    RESTARTS   AGE\nrollouts-demo-687d76d795-7xztq   1/1     Running   0          4m48s\nrollouts-demo-687d76d795-bnnwx   1/1     Running   0          4m48s\nrollouts-demo-687d76d795-dtlns   1/1     Running   0          4m48s\nrollouts-demo-687d76d795-q6867   1/1     Running   0          4m48s\nrollouts-demo-687d76d795-zlzdv   1/1     Running   0          4m48s\n</code></pre> <p>Argo Rollouts \u7684 kubectl \u63d2\u4ef6\u5141\u8bb8\u6211\u4eec\u53ef\u89c6\u5316 Rollout \u4ee5\u53ca\u76f8\u5173\u8d44\u6e90\u5bf9\u8c61\uff0c\u5e76\u5c55\u793a\u5b9e\u65f6\u72b6\u6001\u53d8\u5316\uff0c\u8981\u5728\u90e8\u7f72\u8fc7\u7a0b\u4e2d\u89c2\u5bdf Rollout\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c\u63d2\u4ef6\u7684 <code>get rollout --watch</code> \u547d\u4ee4\uff0c\u6bd4\u5982\uff1a</p> <pre><code>$ kubectl argo rollouts get rollout rollouts-demo --watch\n</code></pre> <p></p>"},{"location":"argo1/2Argo_Rollouts/#2-rollout","title":"2. \u66f4\u65b0 Rollout","text":"<p>\u4e0a\u9762\u5df2\u7ecf\u90e8\u7f72\u5b8c\u6210\uff0c\u63a5\u4e0b\u6765\u5c31\u9700\u8981\u6267\u884c\u66f4\u65b0\u4e86\uff0c\u548c Deployment \u7c7b\u4f3c\uff0c\u5bf9 Pod \u6a21\u677f\u5b57\u6bb5\u7684\u4efb\u4f55\u53d8\u66f4\u90fd\u4f1a\u5bfc\u81f4\u65b0\u7684\u7248\u672c\uff08\u5373 ReplicaSet\uff09\u88ab\u90e8\u7f72\uff0c\u66f4\u65b0 Rollout \u901a\u5e38\u662f\u4fee\u6539\u5bb9\u5668\u955c\u50cf\u7684\u7248\u672c\uff0c\u7136\u540e\u6267\u884c kubectl apply \uff0c\u4e3a\u4e86\u65b9\u4fbf\uff0crollouts \u63d2\u4ef6\u8fd8\u5355\u72ec\u63d0\u4f9b\u4e86\u4e00\u4e2a <code>set image</code> \u7684\u547d\u4ee4\uff0c\u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u8fd0\u884c\u4ee5\u4e0b\u6240\u793a\u547d\u4ee4\uff0c\u7528 yellow \u7248\u672c\u7684\u5bb9\u5668\u66f4\u65b0\u4e0a\u9762\u7684 <code>Rollout</code>\uff1a</p> <pre><code>$ kubectl argo rollouts set image rollouts-demo \\\n  rollouts-demo=argoproj/rollouts-demo:yellow\nrollout \"rollouts-demo\" image updated\n</code></pre> <p>\u5728 rollout \u66f4\u65b0\u671f\u95f4\uff0c\u63a7\u5236\u5668\u5c06\u901a\u8fc7 Rollout \u66f4\u65b0\u7b56\u7565\u4e2d\u5b9a\u4e49\u7684\u6b65\u9aa4\u8fdb\u884c\u3002\u8fd9\u4e2a\u793a\u4f8b\u7684 rollout \u4e3a\u91d1\u4e1d\u96c0\u8bbe\u7f6e\u4e86 20% \u7684\u6d41\u91cf\u6743\u91cd\uff0c\u5e76\u4e00\u76f4\u6682\u505c rollout\uff0c\u76f4\u5230\u7528\u6237\u53d6\u6d88\u6216\u4fc3\u8fdb\u53d1\u5e03\u3002</p> <p>\u5728\u66f4\u65b0\u955c\u50cf\u540e\uff0c\u518d\u6b21\u89c2\u5bdf rollout\uff0c\u76f4\u5230\u5b83\u8fbe\u5230\u6682\u505c\u72b6\u6001\u3002</p> <pre><code>$ kubectl argo rollouts get rollout rollouts-demo --watch\n</code></pre> <p></p> <p>\u5f53 demo rollout \u5230\u8fbe\u7b2c\u4e8c\u6b65\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u4ece\u63d2\u4ef6\u4e2d\u770b\u5230\uff0cRollout \u5904\u4e8e\u6682\u505c\u72b6\u6001\uff0c\u73b0\u5728\u6709 5 \u4e2a\u526f\u672c\u4e2d\u7684 1 \u4e2a\u8fd0\u884c\u65b0\u7248\u672c\u7684 pod\uff0c\u5176\u4f59 4 \u4e2a\u4ecd\u7136\u8fd0\u884c\u65e7\u7248\u672c\uff0c\u8fd9\u76f8\u5f53\u4e8e setWeight: 20 \u6b65\u9aa4\u6240\u5b9a\u4e49\u7684 20%\u7684\u91d1\u4e1d\u96c0\u6743\u91cd\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#3-promote-rollout","title":"3. Promote Rollout","text":"<p>\u7ecf\u8fc7\u4e0a\u9762\u7684\u66f4\u65b0\u540e\uff0cRollout \u73b0\u5728\u5904\u4e8e\u6682\u505c\u72b6\u6001\uff0c\u5f53\u4e00\u4e2a Rollout \u5230\u8fbe\u4e00\u4e2a\u6ca1\u6709\u6301\u7eed\u65f6\u95f4\u7684\u6682\u505c\u6b65\u9aa4\u65f6\uff0c\u5b83\u5c06\u4e00\u76f4\u4fdd\u6301\u5728\u6682\u505c\u72b6\u6001\uff0c\u76f4\u5230\u5b83\u88ab\u6062\u590d/\u7ee7\u7eed\u3002\u8981\u624b\u52a8\u5c06 Rollout \u5207\u6362\u5230\u4e0b\u4e00\u4e2a\u6b65\u9aa4\uff0c\u8bf7\u8fd0\u884c\u63d2\u4ef6\u7684 promotion \u547d\u4ee4\u3002</p> <pre><code>$ kubectl argo rollouts promote rollouts-demo\nrollout 'rollouts-demo' promoted\n</code></pre> <p>\u5207\u6362\u540e Rollout \u5c06\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u6b65\u9aa4\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u5269\u4f59\u7684\u6b65\u9aa4\u662f\u5b8c\u5168\u81ea\u52a8\u5316\u7684\uff0c\u6240\u4ee5 Rollout \u6700\u7ec8\u4f1a\u5b8c\u6210\u6b65\u9aa4\uff0c\u76f4\u5230\u5b83\u5df2\u7ecf\u5b8c\u5168\u8fc7\u6e21\u5230\u65b0\u7248\u672c\u3002</p> <p>\u518d\u6b21\u89c2\u5bdf Rollout\uff0c\u76f4\u5230\u5b83\u5b8c\u6210\u6240\u6709\u6b65\u9aa4\u3002</p> <pre><code>$ kubectl argo rollouts get rollout rollouts-demo --watch\n</code></pre> <p></p> <p>promote \u547d\u4ee4\u8fd8\u652f\u6301\u7528 --full \u6807\u5fd7\u8df3\u8fc7\u6240\u6709\u5269\u4f59\u6b65\u9aa4\u548c\u5206\u6790\u3002</p> <p>\u53ef\u4ee5\u770b\u5230 stable \u7248\u672c\u5df2\u7ecf\u5207\u6362\u5230 <code>revision:2</code> \u8fd9\u4e2a ReplicaSet \u4e86\u3002</p> <p>\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u65e0\u8bba\u4f55\u65f6\uff0c\u65e0\u8bba\u662f\u901a\u8fc7\u5931\u8d25\u7684\u91d1\u4e1d\u96c0\u5206\u6790\u81ea\u52a8\u4e2d\u6b62\uff0c\u8fd8\u662f\u7531\u7528\u6237\u624b\u52a8\u4e2d\u6b62\uff0cRollout \u90fd\u4f1a\u9000\u56de\u5230 stable \u7248\u672c\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#4-rollout","title":"4. \u4e2d\u65ad Rollout","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u5982\u4f55\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u624b\u52a8\u4e2d\u6b62 Rollout\uff0c\u9996\u5148\uff0c\u4f7f\u7528 set image \u547d\u4ee4\u90e8\u7f72\u4e00\u4e2a\u65b0\u7684 red \u7248\u672c\u7684\u5bb9\u5668\uff0c\u5e76\u7b49\u5f85 rollout \u518d\u6b21\u8fbe\u5230\u6682\u505c\u7684\u6b65\u9aa4\u3002</p> <pre><code>$ kubectl argo rollouts set image rollouts-demo \\\n  rollouts-demo=argoproj/rollouts-demo:red\nrollout \"rollouts-demo\" image updated\n</code></pre> <p>\u8fd9\u4e00\u6b21\u6211\u4eec\u5c06\u4e2d\u6b62\u66f4\u65b0\uff0c\u800c\u4e0d\u662f\u5c06\u6eda\u52a8\u5207\u6362\u5230\u4e0b\u4e00\u6b65\uff0c\u8fd9\u6837\u5b83\u5c31\u56de\u5230\u4e86 stable \u7248\u672c\uff0c\u8be5\u63d2\u4ef6\u540c\u6837\u63d0\u4f9b\u4e86\u4e00\u4e2a abort \u547d\u4ee4\uff0c\u53ef\u4ee5\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u7684\u4efb\u4f55\u65f6\u5019\u624b\u52a8\u4e2d\u6b62 Rollout\u3002</p> <pre><code>$ kubectl argo rollouts abort rollouts-demo\n</code></pre> <p>\u5f53\u4e2d\u6b62\u6eda\u52a8\u65f6\uff0c\u5b83\u5c06\u6269\u5927 ReplicaSet \u7684 stable \u7248\u672c\uff08\u5728\u672c\u4f8b\u4e2d\u662f yellow \u7248\u672c\uff09\uff0c\u5e76\u7f29\u5c0f\u4efb\u4f55\u5176\u4ed6\u7248\u672c\u3002</p> <p>\u5c3d\u7ba1 ReplicaSet \u7684\u7a33\u5b9a\u7248\u672c\u53ef\u80fd\u6b63\u5728\u8fd0\u884c\uff0c\u5e76\u4e14\u662f\u5065\u5eb7\u7684\uff0c\u4f46\u6574\u4e2a Rollout \u4ecd\u7136\u88ab\u8ba4\u4e3a\u662f\u9000\u5316\u7684\uff0c\u56e0\u4e3a\u671f\u671b\u7684\u7248\u672c\uff08red \u7248\u672c\uff09\u4e0d\u662f\u5b9e\u9645\u8fd0\u884c\u7684\u7248\u672c\u3002</p> <p></p> <p>\u4e3a\u4e86\u4f7f Rollout \u518d\u6b21\u88ab\u8ba4\u4e3a\u662f\u5065\u5eb7\u7684\u800c\u4e0d\u662f\u6709\u95ee\u9898\u7684\u7248\u672c\uff0c\u6709\u5fc5\u8981\u5c06\u6240\u9700\u7684\u72b6\u6001\u6539\u56de\u4ee5\u524d\u7684\u7a33\u5b9a\u7248\u672c\u3002\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u5730\u4f7f\u7528\u4e4b\u524d\u7684 yellow \u955c\u50cf\u91cd\u65b0\u8fd0\u884c set image \u547d\u4ee4\u5373\u53ef\u3002</p> <pre><code>$ kubectl argo rollouts set image rollouts-demo \\\n  rollouts-demo=argoproj/rollouts-demo:yellow\n</code></pre> <p>\u8fd0\u884c\u8fd9\u4e2a\u547d\u4ee4\u540e\uff0c\u53ef\u4ee5\u770b\u5230 Rollout \u7acb\u5373\u53d8\u6210\u4e86 health \u72b6\u6001\uff0c\u800c\u4e14\u6ca1\u6709\u4efb\u4f55\u5173\u4e8e\u521b\u5efa\u65b0 ReplicaSets \u7684\u52a8\u6001\u3002</p> <p></p> <p>\u5f53 Rollout \u8fd8\u6ca1\u6709\u8fbe\u5230\u9884\u671f\u72b6\u6001\uff08\u4f8b\u5982\u5b83\u88ab\u4e2d\u6b62\u4e86\uff0c\u6216\u8005\u6b63\u5728\u66f4\u65b0\u4e2d\uff09\uff0c\u800c\u7a33\u5b9a\u7248\u672c\u7684\u8d44\u6e90\u6e05\u5355\u88ab\u91cd\u65b0\u5e94\u7528\uff0cRollout \u68c0\u6d4b\u5230\u8fd9\u662f\u4e00\u4e2a\u56de\u6eda\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u66f4\u65b0\uff0c\u5e76\u5c06\u901a\u8fc7\u8df3\u8fc7\u5206\u6790\u548c\u6b65\u9aa4\u5feb\u901f\u90e8\u7f72\u7a33\u5b9a\u7684 ReplicaSet\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#argo-rollouts-nginx-ingress","title":"Argo Rollouts \u4e0e NGINX Ingress \u96c6\u6210","text":"<p>\u4e0a\u9762\u4f8b\u5b50\u4e2d\u7684 Rollout \u6ca1\u6709\u4f7f\u7528 Ingress \u63a7\u5236\u5668\u6216\u670d\u52a1\u7f51\u683c\u6765\u63a7\u5236\u6d41\u91cf\u3002</p> <p>\u5b83\u4f7f\u7528 Kubernetes Service \u6765\u5b9e\u73b0\u8fd1\u4f3c\u7684\u91d1\u4e1d\u96c0\u6743\u91cd\uff0c\u57fa\u4e8e\u65b0\u65e7\u526f\u672c\u6570\u91cf\u7684\u6bd4\u4f8b\u6765\u5b9e\u73b0\u3002</p> <p>\u6240\u4ee5\uff0c\u8fd9\u4e2a Rollout \u6709\u9650\u5236\uff0c\u4e3a\u4e86\u5b9e\u73b0\u66f4\u7ec6\u7c92\u5ea6\u7684\u91d1\u4e1d\u96c0\uff0c\u8fd9\u5c31\u9700\u8981\u4e00\u4e2a Ingress \u63a7\u5236\u5668\u6216\u670d\u52a1\u7f51\u683c\u4e86\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u4ecb\u7ecd\u4e0b Argo Rollouts \u5982\u4f55\u4e0e NGINX Ingress Controller \u96c6\u6210\u4ee5\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\u3002</p> <p>\u5f53\u7136\u9996\u5148\u8981\u4fdd\u8bc1\u5df2\u7ecf\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5\u4e86 ingress-nginx \u63a7\u5236\u5668\u3002\u5f53 NGINX Ingress \u7528\u4f5c\u6d41\u91cf\u8def\u7531\u5668\u65f6\uff0cRollout \u91d1\u4e1d\u96c0\u7b56\u7565\u5fc5\u987b\u5b9a\u4e49\u4ee5\u4e0b\u5f3a\u5236\u5b57\u6bb5\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: rollouts-demo\nspec:\n  strategy:\n    canary:\n      # \u5f15\u7528\u4e00\u4e2a Service\uff0c\u63a7\u5236\u5668\u5c06\u66f4\u65b0\u8be5\u670d\u52a1\u4ee5\u6307\u5411\u91d1\u4e1d\u96c0 ReplicaSet\n      canaryService: rollouts-demo-canary\n      # \u5f15\u7528\u4e00\u4e2a Service\uff0c\u63a7\u5236\u5668\u5c06\u66f4\u65b0\u8be5\u670d\u52a1\u4ee5\u6307\u5411\u7a33\u5b9a\u7684 ReplicaSet\n      stableService: rollouts-demo-stable\n      trafficRouting:\n        nginx:\n          # \u6307\u5411\u7a33\u5b9a Service \u7684\u89c4\u5219\u6240\u5f15\u7528\u7684 Ingress\n          # \u8be5 Ingress \u5c06\u88ab\u514b\u9686\u5e76\u8d4b\u4e88\u4e00\u4e2a\u65b0\u7684\u540d\u79f0\uff0c\u4ee5\u5b9e\u73b0NGINX\u6d41\u91cf\u5206\u5272\u3002\n          stableIngress: rollouts-demo-stable\n</code></pre> <p>\u5176\u4e2d <code>canary.trafficRouting.nginx.stableIngress</code> \u4e2d\u5f15\u7528\u7684 <code>Ingress</code> \u9700\u8981\u6709\u4e00\u4e2a host \u89c4\u5219\uff0c\u8be5\u89c4\u5219\u5177\u6709\u9488\u5bf9 <code>canary.stableService</code> \u4e0b\u5f15\u7528\u7684\u670d\u52a1\u7684\u540e\u7aef\u3002</p> <p>\u63a5\u4e0b\u6765\u6309\u7167\u4e0a\u9762\u7684\u63cf\u8ff0\u6765\u5b9a\u4e49\u6211\u4eec\u793a\u4f8b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code># rollout.yaml\napiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: rollouts-demo\nspec:\n  replicas: 1\n  strategy:\n    canary:\n      canaryService: rollouts-demo-canary\n      stableService: rollouts-demo-stable\n      trafficRouting:\n        nginx:\n          stableIngress: rollouts-demo-stable\n      steps:\n        - setWeight: 5\n        - pause: {}\n  revisionHistoryLimit: 2\n  selector:\n    matchLabels:\n      app: rollouts-demo\n  template:\n    metadata:\n      labels:\n        app: rollouts-demo\n    spec:\n      containers:\n        - name: rollouts-demo\n          image: argoproj/rollouts-demo:blue\n          ports:\n            - name: http\n              containerPort: 8080\n              protocol: TCP\n          resources:\n            requests:\n              memory: 32Mi\n              cpu: 5m\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a rollouts-demo \u7684 Rollout \u8d44\u6e90\uff0c\u5b83\u7684 canaryService \u548c stableService \u5206\u522b\u5f15\u7528\u4e86\u4e24\u4e2a Service \u8d44\u6e90\uff0c stableIngress \u5f15\u7528\u4e86\u4e00\u4e2a Ingress \u8d44\u6e90\uff0csteps \u5b9a\u4e49\u4e86\u91d1\u4e1d\u96c0\u53d1\u5e03\u7684\u6b65\u9aa4\uff0c</p> <p>\u8fd9\u91cc\u6211\u4eec\u5b9a\u4e49\u4e86\u4e24\u4e2a\u6b65\u9aa4\uff0c</p> <ul> <li>\u7b2c\u4e00\u4e2a\u6b65\u9aa4\u5c06\u6743\u91cd\u8bbe\u7f6e\u4e3a 5%\uff0c\u7b2c\u4e8c\u4e2a\u6b65\u9aa4\u662f\u6682\u505c\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5728\u7b2c\u4e00\u4e2a\u6b65\u9aa4\u4e2d\u5c06 5% \u7684\u6d41\u91cf\u53d1\u9001\u5230\u91d1\u4e1d\u96c0\u4e0a\uff0c\u7136\u540e\u624b\u52a8\u53d1\u5e03\uff0c\u6700\u540e\u5728\u5347\u7ea7\u7684\u5269\u4f59\u65f6\u95f4\u5185\u9010\u6e10\u81ea\u52a8\u589e\u5927\u6d41\u91cf\u3002</li> </ul> <p>\u5bf9\u5e94\u7684 Service \u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: rollouts-demo-canary\nspec:\n  ports:\n    - port: 80\n      targetPort: http\n      protocol: TCP\n      name: http\n  selector:\n    app: rollouts-demo\n    # \u8be5 selector \u5c06\u4f7f\u7528\u91d1\u4e1d\u96c0 ReplicaSet \u7684 pod-template-hash \u8fdb\u884c\u66f4\u65b0\uff0c\u6bd4\u5982 rollouts-pod-template-hash: 7bf84f9696\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: rollouts-demo-stable\nspec:\n  ports:\n    - port: 80\n      targetPort: http\n      protocol: TCP\n      name: http\n  selector:\n    app: rollouts-demo\n    # \u8be5 selector \u5c06\u4f7f\u7528\u7a33\u5b9a\u7248\u7684 ReplicaSet \u7684 pod-template-hash \u8fdb\u884c\u66f4\u65b0\uff0c\u6bd4\u5982 rollouts-pod-template-hash: 789746c88d\n</code></pre> <p>\u7136\u540e\u6700\u540e\u8fd8\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a Ingress \u5bf9\u8c61\uff1a</p> <pre><code># ingress.yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: rollouts-demo-stable\nspec:\n  ingressClassName: nginx\n  rules:\n    - host: rollouts-demo.local\n      http:\n        paths:\n          - path: /\n            pathType: Prefix\n            backend:\n              service:\n                # \u5f15\u7528\u670d\u52a1\u540d\u79f0\uff0c\u4e5f\u5728 Rollout spec.strategy.canary.stableService \u5b57\u6bb5\u4e2d\u6307\u5b9a\n                name: rollouts-demo-stable\n                port:\n                  number: 80\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5148\u5220\u9664\u524d\u9762\u793a\u4f8b\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl delete -f basic-rollout.yaml\n$ kubectl delete -f basic-service.yaml\n</code></pre> <p>\u7136\u540e\u518d\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f rollout.yaml\n$ kubectl apply -f service.yaml\n$ kubectl apply -f ingress.yaml\n</code></pre> <p>\u5e94\u7528\u6e05\u5355\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u96c6\u7fa4\u4e2d\u770b\u5230\u4ee5\u4e0b\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>\n$ kubectl get ro\nNAME            DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE\nrollouts-demo   1         1         1            1           69s\n$ kubectl get svc\nNAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE\nrollouts-demo-canary   ClusterIP   10.111.85.229    &lt;none&gt;        80/TCP    72s\nrollouts-demo-stable   ClusterIP   10.110.107.123   &lt;none&gt;        80/TCP    72s\n$ kubectl get ing\nNAME                                        CLASS   HOSTS                 ADDRESS   PORTS   AGE\nrollouts-demo-rollouts-demo-stable-canary   nginx   rollouts-demo.local             80      41s\nrollouts-demo-stable                        nginx   rollouts-demo.local             80      41s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u6ce8\u610f\u5230\u65b0\u589e\u4e86\u4e00\u4e2a\u540d\u4e3a <code>rollouts-demo-rollouts-demo-stable-canary</code> \u7684 Ingress \u5bf9\u8c61\u3002</p> <p>\u8fd9\u4e2a\u5bf9\u8c61\u662f <code>canary ingress</code>\uff0c\u5b83\u662f <code>nginx.stableIngress</code> \u4e0b\u5f15\u7528\u7684\u7528\u6237\u7ba1\u7406 <code>Ingress</code> \u7684\u514b\u9686\u3002 </p> <p>nginx ingress \u63a7\u5236\u5668\u4f7f\u7528\u5b83\u6765\u5b9e\u73b0\u91d1\u4e1d\u96c0\u6d41\u91cf\u5206\u5272\u3002\u751f\u6210\u7684\u5165\u53e3\u7684\u540d\u79f0\u662f\u4f7f\u7528 <code>&lt;ROLLOUT-NAME&gt;-&lt;INGRESS-NAME&gt;-canary</code> \u5236\u5b9a\u7684\u3002</p> <p>\u540c\u6837\u73b0\u5728\u4e5f\u53ef\u4ee5\u67e5\u770b Rollout \u5bf9\u8c61\u7684\u5177\u4f53\u72b6\u6001\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7\u66f4\u6539\u955c\u50cf\u7248\u672c\u6765\u66f4\u65b0\u53d1\u5e03\uff0c\u7136\u540e\u7b49\u5f85\u5b83\u8fbe\u5230\u6682\u505c\u72b6\u6001\u3002</p> <pre><code>$ kubectl argo rollouts set image rollouts-demo rollouts-demo=argoproj/rollouts-demo:yellow\nkubectl argo rollouts get rollout rollouts-demo\n</code></pre> <p></p> <p>\u6b64\u65f6\uff0cRollout \u7684\u91d1\u4e1d\u96c0\u7248\u548c\u7a33\u5b9a\u7248\u90fd\u5728\u8fd0\u884c\uff0c\u5176\u4e2d 5% \u7684\u6d41\u91cf\u8def\u7531\u5230\u91d1\u4e1d\u96c0\u7248\u3002\u9700\u8981\u6ce8\u610f\u7684\u4e00\u4ef6\u4e8b\u662f\uff0c\u5c3d\u7ba1\u53ea\u8fd0\u884c\u4e24\u4e2a pod\uff0c\u4f46\u6b64\u6b21\u53d1\u5e03\u4ecd\u80fd\u591f\u5b9e\u73b0 5% \u7684\u91d1\u4e1d\u96c0\u6743\u91cd\u3002\u8fd9\u662f\u80fd\u591f\u5b9e\u73b0\u7684\uff0c\u56e0\u4e3a\u6d41\u91cf\u5206\u5272\u53d1\u751f\u5728 Ingress \u63a7\u5236\u5668\u5904\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u8bbf\u95ee\u8be5 Demo \u6765\u5927\u81f4\u4e86\u89e3\uff1a</p> <p></p> <p>\u5f53\u68c0\u67e5 rollout \u63a7\u5236\u5668\u751f\u6210\u7684 Ingress \u526f\u672c\u65f6\uff0c\u6211\u4eec\u53d1\u73b0\u5b83\u6bd4\u539f\u59cb Ingress \u6709\u4ee5\u4e0b\u53d8\u5316\uff1a</p> <ul> <li>\u6ce8\u89e3\u4e2d\u6dfb\u52a0\u4e86\u4e24\u4e2a\u989d\u5916\u7684 NGINX \u7279\u5b9a\u91d1\u4e1d\u96c0\u6ce8\u89e3\u3002</li> <li>Ingress \u89c4\u5219\u5c06\u6709\u4e00\u6761\u5c06\u540e\u7aef\u6307\u5411\u91d1\u4e1d\u96c0\u670d\u52a1\u7684\u89c4\u5219\u3002</li> </ul> <p>\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"5\"\n  name: rollouts-demo-rollouts-demo-stable-canary\n  namespace: default\nspec:\n  ingressClassName: nginx\n  rules:\n    - host: rollouts-demo.local\n      http:\n        paths:\n          - backend:\n              service:\n                name: rollouts-demo-canary\n                port:\n                  number: 80\n            path: /\n            pathType: Prefix\n</code></pre> <p>\u968f\u7740 Rollout \u9010\u6b65\u8fdb\u884c\uff0c<code>canary-weight</code> \u6ce8\u89e3\u5c06\u8c03\u6574\u4ee5\u5339\u914d\u6b65\u9aa4\u7684\u5f53\u524d setWeight\u3002</p> <p>NGINX Ingress \u63a7\u5236\u5668\u68c0\u67e5\u539f\u59cb Ingress\u3001\u91d1\u4e1d\u96c0 Ingress \u548c\u91d1\u4e1d\u96c0\u6743\u91cd\u6ce8\u89e3\uff0c\u4ee5\u786e\u5b9a\u5728\u4e24\u4e2a\u5165\u53e3\u4e4b\u95f4\u5206\u914d\u7684\u6d41\u91cf\u767e\u5206\u6bd4\u3002NGINX Ingress \u5982\u4f55\u5b9e\u73b0\u91d1\u4e1d\u96c0\u6d41\u91cf\u5206\u5272\u5728 NGINX Ingress \u7ae0\u8282\u4e2d\u6211\u4eec\u5df2\u7ecf\u8be6\u7ec6\u8bb2\u89e3\u8fc7\u4e86\u3002</p> <p>\u6700\u540e\u6211\u4eec\u53ef\u4ee5\u6267\u884c promote \u547d\u4ee4\u6765\u5c06 Rollout \u63a8\u8fdb\u5230\u4e0b\u4e00\u4e2a\u6b65\u9aa4\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u91d1\u4e1d\u96c0\u53d1\u5e03\u3002</p> <pre><code>$ kubectl argo rollouts promote rollouts-demo\nrollout 'rollouts-demo' promoted\n</code></pre> <p>\u5f53\u7136\u6b64\u65f6\u5e94\u7528\u4f1a\u5168\u90e8\u5207\u6362\u5230 yellow \u7248\u672c\u7684\u5bb9\u5668\uff1a</p> <p></p>"},{"location":"argo1/2Argo_Rollouts/#dashboard","title":"Dashboard","text":"<p>Argo Rollouts Kubectl \u63d2\u4ef6\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u672c\u5730 Dashboard\uff0c\u6765\u53ef\u89c6\u5316\u4f60\u7684 Rollouts\u3002</p> <p>\u8981\u542f\u52a8\u8fd9\u4e2a Dashboard\uff0c\u9700\u8981\u5728\u5305\u542b Rollouts \u8d44\u6e90\u5bf9\u8c61\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c kubectl argo rollouts dashboard \u547d\u4ee4\uff0c\u7136\u540e\u8bbf\u95eelocalhost:3100 \u5373\u53ef\u3002</p> <p></p> <p>\u70b9\u51fb Rollout \u53ef\u4ee5\u8fdb\u884c\u8be6\u7ec6\u9875\u9762\uff0c\u5728\u8be6\u7ec6\u9875\u9762\u53ef\u4ee5\u770b\u5230 Rollout \u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u8fd8\u53ef\u4ee5\u76f4\u63a5\u5728 UI \u754c\u9762\u4e0a\u6267\u884c\u4e00\u4e9b\u5e38\u7528\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982\u91cd\u542f\u3001\u91cd\u542f\u3001\u4e2d\u65ad\u7b49\u3002</p> <p></p>"},{"location":"argo1/2Argo_Rollouts/#analysis","title":"Analysis \u548c\u6e10\u8fdb\u5f0f\u4ea4\u4e92","text":"<p>Argo Rollouts \u63d0\u4f9b\u4e86\u51e0\u79cd\u6267\u884c\u5206\u6790\u7684\u65b9\u6cd5\u6765\u63a8\u52a8\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\uff0c\u9996\u5148\u9700\u8981\u4e86\u89e3\u51e0\u4e2a CRD \u8d44\u6e90\uff1a</p> <ul> <li>Rollout\uff1aRollout \u662f Deployment \u8d44\u6e90\u7684\u76f4\u63a5\u66ff\u4ee3\u54c1\uff0c\u5b83\u63d0\u4f9b\u989d\u5916\u7684 blueGreen \u548c canary \u66f4\u65b0\u7b56\u7565\uff0c\u8fd9\u4e9b\u7b56\u7565\u53ef\u4ee5\u5728\u66f4\u65b0\u671f\u95f4\u521b\u5efa AnalysisRuns \u548c Experiments\uff0c\u53ef\u4ee5\u63a8\u8fdb\u66f4\u65b0\uff0c\u6216\u4e2d\u6b62\u66f4\u65b0\u3002</li> <li>Experiments\uff1aExperiments CRD \u5141\u8bb8\u7528\u6237\u4e34\u65f6\u8fd0\u884c\u4e00\u4e2a\u6216\u591a\u4e2a ReplicaSet\u3002<ul> <li>\u9664\u4e86\u8fd0\u884c\u4e34\u65f6 ReplicaSet \u4e4b\u5916\uff0cExperiments CRD \u8fd8\u53ef\u4ee5\u4e0e ReplicaSet \u4e00\u8d77\u542f\u52a8 AnalysisRuns\u3002\u901a\u5e38\uff0c\u8fd9\u4e9b AnalysisRun \u7528\u4e8e\u786e\u8ba4\u65b0\u7684 ReplicaSet \u662f\u5426\u6309\u9884\u671f\u8fd0\u884c\u3002</li> </ul> </li> <li>AnalysisTemplate\uff1aAnalysisTemplate \u662f\u4e00\u4e2a\u6a21\u677f\uff0c\u5b83\u5b9a\u4e49\u4e86\u5982\u4f55\u6267\u884c\u91d1\u4e1d\u96c0\u5206\u6790\uff0c\u4f8b\u5982\u5b83\u5e94\u8be5\u6267\u884c\u7684\u6307\u6807\u3001\u9891\u7387\u4ee5\u53ca\u88ab\u89c6\u4e3a\u6210\u529f\u6216\u5931\u8d25\u7684\u503c\uff0cAnalysisTemplate \u53ef\u4ee5\u7528\u8f93\u5165\u503c\u8fdb\u884c\u53c2\u6570\u5316\u3002</li> <li>ClusterAnalysisTemplate\uff1aClusterAnalysisTemplate \u548c AnalysisTemplate \u7c7b\u4f3c\uff0c\u4f46\u5b83\u662f\u5168\u5c40\u8303\u56f4\u5185\u7684\uff0c\u5b83\u53ef\u4ee5\u88ab\u6574\u4e2a\u96c6\u7fa4\u7684\u4efb\u4f55 Rollout \u4f7f\u7528\u3002</li> <li>AnalysisRun\uff1aAnalysisRun \u662f AnalysisTemplate \u7684\u5b9e\u4f8b\u5316\u3002<ul> <li>AnalysisRun \u5c31\u50cf Job \u4e00\u6837\uff0c\u5b83\u4eec\u6700\u7ec8\u4f1a\u5b8c\u6210\uff0c\u5b8c\u6210\u7684\u8fd0\u884c\u88ab\u8ba4\u4e3a\u662f\u6210\u529f\u7684\u3001\u5931\u8d25\u7684\u6216\u4e0d\u786e\u5b9a\u7684\uff0c\u8fd0\u884c\u7684\u7ed3\u679c\u5206\u522b\u5f71\u54cd Rollout \u7684\u66f4\u65b0\u662f\u5426\u7ee7\u7eed\u3001\u4e2d\u6b62\u6216\u6682\u505c\u3002</li> </ul> </li> </ul> <p></p>"},{"location":"argo1/2Argo_Rollouts/#_5","title":"\u540e\u53f0\u5206\u6790","text":"<p>\u91d1\u4e1d\u96c0\u6b63\u5728\u6267\u884c\u5176\u90e8\u7f72\u6b65\u9aa4\u65f6\uff0c\u5206\u6790\u53ef\u4ee5\u5728\u540e\u53f0\u8fd0\u884c\u3002</p> <p>\u4ee5\u4e0b\u793a\u4f8b\u662f\u6bcf 10 \u5206\u949f\u9010\u6e10\u5c06 Canary \u6743\u91cd\u589e\u52a0 20%\uff0c\u76f4\u5230\u8fbe\u5230 100%\u3002</p> <p>\u5728\u540e\u53f0\uff0c\u57fa\u4e8e\u540d\u4e3a success-rate \u7684 <code>AnalysisTemplate</code> \u542f\u52a8 <code>AnalysisRun</code>\uff0c<code>success-rate</code> \u6a21\u677f\u67e5\u8be2 Prometheus \u670d\u52a1\u5668\uff0c\u4ee5 5 \u5206\u949f\u95f4\u9694/\u6837\u672c\u6d4b\u91cf HTTP \u6210\u529f\u7387\uff0c\u5b83\u6ca1\u6709\u7ed3\u675f\u65f6\u95f4\uff0c\u4e00\u76f4\u6301\u7eed\u5230\u505c\u6b62\u6216\u5931\u8d25\u3002</p> <p>\u5982\u679c\u6d4b\u91cf\u5230\u7684\u6307\u6807\u5c0f\u4e8e 95%\uff0c\u5e76\u4e14\u6709\u4e09\u4e2a\u8fd9\u6837\u7684\u6d4b\u91cf\u503c\uff0c\u5219\u5206\u6790\u88ab\u89c6\u4e3a\u5931\u8d25\u3002</p> <p>\u5931\u8d25\u7684\u5206\u6790\u4f1a\u5bfc\u81f4 Rollout \u4e2d\u6b62\uff0c\u5c06 Canary \u6743\u91cd\u8bbe\u7f6e\u56de\u96f6\uff0c\u5e76\u4e14 Rollout \u5c06\u88ab\u89c6\u4e3a\u964d\u7ea7\u3002\u5426\u5219\uff0c\u5982\u679c Rollout \u5b8c\u6210\u5176\u6240\u6709 Canary \u6b65\u9aa4\uff0c\u5219\u8ba4\u4e3a rollout \u662f\u6210\u529f\u7684\uff0c\u5e76\u4e14\u63a7\u5236\u5668\u5c06\u505c\u6b62\u8fd0\u884c\u5206\u6790\u3002</p> <p>\u5982\u4e0b\u6240\u793a\u7684 Rollout \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: guestbook\nspec:\n  # ...\n  strategy:\n    canary:\n      analysis:\n        templates:\n          - templateName: success-rate\n        startingStep: 2 # \u5ef6\u8fdf\u5f00\u59cb\u5206\u6790\uff0c\u5230\u7b2c3\u6b65\u5f00\u59cb\n        args:\n          - name: service-name\n            value: guestbook-svc.default.svc.cluster.local\n      steps:\n        - setWeight: 20\n        - pause: { duration: 10m }\n        - setWeight: 40\n        - pause: { duration: 10m }\n        - setWeight: 60\n        - pause: { duration: 10m }\n        - setWeight: 80\n        - pause: { duration: 10m }\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u5f15\u7528\u4e86\u4e00\u4e2a success-rate \u7684\u6a21\u677f\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: AnalysisTemplate\nmetadata:\n  name: success-rate\nspec:\n  args:\n    - name: service-name\n  metrics:\n    - name: success-rate\n      interval: 5m\n      # NOTE: prometheus queries return results in the form of a vector.\n      # So it is common to access the index 0 of the returned array to obtain the value\n      successCondition: result[0] &gt;= 0.95\n      failureLimit: 3\n      provider:\n        prometheus:\n          address: http://prometheus.example.com:9090\n          query: |\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\",response_code!~\"5.*\"}[5m]\n            )) /\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\"}[5m]\n            ))\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#_6","title":"\u5185\u8054\u5206\u6790","text":"<p>\u5206\u6790\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u5185\u5d4c\u5206\u6790\u6b65\u9aa4\u6765\u6267\u884c\uff0c\u5f53\u5206\u6790\u4ee5\u5185\u8054\u65b9\u5f0f\u8fdb\u884c\u65f6\uff0c\u5728\u5230\u8fbe\u8be5\u6b65\u9aa4\u65f6\u542f\u52a8 AnalysisRun\uff0c\u5e76\u5728\u8fd0\u884c\u5b8c\u6210\u4e4b\u524d\u963b\u6b62\u5176\u63a8\u8fdb\u3002\u5206\u6790\u8fd0\u884c\u7684\u6210\u529f\u6216\u5931\u8d25\u51b3\u5b9a\u4e86\u90e8\u7f72\u662f\u7ee7\u7eed\u8fdb\u884c\u4e0b\u4e00\u6b65\uff0c\u8fd8\u662f\u5b8c\u5168\u4e2d\u6b62\u90e8\u7f72\u3002</p> <p>\u5982\u4e0b\u6240\u793a\u7684\u793a\u4f8b\u4e2d\u6211\u4eec\u5c06 Canary \u6743\u91cd\u8bbe\u7f6e\u4e3a 20%\uff0c\u6682\u505c 5 \u5206\u949f\uff0c\u7136\u540e\u8fd0\u884c\u5206\u6790\u3002\u5982\u679c\u5206\u6790\u6210\u529f\uff0c\u5219\u7ee7\u7eed\u63a8\u51fa\uff0c\u5426\u5219\u4e2d\u6b62\u3002</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: guestbook\nspec:\n  # ...\n  strategy:\n    canary:\n      steps:\n        - setWeight: 20\n        - pause: { duration: 5m }\n        - analysis:\n            templates:\n              - templateName: success-rate\n            args:\n              - name: service-name\n                value: guestbook-svc.default.svc.cluster.local\n</code></pre> <p>\u4e0a\u9762\u7684\u5bf9\u8c61\u4e2d\u6211\u4eec\u5c06 analysis \u4f5c\u4e3a\u4e00\u4e2a\u6b65\u9aa4\u5185\u8054\u5230\u4e86 Rollout \u6b65\u9aa4\u4e2d\uff0c\u5f53 20%\u6d41\u91cf\u6682\u505c 5 \u5206\u949f\u540e\uff0c\u5f00\u59cb\u6267\u884c success-rate \u8fd9\u4e2a\u5206\u6790\u6a21\u677f\u3002</p> <p>\u8fd9\u91cc AnalysisTemplate \u4e0e\u4e0a\u9762\u7684\u540e\u53f0\u5206\u6790\u4f8b\u5b50\u76f8\u540c\uff0c\u4f46\u7531\u4e8e\u6ca1\u6709\u6307\u5b9a\u95f4\u9694\u65f6\u95f4\uff0c\u5206\u6790\u5c06\u6267\u884c\u4e00\u6b21\u6d4b\u91cf\u5c31\u5b8c\u6210\u4e86\u3002</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: AnalysisTemplate\nmetadata:\n  name: success-rate\nspec:\n  args:\n    - name: service-name\n    - name: prometheus-port\n      value: 9090\n  metrics:\n    - name: success-rate\n      successCondition: result[0] &gt;= 0.95\n      provider:\n        prometheus:\n          address: \"http://prometheus.example.com:{{args.prometheus-port}}\"\n          query: |\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\",response_code!~\"5.*\"}[5m]\n            )) /\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\"}[5m]\n            ))\n</code></pre> <p>\u6b64\u5916\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a count \u548c interval \u5b57\u6bb5\uff0c\u53ef\u4ee5\u5728\u4e00\u4e2a\u8f83\u957f\u7684\u65f6\u95f4\u6bb5\u5185\u8fdb\u884c\u591a\u6b21\u6d4b\u91cf\u3002</p> <pre><code>\nmetrics:\n  - name: success-rate\n    successCondition: result[0] &gt;= 0.95\n    interval: 60s\n    count: 5\n    provider:\n      prometheus:\n        address: http://prometheus.example.com:9090\n        query: ...\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#_7","title":"\u591a\u4e2a\u6a21\u677f\u7684\u5206\u6790","text":"<p>Rollout \u5728\u6784\u5efa AnalysisRun \u65f6\u53ef\u4ee5\u5f15\u7528\u591a\u4e2a AnalysisTemplate\u3002</p> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u4ece\u591a\u4e2a AnalysisTemplate \u4e2d\u6765\u7ec4\u6210\u5206\u6790\uff0c\u5982\u679c\u5f15\u7528\u4e86\u591a\u4e2a\u6a21\u677f\uff0c\u90a3\u4e48\u63a7\u5236\u5668\u5c06\u628a\u8fd9\u4e9b\u6a21\u677f\u5408\u5e76\u5728\u4e00\u8d77\uff0c\u63a7\u5236\u5668\u4f1a\u7ed3\u5408\u6240\u6709\u6a21\u677f\u7684\u6307\u6807\u548c args \u5b57\u6bb5\u3002\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: guestbook\nspec:\n  # ...\n  strategy:\n    canary:\n      analysis:\n        templates:\n          - templateName: success-rate\n          - templateName: error-rate\n        args:\n          - name: service-name\n            value: guestbook-svc.default.svc.cluster.local\n---\napiVersion: argoproj.io/v1alpha1\nkind: AnalysisTemplate\nmetadata:\n  name: success-rate\nspec:\n  args:\n    - name: service-name\n  metrics:\n    - name: success-rate\n      interval: 5m\n      successCondition: result[0] &gt;= 0.95\n      failureLimit: 3\n      provider:\n        prometheus:\n          address: http://prometheus.example.com:9090\n          query: |\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\",response_code!~\"5.*\"}[5m]\n            )) /\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\"}[5m]\n            ))\n---\napiVersion: argoproj.io/v1alpha1\nkind: AnalysisTemplate\nmetadata:\n  name: error-rate\nspec:\n  args:\n    - name: service-name\n  metrics:\n    - name: error-rate\n      interval: 5m\n      successCondition: result[0] &lt;= 0.95\n      failureLimit: 3\n      provider:\n        prometheus:\n          address: http://prometheus.example.com:9090\n          query: |\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\",response_code=~\"5.*\"}[5m]\n            )) /\n            sum(irate(\n              istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\"}[5m]\n            ))\n</code></pre> <p>\u5f53\u6267\u884c\u7684\u5206\u6790\u7684\u65f6\u5019\uff0c\u63a7\u5236\u5668\u4f1a\u5c06\u4e0a\u9762\u7684 success-rate \u548c error-rate \u4e24\u4e2a\u6a21\u677f\u5408\u5e76\u5230\u4e00\u4e2a AnalysisRun \u5bf9\u8c61\u4e2d\u53bb\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u51fa\u73b0\u4ee5\u4e0b\u60c5\u51b5\uff0c\u63a7\u5236\u5668\u5728\u5408\u5e76\u6a21\u677f\u65f6\u5c06\u51fa\u9519\uff1a</p> <ul> <li>\u6a21\u677f\u4e2d\u7684\u591a\u4e2a\u6307\u6807\u5177\u6709\u76f8\u540c\u7684\u540d\u79f0</li> <li>\u4e24\u4e2a\u540c\u540d\u7684\u53c2\u6570\u90fd\u6709\u503c</li> </ul>"},{"location":"argo1/2Argo_Rollouts/#_8","title":"\u5206\u6790\u6a21\u677f\u53c2\u6570","text":"<p>AnalysisTemplates \u53ef\u4ee5\u58f0\u660e\u4e00\u7ec4\u53c2\u6570\uff0c\u8fd9\u4e9b\u53c2\u6570\u53ef\u4ee5\u7531 Rollouts \u4f20\u9012\u3002</p> <p>\u7136\u540e\uff0c\u8fd9\u4e9b\u53c2\u6570\u53ef\u4ee5\u50cf\u5728 metrics \u914d\u7f6e\u4e2d\u4e00\u6837\u4f7f\u7528\uff0c\u5e76\u5728 <code>AnalysisRun</code> \u521b\u5efa\u65f6\u88ab\u5b9e\u4f8b\u5316\uff0c\u53c2\u6570\u5360\u4f4d\u7b26\u88ab\u5b9a\u4e49\u4e3a <code>{{ args.&lt;name&gt; }}</code>\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: AnalysisTemplate\nmetadata:\n  name: args-example\nspec:\n  args:\n    # required\n    - name: service-name\n    - name: stable-hash\n    - name: latest-hash\n    # optional\n    - name: api-url\n      value: http://example/measure\n    # from secret\n    - name: api-token\n      valueFrom:\n        secretKeyRef:\n          name: token-secret\n          key: apiToken\n  metrics:\n    - name: webmetric\n      successCondition: result == 'true'\n      provider:\n        web:\n          # placeholders are resolved when an AnalysisRun is created\n          url: \"{{ args.api-url }}?service={{ args.service-name }}\"\n          headers:\n            - key: Authorization\n              value: \"Bearer {{ args.api-token }}\"\n          jsonPath: \"{$.results.ok}\"\n</code></pre> <p>\u5728\u521b\u5efa AnalysisRun \u65f6\uff0cRollout \u4e2d\u5b9a\u4e49\u7684\u53c2\u6570\u4e0e AnalysisTemplate \u7684\u53c2\u6570\u4f1a\u5408\u5e76\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: guestbook\nspec:\n---\nstrategy:\n  canary:\n    analysis:\n      templates:\n        - templateName: args-example\n      args:\n        # required value\n        - name: service-name\n          value: guestbook-svc.default.svc.cluster.local\n        # override default value\n        - name: api-url\n          value: http://other-api\n        # pod template hash from the stable ReplicaSet\n        - name: stable-hash\n          valueFrom:\n            podTemplateHashValue: Stable\n        # pod template hash from the latest ReplicaSet\n        - name: latest-hash\n          valueFrom:\n            podTemplateHashValue: Latest\n</code></pre> <p>\u6b64\u5916\u5206\u6790\u53c2\u6570\u4e5f\u652f\u6301 valueFrom\uff0c\u7528\u4e8e\u8bfb\u53d6 meta \u6570\u636e\u5e76\u5c06\u5176\u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9 AnalysisTemplate\uff0c\u5982\u4e0b\u4f8b\u5b50\u662f\u5f15\u7528\u5143\u6570\u636e\u4e2d\u7684 env \u548c region \u6807\u7b7e\uff0c\u5e76\u5c06\u5b83\u4eec\u4f20\u9012\u7ed9 AnalysisTemplate\u3002</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: guestbook\n  labels:\n    appType: demo-app\n    buildType: nginx-app\n    ...\n    env: dev\n    region: us-west-2\nspec:\n...\n  strategy:\n    canary:\n      analysis:\n        templates:\n        - templateName: args-example\n        args:\n        ...\n        - name: env\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.labels['env']\n        # region where this app is deployed\n        - name: region\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.labels['region']\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#_9","title":"\u84dd\u7eff\u9884\u53d1\u5e03\u5206\u6790","text":"<p>\u4f7f\u7528 BlueGreen \u7b56\u7565\u7684 Rollout \u53ef\u4ee5\u5728\u4f7f\u7528\u9884\u53d1\u5e03\u5c06\u6d41\u91cf\u5207\u6362\u5230\u65b0\u7248\u672c\u4e4b\u524d\u542f\u52a8\u4e00\u4e2a AnalysisRun\u3002\u5206\u6790\u8fd0\u884c\u7684\u6210\u529f\u6216\u5931\u8d25\u51b3\u5b9a Rollout \u662f\u5426\u5207\u6362\u6d41\u91cf\uff0c\u6216\u5b8c\u5168\u4e2d\u6b62 Rollout\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>kind: Rollout\nmetadata:\n  name: guestbook\nspec:\n---\nstrategy:\n  blueGreen:\n    activeService: active-svc\n    previewService: preview-svc\n    prePromotionAnalysis:\n      templates:\n        - templateName: smoke-tests\n      args:\n        - name: service-name\n          value: preview-svc.default.svc.cluster.local\n</code></pre> <p>\u4e0a\u9762\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\u4e00\u65e6\u65b0\u7684 ReplicaSet \u5b8c\u5168\u53ef\u7528\uff0cRollout \u4f1a\u521b\u5efa\u4e00\u4e2a\u9884\u53d1\u5e03\u7684 AnalysisRun\uff0cRollout \u4e0d\u4f1a\u5c06\u6d41\u91cf\u5207\u6362\u5230\u65b0\u7248\u672c\uff0c\u800c\u662f\u4f1a\u7b49\u5230\u5206\u6790\u8fd0\u884c\u6210\u529f\u5b8c\u6210\u3002</p> <p>\u6ce8\u610f\uff1a\u5982\u679c\u6307\u5b9a\u4e86 <code>autoPromotionSeconds</code> \u5b57\u6bb5\uff0c\u5e76\u4e14 Rollout \u5df2\u7ecf\u7b49\u5f85\u4e86 <code>auto promotion seconds</code> \u7684\u65f6\u95f4\uff0cRollout \u4f1a\u6807\u8bb0 AnalysisRun \u6210\u529f\uff0c\u5e76\u81ea\u52a8\u5c06\u6d41\u91cf\u5207\u6362\u5230\u65b0\u7248\u672c\u3002</p> <p>\u5982\u679c AnalysisRun \u5728\u6b64\u4e4b\u524d\u5b8c\u6210\uff0cRollout \u5c06\u4e0d\u4f1a\u521b\u5efa\u53e6\u4e00\u4e2a AnalysisRun\uff0c\u5e76\u7b49\u5f85 autoPromotionSeconds \u7684\u5269\u4f59\u65f6\u95f4\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#_10","title":"\u84dd\u7eff\u53d1\u5e03\u540e\u5206\u6790","text":"<p>\u4f7f\u7528 BlueGreen \u7b56\u7565\u7684 Rollout \u8fd8\u53ef\u4ee5\u5728\u6d41\u91cf\u5207\u6362\u5230\u65b0\u7248\u672c\u540e\u4f7f\u7528\u53d1\u5e03\u540e\u5206\u6790\u3002</p> <p>\u5982\u679c\u53d1\u5e03\u540e\u5206\u6790\u5931\u8d25\u6216\u51fa\u9519\uff0cRollout \u5219\u8fdb\u5165\u4e2d\u6b62\u72b6\u6001\uff0c\u5e76\u5c06\u6d41\u91cf\u5207\u6362\u56de\u4e4b\u524d\u7684\u7a33\u5b9a ReplicaSet\uff0c\u5f53\u540e\u5206\u6790\u6210\u529f\u65f6\uff0cRollout \u88ab\u8ba4\u4e3a\u662f\u5b8c\u5168\u53d1\u5e03\u72b6\u6001\uff0c\u65b0\u7684 ReplicaSet \u5c06\u88ab\u6807\u8bb0\u4e3a\u7a33\u5b9a\uff0c\u7136\u540e\u65e7\u7684 ReplicaSet \u5c06\u6839\u636e scaleDownDelaySeconds\uff08\u9ed8\u8ba4\u4e3a 30 \u79d2\uff09\u8fdb\u884c\u7f29\u51cf</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: guestbook\nspec:\n---\nstrategy:\n  blueGreen:\n    activeService: active-svc\n    previewService: preview-svc\n    scaleDownDelaySeconds: 600 # 10 minutes\n    postPromotionAnalysis:\n      templates:\n        - templateName: smoke-tests\n      args:\n        - name: service-name\n          value: preview-svc.default.svc.cluster.local\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#_11","title":"\u5931\u8d25\u6761\u4ef6","text":"<p>failureCondition \u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u5206\u6790\u8fd0\u884c\u5931\u8d25\uff0c\u4e0b\u9762\u7684\u4f8b\u5b50\u662f\u6bcf\u9694 5 \u5206\u949f\u6301\u7eed\u8f6e\u8be2 Prometheus \u670d\u52a1\u5668\u6765\u83b7\u5f97\u9519\u8bef\u603b\u6570\uff0c\u5982\u679c\u9047\u5230 10 \u4e2a\u6216\u66f4\u591a\u7684\u9519\u8bef\uff0c\u5219\u8ba4\u4e3a\u5206\u6790\u8fd0\u884c\u5931\u8d25\u3002</p> <pre><code>metrics:\n  - name: total-errors\n    interval: 5m\n    failureCondition: result[0] &gt;= 10\n    failureLimit: 3\n    provider:\n      prometheus:\n        address: http://prometheus.example.com:9090\n        query: |\n          sum(irate(\n            istio_requests_total{reporter=\"source\",destination_service=~\"{{args.service-name}}\",response_code~\"5.*\"}[5m]\n          ))\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#_12","title":"\u65e0\u7ed3\u679c\u7684\u8fd0\u884c","text":"<p>\u5206\u6790\u8fd0\u884c j \u7ed3\u679c\u4e5f\u53ef\u4ee5\u88ab\u8ba4\u4e3a\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u8fd9\u8868\u660e\u8fd0\u884c\u65e2\u4e0d\u6210\u529f\uff0c\u4e5f\u4e0d\u5931\u8d25\u3002\u65e0\u7ed3\u679c\u7684\u8fd0\u884c\u4f1a\u5bfc\u81f4\u53d1\u5e03\u5728\u5f53\u524d\u6b65\u9aa4\u4e0a\u6682\u505c\u3002</p> <p>\u8fd9\u65f6\u9700\u8981\u4eba\u5de5\u5e72\u9884\uff0c\u4ee5\u6062\u590d\u8fd0\u884c\uff0c\u6216\u4e2d\u6b62\u8fd0\u884c\u3002\u5f53\u4e00\u4e2a\u6307\u6807\u6ca1\u6709\u5b9a\u4e49\u6210\u529f\u6216\u5931\u8d25\u7684\u6761\u4ef6\u65f6\uff0c\u5206\u6790\u8fd0\u884c\u53ef\u80fd\u6210\u4e3a\u65e0\u7ed3\u679c\u7684\u4e00\u4e2a\u4f8b\u5b50\u3002</p> <pre><code>metrics:\n  - name: my-query\n    provider:\n      prometheus:\n        address: http://prometheus.example.com:9090\n        query: ...\n</code></pre> <p>\u6b64\u5916\u5f53\u540c\u65f6\u6307\u5b9a\u4e86\u6210\u529f\u548c\u5931\u8d25\u7684\u6761\u4ef6\uff0c\u4f46\u6d4b\u91cf\u503c\u6ca1\u6709\u6ee1\u8db3\u4efb\u4f55\u4e00\u4e2a\u6761\u4ef6\u65f6\uff0c\u4e5f\u53ef\u80fd\u53d1\u751f\u4e0d\u786e\u5b9a\u7684\u5206\u6790\u8fd0\u884c\u3002</p> <pre><code>metrics:\n  - name: success-rate\n    successCondition: result[0] &gt;= 0.90\n    failureCondition: result[0] &lt; 0.50\n    provider:\n      prometheus:\n        address: http://prometheus.example.com:9090\n        query: ...\n</code></pre> <p>\u4e0d\u786e\u5b9a\u7684\u5206\u6790\u8fd0\u884c\u7684\u4e00\u4e2a\u573a\u666f\u662f\u4f7f Argo Rollouts \u80fd\u591f\u81ea\u52a8\u6267\u884c\u5206\u6790\u8fd0\u884c\uff0c\u5e76\u6536\u96c6\u6d4b\u91cf\u7ed3\u679c\uff0c\u4f46\u4ecd\u7136\u5141\u8bb8\u6211\u4eec\u6765\u5224\u65ad\u51b3\u5b9a\u6d4b\u91cf\u503c\u662f\u5426\u53ef\u4ee5\u63a5\u53d7\uff0c\u5e76\u51b3\u5b9a\u7ee7\u7eed\u6216\u4e2d\u6b62\u3002</p>"},{"location":"argo1/2Argo_Rollouts/#_13","title":"\u5ef6\u8fdf\u5206\u6790\u8fd0\u884c","text":"<p>\u5982\u679c\u5206\u6790\u8fd0\u884c\u4e0d\u9700\u8981\u7acb\u5373\u5f00\u59cb\uff08\u5373\u7ed9\u6307\u6807\u63d0\u4f9b\u8005\u65f6\u95f4\u6765\u6536\u96c6\u91d1\u4e1d\u96c0\u7248\u672c\u7684\u6307\u6807\uff09\uff0c\u5206\u6790\u8fd0\u884c\u53ef\u4ee5\u5ef6\u8fdf\u7279\u5b9a\u7684\u6307\u6807\u5206\u6790\u3002\u6bcf\u4e2a\u6307\u6807\u53ef\u4ee5\u88ab\u914d\u7f6e\u4e3a\u6709\u4e0d\u540c\u7684\u5ef6\u8fdf\uff0c\u9664\u4e86\u7279\u5b9a\u6307\u6807\u7684\u5ef6\u8fdf\u4e4b\u5916\uff0c\u5177\u6709\u540e\u53f0\u5206\u6790\u7684\u53d1\u5e03\u53ef\u4ee5\u5ef6\u8fdf\u521b\u5efa\u5206\u6790\u8fd0\u884c\uff0c\u76f4\u5230\u8fbe\u5230\u67d0\u4e2a\u6b65\u9aa4\u4e3a\u6b62</p> <p>\u5982\u4e0b\u6240\u793a\u5ef6\u8fdf\u4e00\u4e2a\u6307\u5b9a\u7684\u5206\u6790\u6307\u6807:</p> <pre><code>metrics:\n  - name: success-rate\n    # Do not start this analysis until 5 minutes after the analysis run starts\n    initialDelay: 5m\n    successCondition: result[0] &gt;= 0.90\n    provider:\n      prometheus:\n        address: http://prometheus.example.com:9090\n        query: ...\n</code></pre> <p>\u5ef6\u8fdf\u5f00\u59cb\u540e\u53f0\u5206\u6790\u8fd0\u884c\uff0c\u76f4\u5230\u6b65\u9aa4 3\uff08\u8bbe\u5b9a\u91cd\u91cf 40%\uff09\u3002</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n  name: guestbook\nspec:\n  strategy:\n    canary:\n      analysis:\n        templates:\n          - templateName: success-rate\n        startingStep: 2\n      steps:\n        - setWeight: 20\n        - pause: { duration: 10m }\n        - setWeight: 40\n        - pause: { duration: 10m }\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#job-metrics","title":"Job Metrics","text":"<p>\u6b64\u5916 Kubernetes Job \u8fd8\u53ef\u7528\u4e8e\u8fd0\u884c\u5206\u6790\uff0c\u4f7f\u7528 Job \u65f6\uff0c\u5982\u679c Job \u5b8c\u6210\u4e14\u9000\u51fa\u4ee3\u7801\u4e3a\u96f6\uff0c\u5219\u6307\u6807\u88ab\u89c6\u4e3a\u6210\u529f\uff0c\u5426\u5219\u6307\u6807\u5931\u8d25\u3002</p> <pre><code>metrics:\n  - name: test\n    provider:\n      job:\n        metadata:\n          annotations:\n            foo: bar # annotations defined here will be copied to the Job object\n          labels:\n            foo: bar # labels defined here will be copied to the Job object\n        spec:\n          backoffLimit: 1\n          template:\n            spec:\n              containers:\n                - name: test\n                  image: my-image:latest\n                  command:\n                    [my-test-script, my-service.default.svc.cluster.local]\n              restartPolicy: Never\n</code></pre>"},{"location":"argo1/2Argo_Rollouts/#web-metrics","title":"Web Metrics","text":"<p>\u540c\u6837\u8fd8\u53ef\u4ee5\u9488\u5bf9\u67d0\u4e9b\u5916\u90e8\u670d\u52a1\u6267\u884c HTTP \u8bf7\u6c42\u6765\u83b7\u53d6\u6d4b\u91cf\u7ed3\u679c\u3002\u4e0b\u9762\u793a\u4f8b\u5411\u67d0\u4e2a URL \u53d1\u51fa HTTP GET \u8bf7\u6c42\u3002 Webhook \u54cd\u5e94\u5fc5\u987b\u8fd4\u56de JSON \u5185\u5bb9\u3002</p> <p>jsonPath \u8868\u8fbe\u5f0f\u7684\u7ed3\u679c\u5c06\u5206\u914d\u7ed9\u53ef\u5728 successCondition \u548c failureCondition \u8868\u8fbe\u5f0f\u4e2d\u5f15\u7528\u7684 result \u53d8\u91cf\u3002\u5982\u679c\u7701\u7565\uff0c\u5c06\u4f7f\u7528\u6574\u4e2a body \u4f5c\u4e3a\u7ed3\u679c\u53d8\u91cf\u3002</p> <pre><code>metrics:\n  - name: webmetric\n    successCondition: result == true\n    provider:\n      web:\n        url: \"http://my-server.com/api/v1/measurement?service={{ args.service-name }}\"\n        timeoutSeconds: 20 # defaults to 10 seconds\n        headers:\n          - key: Authorization\n            value: \"Bearer {{ args.api-token }}\"\n        jsonPath: \"{$.data.ok}\"\n</code></pre> <p>\u6bd4\u5982\u4e0b\u9762\u7684\u793a\u4f8b\u8868\u793a\u5982\u679c <code>data.ok</code> \u5b57\u6bb5\u4e3a\u771f\u4e14 <code>data.successPercent</code> \u5927\u4e8e <code>0.90</code>\uff0c\u6d4b\u91cf\u5c06\u662f\u6210\u529f\u7684\u3002</p> <pre><code>{ \"data\": { \"ok\": true, \"successPercent\": 0.95 } }\n</code></pre> <pre><code>\nmetrics:\n  - name: webmetric\n    successCondition: \"result.ok &amp;&amp; result.successPercent &gt;= 0.90\"\n    provider:\n      web:\n        url: \"http://my-server.com/api/v1/measurement?service={{ args.service-name }}\"\n        headers:\n          - key: Authorization\n            value: \"Bearer {{ args.api-token }}\"\n        jsonPath: \"{$.data}\"\n</code></pre> <p>\u5f53\u7136\u5173\u4e8e Argo Rollouts \u7684\u4f7f\u7528\u8fd8\u6709\u5f88\u591a\u7ec6\u8282\uff0c\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\uff1ahttps://argoproj.github.io/argo-rollouts/\u4ee5\u4e86\u89e3\u66f4\u591a\u3002</p>"},{"location":"argo1/3argo_dr/","title":"3 DevOps\u4e2d\u7684Argo CD \u2014 \u707e\u96be\u6062\u590d","text":""},{"location":"argo1/3argo_dr/#argo-cd","title":"\u4e3a\u4ec0\u4e48\u8981\u5bf9 Argo CD \u8fdb\u884c\u707e\u96be\u6062\u590d\uff1f","text":"<p>\u91cd\u8981\u7684\u662f\u8981\u4e86\u89e3 Argo CD \u4e0d\u76f4\u63a5\u4e0e\u4efb\u4f55\u6570\u636e\u5e93\u4ea4\u4e92\uff0c\u4ec5\u5229\u7528 Redis \u4f5c\u4e3a\u7f13\u5b58\u673a\u5236\uff0c\u4f7f\u5176\u770b\u8d77\u6765\u662f\u65e0\u72b6\u6001\u7684\u3002\u6b63\u5982\u6211\u4eec\u4e4b\u524d\u8ba8\u8bba\u7684\uff0c\u4e3b\u8981\u901a\u8fc7\u589e\u52a0\u6bcf\u4e2a\u90e8\u7f72\u7684\u526f\u672c\u6570\u91cf\u6765\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\u5b89\u88c5\u662f\u53ef\u80fd\u7684\u3002</p> <p>\u4f46\u662f\uff0cArgo CD \u786e\u5b9e\u4ee5\u5e94\u7528\u7a0b\u5e8f\u5b9a\u4e49\uff08\u4f8b\u5982 Git \u6e90\u548c\u76ee\u6807\u96c6\u7fa4\uff09\u3001\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u7684\u4fe1\u606f\u4ee5\u53ca\u8fde\u63a5\u5230\u79c1\u6709 Git \u6216 Helm \u5b58\u50a8\u5e93\u7684\u8be6\u7ec6\u4fe1\u606f\u7684\u5f62\u5f0f\u7ef4\u62a4\u72b6\u6001\u3002Argo CD \u7684\u6b64\u72b6\u6001\u4fe1\u606f\u5b58\u50a8\u5728 Kubernetes \u8d44\u6e90\u4e2d\u3002\u5176\u4e2d\u4e00\u4e9b\u662f\u672c\u673a\u529f\u80fd\uff0c\u4f8b\u5982\u8fde\u63a5\u8be6\u7ec6\u4fe1\u606f\u7684\u79d8\u5bc6\uff0c\u800c\u53e6\u4e00\u4e9b\u662f\u9488\u5bf9\u5e94\u7528\u7a0b\u5e8f\u548c\u5e94\u7528\u7a0b\u5e8f\u7ea6\u675f\u7684\u81ea\u5b9a\u4e49\u529f\u80fd\u3002</p> <p>\u4e0d\u53ef\u9884\u89c1\u7684\u60c5\u51b5\uff0c\u5305\u62ec\u5220\u9664 Kubernetes \u96c6\u7fa4\u6216 Argo CD \u547d\u540d\u7a7a\u95f4\u7b49\u4eba\u4e3a\u884c\u4e3a\uff0c\u6216\u8005\u4e91\u63d0\u4f9b\u5546\u7684\u590d\u6742\u60c5\u51b5\uff0c\u90fd\u53ef\u80fd\u5bfc\u81f4\u707e\u96be\u3002</p> <p>\u8fd8\u53ef\u80fd\u5b58\u5728\u9700\u8981\u5c06 Argo CD \u5b89\u88c5\u4ece\u4e00\u4e2a\u96c6\u7fa4\u8f6c\u79fb\u5230\u53e6\u4e00\u4e2a\u96c6\u7fa4\u7684\u60c5\u51b5\u3002\u6240\u4ee5Argo CD\u707e\u96be\u6062\u590d\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u6765\u8bf4\u662f\u5fc5\u8981\u7684\u3002</p> <p>\u53e6\u5916\uff0c\u8bf7\u8bb0\u4f4f\u5728 Argo CD \u4e2d\uff1a</p> <ul> <li>\u5e76\u975e\u6240\u6709\u5185\u5bb9\u90fd\u4f1a\u4fdd\u5b58\u5230 Git \u5b58\u50a8\u5e93\u4e2d\u3002</li> <li>\u4ece Git \u5b58\u50a8\u5e93\u91cd\u65b0\u521b\u5efa\u6240\u6709\u5185\u5bb9\u53ef\u80fd\u9700\u8981\u82b1\u8d39\u5927\u91cf\u65f6\u95f4\uff0c\u5c24\u5176\u662f\u5f53\u60a8\u6709\u5927\u91cf\u5e94\u7528\u7a0b\u5e8f\u65f6</li> </ul>"},{"location":"argo1/3argo_dr/#argo-cd_1","title":"\u4ec0\u4e48\u662f Argo CD \u707e\u96be\u6062\u590d\uff1f","text":"<p>Argo CD \u707e\u96be\u6062\u590d\u662f\u5728\u707e\u96be\u6027\u4e8b\u4ef6\u53d1\u751f\u540e\u6062\u590d Argo CD \u90e8\u7f72\u7684\u8fc7\u7a0b\uff0c\u4f8b\u5982\u4eba\u4e3a\u9519\u8bef\uff08\u4f8b\u5982\uff0c\u5220\u9664 Argo CD \u547d\u540d\u7a7a\u95f4\u6216 Kubernetes \u96c6\u7fa4\uff09\u3001\u8f6f\u4ef6\u9519\u8bef\u6216\u57fa\u7840\u8bbe\u65bd\u95ee\u9898\uff08\u4f8b\u5982\uff0c\u4e91\u63d0\u4f9b\u5546\u4e2d\u65ad\u6216\u6570\u636e\u4e2d\u5fc3\uff09\u5931\u8d25\uff09\u3002</p> <p>\u707e\u96be\u6062\u590d\u7684\u76ee\u7684\u662f\u4f7f\u60a8\u7684\u7cfb\u7edf\u6062\u590d\u5230\u6b63\u5e38\u8fd0\u884c\u72b6\u6001\uff0c\u540c\u65f6\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u505c\u673a\u65f6\u95f4\u548c\u6570\u636e\u4e22\u5931\u3002\u8fd9\u5305\u62ec\u6062\u590d\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u72b6\u6001\u3001\u6062\u590d Argo CD \u6570\u636e\u5e93\u4ee5\u53ca\u6062\u590d Git \u5b58\u50a8\u5e93\u548c Kubernetes \u96c6\u7fa4\u4e4b\u95f4\u7684\u540c\u6b65\u3002</p> <p>\u5b83\u901a\u5e38\u6d89\u53ca\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u5907\u4efd\uff1a\u5b9a\u671f\u5907\u4efd\u91cd\u8981\u6570\u636e\uff0c\u4f8b\u5982 Argo CD \u6570\u636e\u5e93\u548c Argo CD \u7528\u4e8e\u8fde\u63a5 Git \u5b58\u50a8\u5e93\u6216 Kubernetes \u96c6\u7fa4\u7684 Kubernetes Secrets\u3002\u5907\u4efd\u9891\u7387\u901a\u5e38\u53d6\u51b3\u4e8e\u60a8\u66f4\u6539\u5e94\u7528\u7a0b\u5e8f\u7684\u9891\u7387\u3002</li> <li>\u6062\u590d\uff1a\u5982\u679c\u53d1\u751f\u707e\u96be\uff0c\u60a8\u53ef\u4ee5\u4ece\u5907\u4efd\u6062\u590dArgo CD \u5b89\u88c5\u3002\u8fd9\u901a\u5e38\u6d89\u53ca\u521b\u5efa\u65b0\u7684 Argo CD \u5b9e\u4f8b\u5e76\u5c06\u5907\u4efd\u6570\u636e\u52a0\u8f7d\u5230\u5176\u4e2d\u3002 </li> <li>\u9a8c\u8bc1\uff1a\u6062\u590d\u540e\uff0c\u9a8c\u8bc1\u6062\u590d\u662f\u5426\u6210\u529f\u975e\u5e38\u91cd\u8981\u3002\u8fd9\u53ef\u80fd\u6d89\u53ca\u68c0\u67e5\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u5904\u4e8e\u6b63\u786e\u72b6\u6001\uff0c\u5e76\u4e14 Argo CD \u53ef\u4ee5\u6b63\u786e\u5730\u5c06\u6240\u9700\u72b6\u6001\u4ece Git \u540c\u6b65\u5230 Kubernetes \u96c6\u7fa4\u3002</li> </ul>"},{"location":"argo1/3argo_dr/#argocd-admin","title":"\u201cargocd admin\u201d\u547d\u4ee4","text":"<p>\u201cargocd admin\u201d\u547d\u4ee4\u5305\u542b\u4e00\u7ec4\u5bf9 Argo CD \u7ba1\u7406\u5458\u6709\u7528\u7684\u547d\u4ee4\uff0c\u5e76\u4e14\u9700\u8981\u76f4\u63a5 Kubernetes \u8bbf\u95ee\u3002</p> <p>\u8bed\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>$ argocd admin [flags] [commands]\n\nUsage:\n  argocd admin [flags]\n  argocd admin [command]\n\nAvailable Commands:\n  app              Manage applications configuration\n  cluster          Manage clusters configuration\n  dashboard        Starts Argo CD Web UI locally\n  export           Export all Argo CD data to stdout (default) or a file\n  import           Import Argo CD data from stdin (specify `-') or a file\n  initial-password Prints initial password to log in to Argo CD for the first time\n  notifications    Set of CLI commands that helps manage notifications settings\n  proj             Manage projects configuration\n  repo             Manage repositories configuration\n  settings         Provides set of commands for settings validation and troubleshooting\n</code></pre> <p>\u521b\u5efa\u5907\u4efd</p> <p>\u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u8fde\u63a5\u5230\u96c6\u7fa4\u5e76\u521b\u5efa\u5907\u4efd\u3002\u60a8\u5e94\u8be5\u8fde\u63a5\u5230\u5b89\u88c5\u4e86 Argo CD \u7684\u96c6\u7fa4\u3002</p> <p>\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u8fd9\u5c06\u6839\u636e\u5f53\u524d\u65e5\u671f\u548c\u65f6\u95f4\u521b\u5efa\u4e00\u4e2a\u5177\u6709\u81ea\u5b9a\u4e49\u540d\u79f0\u7684\u6587\u4ef6\uff1a</p> <pre><code>$ argocd admin export -n argocd &gt; argocd-backup-$(date +\"%Y-%m-%d_%H:%M\").yml\n\n$ ls -l\n-rw-rw-r-- 1 txu  txu  63010 Jun 14 20:18 argocd-backup-2023-06-14_20:18.yml\n</code></pre> <p>\u4e0b\u4e00\u6b65\uff0c\u60a8\u5e94\u8be5\u83b7\u53d6\u6b64\u5907\u4efd\u6587\u4ef6\u5e76\u5c06\u5176\u4fdd\u5b58\u5728\u4e91\u5b58\u50a8\u7cfb\u7edf\uff08\u4f8b\u5982 AWS S3\u3001Azure Blob \u6216 Google Cloud Storage\uff09\u4e0a\uff0c\u5bf9\u5176\u8fdb\u884c\u52a0\u5bc6\u5e76\u5236\u5b9a\u8bbf\u95ee\u7b56\u7565\u3002</p>"},{"location":"argo1/3argo_dr/#_1","title":"\u4ece\u5907\u4efd\u6062\u590d","text":"<p>\u6062\u590d\u5907\u4efd\u9700\u8981\u5728\u76ee\u6807\u96c6\u7fa4\u4e2d\u521d\u59cb\u5b89\u88c5 Argo CD\u3002\u5907\u4efd\u5305\u62ec\u5176\u914d\u7f6e\u4ee5\u53ca\u6240\u6709\u76f8\u5173\u7684 ConfigMap \u548c Secret\uff0c\u5176\u4e2d\u5e94\u5305\u542b\u521d\u59cb\u8bbe\u7f6e\u671f\u95f4\u6240\u505a\u7684\u6240\u6709\u4fee\u6539\u3002</p> <p>\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ argocd admin import - &lt; argocd-backup-2023-06-14_20:18.yml\n...\n/ConfigMap argocd-cm created\n/ConfigMap argocd-rbac-cm created\n/ConfigMap argocd-ssh-known-hosts-cm created\n/ConfigMap argocd-tls-certs-cm created\n/Secret argocd-secret created\n/Secret autopilot-secret created\nargoproj.io/AppProject default created\nargoproj.io/AppProject testing created\nargoproj.io/Application argo-cd created\nargoproj.io/Application autopilot-bootstrap created\nargoproj.io/Application cluster-resources-in-cluster created\nargoproj.io/Application root created\nargoproj.io/ApplicationSet cluster-resources created\nargoproj.io/ApplicationSet testing created\n</code></pre> <p>\u6062\u590d\u8fc7\u7a0b\u5b8c\u6210\u540e\uff0c\u60a8\u7684\u65b0\u5b89\u88c5\u5e94\u8be5\u590d\u5236\u5907\u4efd\u65f6\u7684\u72b6\u6001\uff0c\u5305\u62ec\u6240\u6709\u5e94\u7528\u7a0b\u5e8f\u3001\u96c6\u7fa4\u548c Git \u5b58\u50a8\u5e93\u3002</p> <p>\u5173\u952e\u533a\u522b\u5728\u4e8e Redis \u7f13\u5b58\u4e2d\u6ca1\u6709\u6570\u636e\u3002\u56e0\u6b64\uff0cArgo CD \u5c06\u9700\u8981\u5f00\u59cb\u91cd\u65b0\u5904\u7406 Git \u5b58\u50a8\u5e93\u4e2d\u7684\u6240\u6709\u6e05\u5355\uff0c\u8fd9\u6700\u521d\u53ef\u80fd\u4f1a\u5f71\u54cd\u7cfb\u7edf\u6027\u80fd\u3002\u7136\u800c\uff0c\u8fd9\u79cd\u60c5\u51b5\u5e94\u8be5\u4f1a\u5728\u51e0\u5206\u949f\u540e\u7a33\u5b9a\u4e0b\u6765\uff0c\u4f7f\u64cd\u4f5c\u6062\u590d\u5230\u6b63\u5e38\u72b6\u6001\u3002</p>"},{"location":"argo1/3argo_dr/#_2","title":"\u81ea\u52a8\u5316\u5907\u4efd\u8fc7\u7a0b","text":"<p>\u4e00\u65e6\u5b8c\u5168\u6d4b\u8bd5\u4e86\u5907\u4efd\u548c\u6062\u590d\u547d\u4ee4\uff0c\u60a8\u5c31\u5e94\u8be5\u5f00\u59cb\u81ea\u52a8\u5316\u5907\u4efd\u8fc7\u7a0b\u3002</p> <p>\u81ea\u52a8\u5316 Argo CD \u5907\u4efd\u8fc7\u7a0b\u53ef\u4ee5\u5e26\u6765\u663e\u7740\u7684\u597d\u5904\uff0c\u5c24\u5176\u662f\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff1a</p> <ul> <li> <p>\u4e00\u81f4\u6027\uff1a\u81ea\u52a8\u5316\u786e\u4fdd\u5907\u4efd\u8fc7\u7a0b\u6bcf\u6b21\u90fd\u4e00\u81f4\u6267\u884c\uff0c\u51cf\u5c11\u4eba\u4e3a\u9519\u8bef\u7684\u53ef\u80fd\u6027\u3002\u5b83\u8fd8\u4fdd\u8bc1\u5907\u4efd\u6240\u6709\u5fc5\u8981\u7684\u8d44\u6e90\u3002</p> </li> <li> <p>\u9891\u7387\uff1a\u53ef\u4ee5\u5b89\u6392\u81ea\u52a8\u5907\u4efd\u5b9a\u671f\u8fd0\u884c\uff0c\u786e\u4fdd\u60a8\u59cb\u7ec8\u62e5\u6709\u6700\u65b0\u7684\u5907\u4efd\u3002\u8fd9\u5bf9\u4e8e\u9891\u7e41\u53d1\u751f\u53d8\u5316\u7684\u6d3b\u8dc3\u73af\u5883\u5c24\u5176\u91cd\u8981\u3002</p> </li> <li> <p>\u6548\u7387\uff1a\u81ea\u52a8\u5907\u4efd\u8fc7\u7a0b\u6bd4\u624b\u52a8\u5907\u4efd\u8fc7\u7a0b\u9ad8\u6548\u5f97\u591a\uff0c\u53ef\u4ee5\u91ca\u653e\u4eba\u529b\u8d44\u6e90\u6765\u6267\u884c\u66f4\u590d\u6742\u7684\u4efb\u52a1\u3002</p> </li> <li> <p>\u901f\u5ea6\u548c\u6062\u590d\u65f6\u95f4\uff1a\u5f53\u707e\u96be\u53d1\u751f\u65f6\uff0c\u62e5\u6709\u4e00\u4e2a\u7ecf\u8fc7\u9a8c\u8bc1\u7684\u81ea\u52a8\u5316\u5907\u4efd\u8fc7\u7a0b\u53ef\u4ee5\u663e\u7740\u52a0\u5feb\u6062\u590d\u65f6\u95f4\uff0c\u4ece\u800c\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u505c\u673a\u65f6\u95f4\u3002</p> </li> </ul>"},{"location":"argo1/4argo_rollouts_ab/","title":"A/B\u6d4b\u8bd5: \u5982\u4f55\u4f7f\u7528Argo Rollouts \u8fdb\u884c\u6e10\u8fdb\u5f0f\u4ea4\u4ed8","text":"<p>\u4f20\u7edf\u4e0a\uff0c\u8f6f\u4ef6\u548c\u5e94\u7528\u7a0b\u5e8f\u5982\u679c\u5347\u7ea7\u51fa\u73b0\u4efb\u4f55\u95ee\u9898\uff0c\u5de5\u7a0b\u56e2\u961f\u65e0\u80fd\u4e3a\u529b\uff0c\u56e0\u4e3a\u5e94\u7528\u7a0b\u5e8f\u53d1\u5e03\u540e\u4ed6\u4eec\u51e0\u4e4e\u65e0\u6cd5\u63a7\u5236\u8be5\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>\u7136\u800c\uff0c\u968f\u7740\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7b56\u7565\u7684\u51fa\u73b0\uff0c\u56e2\u961f\u53ef\u4ee5\u66f4\u597d\u5730\u63a7\u5236\u4ed6\u4eec\u7684\u53d1\u5e03\u3002\u8fd9\u4f7f\u5f97\u4ed6\u4eec\u53ef\u4ee5\u66f4\u8f7b\u677e\u5730\u5feb\u901f\u56de\u6eda\u5230\u4ee5\u524d\u7684\u7248\u672c\uff0c\u4ee5\u9632\u51fa\u73b0\u95ee\u9898\u3002</p> <p>\u5927\u591a\u6570\u90e8\u7f72\u7b56\u7565\uff08\u4f8b\u5982 Canary \u548c Blue-Green\uff09\u5141\u8bb8\u6211\u4eec\u5feb\u901f\u56de\u6eda\u5e94\u7528\u7a0b\u5e8f\u7248\u672c\uff0c\u540c\u65f6\u7ef4\u62a4\u5e94\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u7248\u672c\u3002</p> <p>\u8c08\u5230\u591a\u4e2a\u7248\u672c\uff0c\u5176\u4e2d\u4e00\u4e2a\u7248\u672c\u6253\u5f00\u4e86\u4e00\u9879\u529f\u80fd\uff0c\u53e6\u4e00\u4e2a\u7248\u672c\u5219\u5173\u95ed\u4e86\u8be5\u529f\u80fd\u3002\u4f46\u662f\uff0c\u5728\u5c06\u5176\u53d1\u5e03\u7ed9\u66f4\u5927\u7684\u7fa4\u4f53\u4e4b\u524d\uff0c\u60a8\u5982\u4f55\u77e5\u9053\u54ea\u4e00\u4e2a\u66f4\u597d\u5462\uff1f</p> <p>\u5728\u8fd9\u7bc7\u535a\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u8ba8\u8bba A/B \u6d4b\u8bd5\uff0c\u5b83\u5141\u8bb8\u60a8\u5229\u7528\u6570\u636e\u6765\u5e2e\u52a9\u60a8\u786e\u5b9a\u54ea\u4e2a\u7248\u672c\u66f4\u597d\u3002\u6211\u4eec\u5c06\u4e86\u89e3\u4ec0\u4e48\u662f A/B \u6d4b\u8bd5\uff0c\u4e86\u89e3\u5176\u5728\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e2d\u7684\u4f5c\u7528\uff0c\u5e76\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u5c55\u793a A/B \u6d4b\u8bd5\u5982\u4f55\u4e0eArgo Rollouts\u914d\u5408\u4f7f\u7528\u3002</p>"},{"location":"argo1/4argo_rollouts_ab/#ab-101","title":"A/B \u6d4b\u8bd5 101","text":"<p>A/B \u6d4b\u8bd5\u662f\u4e00\u4e2a\u5bf9\u5e94\u7528\u7a0b\u5e8f\u7684\u4e24\u4e2a\u4e0d\u540c\u7248\u672c\u8fdb\u884c\u6bd4\u8f83\u548c\u8bc4\u4f30\u7684\u8fc7\u7a0b\uff0c\u4ee5\u786e\u5b9a\u54ea\u4e2a\u7248\u672c\u6027\u80fd\u66f4\u597d\u3002\u8fd9\u4e5f\u79f0\u4e3a\u5bf9\u6bd4\u6d4b\u8bd5\u3002\u4e0d\u540c\u7684\u7248\u672c\u4f1a\u663e\u793a\u7ed9\u4e0d\u540c\u7684\u7528\u6237\u7ec4\uff0c\u5e76\u901a\u8fc7\u6536\u96c6\u4e0d\u540c\u7684\u6307\u6807\u6765\u6267\u884c\u7edf\u8ba1\u5206\u6790\uff0c\u4ee5\u5e2e\u52a9\u786e\u5b9a\u54ea\u4e2a\u7248\u672c\u6027\u80fd\u66f4\u597d\u3002</p> <p>A/B \u6d4b\u8bd5\u6d41\u884c\u7684\u4e3b\u8981\u539f\u56e0\u4e4b\u4e00\u662f\u5b83\u5141\u8bb8\u56e2\u961f\u6839\u636e\u6570\u636e\u800c\u4e0d\u662f\u4ed6\u4eec\u7684\u610f\u89c1\u5bf9\u5176\u4ea7\u54c1\u8fdb\u884c\u66f4\u6539\u3002\u56e2\u961f\u53ef\u4ee5\u5bf9\u4ea7\u54c1\u6709\u4e00\u4e2a\u613f\u666f\uff0c\u4f46\u662f\uff0c\u7528\u6237\u7684\u53cd\u9988\u6709\u52a9\u4e8e\u5851\u9020\u4ea7\u54c1\u7684\u672a\u6765\u3002\u57fa\u4e8e\u6b64\u7c7b\u53cd\u9988\uff0c\u4ea7\u54c1\u53ef\u4ee5\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\u800c\u5f97\u5230\u6539\u8fdb\u3002</p> <p></p> <p>\u8fd9\u79cd\u65b9\u6cd5\u975e\u5e38\u6d41\u884c\uff0c\u7528\u4e8e\u8861\u91cf\u767b\u9646\u9875\u9762\u548c\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u3002\u4f7f\u7528 A/B \u6d4b\u8bd5\uff0c\u4ed6\u4eec\u4e0d\u4ec5\u80fd\u591f\u505a\u51fa\u8bbe\u8ba1\u51b3\u7b56\uff0c\u8fd8\u80fd\u4e86\u89e3\u5f71\u54cd\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u7684\u7528\u6237\u4f53\u9a8c\u3002\u6211\u4eec\u4e2d\u7684\u8bb8\u591a\u4eba\u53ef\u80fd\u5f88\u96be\u76f8\u4fe1\u6309\u94ae\u989c\u8272\u7684\u7b80\u5355\u6539\u53d8\u5c31\u80fd\u4f7f\u8f6c\u5316\u7387\u63d0\u9ad8 21%\u3002</p>"},{"location":"argo1/4argo_rollouts_ab/#ab","title":"\u4f7f\u7528 A/B \u6d4b\u8bd5\u7684\u6570\u636e\u9a71\u52a8\u6e10\u8fdb\u5f0f\u4ea4\u4ed8","text":"<p>\u5728\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u7684\u60c5\u51b5\u4e0b\uff0c\u60a8\u6709\u4e24\u4e2a\u4e0d\u540c\u7684\u90e8\u7f72\uff0c\u60a8\u53ef\u4ee5\u5728\u8fd9\u4e24\u4e2a\u90e8\u7f72\u4e0a\u8fd0\u884c\u6d4b\u8bd5\uff0c\u4ee5\u5e2e\u52a9\u60a8\u786e\u5b9a\u4e24\u4e2a\u7248\u672c\u4e2d\u54ea\u4e2a\u7248\u672c\u66f4\u597d\u3002\u5728\u51b3\u5b9a\u7ee7\u7eed\u8fdb\u884c\u54ea\u4e00\u4e2a\u4e4b\u524d\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e0d\u540c\u7248\u672c\u7684\u5e94\u7528\u7a0b\u5e8f\u542f\u52a8\u591a\u4e2a\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u5b9e\u9a8c\u3002</p> <p>\u60a8\u8fd0\u884c\u7684\u6d4b\u8bd5\u548c\u6536\u96c6\u7684\u6307\u6807\u5b8c\u5168\u53d6\u51b3\u4e8e\u60a8\u7684\u7528\u4f8b\u3002\u60a8\u53ef\u4ee5\u5bf9\u5e94\u7528\u7a0b\u5e8f\u7248\u672c\u672c\u8eab\u8fd0\u884c\u6d4b\u8bd5\uff0c\u6216\u4f7f\u7528\u5916\u90e8\u6307\u6807\u6765\u51b3\u5b9a\u6700\u7ec8\u7248\u672c\u3002</p> <p>\u56e2\u961f\u901a\u5e38\u4f7f\u7528\u5ef6\u8fdf\u3001\u70b9\u51fb\u7387\u548c\u8df3\u51fa\u7387\u7b49\u6307\u6807\u6765\u9009\u62e9\u5347\u7ea7\u5230\u751f\u4ea7\u7684\u7248\u672c\u3002</p> <p>\u5728\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e2d\u4f7f\u7528 A/B \u6d4b\u8bd5\u4e0d\u4ec5\u53ef\u4ee5\u4f7f\u60a8\u7684\u6d41\u7a0b\u66f4\u5177\u5f39\u6027\u548c\u5feb\u901f\uff0c\u8fd8\u53ef\u4ee5\u5e2e\u52a9\u60a8\u6839\u636e\u6570\u636e\u786e\u5b9a\u7528\u6237\u7684\u6700\u4f73\u4f53\u9a8c\u3002</p> <p>\u8ba9\u6211\u4eec\u770b\u770b\u5982\u4f55\u4f7f\u7528 Argo Rollouts \u8fdb\u884c\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e2d\u7684 A/B \u6d4b\u8bd5\u3002</p>"},{"location":"argo1/4argo_rollouts_ab/#argo-ab","title":"\u4f7f\u7528 Argo \u63a8\u51fa\u5b9e\u9a8c\u8fdb\u884c A/B \u6d4b\u8bd5","text":"<p>Argo Rollouts\u662f\u4e00\u4e2a Kubernetes \u63a7\u5236\u5668\u4ee5\u53ca\u4e00\u7ec4 CRD\uff0c\u53ef\u63d0\u4f9b\u9ad8\u7ea7\u90e8\u7f72\u7b56\u7565\uff0c\u4f8b\u5982 Canary\u3001Blue Green \u548c Experiments \u7b49\u3002</p> <p>\u5b83\u521b\u5efa\u7c7b\u4f3c\u4e8e\u90e8\u7f72\u7684ReplicaSet \u3002</p> <p>\u63a7\u5236\u5668\u6839\u636erollout \u5bf9\u8c61\u4e2d\u5b9a\u4e49\u7684spec.template\u7ba1\u7406\u8fd9\u4e9b ReplicaSet \u7684\u521b\u5efa\u548c\u5220\u9664\u3002</p> <p>Argo Rollouts Experiment \u662f\u4e00\u4e2a Kubernetes CRD\uff0c\u5b83\u5141\u8bb8\u6211\u4eec\u5bf9\u5e94\u7528\u7a0b\u5e8f\u6267\u884c A/B \u6d4b\u8bd5\u548c Kayenta \u5f0f\u5206\u6790\u3002Experiment\u7531\u4e09\u4e2a\u7ec4\u6210\u90e8\u5206\u7ec4\u6210\u3002\u8ba9\u6211\u4eec\u4e86\u89e3\u4e00\u4e0b\u8fd9\u4e9b\u662f\u4ec0\u4e48\uff1a</p> <ul> <li>Experiment\uff1a\u65e8\u5728\u5728 ReplicaSet \u4e0a\u8fd0\u884c\u4ee5\u8fdb\u884c\u5206\u6790\u3002Experiment\u53ef\u4ee5\u6309\u7167\u9884\u5b9a\u7684\u6301\u7eed\u65f6\u95f4\u6216\u65e0\u9650\u671f\u5730\u8fd0\u884c\u76f4\u81f3\u505c\u6b62\u3002\u5982\u679c\u672a\u6307\u5b9a\u6301\u7eed\u65f6\u95f4\uff0c\u5b83\u5c06\u65e0\u9650\u671f\u5730\u8fd0\u884c\uff0c\u76f4\u5230\u505c\u6b62\u6216\u76f4\u5230\u6240\u6709\u6807\u8bb0requiredForCompletion\u7684\u5206\u6790\u5b8c\u6210\u3002\u5728\u5185\u90e8\uff0c\u5b83\u8fd8\u5f15\u7528 AnalysisTemplate\u3002\u8fd9\u7528\u4e8e\u5e76\u884c\u521b\u5efa\u57fa\u7ebf\u548c\u91d1\u4e1d\u96c0\u90e8\u7f72\uff0c\u5e76\u6bd4\u8f83\u4e24\u8005\u751f\u6210\u7684\u6307\u6807\u4ee5\u51b3\u5b9a\u540e\u7eed\u6b65\u9aa4\u3002</li> <li>AnalysisTemplate\uff1a\u6b64\u6a21\u677f\u5b9a\u4e49\u5982\u4f55\u6267\u884c\u5206\u6790\u3002\u5b83\u5305\u62ec\u9891\u7387\u3001\u6301\u7eed\u65f6\u95f4\u548c\u6210\u529f/\u5931\u8d25\u503c\u7b49\u8be6\u7ec6\u4fe1\u606f\uff0c\u7528\u4e8e\u786e\u5b9a\u5b9e\u9a8c\u662f\u6210\u529f\u8fd8\u662f\u5931\u8d25\u3002</li> <li>AnalysisRun\uff1a\u8fd9\u4e9b\u662f\u6839\u636e AnalysisTemplate \u4e2d\u63d0\u4f9b\u7684\u8be6\u7ec6\u4fe1\u606f\u8fd0\u884c\u7684\u4f5c\u4e1a\u3002\u5b83\u4eec\u88ab\u5206\u7c7b\u4e3a\u6210\u529f\u3001\u5931\u8d25\u6216\u4e0d\u786e\u5b9a\uff0c\u6839\u636e\u8fd9\u4e9b\u6765\u51b3\u5b9aRollout\u7684\u66f4\u65b0\u3002\u56e0\u6b64\uff0c\u4ec5\u5f53 AnalysisRun \u6210\u529f\u65f6\uff0c\u90e8\u7f72\u624d\u4f1a\u7ee7\u7eed\u3002</li> </ul> <p></p> <p>Experiment\u53ef\u4ee5\u72ec\u7acb\u8fd0\u884c\u3001\u4f5c\u4e3a\u90e8\u7f72\u7684\u4e00\u90e8\u5206\u6216\u4e0e\u6d41\u91cf\u8def\u7531\u4e00\u8d77\u8fd0\u884c\u3002\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u8ba8\u8bba\u5982\u4f55\u4f7f\u7528 Argo Rollouts Experiment\u8fdb\u884c\u91d1\u4e1d\u96c0\u90e8\u7f72\u3002</p> <p>\u4ee5\u4e0b\u662f Argo Rollouts Experiment\u5982\u4f55\u4e0e\u91d1\u4e1d\u96c0\u63a8\u51fa\u914d\u5408\u4f7f\u7528\uff1a</p> <ul> <li>\u526f\u672c\u96c6\u88ab\u521b\u5efa\uff0c\u4e00\u65e6\u5b83\u4eec\u8fbe\u5230\u5b8c\u5168\u53ef\u7528\u6027\uff0cExperiment\u5c31\u4f1a\u5f00\u59cb\u5e76\u5f88\u5feb\u8fdb\u5165\u8fd0\u884c\u72b6\u6001\u3002</li> <li>\u5f53Experiment\u8fd0\u884c\u65f6\uff0c\u5b83\u4f1a\u6839\u636e AnalysisTemplate \u4e2d\u63d0\u4f9b\u7684\u8be6\u7ec6\u4fe1\u606f\u542f\u52a8 AnalysisRun\u3002</li> <li>\u5982\u679c\u6307\u5b9a\u4e86\u6301\u7eed\u65f6\u95f4\uff0c\u5219Experiment\u5c06\u5728\u5b8c\u6210\u4e4b\u524d\u6301\u7eed\u8fd0\u884c\u3002</li> <li>\u5982\u679c AnalysisRun \u6210\u529f\uff0c\u5219Experiment\u6210\u529f\u5e76\u4e14\u90e8\u7f72\u5c06\u7ee7\u7eed\uff0c\u5982\u679c\u5931\u8d25\uff0c\u5219\u90e8\u7f72\u4e0d\u4f1a\u53d1\u751f\u3002</li> <li>\u4e00\u65e6 AnalysisRun \u5b8c\u6210\u5e76\u4e14Experiment\u7ed3\u675f\uff0cReplicaSets \u5c06\u7f29\u653e\u4e3a\u96f6\u3002</li> </ul>"},{"location":"argo1/4argo_rollouts_ab/#argo-rollouts","title":"Argo Rollouts \u91d1\u4e1d\u96c0\u90e8\u7f72","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528\u5e26\u6709\u91d1\u4e1d\u96c0\u90e8\u7f72\u7b56\u7565\u7684 Argo Rollouts Experiment\uff0c\u5e76\u4e86\u89e3Experiment\u5982\u4f55\u5e2e\u52a9\u6211\u4eec\u6267\u884c A/B \u6d4b\u8bd5\u5e76\u81ea\u52a8\u786e\u5b9a\u63a8\u51fa\u8fdb\u5ea6\u72b6\u6001\u3002</p>"},{"location":"argo1/4argo_rollouts_ab/#_1","title":"\u4f7f\u7528\u6848\u4f8b","text":"<p>\u6211\u4eec\u5c06\u4f7f\u7528\u4e00\u4e2a\u5929\u6c14\u5e94\u7528\u7a0b\u5e8f\u3002\u5929\u6c14\u5e94\u7528\u7a0b\u5e8f\u6709\u4e24\u4e2a\u7248\u672c\uff0c\u5c06\u4f7f\u7528\u91d1\u4e1d\u96c0\u90e8\u7f72\u7b56\u7565\u63a8\u51fa\u3002\u6211\u4eec\u5c06\u5728\u91d1\u4e1d\u96c0\u7b56\u7565\u4e2d\u8fdb\u884c\u4e00\u4e2aExperiment\u3002\u8be5Experiment\u5f15\u7528\u4e86\u4e00\u4e2a AnalysisTemplate\uff0c\u5b83\u57fa\u672c\u4e0a\u4ece API \u83b7\u53d6\u54cd\u5e94\u3002\u6839\u636e\u54cd\u5e94\uff0cExperiment\u5c06\u88ab\u6807\u8bb0\u4e3a\u901a\u8fc7\u6216\u5931\u8d25\u3002\u5982\u679cExperiment\u6210\u529f\uff0c\u5219\u5c06\u63a8\u51fa\u5e94\u7528\u7a0b\u5e8f\u7684\u65b0\u7248\u672c\uff0c\u5426\u5219\u4e0d\u4f1a\u3002</p> <p>\u4e86\u89e3\u4e86\u7528\u4f8b\u540e\uff0c\u8ba9\u6211\u4eec\u8fdb\u5165\u4ee3\u7801\uff1a</p>"},{"location":"argo1/4argo_rollouts_ab/#argo-rollouts-experiment","title":"Argo Rollouts Experiment\u7684\u5b9e\u65bd","text":"<p>\u9996\u5148\uff0c\u60a8\u9700\u8981\u4e00\u4e2a Kubernetes \u96c6\u7fa4\u3002\u60a8\u53ef\u4ee5\u8ba9\u5b83\u5728\u672c\u5730\u7cfb\u7edf\u6216\u6258\u7ba1\u4e91\u63d0\u4f9b\u5546\u4e0a\u8fd0\u884c\u3002\u7136\u540e\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u7ec8\u7aef\u6765\u8bbf\u95ee\u8be5\u96c6\u7fa4\u6765\u8fde\u63a5\u5230\u8be5\u96c6\u7fa4\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 Minikube\u3002\u5982\u679c\u60a8\u4f7f\u7528 Minikube\uff0c\u8bf7\u786e\u4fdd\u542f\u7528 ingress \u63d2\u4ef6\u3002</p> <p>\u4e0b\u4e00\u6b65\u662f\u514b\u9686\u5305\u542b\u6b64\u793a\u4f8b\u7684\u5b58\u50a8\u5e93\uff1a</p> <pre><code>git clone https://github.com/infracloudio/ArgoRollouts-ABTesting-WeatherExample.git\n</code></pre>"},{"location":"argo1/4argo_rollouts_ab/#argo-rollouts_1","title":"\u8bbe\u7f6e Argo Rollouts \u63a7\u5236\u5668","text":"<p>\u521b\u5efa\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4ee5\u5c06 Argo Rollouts \u63a7\u5236\u5668\u5b89\u88c5\uff1a</p> <pre><code>kubectl create namespace argo-rollouts\n</code></pre> <p>\u5b89\u88c5\u6700\u65b0\u7248\u672c\u7684 Argo Rollouts \u63a7\u5236\u5668\uff1a</p> <pre><code>kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml\n</code></pre> <p>\u786e\u4fdd\u7528\u4e8e argo \u90e8\u7f72\u7684\u6240\u6709\u7ec4\u4ef6\u548c Pod \u5747\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u68c0\u67e5\u5b83\uff1a</p> <pre><code>kubectl get all -n argo-rollouts\n</code></pre> <p>\u4e0e Argo Rollouts \u63a7\u5236\u5668\u4ea4\u4e92\u7684\u6700\u7b80\u5355\u4e14\u63a8\u8350\u7684\u65b9\u6cd5\u4e4b\u4e00\u662f\u4f7f\u7528<code>kubectl argo rollout</code> \u63d2\u4ef6\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u5b89\u88c5\u5b83\uff1a</p> <pre><code>\ncurl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64\nchmod +x ./kubectl-argo-rollouts-linux-amd64\nsudo mv ./kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts\nkubectl argo rollouts version\n</code></pre> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u5df2\u7ecf\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u6210\u529f\u914d\u7f6e\u4e86 Argo Rollouts \u63a7\u5236\u5668\u3002</p>"},{"location":"argo1/4argo_rollouts_ab/#argo-rollouts_2","title":"Argo Rollouts\u91d1\u4e1d\u96c0\u90e8\u7f72","text":"<p>\u5982\u524d\u6240\u8ff0\uff0c\u6211\u4eec\u5c06\u4f7f\u7528 <code>Argo Rollouts Experiment</code>\u548c <code>Canary</code> \u90e8\u7f72\u3002</p> <p>\u4e3a\u6b64\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a\u91d1\u4e1d\u96c0<code>rollout.yaml</code>\u548c\u4e00\u4e2a<code>AnalysisTemplate</code>\u3002 rollout\u89c4\u683c\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Rollout\nmetadata:\n name: rollout-experiment\nspec:\n replicas: 2\n strategy:\n   canary:\n     steps:\n     - setWeight: 20\n     - pause: {duration: 10}\n     # The second step is the experiment which starts a single canary pod\n     - experiment:\n         duration: 5m\n         templates:\n         - name: canary\n           specRef: canary\n         # This experiment performs its own analysis by referencing an AnalysisTemplates\n         # The success or failure of these runs will progress or abort the rollout respectively.\n         analyses:\n         - name: canary-experiment\n           templateName: webmetric\n     - setWeight: 40\n     - pause: {duration: 10}\n     - setWeight: 60\n     - pause: {duration: 10}\n     - setWeight: 80\n     - pause: {duration: 10}\n revisionHistoryLimit: 2\n selector:\n   matchLabels:\n     app: rollout-experiment\n template:\n   metadata:\n     labels:\n       app: rollout-experiment\n   spec:\n     containers:\n     - name: rollouts-demo\n       image: docker.io/atulinfracloud/weathersample:v1\n       imagePullPolicy: Always\n       ports:\n       - containerPort: 5000\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n name: rollout-weather-svc\nspec:\n selector:\n   app: rollout-experiment\n ports:\n   - protocol: \"TCP\"\n     port: 80\n     targetPort: 5000\n type: NodePort\n\n---\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n name: rollout-ingress\n annotations:\n   nginx.ingress.kubernetes.io/rewrite-target: /\nspec:\n    ingressClassName: nginx\n rules:\n - http:\n     paths:\n     - path: /\n       pathType: Prefix\n       backend:\n         service:\n           name: rollout-weather-svc\n           port:\n             number: 80\n</code></pre> <p>\u5728\u4e0a\u9762\uff0c<code>rollout.yaml</code>\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u91d1\u4e1d\u96c0\u7b56\u7565\u5e76\u63d0\u4f9b\u4e86\u4e00\u4e2aexperiment\u4f5c\u4e3a\u6b65\u9aa4\u3002</p> <p>\u65e0\u8bba\u7ed3\u679c\u5982\u4f55\uff0cexperiment\u90fd\u8ba1\u5212\u8fd0\u884c 5 \u5206\u949f\u3002\u5b83\u521b\u5efa\u4e00\u4e2a <code>Canary ReplicaSet</code> \u5e76\u5f15\u7528\u4e00\u4e2a <code>AnalysisTemplate</code> \u5bf9\u8c61\u3002</p> <p>AnalysisTemplate </p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: AnalysisTemplate\nmetadata:\n name: webmetric\nspec:\n metrics:\n - name: webmetric\n   successCondition: result.completed == true # Change this value to `result.completed == false` to fail the test\n   provider:\n     web:\n       url: \"https://jsonplaceholder.typicode.com/todos/4\" # URL returns a JSON object with completed being one of the values, it returns true by default\n       timeoutSeconds: 10\n ```\n\n AnalysisTemplate \u540d\u79f0\u4e3awebmetric\u3002\n\n \u5b83\u8c03\u7528\u8fd4\u56de JSON \u5bf9\u8c61\u7684 API\u3002\u8be5\u5bf9\u8c61\u6709\u591a\u4e2a\u53d8\u91cf\uff0c\u5176\u4e2d\u4e4b\u4e00\u662fcompleted. \u4e0b\u9762\u662f\u4e00\u4e2a JSON \u5bf9\u8c61\u793a\u4f8b\uff1a\n\n ```\n{\n    \"userId\": 1,\n    \"id\": 4,\n    \"title\": \"et porro tempora\",\n    \"completed\": true\n  }\n ```\n\n**\u8be5\u6a21\u677f\u6307\u5b9asuccessConditionas\u7684\u503c\u4e3a`result.completed == true`\u3002**\n\n**\u8fd9\u610f\u5473\u7740\u53ea\u6709\u5f53completed\u503c\u4e3atrue\u65f6 AnalysisRun \u624d\u4f1a\u6210\u529f**\u3002\u5373\uff0c\u4ec5\u5f53\u8be5 AnalysisRun \u6210\u529f\u65f6\uff0c\u66f4\u65b0\u624d\u4f1a\u7ee7\u7eed\u8fdb\u884c\u3002\n\n\u4e3a\u4e86\u4fbf\u4e8e\u90e8\u7f72\uff0c\u6211\u4eec\u5c06\u4e0a\u9762\u63d0\u5230\u7684\u670d\u52a1\u548c\u90e8\u7f72\u5408\u5e76\u5230\u4e00\u4e2a YAML \u6587\u4ef6\u4e2d\uff1a`rollout.yaml.` \u6211\u4eec\u5c06\u9996\u5148\u90e8\u7f72 `AnalysisTemplate`\uff0c\u7136\u540e\u8fdb\u884c\u90e8\u7f72\u3002\n\n</code></pre> <p>$ kubectl apply -f analysis.yaml analysistemplate.argoproj.io/webmetric created</p> <pre><code>\n\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u68c0\u67e5\u521b\u5efa\u7684 AnalysisTemplate \u7684\u72b6\u6001\uff1a\n\n\n</code></pre> <p>$ kubectl describe AnalysisTemplate</p> <p>Name:         webmetric Namespace:    default Labels:        Annotations:   API Version:  argoproj.io/v1alpha1 Kind:         AnalysisTemplate Metadata:   Creation Timestamp:  2022-09-26T07:03:32Z   Generation:          1   Managed Fields:     API Version:  argoproj.io/v1alpha1     Fields Type:  FieldsV1     fieldsV1:       f:metadata:         f:annotations:           .:           f:kubectl.kubernetes.io/last-applied-configuration:       f:spec:         .:         f:metrics:     Manager:         kubectl-client-side-apply     Operation:       Update     Time:            2022-09-26T07:03:32Z   Resource Version:  8231   UID:               43717fbe-8126-4564-87a1-6c45b1d45ba8 Spec:   Metrics:     Name:  webmetric     Provider:       Web:         Timeout Seconds:  10         URL:              https://jsonplaceholder.typicode.com/todos/1     Success Condition:    result.completed == true Events:                    <pre><code>\n\u90e8\u7f72 AnalysisTemplate \u540e\uff0c\u8ba9\u6211\u4eec\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u90e8\u7f72rollout\uff1a\n\n</code></pre> <p>kubectl apply -f rollout.yaml</p> <p>rollout.argoproj.io/rollout-experiment created service/weather-test-app-hyd created service/weather-test-app-ny created</p> <pre><code>\n\u60a8\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u9a8c\u8bc1rollout\u662f\u5426\u6210\u529f\uff1a\n\n</code></pre> <p>$ kubectl argo rollouts get rollout rollout-experiment</p> <p>Name:            rollout-experiment Namespace:       default Status:          \u2714 Healthy Strategy:        Canary   Step:          9/9   SetWeight:     100   ActualWeight:  100 Images:          docker.io/atulinfracloud/weathersample:v1 (stable) Replicas:   Desired:       2   Current:       2   Updated:       2   Ready:         2   Available:     2</p> <p>NAME                                           KIND        STATUS     AGE   INFO \u27f3 rollout-experiment                           Rollout     \u2714 Healthy  116s \u2514\u2500\u2500# revision:1                                                               \u2514\u2500\u2500\u29c9 rollout-experiment-9fb48bdbf           ReplicaSet  \u2714 Healthy  116s  stable       \u251c\u2500\u2500\u25a1 rollout-experiment-9fb48bdbf-czvsh  Pod         \u2714 Running  116s  ready:1/1       \u2514\u2500\u2500\u25a1 rollout-experiment-9fb48bdbf-qnk2s  Pod         \u2714 Running  116s  ready:1/1</p> <pre><code>\n</code></pre> <p>$ kubectl get all -n argo-rollouts  NAME                                READY   STATUS    RESTARTS      AGE pod/argo-rollouts-b9bbbc884-mrgkp   1/1     Running   1 (22h ago)   22h</p> <p>NAME                            TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)    AGE service/argo-rollouts-metrics   ClusterIP   192.168.194.247           8090/TCP   23h <p>NAME                            READY   UP-TO-DATE   AVAILABLE   AGE deployment.apps/argo-rollouts   1/1     1            1           23h</p> <p>NAME                                      DESIRED   CURRENT   READY   AGE replicaset.apps/argo-rollouts-b9bbbc884   1         1         1       23h</p> <pre><code>\n\u6b64\u65f6\uff0c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u6b63\u5728\u4f7f\u7528\u5929\u6c14\u5e94\u7528\u7a0b\u5e8f v1 \u8fd0\u884c\u3002\u4e3a\u4e86\u8bbf\u95ee\u8be5\u5e94\u7528\u7a0b\u5e8f\uff0c\u60a8\u9700\u8981\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n\n* \u5728\u65b0\u7684\u7ec8\u7aef\u4e2d\u8fd0\u884c`minikube tunnel`\uff1b\u8fd9\u5c06\u521b\u5efa\u4e00\u4e2a\u96a7\u9053\uff0c\u4ee5\u4fbf\u6211\u4eec\u53ef\u4ee5\u4ece\u672c\u5730\u4e3b\u673a\u8bbf\u95ee\u5165\u53e3\u3002\n* \u5728\u53e6\u4e00\u4e2a\u7ec8\u7aef\u4e2d\uff0c\u516c\u5f00`rollout-weather-sv`c\u901a\u8fc7\u547d\u4ee4 `minikube service rollout-weather-svc --url`\n* \u4f7f\u7528\u60a8\u4ece\u4e0a\u8ff0\u6b65\u9aa4\u4e2d\u83b7\u5f97\u7684 URL \u8bbf\u95ee\u8be5\u5e94\u7528\u7a0b\u5e8f\u3002\n\n![Alt Image Text](../images/ag1_4_3.png \"Body image\")\n\n\u73b0\u5728\u8ba9\u6211\u4eec\u4f7f\u7528\u91d1\u4e1d\u96c0\u7b56\u7565\u5c06Docker\u955c\u50cf\u66f4\u65b0\u4e3a\u65b0\u7684Docker\u955c\u50cf\u3002\n\n</code></pre> <p>kubectl argo rollouts set image rollout-experiment rollouts-demo=docker.io/atulinfracloud/weathersample:v2</p> <pre><code>\n\u5f53\u6211\u4eec\u8fd0\u884c\u6b64\u547d\u4ee4\u65f6\uff0c\u4ee5\u4e0b\u6d3b\u52a8\u5c06\u540c\u65f6\u542f\u52a8\uff1a\n\n* \u91d1\u4e1d\u96c0\u90e8\u7f72\u5c06\u5f00\u59cbrollout\u8fc7\u7a0b\u3002\n* **Experiments\u5c06\u542f\u52a8\u5e76\u89e6\u53d1\u63d0\u4f9b\u7684 AnalysisTemplate\uff0c\u5b83\u5c06\u5904\u4e8e\u6a21\u677f\u4e2d\u6307\u5b9a\u7684running\u72b6\u6001 5 \u5206\u949f**\u3002\n* AnalysisRun \u5c06\u6839\u636e AnalysisTemplate \u542f\u52a8\u5e76\u8fd0\u884c\u76f4\u81f3\u6d4b\u8bd5\u7ed3\u675f\u3002\n* AnalysisRun \u5c06\u6210\u529f\u7ed3\u675f\uff0c\u4f46Experiments\u5c06\u8fd0\u884c 5 \u5206\u949f\u3002\n* 5 \u5206\u949f\u540e\uff0cExperiments\u5c06\u6210\u529f\uff0c\u90e8\u7f72\u5c06\u7ee7\u7eed\u5e76\u90e8\u7f72\u5929\u6c14\u5e94\u7528\u7a0b\u5e8f v2\u3002\n\n\u5728\u4ee5\u4e0b\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u5c06\u770b\u5230\u4e0a\u8ff0\u6bcf\u9879\u6d3b\u52a8\u3002\n\nExperiments\u72b6\u51b5\n\n</code></pre> <p>$ kubectl get Experiments</p> <p>NAME                               STATUS    AGE rollout-experiment-c8b88c86c-2-2   Running   9s</p> <pre><code>\nAnalysisRun \u7684\u72b6\u6001\n\n</code></pre> <p>$ kubectl get AnalysisRun NAME                                                 STATUS       AGE rollout-experiment-c8b88c86c-2-2-canary-experiment   Successful   16s</p> <pre><code>\n\u8ba9\u6211\u4eec\u63cf\u8ff0 AnalysisRun \u5e76\u67e5\u770b AnalysisRun \u6267\u884c\u65f6\u53d1\u751f\u7684\u4e8b\u4ef6\u3002\n\n</code></pre> <p>$ kubectl describe AnalysisRun rollout-experiment-c8b88c86c-2-2-canary-experiment Name:         rollout-experiment-c8b88c86c-2-2-canary-experiment Namespace:    default Labels:        Annotations:   API Version:  argoproj.io/v1alpha1 Kind:         AnalysisRun Metadata:   Creation Timestamp:  2023-10-20T14:00:16Z   Generation:          2   Managed Fields:     API Version:  argoproj.io/v1alpha1     Fields Type:  FieldsV1     fieldsV1:       f:metadata:         f:ownerReferences:           .:           k:{\"uid\":\"4fd270a1-f7aa-4854-a0ed-aa51f07f024e\"}:       f:spec:         .:         f:metrics:       f:status:         .:         f:dryRunSummary:         f:metricResults:         f:phase:         f:runSummary:           .:           f:count:           f:successful:         f:startedAt:     Manager:    rollouts-controller     Operation:  Update     Time:       2023-10-20T14:00:18Z   Owner References:     API Version:           argoproj.io/v1alpha1     Block Owner Deletion:  true     Controller:            true     Kind:                  Experiment     Name:                  rollout-experiment-c8b88c86c-2-2     UID:                   4fd270a1-f7aa-4854-a0ed-aa51f07f024e   Resource Version:        63932   UID:                     9ac528be-e255-42e7-a045-e1e90373a29f Spec:   Metrics:     Name:  webmetric     Provider:       Web:         Timeout Seconds:  10         URL:              https://jsonplaceholder.typicode.com/todos/4     Success Condition:    result.completed == true Status:   Dry Run Summary:   Metric Results:     Count:  1     Measurements:       Finished At:  2023-10-20T14:00:18Z       Phase:        Successful       Started At:   2023-10-20T14:00:16Z       Value:        {\"completed\":true,\"id\":4,\"title\":\"et porro tempora\",\"userId\":1}     Name:           webmetric     Phase:          Successful     Successful:     1   Phase:            Successful   Run Summary:     Count:       1     Successful:  1   Started At:    2023-10-20T14:00:18Z Events:   Type    Reason                 Age   From                 Message   ----    ------                 ----  ----                 -------   Normal  MetricSuccessful       49s   rollouts-controller  Metric 'webmetric' Completed. Result: Successful   Normal  AnalysisRunSuccessful  49s   rollouts-controller  Analysis Completed. Result: Successful <pre><code>\n\u73b0\u5728\u8ba9\u6211\u4eec\u770b\u770b AnalysisRun \u6210\u529f\u540eExperiments\u7684\u72b6\u6001\uff1a\n\n</code></pre> <p>$ kubectl describe Experiment rollout-experiment-698fdb45bf-2-2</p> <p>... Status:   Analysis Runs:     Analysis Run:  rollout-experiment-698fdb45bf-2-2-canary-experiment     Name:          canary-experiment     Phase:         Successful   Available At:    2022-09-26T07:44:49Z   Conditions:     Last Transition Time:  2022-09-26T07:44:35Z     Last Update Time:      2022-09-26T07:44:49Z     Message:               Experiment \"rollout-experiment-698fdb45bf-2-2\" is running.     Reason:                NewReplicaSetAvailable     Status:                True     Type:                  Progressing   Phase:                   Running   Template Statuses:     Available Replicas:    1     Last Transition Time:  2022-09-26T07:44:49Z     Name:                  canary     Ready Replicas:        1     Replicas:              1     Status:                Running     Updated Replicas:      1 Events:   Type    Reason                 Age   From                 Message   ----    ------                 ----  ----                 -------   Normal  TemplateProgressing    48s   rollouts-controller  Template 'canary' transitioned from  -&gt; Progressing   Normal  ExperimentPending      48s   rollouts-controller  Experiment transitioned from  -&gt; Pending   Normal  ScalingReplicaSet      48s   rollouts-controller  Scaled up ReplicaSet rollout-experiment-698fdb45bf-2-2-canary from 0 to 1   Normal  TemplateRunning        34s   rollouts-controller  Template 'canary' transitioned from Progressing -&gt; Running   Normal  ExperimentRunning      34s   rollouts-controller  Experiment transitioned from Pending -&gt; Running   Normal  AnalysisRunPending     34s   rollouts-controller  AnalysisRun 'canary-experiment' transitioned from  -&gt; Pending   Normal  AnalysisRunSuccessful  29s   rollouts-controller  AnalysisRun 'canary-experiment' transitioned from  -&gt; Successful</p> <pre><code>\nArgo Rollouts \u8fd8\u5e26\u6709\u81ea\u5df1\u7684GUI\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8fdb\u884c\u8bbf\u95ee\uff1a\n\n</code></pre> <p>kubectl argo rollouts dashboard</p> <pre><code>\n\u60a8\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u8bbf\u95ee`http://localhost:3100`\u6765\u8bbf\u95ee Argo Rollouts \u63a7\u5236\u53f0\u3002\u5982\u679c\u60a8\u5728Experiments\u8fd0\u884c\u65f6\u67e5\u770b Argo Rollouts \u4eea\u8868\u677f\uff0c\u60a8\u5e94\u8be5\u4f1a\u770b\u5230\u5982\u4e0b\u5185\u5bb9\uff1a\n\n![Alt Image Text](../images/ag1_4_4.png \"Body image\")\n\n![Alt Image Text](../images/ag1_4_41.png \"Body image\")\n\nExperiments\u6301\u7eed\u65f6\u95f4\u8fc7\u540e\uff0cExperiments\u5c06\u901a\u8fc7\uff0c\u90e8\u7f72\u5c06\u7ee7\u7eed\u8fdb\u884c\u540e\u7eed\u6b65\u9aa4\uff0c\u5e76\u6700\u7ec8\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u7684\u8f83\u65b0\u7248\u672c\u3002\n\n![Alt Image Text](../images/ag1_4_5.png \"Body image\")\n\n\u5728\u73b0\u5b9e\u573a\u666f\u4e2d\uff0c\u60a8\u8fd0\u884c\u7684\u6d4b\u8bd5\u53ef\u4ee5\u5305\u62ec\u6765\u81ea Grafana \u548cPrometheus\u7b49\u76d1\u63a7\u5de5\u5177\u7684\u6307\u6807\uff0c\u5e76\u4e14\u60a8\u5c06\u80fd\u591f\u6839\u636e\u8fd9\u4e9b\u503c\u63a8\u8fdb\u90e8\u7f72\u3002\n\n\u8981\u6d4b\u8bd5\u6545\u969c\u573a\u666f\uff0c\u8bf7\u5c06`analysis.yaml`\u6587\u4ef6\u4e2d`successConditionin`\u66f4\u6539\u4e3a`successCondition: result.completed == false`\u3002\n\n\n\u7531\u4e8e API \u7684\u7ed3\u679c\u59cb\u7ec8\u4e3atrue\uff0c\u8fd9\u5c06\u4f7f `AnalysisRun` \u5931\u8d25\u5e76\u4e14Experiments\u5c06\u5931\u8d25\u3002\n\n\u7531\u4e8eExperiments\u5931\u8d25\uff0c\u90e8\u7f72\u5c06\u4e0d\u4f1a\u7ee7\u7eed\u8fdb\u884c\u540e\u7eed\u6b65\u9aa4\uff0c\u5e76\u4e14\u4e0d\u4f1a\u90e8\u7f72\u8f83\u65b0\u7684\u7248\u672c\u3002\n\u66f4\u6539\u503c\u540e\uff0c\u66f4\u65b0docker\u955c\u50cf\u5e76\u6ce8\u610f AnalysisRun \u5bf9\u8c61\u3002\n\n\n</code></pre> <p>kubectl describe AnalysisRun rollout-experiment-c8b88c86c-2-2-canary-experiment  Name:         rollout-experiment-c8b88c86c-2-2-canary-experiment Namespace:    default Labels:        Annotations:   API Version:  argoproj.io/v1alpha1 Kind:         AnalysisRun Metadata:   Creation Timestamp:  2023-10-20T14:00:16Z   Generation:          2   Managed Fields:     API Version:  argoproj.io/v1alpha1     Fields Type:  FieldsV1     fieldsV1:       f:metadata:         f:ownerReferences:           .:           k:{\"uid\":\"4fd270a1-f7aa-4854-a0ed-aa51f07f024e\"}:       f:spec:         .:         f:metrics:       f:status:         .:         f:dryRunSummary:         f:metricResults:         f:phase:         f:runSummary:           .:           f:count:           f:successful:         f:startedAt:     Manager:    rollouts-controller     Operation:  Update     Time:       2023-10-20T14:00:18Z   Owner References:     API Version:           argoproj.io/v1alpha1     Block Owner Deletion:  true     Controller:            true     Kind:                  Experiment     Name:                  rollout-experiment-c8b88c86c-2-2     UID:                   4fd270a1-f7aa-4854-a0ed-aa51f07f024e   Resource Version:        63932   UID:                     9ac528be-e255-42e7-a045-e1e90373a29f Spec:   Metrics:     Name:  webmetric     Provider:       Web:         Timeout Seconds:  10         URL:              https://jsonplaceholder.typicode.com/todos/4     Success Condition:    result.completed == true Status:   Dry Run Summary:   Metric Results:     Count:  1     Measurements:       Finished At:  2023-10-20T14:00:18Z       Phase:        Successful       Started At:   2023-10-20T14:00:16Z       Value:        {\"completed\":true,\"id\":4,\"title\":\"et porro tempora\",\"userId\":1}     Name:           webmetric     Phase:          Successful     Successful:     1   Phase:            Successful   Run Summary:     Count:       1     Successful:  1   Started At:    2023-10-20T14:00:18Z Events:   Type    Reason                 Age    From                 Message   ----    ------                 ----   ----                 -------   Normal  MetricSuccessful       9m33s  rollouts-controller  Metric 'webmetric' Completed. Result: Successful   Normal  AnalysisRunSuccessful  9m33s  rollouts-controller  Analysis Completed. Result: Successful ``` <p>\u8fd9\u662f\u4e00\u4e2a\u7b80\u77ed\u7684\u6f14\u793a\uff0c\u5c55\u793a\u4e86\u5982\u4f55\u4f7f\u7528 Argo Rollouts \u8fdb\u884c\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e2d\u7684 A/B \u6d4b\u8bd5\u3002\u8fd9\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff0c\u5c55\u793a\u4e86 Argo Rollouts Experiments\u7684 A/B \u6d4b\u8bd5\u80fd\u529b\u3002</p>"},{"location":"argo1/4argo_rollouts_ab/#ab_1","title":"A/B \u6d4b\u8bd5\u5728\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u4e2d\u7684\u597d\u5904","text":"<p>A/B \u6d4b\u8bd5\u672c\u8eab\u6709\u5f88\u591a\u597d\u5904\u3002\u7136\u800c\uff0c\u901a\u8fc7\u5c06\u5176\u4e0e\u91d1\u4e1d\u96c0\u90e8\u7f72\u4e00\u8d77\u4f7f\u7528\uff0c\u6211\u4eec\u80fd\u591f\u66f4\u8fdb\u4e00\u6b65\u3002\u901a\u8fc7\u8fd9\u79cd\u65b9\u6cd5\uff0c\u6211\u4eec\u80fd\u591f\uff1a</p> <ul> <li>\u5728\u7279\u5b9a\u6301\u7eed\u65f6\u95f4\u5185\u6216\u65e0\u9650\u671f\u5730\u8fd0\u884cExperiments\uff0c\u76f4\u5230\u90a3\u65f6\u624d\u4f1a\u8fdb\u884c\u90e8\u7f72\u3002</li> <li>\u6839\u636e\u6211\u4eec\u5b9a\u4e49\u7684\u6307\u6807\u548c\u6807\u51c6\u81ea\u52a8\u63a8\u8fdb\u90e8\u7f72\u3002</li> <li>\u66f4\u5feb\u7684\u707e\u96be\u6062\u590d\u5982\u679cExperiments\u5931\u8d25\uff0c\u90e8\u7f72\u5c06\u505c\u6b62\u3002</li> </ul>"},{"location":"argo1/4argo_rollouts_ab/#_2","title":"\u6982\u62ec","text":"<p>\u6e10\u8fdb\u5f0f\u4ea4\u4ed8\u548c A/B \u6d4b\u8bd5\u4f7f\u56e2\u961f\u80fd\u591f\u6267\u884c\u81ea\u5b9a\u4e49 A/B \u6d4b\u8bd5\u5e76\u66f4\u5feb\u5730\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\u3002\u5728\u8fd9\u7bc7\u535a\u6587\u4e2d\uff0c\u6211\u4eec\u4e86\u89e3\u4e86\u5982\u4f55\u4f7f\u7528 Argo Rollouts \u7684Experiments\u529f\u80fd\u901a\u8fc7\u91d1\u4e1d\u96c0\u90e8\u7f72\u6267\u884c A/B \u6d4b\u8bd5\u3002\u6211\u4eec\u4e86\u89e3\u4e86 AnalysisTemplates \u548c AnalysisRuns \u4ee5\u53ca\u5b83\u4eec\u7684\u8f93\u51fa\u5982\u4f55\u5f71\u54cd\u63a8\u51fa\u3002</p>"},{"location":"argo1/6gitops/","title":"GitOps \u662f\u4ec0\u4e48\uff1f","text":"<p>GitOps \u662f\u4e00\u7ec4\u4f7f\u7528 Git \u4f5c\u4e3a\u552f\u4e00\u771f\u5b9e\u6765\u6e90\u6765\u7ba1\u7406\u57fa\u7840\u8bbe\u65bd\u548c\u5e94\u7528\u7a0b\u5e8f\u914d\u7f6e\u7684\u5b9e\u8df5\u65b9\u6cd5\uff0c\u4ee5\u4ee3\u7801\u5f62\u5f0f\u4ea4\u4ed8\u57fa\u7840\u8bbe\u65bd\u3002\u6362\u53e5\u8bdd\u8bf4\u2014\u2014\u57fa\u7840\u8bbe\u65bd\u7684\u7248\u672c\u63a7\u5236\u65b9\u5f0f\u3002</p>"},{"location":"argo1/6gitops/#_1","title":"\u8c01\u8d1f\u8d23\uff1f","text":"<p>DevOps \u56e2\u961f\u5e94\u8be5\u8d1f\u8d23\u5b9e\u65bd GitOps \u5b9e\u8df5\uff0c\u800c\u5e38\u89c4\u5f00\u53d1\u4eba\u5458\u5e94\u79ef\u6781\u53c2\u4e0e\u8be5\u8fc7\u7a0b\u3002</p> <p>DevOps \u56e2\u961f\u8d1f\u8d23\u5efa\u7acb\u548c\u7ef4\u62a4 GitOps \u5de5\u4f5c\u6d41\u7a0b\uff0c\u901a\u8fc7 Git \u6709\u6548\u7ba1\u7406\u57fa\u7840\u67b6\u6784\u548c\u5e94\u7528\u914d\u7f6e\u3002</p> <p>\u5f00\u53d1\u4eba\u5458\u901a\u8fc7\u63d0\u4ea4\u4ee3\u7801\u548c\u914d\u7f6e\u66f4\u6539\u6765\u8d21\u732e\uff0c\u4ece\u800c\u76f4\u63a5\u5f71\u54cd\u5176\u6784\u5efa\u7684\u5e94\u7528\u7684\u90e8\u7f72\u548c\u8fd0\u884c\u3002</p> <p>\u5047\u8bbe\u4f60\u6b63\u5728\u66f4\u65b0\u4e00\u4e2a\u8fd0\u884c\u5728 Kubernetes \u4e0a\u7684\u5e94\u7528\u3002\u4f60\u53ef\u4ee5\u76f4\u63a5\u5728 <code>deployment.yaml</code> \u4e2d\u66f4\u6539\u955c\u50cf\u5730\u5740\u6765\u66f4\u65b0\u5e94\u7528\u7248\u672c\uff0c\u5982\u4e0b\u6240\u793a</p> <pre><code>- image: myapp:v2.0\n</code></pre> <p>\u7136\u540e\u63d0\u4ea4\u548c\u63a8\u9001\u914d\u7f6e\uff0cArgo CD \u89c2\u5bdf\u5230\u66f4\u6539\u540e\uff0c\u66f4\u65b0\u4f60\u7684\u90e8\u7f72\uff0c\u8fd9\u6837\u4f60\u7684\u5e94\u7528\u5c31\u4f1a\u8fd0\u884c\u65b0\u7248\u672c\u3002\u8f7b\u677e\u53c8\u5feb\u6377</p> <p></p>"},{"location":"argo1/6gitops/#2024gitops","title":"\u4e3a\u4ec0\u4e48\u57282024\u5e74\u9009\u62e9GitOps\uff1f","text":"<ul> <li>\u63d0\u4ea4\u5386\u53f2\uff1a\u67e5\u770b\u4f60\u7684\u57fa\u7840\u67b6\u6784\u66f4\u6539\u7684\u5b8c\u6574\u5386\u53f2\u8bb0\u5f55\u3002</li> <li>\u6d88\u9664\u9519\u8bef\uff1a\u901a\u8fc7\u7b80\u5355\u7684\u8fd8\u539f\u56de\u6eda\u5230\u5148\u524d\u72b6\u6001\u3002</li> <li>Auto-Pilot\uff1a\u5c06\u66f4\u6539\u63a8\u9001\u5230 Git \u4ee5\u81ea\u52a8\u5e94\u7528\u66f4\u6539\u3002</li> <li>\u4fdd\u6301\u540c\u6b65\uff1a\u60a8\u7684\u5b9e\u65f6\u73af\u5883\u4e0eGit\u5b58\u50a8\u5e93\u4e2d\u7684\u5185\u5bb9\u5b8c\u5168\u5339\u914d\u3002\u5982\u679c\u6709\u4eba\u8bd5\u56fe\u76f4\u63a5\u5728\u4e91\u7aef\u5077\u5077\u6539\u53d8\uff0cGitOps\u4f1a\u8bf4\u201c\u4e0d\uff0c\u4e0d\u5141\u8bb8\u201d\uff0c\u5e76\u5c06\u8fd9\u4e9b\u66f4\u6539\u8fd8\u539f\u56de\u6765\u3002</li> </ul>"},{"location":"argo1/6gitops/#gitops_1","title":"GitOps\u7684\u5173\u952e\u5de5\u5177","text":"<p>GitOps \u662f\u5173\u4e8e\u4f7f\u7528 Git \u4f5c\u4e3a\u57fa\u7840\u67b6\u6784\u5373\u4ee3\u7801\uff08IaC\uff09\u7684\u5de5\u5177\uff0c\u4ee5\u4e0b\u662f\u8fd9\u79cd\u65b9\u6cd5\u7684\u91cd\u8981\u5de5\u5177\uff1a</p> <ol> <li>Argo CD - \u5c06\u60a8\u7684 Kubernetes \u90e8\u7f72\u4e0e\u60a8\u7684 Git \u5b58\u50a8\u5e93\u540c\u6b65\u3002\u5b83\u81ea\u52a8\u5316\u90e8\u7f72\u8fc7\u7a0b\u4ee5\u5339\u914d\u5b9a\u4e49\u5728 Git \u4e2d\u7684\u72b6\u6001\u3002</li> <li>Flux - \u7c7b\u4f3c\u4e8e Argo CD\uff0c\u5b83\u76d1\u89c6\u60a8\u7684 Git \u5b58\u50a8\u5e93\u7684\u66f4\u6539\u5e76\u81ea\u52a8\u5e94\u7528\u5b83\u4eec\u5230\u60a8\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u3002</li> <li>Terraform - \u4e0d\u4ec5\u9002\u7528\u4e8e Kubernetes\uff0c\u8fd8\u5141\u8bb8\u60a8\u5c06\u4e91\u57fa\u7840\u67b6\u6784\u4f5c\u4e3a\u4ee3\u7801\u8fdb\u884c\u7ba1\u7406\u3002\u5b83\u53ef\u4ee5\u5f88\u597d\u5730\u4e0e GitOps \u534f\u540c\u5de5\u4f5c\uff0c\u901a\u8fc7\u5728 Git \u4e2d\u8ddf\u8e2a\u57fa\u7840\u67b6\u6784\u66f4\u6539\u3002</li> </ol> <p>\u8fd9\u4e9b\u5de5\u5177\u7b80\u5316\u4e86\u57fa\u7840\u67b6\u6784\u7ba1\u7406\uff0c\u786e\u4fdd\u90e8\u7f72\u4e00\u81f4\u4e14\u81ea\u52a8\u5316\u3002</p> <p></p>"},{"location":"argo1/6gitops/#gitopsargo-cd","title":"GitOps\u4e0eArgo CD\u7684\u5b9e\u9645\u64cd\u4f5c","text":"<ol> <li>\u5b89\u88c5\uff1a\u51c6\u5907\u597dKubernetes\u96c6\u7fa4\u4e86\u5417\uff1f\u5c06 Argo CD \u90e8\u7f72\u5230\u5176\u4e2d\u3002</li> <li>\u5b58\u50a8\u5e93\uff1a\u5c06\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u671f\u671b\u72b6\u6001\u653e\u5165\u4e00\u4e2aGit\u5b58\u50a8\u5e93\u4e2d\u3002</li> <li>\u8fde\u63a5\u5173\u7cfb\uff1a\u5c06Argo CD\u4e0e\u60a8\u7684\u5b58\u50a8\u5e93\u548c\u96c6\u7fa4\u8fde\u63a5\u8d77\u6765\u3002</li> <li>CI/CD\u96c6\u6210\uff1a\u63a8\u9001\u955c\u50cf\u66f4\u65b0\u6216\u914d\u7f6e\u66f4\u6539\uff1fArgo CD\u4f1a\u6355\u6349\u5230\uff0c\u5e76\u4fdd\u6301\u60a8\u7684\u96c6\u7fa4\u66f4\u65b0\u3002</li> </ol>"},{"location":"argo1/6gitops/#_2","title":"\u6700\u4f73\u5b9e\u8df5","text":"<ul> <li>\u53ef\u91cd\u590d\u90e8\u7f72\uff1a\u901a\u8fc7 Helm \u5b9e\u73b0\u8de8\u73af\u5883\u7684\u4e00\u81f4\u6027\u3002\u5b83\u53ef\u4ee5\u4e3a\u60a8\u7684 Kubernetes \u5e94\u7528\u521b\u5efa\u6a21\u677f\uff0c\u4f7f\u90e8\u7f72\u548c\u66f4\u65b0\u53d8\u5f97\u7b80\u5355\u660e\u4e86\u3002</li> <li>\u4fdd\u62a4\u60a8\u7684\u5de5\u4f5c\u6d41\u7a0b\uff1a\u4f7f\u7528 Sealed Secrets \u5bf9 Git \u4e2d\u7684\u6570\u636e\u8fdb\u884c\u52a0\u5bc6\uff0c\u4fdd\u62a4\u60a8\u7684\u914d\u7f6e\u3002\u5728 Kubernetes \u4e2d\u5b9e\u65bd\u57fa\u4e8e\u89d2\u8272\u7684\u8bbf\u95ee\u63a7\u5236\uff08RBAC\uff09\u4ee5\u63a7\u5236\u8c01\u80fd\u505a\u4ec0\u4e48\u3002</li> <li>\u4e0d\u53ef\u53d8\u57fa\u7840\u67b6\u6784\uff1a\u7edd\u4e0d\u624b\u52a8\u66f4\u6539\u914d\u7f6e\uff0c\u53ea\u80fd\u901a\u8fc7 Git \u8fdb\u884c\u66f4\u6539\uff0c\u4ee5\u786e\u4fdd\u6240\u6709\u5185\u5bb9\u90fd\u53ef\u5ba1\u6838\uff0c\u8fd8\u539f\u7b80\u5355\u3002</li> </ul> <p>\u901a\u8fc7\u4e13\u6ce8\u4e8e\u8fd9\u4e9b\u5b9e\u8df5\u65b9\u6cd5\u548c\u5de5\u5177\uff0c\u60a8\u53ef\u4ee5\u4f18\u5316\u548c\u4fdd\u62a4\u60a8\u7684GitOps\u5de5\u4f5c\u6d41\u7a0b\uff0c\u786e\u4fdd\u6548\u7387\u548c\u7a33\u5b9a\u7684\u57fa\u7840\u67b6\u6784\u3002</p> <p></p>"},{"location":"argo1/7k8s_yaml_cicd/","title":"K8S YAML \u8d44\u6e90\u6e05\u5355\u7ba1\u7406\u65b9\u6848","text":"<p>\u672c\u6587\u4ecb\u7ecd\u7684\u65b9\u6848\u80fd\u591f\u8fbe\u5230\u5982\u4e0b\u6548\u679c\uff1a</p> <ul> <li>\u901a\u8fc7Git\u5f52\u6863\u6240\u6709YAMl\u6587\u4ef6\uff0c\u6240\u6709\u53d8\u66f4\u6e90\u5934\u5728Git\u4ed3\u5e93\uff0c\u4fdd\u7559\u6240\u6709\u53d8\u66f4\u8bb0\u5f55\uff0c\u65b9\u4fbf\u540e\u7eed\u8ffd\u6eaf</li> <li>\u901a\u8fc7Git\u4ed3\u5e93\u5b9e\u73b0\u6240\u6709\u73af\u5883YAML\u6587\u4ef6\u7684\u7edf\u4e00\u7ba1\u7406</li> <li>\u901a\u8fc7GitOps\u65b9\u5f0f\u5b9e\u73b0\u81ea\u52a8\u5316\u66f4\u65b0YAML\u6587\u4ef6\uff0c\u65e0\u9700\u767b\u5f55\u670d\u52a1\u5668\uff0c\u51cf\u5c11\u624b\u52a8\u6572\u547d\u4ee4\u884c\u4e3a\uff0c\u4ece\u800c\u964d\u4f4e\u8bef\u64cd\u4f5c\u98ce\u9669</li> <li>\u590d\u5236\u73af\u5883\u65f6\u4e5f\u662f\u76f4\u63a5\u64cd\u4f5cGit\u4ed3\u5e93\uff0c\u65b0\u589e\u5bf9\u5e94\u73af\u5883\u5dee\u5f02\u5316\u76ee\u5f55\u5373\u53ef</li> </ul> <p></p>"},{"location":"argo1/7k8s_yaml_cicd/#kustomize","title":"Kustomize\u5de5\u5177\u4ecb\u7ecd","text":"<p>Kustomize \u662f\u4e00\u6b3e Kubernetes \u539f\u751f\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff0c\u5176\u6838\u5fc3\u7406\u5ff5\u662f\u5141\u8bb8\u7528\u6237\u81ea\u5b9a\u4e49 Kubernetes \u8d44\u6e90\u914d\u7f6e\uff0c\u800c\u65e0\u9700\u76f4\u63a5\u4fee\u6539\u539f\u59cb\u7684 YAML \u6587\u4ef6\u3002\u8fd9\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u63d0\u9ad8\u4e86\u914d\u7f6e\u7684\u53ef\u7ef4\u62a4\u6027\u548c\u53ef\u91cd\u7528\u6027\u3002</p> <p>Kustomize \u4f7f\u7528\u58f0\u660e\u5f0f\u7684\u65b9\u5f0f\u6765\u5b9a\u5236\u8d44\u6e90\uff0c\u901a\u8fc7\u4e00\u7cfb\u5217\u9884\u5b9a\u4e49\u7684\u6307\u4ee4\u548c\u89c4\u5219\uff0c\u7528\u6237\u53ef\u4ee5\u5bf9\u57fa\u7840\u8d44\u6e90\u8fdb\u884c\u4fee\u6539\u3001\u6dfb\u52a0\u6216\u5220\u9664</p> <p>Kustomize\u7684\u76ee\u5f55\u4e3b\u8981\u5305\u542bBase\u548cOverlays\uff0cBase\u4e0b\u5b58\u653e\u7684\u662f\u6a21\u7248\u6587\u4ef6\uff0cOverlays\u662f\u4e0d\u540c\u73af\u5883\u7684\u5dee\u5f02\u5316\u7ba1\u7406\u76ee\u5f55\uff0c\u8fd9\u4e24\u4e2a\u76ee\u5f55\u4e0b\u90fd\u9700\u8981\u6709kustomization.yaml\u6587\u4ef6\uff0c\u8fd9\u4e2a\u6587\u4ef6\u7528\u4e8e\u63cf\u8ff0\u5982\u4f55\u751f\u6210\u5b9a\u5236\u7684\u8d44\u6e90\u3002</p> <ul> <li> <p>https://github.com/kubernetes-sigs/kustomize</p> </li> <li> <p>https://kubectl.docs.kubernetes.io/zh/api-reference/kustomization/</p> </li> </ul>"},{"location":"argo1/7k8s_yaml_cicd/#argocd","title":"ArgoCD\u5de5\u5177\u4ecb\u7ecd","text":"<p>ArgoCD \u662f\u4e00\u4e2a\u58f0\u660e\u5f0f\u7684 GitOps \u6301\u7eed\u4ea4\u4ed8\u5de5\u5177\uff0c\u7528\u4e8e Kubernetes \u96c6\u7fa4\u3002\u5b83\u901a\u8fc7\u6301\u7eed\u76d1\u63a7 Git \u4ed3\u5e93\u4e2d\u7684 Kubernetes \u8d44\u6e90\u914d\u7f6e\u6587\u4ef6\uff0c\u5c06\u8fd9\u4e9b\u914d\u7f6e\u5e94\u7528\u5230\u6307\u5b9a\u7684 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u786e\u4fdd\u96c6\u7fa4\u7684\u5b9e\u9645\u72b6\u6001\u4e0e\u4ed3\u5e93\u4e2d\u7684\u914d\u7f6e\u4fdd\u6301\u4e00\u81f4\u3002</p> <p>ArgoCD \u652f\u6301\u5404\u79cd Kubernetes \u6e05\u5355\u683c\u5f0f\uff0c\u5982 Kustomize\u3001Helm Charts\u3001Ksonnet\u3001YAML \u548c JSON\uff0c\u5141\u8bb8\u4f60\u901a\u8fc7 Git \u4ed3\u5e93\u7ba1\u7406\u548c\u90e8\u7f72 Kubernetes \u8d44\u6e90\uff0c\u672c\u6587\u4ecb\u7ecd\u7684\u662fArgoCD YAMl\u6587\u4ef6\u7684\u65b9\u5f0f</p> <ul> <li>https://github.com/argoproj/argo-cd</li> <li>https://argo-cd.readthedocs.io/en/stable/</li> </ul>"},{"location":"argo1/7k8s_yaml_cicd/#_1","title":"\u5177\u4f53\u5b9e\u8df5","text":"<p>\u539f\u751f\u7684Kustomize\u7528\u6cd5\u4e00\u822c\u662f\u5728base\u4e0b\u7ef4\u62a4\u6240\u6709\u5fae\u670d\u52a1\u7684\u5168\u91cfyaml\uff0c\u8fd9\u79cd\u65b9\u5f0f\u5982\u679c\u5fae\u670d\u52a1\u5f88\u591a\u7684\u8bdd\u4f1a\u663e\u5f97\u6bd4\u8f83\u81c3\u80bf\uff0c\u8fd9\u91cc\u8fdb\u884c\u4e86\u4e00\u5c42\u62bd\u8c61\u5316\uff0c\u5c06\u4e0d\u540c\u5f00\u53d1\u8bed\u8a00\u7edf\u4e00\u4f7f\u7528\u4e00\u4efddeployment.yaml\uff0c\u901a\u8fc7\u5360\u4f4d\u7b26\u5b9a\u4e49\u540d\u5b57\uff0c\u7136\u540e\u5728Gitlab-CI\u5904\u7406\uff0c\u6e32\u67d3\u51fa\u5168\u91cfbase deployment.yaml\u540e\uff0c\u518d\u7531Kustomize\u6e32\u67d3\u6700\u7ec8\u5236\u54c1\u3002</p> <ul> <li>\u8fd9\u79cd\u65b9\u5f0f\u51cf\u5c11\u4e86base\u4e0b\u7684yaml\u6587\u4ef6\u6570\uff0c\u907f\u514d\u8fc7\u591a\u7684\u6587\u4ef6\u589e\u52a0\u7ef4\u62a4\u6210\u672c</li> <li>\u65b0\u589e\u670d\u52a1\u65f6\u5f88\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728<code>base_xx/microservice.yaml</code>\u589e\u52a0\u5bf9\u5e94\u7684\u5fae\u670d\u52a1\u540d\u5b57\u5373\u53ef</li> <li>\u8003\u8651\u5230\u53ef\u80fd\u6709\u670d\u52a1\u4e0a\u4e86test\u73af\u5883\u540e\u8fd8\u4e0d\u4e0a\u751f\u4ea7\uff0c\u6240\u4ee5\u5728<code>overlays/env</code>\u76ee\u5f55\u4e0b\u4e5f\u589e\u52a0\u4e86microservice.yaml\uff0c\u7528\u4e8e\u5fae\u670d\u52a1\u7684\u5dee\u5f02\u5316</li> <li><code>overlays/env/kustomization.yaml</code>\u8fd9\u4e2a\u662f\u6700\u91cd\u8981\u7684\u6587\u4ef6\uff0c\u73af\u5883\u7684\u5dee\u5f02\u5316\u914d\u7f6e\u90fd\u5728\u8fd9\u91cc\uff0c\u5982\u5fae\u670d\u52a1\u955c\u50cf/\u526f\u672c\u6570/\u8d44\u6e90/\u914d\u7f6e\u5dee\u5f02\u5316\u90fd\u7edf\u4e00\u5728\u8fd9\u4e2a\u6587\u4ef6\u8fdb\u884c\u914d\u7f6e\uff0c\u5177\u4f53\u914d\u7f6e\u65b9\u6cd5\u5b98\u65b9\u6587\u6863\u6709\u8be6\u7ec6\u4ecb\u7ecd</li> <li>\u65b0\u589e\u73af\u5883\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u590d\u5236\u4e00\u4e2a<code>overlays/env</code>\uff0c\u7136\u540e\u4fee\u6539kustomization.yaml\u5373\u53ef</li> <li>\u6700\u7ec8YAML\u6587\u4ef6\u6e32\u67d3\u51fa\u6765\u540e\u5f52\u6863\u56de\u4ed3\u5e93\uff0cArgocd\u914d\u7f6e\u5173\u8054\u5373\u53ef\uff0c\u8fd9\u91cc\u5c31\u4e0d\u622a\u56fe\u4ecb\u7ecd\u4e86\uff0c\u53ef\u81ea\u884c\u4e86\u89e3Argocd\u7528\u6cd5\u3002Argocd\u652f\u6301\u5f00\u542fAutoSync\uff0c\u6240\u4ee5\u975e\u751f\u4ea7\u73af\u5883\u5f00\u542f\u540e\uff0c\u5728GitLab\u4ed3\u5e93\u4fee\u6539\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u751f\u6548</li> </ul>"},{"location":"argo1/8cd_image_updater/","title":"ArgoCD Image Updater","text":"<p>Argo CD Image Updater \u662f\u4e00\u79cd\u81ea\u52a8\u66f4\u65b0\u7531 Argo CD \u7ba1\u7406\u7684 Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u7684\u5bb9\u5668\u955c\u50cf\u7684\u5de5\u5177\u3002 </p> <p>\u8be5\u5de5\u5177\u53ef\u4ee5\u68c0\u67e5\u4e0e Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u4e00\u8d77\u90e8\u7f72\u7684\u5bb9\u5668\u955c\u50cf\u7684\u65b0\u7248\u672c\uff0c\u5e76\u4f7f\u7528 Argo CD \u81ea\u52a8\u5c06\u5176\u66f4\u65b0\u5230\u5141\u8bb8\u7684\u6700\u65b0\u7248\u672c\u3002</p> <p>\u5b83\u901a\u8fc7\u4e3a Argo CD \u5e94\u7528\u7a0b\u5e8f\u8bbe\u7f6e\u9002\u5f53\u7684\u5e94\u7528\u7a0b\u5e8f\u53c2\u6570\u6765\u5de5\u4f5c\uff0c\u7c7b\u4f3c\u4e8e <code>argocd app set --helm-set image.tag=v1.0.1</code>\uff0c\u4f46\u4ee5\u5b8c\u5168\u81ea\u52a8\u5316\u7684\u65b9\u5f0f\u3002</p> <p>Argo CD Image Updater \u4f1a\u5b9a\u671f\u8f6e\u8be2 Argo CD \u4e2d\u914d\u7f6e\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e76\u67e5\u8be2\u76f8\u5e94\u7684\u955c\u50cf\u4ed3\u5e93\u4ee5\u83b7\u53d6\u53ef\u80fd\u7684\u65b0\u7248\u672c\u3002</p> <p>\u5982\u679c\u5728\u4ed3\u5e93\u4e2d\u627e\u5230\u65b0\u7248\u672c\u7684\u955c\u50cf\uff0c\u5e76\u4e14\u6ee1\u8db3\u7248\u672c\u7ea6\u675f\uff0cArgo CD \u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u5c06\u6307\u793a Argo CD \u4f7f\u7528\u65b0\u7248\u672c\u7684\u955c\u50cf\u66f4\u65b0\u5e94\u7528\u7a0b\u5e8f\u3002</p> <p>\u6839\u636e\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u81ea\u52a8\u540c\u6b65\u7b56\u7565\uff0cArgo CD \u5c06\u81ea\u52a8\u90e8\u7f72\u65b0\u7684\u955c\u50cf\u7248\u672c\u6216\u5c06\u5e94\u7528\u7a0b\u5e8f\u6807\u8bb0\u4e3a\u4e0d\u540c\u6b65\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u540c\u6b65\u5e94\u7528\u7a0b\u5e8f\u6765\u624b\u52a8\u89e6\u53d1\u955c\u50cf\u66f4\u65b0</p>"},{"location":"argo1/8cd_image_updater/#_1","title":"\u5b83\u662f\u5982\u4f55\u8fd0\u4f5c\u7684\uff1f","text":"<p>Image Updater \u7a0b\u5e8f\u901a\u8fc7\u8bfb\u53d6 ArgoCD \u5e94\u7528\u7a0b\u5e8f\u8d44\u6e90\u4e2d\u7684 annotations \u6765\u5de5\u4f5c\uff0c\u8fd9\u4e9b\u6ce8\u89e3\u6307\u5b9a\u5e94\u81ea\u52a8\u66f4\u65b0\u54ea\u4e9b\u955c\u50cf\u3002</p> <p>\u5b83\u4f1a\u68c0\u67e5\u6307\u5b9a\u955c\u50cf\u4ed3\u5e93\u4e2d\u662f\u5426\u6709\u8f83\u65b0\u7684\u6807\u7b7e\uff0c\u5982\u679c\u5b83\u4eec\u4e0e\u9884\u5b9a\u4e49\u7684\u6a21\u5f0f\u6216\u89c4\u5219\u5339\u914d\uff0c\u5219\u4f7f\u7528\u8fd9\u4e9b\u8f83\u65b0\u7684\u6807\u7b7e\u66f4\u65b0\u5e94\u7528\u7a0b\u5e8f\u6e05\u5355\u3002\u6b64\u81ea\u52a8\u5316\u8fc7\u7a0b\u53ef\u786e\u4fdd\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u59cb\u7ec8\u8fd0\u884c\u6700\u65b0\u7248\u672c\u7684\u955c\u50cf\uff0c\u9075\u5faa GitOps \u7684\u4e00\u81f4\u6027\u548c\u53ef\u8ffd\u6eaf\u6027\u539f\u5219</p> <p></p> <p>Image Updater \u57fa\u672c\u7684\u5de5\u4f5c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <ol> <li>Annotation \u914d\u7f6e\uff1a\u5f00\u53d1\u4eba\u5458\u6ce8\u89e3 ArgoCD \u5e94\u7528\u7a0b\u5e8f\u4ee5\u544a\u8bc9 Image Updater \u8981\u8ddf\u8e2a\u54ea\u4e9b\u955c\u50cf\uff0c\u5305\u62ec\u6807\u7b7e\u8fc7\u6ee4\u548c\u66f4\u65b0\u7b56\u7565\u7684\u89c4\u5219\u3002</li> <li>\u955c\u50cf\u4ed3\u5e93\u8f6e\u8be2\uff1aImage Updater \u5b9a\u671f\u8f6e\u8be2\u914d\u7f6e\u7684\u955c\u50cf\u4ed3\u5e93\u4ee5\u67e5\u627e\u7b26\u5408\u6307\u5b9a\u6761\u4ef6\u7684\u65b0\u6807\u7b7e\u3002</li> <li>\u81ea\u52a8\u66f4\u65b0\uff1a\u5f53\u627e\u5230\u65b0\u7684\u5339\u914d\u6807\u7b7e\u65f6\uff0cImage Updater \u4f1a\u81ea\u52a8\u66f4\u65b0\u5e94\u7528\u7a0b\u5e8f\u7684 Kubernetes \u6e05\u5355\u4e2d\u7684\u955c\u50cf\u6807\u7b7e\uff0c\u5e76\u5c06\u66f4\u6539\u63d0\u4ea4\u56de\u6e90 Git \u5b58\u50a8\u5e93\u3002</li> <li>\u540c\u6b65\u53d8\u66f4\uff1aArgoCD \u68c0\u6d4b\u5230\u63d0\u4ea4\u7684\u66f4\u6539\uff0c\u540c\u6b65\u66f4\u65b0\u7684\u6e05\u5355\uff0c\u5e76\u5c06\u5b83\u4eec\u5e94\u7528\u5230 Kubernetes \u96c6\u7fa4\u3002</li> </ol>"},{"location":"argo1/8cd_image_updater/#_2","title":"\u7279\u5f81","text":"<ul> <li>\u66f4\u65b0\u7531 Argo CD \u7ba1\u7406\u4e14\u7531 Helm \u6216 Kustomize \u5de5\u5177\u751f\u6210\u7684\u5e94\u7528\u7a0b\u5e8f\u955c\u50cf</li> <li>\u6839\u636e\u4e0d\u540c\u7684\u66f4\u65b0\u7b56\u7565\u66f4\u65b0\u5e94\u7528\u955c\u50cf<ul> <li>semver\uff1a\u6839\u636e\u7ed9\u5b9a\u7684\u955c\u50cf\u7ea6\u675f\u66f4\u65b0\u5230\u5141\u8bb8\u7684\u6700\u9ad8\u7248\u672c</li> <li>latest\uff1a\u66f4\u65b0\u5230\u6700\u8fd1\u521b\u5efa\u7684\u955c\u50cf\u6807\u7b7e</li> <li>name\uff1a\u66f4\u65b0\u5230\u6309\u5b57\u6bcd\u987a\u5e8f\u6392\u5e8f\u7684\u5217\u8868\u4e2d\u7684\u6700\u540e\u4e00\u4e2a\u6807\u7b7e</li> <li>digest\uff1a\u66f4\u65b0\u5230\u53ef\u53d8\u6807\u7b7e\u7684\u6700\u65b0\u63a8\u9001\u7248\u672c</li> </ul> </li> <li>\u652f\u6301\u5e7f\u6cdb\u4f7f\u7528\u7684\u5bb9\u5668\u955c\u50cf\u4ed3\u5e93</li> <li>\u901a\u8fc7\u914d\u7f6e\u652f\u6301\u79c1\u6709\u5bb9\u5668\u955c\u50cf\u4ed3\u5e93</li> <li>\u53ef\u4ee5\u5c06\u66f4\u6539\u5199\u56de Git</li> <li>\u80fd\u591f\u4f7f\u7528\u5339\u914d\u5668\u51fd\u6570\u8fc7\u6ee4\u955c\u50cf\u4ed3\u5e93\u8fd4\u56de\u7684\u6807\u7b7e\u5217\u8868</li> <li>\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u6216\u8005\u53ef\u4ee5\u4ece\u547d\u4ee4\u884c\u72ec\u7acb\u4f7f\u7528</li> <li>\u80fd\u591f\u6267\u884c\u5e94\u7528\u7a0b\u5e8f\u7684\u5e76\u884c\u66f4\u65b0</li> </ul> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u4f7f\u7528\u8be5\u5de5\u5177\u76ee\u524d\u6709\u51e0\u4e2a\u9650\u5236\uff1a</p> <ul> <li>\u60f3\u8981\u66f4\u65b0\u5bb9\u5668\u955c\u50cf\u7684\u5e94\u7528\u7a0b\u5e8f\u5fc5\u987b\u4f7f\u7528 Argo CD \u8fdb\u884c\u7ba1\u7406\u3002\u4e0d\u652f\u6301\u672a\u4f7f\u7528 Argo CD \u7ba1\u7406\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002</li> <li>Argo CD \u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u53ea\u80fd\u66f4\u65b0\u5176\u6e05\u5355\u4f7f\u7528 Kustomize \u6216 Helm \u5448\u73b0\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u7279\u522b\u662f\u5728 Helm \u7684\u60c5\u51b5\u4e0b\uff0c\u6a21\u677f\u9700\u8981\u652f\u6301\u4f7f\u7528\u53c2\u6570\uff08\u5373image.tag\uff09\u3002</li> <li>\u955c\u50cf\u62c9\u53d6\u5bc6\u94a5\u5fc5\u987b\u5b58\u5728\u4e8e Argo CD Image Updater \u8fd0\u884c\uff08\u6216\u6709\u6743\u8bbf\u95ee\uff09\u7684\u540c\u4e00 Kubernetes \u96c6\u7fa4\u4e2d\u3002\u76ee\u524d\u65e0\u6cd5\u4ece\u5176\u4ed6\u96c6\u7fa4\u83b7\u53d6\u8fd9\u4e9b\u673a\u5bc6\u4fe1\u606f</li> </ul>"},{"location":"argo1/8cd_image_updater/#_3","title":"\u5b89\u88c5","text":"<p>\u5efa\u8bae\u5728\u8fd0\u884c Argo CD \u7684\u540c\u4e00\u4e2a Kubernetes \u547d\u540d\u7a7a\u95f4\u96c6\u7fa4\u4e2d\u8fd0\u884c Argo CD Image Updater\uff0c\u4f46\u8fd9\u4e0d\u662f\u5fc5\u9700\u7684\u3002</p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u751a\u81f3\u4e0d\u9700\u8981\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u8fd0\u884c Argo CD Image Updater \u6216\u6839\u672c\u4e0d\u9700\u8981\u8bbf\u95ee\u4efb\u4f55 Kubernetes \u96c6\u7fa4\u3002\u4f46\u5982\u679c\u4e0d\u8bbf\u95ee Kubernetes\uff0c\u67d0\u4e9b\u529f\u80fd\u53ef\u80fd\u65e0\u6cd5\u4f7f\u7528\uff0c\u6240\u4ee5\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528\u7b2c\u4e00\u79cd\u5b89\u88c5\u65b9\u6cd5\u3002</p> <p>\u8fd0\u884c\u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u7684\u6700\u76f4\u63a5\u65b9\u6cd5\u662f\u5c06\u5176\u4f5c\u4e3a Kubernetes \u5de5\u4f5c\u8d1f\u8f7d\u5b89\u88c5\u5230\u8fd0\u884c Argo CD \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u3002\u8fd9\u6837\u5c31\u4e0d\u9700\u8981\u4efb\u4f55\u914d\u7f6e\uff0c\u4e5f\u4e0d\u4f1a\u5bf9\u4f60\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ea7\u751f\u4efb\u4f55\u5f71\u54cd\u3002</p> <pre><code>kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/stable/manifests/install.yaml\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Argo CD \u4e2d\u770b\u5230 Argo CD Image Updater \u7ec4\u4ef6\u4e86\uff1a</p> <pre><code>$ kubectl get pods -n argocd\nNAME                                                READY   STATUS    RESTARTS      AGE\nargocd-notifications-controller-7f85bc8d8-sdqcd     1/1     Running   1 (13d ago)   14d\nargocd-applicationset-controller-5f7687fbb4-jl6hf   1/1     Running   1 (13d ago)   14d\nargocd-dex-server-665cfbbc8b-nqjf7                  1/1     Running   1 (13d ago)   14d\nargocd-server-84cb8fdcdc-g4wmt                      1/1     Running   1 (13d ago)   14d\nargocd-application-controller-0                     1/1     Running   1 (13d ago)   14d\nargocd-repo-server-bb5d9cc8b-c8f6b                  1/1     Running   1 (13d ago)   14d\nargocd-redis-5f87c6b5d7-n9d6v                       1/1     Running   1 (13d ago)   14d\nargocd-image-updater-57b64976b-kgtkf                1/1     Running   0             20s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u53bb\u76d1\u542c\u955c\u50cf\u662f\u5426\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u800c\u4e0d\u9700\u8981\u5728 CI \u6d41\u6c34\u7ebf\u4e2d\u53bb\u624b\u52a8\u63d0\u4ea4\u4fee\u6539\u8d44\u6e90\u6e05\u5355\u5230\u4ee3\u7801\u4ed3\u5e93\u4e86\u3002</p>"},{"location":"argo1/8cd_image_updater/#_4","title":"\u914d\u7f6e","text":"<p>\u8981\u5145\u5206\u5229\u7528 ArgoCD \u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\uff0c\u5c06\u5176\u914d\u7f6e\u8fde\u63a5\u5230\u955c\u50cf\u4ed3\u5e93\u81f3\u5173\u91cd\u8981\uff0c\u5c24\u5176\u662f\u5728\u4f7f\u7528\u79c1\u6709\u4ed3\u5e93\u6216\u516c\u5171\u4ed3\u5e93\u4e0a\u7684\u79c1\u6709\u5b58\u50a8\u5e93\u65f6\u3002\u4ee5\u4e0b\u662f\u5982\u4f55\u914d\u7f6e\u5fc5\u8981\u7684\u51ed\u636e\u5e76\u4e86\u89e3\u53ef\u7528\u7684\u4e0d\u540c\u65b9\u6cd5\u3002</p> <p>ArgoCD Image Updater \u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u65b9\u6cd5\u83b7\u53d6\u51ed\u636e</p> <ul> <li>\u4ece Kubernetes Secret \u4e2d\u83b7\u53d6\u51ed\u636e\uff1a\u6807\u51c6\u7684 Docker Pull Secret \u6216\u81ea\u5b9a\u4e49 Secret\uff0c\u51ed\u8bc1\u683c\u5f0f\u4e3a <code>&lt;username&gt;:&lt;password&gt;</code> \uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a</li> </ul> <pre><code>kubectl create -n argocd secret docker-registry dockerhub-secret \\\n  --docker-username someuser \\\n  --docker-password s0m3p4ssw0rd \\\n  --docker-server \"https://registry-1.docker.io\"\n</code></pre> <p>\u8fd9\u4e2a secret \u53ef\u4ee5\u88ab\u5f15\u7528\u4e3a <code>pullsecret:&lt;namespace&gt;/&lt;secret_name&gt; (pullsecret:argocd/dockerhub-secret)</code>\u3002</p> <p>\u901a\u7528 <code>Secret\uff1a</code>\u901a\u7528 Secret \u662f\u5305\u542b\u5355\u4e2a\u952e\u503c\u5bf9\u7684 <code>Secret</code>\uff0c\u952e\u503c\u5bf9\u53ef\u4ee5\u662f\u4efb\u4f55\u683c\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a\uff1a</p> <pre><code>kubectl create -n argocd secret generic some-secret \\\n  --from-literal=creds=someuser:s0m3p4ssw0rd\n</code></pre> <p>\u8be5 secret \u53ef\u4ee5\u7528 <code>env:&lt;name_of_environment_variable&gt;</code> (<code>env:DOCKER_HUB_CREDS</code>) \u7684\u65b9\u5f0f\u5f15\u7528</p> <ul> <li>\u73af\u5883\u53d8\u91cf\uff1a\u5c06\u51ed\u8bc1\u5b58\u50a8\u5728\u73af\u5883\u53d8\u91cf\u4e2d\uff0c\u8be5\u53d8\u91cf\u53ef\u4ee5\u4f20\u9012\u5230 ArgoCD Image Updater pod\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 pod \u7684\u914d\u7f6e\u4e2d\u8bbe\u7f6e</li> </ul> <pre><code>env:\n  - name: DOCKER_HUB_CREDS\n    value: \"someuser:s0m3p4ssw0rd\"\n</code></pre> <ul> <li>Script \u811a\u672c\uff1a\u4f7f\u7528\u4ee5 <code>&lt;username&gt;:&lt;password&gt;</code> \u683c\u5f0f\u8f93\u51fa\u51ed\u636e\u7684\u811a\u672c\u3002</li> </ul> <pre><code>#!/bin/sh\necho \"someuser:s0m3p4ssw0rd\"\n</code></pre> <p>\u5c06\u5176\u5f15\u7528\u4e3a <code>ext:&lt;full_path_to_script&gt;</code>\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u5c31\u4ee5 Github \u7684 Container Registry \u4e3a\u4f8b\uff0c\u6765\u6f14\u793a\u4e0b\u5982\u4f55\u4f7f\u7528 ArgoCD Image Updater \u6765\u66f4\u65b0\u955c\u50cf\u3002</p> <p>\u9996\u5148\u6211\u4eec\u5728 Github \u4e2a\u4eba\u8bbe\u7f6e\u9875\u9762\u4e2d\u521b\u5efa\u4e00\u4e2a\u4e2a\u4eba\u8bbf\u95ee\u4ee4\u724c\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u8fd9\u4e2a Token \u7684\u6743\u9650\u8981\u5305\u62ec <code>write:packages</code>\u548c <code>read:packages</code>\uff0c\u8fd9\u6837\u6211\u4eec\u624d\u80fd\u63a8\u9001\u548c\u62c9\u53d6\u955c\u50cf\uff0c\u521b\u5efa\u540e\u4f1a\u5f97\u5230\u4e00\u4e2a Token\u3002</p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5728\u7ec8\u7aef\u6216\u547d\u4ee4\u884c\u4e2d\uff0c\u4f7f\u7528 GitHub \u7528\u6237\u540d\u548c GitHub \u7684\u4e2a\u4eba\u8bbf\u95ee\u4ee4\u724c\uff08PAT\uff09\u767b\u5f55 GitHub Container Registry\u3002</p> <pre><code>\nexport PAT=&lt;your-token&gt;\necho $PAT | docker login ghcr.io -u &lt;your-github-username&gt; --password-stdin\n</code></pre> <p>\u5c06\u66ff\u6362\u4e3a\u4e2a\u4eba\u8bbf\u95ee\u4ee4\u724c\uff0c\u5c06\u66ff\u6362\u4e3a GitHub \u7528\u6237\u540d\u3002</p> <p>\u767b\u5f55\u6210\u529f\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c06 Docker \u955c\u50cf\u6807\u8bb0\u4e3a GitHub Container Registry \u955c\u50cf\uff1a</p> <pre><code>docker tag &lt;your-image-name&gt;:&lt;tag&gt; ghcr.io/&lt;your-github-username&gt;/&lt;your-image-name&gt;:&lt;tag&gt;\n</code></pre> <p>\u5c06 <code>&lt;your-image-name&gt;:&lt;tag&gt;</code> \u66ff\u6362\u4e3a\u672c\u5730 Docker \u955c\u50cf\u540d\u4e0e tag \u540d\uff0c\u5c06 <code>&lt;your-github-username&gt;</code> \u66ff\u6362\u4e3a GitHub \u7528\u6237\u540d\uff0c<code>&lt;tag&gt;</code> \u66ff\u6362\u60f3\u8981\u4f7f\u7528\u7684\u6807\u7b7e\uff08\u4f8b\u5982\u9ed8\u8ba4\u7684 latest \u6807\u7b7e\uff09\u3002</p> <p>\u7136\u540e\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c06 Docker \u955c\u50cf\u63a8\u9001\u5230 GitHub Container Registry \u5373\u53ef\uff1a</p> <pre><code>docker push ghcr.io/&lt;your-github-username&gt;/&lt;your-image-name&gt;:&lt;tag&gt;\n</code></pre> <p>\u5b8c\u6210\u4ee5\u4e0a\u6b65\u9aa4\u540e\uff0c\u5c31\u53ef\u4ee5\u5728 GitHub \u4e2a\u4eba\u8d26\u53f7\u7684 \u7684 Packages \u90e8\u5206\u770b\u5230 Docker \u955c\u50cf\u4e86\uff0c\u4f46\u662f\u8be5\u955c\u50cf\u9ed8\u8ba4\u4e3a private \u955c\u50cf\uff0cPull \u4f7f\u7528\u65f6\u9700\u8981\u5148\u767b\u5f55</p> <p></p> <pre><code>kubectl create -n argocd secret docker-registry ghcr-secret \\\n  --docker-username=cnych \\\n  --docker-password=$PAT \\\n  --docker-server=\"https://ghcr.io\"\n</code></pre> <p>\u8bbe\u7f6e\u51ed\u636e\u540e\uff0c\u5c06\u5b83\u4eec\u914d\u7f6e\u5728 ArgoCD \u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u7684\u914d\u7f6e\u4e2d\uff0c\u4ee5\u901a\u8fc7\u955c\u50cf\u4ed3\u5e93\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\uff0c\u6211\u4eec\u53ef\u4ee5\u4fee\u6539\u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u7684\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: argocd-image-updater-config\n  namespace: argocd\ndata:\n  registries.conf: |\n    registries:\n      - name: ghcr-hub\n        api_url: https://ghcr.io # \u955c\u50cf\u4ed3\u5e93\u5730\u5740\n        credentials: pullsecret:argocd/ghcr-secret # \u51ed\u636e\n        defaultns: library # \u9ed8\u8ba4\u547d\u540d\u7a7a\u95f4\n        default: true # \u9ed8\u8ba4\u4ed3\u5e93\n</code></pre> <p>\u4e0a\u9762\u914d\u7f6e\u4e2d\u6211\u4eec\u6307\u5b9a\u4e86 GitHub \u955c\u50cf\u4ed3\u5e93\u7684\u51ed\u636e\u4e3a <code>pullsecret:argocd/ghcr-secret</code>\uff0c\u8fd9\u6837 ArgoCD Image Updater \u5728\u8bbf\u95ee ghcr.io \u65f6\u5c31\u4f1a\u4f7f\u7528\u8fd9\u4e2a\u51ed\u636e\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u8fd8\u9700\u8981\u5c06 ArgoCD Image Updater \u4e0e Git \u96c6\u6210\uff0c\u8fd9\u4e5f\u662f\u91cd\u70b9\uff0c\u8fd9\u6837 ArgoCD Image Updater \u5c31\u53ef\u4ee5\u5c06\u955c\u50cf\u66f4\u65b0\u76f4\u63a5\u63d0\u4ea4\u56de\u6e90 Git \u4ed3\u5e93\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728 ArgoCD \u7684 Dashboard \u4e2d\u5148\u6dfb\u52a0\u4e00\u4e2a Git \u4ed3\u5e93 <code>https://github.com/test/k8s-devops-gitops-demo</code>\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u6b63\u5e38\u4f7f\u7528\u65b9\u5f0f\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Application \u5bf9\u8c61\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: gitops-demo\n  namespace: argocd\nspec:\n  destination:\n    namespace: gitops-demo\n    server: https://kubernetes.default.svc\n  project: default\n  source:\n    path: helm # \u4ece Helm \u5b58\u50a8\u5e93\u521b\u5efa\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0cchart \u5fc5\u987b\u6307\u5b9a path\n    repoURL: https://github.com/cnych/k8s-devops-gitops-demo.git\n    targetRevision: master\n    helm:\n      parameters:\n        - name: replicaCount\n          value: \"2\"\n      valueFiles:\n        - my-values.yaml\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n    syncOptions:\n      - CreateNamespace=true\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u540e\uff0cArgoCD \u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a Application \u8d44\u6e90\u5bf9\u8c61\uff0c\u5e76\u4e14\u4f1a\u81ea\u52a8\u540c\u6b65\u5230 Git \u4ed3\u5e93\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Git \u4ed3\u5e93\u4e2d\u770b\u5230\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6</p> <p></p> <p>\u5982\u679c\u8be5\u5e94\u7528\u51fa\u73b0\u4e86\u5982\u4e0b\u6240\u793a\u7684\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>Namespace                gitops-demo                            SyncFailed        resource :Namespace is not permitted in project default\n</code></pre> <p>\u5219\u8868\u9762\u5f53\u524d\u4f7f\u7528\u7684 project \u6ca1\u6709\u6743\u9650\u521b\u5efa namespace\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4e3a\u5176\u6dfb\u52a0\u5bf9\u5e94\u7684\u6743\u9650\u5373\u53ef\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: AppProject\nmetadata:\n  name: default\n  namespace: argocd\nspec:\n  clusterResourceWhitelist: # \u767d\u540d\u5355\uff0c\u8868\u793a\u5141\u8bb8\u8bbf\u95ee\u7684\u8d44\u6e90\n    - group: \"*\"\n      kind: \"*\"\n  destinations:\n    - name: \"*\"\n      namespace: \"*\"\n      server: \"*\"\n  sourceRepos:\n    - \"*\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 argocd app get \u547d\u4ee4\u6765\u67e5\u770b Application \u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\uff1a</p> <pre><code>$ argocd app get argocd/gitops-demo\nName:               argocd/gitops-demo\nProject:            default\nServer:             https://kubernetes.default.svc\nNamespace:          gitops-demo\nURL:                https://grpc.argocd.k8s.local/applications/gitops-demo\nSource:\n- Repo:             https://github.com/cnych/k8s-devops-gitops-demo.git\n  Target:           master\n  Path:             helm\n  Helm Values:      my-values.yaml\nSyncWindow:         Sync Allowed\nSync Policy:        Automated (Prune)\nSync Status:        Synced to master (53d91ed)\nHealth Status:      Progressing\n\nGROUP              KIND        NAMESPACE    NAME                        STATUS     HEALTH       HOOK  MESSAGE\n                   Namespace                gitops-demo                 Running    Synced             namespace/gitops-demo created\napps               Deployment  default      gitops-demo-helm-guestbook  Succeeded  Pruned             pruned\n                   Service     default      gitops-demo-helm-guestbook  Succeeded  Pruned             pruned\n                   Service     gitops-demo  gitops-demo-devops-demo     Synced     Healthy            service/gitops-demo-devops-demo created\napps               Deployment  gitops-demo  gitops-demo-devops-demo     Synced     Progressing        deployment.apps/gitops-demo-devops-demo created\nnetworking.k8s.io  Ingress     gitops-demo  gitops-demo-devops-demo     Synced     Progressing        ingress.networking.k8s.io/gitops-demo-devops-demo created\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u8981\u5728\u76ee\u6807\u547d\u540d\u7a7a\u95f4\u4e2d\u6dfb\u52a0 Image Pull Secret\u3002</p> <p>\u6b63\u5e38\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528\u5c31\u53ef\u4ee5\u8fd0\u884c\u4e86\uff1a</p> <pre><code>$ curl http://gitops-demo.k8s.local/\n{\"msg\":\"Hello Tekton On GitLab With ArgoCD\"}\n</code></pre> <p>\u4f46\u662f\u5728 Dashboard \u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5e94\u7528\u867d\u7136\u5df2\u7ecf\u662f Synced \u72b6\u6001\uff0c\u4f46\u662f APP HEALTH \u4e00\u76f4\u663e\u793a\u4e3a Progressing \u72b6\u6001\u3002</p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a ArgoCD \u7684\u5065\u5eb7\u72b6\u6001\u673a\u5236\u5f15\u8d77\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6e90\u7801 </p> <p>https://github.com/argoproj/gitops-engine/blob/master/pkg/health/health_ingress.go#L7</p> <p>\u4e2d\u770b\u5230\u5065\u5eb7\u72b6\u6001\u7684\u68c0\u67e5\u903b\u8f91\u3002</p> <pre><code>func getIngressHealth(obj *unstructured.Unstructured) (*HealthStatus, error) {\n ingresses, _, _ := unstructured.NestedSlice(obj.Object, \"status\", \"loadBalancer\", \"ingress\")\n health := HealthStatus{}\n if len(ingresses) &gt; 0 {\n  health.Status = HealthStatusHealthy\n } else {\n  health.Status = HealthStatusProgressing\n }\n return &amp;health, nil\n}\n</code></pre> <p>\u4ed6\u9700\u8981\u68c0\u67e5 Ingress \u8d44\u6e90\u5bf9\u8c61\u7684 <code>status.loadBalancer.ingress</code> \u5b57\u6bb5\u662f\u5426\u4e3a\u7a7a\uff0c\u5982\u679c\u4e3a\u7a7a\u5219\u8868\u793a\u5065\u5eb7\u72b6\u6001\u4e3a <code>Progressing</code>\uff0c\u5426\u5219\u4e3a Healthy\uff0c\u4f46\u5b9e\u9645\u60c5\u51b5\u5374\u662f\u5e76\u4e0d\u662f\u6240\u6709\u7684 <code>Ingress</code> \u8d44\u6e90\u5bf9\u8c61\u90fd\u4f1a\u81ea\u52a8\u751f\u6210 <code>status.loadBalancer.ingress</code> \u5b57\u6bb5\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c31\u5e76\u6ca1\u6709\u751f\u6210\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e argocd-cm \u7684\u914d\u7f6e\u8d44\u6e90\u6765\u4fee\u6539\u5065\u5eb7\u72b6\u6001\u68c0\u67e5\u903b\u8f91\uff0c\u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u914d\u7f6e\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: argocd-cm\n  namespace: argocd\ndata:\n  resource.customizations: |\n    networking.k8s.io/Ingress:\n      health.lua: |\n        hs = {}\n        if obj.metadata ~= nil and obj.metadata.creationTimestamp ~= nil then\n          hs.status = \"Healthy\"\n          hs.message = \"Ingress \u5df2\u521b\u5efa\"\n        else\n          hs.status = \"Progressing\"\n          hs.message = \"Ingress \u6b63\u5728\u521b\u5efa\u4e2d\"\n        end\n        return hs\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u8868\u793a\u5982\u679c Ingress \u8d44\u6e90\u5bf9\u8c61\u7684 <code>metadata.creationTimestamp</code> \u5b57\u6bb5\u4e0d\u4e3a\u7a7a\uff0c\u5219\u8868\u793a\u5065\u5eb7\u72b6\u6001\u4e3a Healthy\uff0c\u5426\u5219\u4e3a Progressing\uff0c\u66f4\u65b0\u4e0a\u9762\u7684\u914d\u7f6e\u540e\uff0c\u6211\u4eec\u518d\u6b21\u67e5\u770b\u5e94\u7528\u7684\u5065\u5eb7\u72b6\u6001\u5c31\u4f1a\u53d1\u73b0\u5df2\u7ecf\u53d8\u6210\u4e86 Healthy \u72b6\u6001\uff1a</p> <p></p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 ArgoCD Image Updater \u6765\u66f4\u65b0\u955c\u50cf\u4e86\uff0c\u4fee\u6539\u4e0a\u9762\u7684 Application \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u6211\u4eec\u9700\u8981\u6dfb\u52a0\u4e00\u4e9b\u6ce8\u89e3\u6765\u6307\u5b9a\u9700\u8981\u66f4\u65b0\u7684\u955c\u50cf\u89c4\u5219\u7b56\u7565\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: argoproj.io/v1alpha1\nkind: Application\nmetadata:\n  name: gitops-demo\n  namespace: argocd\n  annotations:\n    argocd-image-updater.argoproj.io/image-list: myalias=ghcr.io/cnych/gitops-demo # \u6307\u5b9a\u955c\u50cf\u4ed3\u5e93\n    argocd-image-updater.argoproj.io/myalias.allow-tags: regexp:^.*$ # \u5141\u8bb8\u6240\u6709\u6807\u7b7e\n    argocd-image-updater.argoproj.io/myalias.pull-secret: pullsecret:argocd/ghcr-secret # \u6307\u5b9a\u51ed\u636e\n    argocd-image-updater.argoproj.io/myalias.update-strategy: latest # \u6307\u5b9a\u66f4\u65b0\u7b56\u7565\n    # argocd-image-updater.argoproj.io/myalias.ignore-tags: latest, master # \u6307\u5b9a\u5ffd\u7565\u7684\u6807\u7b7e\n    argocd-image-updater.argoproj.io/write-back-method: git # \u6307\u5b9a\u5199\u56de\u65b9\u6cd5\n    argocd-image-updater.argoproj.io/git-branch: master # \u6307\u5b9a Git \u5206\u652f\n    argocd-image-updater.argoproj.io/myalias.force-update: \"true\" # \u5f3a\u5236\u66f4\u65b0\nspec:\n  destination:\n    namespace: gitops-demo\n    server: https://kubernetes.default.svc\n  project: default\n  source:\n    path: helm # \u4ece Helm \u5b58\u50a8\u5e93\u521b\u5efa\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0cchart \u5fc5\u987b\u6307\u5b9a path\n    repoURL: https://github.com/cnych/k8s-devops-gitops-demo.git\n    targetRevision: master\n    helm:\n      parameters:\n        - name: replicaCount\n          value: \"2\"\n      valueFiles:\n        - my-values.yaml\n  syncPolicy:\n    automated:\n      prune: true\n      selfHeal: true\n    syncOptions:\n      - CreateNamespace=true\n</code></pre> <p>\u8fd9\u4e2a\u65b0\u7684\u8d44\u6e90\u5bf9\u8c61\u4e2d\uff0c\u6211\u4eec\u6dfb\u52a0\u4e86\u4e00\u4e9b\u6ce8\u91ca\uff0c\u8fd9\u4e9b\u6ce8\u91ca\u7528\u4e8e\u914d\u7f6e Argo CD Image Updater\u3002\u8fd9\u4e9b\u914d\u7f6e\u7528\u4e8e\u6307\u5b9a\u81ea\u52a8\u66f4\u65b0\u5bb9\u5668\u955c\u50cf\u7684\u7b56\u7565\u3001\u53c2\u6570\u548c\u76f8\u5173\u4fe1\u606f\u3002\u4ee5\u4e0b\u662f\u5bf9\u8fd9\u4e9b\u6ce8\u91ca\u7684\u8be6\u7ec6\u89e3\u91ca\uff1a</p> <ul> <li><code>argocd-image-updater.argoproj.io/image-list</code>: \u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u5e94\u7528\u4e2d\u4f7f\u7528\u7684\u955c\u50cf\u5217\u8868\u3002</li> <li><code>argocd-image-updater.argoproj.io/allow-tags</code>: \u8fd9\u4e2a\u6ce8\u89e3\u6307\u5b9a\u4e86\u5141\u8bb8\u66f4\u65b0\u7684\u955c\u50cf\u6807\u7b7e\uff0c\u53ef\u4ee5\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u65b9\u5f0f\u3002</li> <li><code>argocd-image-updater.argoproj.io/&lt;alias&gt;.pull-secret</code>: \u8fd9\u4e2a\u6ce8\u89e3\u6307\u5b9a\u4e86\u7528\u4e8e\u62c9\u53d6\u955c\u50cf\u7684 Secret\u3002</li> <li> <p><code>argocd-image-updater.argoproj.io/update-strategy:</code> \u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u955c\u50cf\u66f4\u65b0\u7b56\u7565\u3002\u8fd9\u91cc\u7684\u503c\u662f latest\uff0c\u8868\u793a\u4f7f\u7528\u6700\u65b0\u7684\u955c\u50cf\u6807\u7b7e\u8fdb\u884c\u66f4\u65b0\uff0c\u8fd8\u53ef\u4ee5\u6307\u5b9a\u7684\u503c\u5305\u62ec\uff1adigest\u3001name\u3001semver\u3002</p> <ul> <li>latest: \u4f7f\u7528\u6700\u65b0\u7684\u955c\u50cf\u6807\u7b7e\u8fdb\u884c\u66f4\u65b0\u3002</li> <li>digest: \u4f7f\u7528\u955c\u50cf\u7684 digest \u8fdb\u884c\u66f4\u65b0\u3002</li> <li>name: \u4f7f\u7528\u955c\u50cf\u7684\u540d\u79f0\u8fdb\u884c\u66f4\u65b0\u3002</li> <li>semver: \u4f7f\u7528 semver \u8fdb\u884c\u66f4\u65b0</li> </ul> </li> </ul> <p><code>argocd-image-updater.argoproj.io/write-back-method</code>: \u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u5199\u56de\u65b9\u6cd5\u3002git \u8868\u793a\u5c06\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u5199\u56de\u5230 Git \u4ed3\u5e93\u3002</p> <ul> <li>git: \u5c06\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u5199\u56de\u5230 Git \u4ed3\u5e93\u3002</li> <li>patch: \u4f7f\u7528 kubectl patch \u547d\u4ee4\u66f4\u65b0\u8d44\u6e90\u3002</li> <li> <p>replace: \u4f7f\u7528 kubectl replace \u547d\u4ee4\u66f4\u65b0\u8d44\u6e90\u3002</p> </li> <li> <p><code>argocd-image-updater.argoproj.io/git-branch</code>: \u8fd9\u4e2a\u6ce8\u89e3\u5b9a\u4e49\u4e86\u66f4\u65b0\u540e\u7684\u914d\u7f6e\u5199\u56de\u5230 Git \u4ed3\u5e93\u7684\u5206\u652f\u3002</p> </li> </ul> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u66f4\u65b0 Application \u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u91cd\u65b0\u63a8\u9001\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u5230 GitHub Container Registry \u5373\u53ef\u81ea\u52a8\u89e6\u53d1 ArgoCD Image Updater \u66f4\u65b0\u955c\u50cf\u3002</p> <p>\u6211\u4eec\u66f4\u65b0\u4e0b\u4ed3\u5e93\u4e2d\u7684 main.go \u6587\u4ef6\uff1a</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u6784\u5efa\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u5e76\u63a8\u9001\u5230 GitHub Container Registry\uff1a</p> <pre><code>docker build --platform linux/amd64 -t ghcr.io/cnych/gitops-demo:v0.1.1 .\ndocker push ghcr.io/cnych/gitops-demo:v0.1.1\n</code></pre> <p>\u63a8\u9001\u65b0\u7684\u955c\u50cf\u540e\uff0c\u7136\u540e Argo CD Image Updater \u5c06\u4f1a\u6bcf 2 \u5206\u949f\u4ece\u955c\u50cf\u4ed3\u5e93\u53bb\u68c0\u7d22\u955c\u50cf\u7248\u672c\u53d8\u5316\uff0c\u4e00\u65e6\u53d1\u73b0\u6709\u65b0\u7684\u955c\u50cf\u7248\u672c\uff0c\u5b83\u5c06\u81ea\u52a8\u4f7f\u7528\u65b0\u7248\u672c\u6765\u66f4\u65b0\u96c6\u7fa4\u5185\u5de5\u4f5c\u8d1f\u8f7d\u7684\u955c\u50cf\uff0c\u5e76\u5c06\u955c\u50cf\u7248\u672c\u56de\u5199\u5230 Git \u4ed3\u5e93\u4e2d\u53bb\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b Argo CD Image Updater \u7684\u65e5\u5fd7\u53d8\u5316\uff1a</p> <pre><code>$ kubectl logs -f argocd-image-updater-57b788886d-d4qh5 -n argocd\ntime=\"2024-09-27T06:51:32Z\" level=info msg=\"argocd-image-updater v0.14.0+af844fe starting [loglevel:INFO, interval:2m0s, healthport:8080]\"\ntime=\"2024-09-27T06:51:32Z\" level=warning msg=\"commit message template at /app/config/commit.template does not exist, using default\"\ntime=\"2024-09-27T08:35:39Z\" level=warning msg=\"\\\"latest\\\" strategy has been renamed to \\\"newest-build\\\". Please switch to the new convention as support for the old naming convention will be removed in future versions.\" image_alias=myalias image_name=ghcr.io/cnych/gitops-demo registry_url=ghcr.io\ntime=\"2024-09-27T08:35:40Z\" level=info msg=\"Processing results: applications=1 images_considered=1 images_skipped=0 images_updated=0 errors=0\"\nxxxxxxxxxxxxxxtime=\"2024-09-27T08:37:40Z\" level=info msg=\"Starting image update cycle, considering 1 annotated application(s) for update\"\ntime=\"2024-09-27T08:37:40Z\" level=warning msg=\"\\\"latest\\\" strategy has been renamed to \\\"newest-build\\\". Please switch to the new convention as support for the old naming convention will be removed in future versions.\" image_alias=myalias image_name=ghcr.io/cnych/gitops-demo registry_url=ghcr.io\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"Setting new image to ghcr.io/cnych/gitops-demo:v0.1.1\" alias=myalias application=gitops-demo image_name=cnych/gitops-demo image_tag=latest registry=ghcr.io\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"Successfully updated image 'ghcr.io/cnych/gitops-demo:latest' to 'ghcr.io/cnych/gitops-demo:v0.1.1', but pending spec update (dry run=false)\" alias=myalias application=gitops-demo image_name=cnych/gitops-demo image_tag=latest registry=ghcr.io\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"Committing 1 parameter update(s) for application gitops-demo\" application=gitops-demo\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"Starting configmap/secret informers\"\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"Configmap/secret informer synced\"\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"Initializing https://github.com/cnych/k8s-devops-gitops-demo.git to /tmp/git-gitops-demo1873820104\"\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"secrets informer cancelled\"\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"configmap informer cancelled\"\ntime=\"2024-09-27T08:37:44Z\" level=info msg=\"git fetch origin --tags --force --prune\" dir=/tmp/git-gitops-demo1873820104 execID=acebc\ntime=\"2024-09-27T08:37:46Z\" level=info msg=Trace args=\"[git fetch origin --tags --force --prune]\" dir=/tmp/git-gitops-demo1873820104 operation_name=\"exec git\" time_ms=1640.146246\ntime=\"2024-09-27T08:37:46Z\" level=info msg=\"git config user.name argocd-image-updater\" dir=/tmp/git-gitops-demo1873820104 execID=7ec2d\ntime=\"2024-09-27T08:37:46Z\" level=info msg=Trace args=\"[git config user.name argocd-image-updater]\" dir=/tmp/git-gitops-demo1873820104 operation_name=\"exec git\" time_ms=1.5687190000000002\ntime=\"2024-09-27T08:37:46Z\" level=info msg=\"git config user.email noreply@argoproj.io\" dir=/tmp/git-gitops-demo1873820104 execID=6e796\ntime=\"2024-09-27T08:37:46Z\" level=info msg=Trace args=\"[git config user.email noreply@argoproj.io]\" dir=/tmp/git-gitops-demo1873820104 operation_name=\"exec git\" time_ms=1.688394\ntime=\"2024-09-27T08:37:46Z\" level=info msg=\"git checkout --force master\" dir=/tmp/git-gitops-demo1873820104 execID=403bb\ntime=\"2024-09-27T08:37:46Z\" level=info msg=Trace args=\"[git checkout --force master]\" dir=/tmp/git-gitops-demo1873820104 operation_name=\"exec git\" time_ms=4.522311\ntime=\"2024-09-27T08:37:46Z\" level=info msg=\"git clean -ffdx\" dir=/tmp/git-gitops-demo1873820104 execID=b3f03\ntime=\"2024-09-27T08:37:46Z\" level=info msg=Trace args=\"[git clean -ffdx]\" dir=/tmp/git-gitops-demo1873820104 operation_name=\"exec git\" time_ms=1.429556\ntime=\"2024-09-27T08:37:46Z\" level=info msg=\"git -c gpg.format=openpgp commit -a -F /tmp/image-updater-commit-msg441967746\" dir=/tmp/git-gitops-demo1873820104 execID=0efc6\ntime=\"2024-09-27T08:37:46Z\" level=info msg=Trace args=\"[git -c gpg.format=openpgp commit -a -F /tmp/image-updater-commit-msg441967746]\" dir=/tmp/git-gitops-demo1873820104 operation_name=\"exec git\" time_ms=5.239213\ntime=\"2024-09-27T08:37:46Z\" level=info msg=\"git push origin master\" dir=/tmp/git-gitops-demo1873820104 execID=fcd1f\ntime=\"2024-09-27T08:37:47Z\" level=info msg=Trace args=\"[git push origin master]\" dir=/tmp/git-gitops-demo1873820104 operation_name=\"exec git\" time_ms=1934.14529\ntime=\"2024-09-27T08:37:47Z\" level=info msg=\"Successfully updated the live application spec\" application=gitops-demo\ntime=\"2024-09-27T08:37:47Z\" level=info msg=\"Processing results: applications=1 images_considered=1 images_skipped=0 images_updated=1 errors=0\"\n</code></pre> <p>\u7136\u540e\u5728 Git \u4ed3\u5e93\u4e2d\u6211\u4eec\u4e5f\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u6761\u65b0\u7684 commit \u63d0\u4ea4\u8bb0\u5f55\uff0c\u53ef\u4ee5\u770b\u5230\u5728\u56de\u5199\u65f6\uff0cArgoCD Image Updater \u5e76\u4e0d\u4f1a\u76f4\u63a5\u4fee\u6539\u4ed3\u5e93\u7684 <code>values.yaml</code> \u6587\u4ef6\uff0c\u800c\u662f\u4f1a\u521b\u5efa\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u8986\u76d6 <code>Helm Chart values.yaml</code> \u7684 <code>.argocd-source-devops-demo.yaml</code> \u6587\u4ef6\u3002</p> <p></p> <p>\u81ea\u52a8\u63d0\u4ea4\u53d8\u66f4\u540e\uff0cArgo CD \u5c31\u4f1a\u81ea\u52a8\u540c\u6b65\u90e8\u7f72\u5e94\u7528\u4e86\u3002</p> <p>\u5f53\u7136\u73b0\u5728\u8bbf\u95ee\u5e94\u7528\u7ed3\u679c\u5c31\u662f\u6211\u4eec\u66f4\u6539\u540e\u7684\u5185\u5bb9\u4e86\uff1a</p> <pre><code>$ curl http://gitops-demo.k8s.local/\n{\"msg\":\"Hello ArgoCD With Image Updater\"}\n</code></pre> <p></p> <p>\u53e6\u5916\u6211\u4eec\u53ef\u4ee5\u6ce8\u610f\u5230\u6bcf\u6b21 Git \u63d0\u4ea4\u90fd\u4e0e\u4f5c\u8005\u7684\u59d3\u540d\u548c\u7535\u5b50\u90ae\u4ef6\u5730\u5740\u76f8\u5173\u8054\u3002\u5982\u679c\u672a\u914d\u7f6e\uff0cArgo CD \u955c\u50cf\u66f4\u65b0\u7a0b\u5e8f\u6267\u884c\u7684\u63d0\u4ea4\u5c06\u4f7f\u7528 <code>argocd-image-updater &lt;noreply@argoproj.io&gt;</code> \u4f5c\u4e3a\u4f5c\u8005\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>--git-commit-user</code> \u548c <code>--git-commit-email</code>\u547d\u4ee4\u884c\u5f00\u5173\u8986\u76d6\u4f5c\u8005\uff0c\u6216\u5728 <code>argocd-image-updater-config ConfigMap</code> \u4e2d\u8bbe\u7f6e <code>git.user</code> \u548c <code>git.email</code> \u5373\u53ef\u3002</p> <p>\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u5c06 Argo CD Image Updater \u4f7f\u7528\u7684\u9ed8\u8ba4\u63d0\u4ea4\u6d88\u606f\u66f4\u6539\u4e3a\u9002\u5408\u4f60\u7684\u65b9\u5f0f\u3002\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u6a21\u677f\uff08\u4f7f\u7528 Golang Template\uff09\uff0c\u5e76\u901a\u8fc7\u5c06 <code>argocd-image-updater-config ConfigMap</code> \u4e2d\u7684\u5bc6\u94a5 <code>git.commit-message-template</code> \u8bbe\u7f6e\u4e3a\u6a21\u677f\u7684\u5185\u5bb9\u6765\u4f7f\u5176\u53ef\u7528\uff0c\u4f8b\u5982\uff1a</p> <pre><code>data:\n  git.commit-message-template: |\n    build: automatic update of {{ .AppName }}\n\n    {{ range .AppChanges -}}\n    updates image {{ .Image }} tag '{{ .OldTag }}' to '{{ .NewTag }}'\n    {{ end -}}\n</code></pre> <p>\u6a21\u677f\u4e2d\u63d0\u4f9b\u4e86\u4e24\u4e2a\u9876\u7ea7\u53d8\u91cf\uff1a</p> <ul> <li><code>.AppName</code> \u662f\u6b63\u5728\u66f4\u65b0\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u540d\u79f0</li> <li> <p><code>.AppChanges</code> \u662f\u66f4\u65b0\u6240\u6267\u884c\u7684\u66f4\u6539\u7684\u5217\u8868\u3002\u6b64\u5217\u8868\u4e2d\u7684\u6bcf\u4e2a\u6761\u76ee\u90fd\u662f\u4e00\u4e2a\u7ed3\u6784\u4f53\uff0c\u4e3a\u6bcf\u4e2a\u66f4\u6539\u63d0\u4f9b\u4ee5\u4e0b\u4fe1\u606f\uff1a</p> <ul> <li><code>.Image</code> \u4fdd\u5b58\u5df2\u66f4\u65b0\u56fe\u50cf\u7684\u5168\u540d</li> <li><code>.OldTag</code> \u4fdd\u5b58\u66f4\u65b0\u4e4b\u524d\u7684\u6807\u7b7e\u540d\u79f0\u6216 SHA \u6458\u8981</li> <li><code>.NewTag</code> \u4fdd\u5b58\u66f4\u65b0\u4e3a\u7684\u6807\u7b7e\u540d\u79f0\u6216 SHA \u6458\u8981</li> </ul> </li> </ul>"},{"location":"chap0/1proj/","title":"Project and Repositoires","text":""},{"location":"chap0/1proj/#1-git-repository","title":"1 Git Repository","text":"<ul> <li>Central: Every GitLab project has a shared, central Git repository</li> <li>Tracked: Git repository maintains the history for your project</li> <li>Accessible: Everyone with the access can work on the contents of the repository</li> </ul>"},{"location":"chap0/1proj/#gitlab-project","title":"GitLab Project","text":"<ul> <li>GitLab Project is the entry point for collaboration between teams</li> <li>Every user can create unlimited number of GitLab projects</li> <li>Every GitLab project has a Git repository at its core</li> </ul> <p>Different roles and job profiles, first and foremost being able to provide a repository to work in. </p> <p>On top of the repository, GitLab offers teams and users to create and manage their tasks, tickets, and issues.</p> <p>GitLab offers a web IDE for the developers and engineers to write the code and also to edit the files as needed on the fly.</p> <p>GitLab is a DevOps tool. It enables teams to use DevOps and C/CD pipelines to build,test, and validate the software products that are being developed. </p> <p>GitLab allows code owners, project maintainers, and organization owners to review the code before accepting it in the mainstream project branch.</p> <p>GitLab provides various options for the teams to document their projects apart from iust writing the comments in the source code.</p>"},{"location":"chap0/1proj/#2-creating-a-gitlab-project","title":"2 Creating a GitLab Project","text":"<ul> <li>Blank Project\uff1a Start a project from scratch with an empty Git repository</li> <li>Use a Template  Create a project based on a template made available by GitLab</li> <li>Import a Project Bring an external Git project to GitLab and use GitLab features such as Auto DevOps</li> </ul>"},{"location":"chap0/1proj/#3-updating-the-project","title":"3 Updating the Project","text":"<ul> <li>Tile</li> <li>The topics are the tags that you can use to reflect the category of the project. GitLab offers to explore public</li> <li>Description</li> <li>Avatar</li> </ul>"},{"location":"chap0/1proj/#3-creating-a-templated-project","title":"3 Creating a Templated Project","text":""},{"location":"chap0/1proj/#project-templates","title":"Project Templates","text":"<ul> <li>Templates are provided officially by GitLab for users</li> <li>Templates speed up creation of new projects and repositories</li> </ul> <p>They're also used to reduce the boilerplate code in case a team needs to create multiple projects of the same structure.</p> <ul> <li>Templates are provided officially by GitLab for users</li> <li>Templates speed up creation of new projects and repositories</li> <li>Sources:<ul> <li>https://gitlab.com/gitlab-org/project-templates</li> <li>https://gitlab.com/pages</li> </ul> </li> </ul> <p> </p>"},{"location":"chap0/1proj/#4-importing-a-project","title":"4 Importing a Project","text":"<p>it can be done from an internal source such as from a GitLab project or external Git sources, such as GitHub. GitLab enables you to connect to other cloud-hosted services, such as GitHub, or use authentication to connect to external Git repositories.</p>"},{"location":"chap0/1proj/#import-project-to-gitlab","title":"Import Project to GitLab","text":"<ul> <li>Import from external Git sources</li> <li>Connect cloud-hosted Git providers</li> <li>Use credentials for private and authenticated repositories</li> <li>Importing a repository is not like the Git mirror feature</li> </ul>"},{"location":"chap0/1proj/#5-cloning-the-project","title":"5 Cloning the Project","text":""},{"location":"chap0/1proj/#git-cli","title":"Git CLI","text":"<ul> <li>GitLab Ul provides basic features of Git version control</li> <li>Advanced functionalities require Git CLI</li> <li>Use SSH keys for actions that require trust and authentication</li> <li>Offline development is faster with custom software and processes</li> </ul>"},{"location":"chap0/1proj/#git-clone","title":"Git Clone","text":"<p>Local Copy</p> <p>Git clone copies the repository contents to your own machine</p> <p>Connection</p> <p>Remote connections can be created to synchronize the work</p> <p>Use SSH</p> <p>Git CLI allows authenticating with SSH keys if needed</p>"},{"location":"chap0/1proj/#6-gitlab-groups","title":"6 GitLab Groups","text":""},{"location":"chap0/1proj/#repositories-in-a-project","title":"Repositories in a Project","text":"<ul> <li>A project can only contain a single repository</li> <li>A project requires multiple repositories for different source code</li> <li>Developers and operations work together on a project</li> <li>Hiding the secrets and infrastructure files is harder in a single project</li> </ul> <p>The groups form a collection of the projects that are created for the same business requirements. </p> <p>GitLab groups can be the departments within your organizations, so a group of developers,  a group of infrastructure, and group of  operations. </p> <p>And you can also create cross-departmental groups, such as a group of security and a group of frontend teams. This helps keep every team separate in their own group with their own roles and the permissions as are needed by their iob profiles.</p> <p>But the groups can always interact with each other and follow a unique hierarchy and a pattern that can be used to mimic the structure of the organization.</p>"},{"location":"chap0/1proj/#group-properties","title":"Group Properties","text":"<ul> <li>Different profiles</li> <li>Unique permissions</li> <li>Dedicated members</li> <li>Organizational hierarchy</li> <li>Resource ownership</li> <li>20 levels of subgroups</li> </ul>"},{"location":"chap0/1proj/#creating-a-gitlab-group","title":"Creating a GitLab Group","text":""},{"location":"chap0/1proj/#7-grouping-the-projects","title":"7 Grouping the Projects","text":"<pre><code>https://gitlab.com/projects/new?namespace_id=51247002#create_from_template\n</code></pre> <p>Move an existing project</p> <p></p> <pre><code>git remote add gitlab https://gitlab.com/t8985/hello-world\ngit remote -v\ngitlab  https://gitlab.com/t8985/hello-world (fetch)\ngitlab  https://gitlab.com/t8985/hello-world (push)\n</code></pre> <ul> <li>Git repositories and projects<ul> <li>Creating projects</li> <li>Using project templates</li> </ul> </li> <li>Importing external projects<ul> <li>Projects with credentials</li> </ul> </li> <li>GitLab groups</li> <li>Moving projects between groups</li> </ul>"},{"location":"chap0/4issues/","title":"Gitlab Issues and Timelines","text":""},{"location":"chap0/4issues/#1-overview","title":"1 Overview","text":"<p>GitLab offers visual boards on top of the backlog list of the issues. </p> <p>GitLab Issues</p> <ul> <li>Issues</li> <li>Incidents</li> </ul> <p>Project labels</p> <p>Issue board</p> <ul> <li>Creating boards</li> <li>Moving issues between boards</li> </ul> <p>Project members</p> <p>Milestones</p>"},{"location":"chap0/4issues/#2-gitlab-issues","title":"2 GitLab Issues","text":""},{"location":"chap0/4issues/#2-1-features-of-gitlab-issues","title":"2-1 Features of GitLab Issues","text":"<p>The issues on GitLab are created per project, so each project has its own dedicated space for the issues and incident management. In other systems, you might call them tasks or tickets, such as in Jira.</p> <p>The incidents are provided on top of the issue management system with a few extra details. </p> <p>Another aspect of the issues is that they enable teams to collaborate and discuss on the features and bugs in the project.</p> <p>Everything that happens in an issue ticket is maintained as a timeline based on the date and the time of the activitv. You can fetch this activity from GitLab using RSS feed as needed, or you can integrate with the GitLab API or other third-party solutions that provide nice features, such as Jira for ticket</p> <p>When we create an issue in GitLab instance, we can specify the title, labels, and basic information to explain the main feature or requirements for the ticket. </p> <p>Once created, or when we are creating, we can always include collaborators.</p> <p>GitLab also enables organizations to provide the list of owners who can review each contribution for a feature last but a very important feature. Being that every issue can be added to a milestone that helps track the work</p>"},{"location":"chap0/4issues/#2-2-demo","title":"2-2 Demo","text":"<p>Create an issue</p> <ul> <li>Provide title</li> <li>Describe the issue</li> <li>Assign to yourself</li> </ul> <p></p> <p>You can import issues from Jira by enabling the integration between Jira and GitLab. GitLab helps you receive issues and incidents by email</p> <p></p>"},{"location":"chap0/4issues/#3-gitlab-labels","title":"3 GitLab Labels","text":"<p>GitLab provides an interesting feature called labels, which are a nice way to categorize the content within your projects.</p> <p>The Git Lab labels are used to create a nice scope around your content.</p> <p>For example, they're a nice way to categorize your issues, such as the front-end issues or the back-end issues or the issues for the infrastructure teams to look into. </p> <p>And GitLab uses the labels to create the columns for your issue boards in the projects as well. </p>"},{"location":"chap0/4issues/#demo","title":"Demo","text":"<p>In this demonstration, we will create the labels in a GitLab project. We will learn how to create the default labels for a project that GitLab provides. </p> <p>You see a button to create a new label and also a button to generate default labels.</p>"},{"location":"chap0/4issues/#4-issue-board","title":"4 Issue Board","text":"<p>Let's learn about the issue boards that GitLab offers. The issue boards are a nice feature of GitLab that offers teams with the capabilities to manage the projects.</p>"},{"location":"chap0/4issues/#purpose-of-gitlab-labels","title":"Purpose of GitLab Labels","text":"<ul> <li> <p>Scope</p> <ul> <li>Define scoped areas of focus within your GitLab organization</li> </ul> </li> <li> <p>Categorization</p> <ul> <li>Group together similar issues for a better management</li> </ul> </li> <li> <p>Issue boards</p> <ul> <li>Define the columns where the issues reside in Issue board.</li> </ul> </li> </ul> <p>Think of kanban boards, for example. The boards are powered by the labels and your issues, and the issues move from one column in the swim lane to another based on the changes in the labels.</p> <p>The boards also help with the milestones and timeline </p> <p>The boards can be created for each team separately so everyone can work on their own tasks,</p>"},{"location":"chap0/4issues/#demo_1","title":"Demo","text":"<ul> <li>Exploring the board</li> <li>Moving the issues</li> </ul> <p>In this demonstration, we will learn about the boards, how to access the board. and some areas around it. We will also learn how to move the issues between the columns on a board.</p> <p>By default, GitLab takes you to the backlog page where you can see the list of the active and open issues available in the project.</p> <p></p> <p>Edit Board</p> <p></p> <p>Add labels to list of board</p> <p></p>"},{"location":"chap0/4issues/#5-inviting-members-to-project","title":"5 Inviting Members to Project","text":"<p>Let's learn how to invite members to our projects. we will learn how to invite new members to our project using their email addresses or their usernames on GitLab.</p> <p>We will also learn how do we define the roles for the users that we invite to the projects. Open the project and select the Members menu </p> <p></p> <p>We can invite a member to the group using the Invite members button </p> <p></p>"},{"location":"chap0/4issues/#6-working-on-issues","title":"6 Working on Issues","text":"<p>Now, let's learn how to work on the issues with our teams in a collaborative manner. </p>"},{"location":"chap0/4issues/#demo_2","title":"Demo","text":"<p>In this demonstration, we will learn how to change the assignees on the issues. </p> <ul> <li>We will also learn how to update the labels on the issue. </li> <li>Then, we will learn how to leave comments on the issues, such as our feedback, questions, or suggestions,</li> </ul> <p></p>"},{"location":"chap0/4issues/#7-milestones","title":"7 Milestones","text":"<p>Milestones are a great way of tracking the work and keeping timelines active in a project. </p> <p>The milestones are a part of the team planning as they work on the features of the project.</p> <p>Milestones, however, do not contain everything that a project needs worked on.  Each milestone aims to collect a set of the issues and focus on them only.</p> <p>Milestones can be labeled as the quarterly releases or the version number that is being aimed for.</p>"},{"location":"chap0/4issues/#using-milestones","title":"Using Milestones","text":"<ul> <li>Team Planning: Work closely with stakeholders for business planning</li> <li>Prioritize Work: Focus on the issues and tickets for upcoming milestones</li> <li>Create Releases:  Publish releases for the milestones and work done</li> </ul> <p>Once your milestone is complete, everything from that milestone can be built,validated, packaged, and shipped to market for your customers to use.</p>"},{"location":"chap0/4issues/#demo_3","title":"Demo","text":"<p>In this demonstration, we will create a milestone and see what GitLab offers.</p> <p></p> <p>The Milestone page on GitLab offers an interesting insight in how the project is being developed. It shows Upcoming because this milestone has not yet begun.</p> <p>At the time of this recording, the milestone was still a few days behind the start date. It shows the percentage of the completion based on the issues in the milestone.</p> <p>It also shows how many issues this milestone has and how many of them are open or closed. we have the merge requests for this milestone and if there were any releases created with this milestone.</p> <p>The main canvas for the milestone shows the charts that are useful to see how the team works. </p> <p></p> <p>In the below, It shows how many issues are open and how much work has been done.</p> <p></p> <p>You have a list of the participating issues and any merge requests.</p> <p></p> <p>This helps identify and categorize the issues based on their milestone, and you can easily filter the issues for a specific milestone. </p> <p></p>"},{"location":"chap0/4issues/#8-service-desk","title":"8 Service Desk","text":"<p>Let's explore how to engage our customers. The Service Desk is a nice feature of GitLab that offers organizations to use an email address where customers can send their issues and complaints for your project. </p> <p>This feature does not require integrations or configurations on your or your customers part as this is just an email address, but it is always better to avoid being spammed on this address so proceed with caution and do not publish it outside without unnecessary need.</p> <p>GitLab would collect and centralize all the incidents and issues in a single place for your project.</p>"},{"location":"chap0/4issues/#service-desk","title":"Service Desk","text":"<ul> <li>Customer Service:  GitLab enables businesses to capture feedback continuously</li> <li>No Integrations:   Service Desk uses email messages, thus no integration is required</li> <li>Centralize:   Bring the feedback closer to the teams, with issues and incidents</li> </ul> <p>We will send an email to the address and also assign someone to the work.</p> <p></p> <p></p> <p></p> <p></p> <p>If you submit any changes to this issue, the email address would receive a notification automatically so you do not need to reach out to the person via email directly.</p>"},{"location":"chap1/1gitlab_cicd/","title":"1 Gitlab \u57fa\u672c\u4ecb\u7ecd\uff08CI/CD)","text":""},{"location":"chap1/1gitlab_cicd/#1","title":"1 \u4f20\u7edf\u5e94\u7528\u53d1\u5e03\u6a21\u5f0f","text":"<p>1 \u5f00\u53d1\u56e2\u961f </p> <p>\u5728\u5f00\u53d1\u73af\u5883\u4e2d\u5b8c\u6210\u8f6f\u4ef6\u5f00\u53d1\uff0c\u5355\u5143\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u901a\u8fc7\uff0c\u63d0\u4ea4\u5230\u4ee3\u7801\u7248\u672c\u7ba1\u7406\u5e93\u3002</p> <p>2 \u8fd0\u7ef4\u56e2\u961f </p> <p>\u628a\u5e94\u7528\u90e8\u7f72\u5230\u6d4b\u8bd5\u73af\u5883\uff0c\u4f9bQA\u56e2\u961f\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u901a\u8fc7\u540e\u90e8\u7f72\u751f\u4ea7\u73af\u5883\u3002 </p> <p>3 QA\u56e2\u961f</p> <p>\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u901a\u8fc7\u540e\u901a\u77e5\u90e8\u7f72\u4eba\u5458\u53d1\u5e03\u5230\u751f\u4ea7\u73af\u5883\u3002 </p>"},{"location":"chap1/1gitlab_cicd/#2","title":"2 \u9762\u4e34\u6311\u6218","text":"<p>1 \u9519\u8bef\u53d1\u73b0\u4e0d\u53ca\u65f6</p> <p>\u5f88\u591a\u9519\u8bef\u5728\u9879\u76ee\u7684\u65e9\u671f\u53ef\u80fd\u5c31\u5b58\u5728\uff0c\u5230\u6700\u540e\u96c6\u6210\u7684\u65f6\u5019\u624d\u53d1\u73b0\u95ee\u9898\u3002 </p> <p>2 \u4eba\u5de5\u4f4e\u7ea7\u9519\u8bef\u53d1\u751f</p> <p>\u4ea7\u54c1\u548c\u670d\u52a1\u4ea4\u4ed8\u4e2d\u7684 \u5173\u952e\u6d3b\u52a8\u5168\u90fd\u9700\u8981\u624b\u52a8\u64cd\u4f5c\u3002</p> <p>3 \u56e2\u961f\u5de5\u4f5c\u6548\u7387\u4f4e</p> <p>\u9700\u8981\u7b49\u5f85\u4ed6\u4eba\u7684\u5de5\u4f5c \u5b8c\u6210\u540e\u624d\u80fd\u8fdb\u884c\u81ea\u5df1\u7684\u5de5\u4f5c\u3002 </p> <p>4 \u5f00\u53d1\u8fd0\u7ef4\u5bf9\u7acb</p> <p>\u5f00\u53d1\u4eba\u5458\u60f3\u8981\u5feb\u901f\u66f4\u65b0\uff0c\u8fd0\u7ef4\u4eba\u5458\u8ffd\u6c42\u7a33\u5b9a\uff0c\u5404\u81ea\u7684\u9488\u5bf9\u7684\u65b9\u5411\u4e0d\u540c </p>"},{"location":"chap1/1gitlab_cicd/#3-cicd","title":"3 CI/CD","text":""},{"location":"chap1/1gitlab_cicd/#ci","title":"\u6301\u7eed\u96c6\u6210\uff08CI\uff09","text":"<p>\u6301\u7eed\u96c6\u6210(Continuous integration\uff0c\u7f29\u5199\u4e3a CI)\u662f\u4e00\u79cd\u8f6f\u4ef6\u5f00\u53d1\u5b9e\u8df5\uff0c\u56e2\u961f \u5f00\u53d1\u6210\u5458\u7ecf\u5e38\u96c6\u6210\u4ed6\u4eec\u7684\u5de5\u4f5c\u3002\u5229\u7528\u81ea\u52a8\u6d4b\u8bd5\u6765\u9a8c\u8bc1\u5e76\u65ad\u8a00\u5176\u4ee3\u7801\u4e0d\u4f1a\u4e0e\u73b0\u6709\u4ee3\u7801\u5e93\u4ea7\u751f\u51b2\u7a81\u3002</p> <p>\u7406\u60f3\u60c5\u51b5\u4e0b\uff0c\u4ee3\u7801\u66f4\u6539\u5e94\u8be5\u6bcf\u5929\u5728 CI \u5de5\u5177\u7684\u5e2e\u52a9\u4e0b\uff0c\u5728\u6bcf\u6b21\u63d0\u4ea4\u65f6\u8fdb \u884c\u81ea\u52a8\u5316\u6784\u5efa(\u5305\u62ec\u7f16\u8bd1\uff0c\u53d1\u5e03\uff0c\u81ea\u52a8\u5316\u6d4b\u8bd5)\uff0c\u4ece\u800c\u5c3d\u65e9\u5730\u53d1\u73b0\u96c6\u6210\u9519\u8bef\uff0c\u4ee5\u786e \u4fdd\u5408\u5e76\u7684\u4ee3\u7801\u6ca1\u6709\u7834\u574f\u4e3b\u5206\u652f\u3002</p> <p>Continuous integration (CI for short) is a software development practice in which team development members frequently integrate their work. Utilize automated tests to verify and assert that their code does not conflict with existing codebases. Ideally, code changes should be automated on a daily basis with the help of CI tools, with automated builds (including compile, release, automated tests) on each commit, to catch integration errors early enough to ensure that the merged code doesn't break the master branch</p> <ul> <li>\u5408\u5e76\u5f00\u53d1\u4eba\u5458\u6b63\u5728\u5f00\u53d1\u7f16\u5199\u7684\u6240\u6709\u4ee3\u7801\u7684\u4e00\u79cd\u505a\u6cd5\u3002 </li> <li>\u901a\u5e38\u4e00\u5929\u5185\u8fdb\u884c\u591a\u6b21\u5408\u5e76\u548c\u63d0\u4ea4\u4ee3\u7801\u3002 </li> <li>\u4ece\u5b58\u50a8\u5e93\u6216\u751f\u4ea7\u73af\u5883\u4e2d\u8fdb\u884c\u6784\u5efa\u548c\u81ea\u52a8\u5316\u6d4b\u8bd5\uff0c\u4ee5\u786e\u4fdd\u6ca1\u6709\u96c6\u6210\u95ee\u9898\u5e76\u6bd5\u53d1\u73b0\u4efb\u4f55\u95ee\u9898\u3002</li> </ul>"},{"location":"chap1/1gitlab_cicd/#cd","title":"\u8fde\u7eed\u4ea4\u4ed8\uff08CD)","text":"<p>\u6301\u7eed\u4ea4\u4ed8(Continuous delivery\uff0c\u7f29\u5199\u4e3a CD)\u4ee5\u53ca\u6301\u7eed\u96c6\u6210\u4e3a\u4ea4\u4ed8\u4ee3\u7801\u5305\u63d0 \u4f9b\u4e86\u5b8c\u6574\u7684\u6d41\u7a0b\u3002</p> <p>\u5728\u6b64\u9636\u6bb5\uff0c\u5c06\u4f7f\u7528\u81ea\u52a8\u6784\u5efa\u5de5\u5177\u6765\u7f16\u8bd1\u5de5\u4ef6\uff0c\u5e76\u4f7f\u5176\u51c6\u5907\u597d\u4ea4\u4ed8 \u7ed9\u6700\u7ec8\u7528\u6237\u3002\u5b83\u7684\u76ee\u6807\u5728\u4e8e\u8ba9\u8f6f\u4ef6\u7684\u6784\u5efa\u3001\u6d4b\u8bd5\u4e0e\u53d1\u5e03\u53d8\u5f97\u66f4\u5feb\u4ee5\u53ca\u66f4\u9891\u7e41\u3002\u8fd9\u79cd \u65b9\u5f0f\u53ef\u4ee5\u51cf\u5c11\u8f6f\u4ef6\u5f00\u53d1\u7684\u6210\u672c\u4e0e\u65f6\u95f4\uff0c\u51cf\u5c11\u98ce\u9669\u3002</p> <ul> <li>\u901a\u5e38\u53ef\u4ee5\u901a\u8fc7\u5c06\u66f4\u6539\u81ea\u52a8\u63a8\u9001\u5230\u53d1\u5e03\u7cfb\u7edf\u6765\u968f\u65f6\u5c06\u8f6f\u4ef6\u53d1\u5e03\u5230\u751f\u4ea7\u73af\u5883\u4e2d\u3002 </li> <li>\u6301\u7eed\u90e8\u7f72\u4f1a\u66f4\u8fdb\u4e00\u6b65\uff0c\u5e76\u81ea\u52a8\u5c06\u66f4\u6539\u63a8\u9001\u5230\u751f\u4ea7\u4e2d\u3002 </li> </ul> <p>Continuous delivery (CD) and continuous integration provide a complete process for delivering code packages. At this stage, automated build tools are used to compile the artifacts and make them ready for delivery to end users. Its goal is to make software build, test, and release faster and more frequently. This approach can reduce the cost and time of software development and reduce risks.</p>"},{"location":"chap1/1gitlab_cicd/#cd_1","title":"\u8fde\u7eed\u4ea4\u4ed8\uff08CD)","text":"<p>\u6301\u7eed\u90e8\u7f72(Continuous deployment)\u901a\u8fc7\u96c6\u6210\u65b0\u7684\u4ee3\u7801\u66f4\u6539\u5e76\u5c06\u5176\u81ea\u52a8\u4ea4\u4ed8 \u5230\u53d1\u5e03\u5206\u652f\uff0c\u4ece\u800c\u5c06\u6301\u7eed\u4ea4\u4ed8\u63d0\u5347\u5230\u4e00\u4e2a\u65b0\u7684\u6c34\u5e73\u3002</p> <p>\u66f4\u5177\u4f53\u5730\u8bf4\uff0c\u4e00\u65e6\u66f4\u65b0\u901a\u8fc7\u4e86 \u751f\u4ea7\u6d41\u7a0b\u7684\u6240\u6709\u9636\u6bb5\uff0c\u4fbf\u5c06\u5b83\u4eec\u76f4\u63a5\u90e8\u7f72\u5230\u6700\u7ec8\u7528\u6237\uff0c\u800c\u65e0\u9700\u4eba\u5de5\u5e72\u9884\u3002\u56e0\u6b64\uff0c\u8981 \u6210\u529f\u5229\u7528\u8fde\u7eed\u90e8\u7f72\uff0c\u8f6f\u4ef6\u5de5\u4ef6\u5fc5\u987b\u5148\u7ecf\u8fc7\u4e25\u683c\u5efa\u7acb\u7684\u81ea\u52a8\u5316\u6d4b\u8bd5\u548c\u5de5\u5177\uff0c\u7136\u540e\u624d\u80fd \u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e2d\u3002</p> <p>Continuous deployment takes continuous delivery to the next level by integrating new code changes and automatically delivering them to release branches. More specifically, once updates have passed all stages of the production process, they are deployed directly to end users without human intervention. Therefore, to successfully leverage continuous deployment, software artifacts must undergo rigorously established automated testing and tooling before they can be deployed into production.</p>"},{"location":"chap1/1gitlab_cicd/#4-ci-jenkins","title":"4 CI-Jenkins","text":"<ul> <li>\u53ef\u6269\u5c55\u81ea\u52a8\u5316\u670d\u52a1\u5668  </li> <li>\u5b89\u88c5\u914d\u7f6e\u7b80\u5355 </li> <li>\u4e30\u5bcc\u7684\u63d2\u4ef6\u5e93 </li> <li>\u5206\u5e03\u5f0f\u67b6\u6784\u8bbe\u8ba1 </li> <li>\u652f\u6301\u6240\u6709\u7684\u5e73\u53f0 </li> <li>\u53ef\u89c6\u5316\u7684\u7ba1\u7406\u9875\u9762 </li> </ul>"},{"location":"chap1/1gitlab_cicd/#5-gitlab","title":"5 \u4ee3\u7801\u7248\u672c\u7ba1\u7406\u2014\u2014Gitlab","text":"<p>\u4ee3\u7801\u5ba1\u67e5  / \u95ee\u9898\u8ddf\u8e2a  / \u52a8\u6001\u8ba2\u9605 / \u6613\u4e8e\u6269\u5c55 / \u9879\u76eewiki / \u591a\u89d2\u8272\u9879\u76ee\u7ba1\u7406  / \u9879\u76ee\u4ee3\u7801\u5728\u7ebf\u9884\u89c8  / CI\u5de5\u5177\u96c6\u6210</p> <p></p>"},{"location":"chap1/1gitlab_cicd/#1-ci","title":"1 \u6301\u7eed\u96c6\u6210\uff08CI)","text":"<ul> <li>\u96c6\u6210\u56e2\u961f\u4e2d\u6bcf\u4e2a\u5f00\u53d1\u4eba\u5458\u63d0\u4ea4\u7684\u4ee3\u7801\u5230\u4ee3\u7801\u5b58\u50a8\u5e93\u4e2d\u3002 </li> <li>\u5f00\u53d1\u4eba\u5458\u5728Merge\u6216\u8005Pull\u8bf7\u6c42\u4e2d\u5408\u5e76\u62c9\u53d6\u65b0\u4ee3\u7801\u3002 </li> <li>\u5728\u63d0\u4ea4\u6216\u8005\u5408\u73af\u66f4\u6539\u5230\u4ee3\u7801\u5b58\u50a8\u5e93\u4e4b\u524d\uff0c\u4f1a\u89e6\u53d1\u4e86\u6784\u5efa\uff0c\u6d4b\u8bd5\u548c\u65b0\u4ee3\u7801\u9a8c\u8bc1\u7684\u7ba1\u9053\u3002 </li> <li>CI\u53ef\u5e2e\u52a9\u60a8\u5728\u5f00\u53d1\u5468\u671f\u7684\u65e9\u671f\u53d1\u73b0\u5e76\u51cf\u5c11\u9519\u8bef </li> </ul>"},{"location":"chap1/1gitlab_cicd/#2-cd","title":"2 \u6301\u7eed\u4ea4\u4ed8\uff08CD)","text":"<ul> <li>\u53ef\u901a\u8fc7\u7ed3\u6784\u5316\u7684\u90e8\u7f72\u7ba1\u9053\u786e\u4fdd\u5c06\u7ecf\u8fc7CI\u9a8c\u8bc1\u7684\u4ee3\u7801\u4ea4\u4ed8\u7ed9\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u3002</li> <li>CD\u53ef\u4ee5\u5c06\u7ecf\u8fc7\u9a8c\u8bc1\u7684\u4ee3\u7801\u66f4\u5feb\u5730\u79fb\u81f3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u3002 </li> </ul> <p>CI/CD \u4e00\u8d77\u53ef\u4ee5\u52a0\u5feb\u56e2\u961f\u4e3a\u5ba2\u6237\u548c\u5229\u76ca\u76f8\u5173\u8005\u4ea4\u4ed8\u6210\u679c\u7684\u901f\u5ea6\u3002CI\u548cCD\u5fc5\u987b\u65e0\u7f1d\u534f\u4f5c\uff0c\u4ee5\u4f7f\u60a8\u7684\u56e2\u961f\u5feb\u901f\u6709\u6548\u8fdb\u884c\u6784\u5efa\uff0c\u5e76\u4e14\u5bf9\u4e8e\u786e\u4fdd\u5b8c\u5168\u4f18\u5316\u7684\u5f00\u53d1\u5b9e\u8df5\u81f3\u5173\u91cd\u8981\u3002</p>"},{"location":"chap1/1gitlab_cicd/#3-gitlab-cicd","title":"3 Gitlab CI/CD \u4f18\u52bf","text":"<ul> <li>\u5f00\u6e90\uff1aCI/CD\u662f\u5f00\u6e90GitLab\u793e\u533a\u7248\u548c\u4e13\u6709GitLab\u4f01\u4e1a\u7248\u7684\u4e00\u90e8\u5206\u3002 </li> <li>\u6613\u4e8e\u5b66\u4e60\uff1a\u5177\u6709\u8be6\u7ec6\u7684\u5165\u95e8\u6587\u6863\u3002 </li> <li>\u65e0\u7f1d\u96c6\u6210\uff1aGitLab CI/CD \u662fGitLab\u7684\u4e00\u90e8\u5206\uff0c\u652f\u6301\u4ece\u8ba1\u5212\u5230\u90e8\u7f72\uff0c\u5177\u6709\u51fa\u8272\u7684\u7528\u6237\u4f53\u9a8c\u3002 </li> <li>\u53ef\u6269\u5c55\uff1a\u6d4b\u8bd5\u53ef\u4ee5\u5728\u5355\u72ec\u7684\u8ba1\u7b97\u673a\u4e0a\u5206\u5e03\u5f0f\u8fd0\u884c\uff0c\u53ef\u4ee5\u6839\u636e\u9700\u8981\u6dfb\u52a0\u4efb\u610f\u6570\u91cf\u7684\u8ba1\u7b97\u673a\u3002 </li> <li>\u66f4\u5feb\u7684\u7ed3\u679c\uff1a\u6bcf\u4e2a\u6784\u5efa\u53ef\u4ee5\u62c6\u5206\u4e3a\u591a\u4e2a\u4f5c\u4e1a\uff0c\u8fd9\u4e9b\u4f5c\u4e1a\u53ef\u4ee5\u5728\u591a\u53f0\u8ba1\u7b97\u673a\u4e0a\u5e76\u884c\u8fd0\u884c\u3002 </li> <li>\u9488\u5bf9\u4ea4\u4ed8\u8fdb\u884c\u4e86\u4f18\u5316\uff1a\u591a\u4e2a\u9636\u6bb5\uff0c\u624b\u52a8\u90e8\u7f72\uff0c\u73af\u5883\u548c\u53d8\u91cf\u3002 </li> </ul>"},{"location":"chap1/1gitlab_cicd/#4-gitlab-cicd","title":"4 Gitlab CI/CD \u7ec4\u4ef6","text":"<p>GitLab CI/CD</p> <ul> <li>GitLab\u7684\u4e00\u90e8\u5206\uff0cGitLab\u662f\u4e00\u4e2aWeb\u5e94\u7528\u7a0b\u5e8f\uff0c\u5177\u6709\u5c06\u5176\u72b6\u6001\u5b58\u50a8\u5728\u6570\u636e\u5e93\u4e2d\u7684API</li> <li>\u9664\u4e86GitLab\u7684\u6240\u6709\u529f\u80fd\u4e4b\u5916\uff0c\u5b83\u8fd8\u7ba1\u7406\u9879\u76ee\uff0f\u6784\u5efa\u5e76\u63d0\u4f9b\u4e00\u4e2a\u4e0d\u9519\u7684\u7528\u6237\u754c\u9762\u3002 </li> </ul> <p>GitLab Runner </p> <ul> <li>\u662f\u4e00\u4e2a\u5904\u7406\u6784\u5efa\u7684\u5e94\u7528\u7a0b\u5e8f\u3002 </li> <li>\u5b83\u53ef\u4ee5\u5355\u72ec\u90e8\u7f72\uff0c\u5e76\u901a\u8fc7API\u4e0eGitLab CI/CD\u4e00\u8d77\u4f7f\u7528\u3002 </li> </ul> <p><code>.gitlab-ci.yml</code></p> <p>\u4e3a\u4e86\u8fd0\u884c\u6d4b\u8bd5\uff0c\u81f3\u5c11\u9700\u8981\u4e00\u4e2aGitLab\u5b9e\u4f8b\u548c\u4e00\u4e2aGitLab Runner\u3002</p> <p></p>"},{"location":"chap1/1gitlab_cicd/#5-gitlab-cicd","title":"5 Gitlab CI/CD \u7ec4\u4ef6","text":"<ul> <li>\u591a\u5e73\u53f0\uff1aUnix, Windows, macOS\u548c\u4efb\u4f55\u5176\u4ed6\u652f\u6301Go\u7684\u5e73\u53f0\u4e0a\u6267\u884c\u6784\u5efa\u3002 * \u591a\u8bed\u8a00\uff1a\u6784\u5efa\u811a\u672c\u662f\u547d\u4ee4\u884c\u9a71\u52a8\u7684\uff0c\u5e76\u4e14\u53ef\u4ee5\u4e0eJava, PHP, Ruby, C\u548c\u4efb\u4f55\u5176\u4ed6\u8bed\u8a00\u4e00\u534e\u4f7f\u7528\u3002 </li> <li>\u7a33\u5b9a\u6784\u5efa\uff1a\u6784\u5efa\u5728\u4e0eGitLab\u4e0d\u540c\u7684\u673a\u5668\u4e0a\u8fd0\u884c\u3002 </li> <li>\u5e76\u884c\u6784\u5efa\uff1aGitLab CI/CD\u5728\u591a\u53f0\u673a\u5668\u4e0a\u62c6\u5206\u6784\u5efa\uff0c\u4ee5\u5b9e\u73b0\u5feb\u901f\u6267\u884c\u3002 </li> <li>\u5b9e\u65f6\u65e5\u5fd7\u8bb0\u5f55\uff1a\u5408\u5e76\u8bf7\u6c42\u4e2d\u7684\u94fe\u63a5\u5c06\u60a8\u5e26\u5230\u52a8\u6001\u66f4\u65b0\u7684\u5f53\u524d\u6784\u5efa\u65e5\u5fd7\u3002 </li> <li>\u7075\u6d3b\u7684\u7ba1\u9053\uff1a\u60a8\u53ef\u4ee5\u5728\u6bcf\u4e2a\u9636\u6bb5\u5b9a\u4e49\u591a\u4e2a\u5e76\u884c\u4f5c\u4e1a\uff0c\u5e76\u4e14\u53ef\u4ee5\u89e6\u53d1\u5176\u4ed6\u6784\u5efa\u3002 </li> <li>\u7248\u672c\u7ba1\u9053\uff1a\u4e00\u4e2a<code>.gitlab-ci.yml</code>\u6587\u4ef6\u5305\u542b\u60a8\u7684\u6d4b\u8bd5\uff0c\u6574\u4e2a\u8fc7\u7a0b\u7684\u6b65\u9aa4\uff0c\u4f7f\u6bcf\u4e2a\u4eba\u90fd\u80fd\u8d21\u732e\u66f4\u6539\uff0c \u652f\u83b7\u5f97\u6240\u9700\u7684\u7ba1\u9053\u3002 </li> </ul>"},{"location":"chap1/1gitlab_cicd/#6-gitlab-cicd","title":"6 Gitlab CI/CD \u7279\u70b9","text":"<ul> <li>\u81ea\u52a8\u7f29\u653e\uff1a\u60a8\u53ef\u4ee5\u81ea\u52a8\u7f29\u653e\u6784\u5efa\u673a\u5668\uff0c\u4ee5\u786e\u4fdd\u7acb\u5373\u5904\u7406\u60a8\u7684\u6784\u5efa\u5e76\u5c06\u6210\u672c\u964d\u81f3\u6700\u4f4e\u3002 </li> <li>\u6784\u5efa\u5de5\u4ef6\uff1a\u60a8\u53ef\u4ee5\u5c06\u4e8c\u8fdb\u5236\u6587\u4ef6\u811a\u5176\u4ed6\u6784\u5efa\u5de5\u4ef6\u4e0a\u8f7d\u5230GitLab\u5e76\u6d4f\u89c8\u548c\u4e0b\u8f7d\u5b83\u4eec\u3002 </li> <li>Docker\u652f\u6301\uff1a\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u4e49Docker\u6620\u50cf\uff0c\u4f5c\u4e3a\u6d4b\u8bd5\u7684\u4e00\u90e8\u5206\u542f\u52a8\u670d\u52a1\uff0c\u6784\u5efa\u65b0\u7684Docker\u6620\u50cf\uff0c\u751a\u81f3\u53ef\u4ee5\u5728 Kubernetes\u4e0a\u8fd0\u884c\u3002 </li> <li>\u5bb9\u5668\u6ce8\u518c\u8868\uff1a\u5185\u7f6e\u7684\u5bb9\u5668\u6ce8\u518c\u8868\uff0c\u7528\u4e8e\u5b58\u50a8\uff0c\u5171\u4eab\u548c\u4f7f\u7528\u5bb9\u5668\u6620\u50cf\u3002 </li> <li>\u53d7\u4fdd\u62a4\u7684\u53d8\u91cf\uff1a\u5728\u90e8\u7f72\u671f\u95f4\u4f7f\u7528\u53d7\u6bcf\u4e2a\u73af\u5883\u4fdd\u62a4\u7684\u53d8\u91cf\u5b89\u5168\u5730\u5b58\u50a8\u548c\u4f7f\u7528\u673a\u5bc6\u3002 </li> <li>\u73af\u5883\uff1a\u5b9a\u4e49\u591a\u4e2a\u73af\u5883 </li> </ul>"},{"location":"chap1/1gitlab_cicd/#7-gitlab-cicd","title":"7 Gitlab CI/CD \u5de5\u4f5c\u539f\u7406","text":"<ul> <li>\u5c06\u4ee3\u7801\u6258\u7ba1\u5230Git\u5b58\u50a8\u5e93\u3002 </li> <li>\u5728\u9879\u76ee\u6839\u76ee\u5f55\u521b\u5efaCI\u6587\u4ef6<code>.gitlab-ci.yml</code>, \u5728\u6587\u4ef6\u4e2d\u6307\u5b9a\u6784\u5efa\uff0c\u6d4b\u8bd5\u548c\u90e8\u7f72\u811a\u672c\u3002  </li> <li>GitLab\u5c06\u68c0\u6d4b\u5230\u5b83\u5e76\u4f7f\u7528\u540d\u4e3a<code>GitLab Runner</code>\u7684\u5de5\u5177\u8fd0\u884c\u811a\u672c\u3002 </li> <li>\u811a\u672c\u88ab\u5206\u7ec4\u4e3a\u4f5c\u4e1a\uff0c\u5b83\u4eec\u5171\u540c\u7ec4\u6210\u4e86\u4e00\u4e2a\u7ba1\u9053\u3002 </li> </ul>"},{"location":"chap1/1gitlab_cicd/#6-gtilabci-jenkinsci","title":"6 GtilabCI \u4e0e JenkinsCI\u7684\u5bf9\u6bd4","text":""},{"location":"chap1/1gitlab_cicd/#jenkins","title":"Jenkins","text":"<p>Jenkins\u662f\u4e00\u4e2a\u5e7f\u6cdb\u7528\u4e8e\u6301\u7eed\u96c6\u6210\u7684\u53ef\u89c6\u5316web\u81ea\u52a8\u5316\u5de5\u5177\uff0c jenkins\u53ef\u4ee5\u5f88\u597d\u7684\u652f\u6301\u5404\u79cd\u8bed\u8a00\u7684\u9879\u76ee\u6784\u5efa\uff0c\u4e5f\u5b8c\u5168\u517c\u5bb9ant\u3001 maven\u3001gradle\u7b49\u591a\u79cd\u7b2c\u4e09\u65b9\u6784\u5efa\u5de5\u5177\uff0c\u540c\u65f6\u8ddfsvn, git\u80fd\u65e0\u7f1d\u96c6\u6210\uff0c\u4e5f\u652f\u6301\u76f4\u63a5\u4e0e\u77e5\u540d\u6e90\u4ee3\u7801\u6258\u7ba1\u7f51\u7ad9\uff0c\u6bd4\u5982 github\u3001 bitbucket\u76f4\u63a5\u96c6\u6210\uff0c\u800c\u4e14\u63d2\u4ef6\u4f17\u591a\uff0c\u5728\u8fd9\u4e48\u591a\u5e74\u7684 \u6280\u672f\u79ef\u7d2f\u4e4b\u540e \uff0c\u5728\u56fd\u5185\u5927\u90e8\u5206\u516c\u53f8\u90fd\u6709\u4f7f\u7528Jenkins</p> <p></p>"},{"location":"chap1/1gitlab_cicd/#gtilabci","title":"GtilabCI","text":"<p>gitlab-CI\u662fgitlab8.0\u4e4b\u540e\u81ea\u5e26\u7684\u4e00\u4e2a\u6301\u7eed\u96c6\u6210\u7cfb\u7edf\uff0c\u4e2d\u5fc3\u601d\u60f3\u662f\u5f53\u6bcf\u4e00\u6b21push\u5230gitlab\u7684\u65f6\u5019\uff0c \u90fd\u4f1a\u89e6\u53d1\u4e00\u6b21\u811a\u672c\u6267\u884c\uff0c\u7136\u540e\u811a\u672c\u7684\u5185\u5bb9\u5305\u62ec\u4e86\u6d4b\u8bd5\uff0c\u7f16\u8bd1\uff0c\u90e8\u7f72\u7b49\u4e00\u7cfb\u5217\u81ea\u5b9a\u4e49\u7684\u5185\u5bb9\u3002 </p> <p>gitlab-CI\u7684\u811a\u672c\u6267\u884c\uff0c\u9700\u8981\u81ea\u5b9a\u4e49\u5b89\u88c5\u5bf9\u5e94<code>gitlab-runner</code>\u6765\u6267\u884c\uff0c\u4ee3\u7801push\u4e4b\u540e\uff0cwebhook\u68c0\u6d4b\u5230\u4ee3\u7801\u53d8\u5316\uff0c\u5c31\u4f1a\u89e6\u53d1gitlab-CI\uff0c\u5206\u914d\u5230\u5404\u4e2aRunner\u6765\u8fd0\u884c\u76f8\u5e94\u7684\u811a\u672cscript\u3002\u8fd9\u4e9b\u811a\u672c\u6709\u7684\u662f\u6d4b\u8bd5\u9879\u76ee\u7528\u7684\uff0c\u6709\u7684\u662f\u90e8\u7f72\u7528\u7684\u3002 </p>"},{"location":"chap1/1gitlab_cicd/#jenkins-vs-gtilabci","title":"Jenkins VS GtilabCI","text":"<p>1 \u5206\u652f\u7684\u53ef\u914d\u7f6e\u6027 </p> <ul> <li>\u4f7f\u7528GitLab CI\uff0c\u65b0\u521b\u5efa\u7684\u5206\u652f\u624b\u9700\u4efb\u4f55\u8fdb\u4e00\u6b65\u914d\u7f6e\u5373\u53ef\u7acb\u5373\u4f7f\u7528CI\u7ba1 \u9053\u4e2d\u7684\u5df2\u5b9a\u4e49\u4f5c\u4e1a\u3002 </li> <li>Jenkins 2\u57fa\u4e8egitlab\u7684\u591a\u5206\u652f\u6d41\u6c34\u7ebf\u53ef\u4ee5\u5b9e\u73b0\u3002\u76f8\u5bf9\u914d\u7f6e\u6765\u8bf4 gitlab\u66f4\u52a0\u65b9\u4fbf\u4e00\u4e9b\u3002 </li> </ul> <p>2 \u5b9a\u65f6\u6267\u884c\u6784\u5efa </p> <p>\u6709\u65f6\uff0c\u6839\u636e\u65f6\u95f4\u89e6\u53d1\u4f5c\u4e1a\u6216\u6574\u4e2a\u7ba1\u9053\u4f1a\u6709\u6240\u5e2e\u52a9\u3002\u4f8b\u5982\uff0c\u5e38\u89c4\u7684\u591c\u95f4\u5b9a\u65f6\u6784\u5efa\u3002 </p> <ul> <li>\u4f7f\u7528Jenkins 2\u53ef\u4ee5\u7acb\u5373\u4f7f\u7528\u3002\u53ef\u4ee5\u5728\u5e94\u6267\u884c\u4f5c\u4e1a\u6216\u7ba1\u9053\u7684\u90a3\u4e00\u523b\u4ee5cron\u5f0f\u8bed\u6cd5\u5b9a\u4e49\u3002 </li> <li>GitLab CI<ul> <li>Scheduled pipelines for tags introduced in GitLab 14.9.</li> <li>Use scheduled pipelines to run GitLab CI/CD pipelines at regular intervals.</li> </ul> </li> </ul> <p>3 \u62c9\u53d6\u8bf7\u6c42\u652f\u6301</p> <p>\u5982\u679c\u5f88\u597d\u5730\u96c6\u6210\u4e86\u5b58\u50a8\u5e93\u7ba1\u7406\u5668\u548cCI/CD\u5e73\u53f0\uff0c\u60a8\u53ef\u4ee5\u770b\u5230\u8bf7\u6c42\u7684\u5f53\u524d\u6784\u5efa\u72b6\u6001\u3002\u4f7f\u7528\u8fd9\u79cd\u529f\u80fd\uff0c\u53ef\u4ee5\u907f\u514d\u5c06\u4ee3\u7801\u5408\u5e76\u5230\u4e0d\u8d77\u4f5c\u7528\u6216\u65e0\u6cd5\u6b63\u786e\u6784\u5efa\u7684\u4e3b\u5206\u652f\u4e2d\u3002 </p> <ul> <li>Jenkins\u6ca1\u6709\u4e0e\u6e90\u4ee3\u7801\u7ba1\u7406\u7cfb\u7edf\u8fdb\u4e00\u6b65\u96c6\u6210\uff0c\u9700\u8981\u7ba1\u7406\u5458\u81ea\u884c\u5199\u4ee3\u7801\u6216\u8005\u63d2\u4ef6\u5b9e\u73b0\u3002 </li> <li>Gitlab\u4e0e\u5176CI\u5e73\u53f0\u7d27\u5bc6\u96c6\u6210\uff0c\u53ef\u4ee5\u65b9\u4fbf\u67e5\u770b\u6bcf\u4e2a\u6253\u5f00\u548c\u5173\u95ed\u62c9\u52a8\u8bf7\u6c42\u7684\u8fd0\u884c\u548c\u5b8c\u6210\u7ba1\u9053\u3002 </li> </ul> <p>4 \u6743\u9650\u7ba1\u7406 </p> <p>\u4ece\u5b58\u50a8\u5e93\u7ba1\u7406\u5668\u7ee7\u627f\u7684\u6743\u9650\u7ba1\u7406\u5bf9\u4e8e\u4e0d\u60f3\u4e3a\u6bcf\u4e2a\u670d\u52a1\u5206\u522b\u8bbe\u7f6e\u6bcf\u4e2a\u7528\u6237\u7684\u6743\u9650\u7684\u5927\u578b\u5f00\u53d1\u4eba\u5458\u6216\u7ec4\u7ec7\u56e2\u4f53\u5f88\u6709\u7528\u3002\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u4e24\u79cd\u60c5\u51b5\u4e0b\u7684\u6743\u9650\u90fd\u662f\u76f8\u540c\u7684\uff0c\u56e0\u6b64\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5e94\u5c06\u5b83\u4eec\u914d\u7f6e\u5728\u4e00\u4e2a\u4f4d\u7f6e\u3002 </p> <ul> <li>\u7531\u4e8eGitLab\u4e0eGitLabC\u5de5\u7684\u6df1\u5ea6\u6574\u5408\uff0c\u6743\u9650\u53ef\u4ee5\u7edf\u4e00\u7ba1\u7406\u3002 </li> <li>\u7531\u4e8eJenkins2\u6ca1\u6709\u5185\u7f6e\u7684\u5b58\u50a8\u5e93\u7ba1\u7406\u5668\uff0c\u56e0\u6b64\u5b83\u65e0\u6cd5\u76f4\u63a5\u5728\u5b58\u50a8\u5e93\u7ba1\u7406\u5668\u548cCI/CD\u5e73\u53f0\u4e4b\u95f4\u5408\u5e76\u6743\u9650\u3002 </li> </ul> <p>5 \u5b58\u50a8\u5e93\u4ea4\u4e92 </p> <ul> <li>GitLab CI\u662fGit\u5b58\u50a8\u5e93\u7ba1\u7406\u5668GitLab\u7684\u56fa\u5b9a\u7ec4\u4ef6\uff0c\u56e0\u6b64\u5728CI/CD\u6d41\u7a0b\u548c\u5b58\u50a8\u5e93\u529f\u80fd\u4e4b\u95f4\u63d0\u4f9b\u4e86\u826f\u597d\u7684\u4ea4\u4e92\u3002 </li> <li>Jenkins 2\u4e0e\u5b58\u50a8\u5e93\u7ba1\u7406\u5668\u90fd\u662f\u677e\u6563\u7978\u5408\u7684\uff0c\u56e0\u6b64\u5728\u9009\u62e9\u7248\u672c\u63a7\u5236\u7cfb\u7edf\u65f6\u5b83\u975e\u5e38\u7075\u6d3b\u3002 </li> </ul> <p>\u6b64\u5916\uff0c\u5c31\u50cf\u5176\u524d\u8eab\u4e00\u6837\uff0cJenkins 2\u5f3a\u8c03\u4e86\u5bf9\u63d2\u4ef6\u7684\u652f\u6301\uff0c\u4ee5\u8fdb\u4e00\u6b65\u6269\u5c55\u6216\u6539\u5584\u8f6f\u4ef6\u7684\u73b0\u6709\u529f\u80fd\u3002 </p> <p>6 \u63d2\u4ef6\u7ba1\u7406 </p> <ul> <li>\u6269\u5c55Jenkins\u7684\u672c\u673a\u529f\u80fd\u662f\u901a\u8fc7\u63d2\u4ef6\u5b8c\u6210\u7684\u3002\u63d2\u4ef6\u7684\u7ef4\u62a4\uff0c\u4fdd\u62a4\u548c\u5347\u7ea7\u6210\u672c\u5f88\u9ad8\u3002 </li> <li>GitLab\u662f\u5f00\u653e\u5f0f\u7684\uff0c\u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u76f4\u63a5\u5411\u4ee3\u7801\u5e93\u8d21\u732e\u66f4\u6539\uff0c\u4e00\u65e6\u5408\u5e76\uff0c\u5b83\u5c06\u81ea\u52a8\u6d4b\u8bd5\u5e76\u7ef4\u62a4\u6bcf\u4e2a\u66f4\u6539\u3002 </li> </ul>"},{"location":"chap1/1gitlab_cicd/#jenkins-vs-gtilabci_1","title":"Jenkins VS GtilabCI \u5c0f\u7ed3","text":"<p>GitLabCI</p> <ul> <li>\u8f7b\u91cf\u7ea7\uff0c\u4e0d\u9700\u8981\u590d\u6742\u7684\u5b89\u88c5\u624b\u6bb5\u3002 </li> <li>\u914d\u7f6e\u7b80\u5355\uff0c\u4e0egitlab\u53ef\u76f4\u63a5\u9002\u914d\u3002 </li> <li>\u5b9e\u65f6\u6784\u5efa\u65e5\u5fd7\u5341\u5206\u6e05\u6670\uff0cUI\u4ea4\u4e92\u4f53\u9a8c\u5f88\u597d </li> <li>\u4f7f\u7528YAML\u8fdb\u884c\u914d\u7f6e\uff0c\u4efb\u4f55\u4eba\u90fd\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u4f7f\u7528\u3002 </li> <li>\u6ca1\u6709\u7edf\u4e00\u7684\u7ba1\u7406\u754c\u9762\uff0c\u65e0\u6cd5\u7edf\u7b79\u7ba1\u7406\u6240\u6709\u9879\u76ee </li> <li>\u914d\u7f6e\u4f9d\u8d56\u4e8e\u4ee3\u6b8a\u4ed3\u5e93\uff0c\u8026\u5408\u5ea6\u6ca1\u6709Jenkins\u4f4e </li> </ul> <p>Jenkins </p> <ul> <li>\u7f16\u8bd1\u670d\u52a1\u548c\u4ee3\u7801\u4ed3\u5e93\uff0c\u8026\u5408\u5ea6\u4f4e </li> <li>\u63d2\u4ef6\u4e30\u5bcc\uff0c\u652f\u6301\u8bed\u8a00\u591a  </li> <li>\u6709\u7edf\u4e00\u7684web\u7ba1\u7406\u754c\u5c65 </li> <li>\u63d2\u4ef6\u4ee5\u53ca\u81ea\u8eab\u5b89\u88c5\u8f83\u4e3a\u590d\u6742\u3002 </li> <li> <p>\u4f53\u91cf\u8f83\u5927\uff0c\u4e0d\u662f\u5f88\u5408\u9002\u5c0f\u578b\u56e2\u961f\u3002 </p> </li> <li> <p>GitLabCI\u6709\u52a9\u4e8eDevOps\u4eba\u5458\uff0c\u4f8b\u5982\u654f\u6377\u5f00\u53d1\u4e2d\uff0c\u5f00\u53d1\u4e0e\u8fd0\u7ef4\u662f\u540c\u4e00\u4e2a\u4eba\uff0c\u6700\u4fbf\u6377\u7684\u5f00\u53d1\u65b9\u5f0f</p> </li> <li>JenkinsCI\u9002\u5408\u591a\u89d2\u8272\u56e2\u961f\u4e2d\uff0c\u804c\u8d23\u5206\u660e\uff0c\u914d\u7f6e\u4e0e\u4ee3\u7801\u5206\u79bb\uff0c\u63d2\u4ef6\u4e30\u5bcc</li> </ul>"},{"location":"chap1/2gitlab_branch_strategy/","title":"2 Gitlab branch Strategy","text":"<p>https://docs.gitlab.com/ee/topics/gitlab_flow.html</p>"},{"location":"chap1/2gitlab_branch_strategy/#1-requirement","title":"1 Requirement","text":"<p>Once develop has acquired enough features for a release (or a predetermined release date is approaching), you fork a release branch off of develop. </p> <p>Creating this branch starts the next release cycle, so no new features can be added after this point. Only bug fixes, documentation generation, and other release-oriented tasks should go in this branch(which includes testing also). </p> <p>Once it's ready to ship, the release gets merged into master and tagged with a version number. In addition, it should be merged back into develop, which may have progressed since the release was initiated. </p> <p>Using a dedicated branch to prepare releases makes it possible for one team to polish the current release while another team continues working on features for the next release. </p> <p>It also creates well-defined phases of development (e.g., it's easy to say, 'this week we're preparing for version 4.0\" and to actually see it in the structure of the repository). </p>"},{"location":"chap1/2gitlab_branch_strategy/#basic-description","title":"Basic Description","text":"<p>It suggests a main branch and a separate develop branch, with supporting branches for features, releases, and hotfixes. </p> <ul> <li> <p>The development happens on the develop branch, moves to a release branch, and is finally merged into the main branch.</p> </li> <li> <p>master\uff1aThe official version that can be provided to users\uff1b</p> </li> <li>develop\uff1aVersion used to generate code(nightly\uff09\uff1b</li> <li>feature\uff1aFor developing a function\uff1b</li> <li>hotfix\uff1aUsed to fix bugs in online code\uff1b</li> <li>release\uff1aRelease branch, integrate feature branch for release\u3002</li> </ul>"},{"location":"chap1/2gitlab_branch_strategy/#the-first-problem","title":"The first problem","text":"<ul> <li>The first problem is that developers must use the develop branch and not main.  <ul> <li>main is reserved for code that is released to production. </li> <li>It is a convention to call your default branch main and to mostly branch from and merge to this. Because most tools automatically use the main branch as the default, it is annoying to have to switch to another branch.</li> </ul> </li> </ul>"},{"location":"chap1/2gitlab_branch_strategy/#the-second-problem","title":"The second problem","text":"<p>Git flow is the complexity introduced by the hotfix and release branches\u3002</p> <p>Frequently, developers make mistakes such as merging changes only into main and not into the develop branch. The reason for these errors is that Git flow is too complicated for most use cases. For example, many projects do releases but don\u2019t need to do hotfixes.</p>"},{"location":"chap1/2gitlab_branch_strategy/#release-branches-with-gitlab-flow","title":"Release branches with GitLab flow","text":"<p>You should work with release branches only if you need to release software to the outside world. In this case, each branch contains a minor version, such as <code>2.3-stable</code> or <code>2.4-stable</code>:</p> <p></p> <p>After announcing a release branch, only add serious bug fixes to the branch. </p> <p>If possible, first merge these bug fixes into main, and then cherry-pick them into the release branch. If you start by merging into the release branch, you might forget to cherry-pick them into main, and then you\u2019d encounter the same bug in subsequent releases. </p> <p>Merging into main and then cherry-picking into release is called an \u201cupstream first\u201d policy, </p>"},{"location":"chap1/2gitlab_branch_strategy/#squashing-commits-with-rebase","title":"Squashing commits with rebase","text":"<p>With Git, you can use an interactive rebase (<code>rebase -i</code>) to squash multiple commits into one or reorder them. This feature helps you replace a couple of small commits with a single commit, or if you want to make the order more logical:</p> <pre><code>pick c6ee4d3 add a new file to the repo\npick c3c130b change readme\n\n# Rebase 168afa0..c3c130b onto 168afa0\n#\n# Commands:\n# p, pick = use commit\n# r, reword = use commit, but edit the commit message\n# e, edit = use commit, but stop for amending\n# s, squash = use commit, but meld into previous commit\n# f, fixup = like \"squash\", but discard this commit's log message\n# x, exec = run command (the rest of the line) using shell\n#\n# These lines can be re-ordered; they are executed from top to bottom.\n#\n# If you remove a line here THAT COMMIT WILL BE LOST.\n#\n# However, if you remove everything, the rebase will be aborted.\n#\n# Note that empty commits are commented out\n~\n</code></pre>"},{"location":"chap1/2gitlab_branch_strategy/#gitlab-flow-with-environment-branches","title":"Gitlab Flow with     Environment Branches","text":""},{"location":"chap1/3gitlab_install_quick/","title":"3 \u5b89\u88c5\u914d\u7f6eGitlab","text":""},{"location":"chap1/3gitlab_install_quick/#rpmcentos7","title":"\u4f7f\u7528RPM\u5305\u5b89\u88c5\uff08Centos7)","text":"<p>https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/</p> <pre><code>wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-15.1.1-ce.0.el7.x86_64.rpm\n\nrpm -ivh gitlab-ce-15.1.1-ce.0.el7.x86_64.rpm\n\nvim /etc/gitlab.rb # \u7f16\u8f91\u7ad9\u70b9\u5730\u5740\ngitlab-ctl reconfigure # \u914d\u7f6e\n\n\n# \u670d\u52a1\u63a7\u5236\ngitlab-ctl start \ngitlab-ctl status \ngitlab-ctl stop \n</code></pre>"},{"location":"chap1/3gitlab_install_quick/#docker","title":"\u4f7f\u7528 Docker \u5b89\u88c5","text":"<p>https://github.com/sameersbn/docker-gitlab#installation</p> <pre><code>mkdir -p ~/data/gitlab/conf ~/data/gitlab/logs ~/data/gitlab/data\ndocker pull gitlab/gitlab-ce:14.10.5-ce.0\n\n\ndocker run -d -p 443:443 -p 80:80 -p 222:22 --name gitlab --restart always -v /Users/jacob/data/gitlab/config:/etc/gitlab -v /Users/jacob/data/gitlab/logs:/var/log/gitlab -v  /Users/jacob/data/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:14.10.5-ce.0 \n\n\ndocker exec -it gitlab bash \nvim /etc/gitlab.rb \uff03\u7f16\u8f91\u7ad9\u70b9\u5730\u5740 \ngitlab-ctl reconfigure\uff03\u914d\u7f6e \n\ndocker restart gitlab \n\n\n\uff03\u670d\u52a1\u63a7\u5236 \ndocker start gitlab \ndocker stop gitlab \ndocker rm gitlab \n</code></pre>"},{"location":"chap1/3gitlab_install_quick/#quick-start-with-docker","title":"Quick start with docker","text":""},{"location":"chap1/3gitlab_install_quick/#docker-compose","title":"<code>docker-compose</code>","text":"<pre><code>wget https://raw.githubusercontent.com/sameersbn/docker-gitlab/master/docker-compose.yml\n</code></pre> <p><code>docker-compose.yml</code></p> <pre><code>version: '2.3'\n\nservices:\n  redis:\n    restart: always\n    image: redis:6.2.6\n    command:\n    - --loglevel warning\n    volumes:\n    - redis-data:/data:Z\n\n  postgresql:\n    restart: always\n    image: sameersbn/postgresql:12-20200524\n    volumes:\n    - postgresql-data:/var/lib/postgresql:Z\n    environment:\n    - DB_USER=gitlab\n    - DB_PASS=password\n    - DB_NAME=gitlabhq_production\n    - DB_EXTENSION=pg_trgm,btree_gist\n\n  gitlab:\n    restart: always\n    image: sameersbn/gitlab:15.1.1\n    depends_on:\n    - redis\n    - postgresql\n    ports:\n    - \"10080:80\"\n    - \"10022:22\"\n    volumes:\n    - gitlab-data:/home/git/data:Z\n    healthcheck:\n      test: [\"CMD\", \"/usr/local/sbin/healthcheck\"]\n      interval: 5m\n      timeout: 10s\n      retries: 3\n      start_period: 5m\n    environment:\n    - DEBUG=false\n\n    - DB_ADAPTER=postgresql\n    - DB_HOST=postgresql\n    - DB_PORT=5432\n    - DB_USER=gitlab\n    - DB_PASS=password\n    - DB_NAME=gitlabhq_production\n\n    - REDIS_HOST=redis\n    - REDIS_PORT=6379\n\n    - TZ=Asia/Kolkata\n    - GITLAB_TIMEZONE=Kolkata\n\n    - GITLAB_HTTPS=false\n    - SSL_SELF_SIGNED=false\n\n    - GITLAB_HOST=localhost\n    - GITLAB_PORT=10080\n    - GITLAB_SSH_PORT=10022\n    - GITLAB_RELATIVE_URL_ROOT=\n    - GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alphanumeric-string\n    - GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alphanumeric-string\n    - GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alphanumeric-string\n\n    - GITLAB_ROOT_PASSWORD=\n    - GITLAB_ROOT_EMAIL=\n\n    - GITLAB_NOTIFY_ON_BROKEN_BUILDS=true\n    - GITLAB_NOTIFY_PUSHER=false\n\n    - GITLAB_EMAIL=notifications@example.com\n    - GITLAB_EMAIL_REPLY_TO=noreply@example.com\n    - GITLAB_INCOMING_EMAIL_ADDRESS=reply@example.com\n\n    - GITLAB_BACKUP_SCHEDULE=daily\n    - GITLAB_BACKUP_TIME=01:00\n\n    - SMTP_ENABLED=false\n    - SMTP_DOMAIN=www.example.com\n    - SMTP_HOST=smtp.gmail.com\n    - SMTP_PORT=587\n    - SMTP_USER=mailer@example.com\n    - SMTP_PASS=password\n    - SMTP_STARTTLS=true\n    - SMTP_AUTHENTICATION=login\n\n    - IMAP_ENABLED=false\n    - IMAP_HOST=imap.gmail.com\n    - IMAP_PORT=993\n    - IMAP_USER=mailer@example.com\n    - IMAP_PASS=password\n    - IMAP_SSL=true\n    - IMAP_STARTTLS=false\n\n    - OAUTH_ENABLED=false\n    - OAUTH_AUTO_SIGN_IN_WITH_PROVIDER=\n    - OAUTH_ALLOW_SSO=\n    - OAUTH_BLOCK_AUTO_CREATED_USERS=true\n    - OAUTH_AUTO_LINK_LDAP_USER=false\n    - OAUTH_AUTO_LINK_SAML_USER=false\n    - OAUTH_EXTERNAL_PROVIDERS=\n\n    - OAUTH_CAS3_LABEL=cas3\n    - OAUTH_CAS3_SERVER=\n    - OAUTH_CAS3_DISABLE_SSL_VERIFICATION=false\n    - OAUTH_CAS3_LOGIN_URL=/cas/login\n    - OAUTH_CAS3_VALIDATE_URL=/cas/p3/serviceValidate\n    - OAUTH_CAS3_LOGOUT_URL=/cas/logout\n\n    - OAUTH_GOOGLE_API_KEY=\n    - OAUTH_GOOGLE_APP_SECRET=\n    - OAUTH_GOOGLE_RESTRICT_DOMAIN=\n\n    - OAUTH_FACEBOOK_API_KEY=\n    - OAUTH_FACEBOOK_APP_SECRET=\n\n    - OAUTH_TWITTER_API_KEY=\n    - OAUTH_TWITTER_APP_SECRET=\n\n    - OAUTH_GITHUB_API_KEY=\n    - OAUTH_GITHUB_APP_SECRET=\n    - OAUTH_GITHUB_URL=\n    - OAUTH_GITHUB_VERIFY_SSL=\n\n    - OAUTH_GITLAB_API_KEY=\n    - OAUTH_GITLAB_APP_SECRET=\n\n    - OAUTH_BITBUCKET_API_KEY=\n    - OAUTH_BITBUCKET_APP_SECRET=\n    - OAUTH_BITBUCKET_URL=\n\n    - OAUTH_SAML_ASSERTION_CONSUMER_SERVICE_URL=\n    - OAUTH_SAML_IDP_CERT_FINGERPRINT=\n    - OAUTH_SAML_IDP_SSO_TARGET_URL=\n    - OAUTH_SAML_ISSUER=\n    - OAUTH_SAML_LABEL=\"Our SAML Provider\"\n    - OAUTH_SAML_NAME_IDENTIFIER_FORMAT=urn:oasis:names:tc:SAML:2.0:nameid-format:transient\n    - OAUTH_SAML_GROUPS_ATTRIBUTE=\n    - OAUTH_SAML_EXTERNAL_GROUPS=\n    - OAUTH_SAML_ATTRIBUTE_STATEMENTS_EMAIL=\n    - OAUTH_SAML_ATTRIBUTE_STATEMENTS_NAME=\n    - OAUTH_SAML_ATTRIBUTE_STATEMENTS_USERNAME=\n    - OAUTH_SAML_ATTRIBUTE_STATEMENTS_FIRST_NAME=\n    - OAUTH_SAML_ATTRIBUTE_STATEMENTS_LAST_NAME=\n\n    - OAUTH_CROWD_SERVER_URL=\n    - OAUTH_CROWD_APP_NAME=\n    - OAUTH_CROWD_APP_PASSWORD=\n\n    - OAUTH_AUTH0_CLIENT_ID=\n    - OAUTH_AUTH0_CLIENT_SECRET=\n    - OAUTH_AUTH0_DOMAIN=\n    - OAUTH_AUTH0_SCOPE=\n\n    - OAUTH_AZURE_API_KEY=\n    - OAUTH_AZURE_API_SECRET=\n    - OAUTH_AZURE_TENANT_ID=\n\nvolumes:\n  redis-data:\n  postgresql-data:\n  gitlab-data:\n</code></pre> <p><code>docker-compose up</code></p>"},{"location":"chap1/3gitlab_install_quick/#docker-start-one-by-one","title":"docker start one by one","text":"<ul> <li>gitlab-postgresql</li> <li>gitlab-redis</li> <li>gitlab</li> </ul> <p>Step 1. Launch a postgresql container</p> <pre><code>docker run --name gitlab-postgresql -d \\\n    --env 'DB_NAME=gitlabhq_production' \\\n    --env 'DB_USER=gitlab' --env 'DB_PASS=password' \\\n    --env 'DB_EXTENSION=pg_trgm,btree_gist' \\\n    --volume /srv/docker/gitlab/postgresql:/var/lib/postgresql \\\n    sameersbn/postgresql:12-20200524\n</code></pre> <p>Step 2. Launch a redis container</p> <pre><code>docker run --name gitlab-redis -d \\\n    --volume /srv/docker/gitlab/redis:/data \\\n    redis:6.2\n</code></pre> <p>Step 3. Launch the gitlab container</p> <pre><code>docker run --name gitlab -d \\\n    --link gitlab-postgresql:postgresql --link gitlab-redis:redisio \\\n    --publish 10022:22 --publish 10080:80 \\\n    --env 'GITLAB_PORT=10080' --env 'GITLAB_SSH_PORT=10022' \\\n    --env 'GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alpha-numeric-string' \\\n    --env 'GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alpha-numeric-string' \\\n    --env 'GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alpha-numeric-string' \\\n    --volume /srv/docker/gitlab/gitlab:/home/git/data \\\n    sameersbn/gitlab:15.1.1\n</code></pre>"},{"location":"chap1/4gitlab_install_k8s/","title":"4 \u5728Kubernetes\u4e0a\u5b89\u88c5Gitlab","text":"<p>Gitlab \u5b98\u65b9\u63d0\u4f9b\u4e86 Helm \u7684\u65b9\u5f0f\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u6765\u5feb\u901f\u5b89\u88c5\uff0c\u4f46\u662f\u5728\u4f7f\u7528\u7684\u8fc7\u7a0b\u4e2d\u53d1\u73b0 Helm \u63d0\u4f9b\u7684 Chart \u5305\u4e2d\u6709\u5f88\u591a\u5176\u4ed6\u989d\u5916\u7684\u914d\u7f6e\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u65b9\u5f0f\u6765\u5b89\u88c5\uff0c\u4e5f\u5c31\u662f\u81ea\u5df1\u6765\u5b9a\u4e49\u4e00\u4e9b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002</p> <p>Gitlab \u4e3b\u8981\u6d89\u53ca\u52303\u4e2a\u5e94\u7528\uff1aRedis\u3001Postgresql\u3001Gitlab \u6838\u5fc3\u7a0b\u5e8f\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u53ea\u8981\u5c06\u8fd93\u4e2a\u5e94\u7528\u5206\u522b\u542f\u52a8\u8d77\u6765\uff0c\u7136\u540e\u52a0\u4e0a\u5bf9\u5e94\u7684\u914d\u7f6e\u5c31\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5b89\u88c5 Gitlab \u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u9009\u62e9\u4f7f\u7528\u7684\u955c\u50cf\u4e0d\u662f\u5b98\u65b9\u7684\uff0c\u800c\u662f Gitlab \u5bb9\u5668\u5316\u4e2d\u4f7f\u7528\u975e\u5e38\u591a\u7684\u4e00\u4e2a\u7b2c\u4e09\u65b9\u955c\u50cf\uff1asameersbn/gitlab\uff0c\u57fa\u672c\u4e0a\u548c\u5b98\u65b9\u4fdd\u6301\u540c\u6b65\u66f4\u65b0\uff0c\u5730\u5740\uff1ahttp://www.damagehead.com/docker-gitlab/</p> <p>https://github.com/sameersbn/docker-gitlab#installation</p>"},{"location":"chap1/4gitlab_install_k8s/#_1","title":"\u5b89\u88c5","text":"<p>\u5982\u679c\u6211\u4eec\u5df2\u7ecf\u6709\u53ef\u4f7f\u7528\u7684 Redis \u6216 Postgresql \u670d\u52a1\u7684\u8bdd\uff0c\u90a3\u4e48\u76f4\u63a5\u914d\u7f6e\u5728 Gitlab \u73af\u5883\u53d8\u91cf\u4e2d\u5373\u53ef\uff0c\u5982\u679c\u6ca1\u6709\u7684\u8bdd\u5c31\u5355\u72ec\u90e8\u7f72\u3002</p> <p>\u9996\u5148\u90e8\u7f72\u9700\u8981\u7684 Redis \u670d\u52a1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(<code>gitlab-redis.yaml</code>)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: redis\n  namespace: devops\n  labels:\n    name: redis\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      name: redis\n  template:\n    metadata:\n      name: redis\n      labels:\n        name: redis\n    spec:\n      containers:\n      - name: redis\n        image: sameersbn/redis\n        imagePullPolicy: IfNotPresent\n        ports:\n        - name: redis\n          containerPort: 6379\n        volumeMounts:\n        - mountPath: /var/lib/redis\n          name: data\n        livenessProbe:\n          exec:\n            command:\n            - redis-cli\n            - ping\n          initialDelaySeconds: 30\n          timeoutSeconds: 5\n        readinessProbe:\n          exec:\n            command:\n            - redis-cli\n            - ping\n          initialDelaySeconds: 5\n          timeoutSeconds: 1\n      volumes:\n      - name: data\n        emptyDir: {}\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis\n  namespace: devops\n  labels:\n    name: redis\nspec:\n  ports:\n    - name: redis\n      port: 6379\n      targetPort: redis\n  selector:\n    name: redis\n</code></pre> <p>\u7136\u540e\u662f\u6570\u636e\u5e93 Postgresql\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(<code>gitlab-postgresql.yaml</code>)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: postgresql\n  namespace: devops\n  labels:\n    name: postgresql\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      name: postgresql\n  template:\n    metadata:\n      name: postgresql\n      labels:\n        name: postgresql\n    spec:\n      containers:\n      - name: postgresql\n        image: sameersbn/postgresql:12-20200524\n        imagePullPolicy: IfNotPresent\n        env:\n        - name: DB_USER\n          value: gitlab\n        - name: DB_PASS\n          value: passw0rd\n        - name: DB_NAME\n          value: gitlab_production\n        - name: DB_EXTENSION\n          value: \"pg_trgm,btree_gist\"\n        ports:\n        - name: postgres\n          containerPort: 5432\n        volumeMounts:\n        - mountPath: /var/lib/postgresql\n          name: data\n        livenessProbe:\n          exec:\n            command:\n            - pg_isready\n            - -h\n            - localhost\n            - -U\n            - postgres\n          initialDelaySeconds: 30\n          timeoutSeconds: 5\n        readinessProbe:\n          exec:\n            command:\n            - pg_isready\n            - -h\n            - localhost\n            - -U\n            - postgres\n          initialDelaySeconds: 5\n          timeoutSeconds: 1\n      volumes:\n      - name: data\n        emptyDir: {}\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: postgresql\n  namespace: devops\n  labels:\n    name: postgresql\nspec:\n  ports:\n    - name: postgres\n      port: 5432\n      targetPort: postgres\n  selector:\n    name: postgresql\n</code></pre> <p>\u7136\u540e\u5c31\u662f\u6211\u4eec\u6700\u6838\u5fc3\u7684 Gitlab \u7684\u5e94\u7528\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(gitlab.yaml)</p> <pre><code>---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: gitlab-pvc-volume\n  namespace: devops\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 2Gi\n  storageClassName: hostpath\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: gitlab\n  namespace: devops\n  labels:\n    name: gitlab\nspec:\n  selector:\n    matchLabels:\n      name: gitlab\n  template:\n    metadata:\n      name: gitlab\n      labels:\n        name: gitlab\n    spec:\n      containers:\n      - name: gitlab\n        image: sameersbn/gitlab\n        imagePullPolicy: IfNotPresent\n        env:\n        - name: TZ\n          value: Asia/Shanghai\n        - name: GITLAB_TIMEZONE\n          value: Beijing\n        - name: GITLAB_SECRETS_DB_KEY_BASE\n          value: long-and-random-alpha-numeric-string\n        - name: GITLAB_SECRETS_SECRET_KEY_BASE\n          value: long-and-random-alpha-numeric-string\n        - name: GITLAB_SECRETS_OTP_KEY_BASE\n          value: long-and-random-alpha-numeric-string\n        - name: GITLAB_ROOT_PASSWORD\n          value: admin321\n        - name: GITLAB_ROOT_EMAIL\n          value: example@gmail.com\n        - name: GITLAB_HOST\n          value: \"localhost\"\n        - name: GITLAB_PORT\n          value: \"32220\"   #\u8fd9\u91cc\u6781\u5176\u91cd\u8981\n        - name: GITLAB_SSH_PORT\n          value: \"30022\"\n        - name: GITLAB_NOTIFY_ON_BROKEN_BUILDS\n          value: \"true\"\n        - name: GITLAB_NOTIFY_PUSHER\n          value: \"false\"\n        - name: GITLAB_BACKUP_SCHEDULE\n          value: daily\n        - name: GITLAB_BACKUP_TIME\n          value: 01:00\n        - name: DB_TYPE\n          value: postgres\n        - name: DB_HOST\n          value: postgresql\n        - name: DB_PORT\n          value: \"5432\"\n        - name: DB_USER\n          value: gitlab\n        - name: DB_PASS\n          value: passw0rd\n        - name: DB_NAME\n          value: gitlab_production\n        - name: REDIS_HOST\n          value: redis\n        - name: REDIS_PORT\n          value: \"6379\"\n        ports:\n        - name: http\n          containerPort: 80\n        - name: ssh\n          containerPort: 22\n        volumeMounts:\n        - mountPath: /home/git/data\n          name: data\n        livenessProbe:\n          httpGet:\n            path: /\n            port: 80\n          initialDelaySeconds: 180\n          timeoutSeconds: 5\n        readinessProbe:\n          httpGet:\n            path: /\n            port: 80\n          initialDelaySeconds: 5\n          timeoutSeconds: 1\n      volumes:\n      - name: data\n        persistentVolumeClaim:\n          claimName: gitlab-pvc-volume \n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: gitlab\n  namespace: devops\n  labels:\n    name: gitlab\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: http\n      nodePort: 32220\n    - name: ssh\n      port: 22\n      targetPort: ssh\n      nodePort: 30022\n  type: NodePort\n  selector:\n    name: gitlab\n</code></pre> <p>\u8981\u6ce8\u610f\u6211\u4eec\u8fd9\u91cc\u5e94\u7528\u6570\u636e\u6ca1\u6709\u505a\u6570\u636e\u6301\u4e45\u5316\uff0c\u53ea\u662f\u4f7f\u7528\u7684<code>emptyDir: {}</code>\u7c7b\u578b\u7684 volume\uff0cPod \u6302\u6389\u540e\uff0c\u5bf9\u5e94\u7684\u6570\u636e \u4e5f\u5c31\u6ca1\u6709\u4e86\uff0c\u6240\u4ee5\u8981\u5728\u6b63\u5f0f\u7684\u73af\u5883\u4e2d\u4f7f\u7528\u4e00\u5b9a\u8981\u505a\u6570\u636e\u7684\u6301\u4e45\u5316\uff0c\u6bd4\u5982\u6dfb\u52a0 PV/PVC \u6216\u8005 StorageClass\u3002</p> <pre><code>$ kubectl create -f gitlab-redis.yaml gitlab-postgresql.yaml gitlab.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b Pod \u7684\u90e8\u7f72\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pod -n devops \nNAME                         READY   STATUS    RESTARTS   AGE\ngitlab-6f4d75595d-jh6nf      1/1     Running   0          43m\npostgresql-6d5878b74-gkwzv   1/1     Running   0          50m\nredis-65668f87b8-ww5n2       1/1     Running   0          100m\n</code></pre> <pre><code>$ kubectl get svc -n devops\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                     AGE\ngitlab       NodePort    10.108.212.14   &lt;none&gt;        80:32220/TCP,22:30022/TCP   45m\npostgresql   ClusterIP   10.101.62.211   &lt;none&gt;        5432/TCP                    52m\nredis        ClusterIP   10.97.115.239   &lt;none&gt;        6379/TCP                    102m\n</code></pre>"},{"location":"chap1/4gitlab_install_k8s/#ingress","title":"\u6216\u8005\u53ef\u4ee5\u90e8\u7f72<code>Ingress</code>\uff0c\u901a\u8fc7\u57df\u540d\u8bbf\u95ee","text":"<pre><code>---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: gitlab\n  namespace: kube-ops\n  annotations:\n    kubernetes.io/ingress.class: traefik\nspec:\n  rules:\n  - host: git.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: gitlab\n          servicePort: http\n</code></pre>"},{"location":"chap1/4gitlab_install_k8s/#_2","title":"\u4f7f\u7528","text":"<pre><code>kubectl port-forward svc/gitlab 10008:80 -n kube-ops\n</code></pre> <p><code>localhost:10008</code></p> <ul> <li>root</li> <li>admin321</li> </ul> <p></p> <p></p> <p><code>settings -&gt; ssh</code></p>"},{"location":"chap1/4gitlab_install_k8s/#gitlab-project","title":"\u521b\u5efa\u65b0\u7684<code>gitlab-project</code>","text":"<p>\u4f7f\u7528\u7528\u6237\u540d root\uff0c\u548c\u90e8\u7f72\u7684\u65f6\u5019\u6307\u5b9a\u7684\u8d85\u7ea7\u7528\u6237\u5bc6\u7801<code>GITLAB_ROOT_PASSWORD=admin321</code>\u5373\u53ef\u767b\u5f55\u8fdb\u5165\u5230\u9996\u9875\uff1a</p> <p>Gitlab \u8fd0\u884c\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6ce8\u518c\u4e3a\u65b0\u7528\u6237\u5e76\u521b\u5efa\u4e00\u4e2a\u9879\u76ee\uff0c\u8fd8\u53ef\u4ee5\u505a\u5f88\u591a\u7684\u5176\u4ed6\u7cfb\u7edf\u8bbe\u7f6e\uff0c\u6bd4\u5982\u8bbe\u7f6e\u8bed\u8a00\u3001\u8bbe\u7f6e\u5e94\u7528\u98ce\u683c\u6837\u5f0f\u7b49\u7b49\u3002</p> <p>\u70b9\u51fb<code>Create a project</code>\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u9879\u76ee\uff0c\u548c\u4e4b\u524d Github \u4f7f\u7528\u4e0a\u6ca1\u6709\u591a\u5927\u7684\u5dee\u522b</p> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u672c\u5730\u7528\u6237\u7684\u4e00\u4e2a<code>SSH-KEY</code>\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 SSH \u6765\u62c9\u53d6\u6216\u8005\u63a8\u9001\u4ee3\u7801\u4e86\u3002</p> <p>SSH \u516c\u94a5\u901a\u5e38\u5305\u542b\u5728<code>~/.ssh/id_rsa.pub</code> \u6587\u4ef6\u4e2d\uff0c\u5e76\u4ee5<code>ssh-rsa</code>\u5f00\u5934\u3002\u5982\u679c\u6ca1\u6709\u7684\u8bdd\u53ef\u4ee5\u4f7f\u7528<code>ssh-keygen</code>\u547d\u4ee4\u6765\u751f\u6210\uff0c<code>id_rsa.pub</code>\u91cc\u9762\u7684\u5185\u5bb9\u5c31\u662f\u6211\u4eec\u9700\u8981\u7684 SSH \u516c\u94a5\uff0c\u7136\u540e\u6dfb\u52a0\u5230 Gitlab \u4e2d\u3002</p> <p>\u7531\u4e8e\u5e73\u65f6\u4f7f\u7528\u7684 ssh \u9ed8\u8ba4\u662f 22 \u7aef\u53e3\uff0c\u73b0\u5728\u5982\u679c\u7528\u9ed8\u8ba4\u7684 22 \u7aef\u53e3\u53bb\u8fde\u63a5\uff0c\u662f\u6ca1\u529e\u6cd5\u548c Gitlab \u5bb9\u5668\u4e2d\u7684 22 \u7aef\u53e3\u8fdb\u884c\u6620\u5c04\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u53ea\u662f\u901a\u8fc7 Service \u7684 22 \u7aef\u53e3\u8fdb\u884c\u4e86\u6620\u5c04\uff0c\u8981\u60f3\u901a\u8fc7\u8282\u70b9\u53bb\u8fdb\u884c ssh \u94fe\u63a5\u5c31\u9700\u8981\u5728\u8282\u70b9\u4e0a\u4e00\u4e2a\u7aef\u53e3\u548c\u5bb9\u5668\u5185\u90e8\u768422\u7aef\u53e3\u8fdb\u884c\u7ed1\u5b9a\uff0c\u6240\u4ee5\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 NodePort \u53bb\u6620\u5c04 Gitlab \u5bb9\u5668\u5185\u90e8\u768422\u7aef\u53e3\uff0c\u6bd4\u5982\u6211\u4eec\u5c06\u73af\u5883\u53d8\u91cf\u8bbe\u7f6e\u4e3a<code>GITLAB_SSH_PORT=30022</code>\uff0c\u5c06 <code>Gitlab</code> \u7684 <code>Service</code> \u4e5f\u8bbe\u7f6e\u4e3a <code>NodePort</code> \u7c7b\u578b\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: gitlab\n  namespace: devops\n  labels:\n    name: gitlab\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: http\n    - name: ssh\n      port: 22\n      targetPort: ssh\n      nodePort: 30022\n  type: NodePort\n  selector:\n    name: gitlab\n</code></pre> <p>\u4e0a\u9762 ssh \u5bf9\u5e94\u7684 nodePort \u7aef\u53e3\u8bbe\u7f6e\u4e3a 30022\uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u968f\u673a\u751f\u6210\u4e86\uff0c\u91cd\u65b0\u66f4\u65b0\u4e0b <code>Deployment</code> \u548c <code>Service</code>\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u73b0\u5728\u6211\u4eec\u5728\u9879\u76ee\u4e0a\u9762 Clone \u7684\u65f6\u5019\u4f7f\u7528 ssh \u5c31\u4f1a\u5e26\u4e0a\u7aef\u53e3\u53f7\u4e86\uff1a</p> <p></p> <pre><code> git clone ssh://git@localhost:30022/root/gitlab-demo.git\nCloning into 'gitlab-demo'...\nThe authenticity of host '[localhost]:30022 ([::1]:30022)' can't be established.\nECDSA key fingerprint is SHA256:m7ViaaMBdYKdedh4xQrefW+kpV+8xQ9e9+dJ+8+cAJw.\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added '[localhost]:30022' (ECDSA) to the list of known hosts.\nwarning: You appear to have cloned an empty repository.\n\n$ cd gitlab-demo\n$ echo \"# hello world\" &gt;  README.md\n$ git add .\n git commit -m 'hello world'\n[master (root-commit) aff3a72] hello world\n 1 file changed, 1 insertion(+)\n create mode 100644 README.md\n\n$ git push origin master\nEnumerating objects: 3, done.\nCounting objects: 100% (3/3), done.\nWriting objects: 100% (3/3), 221 bytes | 221.00 KiB/s, done.\nTotal 3 (delta 0), reused 0 (delta 0)\nTo ssh://localhost:30022/root/gitlab-demo.git\n * [new branch]      master -&gt; master\n</code></pre>"},{"location":"chap10/1action_docker/","title":"\u57fa\u4e8eGitHubActions\u540c\u6b65Docker\u955c\u50cf\u5b9e\u8df5","text":""},{"location":"chap10/1action_docker/#github-actions","title":"GitHub Actions\u7b80\u4ecb","text":"<p>GitHub Actions \u662f GitHub \u63a8\u51fa\u7684\u4e00\u6b3e\u5f3a\u5927\u7684\u6301\u7eed\u96c6\u6210\u548c\u6301\u7eed\u90e8\u7f72(CI/CD)\u5de5\u5177\u3002\u5b83\u53ef\u4ee5\u5e2e\u52a9\u5f00\u53d1\u8005\u5728 GitHub \u4e0a\u81ea\u52a8\u5316\u8f6f\u4ef6\u5f00\u53d1\u751f\u547d\u5468\u671f\u4e2d\u7684\u5404\u79cd\u4efb\u52a1,\u4ece\u800c\u63d0\u9ad8\u5f00\u53d1\u6548\u7387\u548c\u4ea4\u4ed8\u8d28\u91cf\u3002</p> <p>GitHub Actions \u7684\u6838\u5fc3\u601d\u60f3\u662f\u57fa\u4e8e\u4e8b\u4ef6\u9a71\u52a8\u7684\u5de5\u4f5c\u6d41(Workflow)\u3002\u5f00\u53d1\u8005\u53ef\u4ee5\u5b9a\u4e49\u5404\u79cd\u4e8b\u4ef6(\u5982\u4ee3\u7801\u63d0\u4ea4\u3001\u62c9\u53d6\u8bf7\u6c42\u3001\u8ba1\u5212\u4efb\u52a1\u7b49)\u89e6\u53d1\u76f8\u5e94\u7684\u5de5\u4f5c\u6d41,\u5728\u5de5\u4f5c\u6d41\u4e2d\u6267\u884c\u4e00\u7cfb\u5217\u7684\u64cd\u4f5c\u548c\u52a8\u4f5c\u3002\u8fd9\u4e9b\u64cd\u4f5c\u5305\u62ec\u7f16\u8bd1\u3001\u6d4b\u8bd5\u3001\u6253\u5305\u3001\u90e8\u7f72\u7b49\u5404\u79cd\u8f6f\u4ef6\u5f00\u53d1\u76f8\u5173\u7684\u4efb\u52a1\u3002</p> <p>\u5de5\u4f5c\u6d41\u7684\u5b9a\u4e49\u91c7\u7528 YAML \u683c\u5f0f,\u975e\u5e38\u7b80\u6d01\u6613\u8bfb\u3002\u5f00\u53d1\u8005\u53ea\u9700\u8981\u5728\u4ee3\u7801\u4ed3\u5e93\u4e2d\u521b\u5efa\u4e00\u4e2a <code>.github/workflows</code> \u76ee\u5f55,\u5e76\u5728\u5176\u4e2d\u6dfb\u52a0 YAML \u683c\u5f0f\u7684\u5de5\u4f5c\u6d41\u5b9a\u4e49\u6587\u4ef6\u5373\u53ef\u3002\u8fd9\u4e9b\u6587\u4ef6\u63cf\u8ff0\u4e86\u5728\u7279\u5b9a\u4e8b\u4ef6\u53d1\u751f\u65f6\u5e94\u8be5\u6267\u884c\u54ea\u4e9b\u64cd\u4f5c\u6b65\u9aa4\u3002</p> <p>GitHub Actions \u63d0\u4f9b\u4e86\u5927\u91cf\u7684\u73b0\u6210\u52a8\u4f5c(Actions),\u5f00\u53d1\u8005\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u3002\u8fd9\u4e9b\u52a8\u4f5c\u5c01\u88c5\u4e86\u5404\u79cd\u5e38\u89c1\u7684\u6784\u5efa\u3001\u6d4b\u8bd5\u3001\u90e8\u7f72\u7b49\u529f\u80fd,\u6db5\u76d6\u4e86\u4ece Java\u3001Python\u3001Node.js \u5230 Docker\u3001AWS \u7b49\u5404\u79cd\u6280\u672f\u6808\u3002\u5f00\u53d1\u8005\u4e5f\u53ef\u4ee5\u81ea\u5b9a\u4e49\u52a8\u4f5c,\u5b9e\u73b0\u66f4\u590d\u6742\u7684\u529f\u80fd\u3002</p> <p>\u9664\u4e86\u7075\u6d3b\u7684\u5de5\u4f5c\u6d41\u5b9a\u4e49\u548c\u4e30\u5bcc\u7684\u52a8\u4f5c\u5e93,GitHub Actions \u8fd8\u63d0\u4f9b\u4e86\u65b9\u4fbf\u7684\u65e5\u5fd7\u67e5\u770b\u3001\u72b6\u6001\u68c0\u67e5\u7b49\u529f\u80fd,\u5e2e\u52a9\u5f00\u53d1\u8005\u66f4\u597d\u5730\u76d1\u63a7\u548c\u7ba1\u7406\u81ea\u52a8\u5316\u6d41\u7a0b\u3002\u540c\u65f6,\u5b83\u8fd8\u652f\u6301\u77e9\u9635\u6784\u5efa\u3001\u7f13\u5b58\u4f9d\u8d56\u3001secrets \u7ba1\u7406\u7b49\u9ad8\u7ea7\u7279\u6027,\u6ee1\u8db3\u590d\u6742\u573a\u666f\u4e0b\u7684\u9700\u6c42\u3002</p> <p>GitHub Actions \u7684\u53e6\u4e00\u5927\u4f18\u52bf\u5728\u4e8e\u5b83\u4e0e GitHub \u672c\u8eab\u6df1\u5ea6\u96c6\u6210\u3002\u5f00\u53d1\u8005\u65e0\u9700\u989d\u5916\u914d\u7f6e\u7b2c\u4e09\u65b9 CI/CD \u5de5\u5177,\u53ea\u9700\u5229\u7528\u719f\u6089\u7684 GitHub \u73af\u5883\u5373\u53ef\u5b9e\u73b0\u81ea\u52a8\u5316\u3002\u8fd9\u4e0d\u4ec5\u7b80\u5316\u4e86\u5de5\u5177\u94fe,\u4e5f\u4f7f\u5f97\u5f00\u53d1\u3001\u6784\u5efa\u3001\u90e8\u7f72\u7684\u5168\u6d41\u7a0b\u53ef\u4ee5\u65e0\u7f1d\u8854\u63a5\u3002</p> <p>\u603b\u7684\u6765\u8bf4,GitHub Actions \u4e3a\u5f00\u53d1\u8005\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f3a\u5927\u3001\u7075\u6d3b\u3001\u96c6\u6210\u5ea6\u9ad8\u7684 CI/CD \u89e3\u51b3\u65b9\u6848\u3002\u5b83\u4e0d\u4ec5\u80fd\u591f\u5e2e\u52a9\u5f00\u53d1\u8005\u63d0\u9ad8\u4ea4\u4ed8\u6548\u7387,\u8fd8\u80fd\u4fc3\u8fdb\u4ee3\u7801\u4ed3\u5e93\u3001\u81ea\u52a8\u5316\u6d41\u7a0b\u548c\u90e8\u7f72\u73af\u5883\u7684\u826f\u6027\u4e92\u52a8,\u4e3a\u8f6f\u4ef6\u5f00\u53d1\u6ce8\u5165\u65b0\u7684\u6d3b\u529b\u3002\u968f\u7740 GitHub Actions \u7684\u6301\u7eed\u53d1\u5c55\u548c\u5b8c\u5584,\u76f8\u4fe1\u5b83\u5c06\u5728\u672a\u6765\u6210\u4e3a\u4e1a\u754c\u9886\u5148\u7684 CI/CD \u5de5\u5177\u4e4b\u4e00\u3002</p>"},{"location":"chap10/1action_docker/#docker","title":"Docker\u955c\u50cf\u540c\u6b65","text":"<p>\u5c06\u5916\u7f51\u7684\u955c\u50cf\u540c\u6b65\u5230\u56fd\u5185\u7684\u955c\u50cf\u4ed3\u5e93\u662f\u4e00\u4e2a\u5e38\u89c1\u7684\u9700\u6c42,\u7279\u522b\u662f\u5bf9\u4e8e\u4e00\u4e9b\u9700\u8981\u8bbf\u95ee\u56fd\u5916\u8d44\u6e90\u7684\u4f01\u4e1a\u548c\u5f00\u53d1\u8005\u6765\u8bf4\u3002\u8fd9\u6837\u53ef\u4ee5\u63d0\u9ad8\u955c\u50cf\u62c9\u53d6\u7684\u901f\u5ea6,\u540c\u65f6\u4e5f\u80fd\u89c4\u907f\u56e0\u7f51\u7edc\u95ee\u9898\u5bfc\u81f4\u7684\u955c\u50cf\u62c9\u53d6\u5931\u8d25\u3002\u4e0b\u9762\u6211\u5c06\u8be6\u7ec6\u4ecb\u7ecd\u5982\u4f55\u5b9e\u73b0\u8fd9\u4e00\u540c\u6b65\u8fc7\u7a0b:</p> <p>1.\u9009\u62e9\u5408\u9002\u7684\u56fd\u5185\u955c\u50cf\u4ed3\u5e93\u670d\u52a1\u5546</p> <p>\u56fd\u5185\u5e38\u89c1\u7684\u955c\u50cf\u4ed3\u5e93\u670d\u52a1\u5546\u6709\u963f\u91cc\u4e91\u5bb9\u5668\u955c\u50cf\u670d\u52a1\u3001\u817e\u8baf\u4e91\u955c\u50cf\u4ed3\u5e93\u3001\u534e\u4e3a\u4e91\u955c\u50cf\u4ed3\u5e93\u7b49\u3002\u9009\u62e9\u65f6\u53ef\u4ee5\u8003\u8651\u670d\u52a1\u8d28\u91cf\u3001\u4ef7\u683c\u3001\u4f7f\u7528\u4fbf\u5229\u6027\u7b49\u56e0\u7d20\u3002</p> <p>2.\u521b\u5efa\u56fd\u5185\u955c\u50cf\u4ed3\u5e93</p> <p>\u767b\u5f55\u9009\u5b9a\u7684\u955c\u50cf\u4ed3\u5e93\u670d\u52a1\u5546\u5e73\u53f0,\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u8fd9\u4e2a\u955c\u50cf\u4ed3\u5e93\u5c06\u4f5c\u4e3a\u540c\u6b65\u76ee\u6807\u4ed3\u5e93,\u7528\u4e8e\u5b58\u50a8\u4ece\u5916\u7f51\u540c\u6b65\u8fc7\u6765\u7684\u955c\u50cf\u3002</p> <p>3.\u914d\u7f6e\u955c\u50cf\u540c\u6b65\u4efb\u52a1</p> <ul> <li>\u5927\u591a\u6570\u955c\u50cf\u4ed3\u5e93\u670d\u52a1\u5546\u90fd\u63d0\u4f9b\u4e86\u955c\u50cf\u540c\u6b65\u7684\u529f\u80fd\u3002\u5728\u670d\u52a1\u5546\u7684\u63a7\u5236\u53f0\u4e0a,\u627e\u5230\u955c\u50cf\u540c\u6b65\u7684\u76f8\u5173\u529f\u80fd,\u914d\u7f6e\u540c\u6b65\u4efb\u52a1\u7684\u6e90\u955c\u50cf\u4ed3\u5e93(\u901a\u5e38\u662f\u5916\u7f51\u4ed3\u5e93)\u548c\u76ee\u6807\u955c\u50cf\u4ed3\u5e93(\u521a\u521a\u521b\u5efa\u7684\u56fd\u5185\u4ed3\u5e93)\u3002</li> <li>\u540c\u65f6\u53ef\u4ee5\u8bbe\u7f6e\u540c\u6b65\u7684\u955c\u50cf\u540d\u79f0\u3001\u6807\u7b7e\u3001\u540c\u6b65\u9891\u7387\u7b49\u53c2\u6570,\u4ee5\u6ee1\u8db3\u4e1a\u52a1\u9700\u6c42\u3002</li> </ul> <p>4.\u89e6\u53d1\u9996\u6b21\u540c\u6b65</p> <ul> <li>\u914d\u7f6e\u597d\u540c\u6b65\u4efb\u52a1\u540e,\u901a\u5e38\u9700\u8981\u624b\u52a8\u89e6\u53d1\u9996\u6b21\u540c\u6b65,\u4e4b\u540e\u5c31\u53ef\u4ee5\u8bbe\u7f6e\u4e3a\u81ea\u52a8\u540c\u6b65\u3002</li> <li>\u540c\u6b65\u8fc7\u7a0b\u4e2d,\u670d\u52a1\u5546\u7684\u63a7\u5236\u53f0\u4f1a\u5b9e\u65f6\u663e\u793a\u540c\u6b65\u8fdb\u5ea6\u548c\u72b6\u6001,\u65b9\u4fbf\u76d1\u63a7\u3002</li> </ul> <p>5.\u9a8c\u8bc1\u540c\u6b65\u7ed3\u679c</p> <p>\u540c\u6b65\u5b8c\u6210\u540e,\u767b\u5f55\u56fd\u5185\u955c\u50cf\u4ed3\u5e93\u68c0\u67e5\u76ee\u6807\u955c\u50cf\u662f\u5426\u5df2\u7ecf\u540c\u6b65\u6210\u529f\u3002\u53ef\u4ee5\u5c1d\u8bd5\u62c9\u53d6\u955c\u50cf\u5e76\u8fd0\u884c\u5bb9\u5668,\u9a8c\u8bc1\u955c\u50cf\u7684\u5b8c\u6574\u6027\u3002</p> <p>6.\u8c03\u6574\u540c\u6b65\u7b56\u7565</p> <p>\u6839\u636e\u5b9e\u9645\u4f7f\u7528\u60c5\u51b5,\u53ef\u4ee5\u9002\u5f53\u8c03\u6574\u540c\u6b65\u7684\u955c\u50cf\u540d\u79f0\u3001\u6807\u7b7e\u3001\u9891\u7387\u7b49\u53c2\u6570,\u4ee5\u4f18\u5316\u540c\u6b65\u6548\u679c\u3002\u6bd4\u5982\u53ef\u4ee5\u540c\u6b65\u5e38\u7528\u7684\u57fa\u7840\u955c\u50cf,\u800c\u5bf9\u4e8e\u53d8\u66f4\u9891\u7387\u8f83\u9ad8\u7684\u4e1a\u52a1\u955c\u50cf\u53ef\u4ee5\u7f29\u77ed\u540c\u6b65\u95f4\u9694\u3002</p> <p>\u901a\u8fc7\u4ee5\u4e0a\u6b65\u9aa4,\u5c31\u53ef\u4ee5\u5c06\u5916\u7f51\u7684\u955c\u50cf\u8d44\u6e90\u540c\u6b65\u5230\u56fd\u5185\u7684\u955c\u50cf\u4ed3\u5e93\u4e86\u3002\u8fd9\u6837\u4e0d\u4ec5\u53ef\u4ee5\u52a0\u5feb\u955c\u50cf\u62c9\u53d6\u901f\u5ea6,\u63d0\u9ad8\u5e94\u7528\u90e8\u7f72\u6548\u7387,\u8fd8\u80fd\u89c4\u907f\u56e0\u7f51\u7edc\u95ee\u9898\u5bfc\u81f4\u7684\u955c\u50cf\u62c9\u53d6\u5931\u8d25\u3002</p> <p>\u5bf9\u4e8e\u9700\u8981\u8bbf\u95ee\u56fd\u5916\u8d44\u6e90\u7684\u4f01\u4e1a\u548c\u5f00\u53d1\u8005\u6765\u8bf4,\u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u6709\u4ef7\u503c\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"chap10/1action_docker/#github-actions_1","title":"GitHub Actions\u540c\u6b65\u955c\u50cf","text":"<p>\u4f7f\u7528 GitHub Actions \u53ef\u4ee5\u975e\u5e38\u65b9\u4fbf\u5730\u5b9e\u73b0 Docker \u955c\u50cf\u7684\u540c\u6b65\u3002\u4e0b\u9762\u6211\u4eec\u6765\u8be6\u7ec6\u4ecb\u7ecd\u4e00\u4e0b\u5177\u4f53\u7684\u914d\u7f6e\u6b65\u9aa4:</p> <p>1.\u5728 GitHub \u4ed3\u5e93\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5de5\u4f5c\u6d41\u6587\u4ef6:</p> <p>\u5728 <code>.github/workflows</code> \u76ee\u5f55\u4e0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 YAML \u6587\u4ef6,\u4f8b\u5982 <code>docker-sync.yml</code>\u3002</p> <p>2.\u5728\u5de5\u4f5c\u6d41\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u5185\u5bb9:</p> <pre><code>name: Docker Image Sync\n\non:\n  push:\n    branches: [ \"main\" ]\n  pull_request:\n    branches: [ \"main\" ]\n\njobs:\n\n  sync:\n    runs-on: ubuntu-latest\n\n    steps:\n    - uses: actions/checkout@v2\n\n    - name: Set up QEMU\n      uses: docker/setup-qemu-action@v1\n\n    - name: Set up Docker Buildx\n      uses: docker/setup-buildx-action@v1\n\n    - name: Login to Docker Hub\n      uses: docker/login-action@v1\n      with:\n        username: ${{ secrets.DOCKER_USERNAME }}\n        password: ${{ secrets.DOCKER_PASSWORD }}\n\n    - name: Sync Docker Image\n      run: |\n        docker pull &lt;source-image-name&gt;:&lt;source-tag&gt;\n        docker tag &lt;source-image-name&gt;:&lt;source-tag&gt; &lt;target-image-name&gt;:&lt;target-tag&gt;\n        docker push &lt;target-image-name&gt;:&lt;target-tag&gt;\n</code></pre> <p>\u8fd9\u4e2a\u5de5\u4f5c\u6d41\u5b9a\u4e49\u4e86\u5728 main \u5206\u652f\u4e0a\u7684 <code>push</code> \u548c <code>pull_request</code> \u4e8b\u4ef6\u89e6\u53d1\u65f6\u6267\u884c\u540c\u6b65\u4efb\u52a1\u3002</p> <p>3.\u914d\u7f6e Docker \u767b\u5f55\u51ed\u8bc1:</p> <p>\u5728 GitHub \u4ed3\u5e93\u7684 <code>Settings &gt; Secrets</code> \u9875\u9762\u6dfb\u52a0 <code>DOCKER_USERNAME</code> \u548c <code>DOCKER_PASSWORD</code> \u4e24\u4e2a secret,\u5206\u522b\u5b58\u50a8 Docker \u955c\u50cf\u4ed3\u5e93\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u3002</p> <p>4.\u914d\u7f6e\u540c\u6b65\u6e90\u548c\u76ee\u6807\u955c\u50cf:</p> <p>\u5728 <code>Sync Docker Image</code> \u6b65\u9aa4\u4e2d,\u5c06 <code>&lt;source-image-name&gt;</code> \u548c <code>&lt;source-tag&gt;</code> \u66ff\u6362\u4e3a\u6e90\u955c\u50cf\u7684\u540d\u79f0\u548c\u6807\u7b7e,\u5c06 <code>&lt;target-image-name&gt;</code> \u548c<code>&lt;target-tag&gt;</code> \u66ff\u6362\u4e3a\u76ee\u6807\u955c\u50cf\u7684\u540d\u79f0\u548c\u6807\u7b7e\u3002</p> <p>5.\u63d0\u4ea4\u5de5\u4f5c\u6d41\u6587\u4ef6\u5e76\u63a8\u9001\u5230 GitHub \u4ed3\u5e93:</p> <p>\u4fdd\u5b58\u5de5\u4f5c\u6d41\u6587\u4ef6\u5e76\u63a8\u9001\u5230 GitHub \u4ed3\u5e93\u7684 main \u5206\u652f\u3002</p> <p>\u5b8c\u6210\u4ee5\u4e0a\u6b65\u9aa4\u540e,\u6bcf\u6b21 main \u5206\u652f\u4e0a\u6709 push \u6216 <code>pull_request</code>\u4e8b\u4ef6\u53d1\u751f\u65f6,GitHub Actions \u5c31\u4f1a\u81ea\u52a8\u89e6\u53d1\u955c\u50cf\u540c\u6b65\u4efb\u52a1\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f,\u5728\u5b9e\u9645\u4f7f\u7528\u65f6,\u60a8\u9700\u8981\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u4fee\u6539\u955c\u50cf\u540d\u79f0\u3001\u6807\u7b7e\u3001Docker \u4ed3\u5e93\u7b49\u76f8\u5173\u4fe1\u606f\u3002\u540c\u65f6,\u5982\u679c\u9700\u8981\u540c\u6b65\u591a\u4e2a\u955c\u50cf,\u53ef\u4ee5\u5728\u5de5\u4f5c\u6d41\u4e2d\u6dfb\u52a0\u591a\u4e2a Sync Docker Image \u6b65\u9aa4\u3002</p> <p>\u901a\u8fc7\u4f7f\u7528 GitHub Actions \u5b9e\u73b0 Docker \u955c\u50cf\u540c\u6b65,\u60a8\u53ef\u4ee5\u8f7b\u677e\u5730\u5c06\u5916\u7f51\u955c\u50cf\u540c\u6b65\u5230\u56fd\u5185\u4ed3\u5e93,\u63d0\u9ad8\u5e94\u7528\u90e8\u7f72\u7684\u6548\u7387\u548c\u53ef\u9760\u6027\u3002\u5982\u679c\u60a8\u6709\u4efb\u4f55\u5176\u4ed6\u95ee\u9898,\u6b22\u8fce\u968f\u65f6\u4e0e\u6211\u4ea4\u6d41\u3002</p>"},{"location":"chap10/1action_docker/#_1","title":"\u5b9e\u8df5\u8fc7\u7a0b","text":"<p>\u65b0\u5efa\u4e86\u4e00\u4e2aGitHub\u4ed3\u5e93\u7528\u4e8e\u4e2a\u4eba\u540c\u6b65\u955c\u50cf\u5230\u817e\u8baf\u4e91TCR\u3002</p> <p>\u5730\u5740: <code>https://github.com/xxx/docker_proxy</code></p> <p>\u6ce8\u610f\uff1aGitHub Actions\u8bed\u6cd5\u6709\u5f88\u591a\uff0c\u76ee\u524d\u5f88\u7b80\u5355\u624b\u52a8\u4fee\u6539ci.yaml\u4f1a\u81ea\u52a8\u89e6\u53d1action pipeline.</p> <p>\u521b\u5efa\u76ee\u6807\u955c\u50cf\u4ed3\u5e93</p> <p><code>ccr.ccs.tencentyun.com/devopsvip/inbound-agent</code></p> <p></p> <p>\u6dfb\u52a0\u4ed3\u5e93Secrets</p> <p>\u4fdd\u5b58\u76ee\u6807\u955c\u50cf\u4ed3\u5e93\u7684\u8ba4\u8bc1\u4fe1\u606f</p> <p></p> <p>CI\u6587\u4ef6\uff08.github/workflow/ci.yaml\uff09</p> <pre><code># This is a basic workflow to help you get started with Actions\n#VERSION 2\n#renew\n\nname: Docker image sync to tencent\nenv:\n  REGISTRY_URL: \"ccr.ccs.tencentyun.com/devopsvip\"\non:\n  push:\n    paths:\n      - '.github/workflows/**'\n\njobs:\n  build:\n    runs-on: ubuntu-20.04\n    steps:\n    - name: Push Docker images\n      run: |\n        docker pull jenkins/inbound-agent:latest-jdk17 \n        docker tag jenkins/inbound-agent:latest-jdk17 ${REGISTRY_URL}/inbound-agent:latest-jdk17\n        docker login -u ${{ secrets.TENCENTDOCKER_USER}} -p ${{ secrets.TENCENTDOCKER_PASSWD}} ${REGISTRY_URL}\n        docker push ${REGISTRY_URL}/inbound-agent:latest-jdk17\n</code></pre> <p>\u6548\u679c\u9a8c\u8bc1</p> <p></p> <p></p>"},{"location":"chap10/2action_workflow/","title":"GitHub Action - CI/CD Pipeline with Docker","text":""},{"location":"chap10/2action_workflow/#what-are-those-workflows","title":"What are those workflows?","text":""},{"location":"chap10/2action_workflow/#organizational-tasks","title":"Organizational tasks","text":"<p>WORKFLOWS</p> <ol> <li>Merged Code</li> <li>Test</li> <li>Build</li> <li>Deployment</li> </ol>"},{"location":"chap10/2action_workflow/#how-github-actions-automate-these-workflows","title":"How GitHub Actions automate these workflows?","text":"<p>when something happens IN or TO your repository</p> <ul> <li>PR created</li> <li>Contr. joined</li> <li>other apps</li> <li>Issue created</li> <li>PR merged</li> </ul> <p>automatic ACTIONS are executed in response</p> <ol> <li>LISTEN TO EVENT</li> <li>TRIGGER WORKFLOW</li> </ol>"},{"location":"chap10/2action_workflow/#cicd-with-github-actions","title":"CI/CD with Github Actions","text":"<p>integration with other technologies is important!</p> <p></p> <p></p> <p>https://github.com/Chao-Xi/action-project</p> <pre><code>$ tree .github/\n.github/\n\u2514\u2500\u2500 workflows\n    \u2514\u2500\u2500 ci.yml\n\n1 directory, 1 file\n</code></pre> <pre><code># This workflow will build a Java project with Gradle\n# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-gradle\n\nname: Java CI with Gradle\n\non:\n  push:\n    branches: [ main ]\n  pull_request:\n    branches: [ main ]\n\njobs:\n  build-java:\n\n    runs-on: ubuntu-latest\n    # runs-on: ${{matrix.os}}\n    # strategy:\n    #     matrix:\n    #       os: [ubuntu-latest, windows-latest, macOS-latest]\n\n    steps:\n    - uses: actions/checkout@v2\n\n    - name: Set up JDK 1.8\n      uses: actions/setup-java@v1\n      with:\n        java-version: 1.8\n\n    - name: Grant execute permission for gradlew\n      run: chmod +x gradlew\n\n    - name: Build with Gradle\n      run: ./gradlew build --warning-mode all\n\n    - name: Build and Push Docker Image\n      uses: mr-smithers-excellent/docker-build-push@v4\n      with:\n        image: nyjxi/action-demo-app\n        registry: docker.io\n        username: ${{ secrets.DOCKER_USERNAME }}\n        password: ${{ secrets.DOCKER_PASSWORD }}\n</code></pre>"},{"location":"chap10/2action_workflow/#syntax","title":"Syntax","text":"<p>1.name [optional]  name of GitHub event that triggers the workflow</p> <p>2.on [required]</p> <p>3.jobs [required]</p> <ul> <li>One or more jobs (jobs. ) <li>sequence of tasks (steps)</li> <li>Steps can run commands, setup tasks OR run an action</li> <p>Uses - selects an action</p> <ul> <li>uses: actions/checkout@v2</li> </ul> <p>https://github.com/actions/checkout</p> <p>4 steps  [required]</p> <p>can run commands, setup tasks OR run an action</p> <p>5 uses - selects an action</p> <p>6 run - runs a command-line command</p> <ul> <li>runs on Ubuntu, Windows or macOS</li> </ul> <pre><code>runs-on: ubuntu-latest\n</code></pre> <p></p> <ul> <li>Docker Build &amp; Push Action</li> </ul> <pre><code>uses: mr-smithers-excellent/docker-build-push@v4\n</code></pre> <p>https://github.com/docker/build-push-action</p> <p>https://github.com/mr-smithers-excellent/docker-build-push</p> <pre><code>- name: Build and Push Docker Image\n  uses: mr-smithers-excellent/docker-build-push@v4\n  with:\n    image: nyjxi/action-demo-app\n    registry: docker.io\n    username: ${{ secrets.DOCKER_USERNAME }}\n    password: ${{ secrets.DOCKER_PASSWORD }}\n</code></pre>"},{"location":"chap10/3action_events/","title":"GitHub Actions basic learning","text":"<p>Workflow Templates</p> <p>GitHub provided</p> <ul> <li>Recommended based on repo code</li> <li>Deployment (CD)</li> <li>Continuous Integration (CI)</li> <li>Security (code scanning)</li> </ul> <p>Create for your organization</p> <ul> <li>Promote consistency and best practice</li> </ul> <p>https://github.com/Chao-Xi/action-project</p>"},{"location":"chap10/3action_events/#1-triggering-workflows-with-events","title":"1 Triggering Workflows with Events","text":"<pre><code># This is a basic workflow to help you get started with Actions\n\nname: test\n\n# Controls when the workflow will run\non:\n  # Triggers the workflow on push or pull request events but only for the \"main\" branch\n  push:\n  # schedule:\n  # - cron: \"* * * * *\" \n  #   branches: [ \"main\" ]\n  # pull_request:\n  #   branches: [ \"main\" ]\n\n  # Allows you to run this workflow manually from the Actions tab\n  workflow_dispatch: # manual\n\n# A workflow run is made up of one or more jobs that can run sequentially or in parallel\njobs:\n  # This workflow contains a single job called \"build\"\n  build:\n    # The type of runner that the job will run on\n    runs-on: ubuntu-latest\n\n    # Steps represent a sequence of tasks that will be executed as part of the job\n    steps:\n      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it\n      - uses: actions/checkout@v4\n\n      # Runs a single command using the runners shell\n      - name: Run a one-line script\n        run: sleep 5\n\n      # Runs a set of commands using the runners shell\n      - name: Run a multi-line script\n        run: |\n          echo Add other actions to build,\n          echo test, and deploy your project.\n</code></pre>"},{"location":"chap10/3action_events/#push-triggers-workflow-run","title":"Push Triggers Workflow Run","text":"<pre><code>on:\n  # Triggers the workflow on push or pull request events but only for the \"main\" branch\n  push:\n</code></pre>"},{"location":"chap10/3action_events/#triggering-on-a-schedule","title":"Triggering on a Schedule","text":"<pre><code>schedule:\n- cron: \"* * * * *\" \n</code></pre> <p>https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows</p> <p></p>"},{"location":"chap10/3action_events/#manual-triggers-with-workflow_dispatch","title":"Manual Triggers with workflow_dispatch","text":"<pre><code> # Allows you to run this workflow manually from the Actions tab\n  workflow_dispatch: # manual\n</code></pre>"},{"location":"chap10/3action_events/#build-on-every-path","title":"build on Every Path","text":"<p>https://github.com/Chao-Xi/sampleapp-action/blob/main/.github/workflows/build.yaml</p> <pre><code>on:\n  push:\n    paths:\n      - \".github/workflows/build.yaml\"\n      - \".\"\n</code></pre>"},{"location":"chap10/3action_events/#using-the-gh-cli-to-view-runs-and-workflows","title":"Using the gh CLI to View Runs and Workflows","text":"<pre><code>gh auth status\n\ngh auth login\n\ngh workflow list\n\ngh run list\n\ngh run view 9474112383\n\ngh workflow list -repo g\u00fbt4/course-gh-actions\n</code></pre>"},{"location":"chap10/3action_events/#2-using-steps-on-runners","title":"2 Using Steps on Runners","text":"<p>https://github.com/Chao-Xi/action-sample/blob/main/.github/workflows/upper-build.yml</p>"},{"location":"chap10/3action_events/#2-1-jobs-have-steps","title":"2-1 Jobs Have Steps","text":"<pre><code>name: upper-build\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-build.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - run: go version\n</code></pre>"},{"location":"chap10/3action_events/#2-2-a-new-workflow-for-the-upper-build-and-adding-actionssetup-go","title":"2-2 A New Workflow for the Upper Build and Adding actions/setup-go","text":"<p>https://github.com/actions/setup-go</p> <pre><code>....\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - run: go version\n      - uses: actions/setup-go@v5\n        with:\n          go-version: '1.22'\n      - run: go version\n</code></pre> <p></p> <p></p>"},{"location":"chap10/3action_events/#2-3-understanding-actionscheckout","title":"2-3 Understanding actions/checkout","text":"<p>https://github.com/actions/checkout</p> <pre><code>...\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - run: pwd &amp;&amp; ls -al\n      - uses: actions/checkout@v4\n      - run: pwd &amp;&amp; ls -al\n      - run: go version\n      - uses: actions/setup-go@v5\n        with:\n          go-version: '1.22'\n      - run: go version\n</code></pre> <p>Set Working Directory on the Multiline Run Step</p>"},{"location":"chap10/3action_events/#2-4-set-working-directory-on-the-multiline-run-step","title":"2-4 Set Working Directory on the Multiline Run Step","text":"<pre><code>jobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - run: pwd &amp;&amp; ls -al\n      - uses: actions/checkout@v4\n      - run: pwd &amp;&amp; ls -al\n      - run: go version\n      - uses: actions/setup-go@v5\n        with:\n          go-version: '1.22'\n      - run: go version\n      - run: |\n          ls\n          go build\n          ls\n          go test\n          ./upper foo the bar\n        working-directory: upper\n        name: build and test\n</code></pre> <p>working-directory: upper</p> <p></p> <p></p>"},{"location":"chap10/3action_events/#2-5-go-version-file-and-cached-vs-downloaded-go-version","title":"2-5 go-version-file and Cached vs. Downloaded Go Version","text":"<pre><code> - uses: actions/setup-go@v5\n   with:\n    # go-version: '1.22'\n     go-version-file: ./upper/go.mod\n</code></pre> <p>Fix Caching of Dependencies</p> <p></p> <pre><code>...\nsteps:\n  - run: pwd &amp;&amp; ls -al\n  - uses: actions/checkout@v4\n  - run: pwd &amp;&amp; ls -al\n  - run: go version\n  - uses: actions/setup-go@v5\n    with:\n      # go-version: '1.22'\n      go-version-file: ./upper/go.mod\n      cache-dependency-path: ./upper/go.sum\n...\n</code></pre>"},{"location":"chap10/3action_events/#2-6-fix-caching-of-dependencies","title":"2-6 Fix Caching of Dependencies","text":"<pre><code> with:\n  # go-version: '1.22'\n   $    go-version-file: ./upper/go.mod\n          cache-dependency-path: ./upper/go.sum\n      - run: go mod download\n        working-directory: upper\n</code></pre>"},{"location":"chap10/3action_events/#2-7-running-on-macos-latest","title":"2-7 Running on macos-latest","text":"<pre><code>- uses: actions/setup-go@v5\n    with:\n      # go-version: '1.22'\n      go-version-file: ./upper/go.mod\n      cache-dependency-path: ./upper/go.sum\n</code></pre>"},{"location":"chap10/3action_events/#2-8-running-on-macos-latest","title":"2-8 Running on macos-latest","text":"<p>Macos-latest</p> <pre><code>..\njobs:\n  build:\n    # runs-on: ubuntu-latest\n    runs-on: macos-latest\n    steps:\n      - run: pwd &amp;&amp; ls -al\n      - uses: actions/checkout@v4\n      - run: pwd &amp;&amp; ls -al\n...\n</code></pre> <p></p>"},{"location":"chap10/3action_events/#2-9-registering-a-self-hosted-runner","title":"2-9 Registering a Self-hosted Runner","text":"<pre><code>$ curl -o actions-runner-osx-x64-2.320.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.320.0/actions-runner-osx-x64-2.320.0.tar.gz\n\n$ echo \"11e610adc1c3721a806d2a439d03d143cceeda7a63e794bfe75b45da55e308df  actions-runner-osx-x64-2.320.0.tar.gz\" | shasum -a 256 -c\n\nmkdir actions-runner &amp;&amp; cd actions-runner\n\n$ tar xzf ./actions-runner-osx-x64-2.320.0.tar.gz\n$ ./config.sh --url https://github.com/Chao-Xi/action-sample --token ....\n\n\n--------------------------------------------------------------------------------\n|        ____ _ _   _   _       _          _        _   _                      |\n|       / ___(_) |_| | | |_   _| |__      / \\   ___| |_(_) ___  _ __  ___      |\n|      | |  _| | __| |_| | | | | '_ \\    / _ \\ / __| __| |/ _ \\| '_ \\/ __|     |\n|      | |_| | | |_|  _  | |_| | |_) |  / ___ \\ (__| |_| | (_) | | | \\__ \\     |\n|       \\____|_|\\__|_| |_|\\__,_|_.__/  /_/   \\_\\___|\\__|_|\\___/|_| |_|___/     |\n|                                                                              |\n|                       Self-hosted runner registration                        |\n|                                                                              |\n--------------------------------------------------------------------------------\n\n# Authentication\n\n\n\u221a Connected to GitHub\n\n# Runner Registration\n\nEnter the name of the runner group to add this runner to: [press Enter for Default] \n\nEnter the name of runner: [press Enter for C02S710EG8WM] jacob1\n\nThis runner will have the following labels: 'self-hosted', 'macOS', 'X64' \nEnter any additional labels (ex. label-1,label-2): [press Enter to skip] \n\n\u221a Runner successfully added\n\u221a Runner connection is good\n\n# Runner settings\n\nEnter name of work folder: [press Enter for _work] \n\n\u221a Settings Saved.\n\n</code></pre> <pre><code>...\njobs:\n  build:\n    # runs-on: ubuntu-latest\n    # runs-on: macos-latest\n    runs-on: self-hosted\n...\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11275759756</p> <pre><code>$ ./run.sh\n\n\u221a Connected to GitHub\n\nCurrent runner version: '2.320.0'\n2024-10-10 14:07:53Z: Listening for Jobs\n2024-10-10 14:08:32Z: Running job: build\n2024-10-10 14:17:54Z: Job build completed with result: Canceled\n^CExiting...\nRunner listener exit with 0 return code, stop the service, no retry needed.\nExiting runner...\n</code></pre> <p></p>"},{"location":"chap10/3action_events/#3-injecting-secrets-and-environment-variables","title":"3 Injecting Secrets and Environment Variables","text":"<p>gh.yml</p> <pre><code>name: gh\n\non:\n  push:\n    paths:\n      - \".github/workflows/gh.yaml\"\n  workflow_dispatch: # manual\n\njobs:\n  cli:\n    runs-on: ubuntu-latest\n    env:\n      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n    steps:\n      - uses: actions/checkout@v4\n      - run: env\n      - run: gh --version\n      - run: gh auth status\n      - run: gh repo list\n      - run: gh issue list\n      - run: gh workflow list\n      - run: gh api /repos/:owner/:repo/actions/workflows\n</code></pre>"},{"location":"chap10/3action_events/#3-1-injecting-the-gh_token-environment-variable","title":"3-1 Injecting the <code>GH_TOKEN</code> Environment Variable","text":"<pre><code>env:\n  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11294465133/job/31414962742</p> <p></p> <pre><code>steps:\n  - uses: actions/checkout@v4\n</code></pre> <p>  https://github.com/Chao-Xi/action-sample/issues</p> <p></p> <p></p> <pre><code>Run gh api /repos/:owner/:repo/actions/workflows\n{\"total_count\":3,\"workflows\":\n[{\"id\":121669156,\"node_id\":\"W_kwDOM9zvsc4HQIYk\",\"name\":\"api-build\",\"path\":\".github/workflows/api-build.yml\",\"state\":\"active\",\"created_at\":\"2024-10-09T13:33:30.000Z\",\"updated_at\":\"2024-10-09T13:33:30.000Z\",\"url\":\"https://api.github.com/repos/Chao-Xi/action-sample/actions/workflows/121669156\",\"html_url\":\"https://github.com/Chao-Xi/action-sample/blob/main/.github/workflows/api-build.yml\",\"badge_url\":\"https://github.com/Chao-Xi/action-sample/workflows/api-build/badge.svg\"},\n{\"id\":121669168,\"node_id\":\"W_kwDOM9zvsc4HQIYw\",\"name\":\"upper-build\",\"path\":\".github/workflows/upper-build.yml\",\"state\":\"active\",\"created_at\":\"2024-10-09T13:33:30.000Z\",\"updated_at\":\"2024-10-09T13:33:30.000Z\",\"url\":\"https://api.github.com/repos/Chao-Xi/action-sample/actions/workflows/121669168\",\"html_url\":\"https://github.com/Chao-Xi/action-sample/blob/main/.github/workflows/upper-build.yml\",\"badge_url\":\"https://github.com/Chao-Xi/action-sample/workflows/upper-build/badge.svg\"},\n{\"id\":122078780,\"node_id\":\"W_kwDOM9zvsc4HRsY8\",\"name\":\"gh\",\"path\":\".github/workflows/gh.yaml\",\"state\":\"active\",\"created_at\":\"2024-10-11T14:42:47.000Z\",\"updated_at\":\"2024-10-11T14:42:47.000Z\",\"url\":\"https://api.github.com/repos/Chao-Xi/action-sample/actions/workflows/122078780\",\"html_url\":\"https://github.com/Chao-Xi/action-sample/blob/main/.github/workflows/gh.yaml\",\"badge_url\":\"https://github.com/Chao-Xi/action-sample/workflows/gh/badge.svg\"}]}\n</code></pre>"},{"location":"chap10/3action_events/#3-2-commenting-on-issues-with-actionsgithub-scripts","title":"3-2 Commenting on Issues with actions/github-scripts","text":"<p>write-thanks.yml</p> <pre><code>name: thanks\n\non:\n  issues:\n    types: opened\n  workflow_dispatch: # manual\n\njobs:\n  thanks:\n    runs-on: ubuntu-latest\n    permissions:\n      issues: write\n    steps:\n      - uses: actions/github-script@v7\n        id: issue_script\n        with:\n          github-token: ${{ secrets.GITHUB_TOKEN }}\n          script: |\n            const issue_number = context.issue.number || 2;\n            console.log(`issue_number: ${issue_number}`);\n\n            const owner = context.repo.owner;\n            const repo = context.repo.repo;\n\n            // lookup issue info\n            const issue = await github.rest.issues.get({\n              repo, owner, issue_number\n            });\n            console.log(`issue: ${issue}`);\n\n            // create comment thanking contributor\n            const comment = await github.rest.issues.createComment({\n              repo, owner, issue_number,\n              body: \"Thanks for your contribution!\"\n            });\n            console.log(`comment id: ${comment.data.id}`);\n            console.log(comment.data);\n\n            // auto label\n            github.rest.issues.addLabels({\n              repo, owner, issue_number,\n              labels: ['todo-review']\n            })\n\n            // make comment id available to subsequent steps\n            return comment.data.id;\n\n      - run: echo 'comment id=${{ steps.issue_script.outputs.result }}'\n</code></pre> <p>actions/github-script@v7</p> <p>https://github.com/actions/github-script</p> <p>https://github.com/Chao-Xi/action-sample/actions/workflows/write-thanks.yml</p> <p></p> <p>Set Token Permissions to Write to Issues</p> <pre><code>permissions:\n      issues: write\n</code></pre> <p></p> <pre><code>with:\n   github-token: ${{ secrets.GITHUB_TOKEN }}\n</code></pre>"},{"location":"chap10/3action_events/#3-3-adding-a-secret-for-an-openai_api_key","title":"3-3 Adding a Secret for an <code>OPENAI_API_KEY</code>","text":"<pre><code>name: butler\n\non:\n  issue_comment:\n    types: [created]\n\npermissions:\n  pull-requests: write\n\njobs:\n  chat:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: ca-dp/code-butler@v1\n        with:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n          # OPENAI_API_URL: ${{ vars.OPENAI_API_URL }}\n          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}\n          cmd: chat\n          comment_body: ${{ github.event.comment.body }}\n</code></pre>"},{"location":"chap10/3action_events/#4-publishing-artifacts","title":"4 Publishing Artifacts","text":""},{"location":"chap10/3action_events/#4-1-actionsupload-artifact","title":"4-1 actions/upload-artifact","text":"<pre><code>name: upper-capture\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-capture.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\njobs:\n  capture:\n    runs-on: macos-latest\n    defaults:\n      run:\n        working-directory: upper\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with:\n          go-version: 1.22\n          cache-dependency-path: ./upper/go.sum\n      - run: ls\n      - run: go build\n      - run: ls\n      - run: go test -v\n      - uses: actions/upload-artifact@v4\n        with:\n          path: ./upper/upper*\n          name: build\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11302253576/job/31437834265</p> <pre><code>- uses: actions/upload-artifact@v4\n        with:\n          path: ./upper/upper*\n          name: build\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11302382442/job/31438123876</p>"},{"location":"chap10/3action_events/#4-2-matrix-strategy-for-runner-os","title":"4-2 Matrix Strategy for Runner OS","text":"<p>upper-capture.yml</p> <pre><code>name: upper-capture\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-capture.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\njobs:\n  capture:\n    strategy:\n      matrix:\n        os: [ ubuntu-latest, windows-latest, macos-12 ]\n    runs-on: ${{ matrix.os }}\n    defaults:\n      run:\n        working-directory: upper\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with:\n          go-version: 1.22\n          cache-dependency-path: ./upper/go.sum\n      - run: ls\n      - run: go build\n      - run: ls\n      - run: go test -v\n      - uses: actions/upload-artifact@v4\n        with:\n          path: ./upper/upper*\n          name: \"build-${{ matrix.os }}\"\n\n</code></pre> <p></p> <p></p>"},{"location":"chap10/3action_events/#4-2-matrix-strategy-for-runner-os_1","title":"4-2 Matrix Strategy for Runner OS","text":"<pre><code>name: upper-capture\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-capture.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\njobs:\n  capture:\n    strategy:\n      matrix:\n        os: [ ubuntu-latest, windows-latest, macos-12 ]\n    runs-on: ${{ matrix.os }}\n    defaults:\n      run:\n        working-directory: upper\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with:\n          go-version: 1.22\n          cache-dependency-path: ./upper/go.sum\n      - run: ls\n      - run: go build\n      - run: ls\n      - run: go test -v\n      - uses: actions/upload-artifact@v4\n        with:\n          path: ./upper/upper*\n          name: \"build-${{ matrix.os }}\"\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11302490544</p> <p></p>"},{"location":"chap10/3action_events/#4-3-using-a-script-to-cross-compile","title":"4-3 Using a Script to Cross Compile","text":"<p><code>build.xplat.sh</code></p> <pre><code>#!/bin/bash\nset -e\n\necho \"::group::Testing...\"\ngo test -v\necho \"::endgroup::\"\n\nAPP_NAME=upper\nOUTPUT_DIR=bin\n\nmkdir -p $OUTPUT_DIR\n\nplatforms=(\"windows/amd64\" \"linux/amd64\" \"darwin/amd64\")\nfor platform in \"${platforms[@]}\"\ndo\n    platform_split=(${platform//\\// })\n    GOOS=${platform_split[0]}\n    GOARCH=${platform_split[1]}\n    output_name=$OUTPUT_DIR/$APP_NAME'-'$GOOS'-'$GOARCH\n    if [ $GOOS = \"windows\" ]; then\n        output_name+='.exe'\n    fi\n\n    echo \"::group::Building $output_name...\"\n    go clean # remove prior build (triggers more logging too)\n    env GOOS=$GOOS GOARCH=$GOARCH go build -x -o $output_name .\n    echo \"::endgroup::\"\n\ndone\n\necho \"::group::tree...\"\ntree\necho \"::endgroup::\"\n</code></pre> <p><code>upper-capture-script.yml</code></p> <pre><code>name: upper-cross\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-capture-script.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\njobs:\n  cross:\n    runs-on: ubuntu-latest\n    defaults:\n      run:\n        working-directory: upper\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with:\n          go-version: 1.22\n          cache-dependency-path: ./upper/go.sum\n      - run: ./build.xplat.sh\n      - uses: actions/upload-artifact@v4\n        with:\n          path: ./upper/bin/upper*\n          name: build\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11302653121/job/31438797061</p> <p></p>"},{"location":"chap10/3action_events/#4-4-creating-a-github-release","title":"4-4 Creating a GitHub Release","text":"<p><code>upper-capture-tag.yml</code></p> <pre><code>name: upper-cross\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-capture-tag.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\njobs:\n  cross:\n    permissions:\n      contents: write\n    runs-on: ubuntu-latest\n    defaults:\n      run:\n        working-directory: upper\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with:\n          go-version: 1.22\n          cache-dependency-path: ./upper/go.sum\n      - run: ./build.xplat.sh\n      - uses: softprops/action-gh-release@v2\n        with:\n          files: ./upper/bin/upper*\n          body: \"Binaries for the upper (go) command line tool!!!\"\n          tag_name: ${{ github.ref_name }}\n        if: startsWith(github.ref_name, 'refs/tags/')\n</code></pre> <p></p> <pre><code>cross:\n    permissions:\n      contents: write\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11302862521/job/31439286571</p> <pre><code>Run softprops/action-gh-release@v2\n\ud83d\udc69\u200d\ud83c\udfed Creating new GitHub release for tag main...\n\u2b06\ufe0f Uploading upper-windows-amd64.exe...\n\u2b06\ufe0f Uploading upper-linux-amd64...\n\u2b06\ufe0f Uploading upper-darwin-amd64...\n\ud83c\udf89 Release ready at https://github.com/Chao-Xi/action-sample/releases/tag/main\n</code></pre> <p></p> <p>Release on Tags Only</p> <p>add new tag</p> <p><code>if: startsWith(github.ref_name, 'refs/tags/')</code></p> <pre><code>$ git tag v1.1.0\n\n\n$ git tag\nv1.0.0\nv1.1.0\nv4.0.1\n\n$ git push --tags\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11303044702/job/31439694800</p> <p></p> <p></p> <p>https://github.com/Chao-Xi/action-sample/releases</p>"},{"location":"chap10/3action_events/#workflow-status-badges","title":"Workflow Status Badges","text":"<p>docker build #1</p> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11303941783</p> <pre><code>name: upper-images\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-images.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\npermissions:\n  packages: write\n  contents: read # not needed in public repos\n\njobs:\n  image:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - run: docker version\n      - run: docker image build -t upper .\n        working-directory: ./upper\n      - name: test it\n        run: docker container run upper hello wes\n</code></pre> <pre><code>Run docker container run upper hello wes\nHELLO WES\n</code></pre>"},{"location":"chap10/3action_events/#workflow-status-badges_1","title":"Workflow Status Badges","text":"<pre><code>[![upper-cross](https://github.com/Chao-Xi/action-sample/actions/workflows/upper-capture-tag.yml/badge.svg)](https://github.com/Chao-Xi/action-sample/actions/workflows/upper-capture-tag.yml)\n</code></pre>"},{"location":"chap10/3action_events/#check-docker-registry-variables","title":"Check docker registry variables","text":"<pre><code>name: Print environment variables\n\non:\n  workflow_dispatch:\n\njobs:\n  debug:\n    runs-on: ubuntu-latest\n\n    steps:\n      - name: Print\n        run: env | sort\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11304271867/job/31442445265</p> <pre><code>...\nGITHUB_REPOSITORY=Chao-Xi/action-sample\nGITHUB_REPOSITORY_ID=870117297\nGITHUB_REPOSITORY_OWNER=Chao-Xi\n...\n</code></pre>"},{"location":"chap10/3action_events/#push-the-image-to-ghcrio-to-create-a-package","title":"Push the Image to ghcr.io to Create a Package","text":"<pre><code>name: upper-images\n\non:\n  push:\n    paths:\n      - \".github/workflows/upper-images.yml\"\n      - \"upper/**\"\n  workflow_dispatch: # manual\n\npermissions:\n  packages: write\n  contents: read # not needed in public repos\n\njobs:\n  image:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - run: docker version\n      - run: docker image build -t upper .\n        working-directory: ./upper\n      - name: test it\n        run: docker container run upper hello wes\n      - uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.repository_owner }} # Chao-Xi\n          password: ${{ secrets.GITHUB_TOKEN }}\n      - run: docker tag upper ghcr.io/chao-xi/upper:latest\n      - run: docker tag upper ghcr.io/chao-xi/upper:${{ github.ref_name }}\n      - run: docker push ghcr.io/chao-xi/upper:latest\n      - run: docker push ghcr.io/chao-xi/upper:${{ github.ref_name }}\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11304324230/job/31442561439</p> <p></p> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11304324230</p> <p></p> <pre><code>$ docker run --rm -i -t ghcr.io/chao-xi/\nupper:latest test test test\nUnable to find image 'ghcr.io/chao-xi/upper:latest' locally\nlatest: Pulling from chao-xi/upper\n43c4264eed91: Already exists \n46d22ddfd777: Pull complete \nDigest: sha256:248970198c46065b0d81ba636c0e2f399e81c44db11133d4d5d1eabfb6a8ece2\nStatus: Downloaded newer image for ghcr.io/chao-xi/upper:latest\nTEST TEST TEST\n</code></pre>"},{"location":"chap10/3action_events/#push-the-image-to-ghcrio-to-create-a-package_1","title":"Push the Image to ghcr.io to Create a Package","text":"<p>https://github.com/Chao-Xi/action-sample/actions/workflows/upper-capture-tag.yml</p> <pre><code>$ git push tag v1.1.1\n\n$ git push --tags \n\nTotal 0 (delta 0), reused 0 (delta 0), pack-reused 0\nTo github.com:Chao-Xi/action-sample.git\n * [new tag]         v1.1.1 -&gt; v1.1.1\n</code></pre> <p></p> <p></p> <ul> <li>https://github.com/Chao-Xi/action-sample/actions/runs/11304435072</li> <li>https://github.com/Chao-Xi/action-sample/actions/workflows/upper-images.yml</li> </ul> <p></p>"},{"location":"chap10/3action_events/#5-deployment-pipelines","title":"5 Deployment Pipelines","text":""},{"location":"chap10/3action_events/#5-1-building-an-image-for-the-dotnet-web-api","title":"5-1 Building an Image for the dotnet Web API","text":"<p>https://github.com/Chao-Xi/action-sample/tree/main/api</p> <p>compose.yaml</p> <pre><code>services:\n  api:\n    image: nyjxi/actions-web:latest\n    build:\n      context: .\n      target: runner\n      platforms:\n        - linux/amd64\n    ports:\n      - 8080:80\n</code></pre> <p>build-only.sh</p> <pre><code>#!/bin/bash\n\nmy_app_version=$(git describe --tag)\n\ndocker compose build --pull --build-arg \"MY_APP_VERSION=$my_app_version\"\n</code></pre> <p>build-push.sh</p> <pre><code>#!/bin/bash\n\n./build-only.sh\ndocker compose push\n</code></pre>"},{"location":"chap10/3action_events/#5-2-workflow-to-push-an-image-to-docker-hub","title":"5-2 Workflow to Push an Image to Docker Hub","text":"<p>cd.yaml</p> <pre><code>name: cd\n\non:\n  push:\n    paths:\n      - \".github/workflows/cd.yml\"\n      - \"api/**\"\n  workflow_dispatch: # manual\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n        with:\n          fetch-depth: 0 # all commits, so we can generate version off of tags/commit sha...\n      - uses: docker/setup-buildx-action@v3\n      - run: docker buildx ls\n      - uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_PASS }}\n      - run: ./build-push.sh # can reuse local build scripts for CI/CD\n        working-directory: api\n        name: push to docker hub\n</code></pre> <pre><code>username: ${{ secrets.DOCKERHUB_USERNAME }}\npassword: ${{ secrets.DOCKERHUB_PASS }}\n</code></pre> <p></p> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11310904227</p> <p></p>"},{"location":"chap10/3action_events/#5-3-production-environment-requires-approval-to-deploy","title":"5-3 Production Environment Requires Approval to Deploy","text":"<pre><code>deploy:\n  runs-on: ubuntu-latest\n  environment:\n    name: production\n</code></pre> <p>Add environment: production</p> <p></p> <p>Add environment: secret</p> <p></p> <p></p> <pre><code>...\n  deploy:\n    runs-on: ubuntu-latest\n    environment:\n      name: production\n      url: ${{ steps.deploy.outputs.webapp-url }}\n    # needs: build\n    steps:\n      - uses: azure/login@v2\n        with:\n          creds: ${{ secrets.PROD }}\n</code></pre> <p></p> <p></p>"},{"location":"chap10/3action_events/#5-4-azurewebapps-deploy-action","title":"5-4 azure/webapps-deploy Action","text":"<pre><code>...\n  deploy:\n    runs-on: ubuntu-latest\n    environment:\n      name: production\n      url: ${{ steps.deploy.outputs.webapp-url }}\n    # needs: build\n    steps:\n      - uses: azure/login@v2\n        with:\n          creds: ${{ secrets.PROD }}\n      - uses: azure/webapps-deploy@v3\n        id: deploy\n        with:\n          app-name: gh-actions-web-api\n          images: weshigbee/actions-web:latest\n          resource-group-name: gh-actions\n</code></pre>"},{"location":"chap10/3action_events/#5-5-the-entire-cd-pipeline-works","title":"5-5 The Entire CD Pipeline Works!","text":"<pre><code>name: cd\n\non:\n  push:\n    paths:\n      - \".github/workflows/cd.yml\"\n      - \"api/**\"\n  workflow_dispatch: # manual\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n        with:\n          fetch-depth: 0 # all commits, so we can generate version off of tags/commit sha...\n      - uses: docker/setup-buildx-action@v3\n      - run: docker buildx ls\n      - uses: docker/login-action@v3\n        with:\n          username: ${{ secrets.DOCKERHUB_USERNAME }}\n          password: ${{ secrets.DOCKERHUB_PASS }}\n      - run: ./build-push.sh # can reuse local build scripts for CI/CD\n        working-directory: api\n        name: push to docker hub\n  deploy:\n    runs-on: ubuntu-latest\n    environment:\n      name: production\n      url: ${{ steps.deploy.outputs.webapp-url }}\n    needs: build\n    steps:\n      - uses: azure/login@v2\n        with:\n          creds: ${{ secrets.PROD }}\n      - uses: azure/webapps-deploy@v3\n        id: deploy\n        with:\n          app-name: gh-actions-web-api\n          images: weshigbee/actions-web:latest\n          resource-group-name: gh-actions\n</code></pre>"},{"location":"chap10/3action_events/#5-6-triggering-a-new-workflow-on-deployment-created","title":"5-6 Triggering a New Workflow on Deployment Created","text":"<p><code>cd-on-deploy.yml</code></p> <pre><code>name: cd-on-deploy\n\non:\n  deployment: # trigger when a deployment is created\n\njobs:\n  alerts:\n    runs-on: ubuntu-latest\n    steps:\n      - run: echo \"sending slack alert to get deploy approved...\"\n      - run: echo \"${{ toJson(github.event) }}\"\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11311547429/job/31457914181</p> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11311544551</p> <p></p> <p></p> <p></p>"},{"location":"chap10/3action_events/#passing-environment-variables-with-github_env-environment-file","title":"Passing Environment Variables with <code>GITHUB_ENV</code> Environment File","text":"<p><code>integration-tests.yml</code></p> <pre><code>name: integration-tests\n\non:\n  push:\n    paths:\n      - \".github/workflows/integration-tests.yml\"\n  workflow_dispatch: # manual\n\njobs:\n  generate:\n    outputs:\n      RANDOM_PASSWORD: ${{ env.RANDOM_PASSWORD }}\n    runs-on: ubuntu-latest\n    steps:\n      - run: env | sort\n      - run: echo \"RANDOM_PASSWORD=$(LC_ALL=C tr -dc A-Za-z0-9 &lt;/dev/urandom | head -c 12)\" &gt;&gt; \"$GITHUB_ENV\"\n      - run: echo \"$RANDOM_PASSWORD / ${{ env.RANDOM_PASSWORD }}\"\n      - run: env | sort\n      # - run: mysql ... -p $RANDOM_PASSWORD\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11311660841</p> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11311660841/job/31458165238</p> <p></p>"},{"location":"chap10/3action_events/#passing-outputs-between-dependent-jobs","title":"Passing Outputs between Dependent Jobs","text":"<p><code>integration-tests.yml</code></p> <pre><code>name: integration-tests\n\non:\n  push:\n    paths:\n      - \".github/workflows/integration-tests.yml\"\n  workflow_dispatch: # manual\n\njobs:\n  generate:\n    outputs:\n      RANDOM_PASSWORD: ${{ env.RANDOM_PASSWORD }}\n    runs-on: ubuntu-latest\n    steps:\n      - run: env | sort\n      - run: echo \"RANDOM_PASSWORD=$(LC_ALL=C tr -dc A-Za-z0-9 &lt;/dev/urandom | head -c 12)\" &gt;&gt; \"$GITHUB_ENV\"\n      - run: echo \"$RANDOM_PASSWORD / ${{ env.RANDOM_PASSWORD }}\"\n      - run: env | sort\n      # - run: mysql ... -p $RANDOM_PASSWORD\n  testing:\n    runs-on: ubuntu-latest\n    needs: generate\n    steps:\n       - run: echo \"${{ needs.generate.output.RANDOM_PASSWORD }}\"\n</code></pre> <p></p> <p></p>"},{"location":"chap10/3action_events/#using-a-job-container-to-provide-the-mysql-cli","title":"Using a Job Container to Provide the MySQL CLI","text":"<pre><code>name: integration-tests\n\non:\n  push:\n    paths:\n      - \".github/workflows/integration-tests.yml\"\n  workflow_dispatch: # manual\n\njobs:\n  generate:\n    outputs:\n      RANDOM_PASSWORD: ${{ env.RANDOM_PASSWORD }}\n    runs-on: ubuntu-latest\n    steps:\n      - run: env | sort\n      - run: echo \"RANDOM_PASSWORD=$(LC_ALL=C tr -dc A-Za-z0-9 &lt;/dev/urandom | head -c 12)\" &gt;&gt; \"$GITHUB_ENV\"\n      - run: echo \"$RANDOM_PASSWORD / ${{ env.RANDOM_PASSWORD }}\"\n      - run: env | sort\n      # - run: mysql ... -p $RANDOM_PASSWORD\n  testing:\n    runs-on: ubuntu-latest\n    needs: generate\n    container:\n      image: mysql:8.4\n    steps:\n       - run: echo \"${{ needs.generate.outputs.RANDOM_PASSWORD }}\"\n       - run: mysql --version\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11311814333</p> <p></p>"},{"location":"chap10/3action_events/#connecting-to-a-mysql-service-container","title":"Connecting to a MySQL Service Container!","text":"<pre><code>name: integration-tests\n\non:\n  push:\n    paths:\n      - \".github/workflows/integration-tests.yml\"\n  workflow_dispatch: # manual\n\njobs:\n  generate:\n    outputs:\n      RANDOM_PASSWORD: ${{ env.RANDOM_PASSWORD }}\n    runs-on: ubuntu-latest\n    steps:\n      - run: env | sort\n      - run: echo \"RANDOM_PASSWORD=$(LC_ALL=C tr -dc A-Za-z0-9 &lt;/dev/urandom | head -c 12)\" &gt;&gt; \"$GITHUB_ENV\"\n      - run: echo \"$RANDOM_PASSWORD / ${{ env.RANDOM_PASSWORD }}\"\n      - run: env | sort\n      # - run: mysql ... -p $RANDOM_PASSWORD\n  testing:\n    runs-on: ubuntu-latest\n    needs: generate\n    container:\n      image: mysql:8.4\n    services:\n      mysqlserver:\n        image: mysql:8.4\n        env:\n          MYSQL_ROOT_PASSWORD: ${{ needs.generate.outputs.RANDOM_PASSWORD }}\n          MYSQL_DATABASE: foothebar\n        options: --health-cmd=\"mysqladmin ping\" --health-interval=10s --health-timeout=5s --health-retries=3\n    steps:\n      - run: echo \"${{ needs.generate.outputs.RANDOM_PASSWORD }}\"\n      - run: mysql --version\n      - run: mysql -h mysqlserver -u root -p${{ needs.generate.outputs.RANDOM_PASSWORD }} -e \"SHOW DATABASES;\"\n      - run: echo \"job.services= ${{ toJson(job.services)}}\"\n      - run: echo \"job.container= ${{ toJson(job.container)}}\"\n</code></pre>"},{"location":"chap10/3action_events/#setting-up-a-codeql-workflow","title":"Setting up a CodeQL Workflow","text":"<p>https://github.com/Chao-Xi/action-sample/settings/security_analysis</p> <p></p> <p>https://github.com/Chao-Xi/action-sample/blob/main/.github/workflows/codeql.yml</p> <pre><code>name: \"CodeQL Advanced\"\n\non:\n  push:\n    paths:\n      - \".github/workflows/codeql.yml\"\n      - \"api/*\"\n  workflow_dispatch: # manual\n\njobs:\n  analyze:\n    name: Analyze (${{ matrix.language }})\n    # Runner size impacts CodeQL analysis time. To learn more, please see:\n    #   - https://gh.io/recommended-hardware-resources-for-running-codeql\n    #   - https://gh.io/supported-runners-and-hardware-resources\n    #   - https://gh.io/using-larger-runners (GitHub.com only)\n    # Consider using larger runners or machines with greater resources for possible analysis time improvements.\n    runs-on: ${{ (matrix.language == 'swift' &amp;&amp; 'macos-latest') || 'ubuntu-latest' }}\n    permissions:\n      # required for all workflows\n      security-events: write\n\n      # required to fetch internal or private CodeQL packs\n      packages: read\n\n      # only required for workflows in private repositories\n      actions: read\n      contents: read\n\n    strategy:\n      fail-fast: false\n      matrix:\n        include:\n        - language: csharp\n          build-mode: autobuild\n        - language: go\n          build-mode: autobuild\n        # CodeQL supports the following values keywords for 'language': 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'swift'\n        # Use `c-cpp` to analyze code written in C, C++ or both\n        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both\n        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both\n        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,\n        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.\n        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how\n        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages\n    steps:\n    - name: Checkout repository\n      uses: actions/checkout@v4\n\n    # Initializes the CodeQL tools for scanning.\n    - name: Initialize CodeQL\n      uses: github/codeql-action/init@v3\n      with:\n        languages: ${{ matrix.language }}\n        build-mode: ${{ matrix.build-mode }}\n        queries: \"+security-and-quality\"\n        # If you wish to specify custom queries, you can do so here or in a config file.\n        # By default, queries listed here will override any specified in a config file.\n        # Prefix the list here with \"+\" to use these queries and those in the config file.\n\n        # For more details on CodeQL's query packs, refer to: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs\n        # queries: security-extended,security-and-quality\n\n    # If the analyze step fails for one of the languages you are analyzing with\n    # \"We were unable to automatically build your code\", modify the matrix above\n    # to set the build mode to \"manual\" for that language. Then modify this step\n    # to build your code.\n    # \u2139\ufe0f Command-line programs to run using the OS shell.\n    # \ud83d\udcda See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun\n    - if: matrix.build-mode == 'manual'\n      shell: bash\n      run: |\n        echo 'If you are using a \"manual\" build mode for one or more of the' \\\n          'languages you are analyzing, replace this with the commands to build' \\\n          'your code, for example:'\n        echo '  make bootstrap'\n        echo '  make release'\n        exit 1\n\n    - name: Perform CodeQL Analysis\n      uses: github/codeql-action/analyze@v3\n      with:\n        category: \"/language:${{matrix.language}}\"\n</code></pre> <p>https://github.com/Chao-Xi/action-sample/actions/runs/11314646150</p> <p></p>"},{"location":"chap10/3action_events/#alerts-from-the-security-and-quality-suite","title":"Alerts from the security-and-quality Suite","text":""},{"location":"chap10/4action_interm/","title":"4action interm","text":""},{"location":"chap10/4action_interm/#avoiding-duplication-by-using-reusable-workflows","title":"Avoiding Duplication by Using Reusable Workflows","text":"<ol> <li>Avoiding Duplication with GitHub Actions Workflows:</li> <li> <p>To prevent duplication in GitHub Actions workflows, utilize reusable workflows, composite actions, and starter workflows.</p> </li> <li> <p>Reusable Workflows:</p> </li> <li>Reusable workflows are entire workflows that can be called by other workflows, stored in the same repository, or a central shared repository.</li> <li>Reusable workflows can have one or multiple jobs and are called as separate jobs, not just as steps within a job.</li> <li> <p>They show each step in the workflow in the log file output, unlike composite actions.</p> </li> <li> <p>Composite Actions:</p> </li> <li>Composite actions combine multiple steps into a single action, aiding in refactoring long YAML scripts and avoiding duplication.</li> <li> <p>They are a series of steps that can be called from within a job in another workflow.</p> </li> <li> <p>Starter Workflows:</p> </li> <li>Starter workflows are templates that provide a starting point for creating workflows, making it quicker and easier for teams to set up workflows for their projects.</li> <li> <p>They allow modifications for specific project requirements.</p> </li> <li> <p>Calling Reusable Workflows:</p> </li> <li>To call a reusable workflow stored in another repository, specify the owner name, repo name, and path to the workflow starting with .github/workflows.</li> <li>For reusable workflows in the same repo, use the relative path and call it using the file name.</li> <li> <p>Reusable workflows run as part of the caller workflow, allowing actions like checkout to work on the caller's code.</p> </li> <li> <p>Creating Reusable Workflows:</p> </li> <li>When creating a reusable workflow, define the trigger in the 'on' section as 'workflow_call'.</li> <li> <p>Pass variables, including secrets, from the caller workflow's repository to the reusable workflow for effective integration.</p> </li> <li> <p>Focus on Reusable Workflows:</p> </li> <li>The article primarily focuses on reusable workflows, demonstrating their utility and how to implement them effectively for workflow optimization.</li> </ol>"},{"location":"chap10/5action_crazy/","title":"5action crazy","text":"<p>GitHub Actions \u662fGitHub\u7684\u4e00\u4e2a\u7ec4\u4ef6\uff0c\u53ef\u8ba9\u60a8\u521b\u5efa\u81ea\u52a8\u5316\u5de5\u4f5c\u6d41\u7a0b\u3002\u901a\u8fc7\u8bb8\u591a\u53ef\u4ee5\u89e6\u53d1 \u5de5\u4f5c\u6d41\u7a0b\u7684\u4e0d\u540c\u4e8b\u4ef6\uff0c\u60a8\u53ef\u4ee5\u81ea\u7531\u5730\u6784\u5efa\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u81ea\u52a8\u5316\u3002</p> <p>\u867d\u7136\u6700\u5e38\u89c1\u7684\u7528\u4f8b\u662f\u6784\u5efa CI/CD \u7ba1\u9053\uff0c\u4f46\u53ef\u80fd\u6027\u51e0\u4e4e\u662f\u65e0\u9650\u7684\u3002\u67e5\u770b\u8fd9\u4efdawesome actions \u4ee5\u83b7\u5f97\u4e00\u4e9b\u7075\u611f</p>"},{"location":"chap10/5action_crazy/#if-statements","title":"If statements","text":"<p>\u4e4d\u4e00\u770b\u6587\u6863\uff0c\u4f3c\u4e4e\u4e0d\u652f\u6301\u8868\u8fbe\u5f0f\u4e2d\u7684if \u8bed\u53e5\u3002\u4f46\u662f\uff0c\u5982\u679c\u8bed\u53e5\u786e\u5b9e\u5b58\u5728\u3002\u770b\u770b\u4e0b\u9762\u7684\u5de5\u4f5c\u6d41\u7a0b</p> <pre><code>name: If\n\non: push\n\njobs:\n  if:\n    name: If\n    runs-on: ubuntu-20.04\n    strategy:\n      matrix:\n        job: [a, b]\n    steps:\n    - run: echo ${{ (matrix.job == 'a' &amp;&amp; 'foo') || 'bar' }}\n</code></pre> <p>Job a\u5c06\u8f93\u51fafoo\uff0c\u800cJob b \u5c06\u8f93\u51fa bar\u3002\u60a8\u53ef\u4ee5\u5c06\u8868\u8fbe\u5f0f\u89e3\u8bfb\u4e3a\u4ee5\u4e0b if \u8bed\u53e5(pseudo code):</p> <pre><code>if (matrix.job == 'a') {\n  echo 'foo'\n} else {\n  echo 'bar'\n}\n</code></pre> <p>\u5f53\u4e0e\u53ef\u7528\u7684\u51fd\u6570\u6216\u8fd0\u7b97\u7b26\u4e4b\u4e00\u7ed3\u5408\u4f7f\u7528\u65f6\uff0c\u5b83\u7684\u529f\u80fd\u4f1a \u66f4\u52a0\u5f3a\u5927\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u68c0\u67e5\u6570\u5b57\u7684\u503c</p> <pre><code>name: If\n\non: push\n\njobs:\n  if:\n    name: If\n    runs-on: ubuntu-20.04\n    strategy:\n      matrix:\n        node: [4, 6, 8, 10, 12]\n    steps:\n    - run: echo ${{ (matrix.node &gt; 8 &amp;&amp; 'foo') || 'bar' }}\n</code></pre> <p>\u603b\u7ed3\u4e00\u4e0b</p> <p>\u53ea\u6709\u5f53\u4e24\u4e2a\u53c2\u6570\u90fd\u4e3a true \u65f6\uff0cAND \u8fd0\u7b97\u7b26\u624d\u4f1a\u8fd4\u56detrue\u3002 </p> <p>\u5982\u679c\u7b2c\u4e00\u4e2a\u53c2\u6570Not true\uff0c\u5219\u65e0\u9700\u8bc4\u4f30\u7b2c\u4e8c\u4e2a\u53c2\u6570\uff0c\u56e0\u4e3a\u5b83\u662f\u5426\u4e3a\u771f\u5e76\u4e0d\u91cd\u8981\u3002OR \u8fd0\u7b97\u7b26\u7684\u5de5\u4f5c\u539f\u7406\u975e\u5e38\u76f8\u4f3c\u3002\u7531\u4e8e\u5982\u679c\u81f3\u5c11\u4e00\u4e2a\u53c2\u6570\u4e3a true \u5219\u8fd4\u56de true, \u56e0\u6b64\u5982\u679c\u7b2c\u4e00\u4e2a\u53c2\u6570\u5df2\u7ecf\u4e3a true\uff0c\u5219\u65e0\u9700\u8ba1\u7b97\u7b2c\u4e8c\u4e2a\u53c2\u6570\u3002</p> <p>\u56e0\u6b64\uff0c\u8fd9\u79cd\u884c\u4e3a\u4f1a\"\u77ed\u8def\"\u5bf9\u5e03\u5c14\u8fd0\u7b97\u7b26\u4f20\u9012\u7684\u53c2\u6570\u7684\u6c42\u503c\u3002\u8fd9\u4e24\u4e2a\u8fd0\u7b97\u7b26\u7684\u7ec4\u5408\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86 GitHub Actions\u4e2d\u7684 if \u529f\u80fd</p>"},{"location":"chap10/5action_crazy/#composing-secret-names","title":"Composing secret names","text":""},{"location":"chap2/1gitruner_intro/","title":"1 GitLab Runner \u7b80\u4ecb","text":""},{"location":"chap2/1gitruner_intro/#gitlab-runner","title":"GitLab Runner \u7b80\u4ecb","text":"<ul> <li><code>GitLab Runner</code>\u662f\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee\uff0c\u7528\u4e8e\u8fd0\u884c\u4f5c\u4e1a\u5e76\u5c06\u7ed3\u679c\u53d1\u9001\u56deGitLab0 </li> <li>\u4e0e<code>GitLabCI</code>\u7ed3\u5408\u4f7f\u7528\uff0c<code>GitLabCI</code>\u662f<code>GitLab</code>\u968f\u9644\u7684\u7528\u4e8e\u534f\u8c03\u4f5c\u4e1a\u7684\u5f00\u6e90\u6301\u7eed\u96c6\u6210\u670d\u52a1\u3002 </li> <li>GitLab Runner\u662f\u7528Go\u7f16\u5199\u7684\uff0c\u53ef\u4ee5\u5728Linux, macOS\u548cWindows\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u8fd0\u884c\u3002 </li> <li>\u5bb9\u5668\u90e8\u7f72\u9700\u4f7f\u7528\u6700\u65b0Docker\u7248\u672c\u3002<code>GitLab Runner</code>\u9700\u8981\u6700\u5c11\u7684<code>Docker V1.13.0</code>\u3002 </li> <li>GitLab Runner\u7248\u672c\u5e94\u4e0eGitLab\u7248\u672c\u540c\u6b65\u3002\uff08\u907f\u514d\u7248\u672c\u4e0d\u4e00\u81f4\u5bfc\u81f4\u5dee\u5f02\u5316\uff09 </li> <li>\u53ef\u4ee5\u6839\u636e\u9700\u8981\u914d\u7f6e\u4efb\u610f\u6570\u91cf\u7684 Runner</li> </ul> <p>GitLab Runner\u7c7b\u4f3c\u4e8eJenkins\u7684agent\uff0c\u6267\u884cCI\u6301\u7eed\u96c6\u6210\u3001\u6784\u5efa\u7684\u811a\u672c\u4efb\u52a1\u3002 </p> <p></p>"},{"location":"chap2/1gitruner_intro/#gitlab-runner_1","title":"GitLab Runner \u7b80\u4ecb","text":"<ul> <li> <p>\u4f5c\u4e1a\u8fd0\u884c\u63a7\u5236\uff1a\u540c\u65f6\u6267\u884c\u591a\u4e2a\u4f5c\u4e1a\u3002 </p> </li> <li> <p>\u4f5c\u4e1a\u8fd0\u884c\u73af\u5883\uff1a </p> <ul> <li>\u5728\u672c\u5730\u3001\u4f7f\u7528Docker\u5bb9\u5668\u3001\u4f7f\u7528Docker\u5bb9\u5668\u5e76\u901a\u8fc7SSH\u6267\u884c\u4f5c\u4e1a\u3002 </li> <li>\u4f7f\u7528Docker\u5bb9\u5668\u5728\u4e0d\u540c\u7684\u4e91\u548c\u865a\u62df\u5316\u7ba1\u7406\u7a0b\u5e8f\u4e0a\u81ea\u52a8\u7f29\u653e\u3002 </li> <li>\u8fde\u63a5\u5230\u8fdc\u7a0bSSH\u670d\u52a1\u5668\u3002 </li> </ul> </li> <li> <p>\u652f\u6301Bash, Windows Batch\u548cWindows PowerShell\u3002 </p> </li> <li>\u5141\u8bb8\u81ea\u5b9a\u4e49\u4f5c\u4e1a\u8fd0\u884c\u73af\u5883\u3002 </li> <li>\u81ea\u52a8\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\uff0c\u65e0\u9700\u91cd\u542f\u3002 </li> <li>\u6613\u4e8e\u5b89\u88c5\uff0c\u53ef\u4f5c\u4e3aLinux, macOS\u548cWindows\u7684\u670d\u52a1\u3002 </li> </ul>"},{"location":"chap2/1gitruner_intro/#gitlab-runner_2","title":"GitLab Runner \u7c7b\u578b\u4e0e\u72b6\u6001","text":"<p>\u7c7b\u578b </p> <ul> <li>shared\u5171\u4eab\u7c7b\u578b\uff0c\u8fd0\u884c\u6574\u4e2a\u5e73\u53f0\u9879\u76ee\u7684\u4f5c\u4e1a\uff08gitlab)</li> <li>group\u9879\u76ee\u7ec4\u7c7b\u578b\uff0c\u8fd0\u884c\u7279\u5b9agroup\u4e0b\u7684\u6240\u6709\u9879\u76ee\u7684\u4f5c\u4e1a\uff08group)</li> <li>specific\u9879\u76ee\u7c7b\u578b\uff0c\u8fd0\u884c\u6307\u5b9a\u7684\u9879\u76ee\u4f5c\u4e1a\uff08project) </li> </ul> <p>\u72b6\u6001 </p> <ul> <li>locked\uff1a\u9501\u5b9a\u72b6\u6001\uff0c\u65e0\u6cd5\u8fd0\u884c\u9879\u76ee\u4f5c\u4e1a </li> <li>paused\uff1a\u6682\u505c\u72b6\u6001\uff0c\u6682\u65f6\u4e0d\u4f1a\u63a5\u53d7\u65b0\u7684\u4f5c\u4e1a </li> </ul>"},{"location":"chap2/2gitrunner_install/","title":"2 GitLab Runner\u5b89\u88c5\u6ce8\u518c\u914d\u7f6e\u7ba1\u7406","text":"<p>GitLab Runner\u662f\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee\uff0c\u7528\u4e8e\u8fd0\u884c\u60a8\u7684\u4f5c\u4e1a\u5e76\u5c06\u7ed3\u679c\u53d1\u9001\u56deGitLab\u3002\u5b83\u4e0eGitLab CI\u7ed3\u5408\u4f7f\u7528\uff0cGitLab CI\u662fGitLab\u968f\u9644\u7684\u7528\u4e8e\u534f\u8c03\u4f5c\u4e1a\u7684\u5f00\u6e90\u6301\u7eed\u96c6\u6210\u670d\u52a1\u3002</p>"},{"location":"chap2/2gitrunner_install/#_1","title":"\u5b89\u88c5\u8981\u6c42","text":"<p>GitLab Runner\u662f\u7528Go\u7f16\u5199\u7684\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u8fd0\u884c\uff0c\u4e0d\u9700\u8981\u7279\u5b9a\u4e8e\u8bed\u8a00\u7684\u8981\u6c42\u3002\u5b83\u65e8\u5728\u5728GNU / Linux\uff0cmacOS\u548cWindows\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u8fd0\u884c\u3002\u53ea\u8981\u60a8\u53ef\u4ee5\u5728\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u7f16\u8bd1Go\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7edf\u5c31\u53ef\u80fd\u4f1a\u8fd0\u884c\u3002 \u5982\u679c\u8981\u4f7f\u7528Docker\uff0c\u8bf7\u5b89\u88c5\u6700\u65b0\u7248\u672c\u3002<code>GitLab Runner</code>\u9700\u8981\u6700\u5c11\u7684<code>Docker v1.13.0</code>\u3002</p> <p><code>GitLab Runner</code>\u7248\u672c\u5e94\u4e0e<code>GitLab</code>\u7248\u672c\u540c\u6b65\u3002</p> <p>\u53ef\u4ee5\u5728GNU / Linux\uff0cmacOS\uff0cFreeBSD\u548cWindows\u4e0a\u5b89\u88c5\u548c\u4f7f\u7528GitLab Runner \u3002\u60a8\u53ef\u4ee5\u4f7f\u7528Docker\u5b89\u88c5\u5b83\uff0c\u624b\u52a8\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528GitLab\u63d0\u4f9b\u7684rpm / deb\u8f6f\u4ef6\u5305\u7684\u5b58\u50a8\u5e93\u3002</p> <p></p> <p>Add GitLab's official repository\uff1a\u6dfb\u52a0\u5b98\u65b9\u4ed3\u5e93</p> <pre><code># For Debian/Ubuntu/Mint \ncurl -L https://packages.gitlab.com/install/repositories/runner/ditlab-runner/script.deb.sh | sudo bash\n\n# For RHEL/CentOS/Fedora \ncurl -L https://packages.gitlab.com/install/repositorles/runner/gatlab-runner/script.rpm.sh | sudo bash\n</code></pre> <p>Install the test vers!on of GitLab Runner: \u5b89\u88c5\u6700\u65b0\u7248\u672c</p> <pre><code>#For Debian/Ubuntu/Mint \nsudo apt-get install gitlab-runner \n\n\n#For RHEL/Centos/Fedora \nsudo yum install gitlab-runner \n</code></pre> <p>\u66f4\u65b0runner </p> <pre><code>#For Debian/Ubuntu/Mint \nsudo apt-get update\nsudo apt-get install gitlab-runner \n\n#For RHEL/CentOS/Fedora \nsudo  yum  update \nsudo install gitlab-runner \n</code></pre> <p>To install a specific version of GitLab Runner \u5b89\u88c5\u6307\u5b9a\u7248\u672c </p> <pre><code>#for DEB based systems \napt-cache madison gitlab-runner \nsudo apt-get install gitlab-runner=10.0.0 \n\n#for RPM based systems \nyum list gitlab-runner --showduplicates | sort -r\nsudo yum install gitlab-runner-10.0.0-1 \n</code></pre>"},{"location":"chap2/2gitrunner_install/#centos","title":"\u57fa\u4e8ecentos\u5b89\u88c5","text":"<p>\u4e0b\u8f7d\u8f6f\u4ef6\u5305</p> <ul> <li><code>https://gitlab-runner-downloads.s3.amazonaws.com/latest/index.html</code>\u4e0a\u627e\u5230\u6700\u65b0\u7684\u6587\u4ef6\u540d\u548c\u9009\u9879\u3002 </li> <li>\u9009\u62e9\u4e00\u4e2a\u7248\u672c\u5e76\u4e0b\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5982\u6587\u6863\u6240\u8ff0\uff0c\u8be5\u6587\u4ef6\u7528\u4e8e\u4e0b\u8f7d\u4efb\u4f55\u5176\u4ed6\u6807\u8bb0\u7684GitLab Runner\u53d1\u884c\u7248\u3002 </li> </ul> <pre><code>curl -LJO https://gitlab-runner-downloads.s3.amazonaws.com/latest/deb/gitlab-runner_&lt;arch&gt;.deb\n\ndpkg -i gitlab-runner_&lt;arch&gt;.deb\n\ndpkg -i gitlab-runner_&lt;arch&gt;.deb\n</code></pre> <pre><code>curl -LJO https://gitlab-runner-downloads.s3.amazonaws.com/latest/rpm/gitlab-runner_&lt;arch&gt;.rpm\n\nrpm -i gitlab-runner_&lt;arch&gt;.rpm\n\nrpm -Uvh gitlab-runner_&lt;arch&gt;.rpm\n</code></pre>"},{"location":"chap2/2gitrunner_install/#gitlab-runner","title":"Gitlab runner\u5b89\u88c5\u4e8c\u8fdb\u5236\u6587\u4ef6","text":"<pre><code>#Linux x86-64 \nsudo curl -L -output /usr/local/bin/gitlab-runner https://gitiab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64 \n\n#Linux x86 \nsudo curl -L -output /usr/local/bin/gitlab-runner https://gitiab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-386\n\n#Linux arm \nsudo curl -L -output /usr/local/bin/gitlab-runner https://gitiab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm\n\n\n#Linux arm64 \nsudo curl -L -output /usr/local/bin/gitlab-runner https://gitiab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm64\n</code></pre>"},{"location":"chap2/2gitrunner_install/#macos","title":"\u57fa\u4e8emacos\u7cfb\u7edf\u5b89\u88c5","text":"<ul> <li>\u624b\u52a8\u5b89\u88c5</li> </ul> <p>\u4e0b\u8f7d\u4e8c\u8fdb\u5236</p> <pre><code>sudo curl --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/v12.6/binaries/gitlab-runner-darwin-amd64\n</code></pre> <p>\u6388\u4e88\u5176\u6267\u884c\u6743\u529b</p> <pre><code>sudo chmod +x /usr/local/bin/gitlab-runner\n</code></pre> <p>\u5c06runner\u4f5c\u4e3a\u670d\u52a1\u5b89\u88c5\u5e76\u542f\u52a8\u5b83</p> <pre><code>gitlab-runner install\ngitlab-runner start\n</code></pre> <ul> <li>\u81ea\u52a8\u5b89\u88c5</li> </ul> <p>\u5b89\u88c5\uff0c\u542f\u52a8</p> <pre><code>brew install gitlab-runner \nbrew services start gitlab-runner \n</code></pre> <p>\u66f4\u65b0</p> <pre><code>gitlab-runner stop \n\nsudo curl --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/v12.6/binaries/gitlab-runner-darwin-amd64\n\nsudo chrnod +x /usr/local/bin/gitlab-runner \ngitlab-runner start \n</code></pre>"},{"location":"chap2/2gitrunner_install/#docker","title":"\u57fa\u4e8eDocker\u8fd0\u884c","text":"<pre><code>mkdir ~/data/gitlab-runner/config\ndocker run --rm -t -id -v  ~/data/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner:v15.1.0\n</code></pre>"},{"location":"chap2/2gitrunner_install/#_2","title":"\u5b89\u88c5\u603b\u7ed3","text":"<p>Linux\uff1a\u5728\u6e05\u534e\u6e90\u4e0b\u8f7d<code>runner rpm</code>\u5305/\u914d\u7f6e<code>yum</code>\u6e90\u5b89\u88c5\u3002</p> <pre><code>https://mirrors.tuna.tsinghua.edu.cn/gitlab-runner/yum/el7/gitlab-runner-12.9.0-1.x86_64.rpm\n</code></pre>"},{"location":"chap2/2gitrunner_install/#_3","title":"\u6211\u7684\u5b9e\u9a8c","text":"<pre><code>mkdir ~/k8s_test/gitlab/runner-config\n\ndocker run --rm -t -id -v  ~/k8s_test/gitlab/runner-config:/etc/gitlab-runner gitlab/gitlab-runner:latest\n\n</code></pre> <pre><code>$ docker ps | grep gitlab-runner\nb55224151446   gitlab/gitlab-runner:latest   \"/usr/bin/dumb-init \u2026\"   3 minutes ago   Up 3 minutes             inspiring_merkle\n\ndocker exec -it b55224151446 sh\n\n# gitlab-runner -h \nNAME:\n   gitlab-runner - a GitLab Runner\n\nUSAGE:\n   gitlab-runner [global options] command [command options] [arguments...]\n\nVERSION:\n   15.1.0 (76984217)\n\nAUTHOR:\n   GitLab Inc. &lt;support@gitlab.com&gt;\n\nCOMMANDS:\n     exec                  execute a build locally\n     list                  List all configured runners\n     run                   run multi runner service\n     register              register a new runner\n     install               install service\n     uninstall             uninstall service\n ...\n</code></pre>"},{"location":"chap2/2gitrunner_install/#2-gitlab-runner_1","title":"2 GitLab Runner\u6ce8\u518c","text":"<ul> <li> <p>\u6ce8\u518c\u6b65\u9aa4\uff1a</p> <ul> <li><code>\u83b7\u53d6 runner token -\u203a \u8fdb\u884c\u6ce8\u518c</code></li> </ul> </li> <li> <p>GitLabRunner \u7c7b\u578b</p> <ul> <li>shared\uff1a\u8fd0\u884c\u6574\u4e2a\u5e73\u53f0\u9879\u76ee\u7684\u4f5c\u4e1a(gitlab)</li> <li>group: \u8fd0\u884c\u7279\u5b9agroup\u4e0b\u7684\u6240\u6709\u9879\u76ee\u7684\u4f5c\u4e1a(group)</li> <li>specific\uff1a\u8fd0\u884c\u6307\u5b9a\u7684\u9879\u76ee\u4f5c\u4e1a(project)</li> <li>locked\uff1a \u65e0\u6cd5\u8fd0\u884c\u9879\u76ee\u4f5c\u4e1a</li> <li>paused\uff1a \u4e0d\u4f1a\u8fd0\u884c\u4f5c\u4e1a</li> </ul> </li> </ul>"},{"location":"chap2/2gitrunner_install/#2-1-token-shared","title":"2-1  \u83b7\u53d6\u6ce8\u518ctoken-shared\u7c7b\u578b","text":"<p>\u83b7\u53d6 <code>shared</code> \u7c7b\u578b <code>runnertoken</code></p> <p>\u8fdb\u5165\u7cfb\u7edf\u8bbe\u7f6e-\uff1e Runners</p> <p></p>"},{"location":"chap2/2gitrunner_install/#2-2-grouprunnertoken","title":"2-2 \u83b7\u53d6group\u7c7b\u578b\u7684runnertoken","text":"<p>\u8fdb\u5165group -&gt; Settings -&gt; CI/CD -&gt; Runners -&gt; Group Runners</p> <p></p>"},{"location":"chap2/2gitrunner_install/#2-3-token-specific","title":"2-3 \u83b7\u53d6\u6ce8\u518ctoken-specific\u7c7b\u578b","text":"<p>\u8fdb\u5165\u5177\u4f53\u7684\u9879\u76ee -&gt; Settings -&gt; CI/CD -&gt; Runners -&gt; Specific Runners</p> <p></p>"},{"location":"chap2/2gitrunner_install/#-","title":"\u8fdb\u884c\u6ce8\u518c-\u4ea4\u4e92\u5f0f","text":"<p><code>http://127.0.0.1:32220</code></p> <p>\u542f\u52a8\u5bb9\u5668\u4ea4\u4e92\u5f0f\u6ce8\u518c</p> <p></p> <ul> <li><code>http://127.0.0.1:32220/</code></li> <li><code>nzTshoYwsnCttkyzZBxE</code></li> <li><code>devops-service-runner</code></li> <li><code>build</code></li> </ul> <pre><code>docker run -it  -v  ~/data/gitlab-runner/config:/etc/gitlab-runner --network=host gitlab/gitlab-runner:v15.1.0 register\n</code></pre> <ul> <li><code>--network=host</code> \u662f\u5173\u952e\u4e2d\u7684\u5173\u952e\uff0c\u56e0\u4e3a\u4f60\u8981\u8bbf\u95ee\u672c\u5730\u7684localhost</li> </ul> <pre><code>$ docker run -it  --rm -v  ~/k8s_test/gitlab/runner-config:/etc/gitlab-runner --network=host  --restart=always gitlab/gitlab-runner:v15.1.0 register\nRuntime platform                                    arch=amd64 os=linux pid=7 revision=76984217 version=15.1.0\nRunning in system-mode.                            \n\nEnter the GitLab instance URL (for example, https://gitlab.com/):\nhttp://127.0.0.1:32220/\nEnter the registration token:\nnzTshoYwsnCttkyzZBxE\nEnter a description for the runner:\n[docker-desktop]: devops-service-runner\nEnter tags for the runner (comma-separated):\nbuild,deploy\nEnter optional maintenance note for the runner:\nn\nRegistering runner... succeeded                     runner=nzTshoYw\nEnter an executor: custom, docker, parallels, ssh, docker+machine, kubernetes, docker-ssh, shell, virtualbox, docker-ssh+machine:\nshell   \nRunner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!\n</code></pre> <pre><code>$ docker run -it -v  ~/k8s_test/gitlab/runner-config:/etc/gitlab-runner --network=host  --restart=always gitlab/gitlab-runner:v15.1.0 register\n</code></pre> <ul> <li>Enter the GitLab instance URL (for example, https://gitlab.com/):<ul> <li>\u8f93\u5165gitlab\u7684\u670d\u52a1URL</li> </ul> </li> <li>Enter the registration token:<ul> <li>\u8f93\u5165\u4ee4\u724c,\u53c2\u8003\u4e0a\u56fe</li> </ul> </li> <li>Enter a description for the runner:<ul> <li>\u8f93\u5165Runner\u63cf\u8ff0</li> </ul> </li> <li>Enter tags for the runner (comma-separated)<ul> <li>\u7ed9\u8fd9\u4e2agitlab-runner\u8f93\u5165\u4e00\u4e2a\u6807\u8bb0\uff0c\u8fd9\u4e2atag\u975e\u5e38\u91cd\u8981\uff0c\u5728\u540e\u7eed\u7684\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u9700\u8981\u4f7f\u7528\u8fd9\u4e2atag\u6765\u6307\u5b9agitlab-runner\uff08yml\u6587\u4ef6\uff0cjob\u901a\u8fc7\u8bbe\u7f6etags\u6807\u7b7e\u9009\u7528\u6307\u5b9a\u7684Runner)</li> </ul> </li> <li>Enter optional maintenance note for the runner:<ul> <li>\u8f93\u5165\u53ef\u9009\u7ef4\u62a4\u8bf4\u660e: Enter an executor: docker+machine, docker-ssh+machine, custom, docker-windows, docker-ssh, ssh, kubernetes, docker, parallels, shell, virtualbox:</li> </ul> </li> </ul> <p></p> <pre><code>$ docker exec -it aed10f1e614c sh\n# gitlab-runner run \nRuntime platform                                    arch=amd64 os=linux pid=21 revision=76984217 version=15.1.0\nStarting multi-runner from /etc/gitlab-runner/config.toml...  builds=0\nRunning in system-mode.                            \n\nConfiguration loaded                                builds=0\nlisten_address not defined, metrics &amp; debug endpoints disabled  builds=0\n[session_server].listen_address not defined, session endpoints disabled  builds=0\nERROR: Checking for jobs... forbidden               runner=faDQf6_F\nERROR: Checking for jobs... forbidden               runner=MsUXFgx3\nERROR: Checking for jobs... forbidden               runner=faDQf6_F\nERROR: Checking for jobs... forbidden               runner=MsUXFgx3\nERROR: Checking for jobs... forbidden               runner=faDQf6_F\nERROR: Runner http://127.0.0.1:32220/faDQf6_F1G4Ai1bM3yet is not healthy and will be disabled! \nERROR: Checking for jobs... forbidden               runner=MsUXFgx3\nERROR: Runner http://127.0.0.1:32220/MsUXFgx3dnRHknKssGoS is not healthy and will be disabled! \n</code></pre> <p></p> <ul> <li>http://localhost:32220/admin/runners/39</li> <li>http://localhost:32220/admin/runners/39/edit</li> </ul> <p></p>"},{"location":"chap2/2gitrunner_install/#_4","title":"\u6267\u884c\u5668\u529f\u80fd\u5bf9\u6bd4\u8868","text":"<ul> <li>Shell</li> <li>Docker</li> <li>Kubernetes</li> </ul>"},{"location":"chap2/2gitrunner_install/#-_1","title":"\u8fdb\u884c\u6ce8\u518c-\u975e\u4ea4\u4e92\u5f0f","text":"<pre><code>docker run -itd --rm -v  /Users/i515190/k8s_test/gitlab/runner-config:/etc/gitlab-runner --network=host gitlab/gitlab-runner:v15.1.0 register \\\n  --non-interactive \\\n  --executor \"shell\" \\\n  --url \"http://127.0.0.1:32220/\" \\\n  --registration-token \"nzTshoYwsnCttkyzZBxE\" \\\n  --description \"devops-runner\" \\\n  --tag-list \"build,deploy\" \\\n  --run-untagged=\"true\" \\\n  --locked=\"false\" \\\n  --access-level=\"not_protected\"\n</code></pre>"},{"location":"chap2/2gitrunner_install/#_5","title":"\u5e38\u7528\u547d\u4ee4","text":""},{"location":"chap2/2gitrunner_install/#_6","title":"\u542f\u52a8\u547d\u4ee4","text":"<pre><code>gitlab-runner --debug &lt;command&gt;   #\u8c03\u8bd5\u6a21\u5f0f\u6392\u67e5\u9519\u8bef\u7279\u522b\u6709\u7528\u3002\ngitlab-runner &lt;command&gt; --help    #\u83b7\u53d6\u5e2e\u52a9\u4fe1\u606f\ngitlab-runner run       #\u666e\u901a\u7528\u6237\u6a21\u5f0f  \u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e ~/.gitlab-runner/config.toml\nsudo gitlab-runner run  # \u8d85\u7ea7\u7528\u6237\u6a21\u5f0f  \u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e/etc/gitlab-runner/config.toml\n</code></pre>"},{"location":"chap2/2gitrunner_install/#_7","title":"\u6ce8\u518c\u547d\u4ee4","text":"<pre><code>gitlab-runner register  #\u9ed8\u8ba4\u4ea4\u4e92\u6a21\u5f0f\u4e0b\u4f7f\u7528\uff0c\u975e\u4ea4\u4e92\u6a21\u5f0f\u6dfb\u52a0 --non-interactive\ngitlab-runner list      #\u6b64\u547d\u4ee4\u5217\u51fa\u4e86\u4fdd\u5b58\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6240\u6709\u8fd0\u884c\u7a0b\u5e8f\ngitlab-runner verify    #\u6b64\u547d\u4ee4\u68c0\u67e5\u6ce8\u518c\u7684runner\u662f\u5426\u53ef\u4ee5\u8fde\u63a5\uff0c\u4f46\u4e0d\u9a8c\u8bc1GitLab\u670d\u52a1\u662f\u5426\u6b63\u5728\u4f7f\u7528runner\u3002--delete \u5220\u9664\ngitlab-runner unregister   #\u8be5\u547d\u4ee4\u4f7f\u7528GitLab\u53d6\u6d88\u5df2\u6ce8\u518c\u7684runner\u3002\n\n\n#\u4f7f\u7528\u4ee4\u724c\u6ce8\u9500\ngitlab-runner unregister --url http://gitlab.example.com/ --token t0k3n\n\n#\u4f7f\u7528\u540d\u79f0\u6ce8\u9500\uff08\u540c\u540d\u5220\u9664\u7b2c\u4e00\u4e2a\uff09\ngitlab-runner unregister --name test-runner\n\n#\u6ce8\u9500\u6240\u6709\ngitlab-runner unregister --all-runners\n</code></pre>"},{"location":"chap2/2gitrunner_install/#_8","title":"\u670d\u52a1\u7ba1\u7406","text":"<pre><code>gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner\n\n# --user\u6307\u5b9a\u5c06\u7528\u4e8e\u6267\u884c\u6784\u5efa\u7684\u7528\u6237\n#`--working-directory  \u6307\u5b9a\u5c06\u4f7f\u7528**Shell** executor \u8fd0\u884c\u6784\u5efa\u65f6\u6240\u6709\u6570\u636e\u5c06\u5b58\u50a8\u5728\u5176\u4e2d\u7684\u6839\u76ee\u5f55\n\ngitlab-runner uninstall #\u8be5\u547d\u4ee4\u505c\u6b62\u8fd0\u884c\u5e76\u4ece\u670d\u52a1\u4e2d\u5378\u8f7dGitLab Runner\u3002\n\ngitlab-runner start     #\u8be5\u547d\u4ee4\u542f\u52a8GitLab Runner\u670d\u52a1\u3002\n\ngitlab-runner stop      #\u8be5\u547d\u4ee4\u505c\u6b62GitLab Runner\u670d\u52a1\u3002\n\ngitlab-runner restart   #\u8be5\u547d\u4ee4\u5c06\u505c\u6b62\uff0c\u7136\u540e\u542f\u52a8GitLab Runner\u670d\u52a1\u3002\n\ngitlab-runner status #\u6b64\u547d\u4ee4\u663e\u793aGitLab Runner\u670d\u52a1\u7684\u72b6\u6001\u3002\u5f53\u670d\u52a1\u6b63\u5728\u8fd0\u884c\u65f6\uff0c\u9000\u51fa\u4ee3\u7801\u4e3a\u96f6\uff1b\u800c\u5f53\u670d\u52a1\u672a\u8fd0\u884c\u65f6\uff0c\u9000\u51fa\u4ee3\u7801\u4e3a\u975e\u96f6\n</code></pre>"},{"location":"chap2/2gitrunner_install/#3-gitlabcicd","title":"3 GitLab\u7684cicd\u81ea\u52a8\u53d1\u5e03\u6784\u5efa\u6d41\u7a0b","text":"<pre><code>$ docker exec -it aed10f1e614c sh\n# gitlab-runner run \n</code></pre>"},{"location":"chap2/2gitrunner_install/#create-sample-gitlab-maven-repo","title":"Create Sample Gitlab Maven repo","text":"<pre><code>http://localhost:32220/-/profile/preferences\n</code></pre> <p>User Settings -&gt; SSH keys</p> <p></p> <p></p> <pre><code>$ git clone ssh://git@localhost:30022/gitlab-instance-8f6af96c/demo-mvn-project.git\nCloning into 'demo-mvn-project'...\nremote: Enumerating objects: 3, done.\nremote: Counting objects: 100% (3/3), done.\nremote: Compressing objects: 100% (2/2), done.\nremote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0\nReceiving objects: 100% (3/3), done.\n</code></pre> <p>Clone Sample Maven Code</p> <p><code>https://github.com/jenkins-docs/simple-java-maven-app</code></p> <pre><code>cd simple-java-maven-app\ncp * ../demo-mvn-project\n\n\ngit add -A\ngit push -uf origin main\n\n</code></pre>"},{"location":"chap2/2gitrunner_install/#_9","title":"\u8fd0\u884c\u6d41\u6c34\u7ebf\u4efb\u52a1","text":"<p><code>.gitlab-ci.yml</code></p> <pre><code>stages:\n  - build\n  - deploy\n\n\nbuild:\n  stage: build\n  tags:\n    - build\n  only:\n    - main\n  script:\n    - echo \"mvn clean \"\n    - echo \"mvn install\"\n\n\ndeploy:\n  stage: deploy\n  tags:\n    - deploy\n  only:\n    - main\n  script:\n    - echo \"hello deploy\"\n</code></pre> <p></p> <p></p>"},{"location":"chap3/1gitlab_pip1/","title":"GitLabCI\u7cfb\u5217\u4e4b\u6d41\u6c34\u7ebf\u8bed\u6cd5","text":""},{"location":"chap3/1gitlab_pip1/#1-pipeline-1","title":"1 Pipeline \u8bed\u6cd5 1","text":"<p><code>job/script/before_script/after_script/stages/stage/variables</code></p> <pre><code>$ docker exec -it aed10f1e614c sh\n# gitlab-runner start\n# gitlab-runner verify\nRuntime platform                                    arch=amd64 os=linux pid=561 revision=76984217 version=15.1.0\nRunning in system-mode.                            \n\nERROR: Verifying runner... is removed               runner=faDQf6_F\nERROR: Verifying runner... is removed               runner=MsUXFgx3\nVerifying runner... is alive                        runner=Df8p4oox\nFATAL: Failed to verify runners  \n</code></pre>"},{"location":"chap3/1gitlab_pip1/#job","title":"job","text":"<p>\u5728\u6bcf\u4e2a\u9879\u76ee\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u540d\u4e3a <code>.gitlab-ci.yml</code> \u7684YAML\u6587\u4ef6\u914d\u7f6e<code>GitLab CI / CD</code> \u7ba1\u9053\u3002</p> <ul> <li>\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u6216\u591a\u4e2a\u4f5c\u4e1a(job)\u3002</li> <li>\u6bcf\u4e2a\u4f5c\u4e1a\u5fc5\u987b\u5177\u6709\u552f\u4e00\u7684\u540d\u79f0\uff08\u4e0d\u80fd\u4f7f\u7528\u5173\u952e\u5b57\uff09\u3002</li> <li>\u6bcf\u4e2a\u4f5c\u4e1a\u662f\u72ec\u7acb\u6267\u884c\u7684\u3002</li> <li>\u6bcf\u4e2a\u4f5c\u4e1a\u81f3\u5c11\u8981\u5305\u542b\u4e00\u4e2ascript\u3002</li> </ul> <pre><code>job1:\n  script: \"execute-script-for-job1\"\n\njob2:\n  script: \"execute-script-for-job2\"\n</code></pre> <p>\u8fd9\u91cc\u5728pipeline\u4e2d\u5b9a\u4e49\u4e86\u4e24\u4e2a\u4f5c\u4e1a\uff0c\u6bcf\u4e2a\u4f5c\u4e1a\u8fd0\u884c\u4e0d\u901a\u7684\u547d\u4ee4\u3002\u547d\u4ee4\u53ef\u4ee5\u662fshell \u6216\u811a\u672c\u3002</p>"},{"location":"chap3/1gitlab_pip1/#script","title":"script","text":"<pre><code>job:\nscript:\n  - uname -a\n  -  bundle exec rspec\n</code></pre> <p>\u6ce8\u610f\uff1a\u6709\u65f6\uff0c script\u547d\u4ee4\u5c06\u9700\u8981\u7528\u5355\u5f15\u53f7\u6216\u53cc\u5f15\u53f7\u5f15\u8d77\u6765. \u4f8b\u5982\uff0c\u5305\u542b\u5192\u53f7\u547d\u4ee4\uff08 : \uff09\u9700\u8981\u52a0\u5f15\u53f7\uff0c\u4ee5\u4fbf\u88ab\u5305\u88f9\u7684YAML\u89e3\u6790\u5668\u77e5\u9053\u6765\u89e3\u91ca\u6574\u4e2a\u4e8b\u60c5\u4f5c\u4e3a\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\"\u952e\uff1a\u503c\"\u5bf9. \u4f7f\u7528\u7279\u6b8a\u5b57\u7b26\u65f6\u8981\u5c0f\u5fc3\uff1a<code>: \uff0c { \uff0c } \uff0c [ \uff0c ] \uff0c , \uff0c &amp; \uff0c * \uff0c # \uff0c ? \uff0c | \uff0c - \uff0c &lt; \uff0c &gt; \uff0c = ! \uff0c % \uff0c @</code> </p> <pre><code>before_script:\n  - echo \"before-script!!\"\n\nvariables:\n  DOMAIN: example.com\n\nstages:\n  - build\n  - test\n  - codescan\n  - deploy\n\nbuild:\n  before_script:\n    - echo \"before-script in job\"\n  stage: build\n  only:\n    - main\n  script:\n    - echo \"mvn clean \"\n    - echo \"mvn install\"\n    - echo \"$DOMAIN\"\n  after_script:\n    - echo \"after script in job\"\n\ncodescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - echo \"codescan\"\n  when: on_success\n\nunittest:\n  stage: test\n  script:\n    - echo \"run test\"  \n  when: delayed\n  start_in: '5'\n\n\n# deploy:\n#   stage: deploy\n#   tags:\n#     - deploy\n#   only:\n#     - main\n#   script:\n#     - echo \"hello deploy\"\n#   when: on_success\n\ndeploy:\n  stage: deploy\n  script:\n    - echo \"hello deploy\"\n    - sleep 2;\n  when: manual\n\nafter_script:\n  - echo \"after-script\"\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#before_script","title":"<code>before_script</code>","text":"<p>\u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a\u547d\u4ee4\uff0c\u8be5\u547d\u4ee4\u5728\u6bcf\u4e2a\u4f5c\u4e1a\u4e4b\u524d\u8fd0\u884c\u3002</p> <p>\u5fc5\u987b\u662f\u4e00\u4e2a\u6570\u7ec4\u3002\u6307\u5b9a\u7684script\u4e0e\u4e3b\u811a\u672c\u4e2d\u6307\u5b9a\u7684\u4efb\u4f55\u811a\u672c\u4e32\u8054\u5728\u4e00\u8d77\uff0c\u5e76\u5728\u5355\u4e2ashell\u4e2d\u4e00\u8d77\u6267\u884c\u3002</p> <p><code>before_script</code>\u5931\u8d25\u5bfc\u81f4\u6574\u4e2a\u4f5c\u4e1a\u5931\u8d25\uff0c\u5176\u4ed6\u4f5c\u4e1a\u5c06\u4e0d\u518d\u6267\u884c\u3002\u4f5c\u4e1a\u5931\u8d25\u4e0d\u4f1a\u5f71\u54cd<code>after_script</code>\u8fd0\u884c\u3002</p> <p></p>"},{"location":"chap3/1gitlab_pip1/#after_script","title":"<code>after_script</code>","text":"<ul> <li>\u7528\u4e8e\u5b9a\u4e49\u5c06\u5728\u6bcf\u4e2a\u4f5c\u4e1a\uff08\u5305\u62ec\u5931\u8d25\u7684\u4f5c\u4e1a\uff09\u4e4b\u540e\u8fd0\u884c\u7684\u547d\u4ee4\u3002</li> <li>\u8fd9\u5fc5\u987b\u662f\u4e00\u4e2a\u6570\u7ec4\u3002</li> <li>\u6307\u5b9a\u7684\u811a\u672c\u5728\u65b0\u7684shell\u4e2d\u6267\u884c\uff0c\u4e0e\u4efb\u4f55<code>before_script</code>\u6216script\u811a\u672c\u5206\u5f00\u3002</li> </ul> <p>\u53ef\u4ee5\u5728\u5168\u5c40\u5b9a\u4e49\uff0c\u4e5f\u53ef\u4ee5\u5728job\u4e2d\u5b9a\u4e49\u3002\u5728job\u4e2d\u5b9a\u4e49\u4f1a\u8986\u76d6\u5168\u5c40</p> <p></p> <pre><code>$ echo \"before-script!!\"\nbefore-script!!\n$ echo \"hello deploy\"\nhello deploy\n....\n....\n....\nRunning after script...\n$ echo \"after-script\"\nafter-script\nJob succeeded\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#stage","title":"stage","text":"<p>\u7528\u4e8e\u5b9a\u4e49\u4f5c\u4e1a\u53ef\u4ee5\u4f7f\u7528\u7684\u9636\u6bb5\uff0c\u5e76\u4e14\u662f\u5168\u5c40\u5b9a\u4e49\u7684\u3002\u540c\u4e00\u9636\u6bb5\u7684\u4f5c\u4e1a\u5e76\u884c\u8fd0\u884c\uff0c\u4e0d\u540c\u9636\u6bb5\u6309\u987a\u5e8f\u6267\u884c\u3002</p> <pre><code>stages\uff1a\n  - build\n  - test\n  - codescan\n  - deploy\n</code></pre> <p>\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e09\u4e2a\u9636\u6bb5\uff0c\u9996\u5148build\u9636\u6bb5\u5e76\u884c\u8fd0\u884c\uff0c\u7136\u540etest\u9636\u6bb5\u5e76\u884c\u8fd0\u884c\uff0c\u6700\u540edeploy\u9636\u6bb5\u5e76\u884c\u8fd0\u884c\u3002</p> <p>deploy\u9636\u6bb5\u8fd0\u884c\u6210\u529f\u540e\u5c06\u63d0\u4ea4\u72b6\u6001\u6807\u8bb0\u4e3apassed\u72b6\u6001\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u9636\u6bb5\u8fd0\u884c\u5931\u8d25\uff0c\u6700\u540e\u63d0\u4ea4\u72b6\u6001\u4e3afailed\u3002</p> <p></p>"},{"location":"chap3/1gitlab_pip1/#pre-post","title":"<code>. pre</code> &amp; <code>.post</code>","text":"<p><code>.pre</code> \u59cb\u7ec8\u662f\u6574\u4e2a\u7ba1\u9053\u7684\u7b2c\u4e00\u4e2a\u8fd0\u884c\u9636\u6bb5\uff0c<code>.post</code> \u59cb\u7ec8\u662f\u6574\u4e2a\u7ba1\u9053\u7684\u6700\u540e\u4e00\u4e2a\u8fd0\u884c\u9636\u6bb5\u3002</p> <p>\u7528\u6237\u5b9a\u4e49\u7684\u9636\u6bb5\u90fd\u5728\u4e24\u8005\u4e4b\u95f4\u8fd0\u884c\u3002<code>.pre</code>\u548c<code>.post</code>\u7684\u987a\u5e8f\u65e0\u6cd5\u66f4\u6539\u3002\u5982\u679c\u7ba1\u9053\u4ec5\u5305\u542b<code>.pre</code>\u6216<code>.post</code>\u9636\u6bb5\u7684\u4f5c\u4e1a\uff0c\u5219\u4e0d\u4f1a\u521b\u5efa\u7ba1\u9053\u3002</p> <p>\u672a\u5b9a\u4e49stages</p> <p>\u5168\u5c40\u5b9a\u4e49\u7684stages\u662f\u6765\u81ea\u4e8e\u6bcf\u4e2ajob\u3002\u5982\u679cjob\u6ca1\u6709\u5b9a\u4e49stage\u5219\u9ed8\u8ba4\u662ftest\u9636\u6bb5\u3002\u5982\u679c\u5168\u5c40\u672a\u5b9a\u4e49stages,\u5219\u6309\u987a\u5e8f\u8fd0\u884c build,test,deploy\u3002</p> <p></p> <p>\u5982\u679c\u4f5c\u4e1a\u4e2d\u5b9a\u4e49\u4e86\u5176\u4ed6\u9636\u6bb5\uff0c\u4f8b\u5982<code>\"codescan\"</code>\u5219\u4f1a\u51fa\u73b0\u9519\u8bef\u3002\u539f\u56e0\u662f\u56e0\u4e3a\u9664\u4e86<code>build test deploy</code>\u9636\u6bb5\u5916\u7684\u5176\u4ed6\u9636\u6bb5\u4f5c\u4e3a<code>.pre</code>\u8fd0\u884c\uff08\u4e5f\u5c31\u662f\u4f5c\u4e3a\u7b2c\u4e00\u4e2a\u9636\u6bb5\u8fd0\u884c\uff0c\u9700\u8981\u5c06\u6b64\u4f5c\u4e1a\u7684stage\u6307\u5b9a\u4e3a<code>.pre</code>\uff09\u3002</p> <pre><code>codescan:\n  stage: .pre\n  script:\n    - echo \"codescan\"\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#stagesstage","title":"\u5b9a\u4e49stages\u63a7\u5236stage\u8fd0\u884c\u987a\u5e8f","text":"<p>\u4e00\u4e2a\u6807\u51c6\u7684yaml\u6587\u4ef6\u4e2d\u662f\u9700\u8981\u5b9a\u4e49stages\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u5bf9\u6bcf\u4e2astage\u8fdb\u884c\u6392\u5e8f\u3002</p> <pre><code>stages:\n  - build\n  - test\n  - codescan\n  - deploy\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#stage_1","title":"stage","text":"<p>\u662f\u6309JOB\u5b9a\u4e49\u7684\uff0c\u5e76\u4e14\u4f9d\u8d56\u4e8e\u5168\u5c40\u5b9a\u4e49\u7684stages \u3002\u5b83\u5141\u8bb8\u5c06\u4f5c\u4e1a\u5206\u4e3a\u4e0d\u540c\u7684\u9636\u6bb5\uff0c\u5e76\u4e14\u540c\u4e00stage\u4f5c\u4e1a\u53ef\u4ee5\u5e76\u884c\u6267\u884c\uff08\u53d6\u51b3\u4e8e\u7279\u5b9a\u6761\u4ef6 \uff09</p> <pre><code>unittest:\n  stage: test\n  script:\n    - echo \"run test\"\n\ninterfacetest:\n  stage: test\n  script:\n    - echo \"run test\"\n</code></pre> <p></p> <p>\u53ef\u80fd\u9047\u5230\u7684\u95ee\u9898\uff1a\u9636\u6bb5\u5e76\u6ca1\u6709\u5e76\u884c\u8fd0\u884c\u3002</p> <p>\u5728\u8fd9\u91cc\u6211\u628a\u8fd9\u4e24\u4e2a\u9636\u6bb5\u5728\u540c\u4e00\u4e2arunner\u8fd0\u884c\u4e86\uff0c\u6240\u4ee5\u9700\u8981\u4fee\u6539runner\u6bcf\u6b21\u8fd0\u884c\u7684\u4f5c\u4e1a\u6570\u91cf\u3002\u9ed8\u8ba4\u662f1\uff0c\u6539\u4e3a10.</p> <p></p>"},{"location":"chap3/1gitlab_pip1/#variables","title":"variables","text":"<p>\u5b9a\u4e49\u53d8\u91cf\uff0cpipeline\u53d8\u91cf\u3001job\u53d8\u91cf\u3001Runner\u53d8\u91cf\u3002job\u53d8\u91cf\u4f18\u5148\u7ea7\u6700\u5927\u3002</p>"},{"location":"chap3/1gitlab_pip1/#2-pipeline-2","title":"2 Pipeline \u8bed\u6cd5 2","text":"<p><code>tags/allow failure/when/retry/timeout/parallel</code></p>"},{"location":"chap3/1gitlab_pip1/#tags-runner","title":"tags-\u6307\u5b9arunner","text":"<p>\u7528\u4e8e\u4ece\u5141\u8bb8\u8fd0\u884c\u8be5\u9879\u76ee\u7684\u6240\u6709Runner\u5217\u8868\u4e2d\u9009\u62e9\u7279\u5b9a\u7684Runner,\u5728Runner\u6ce8\u518c\u671f\u95f4\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9aRunner\u7684\u6807\u7b7e\u3002tags\u53ef\u8ba9\u60a8\u4f7f\u7528\u6307\u5b9a\u4e86\u6807\u7b7e\u7684\u8dd1\u6b65\u8005\u6765\u8fd0\u884c\u4f5c\u4e1a,\u6b64runner\u5177\u6709ruby\u548cpostgres\u6807\u7b7e\u3002</p> <pre><code>job:\n  tags:\n    - ruby\n    - postgres\n</code></pre> <p>\u7ed9\u5b9a\u5e26\u6709osx\u6807\u7b7e\u7684OS X Runner\u548c\u5e26\u6709windows\u6807\u7b7e\u7684Windows Runner\uff0c\u4ee5\u4e0b\u4f5c\u4e1a\u5c06\u5728\u5404\u81ea\u7684\u5e73\u53f0\u4e0a\u8fd0\u884c\u3002</p> <pre><code>\nwindows job:\n  stage:\n    - build\n  tags:\n    - windows\n  script:\n    - echo Hello, %USERNAME%!\n\nosx job:\n  stage:\n    - build\n  tags:\n    - osx\n  script:\n    - echo \"Hello, $USER!\"\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#allow_failure","title":"<code>allow_failure</code>","text":"<p><code>allow_failure</code> \u5141\u8bb8\u4f5c\u4e1a\u5931\u8d25\uff0c\u9ed8\u8ba4\u503c\u4e3afalse \u3002\u542f\u7528\u540e\uff0c\u5982\u679c\u4f5c\u4e1a\u5931\u8d25\uff0c\u8be5\u4f5c\u4e1a\u5c06\u5728\u7528\u6237\u754c\u9762\u4e2d\u663e\u793a\u6a59\u8272\u8b66\u544a. \u4f46\u662f\uff0c\u7ba1\u9053\u7684\u903b\u8f91\u6d41\u7a0b\u5c06\u8ba4\u4e3a\u4f5c\u4e1a\u6210\u529f/\u901a\u8fc7\uff0c\u5e76\u4e14\u4e0d\u4f1a\u88ab\u963b\u585e\u3002</p> <p>\u5047\u8bbe\u6240\u6709\u5176\u4ed6\u4f5c\u4e1a\u5747\u6210\u529f\uff0c\u5219\u8be5\u4f5c\u4e1a\u7684\u9636\u6bb5\u53ca\u5176\u7ba1\u9053\u5c06\u663e\u793a\u76f8\u540c\u7684\u6a59\u8272\u8b66\u544a\u3002\u4f46\u662f\uff0c\u5173\u8054\u7684\u63d0\u4ea4\u5c06\u88ab\u6807\u8bb0\u4e3a\"\u901a\u8fc7\"\uff0c\u800c\u4e0d\u4f1a\u53d1\u51fa\u8b66\u544a\u3002</p> <pre><code>job1:\n  stage: test\n  script:\n    - execute_script_that_will_fail\n  allow_failure: true\n</code></pre> <pre><code>codescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - ech \"codescan\"\n  allow_failure: failure\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#when-","title":"when-\u63a7\u5236\u4f5c\u4e1a\u8fd0\u884c","text":"<ul> <li><code>on_success</code>\u524d\u9762\u9636\u6bb5\u4e2d\u7684\u6240\u6709\u4f5c\u4e1a\u90fd\u6210\u529f\uff08\u6216\u7531\u4e8e\u6807\u8bb0\u4e3a<code>allow_failure</code>\u800c\u88ab\u89c6\u4e3a\u6210\u529f\uff09\u65f6\u624d\u6267\u884c\u4f5c\u4e1a\u3002\u8fd9\u662f\u9ed8\u8ba4\u503c\u3002</li> <li><code>on_failure</code>\u5f53\u524d\u9762\u9636\u6bb5\u51fa\u73b0\u5931\u8d25\u5219\u6267\u884c\u3002</li> <li><code>always</code> \u6267\u884c\u4f5c\u4e1a\uff0c\u800c\u4e0d\u7ba1\u5148\u524d\u9636\u6bb5\u7684\u4f5c\u4e1a\u72b6\u6001\u5982\u4f55\uff0c\u653e\u5230\u6700\u540e\u6267\u884c\u3002\u603b\u662f\u6267\u884c\u3002</li> <li><code>on_failure</code> \u5f53\u524d\u9762\u9636\u6bb5\u51fa\u73b0\u5931\u8d25\u65f6\u6267\u884c\u3002</li> <li><code>manual</code> \u624b\u52a8\u6267\u884c\u4f5c\u4e1a\u3002</li> <li><code>delayed</code> \u5ef6\u8fdf\u6267\u884c\u4f5c\u4e1a\u3002</li> </ul> <p>manual \u624b\u52a8</p> <p><code>manual</code> - \u624b\u52a8\u6267\u884c\u4f5c\u4e1a,\u4e0d\u4f1a\u81ea\u52a8\u6267\u884c\uff0c\u9700\u8981\u7531\u7528\u6237\u663e\u5f0f\u542f\u52a8. \u624b\u52a8\u64cd\u4f5c\u7684\u793a\u4f8b\u7528\u6cd5\u662f\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883. \u53ef\u4ee5\u4ece\u7ba1\u9053\uff0c\u4f5c\u4e1a\uff0c\u73af\u5883\u548c\u90e8\u7f72\u89c6\u56fe\u5f00\u59cb\u624b\u52a8\u64cd\u4f5c\u3002</p> <p>\u6b64\u65f6\u5728deploy\u9636\u6bb5\u6dfb\u52a0<code>manual</code>\uff0c\u5219\u6d41\u6c34\u7ebf\u8fd0\u884c\u5230<code>deploy</code>\u9636\u6bb5\u4e3a\u9501\u5b9a\u72b6\u6001\uff0c\u9700\u8981\u624b\u52a8\u70b9\u51fb\u6309\u94ae\u624d\u80fd\u8fd0\u884c<code>deploy</code>\u9636\u6bb5\u3002</p> <pre><code>codescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - echo \"codescan\"\n  when: on_success\n\nunittest:\n  stage: test\n  script:\n    - echo \"run test\"  \n  when: delayed\n  start_in: '5'\n\ndeploy:\n  stage: deploy\n  script:\n    - echo \"hello deploy\"\n    - sleep 2;\n  when: manual\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#delayed","title":"delayed \u5ef6\u8fdf","text":"<p>delayed \u5ef6\u8fdf\u4e00\u5b9a\u65f6\u95f4\u540e\u6267\u884c\u4f5c\u4e1a\uff08\u5728GitLab 11.14\u4e2d\u5df2\u6dfb\u52a0\uff09\u3002</p> <p>\u6709\u6548\u503c<code>'5',10 seconds,30 minutes, 1 day, 1 week</code> \u3002</p> <p></p>"},{"location":"chap3/1gitlab_pip1/#retry","title":"retry","text":"<p>\u914d\u7f6e\u5728\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\u91cd\u8bd5\u4f5c\u4e1a\u7684\u6b21\u6570\u3002</p> <p>\u5f53\u4f5c\u4e1a\u5931\u8d25\u5e76\u914d\u7f6e\u4e86retry \uff0c\u5c06\u518d\u6b21\u5904\u7406\u8be5\u4f5c\u4e1a\uff0c\u76f4\u5230\u8fbe\u5230retry\u5173\u952e\u5b57\u6307\u5b9a\u7684\u6b21\u6570\u3002\u5982\u679cretry\u8bbe\u7f6e\u4e3a2\uff0c\u5e76\u4e14\u4f5c\u4e1a\u5728\u7b2c\u4e8c\u6b21\u8fd0\u884c\u6210\u529f\uff08\u7b2c\u4e00\u6b21\u91cd\u8bd5\uff09\uff0c\u5219\u4e0d\u4f1a\u518d\u6b21\u91cd\u8bd5. retry\u503c\u5fc5\u987b\u662f\u4e00\u4e2a\u6b63\u6574\u6570\uff0c\u7b49\u4e8e\u6216\u5927\u4e8e0\uff0c\u4f46\u5c0f\u4e8e\u6216\u7b49\u4e8e2\uff08\u6700\u591a\u4e24\u6b21\u91cd\u8bd5\uff0c\u603b\u5171\u8fd0\u884c3\u6b21\uff09</p> <pre><code>unittest:\n  stage: test\n  retry: 2\n  script:\n    - ech \"run test\"\n</code></pre> <p></p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5c06\u5728\u6240\u6709\u5931\u8d25\u60c5\u51b5\u4e0b\u91cd\u8bd5\u4f5c\u4e1a\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u63a7\u5236retry\u54ea\u4e9b\u5931\u8d25\uff0c\u53ef\u4ee5\u662f\u5177\u6709\u4ee5\u4e0b\u952e\u7684\u54c8\u5e0c\u503c\uff1a</p> <ul> <li>max \uff1a\u6700\u5927\u91cd\u8bd5\u6b21\u6570.</li> <li>when \uff1a\u91cd\u8bd5\u5931\u8d25\u7684\u6848\u4f8b.</li> </ul> <p>\u6839\u636e\u9519\u8bef\u539f\u56e0\u8bbe\u7f6e\u91cd\u8bd5\u7684\u6b21\u6570\u3002</p> <pre><code>always \uff1a\u5728\u53d1\u751f\u4efb\u4f55\u6545\u969c\u65f6\u91cd\u8bd5\uff08\u9ed8\u8ba4\uff09.\nunknown_failure \uff1a\u5f53\u5931\u8d25\u539f\u56e0\u672a\u77e5\u65f6\u3002\nscript_failure \uff1a\u811a\u672c\u5931\u8d25\u65f6\u91cd\u8bd5\u3002\napi_failure \uff1aAPI\u5931\u8d25\u91cd\u8bd5\u3002\nstuck_or_timeout_failure \uff1a\u4f5c\u4e1a\u5361\u4f4f\u6216\u8d85\u65f6\u65f6\u3002\nrunner_system_failure \uff1a\u8fd0\u884c\u7cfb\u7edf\u53d1\u751f\u6545\u969c\u3002\nmissing_dependency_failure: \u5982\u679c\u4f9d\u8d56\u4e22\u5931\u3002\nrunner_unsupported \uff1aRunner\u4e0d\u53d7\u652f\u6301\u3002\nstale_schedule \uff1a\u65e0\u6cd5\u6267\u884c\u5ef6\u8fdf\u7684\u4f5c\u4e1a\u3002\njob_execution_timeout \uff1a\u811a\u672c\u8d85\u51fa\u4e86\u4e3a\u4f5c\u4e1a\u8bbe\u7f6e\u7684\u6700\u5927\u6267\u884c\u65f6\u95f4\u3002\narchived_failure \uff1a\u4f5c\u4e1a\u5df2\u5b58\u6863\u4e14\u65e0\u6cd5\u8fd0\u884c\u3002\nunmet_prerequisites \uff1a\u4f5c\u4e1a\u672a\u80fd\u5b8c\u6210\u5148\u51b3\u6761\u4ef6\u4efb\u52a1\u3002\nscheduler_failure \uff1a\u8c03\u5ea6\u7a0b\u5e8f\u672a\u80fd\u5c06\u4f5c\u4e1a\u5206\u914d\u7ed9\u8fd0\u884cscheduler_failure\u3002\ndata_integrity_failure \uff1a\u68c0\u6d4b\u5230\u7ed3\u6784\u5b8c\u6574\u6027\u95ee\u9898\u3002\n</code></pre> <p>\u5b9a\u4e49\u5f53\u51fa\u73b0\u811a\u672c\u9519\u8bef\u91cd\u8bd5\u4e24\u6b21\uff0c\u4e5f\u5c31\u662f\u4f1a\u8fd0\u884c\u4e09\u6b21\u3002</p> <pre><code>unittest:\n  stage: test\n  tags:\n    - build\n  script:\n    - ech \"run test\"  \n  when: delayed\n  retry:\n    max: 2\n    when: script_failure\n</code></pre> <p></p> <p>Retry : 3 times</p> <p></p> <pre><code>unittest:\n  stage: test\n  tags:\n    - build\n  script:\n    - ech \"run test\"  \n  when: delayed\n  start_in: '5'\n  allow_failure: true  # allow to fail\n  retry:\n    max: 2\n    when: script_failure\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#timeout","title":"timeout \u8d85\u65f6","text":"<p>\u7279\u5b9a\u4f5c\u4e1a\u914d\u7f6e\u8d85\u65f6\uff0c\u4f5c\u4e1a\u7ea7\u522b\u7684\u8d85\u65f6\u53ef\u4ee5\u8d85\u8fc7\u9879\u76ee\u7ea7\u522b\u7684\u8d85\u65f6\uff0c\u4f46\u4e0d\u80fd\u8d85\u8fc7Runner\u7279\u5b9a\u7684\u8d85\u65f6\u3002</p> <pre><code>build:\n  script: build.sh\n  timeout: 3 hours 30 minutes\n\ntest:\n  script: rspec\n  timeout: 3h 30m\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#_1","title":"\u9879\u76ee\u8bbe\u7f6e\u6d41\u6c34\u7ebf\u8d85\u65f6\u65f6\u95f4","text":"<p>\u8d85\u65f6\u5b9a\u4e49\u4e86\u4f5c\u4e1a\u53ef\u4ee5\u8fd0\u884c\u7684\u6700\u957f\u65f6\u95f4\uff08\u4ee5\u5206\u949f\u4e3a\u5355\u4f4d\uff09\u3002\u8fd9\u53ef\u4ee5\u5728\u9879\u76ee\u7684\"\u8bbe\u7f6e\"&gt;\" CI / CD\"&gt;\"\u5e38\u89c4\u7ba1\u9053\"\u8bbe\u7f6e\u4e0b\u8fdb\u884c\u914d\u7f6e \u3002\u9ed8\u8ba4\u503c\u4e3a60\u5206\u949f\u3002</p> <p><code>General pipelines</code></p> <p></p> <p>runner\u8d85\u65f6\u65f6\u95f4</p> <p>\u6b64\u7c7b\u8d85\u65f6\uff08\u5982\u679c\u5c0f\u4e8e\u9879\u76ee\u5b9a\u4e49\u7684\u8d85\u65f6 \uff09\u5c06\u5177\u6709\u4f18\u5148\u6743\u3002\u6b64\u529f\u80fd\u53ef\u7528\u4e8e\u901a\u8fc7\u8bbe\u7f6e\u5927\u8d85\u65f6\uff08\u4f8b\u5982\u4e00\u4e2a\u661f\u671f\uff09\u6765\u9632\u6b62Shared Runner\u88ab\u9879\u76ee\u5360\u7528\u3002\u672a\u914d\u7f6e\u65f6\uff0cRunner\u5c06\u4e0d\u4f1a\u8986\u76d6\u9879\u76ee\u8d85\u65f6\u3002</p> <p></p>"},{"location":"chap3/1gitlab_pip1/#parallel","title":"parallel","text":"<p>\u914d\u7f6e\u8981\u5e76\u884c\u8fd0\u884c\u7684\u4f5c\u4e1a\u5b9e\u4f8b\u6570,\u6b64\u503c\u5fc5\u987b\u5927\u4e8e\u6216\u7b49\u4e8e2\u5e76\u4e14\u5c0f\u4e8e\u6216\u7b49\u4e8e50\u3002</p> <p>\u8fd9\u5c06\u521b\u5efaN\u4e2a\u5e76\u884c\u8fd0\u884c\u7684\u540c\u4e00\u4f5c\u4e1a\u5b9e\u4f8b. \u5b83\u4eec\u4ece<code>job_name</code> 1/N\u5230<code>job_name</code> N/N\u4f9d\u6b21\u547d\u540d</p> <pre><code>codescan:\n  stage: codescan\n  tags:\n    - build\n   only:\n    - main\n  script:\n    - echo \"codescan\"\n    - sleep 5;\n  parallel: 5\n  when: on_success\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#final-script","title":"Final script","text":"<pre><code>before_script:\n  - echo \"before-script!!\"\n\nvariables:\n  DOMAIN: example.com\n\nstages:\n  - build\n  - test\n  - codescan\n  - deploy\n\nbuild:\n  before_script:\n    - echo \"before-script in job\"\n  stage: build\n  only:\n    - main\n  script:\n    - echo \"mvn clean \"\n    - echo \"mvn install\"\n    - echo \"$DOMAIN\"\n  after_script:\n    - echo \"after script in job\"\n\ncodescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - echo \"codescan\"\n    - sleep 5;\n  parallel: 5\n  when: on_success\n\ntimedrollout:\n  stage: deploy\n  script:\n    - echo 'Rolling out 30%....'\n  when: delayed\n  start_in: '30'\n\n# unittest:\n#   stage: test\n#   script:\n#     - echo \"run test\"  \n#   when: delayed\n#   start_in: '5'\nunittest:\n  stage: test\n  tags:\n    - build\n  script:\n    - ech \"run test\"  \n  when: delayed\n  start_in: '5'\n  allow_failure: true\n  retry:\n    max: 2\n    when: \n      - script_failure\n\ndeploy:\n  stage: deploy\n  script:\n    - echo \"hello deploy\"\n    - sleep 2;\n  when: manual\n\nafter_script:\n  - echo \"after-script\"\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#3-pipeline-3","title":"3 Pipeline \u8bed\u6cd5 3","text":"<p><code>only/except/rules/workflow</code></p>"},{"location":"chap3/1gitlab_pip1/#1-only-exceptonly-ecxept-","title":"1 <code>only &amp; except</code>only &amp; ecxept -\uff08\u9010\u6b65\u9000\u51fa\uff09","text":"<p>only\u548cexcept\u662f\u4e24\u4e2a\u53c2\u6570\u7528\u5206\u652f\u7b56\u7565\u6765\u9650\u5236jobs\u6784\u5efa\uff1a</p> <ul> <li>only\u5b9a\u4e49\u54ea\u4e9b\u5206\u652f\u548c\u6807\u7b7e\u7684git\u9879\u76ee\u5c06\u4f1a\u88abjob\u6267\u884c\u3002</li> <li>except\u5b9a\u4e49\u54ea\u4e9b\u5206\u652f\u548c\u6807\u7b7e\u7684git\u9879\u76ee\u5c06\u4e0d\u4f1a\u88abjob\u6267\u884c\u3002</li> </ul> <pre><code>job:\n  only:\n    - main\n</code></pre> <pre><code>job:\n  # use regexp\n  only:\n    - /issue-.*$/\n  # use special keyword\n  except:\n    - branches\n</code></pre> <p></p> <pre><code>deploy:\n  stage: deploy\n  script:\n    - echo \"hello deploy\"\n    - sleep 2;\n  when: manual\n  only:\n    - main\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#2-rules","title":"2 rules","text":"<ul> <li>rules\u5141\u8bb8\u6309\u987a\u5e8f\u8bc4\u4f30\u5355\u4e2a\u89c4\u5219\u5bf9\u8c61\u7684\u5217\u8868\uff0c\u76f4\u5230\u4e00\u4e2a\u5339\u914d\u5e76\u4e3a\u4f5c\u4e1a\u52a8\u6001\u63d0\u4f9b\u5c5e\u6027. </li> <li>\u8bf7\u6ce8\u610f\uff0c rules\u4e0d\u80fdonly/except\u4e0eonly/except\u7ec4\u5408\u4f7f\u7528\u3002</li> </ul> <p>\u53ef\u7528\u7684\u89c4\u5219\u6761\u6b3e\u5305\u62ec\uff1a</p> <ul> <li>if \uff08\u7c7b\u4f3c\u4e8e<code>only:variables</code> \uff09</li> <li>changes \uff08 <code>only:changes</code> \u76f8\u540c\uff09</li> <li>exists</li> </ul>"},{"location":"chap3/1gitlab_pip1/#3-rulesif","title":"3 rules:if","text":"<ul> <li> <p>rules-if-\u6761\u4ef6\u5339\u914d</p> <ul> <li>\u5982\u679cDOMAIN\u7684\u503c\u5339\u914d\uff0c\u5219\u9700\u8981\u624b\u52a8\u8fd0\u884c\u3002</li> <li>\u4e0d\u5339\u914d<code>on_success</code>\u3002</li> <li>\u6761\u4ef6\u5224\u65ad\u4ece\u4e0a\u5230\u4e0b\uff0c\u5339\u914d\u5373\u505c\u6b62\u3002</li> <li>\u591a\u6761\u4ef6\u5339\u914d\u53ef\u4ee5\u4f7f\u7528<code>&amp;&amp; ||</code></li> </ul> </li> </ul> <pre><code>variables:\n  DOMAIN: example.com\n\ncodescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - echo \"codescan\"\n    - sleep 5;\n  #parallel: 5\n  rules:\n    - if: '$DOMAIN == \"example.com\"'\n      when: manual\n    - when: on_success\n</code></pre> <pre><code>deploy:\n  stage: deploy\n  script:\n    - echo \"hello deploy\"\n    - sleep 2;\n  rules:\n    - if: '$DOMAIN == \"example.com\"'\n      when: manual\n    - if: '$DOMAIN == \"example.com\"'\n      when: delayed\n      start_in: '5'\n    - when: on_success \n</code></pre> <p></p> <ul> <li> <p>rules-changes-\u6587\u4ef6\u53d8\u5316</p> <ul> <li>\u63a5\u53d7\u6587\u4ef6\u8def\u5f84\u6570\u7ec4\u3002</li> <li>\u5982\u679c\u63d0\u4ea4\u4e2d<code>*file</code>\u6587\u4ef6\u53d1\u751f\u7684\u53d8\u5316\u5219\u4e3atrue</li> </ul> </li> </ul> <pre><code>codescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - echo \"codescan\"\n    #parallel: 5\n  rules:\n    - changes:\n      - Dockerfile\n      when: manual\n    - if: '$DOMAIN == \"example.com\"'\n      when: on_success\n    - when: on_success\n</code></pre> <p><code>Dockerfile</code></p> <pre><code>FROM alpine:3.8\n</code></pre> <pre><code>FROM alpine:3.8\n\nENV KUBE_LATEST_VERSION=\"v1.13.4\"\n</code></pre> <p></p> <ul> <li><code>rules:exists</code><ul> <li>\u63a5\u53d7\u6587\u4ef6\u8def\u5f84\u6570\u7ec4\u3002\u5f53\u4ed3\u5e93\u4e2d\u5b58\u5728\u6307\u5b9a\u7684\u6587\u4ef6\u65f6\u64cd\u4f5c\u3002</li> </ul> </li> </ul> <pre><code>codescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - echo \"codescan\"\n    - sleep 5;\n  #parallel: 5\n  rules:\n    - exists:\n      - Dockerfile\n      when: manual \n    - changes:\n      - Dockerfile\n      when: on_success\n    - if: '$DOMAIN == \"example.com\"'\n      when: on_success\n    - when: on_success\n</code></pre> <pre><code>rules:\n    - exists:\n      - Dockerfile\n      when: manual \n    - changes:\n      - Dockerfile\n      when: on_success\n</code></pre> <ul> <li>rules-<code>allow_failure</code><ul> <li>\u4f7f\u7528<code>allow_failure: true</code> </li> <li>rules:\u5728\u4e0d\u505c\u6b62\u7ba1\u9053\u672c\u8eab\u7684\u60c5\u51b5\u4e0b\u5141\u8bb8\u4f5c\u4e1a\u5931\u8d25\u6216\u624b\u52a8\u4f5c\u4e1a\u7b49\u5f85\u64cd\u4f5c\u3002</li> </ul> </li> </ul> <pre><code>job:\n  script: \"echo Hello, Rules!\"\n  rules:\n    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == \"main\"'\n      when: manual\n      allow_failure: true\n</code></pre> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u89c4\u5219\u5339\u914d\uff0c\u5219\u4f5c\u4e1a\u5c06\u5177\u6709\u4ee5\u4e0b<code>when: manual</code>\u548c<code>allow_failure: true</code>\u3002</p>"},{"location":"chap3/1gitlab_pip1/#workflowrules","title":"workflow:rules\u521b\u5efa\u7ba1\u9053","text":"<ul> <li>\u9876\u7ea7workf1ow\u5173\u952e\u5b57\u9002\u7528\u4e8e\u6574\u4e2a\u7ba1\u9053\uff0c\u5e76\u5c06\u786e\u5b9a\u662f\u5426\u521b\u5efa\u7ba1\u9053\u3002</li> <li>when\uff1a\u53ef\u4ee5\u8bbe\u7f6e\u4e3aalways\u6216never\uff0c \u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5219\u9ed8\u8ba4\u503calways\u3002</li> </ul> <pre><code>variables:\n  DOMAIN: example.com\n\nworkflow:\n  rules:\n    - if: '$DOMAIN == \"example.com\"'\n    - when: always\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#_2","title":"\u7efc\u5408\u5b9e\u4f8b\u4ee3\u7801","text":"<pre><code>before_script:\n  - echo \"before-script!!\"\n\nvariables:\n  DOMAIN: example.com\n\nworkflow:\n  rules:\n    - if: '$DOMAIN == \"example.com\"'\n      when: always\n    - when: never\n\nstages:\n  - build\n  - test\n  - codescan\n  - deploy\n\nbuild:\n  before_script:\n    - echo \"before-script in job\"\n  stage: build\n  script:\n    - echo \"mvn clean \"\n    - echo \"mvn install\"\n    - echo \"$DOMAIN\"\n  after_script:\n    - echo \"after script in buildjob\"\n  rules:\n    - exists:\n      - Dockerfile\n      when: on_success \n      allow_failure: true\n\n    - changes:\n      - Dockerfile\n      when: manual\n    - when: on_failure\n\nunittest:\n  stage: test\n  script:\n    - echo \"run test\"\n  when: delayed\n  start_in: '5'\n  allow_failure: true\n  retry:\n    max: 1\n    when:\n      - script_failure\n  timeout: 1 hours 10 minutes\n\n\n\ndeploy:\n  stage: deploy\n  script:\n    - echo \"hello deploy\"\n    - sleep 2;\n  rules:\n    - if: '$DOMAIN == \"example.com\"'\n      when: manual\n    - if: '$DOMAIN == \"aexample.com\"'\n      when: delayed\n      start_in: '5'\n    - when: on_failure\n\ncodescan:\n  stage: codescan\n  script:\n    - echo \"codescan\"\n    - sleep 5;\n  when: on_success\n  parallel: 5\n\nafter_script:\n  - echo \"after-script\"\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#4-cache","title":"4 cache \u5173\u952e\u5b57","text":""},{"location":"chap3/1gitlab_pip1/#cache","title":"cache \u7f13\u5b58","text":"<p>\u7528\u6765\u6307\u5b9a\u9700\u8981\u5728job\u4e4b\u95f4\u7f13\u5b58\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u3002\u53ea\u80fd\u4f7f\u7528\u8be5\u9879\u76ee\u5de5\u4f5c\u7a7a\u95f4\u5185\u7684\u8def\u5f84\u3002\u4e0d\u8981\u4f7f\u7528\u7f13\u5b58\u5728\u9636\u6bb5\u4e4b\u95f4\u4f20\u9012\u5de5\u4ef6\uff0c\u56e0\u4e3a\u7f13\u5b58\u4e3b\u8981\u662f\u5b58\u50a8\u7f16\u8bd1\u9879\u76ee\u6240\u9700\u7684\u8fd0\u884c\u65f6\u4f9d\u8d56\u9879\u3002</p> <p>\u5982\u679c\u5728job\u8303\u56f4\u4e4b\u5916\u5b9a\u4e49\u4e86cache \uff0c\u5219\u610f\u5473\u7740\u5b83\u662f\u5168\u5c40\u8bbe\u7f6e\uff0c\u6240\u6709job\u90fd\u5c06\u4f7f\u7528\u8be5\u5b9a\u4e49\u3002\u5982\u679c\u672a\u5168\u5c40\u5b9a\u4e49\u6216\u672a\u6309job\u5b9a\u4e49\u5219\u7981\u7528\u8be5\u529f\u80fd\u3002</p> <ul> <li>\u5b58\u50a8\u7f16\u8bd1\u9879\u76ee\u6240\u9700\u7684\u8fd0\u884c\u65f6\u4f9d\u8d56\u9879\uff0c\u6307\u5b9a\u9879\u76ee\u5de5\u4f5c\u7a7a\u95f4\u4e2d\u9700\u8981\u5728job\u4e4b\u95f4\u7f13\u5b58\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u3002</li> <li>\u5168\u5c40cache\u5b9a\u4e49\u5728job\u4e4b\u5916\uff0c\u9488\u5bf9\u6240\u6709job\u751f\u6548\u3002job\u4e2dcache\u4f18\u5148\u4e8e\u5168\u5c40\u3002</li> </ul> <p></p>"},{"location":"chap3/1gitlab_pip1/#cachepaths","title":"cache:paths","text":"<p>\u4f7f\u7528paths\u6307\u4ee4\u9009\u62e9\u8981\u7f13\u5b58\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u9879\u76ee\u76ee\u5f55\uff0c\u4e0d\u80fd\u76f4\u63a5\u94fe\u63a5\u5230\u9879\u76ee\u76ee\u5f55\u4e4b\u5916\u3002</p> <p><code>$CI_PROJECT_DIR</code>  \u9879\u76ee\u76ee\u5f55\u3002\u5728<code>job build</code>\u4e2d\u5b9a\u4e49\u7f13\u5b58\uff0c\u5c06\u4f1a\u7f13\u5b58target\u76ee\u5f55\u4e0b\u7684\u6240\u6709<code>.jar</code>\u6587\u4ef6\u3002</p> <pre><code>build:\n  script: test\n  cache:\n    paths:\n      - target/*.jar\n</code></pre> <p>\u5f53\u5728\u5168\u5c40\u5b9a\u4e49\u4e86<code>cache:paths</code>\u4f1a\u88ab<code>job</code>\u4e2d\u8986\u76d6\u3002\u4ee5\u4e0b\u5b9e\u4f8b\u5c06\u7f13\u5b58<code>binaries</code>\u76ee\u5f55\u3002</p> <pre><code>cache:\n  paths:\n    - my/files\n\nbuild:\n  script: echo \"hello\"\n  cache:\n    key: build\n    paths:\n      - target/\n</code></pre> <p>\u7531\u4e8e\u7f13\u5b58\u662f\u5728job\u4e4b\u95f4\u5171\u4eab\u7684\uff0c\u5982\u679c\u4e0d\u540c\u7684job\u4f7f\u7528\u4e0d\u540c\u7684\u8def\u5f84\u5c31\u51fa\u73b0\u4e86\u7f13\u5b58\u8986\u76d6\u7684\u95ee\u9898\u3002</p> <p>\u5982\u4f55\u8ba9\u4e0d\u540c\u7684job\u7f13\u5b58\u4e0d\u540c\u7684cache\u5462\uff1f\u8bbe\u7f6e\u4e0d\u540c\u7684<code>cache:key</code>\u3002</p>"},{"location":"chap3/1gitlab_pip1/#cachekey","title":"cache:key  \u7f13\u5b58\u6807\u8bb0","text":"<p>\u4e3a\u7f13\u5b58\u505a\u4e2a\u6807\u8bb0\uff0c\u53ef\u4ee5\u914d\u7f6e<code>job</code>\u3001\u5206\u652f\u4e3a<code>key</code>\u6765\u5b9e\u73b0\u5206\u652f\u3001\u4f5c\u4e1a\u7279\u5b9a\u7684\u7f13\u5b58\u3002</p> <p>\u4e3a\u4e0d\u540c job \u5b9a\u4e49\u4e86\u4e0d\u540c\u7684 <code>cache:key</code> \u65f6\uff0c \u4f1a\u4e3a\u6bcf\u4e2a job \u5206\u914d\u4e00\u4e2a\u72ec\u7acb\u7684 cache\u3002</p> <p><code>cache:key</code> \u53d8\u91cf\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u9884\u5b9a\u4e49\u53d8\u91cf\uff0c\u9ed8\u8ba4default \uff0c\u4eceGitLab 9.0\u5f00\u59cb\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6240\u6709\u5185\u5bb9\u90fd\u5728\u7ba1\u9053\u548c\u4f5c\u4e1a\u4e4b\u95f4\u5171\u4eab\u3002</p> <p>\u6309\u7167\u5206\u652f\u8bbe\u7f6e\u7f13\u5b58</p> <pre><code>cache:\n  key: ${CI_COMMIT_REF_SLUG}\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#cachekeyfles","title":"<code>cache:key:fles</code> \u2014\u2014 \u6587\u4ef6\u53d8\u5316\u81ea\u52a8\u521b\u5efa\u7f13\u5b58","text":"<p>files\uff1a\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u81ea\u52a8\u91cd\u65b0\u751f\u6210\u7f13\u5b58(files\u6700\u591a\u6307\u5b9a\u4e24\u4e2a\u6587\u4ef6)\uff0c\u63d0\u4ea4\u7684\u65f6\u5019\u68c0\u67e5\u6307\u5b9a\u7684\u6587\u4ef6\u3002</p> <p>\u6839\u636e\u6307\u5b9a\u7684\u6587\u4ef6\u751f\u6210\u5bc6\u94a5\u8ba1\u7b97SHA\u6821\u9a8c\u548c\uff0c\u5982\u679c\u6587\u4ef6\u672a\u6539\u53d8\u503c\u4e3adefault\u3002</p> <pre><code>cache:\n  key:\n    files:\n      - Gemfile.lock\n      - package.json\n  paths:\n    - vendor/ruby\n    - node_modules\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#cache-keyprefix-sha","title":"<code>cache: key:prefix</code>-\u7ec4\u5408\u751f\u6210SHA\u6821\u9a8c\u548c","text":"<p>prefix: \u5141\u8bb8\u7ed9\u5b9aprefix\u7684\u503c\u4e0e\u6307\u5b9a\u6587\u4ef6\u751f\u6210\u7684\u79d8\u94a5\u7ec4\u5408\u3002</p> <p>\u5728\u8fd9\u91cc\u5b9a\u4e49\u4e86\u5168\u5c40\u7684<code>cache</code>\uff0c\u5982\u679c\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u5219\u503c\u4e3a <code>rspec-xxx111111111222222</code>   \uff0c\u672a\u53d1\u751f\u53d8\u5316\u4e3a<code>rspec-default</code>\u3002</p> <pre><code>cache:\n  key:\n    files:\n      - Gemfile.lock\n    prefix: ${CI_JOB_NAME}\n  paths:\n    - vendor/ruby\n\nrspec:\n  script:\n    - bundle exec rspec\n</code></pre> <p>\u4f8b\u5982\uff0c\u6dfb\u52a0<code>$CI_JOB_NAME prefix</code>\u5c06\u4f7f\u5bc6\u94a5\u770b\u8d77\u6765\u50cf\uff1a</p> <p><code>rspec-feef9576d21ee9b6a32e30c5c79d0a0ceb68d1e5</code> </p> <p>\u5e76\u4e14\u4f5c\u4e1a\u7f13\u5b58\u5728\u4e0d\u540c\u5206\u652f\u4e4b\u95f4\u5171\u4eab\uff0c\u5982\u679c\u5206\u652f\u66f4\u6539\u4e86<code>Gemfile.lock</code> \uff0c\u5219\u8be5\u5206\u652f\u5c06\u4e3a<code>cache:key:files</code>\u5177\u6709\u65b0\u7684SHA\u6821\u9a8c\u548c</p> <p></p> <p>\u5c06\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u7f13\u5b58\u5bc6\u94a5\uff0c\u5e76\u4e3a\u8be5\u5bc6\u94a5\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7f13\u5b58. \u5982\u679c<code>Gemfile.lock</code>\u672a\u53d1\u751f\u53d8\u5316 \uff0c\u5219\u5c06\u524d\u7f00\u6dfb\u52a0<code>default</code> \uff0c\u56e0\u6b64\u793a\u4f8b\u4e2d\u7684\u952e\u4e3a<code>rspec-default</code> \u3002</p>"},{"location":"chap3/1gitlab_pip1/#cachepolicy","title":"<code>cache:policy</code>  \u7b56\u7565","text":"<p>\u9ed8\u8ba4\uff1a\u5728\u6267\u884c\u5f00\u59cb\u65f6\u4e0b\u8f7d\u6587\u4ef6\uff0c\u5e76\u5728\u7ed3\u675f\u65f6\u91cd\u65b0\u4e0a\u4f20\u6587\u4ef6\u3002\u79f0\u4e3a<code>pull-push</code>\u7f13\u5b58\u7b56\u7565.</p> <ul> <li><code>policy: pull</code> \u8df3\u8fc7\u4e0b\u8f7d\u6b65\u9aa4</li> <li><code>policy: push</code>  \u8df3\u8fc7\u4e0a\u4f20\u6b65\u9aa4</li> </ul> <pre><code>\nstages:\n  - setup\n  - test\n\nprepare:\n  stage: setup\n  cache:\n    key: gems\n    paths:\n      - vendor/bundle\n  script:\n    - bundle install --deployment\n\nrspec:\n  stage: test\n  cache:\n    key: gems\n    paths:\n      - vendor/bundle\n    policy: pull\n  script:\n    - bundle exec rspec ...\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#_3","title":"\u7efc\u5408\u5b9e\u4f8b(\u4e00) \u5168\u5c40\u7f13\u5b58","text":"<pre><code>before_script:\n  - echo \"before-script!!\"\n\nvariables:\n  DOMAIN: example.com\n\ncache: \n  paths:\n   - target/\n\nstages:\n  - build\n  - test\n  - deploy\n\nbuild:\n  before_script:\n    - echo \"before-script in job\"\n  stage: build\n  tags:\n    - build\n  only:\n    - main\n  script:\n    - ls\n    - id\n    - mvn clean package -DskipTests\n    - ls target\n    - echo \"$DOMAIN\"\n    - false &amp;&amp; true ; exit_code=$?\n    - if [ $exit_code -ne 0 ]; then echo \"Previous command failed\"; fi;\n    - sleep 2;\n  after_script:\n    - echo \"after script in job\"\n\n\nunittest:\n  stage: test\n  tags:\n    - build\n  only:\n    - main\n  script:\n    - echo \"run test\"\n    - echo 'test' &gt;&gt; target/a.txt\n    - ls target\n  retry:\n    max: 2\n    when:\n      - script_failure\n\ndeploy:\n  stage: deploy\n  tags:\n    - build\n  only:\n    - main\n  script:\n    - echo \"run deploy\"\n    - ls target\n  retry:\n    max: 2\n    when:\n      - script_failure\n\n\nafter_script:\n  - echo \"after-script\"\n</code></pre> <p>Pipeline\u65e5\u5fd7\u5206\u6790</p> <p>build\u4f5c\u4e1a\u8fd0\u884c\u65f6\u4f1a\u5bf9\u9879\u76ee\u4ee3\u7801\u6253\u5305\uff0c\u7136\u540e\u751f\u6210target\u76ee\u5f55\u3002\u4f5c\u4e1a\u7ed3\u675f\u521b\u5efa\u7f13\u5b58\u3002</p> <p></p> <p>\u5f00\u59cb\u7b2c\u4e8c\u4e2a\u4f5c\u4e1atest\uff0c\u6b64\u65f6\u4f1a\u628a\u5f53\u524d\u76ee\u5f55\u4e2d\u7684target\u76ee\u5f55\u5220\u9664\u6389\uff08\u56e0\u4e3a\u505a\u4e86git \u5bf9\u6bd4\uff09\u3002</p> <p></p> <p>\u83b7\u53d6\u5230\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u751f\u6210\u7684\u7f13\u5b58target\u76ee\u5f55\u3002</p> <p></p> <p>\u5f00\u59cb\u7b2c\u4e09\u4e2a\u4f5c\u4e1a\uff0c\u540c\u6837\u5148\u5220\u9664\u4e86target\u76ee\u5f55\uff0c\u7136\u540e\u83b7\u53d6\u4e86\u7b2c\u4e8c\u4e2a\u4f5c\u4e1a\u7684\u7f13\u5b58\u3002\u6700\u540e\u751f\u6210\u4e86\u5f53\u524d\u7684\u7f13\u5b58\u3002</p> <p></p> <p>Runner\u7f13\u5b58</p> <p>\u5728\u505a\u672c\u6b21\u5b9e\u9a8c\u7684\u65f6\u5019\u6211\u73b0\u5728\u672c\u5730runner\u6e05\u9664\u4e86\u9879\u76ee\u7684\u5de5\u4f5c\u76ee\u5f55\u548c\u5386\u53f2\u7f13\u5b58\u3002</p> <pre><code>[~]# cd /home/gitlab-runner/builds/1Cxihk7-/0/demo/demo-maven-service/\n[rdemo-maven-service]# ls\nJenkinsfile  README.md  aaaaa  jenkins  pom.xml  src  target\n[demo-maven-service]# cd ..\n[demo]# ls\ndemo-maven-service  demo-maven-service.tmp\n[demo]# rm -fr demo-maven-service\n[demo]# rm -fr demo-maven-service.tmp/\n[demo]# cd\n[~]# cd /home/gitlab-runner/cache/\n[cache]# ls\ndemo\n[cache]# rm -rf *\n</code></pre> <p>\u9879\u76ee\u4ee3\u7801\u9ed8\u8ba4\u4e0d\u4f1a\u5220\u9664\uff0c\u53ef\u4ee5\u53d1\u73b0\u662f\u7b2c\u4e8c\u6b21\u4f5c\u4e1a\u7684\u7f13\u5b58\u3002\uff08\u56e0\u4e3a\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\u7b2c\u4e09\u6b21\u4f5c\u4e1a\u5e76\u6ca1\u6709\u4fee\u6539\u7f13\u5b58\u5185\u5bb9\uff09</p> <pre><code>\n[cache]# cd /home/gitlab-runner/builds/1Cxihk7-/0/demo/demo-maven-service/\n[emo-maven-service]# ls\nJenkinsfile  README.md  aaaaa  jenkins  pom.xml  src  target\n[demo-maven-service]# cd ..\n[demo]# ls\ndemo-maven-service  demo-maven-service.tmp\n[demo]# rm -fr *\n\n[remo]# ls\ndemo-maven-service  demo-maven-service.tmp\n[demo]# cd demo-maven-service\n[demo-maven-service]# ls\nJenkinsfile  README.md  aaaaa  jenkins  pom.xml  src  target\n\n[demo-maven-service]# cat target/a.txt\ntest\n</code></pre> <p>\u8fdb\u5165runner\u7f13\u5b58\u76ee\u5f55\u4e2d\u67e5\u770b\u7f13\u5b58\u3002</p> <pre><code>[~]# cd /home/gitlab-runner/cache/demo/demo-maven-service/default/\n[default]# ls\ncache.zip\n[default]# unzip cache.zip\nArchive:  cache.zip\n   creating: target/\n  inflating: target/a.txt\n   creating: target/classes/\n   creating: target/classes/com/\n   creating: target/classes/com/mycompany/\n   creating: target/classes/com/mycompany/app/\n  inflating: target/classes/com/mycompany/app/App.class\n   creating: target/maven-archiver/\n  inflating: target/maven-archiver/pom.properties\n   creating: target/maven-status/\n   creating: target/maven-status/maven-compiler-plugin/\n   creating: target/maven-status/maven-compiler-plugin/compile/\n   creating: target/maven-status/maven-compiler-plugin/compile/default-compile/\n  inflating: target/maven-status/maven-compiler-plugin/compile/default-compile/createdFiles.lst\n  inflating: target/maven-status/maven-compiler-plugin/compile/default-compile/inputFiles.lst\n   creating: target/maven-status/maven-compiler-plugin/testCompile/\n   creating: target/maven-status/maven-compiler-plugin/testCompile/default-testCompile/\n  inflating: target/maven-status/maven-compiler-plugin/testCompile/default-testCompile/createdFiles.lst\n  inflating: target/maven-status/maven-compiler-plugin/testCompile/default-testCompile/inputFiles.lst\n  inflating: target/my-app-1.1-SNAPSHOT.jar\n   creating: target/test-classes/\n   creating: target/test-classes/com/\n   creating: target/test-classes/com/mycompany/\n   creating: target/test-classes/com/mycompany/app/\n  inflating: target/test-classes/com/mycompany/app/AppTest.class\n[default]# ls\ncache.zip  target\n[default]# cd target/\n[target]# ls\na.txt  classes  maven-archiver  maven-status  my-app-1.1-SNAPSHOT.jar  test-classes\n[target]# cat a.txt\ntest\n</code></pre> <p>\u6b64\u65f6\u6b64\u523b\u518d\u6b21\u8fd0\u884c\u6d41\u6c34\u7ebf\u4f5c\u4e1a\uff0c\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u7528\u7684\u662f\u4e0a\u4e2a\u4f5c\u4e1a\u6700\u540e\u751f\u6210\u7684\u7f13\u5b58\u3002</p> <p>\u5728\u505a\u672c\u6b21\u5b9e\u9a8c\u7684\u65f6\u5019\u6211\u73b0\u5728\u672c\u5730runner\u6e05\u9664\u4e86\u9879\u76ee\u7684\u5de5\u4f5c\u76ee\u5f55\u548c\u5386\u53f2\u7f13\u5b58\u3002</p> <p></p> <pre><code>ll\ntotal 12\n-rw------- 1 gitlab-runner gitlab-runner 9172 Apr 29 10:27 cache.zip\ndrwxrwxr-x 6 root          root           127 Apr 29 10:05 target\n</code></pre> <p>\u7ed3\u8bba\uff1a\u5168\u5c40\u7f13\u5b58\u751f\u6548\u4e8e\u672a\u5728\u4f5c\u4e1a\u4e2d\u5b9a\u4e49\u7f13\u5b58\u7684\u6240\u6709\u4f5c\u4e1a\uff0c\u8fd9\u79cd\u60c5\u51b5\u5982\u679c\u6bcf\u4e2a\u4f5c\u4e1a\u90fd\u5bf9\u7f13\u5b58\u76ee\u5f55\u505a\u4e86\u66f4\u6539\uff0c\u4f1a\u51fa\u73b0\u7f13\u5b58\u88ab\u8986\u76d6\u7684\u573a\u666f\u3002</p>"},{"location":"chap3/1gitlab_pip1/#5-artifactsdependencies","title":"5 artifacts/dependencies","text":""},{"location":"chap3/1gitlab_pip1/#artifacts","title":"artifacts","text":"<p>\u7528\u4e8e\u6307\u5b9a\u5728\u4f5c\u4e1a\u6210\u529f\u6216\u8005\u5931\u8d25\u65f6\u5e94\u9644\u52a0\u5230\u4f5c\u4e1a\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u7684\u5217\u8868\u3002\u4f5c\u4e1a\u5b8c\u6210\u540e\uff0c\u5de5\u4ef6\u5c06\u88ab\u53d1\u9001\u5230GitLab\uff0c\u5e76\u53ef\u5728GitLab UI\u4e2d\u4e0b\u8f7d\u3002</p> <ul> <li><code>artifacts:paths</code></li> </ul> <p>\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u9879\u76ee\u76ee\u5f55\u7684\uff0c\u4e0d\u80fd\u76f4\u63a5\u94fe\u63a5\u5230\u9879\u76ee\u76ee\u5f55\u4e4b\u5916\u3002</p> <p>\u5c06\u5236\u54c1\u8bbe\u7f6e\u4e3atarget\u76ee\u5f55</p> <pre><code>artifacts:\n  paths:\n    - target/\n</code></pre> <p></p> <ul> <li><code>artifacts:expose_as</code> -MR\u5c55\u793a\u5236\u54c1</li> </ul> <p>\u5173\u952e\u5b57<code>expose_as</code>\u53ef\u7528\u4e8e\u5728\u5408\u5e76\u8bf7\u6c42 UI\u4e2d\u516c\u5f00\u4f5c\u4e1a\u5de5\u4ef6\u3002</p> <p>\u4f8b\u5982\uff0c\u8981\u5339\u914d\u5355\u4e2a\u6587\u4ef6\uff1a</p> <pre><code>test:\n  script: \n    - echo 1\n  artifacts:\n    expose_as: 'artifact 1'\n    paths: \n      - path/to/file.txt\n</code></pre> <p>\u4f7f\u7528\u6b64\u914d\u7f6e\uff0cGitLab\u5c06\u5728\u6307\u5411\u7684\u76f8\u5173\u5408\u5e76\u8bf7\u6c42\u4e2d\u6dfb\u52a0\u94fe\u63a5<code>file1.txt</code>\u3002</p> <p></p> <p>\u5236\u54c1\u6d4f\u89c8</p> <p></p> <p>\u8bf7\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>\u6bcf\u4e2a\u5408\u5e76\u8bf7\u6c42\u6700\u591a\u53ef\u4ee5\u516c\u5f0010\u4e2a\u4f5c\u4e1a\u5de5\u4ef6\u3002</li> <li>\u5982\u679c\u6307\u5b9a\u4e86\u76ee\u5f55\uff0c\u90a3\u4e48\u5982\u679c\u76ee\u5f55\u4e2d\u6709\u591a\u4e2a\u6587\u4ef6\uff0c\u5219\u8be5\u94fe\u63a5\u5c06\u6307\u5411\u6307\u5411\u4f5c\u4e1a\u5de5\u4ef6\u6d4f\u89c8\u5668\u3002</li> <li> <p>\u5982\u679c\u5f00\u542fGitlabPages\u53ef\u4ee5\u5bf9.html .htm .txt .json .log\u6269\u5c55\u540d\u5355\u4e2a\u6587\u4ef6\u5de5\u4ef6\u6e32\u67d3\u5de5\u4ef6\u3002</p> </li> <li> <p>artifacts-\u5236\u54c1\u521b\u5efa</p> </li> </ul> <pre><code>default-job:\n  script:\n    - mvn test -U\n  except:\n    - tags\n\nrelease-job:\n  script:\n    - mvn package -U\n  artifacts:\n    paths:\n      - target/*.war\n    only:\n      - tags\n</code></pre> <p><code>artifacts:name</code></p> <p>\u901a\u8fc7name\u6307\u4ee4\u5b9a\u4e49\u6240\u521b\u5efa\u7684\u5de5\u4ef6\u5b58\u6863\u7684\u540d\u79f0\u3002\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u6863\u6848\u4f7f\u7528\u552f\u4e00\u7684\u540d\u79f0\u3002</p> <p><code>artifacts:name</code>\u53d8\u91cf\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u9884\u5b9a\u4e49\u53d8\u91cf\u3002\u9ed8\u8ba4\u540d\u79f0\u662f<code>artifacts</code>\uff0c\u4e0b\u8f7d<code>artifacts</code>\u6539\u4e3a<code>artifacts.zip</code>\u3002</p> <p>\u4f7f\u7528\u5f53\u524d\u4f5c\u4e1a\u7684\u540d\u79f0\u521b\u5efa\u6863\u6848</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_JOB_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u4f7f\u7528\u5185\u90e8\u5206\u652f\u6216\u6807\u8bb0\u7684\u540d\u79f0\uff08\u4ec5\u5305\u62ecbinaries\u76ee\u5f55\uff09\u521b\u5efa\u5b58\u6863\uff0c</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_COMMIT_REF_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u4f7f\u7528\u5f53\u524d\u4f5c\u4e1a\u7684\u540d\u79f0\u548c\u5f53\u524d\u5206\u652f\u6216\u6807\u8bb0\uff08\u4ec5\u5305\u62ec\u4e8c\u8fdb\u5236\u6587\u4ef6\u76ee\u5f55\uff09\u521b\u5efa\u5b58\u6863</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_JOB_STAGE-$CI_COMMIT_REF_NAME\"\n    paths:\n      - binaries/\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#artifactswhen","title":"<code>artifacts:when</code>","text":"<p>\u7528\u4e8e\u5728\u4f5c\u4e1a\u5931\u8d25\u65f6\u6216\u6210\u529f\u800c\u4e0a\u4f20\u5de5\u4ef6\u3002</p> <ul> <li><code>on_success</code>\u4ec5\u5728\u4f5c\u4e1a\u6210\u529f\u65f6\u4e0a\u8f7d\u5de5\u4ef6\u9ed8\u8ba4\u503c\u3002</li> <li><code>on_failure</code>\u4ec5\u5728\u4f5c\u4e1a\u5931\u8d25\u65f6\u4e0a\u8f7d\u5de5\u4ef6\u3002</li> <li>always \u4e0a\u8f7d\u5de5\u4ef6\uff0c\u65e0\u8bba\u4f5c\u4e1a\u72b6\u6001\u5982\u4f55\u3002</li> </ul> <pre><code>job:\n  artifacts:\n    when: on_failure\n</code></pre> <pre><code>job:\n  artifacts:\n    when: on_successs\n</code></pre> <pre><code>job:\n  artifacts:\n    when: always\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#artifacts-expire_in","title":"<code>artifacts: expire_in</code> \u5236\u54c1\u4fdd\u7559\u65f6\u95f4","text":"<p>\u5236\u54c1\u7684\u6709\u6548\u671f\uff0c\u4ece\u4e0a\u4f20\u548c\u5b58\u50a8\u5230Gitlab\u7684\u65f6\u95f4\u5f00\u59cb\u7b97\u8d77\u3002\u5982\u679c\u672b\u5b9a\u4e49\u8fc7\u671f\u65f6\u95f4\uff0c\u5219\u9ed8\u8ba4\u4e3a30\u5929\u3002</p> <p><code>expire_in</code> \u7684\u503c\u4ee5\u79d2\u4e3a\u5355\u4f4d\u7684\u7ecf\u8fc7\u65f6\u95f4\uff0c\u9664\u975e\u63d0\u4f9b\u4e86\u5355\u4f4d\u3002</p> <pre><code>\n\u201842\u2019\n\u20183 mins 4 sec\u2019\n\u20182 hrs 20 min\u2019\n\u20182h20min\u2019\n\u20186 mos 1 day\u2019\n\u201847 yrs 6 mos and 4d\u2019\n\u20183 weeks and 2 days\u2019\n</code></pre> <p>\u4e00\u5468\u540e\u8fc7\u671f</p> <pre><code>job:\n  artifacts:\n    expire_in: 1 week\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#artifactsreports","title":"<code>artifacts:reports</code>","text":"<p>\u7528\u4e8e\u4ece\u4f5c\u4e1a\u4e2d\u6536\u96c6\u6d4b\u8bd5\u62a5\u544a\uff0c\u4ee3\u7801\u8d28\u91cf\u62a5\u544a\u548c\u5b89\u5168\u62a5\u544a. \u5728GitLab\u7684UI\u4e2d\u663e\u793a\u8fd9\u4e9b\u62a5\u544a\u3002\u6ce8\u610f\uff1a\u65e0\u8bba\u4f5c\u4e1a\u7ed3\u679c\uff08\u6210\u529f\u6216\u5931\u8d25\uff09\uff0c\u90fd\u5c06\u6536\u96c6\u6d4b\u8bd5\u62a5\u544a\u3002</p> <p><code>artifacts:reports:junit</code> \u2014\u2014 \u5355\u5143\u6d4b\u8bd5\u62a5\u544a</p> <p>\u6536\u96c6junit\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\uff0c\u6536\u96c6\u7684JUnit\u62a5\u544a\u5c06\u4f5c\u4e3a\u5de5\u4ef6\u4e0a\u4f20\u5230GitLab\uff0c\u5e76\u5c06\u81ea\u52a8\u663e\u793a\u5728\u5408\u5e76\u8bf7\u6c42\u4e2d</p> <pre><code>build:\n  stage: build\n  tags:\n    - build\n  only:\n    - main\n  script:\n    - mvn test\n    - mvn cobertura:cobertura\n    - ls target\n  artifacts:\n    name: \"$CI_JOB_NAME-$CI_COMMIT_REF_NAME\"\n    when: on_success\n    expose_as: 'artifact 1'\n    paths:\n      - target/*.jar\n    reports:\n      junit: target/surefire-reports/TEST-*.xml\n</code></pre> <p>\u6ce8\u610f\uff1a\u5982\u679c\u60a8\u4f7f\u7528\u7684<code>JUnit</code>\u5de5\u5177\u5bfc\u51fa\u5230\u591a\u4e2aXML\u6587\u4ef6\uff0c\u5219\u53ef\u4ee5\u5728\u4e00\u4e2a\u4f5c\u4e1a\u4e2d\u6307\u5b9a\u591a\u4e2a\u6d4b\u8bd5\u62a5\u544a\u8def\u5f84\uff0c\u5b83\u4eec\u5c06\u88ab\u81ea\u52a8\u4e32\u8054\u5230\u4e00\u4e2a\u6587\u4ef6\u4e2d. \u4f7f\u7528\u6587\u4ef6\u540d\u6a21\u5f0f\uff08 <code>junit: rspec-*.xml</code> \uff09\uff0c\u6587\u4ef6\u540d\u6570\u7ec4\uff08 <code>junit: [rspec-1.xml, rspec-2.xml, rspec-3.xml]</code>\uff09\u6216\u5176\u7ec4\u5408\uff08<code>junit: [rspec.xml, test-results/TEST-*.xml]</code>\uff09</p> <p></p> <p></p> <pre><code>jobs:build:artifacts paths can't contain '*' when used with 'expose_as'\n</code></pre> <p>\u5982\u679c\u65e0\u6cd5\u663e\u793a\u6b64\u9875\u9762\uff0c\u9700\u8981\u66f4\u6539\u7cfb\u7edf\u8bbe\u7f6e\u3002\u6b64\u9009\u9879\u53ef\u80fd\u4f1a\u52a0\u5927\u8d44\u6e90\u5360\u7528\uff0c\u9ed8\u8ba4\u7981\u7528\u4e86\u9700\u8981\u542f\u7528\u3002</p> <pre><code>\n\u767b\u5f55gitlab\nsu -  git\n$ gitlab-rails console\n--------------------------------------------------------------------------------\n GitLab:       12.9.0 (9a382ff2c82) FOSS\n GitLab Shell: 12.0.0\n PostgreSQL:   10.12\n--------------------------------------------------------------------------------\nFeature.enable(:junit_pipeline_view)Loading production environment (Rails 6.0.2)\nirb(main):001:0&gt;\nirb(main):002:0&gt;\nirb(main):003:0&gt; Feature.enable(:junit_pipeline_view)\n=&gt; true\nirb(main):004:0&gt;\n</code></pre> <p>\u53c2\u8003\u94fe\u63a5\uff1ahttps://docs.gitlab.com/ee/ci/junit_test_reports.html</p> <p><code>artifacts:reports: cobertura</code>-\u8986\u76d6\u7387</p> <pre><code>build:\n  stage: build\n  tags:\n    - build\n  only:\n    - main\n  script:\n    - mvn test\n    - mvn cobertura:cobertura\n    - ls target\n  artifacts:\n    name: \"$CI_JOB_NAME-$CI_COMMIT_REF_NAME\"\n    when: on_success\n    expose_as: 'artifact 1'\n    paths:\n      - target/*.jar\n    reports:\n      junit: target/surefire-reports/TEST-*.xml\n      cobertura: target/site/cobertura/coverage.xml\n</code></pre> <p>maven\u96c6\u6210cobertura\u63d2\u4ef6</p> <pre><code>&lt;plugins&gt;\n    &lt;!-- cobertura plugin start --&gt;\n    &lt;plugin&gt;\n        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;\n        &lt;artifactId&gt;cobertura-maven-plugin&lt;/artifactId&gt;\n        &lt;version&gt;2.7&lt;/version&gt;\n        &lt;configuration&gt;\n            &lt;formats&gt;\n                &lt;format&gt;html&lt;/format&gt;\n                &lt;format&gt;xml&lt;/format&gt;\n            &lt;/formats&gt;\n        &lt;/configuration&gt;\n    &lt;/plugin&gt;\n    &lt;!-- cobertura plugin end --&gt;\n&lt;/plugins&gt;\n</code></pre> <p>\u6267\u884c mvn cobertura:cobertura \u8fd0\u884c\u6d4b\u8bd5\u5e76\u4ea7\u751fcobertura\u7684\u8986\u76d6\u7387</p>"},{"location":"chap3/1gitlab_pip1/#dependencies","title":"dependencies","text":"<p>\u5b9a\u4e49\u8981\u83b7\u53d6\u5de5\u4ef6\u7684\u4f5c\u4e1a\u5217\u8868\uff0c\u53ea\u80fd\u4ece\u5f53\u524d\u9636\u6bb5\u4e4b\u524d\u6267\u884c\u7684\u9636\u6bb5\u5b9a\u4e49\u4f5c\u4e1a\u3002\u5b9a\u4e49\u4e00\u4e2a\u7a7a\u6570\u7ec4\u5c06\u8df3\u8fc7\u4e0b\u8f7d\u8be5\u4f5c\u4e1a\u7684\u4efb\u4f55\u5de5\u4ef6\u4e0d\u4f1a\u8003\u8651\u5148\u524d\u4f5c\u4e1a\u7684\u72b6\u6001\uff0c\u56e0\u6b64\uff0c\u5982\u679c\u5b83\u5931\u8d25\u6216\u662f\u672a\u8fd0\u884c\u7684\u624b\u52a8\u4f5c\u4e1a\uff0c\u5219\u4e0d\u4f1a\u53d1\u751f\u9519\u8bef\u3002</p> <p>\u5982\u679c\u8bbe\u7f6e\u4e3a\u4f9d\u8d56\u9879\u7684\u4f5c\u4e1a\u7684\u5de5\u4ef6\u5df2\u8fc7\u671f\u6216\u5220\u9664\uff0c\u90a3\u4e48\u4f9d\u8d56\u9879\u4f5c\u4e1a\u5c06\u5931\u8d25\u3002</p> <pre><code>unittest:\n  dependencies:\n    - build\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#_4","title":"\u7efc\u5408\u5b9e\u4f8b","text":"<pre><code>before_script:\n  - echo \"before-script!!\"\n\nvariables:\n  DOMAIN: example.com\n\n\ncache: \n  paths:\n   - target/\n\nstages:\n  - build\n  - test\n  - deploy\n\nbuild:\n  before_script:\n    - echo \"before-script in job\"\n  stage: build\n  tags:\n    - build\n  only:\n    - master\n  script:\n    - ls\n    - id\n    - mvn test\n    - mvn cobertura:cobertura\n    - ls target\n    - echo \"$DOMAIN\"\n    - false &amp;&amp; true ; exit_code=$?\n    - if [ $exit_code -ne 0 ]; then echo \"Previous command failed\"; fi;\n    - sleep 2;\n  after_script:\n    - echo \"after script in job\"\n  artifacts:\n    name: \"$CI_JOB_NAME-$CI_COMMIT_REF_NAME\"\n    when: on_success\n    #expose_as: 'artifact 1'\n    paths:\n      - target/*.jar\n      #- target/surefire-reports/TEST*.xml\n    reports:\n      junit: target/surefire-reports/TEST-*.xml\n      cobertura: target/site/cobertura/coverage.xml\n  coverage: '/Code coverage: \\d+\\.\\d+/'\n\n\nunittest:\n  dependencies:\n    - build\n  stage: test\n  tags:\n    - build\n  only:\n    - master\n  script:\n    - echo \"run test\"\n    - echo 'test' &gt;&gt; target/a.txt\n    - ls target\n  retry:\n    max: 2\n    when:\n      - script_failure\n\ndeploy:\n  stage: deploy\n  tags:\n    - build\n  only:\n    - master\n  script:\n    - echo \"run deploy\"\n    - ls target\n  retry:\n    max: 2\n    when:\n      - script_failure\n\n\n\nafter_script:\n  - echo \"after-script\"\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#6-needsartifacts","title":"6 <code>needs/artifacts</code>","text":""},{"location":"chap3/1gitlab_pip1/#needs","title":"needs \u5e76\u884c\u9636\u6bb5","text":"<p>\u53ef\u65e0\u5e8f\u6267\u884c\u4f5c\u4e1a\uff0c\u65e0\u9700\u6309\u7167\u9636\u6bb5\u987a\u5e8f\u8fd0\u884c\u67d0\u4e9b\u4f5c\u4e1a\uff0c\u53ef\u4ee5\u8ba9\u591a\u4e2a\u9636\u6bb5\u540c\u65f6\u8fd0\u884c\u3002</p> <pre><code>stages:\n  - build\n  - test\n  - deploy\n\nmodule-a-build:\n  stage: build\n  script: \n    - echo \"hello3a\"\n    - sleep 10\n\nmodule-b-build:\n  stage: build\n  script: \n    - echo \"hello3b\"\n    - sleep 10\n\nmodule-a-test:\n  stage: test\n  script: \n    - echo \"hello3a\"\n    - sleep 10\n  needs: [\"module-a-build\"]\n\nmodule-b-test:\n  stage: test\n  script: \n    - echo \"hello3b\"\n    - sleep 10\n  needs: [\"module-b-build\"]\n</code></pre> <p></p> <p>\u5982\u679c<code>needs:</code>\u8bbe\u7f6e\u4e3a\u6307\u5411\u56e0<code>only/except</code>\u89c4\u5219\u800c\u672a\u5b9e\u4f8b\u5316\u7684\u4f5c\u4e1a\uff0c\u6216\u8005\u4e0d\u5b58\u5728\uff0c\u5219\u521b\u5efa\u7ba1\u9053\u65f6\u4f1a\u51fa\u73b0YAML\u9519\u8bef\u3002</p> <p>\u6682\u65f6\u9650\u5236\u4e86\u4f5c\u4e1a\u5728<code>needs:</code>\u53ef\u80fd\u9700\u8981\u7684\u6700\u5927\u4f5c\u4e1a\u6570\u5206\u914d,<code>ci_dag_limit_needs</code>\u529f\u80fd\u6807\u5fd7\u5df2\u542f\u7528\uff08\u9ed8\u8ba4\uff09\u5206\u914d10\u4e2a\uff0c\u5982\u679c\u529f\u80fd\u88ab\u7981\u7528\u4e3a50\u3002</p> <pre><code>Feature::disable(:ci_dag_limit_needs)   # 50\nFeature::enable(:ci_dag_limit_needs)  #10\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#_5","title":"\u5236\u54c1\u4e0b\u8f7d","text":"<p>\u5728\u4f7f\u7528needs\uff0c\u53ef\u901a\u8fc7<code>artifacts: true</code>\u6216<code>artifacts: false</code>\u6765\u63a7\u5236\u5de5\u4ef6\u4e0b\u8f7d\u3002\u9ed8\u8ba4\u4e0d\u6307\u5b9a\u4e3atrue\u3002</p> <pre><code>module-a-test:\n  stage: test\n  script: \n    - echo \"hello3a\"\n    - sleep 10\n  needs: \n    - job: \"module-a-build\"\n      artifacts: true\n</code></pre> <p>\u76f8\u540c\u9879\u76ee\u4e2d\u7684\u7ba1\u9053\u5236\u54c1\u4e0b\u8f7d,\u901a\u8fc7\u5c06project\u5173\u952e\u5b57\u8bbe\u7f6e\u4e3a\u5f53\u524d\u9879\u76ee\u7684\u540d\u79f0\uff0c\u5e76\u6307\u5b9a\u5f15\u7528\uff0c\u53ef\u4ee5\u4f7f\u7528needs\u4ece\u5f53\u524d\u9879\u76ee\u7684\u4e0d\u540c\u7ba1\u9053\u4e2d\u4e0b\u8f7d\u5de5\u4ef6\u3002</p> <p>\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u4e2d\uff0c<code>build_job</code>\u5c06\u4f7f\u7528<code>other-refref</code>\u4e0b\u8f7d\u6700\u65b0\u6210\u529f\u7684<code>build-1</code>\u4f5c\u4e1a\u7684\u5de5\u4ef6\uff1a</p> <pre><code>build_job:\n  stage: build\n  script:\n    - ls -lhR\n  needs:\n    - project: group/same-project-name\n      job: build-1\n      ref: other-ref\n      artifacts: true\n</code></pre> <p>\u4e0d\u652f\u6301parallel: \u8fd0\u884c\u7684\u4f5c\u4e1a\u4e2d\u4e0b\u8f7d\u5de5\u4f5c</p>"},{"location":"chap3/1gitlab_pip1/#87-includelocal","title":"87 <code>include/local</code>","text":"<p>\u5b98\u65b9\u6a21\u677f\u5e93\uff1ahttps://gitlab.com/gitlab-org/gitlab/-/tree/master/lib/gitlab/ci/templates</p> <p>\u53ef\u4ee5\u5141\u8bb8\u5f15\u5165\u5916\u90e8YAML\u6587\u4ef6\uff0c\u6587\u4ef6\u5177\u6709\u6269\u5c55\u540d<code>.yml</code>\u6216<code>.yaml</code> \u3002</p> <p>\u4f7f\u7528\u5408\u5e76\u529f\u80fd\u53ef\u4ee5\u81ea\u5b9a\u4e49\u548c\u8986\u76d6\u5305\u542b\u672c\u5730\u5b9a\u4e49\u7684<code>CI / CD</code>\u914d\u7f6e\u3002</p> <p>\u76f8\u540c\u7684job\u4f1a\u5408\u5e76\uff0c\u53c2\u6570\u503c\u4ee5\u6e90\u6587\u4ef6\u4e3a\u51c6\u3002</p> <pre><code>include:\n  local: 'ci/localci.yml'\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#include-local-","title":"include: local-\u5f15\u5165\u672c\u5730\u914d\u7f6e","text":"<p>\u5f15\u5165\u540c\u4e00\u5b58\u50a8\u5e93\u4e2d\u7684\u6587\u4ef6\uff0c\u4f7f\u7528\u76f8\u5bf9\u4e8e\u6839\u76ee\u5f55\u7684\u5b8c\u6574\u8def\u5f84\u8fdb\u884c\u5f15\u7528\uff0c\u4e0e\u914d\u7f6e\u6587\u4ef6\u5728\u540c\u4e00\u5206\u652f\u4e0a\u4f7f\u7528\u3002</p> <p><code>ci/localci.yml</code>: \u5b9a\u4e49\u4e00\u4e2a\u4f5c\u4e1a\u7528\u4e8e\u53d1\u5e03\u3002</p> <pre><code>stages:\n  - deploy\n\ndeployjob:\n  stage: deploy\n  script:\n    - echo 'deploy'\n</code></pre> <p><code>.gitlab-ci.yml</code> \u5f15\u5165\u672c\u5730\u7684CI\u6587\u4ef6<code>'ci/localci.yml'</code>\u3002</p> <pre><code>include:\n  local: 'ci/localci.yml'\n\n\nstages:\n  - build\n  - test\n  - deploy\n\n\nbuildjob:\n  stage: build\n  script: ls\n\n\ntestjob:\n  stage: test\n  script: ls\n</code></pre> <p></p> <p><code>.gitlab-ci.yml</code>\u76f4\u63a5\u52a0\u5165<code>deployjob</code></p> <pre><code>...\ndeployjob:\n  stage: deploy\n  script:\n    - echo 'deploy in gitlab-ci'\n</code></pre> <p>Job deployjob triggered 2 minutes ago by</p> <pre><code>...\nSkipping Git submodules setup\nExecuting \"step_script\" stage of the job script\n00:00\n$ echo 'deploy in gitlab-ci'\ndeploy in gitlab-ci\nJob succeeded\n</code></pre> <p><code>echo 'deploy in gitlab-ci'</code>  \u5185\u90e8\u8f93\u51fa\u4f1a\u8986\u76d6\u5916\u90e8\u5f15\u5165</p>"},{"location":"chap3/1gitlab_pip1/#file","title":"file","text":"<p>\u5305\u542b\u6765\u81ea\u53e6\u4e00\u4e2a\u9879\u76ee\u7684\u6587\u4ef6</p> <p>\u5f15\u5165 <code>demo/demo-java-service</code> \u9879\u76ee main \u5206\u652f <code>.gitlab-ci.yml</code> \u914d\u7f6e</p> <pre><code>include:\n  - project: demo/demo-java-service\n    ref: main\n    file: '.gitlab-ci.yml'\n</code></pre> <p>\u65b0\u5efa\u4e00\u4e2a\u9879\u76ee <code>demo-java-service/.gitlab-ci.yml</code></p> <pre><code>stages:\n  - build\n\nchild-a-build:\n    stage: build\n    script:\n        - echo \"include as external file\"\n        - sleep 10\n</code></pre> <p></p> <pre><code>...\n$ echo \"include as external file\"\ninclude as external file\n$ sleep 10\nJob succeeded\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#include-template-","title":"<code>include: template</code>-\u5f15\u5165\u5b98\u65b9\u914d\u7f6e","text":"<p>\u53ea\u80fd\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u6a21\u677f https://gitlab.com/gitlab-org/gitlab/tree/master/lib/gitlab/ci/templates</p> <pre><code>include:\n  - template: Auto-DevOps.gitlab-ci.yml\n</code></pre> <p>\u7528\u4e8e\u901a\u8fc7<code>HTTP/HTTPS</code>\u5305\u542b\u6765\u81ea\u5176\u4ed6\u4f4d\u7f6e\u7684\u6587\u4ef6\uff0c\u5e76\u4f7f\u7528\u5b8c\u6574URL\u8fdb\u884c\u5f15\u7528. \u8fdc\u7a0b\u6587\u4ef6\u5fc5\u987b\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u7684GET\u8bf7\u6c42\u516c\u5f00\u8bbf\u95ee\uff0c\u56e0\u4e3a\u4e0d\u652f\u6301\u8fdc\u7a0bURL\u4e2d\u7684\u8eab\u4efd\u9a8c\u8bc1\u67b6\u6784\u3002</p> <pre><code>include:\n  - remote: 'https://gitlab.com/awesome-project/raw/master/.gitlab-ci-template.yml'\n</code></pre> <p><code>demo-mvn-project/.gitlab-ci.yml</code></p> <pre><code>include:\n  remote: 'http://127.0.0.1:32220/gitlab-instance-8f6af96c/demo-java-service/-/raw/main/.gitlab-ci.yml'\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#extends-","title":"extends - \u7ee7\u627f\u4f5c\u4e1a\u914d\u7f6e","text":"<p>\u7ee7\u627f\u6a21\u677f\u4f5c\u4e1a</p> <pre><code>stages:\n  - test\nvariables:\n  RSPEC: 'test'\n\n.tests:\n  script: echo \"mvn test\"\n  stage: test\n  only:\n    refs:\n      - branches\n\ntestjob:\n  extends: .tests\n  script: echo \"mvn clean test\"\n  only:\n    variables:\n      - $RSPEC\n</code></pre> <p>\u5408\u5e76\u540e</p> <pre><code>testjob:\n  stage: test\n  script: mvn clean test\n  only:\n    variables:\n      - $RSPEC\n    refs:\n      - branches\n</code></pre> <p></p> <pre><code>$ echo \"mvn clean test\"\nmvn clean test\nJob succeeded\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#extendsinclude","title":"extends&amp;include","text":"<p><code>ci/localci.yml</code></p> <pre><code>#stages:\n#  - deploy\n\ndeployjob:\n  stage: deploy\n  script:\n    - echo 'deploy'\n  only:\n    - dev\n\n.template:\n  stage: build\n  script: \n    - echo \"build\"\n  only:\n    - master\n</code></pre> <pre><code>include:\n  local: 'ci/localci.yml'\n\nstages:\n  - test\n  - build \n  - deploy\n\nvariables:\n  RSPEC: 'test'\n\n.tests:\n  script: echo \"mvn test\"\n  stage: test\n  only:\n    refs:\n      - branches\n\ntestjob:\n  extends: .tests\n  script: echo \"mvn clean test\"\n  only:\n    variables:\n      - $RSPEC\n\n\nnewbuildjob:\n  script:\n    - echo \"123\"\n  extends: .template\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#trigger","title":"trigger \u7ba1\u9053\u89e6\u53d1","text":"<p>\u5f53Gitlab\u4ecetrigger\u5b9a\u4e49\u521b\u5efa\u7684\u4f5c\u4e1a\u542f\u52a8\u65f6\uff0c\u5c06\u521b\u5efa\u4e00\u4e2a\u4e0b\u6e38\u7ba1\u9053\u3002\u5141\u8bb8\u521b\u5efa\u591a\u9879\u76ee\u7ba1\u9053\u548c\u5b50\u7ba1\u9053\u3002\u5c06<code>trigger</code>\u4e0e<code>when:manual</code>\u4e00\u8d77\u4f7f\u7528\u4f1a\u5bfc\u81f4\u9519\u8bef</p> <ul> <li>\u591a\u9879\u76ee\u7ba1\u9053\uff1a\u8de8\u591a\u4e2a\u9879\u76ee\u8bbe\u7f6e\u6d41\u6c34\u7ebf\uff0c\u4ee5\u4fbf\u4e00\u4e2a\u9879\u76ee\u4e2d\u7684\u7ba1\u9053\u53ef\u4ee5\u89e6\u53d1\u53e6\u4e00\u4e2a\u9879\u76ee\u4e2d\u7684\u7ba1\u9053\u3002[\u5fae\u670d\u52a1\u67b6\u6784]</li> <li>\u7236\u5b50\u7ba1\u9053\uff1a\u5728\u540c\u4e00\u9879\u76ee\u4e2d\u7ba1\u9053\u53ef\u4ee5\u89e6\u53d1\u4e00\u7ec4\u540c\u65f6\u8fd0\u884c\u7684\u5b50\u7ba1\u9053\uff0c\u5b50\u7ba1\u9053\u4ecd\u7136\u6309\u7167\u9636\u6bb5\u987a\u5e8f\u6267\u884c\u5176\u6bcf\u4e2a\u4f5c\u4e1a\uff0c\u4f46\u662f\u53ef\u4ee5\u81ea\u7531\u5730\u7ee7\u7eed\u6267\u884c\u5404\u4e2a\u9636\u6bb5\uff0c\u800c\u4e0d\u5fc5\u7b49\u5f85\u7236\u7ba1\u9053\u4e2d\u65e0\u5173\u7684\u4f5c\u4e1a\u5b8c\u6210\u3002</li> </ul>"},{"location":"chap3/1gitlab_pip1/#_6","title":"\u591a\u9879\u76ee\u7ba1\u9053","text":"<p>\u5f53\u524d\u9762\u9636\u6bb5\u8fd0\u884c\u5b8c\u6210\u540e\uff0c\u89e6\u53d1<code>demo/demo-java-service</code>\u9879\u76ee<code>master</code>\u6d41\u6c34\u7ebf\u3002</p> <p>\u521b\u5efa\u4e0a\u6e38\u7ba1\u9053\u7684\u7528\u6237\u9700\u8981\u5177\u6709\u5bf9\u4e0b\u6e38\u9879\u76ee\u7684\u8bbf\u95ee\u6743\u9650\u3002\u5982\u679c\u53d1\u73b0\u4e0b\u6e38\u9879\u76ee\u7528\u6237\u6ca1\u6709\u8bbf\u95ee\u6743\u9650\u4ee5\u5728\u5176\u4e2d\u521b\u5efa\u7ba1\u9053\uff0c\u5219<code>staging</code>\u4f5c\u4e1a\u5c06\u88ab\u6807\u8bb0\u4e3a\u5931\u8d25\u3002</p> <pre><code>stages:\n  - deploy\n\nstaging:\n  variables:\n      ENVIRONMENT: staging\n  stage: deploy\n  trigger:\n      project: gitlab-instance-8f6af96c/demo-java-service\n      branch: main\n      # strategy: depend\n</code></pre> <ul> <li><code>project</code>\u5173\u952e\u5b57\uff0c\u7528\u4e8e\u6307\u5b9a\u4e0b\u6e38\u9879\u76ee\u7684\u5b8c\u6574\u8def\u5f84\u3002\u8be5branch\u5173\u952e\u5b57\u6307\u5b9a\u7531\u6307\u5b9a\u7684\u9879\u76ee\u5206\u652f\u7684\u540d\u79f0\u3002</li> <li>\u4f7f\u7528<code>variables</code>\u5173\u952e\u5b57\u5c06\u53d8\u91cf\u4f20\u9012\u5230\u4e0b\u6e38\u7ba1\u9053\u3002\u5168\u5c40\u53d8\u91cf\u4e5f\u4f1a\u4f20\u9012\u7ed9\u4e0b\u6e38\u9879\u76ee\u3002</li> <li>\u4e0a\u6e38\u7ba1\u9053\u4f18\u5148\u4e8e\u4e0b\u6e38\u7ba1\u9053\u3002\u5982\u679c\u5728\u4e0a\u6e38\u548c\u4e0b\u6e38\u9879\u76ee\u4e2d\u5b9a\u4e49\u4e86\u4e24\u4e2a\u5177\u6709\u76f8\u540c\u540d\u79f0\u7684\u53d8\u91cf\uff0c\u5219\u5728\u4e0a\u6e38\u9879\u76ee\u4e2d\u5b9a\u4e49\u7684\u53d8\u91cf\u5c06\u4f18\u5148\u3002</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e00\u65e6\u521b\u5efa\u4e0b\u6e38\u7ba1\u9053\uff0c<code>trigger</code>\u4f5c\u4e1a\u5c31\u4f1a\u4ee5<code>success</code>\u72b6\u6001\u5b8c\u6210\u3002</li> <li><code>strategy: depend</code>\u5c06\u81ea\u8eab\u72b6\u6001\u4ece\u89e6\u53d1\u7684\u7ba1\u9053\u5408\u5e76\u5230\u6e90\u4f5c\u4e1a\u3002</li> </ul> <p></p> <p></p> <pre><code>...\nExecuting \"step_script\" stage of the job script\n00:10\n$ echo \"include from demo-java-service\"\ninclude from demo-java-service\n$ sleep 10\nJob succeeded\n</code></pre> <p>\u6253\u5f00 depend  <code>strategy: depend</code>\u5c06\u81ea\u8eab\u72b6\u6001\u4ece\u89e6\u53d1\u7684\u7ba1\u9053\u5408\u5e76\u5230\u6e90\u4f5c\u4e1a</p> <pre><code>trigger:\n      project: gitlab-instance-8f6af96c/demo-java-service\n      branch: main\n      strategy: depend\n</code></pre> <p></p> <p>\u5728\u4e0b\u6e38\u9879\u76ee\u4e2d\u67e5\u770b\u7ba1\u9053\u4fe1\u606f</p> <p></p> <p></p> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u4e00\u65e6\u521b\u5efa\u4e86\u4e0b\u6e38\u7ba1\u9053\uff0c\u8be5staging\u5c06\u88ab\u6807\u8bb0\u4e3a\u6210\u529f\u3002</p>"},{"location":"chap3/1gitlab_pip1/#include","title":"\u7236\u5b50\u7ba1\u9053 \u7c7b\u4f3c\u4e8e Include","text":"<p>\u7236\u5b50\u6d41\u6c34\u7ebf\u5728\u4e00\u4e2a\u9879\u76ee\u4e2d</p> <p>\u521b\u5efa\u5b50\u7ba1\u9053ci/child01.yml</p> <pre><code>stages:\n  - build\n\nchild-a-build:\n  stage: build\n  script: \n    - echo \"hello3a\"\n    - sleep 10\n</code></pre> <p>\u5728\u7236\u7ba1\u9053\u89e6\u53d1\u5b50\u7ba1\u9053</p> <pre><code>staging2:\n  variables:\n    ENVIRONMENT: staging\n  stage: deploy\n  trigger: \n    include: ci/child01.yml  \n    strategy: depend\n</code></pre> <p></p> <p></p>"},{"location":"chap3/1gitlab_pip1/#7-imageservicesenvironmentinherit","title":"7 image/services/environment/inherit","text":"<pre><code>docker run -it -v  /Users/i515190/k8s_test/gitlab/runner-config:/etc/gitlab-runner --network=host --restart=always gitlab/gitlab-runner:v15.1.0 register \\\n  --non-interactive \\\n  --executor \"shell\" \\\n  --url \"http://127.0.0.1:32220/\" \\\n  --registration-token \"nzTshoYwsnCttkyzZBxE\" \\\n  --description \"devops-runner\" \\\n  --tag-list \"newdocker\" \\\n  --run-untagged=\"true\" \\\n  --locked=\"false\" \\\n  --access-level=\"not_protected\"\n</code></pre> <p>\u4e00\u4e2a\u6ce8\u518cdocker\u6267\u884c\u5668\u7c7b\u578b\u7684runner\u3002\u53ef\u4ee5\u53c2\u8003\u4ee5\u4e0b\u547d\u4ee4\u6307\u5b9a\uff1a</p> <pre><code>gitlab-runner register \\\n  --non-interactive \\\n  --executor \"docker\" \\\n  --docker-image alpine:latest \\\n  --url \"http://127.0.0.1:32220/\" \\\n  --registration-token \"JRzzw2j1Ji6aBjwvkxAv\" \\\n  --description \"docker-runner\" \\\n  --tag-list \"newdocker\" \\\n  --run-untagged=\"true\" \\\n  --locked=\"false\" \\\n  --access-level=\"not_protected\"\n</code></pre> <p>\u67e5\u770b\u6240\u751f\u6210\u7684\u914d\u7f6e\u6587\u4ef6\u3002</p> <p><code>vim /etc/gitlab-runner/config.toml</code></p> <pre><code>[[runners]]\n  name = \"docker-runner\"\n  url = \"http://192.168.1.200:30088/\"\n  token = \"xuaLZD7xUVviTsyeJAWh\"\n  executor = \"docker\"\n  [runners.custom_build_dir]\n  [runners.cache]\n    [runners.cache.s3]\n    [runners.cache.gcs]\n  [runners.docker]\n    pull_policy = \"if-not-present\"\n    tls_verify = false\n    image = \"alpine:latest\"\n    privileged = false\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = [\"/cache\"]\n    shm_size = 0\n</code></pre> <p><code>pull_policy = \"if-not-present\"</code></p>"},{"location":"chap3/1gitlab_pip1/#image","title":"image","text":"<p>\u9ed8\u8ba4\u5728\u6ce8\u518crunner\u7684\u65f6\u5019\u9700\u8981\u586b\u5199\u4e00\u4e2a\u57fa\u7840\u7684\u955c\u50cf\uff0c\u8bf7\u8bb0\u4f4f\u4e00\u70b9\u53ea\u8981\u4f7f\u7528\u6267\u884c\u5668\u4e3adocker\u7c7b\u578b\u7684runner\u6240\u6709\u7684\u64cd\u4f5c\u8fd0\u884c\u90fd\u4f1a\u5728\u5bb9\u5668\u4e2d\u8fd0\u884c\u3002</p> <p>\u5982\u679c\u5168\u5c40\u6307\u5b9a\u4e86images\u5219\u6240\u6709\u4f5c\u4e1a\u4f7f\u7528\u6b64image\u521b\u5efa\u5bb9\u5668\u5e76\u5728\u5176\u4e2d\u8fd0\u884c\u3002\u5168\u5c40\u672a\u6307\u5b9aimage\uff0c\u518d\u6b21\u67e5\u770bjob\u4e2d\u662f\u5426\u6709\u6307\u5b9a\uff0c\u5982\u679c\u6709\u6b64job\u6309\u7167\u6307\u5b9a\u955c\u50cf\u521b\u5efa\u5bb9\u5668\u5e76\u8fd0\u884c\uff0c\u6ca1\u6709\u5219\u4f7f\u7528\u6ce8\u518crunner\u65f6\u6307\u5b9a\u7684\u9ed8\u8ba4\u955c\u50cf\u3002</p> <pre><code>#image: maven:3.6.3-jdk-8\n\nbefore_script:\n  - ls\n\n\nbuild:\n  image: maven:3.6.3-jdk-8\n  stage: build\n  tags:\n    - newdocker\n  script:\n    - ls\n    - sleep 2\n    - echo \"mvn clean \"\n    - sleep 10\n\ndeploy:\n  stage: deploy\n  tags:\n    - newdocker\n  script:\n    - echo \"deploy\"\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#services","title":"services","text":"<p>\u5de5\u4f5c\u671f\u95f4\u8fd0\u884c\u7684\u53e6\u4e00\u4e2aDocker\u6620\u50cf\uff0c\u5e76link\u5230image\u5173\u952e\u5b57\u5b9a\u4e49\u7684Docker\u6620\u50cf\u3002\u8fd9\u6837\uff0c\u60a8\u5c31\u53ef\u4ee5\u5728\u6784\u5efa\u671f\u95f4\u8bbf\u95ee\u670d\u52a1\u6620\u50cf.</p> <p>\u670d\u52a1\u6620\u50cf\u53ef\u4ee5\u8fd0\u884c\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\uff0c\u4f46\u662f\u6700\u5e38\u89c1\u7684\u7528\u4f8b\u662f\u8fd0\u884c\u6570\u636e\u5e93\u5bb9\u5668\uff0c\u4f8b\u5982mysql \u3002\u4e0e\u6bcf\u6b21\u5b89\u88c5\u9879\u76ee\u65f6\u90fd\u5b89\u88c5mysql\u76f8\u6bd4\uff0c\u4f7f\u7528\u73b0\u6709\u6620\u50cf\u5e76\u5c06\u5176\u4f5c\u4e3a\u9644\u52a0\u5bb9\u5668\u8fd0\u884c\u66f4\u5bb9\u6613\uff0c\u66f4\u5feb\u6377\u3002</p> <pre><code>services:\n  - name: mysql:latest\n    alias: mysql-1\n</code></pre>"},{"location":"chap3/1gitlab_pip1/#environment","title":"environment","text":"<p>\u58f0\u660e\u6240\u90e8\u7f72\u7684\u73af\u5883\u540d\u79f0\u548c\u8bbf\u95ee\u5730\u5740\uff0c\u540e\u7eed\u53ef\u4ee5\u76f4\u63a5\u5728gitlab \u73af\u5883\u53d8\u91cf\u4e2d\u67e5\u770b\u3002\u975e\u5e38\u65b9\u4fbf\u3002</p> <pre><code>deploy to production:\n  stage: deploy\n  script: git push production HEAD:master\n  environment:\n    name: production\n    url: https://prod.example.com\n</code></pre> <pre><code>#       strategy: depend\nbefore_script:\n  - ls\n\n\nbuild:\n  image: maven:3.6.3-jdk-8\n  stage: build\n  tags:\n    - build\n  script:\n    - ls\n    - sleep 2\n    - echo \"mvn clean \"\n    - sleep 10\n\ndeploy:\n  stage: deploy\n  tags:\n    - deploy\n  script:\n    - echo \"deploy\"\n  environment:\n    name: production\n    url: https://www.baidu.com\n</code></pre> <p></p>"},{"location":"chap3/1gitlab_pip1/#inherit","title":"inherit","text":"<p>\u4f7f\u7528\u6216\u7981\u7528\u5168\u5c40\u5b9a\u4e49\u7684\u73af\u5883\u53d8\u91cf\uff08variables\uff09\u6216\u9ed8\u8ba4\u503c(default)\u3002</p> <p>\u4f7f\u7528true\u3001false\u51b3\u5b9a\u662f\u5426\u4f7f\u7528\uff0c\u9ed8\u8ba4\u4e3atrue</p> <pre><code>inherit:\n  default: false\n  variables: false\n</code></pre> <p>\u7ee7\u627f\u5176\u4e2d\u7684\u4e00\u90e8\u5206\u53d8\u91cf\u6216\u9ed8\u8ba4\u503c\u4f7f\u7528list</p> <pre><code>inherit:\n  default:\n    - parameter1\n    - parameter2\n  variables:\n    - VARIABLE1\n    - VARIABLE2\n</code></pre>"},{"location":"chap3/2gitlab_summary/","title":"2 Gitlab CI \u6d41\u6c34\u7ebf\u6784\u5efa\u4f18\u5316 + Runner\u6784\u5efa\u4f18\u5316\uff08\u6301\u4e45\u5316\uff09","text":""},{"location":"chap3/2gitlab_summary/#gitlabci","title":"GitlabCI\u8bed\u6cd5\u7b80\u4ecb","text":"<ul> <li>script     \u8fd0\u884c\u7684Shell\u547d\u4ee4\u6216\u811a\u672c\uff0c</li> <li>image     \u4f7f\u7528docker\u6620\u50cf\u3002</li> <li>services  \u4f7f\u7528docker\u670d\u52a1\u6620\u50cf\u3002</li> <li><code>before_script</code> \u5728\u4f5c\u4e1a\u8fd0\u884c\u524d\u8fd0\u884c\u811a\u672c\u3002</li> <li><code>after_script</code> \u5728\u4f5c\u4e1a\u8fd0\u884c\u540e\u8fd0\u884c\u811a\u672c\uff0c</li> <li>stages: \u5b9a\u4e49\u7ba1\u9053\u4e2d\u7684\u9636\u6bb5\uff0c\u8fd0\u884c\u987a\u5e8f\u3002</li> <li>stage: \u4e3ajob\u5b9a\u4e49\u4e00\u4e2a\u9636\u6bb5\uff0c\u53ef\u9009\uff0c\u672a\u6307\u5b9a\u9ed8\u8ba4\u4e3atest\u9636\u6bb5\u3002</li> <li>only:  \u9650\u5236\u521b\u5efa\u4f5c\u4e1a\u7684\u6761\u4ef6\u3002</li> <li>except:  \u9650\u5236\u672a\u521b\u5efa\u4f5c\u4e1a\u7684\u6761\u4ef6</li> <li>rules  \u6761\u4ef6\u5217\u8868\uff0c\u7528\u4e8e\u8bc4\u4f30\u548c\u786e\u5b9a\u4f5c\u4e1a\u7684\u9009\u5b9a\u5c5e\u6027\uff0c\u4ee5\u53ca\u662f\u5426\u521b\u5efa\u8be5\u4f5c\u4e1a\u3002\u4e0d\u80fdonly\u4e0e/except \u4e00\u8d77\u4f7f\u7528\u3002</li> <li>tags  \u7528\u4e8e\u9009\u62e9Runner\u7684\u6807\u7b7e\u5217\u8868\u3002</li> <li><code>allow_failure</code>: \u5141\u8bb8\u4f5c\u4e1a\u5931\u8d25\uff0c\u5931\u8d25\u7684job\u4e0d\u4f1a\u5f71\u54cd\u63d0\u4ea4\u72b6\u6001\uff0c</li> <li>when: \u4ec0\u4e48\u65f6\u5019\u5f00\u59cb\u8fd0\u884c\u5de5\u4f5c\u3002</li> <li>environment:   \u4f5c\u4e1a\u90e8\u7f72\u5230\u7684\u73af\u5883\u7684\u540d\u79f0\u3002</li> <li>cache: \u5728\u540e\u7eed\u8fd0\u884c\u4e4b\u95f4\u5e94\u7f13\u5b58\u7684\u6587\u4ef6\u5217\u8868\u3002</li> <li>artifacts: \u6210\u529f\u65f6\u9644\u52a0\u5230\u4f5c\u4e1a\u7684\u6587\u4ef6\u548c\u76ee\u5f55\u5217\u8868\uff0c</li> <li>dependencies: \u901a\u8fc7\u63d0\u4f9b\u8981\u4ece\u4e2d\u83b7\u53d6\u5de5\u4ef6\u7684\u4f5c\u4e1a\u5217\u8868\uff0c\u9650\u5236\u5c06\u54ea\u4e9b\u5de5\u4ef6\u4f20\u9012\u7ed9\u7279\u5b9a\u4f5c\u4e1a\u3002</li> <li>retry: \u53d1\u751f\u6545\u969c\u65f6\u53ef\u4ee5\u81ea\u52a8\u91cd\u8bd5\u4f5c\u4e1a\u7684\u65f6\u95f4\u548c\u6b21\u6570.</li> <li>timeout: \u5b9a\u4e49\u81ea\u5b9a\u4e49\u4f5c\u4e1a\u7ea7\u522b\u7684\u8d85\u65f6\uff0c\u8be5\u8d85\u65f6\u4f18\u5148\u4e8e\u9879\u76ee\u8303\u56f4\u7684\u8bbe\u7f6e\u3002</li> <li>parallel: \u591a\u4e2a\u4f5c\u4e1a\u5e76\u884c\u8fd0\u884c\u3002</li> <li>trigger: \u5b9a\u4e49\u4e0b\u6e38\u7ba1\u9053\u89e6\u53d1\u3002</li> <li>include: \u5141\u8bb8\u6b64\u4f5c\u4e1a\u5305\u62ec\u5916\u90e8YAML\u6587\u4ef6\uff0c</li> <li>extends: \u8be5\u4f5c\u4e1a\u5c06\u8981\u7ee7\u627f\u7684\u914d\u7f6e\u6761\u76ee\u3002</li> <li>pages:  \u4e0a\u8f7d\u4f5c\u4e1a\u7ed3\u679c\u4ee5\u7528\u4e8eGitLab\u9875\u9762\uff0c</li> <li>variables: \u5728\u4f5c\u4e1a\u7ea7\u522b\u4e0a\u5b9a\u4e49\u4f5c\u4e1a\u53d8\u91cf\u3002</li> </ul> <p>https://github.com/zeyangli/gitlabci-templates/tree/master/templates</p> <pre><code>include:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/deploy.yml'\n\nvariables:\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID\n  GIT_CHECKOUT: \"false\"\n  MVN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/m2\"\n  BUILD_SHELL: 'mvn clean package  -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  --settings=./settings.xml'  ##\u6784\u5efa\u547d\u4ee4\n  TEST_SHELL : 'mvn test -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  --settings=./settings.xml'                        ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  # \u4ee3\u7801\u626b\u63cf\n  SCANNER_HOME : \"\"\n  SCAN_DIR : \"src\"\n  ARTIFACT_PATH : 'target/*.jar'                            ##\u5236\u54c1\u76ee\u5f55\n\n  #\u4e0a\u4f20\u5236\u54c1\u5e93\n  ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"\n  ARTIFACTORY_NAME: \"cidevops\"\n  TARGET_FILE_PATH: \"$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  TARGET_ARTIFACT_NAME: \"$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID.jar\"\n\n  #\u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\n  CI_REGISTRY_USER: '610556220zy'\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'\n  IMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  DOCKER_FILE_PATH: \"./Dockerfile\"\n\n  #\u90e8\u7f72k8s\n  RUN_DEPLOY: \"yes\"\n  APP_NAME: \"$CI_PROJECT_NAME\"\n  CONTAINER_PORT: 8081\n  NODE_PORT: 30185\n  ENV_NAME: \"staging\"\n  ENV_URL: \"http://192.168.1.200:30185\"\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"\n\n\n\nimage: docker:latest\n\n\nstages:\n  - build\n  - test\n  - parallel01\n  - down_artifact\n  - deploy\n  - interface_test\n\nbefore_script:\n  - ls /home/gitlab-runner/ci-build-cache/builds/\n  - echo  $CI_BUILDS_DIR\n  - echo  $KUBE_URL $KUBE_TOKEN $KUBE_CA_PEM $KUBE_CA_PEM_FILE\n  - export\n\n\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  tags:\n    - k8s\n  image: maven:3.6.3-jdk-8\n  stage: build\n  extends: .build\n  rules:\n    - when: on_success\n  after_script:\n    - ls target/\n\ntest:\n  before_script:\n    - ls target/\n  tags:\n    - k8s\n  image: maven:3.6.3-jdk-8\n  stage: test\n  extends: .test\n  rules:\n    - when: on_success\n  after_script:\n    - ls target/\n\ncode_analysis:\n  tags:\n    - k8s\n  image: sonarsource/sonar-scanner-cli:latest\n  stage: parallel01\n  script:\n    - ls target/\n    - echo $CI_MERGE_REQUEST_IID $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME\n    - \"sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \\\n                  -Dsonar.projectName=${CI_PROJECT_NAME} \\\n                  -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \\\n                  -Dsonar.ws.timeout=30 \\\n                  -Dsonar.projectDescription=${CI_PROJECT_TITLE} \\\n                  -Dsonar.links.homepage=${CI_PROJECT_URL} \\\n                  -Dsonar.sources=${SCAN_DIR} \\\n                  -Dsonar.sourceEncoding=UTF-8 \\\n                  -Dsonar.java.binaries=target/classes \\\n                  -Dsonar.java.test.binaries=target/test-classes \\\n                  -Dsonar.java.surefire.report=target/surefire-reports \\\n                  -Dsonar.host.url=http://192.168.1.200:30090 \\\n                  -Dsonar.login=ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b \\\n                  -Dsonar.branch.name=${CI_COMMIT_REF_NAME}\" \n\nbuild_image:\n  before_script:\n    - ls target/\n  tags:\n    - k8s\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n\n\ndeploy_k8s:\n  image: lucj/kubectl:1.17.2\n  tags:\n    - k8s\n    - kubernetes-runner\n  stage: deploy\n  script:\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" deployment.yaml \n    - sed -i \"s#__appname__#${APP_NAME}#g\" deployment.yaml \n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" deployment.yaml \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" deployment.yaml \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" deployment.yaml \n    - sed -i \"s#__CI_ENVIRONMENT_SLUG__#${CI_ENVIRONMENT_SLUG}#g\" deployment.yaml \n    - sed -i \"s#__CI_PROJECT_PATH_SLUG__#${CI_PROJECT_PATH_SLUG}#g\" deployment.yaml\n    - cat deployment.yaml\n    - kubectl apply -f deployment.yaml  \n  environment:\n    name: $ENV_NAME\n    url: $ENV_URL\n\n\ninterfact_test:\n  inherit:\n    variables: false\n  stage: interface_test\n  extends: .interfacetest\n</code></pre>"},{"location":"chap3/2gitlab_summary/#_1","title":"\u6a21\u677f\u5e93\u89c4\u5212","text":"<ul> <li>\u521b\u5efa\u4e00\u4e2agit \u4ed3\u5e93\u7528\u4e8e\u5b58\u653e\u6a21\u677f</li> <li>\u521b\u5efa\u4e00\u4e2atemplate\u76ee\u5f55\u5b58\u653e\u6240\u6709pipeline\u7684\u6a21\u677f</li> <li>\u521b\u5efa\u4e00\u4e2ajobs\u76ee\u5f55\u5b58\u653ejob\u6a21\u677f\u3002</li> </ul> <p>\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u5c06\u4e00\u4e9bmaven\u3001ant\u3001gradle\u3001npm\u5de5\u5177\u901a\u8fc7\u4e00\u4e2ajob\u6a21\u677f\u548c\u4e0d\u540c\u7684\u6784\u5efa\u547d\u4ee4\u5b9e\u73b0\u3002</p> <p>templates\u7684\u597d\u5904\u662f\u6211\u4eec\u5728\u5176\u4e2d\u5b9a\u4e49\u4e86\u6a21\u677f\u6d41\u6c34\u7ebf\uff0c\u8fd9\u4e9b\u6d41\u6c34\u7ebf\u53ef\u4ee5\u76f4\u63a5\u8ba9\u76ee\u4f7f\u7528\u3002</p> <p>\u5f53\u9047\u5230\u4e2a\u6027\u5316\u9879\u76ee\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u5728\u5f53\u524d\u9879\u76ee\u521b\u5efa<code>.gitlab-ci.yml</code>\u6587\u4ef6\u6765\u5f15\u7528\u6a21\u677f\u6587\u4ef6\uff0c\u518d\u8fdb\u4e00\u6b65\u5b9e\u73b0\u4e2a\u6027\u5316\u9700\u8981\u3002</p> <p>\u6a21\u677f\u590d\u7528\uff0c\u51cf\u5c11\u91cd\u590d\u4ee3\u7801</p>"},{"location":"chap3/2gitlab_summary/#gitlabci-runner","title":"GitlabCI-Runner \u5b89\u88c5\u90e8\u7f72","text":"<ul> <li>\u5b89\u88c5Helm3</li> <li>\u90e8\u7f72Helm chart</li> <li>\u914d\u7f6eHelm Chart</li> <li>\u9a8c\u8bc1\u6548\u679c</li> </ul> <p>helm3</p> <pre><code>https://github.com/helm/helm/releases\ntar -zxvf helm-v3.0.0-linux-amd64.tar.gz\nmm linux-amd64/helm /usr/local/bin/helm\n</code></pre> <p>\u914d\u7f6echart \u5b58\u50a8\u5e93</p> <pre><code>\u6dfb\u52a0chart\u5b58\u50a8\u5e93\nhelm repo add gitlab https://charts.gitlab.io\n\n##\u9a8c\u8bc1\u6e90\nhelm repo list\n\n##\u67e5\u8be2\u53ef\u4ee5\u5b89\u88c5\u7684gitlab-runnerchart\nhelm search repo -l gitlab/gitlab-runner\n</code></pre> <p>\u66f4\u65b0\u914d\u7f6e\u4fe1\u606f</p> <pre><code>helm fetch gitlab/gitlab-runner --version=x.y.z\n</code></pre> <p>values.yml</p> <pre><code>## GitLab Runner Image\n##\n## By default it's using gitlab/gitlab-runner:alpine-v{VERSION}\n## where {VERSION} is taken from Chart.yaml from appVersion field\n##\n## ref: https://hub.docker.com/r/gitlab/gitlab-runner/tags/\n##\nimage: gitlab/gitlab-runner:alpine-v12.9.0\n\n## \u955c\u50cf\u4e0b\u8f7d\u7b56\u7565\nimagePullPolicy: IfNotPresent\n\n## Gitlab\u670d\u52a1\u5668\u5730\u5740\ngitlabUrl: http://192.168.1.200:30088/\n\n## runner\u6ce8\u518ctoken\nrunnerRegistrationToken: \"JRzzw2j1Ji6aBjwvkxAv\"\n\n## \u7ec8\u6b62\u4e4b\u524d\u6ce8\u9500\u6240\u6709\u8dd1\u6b65\u8005\nunregisterRunners: true\n\n\n## \u5f53\u505c\u6b62\u7ba1\u9053\u65f6\u7b49\u5f85\u5176\u4f5c\u4e1a\u7ec8\u6b62\u65f6\u95f4\nterminationGracePeriodSeconds: 3600\n\n## Set the certsSecretName in order to pass custom certficates for GitLab Runner to use\n## Provide resource name for a Kubernetes Secret Object in the same namespace,\n## this is used to populate the /home/gitlab-runner/.gitlab-runner/certs/ directory\n## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates\n##\n# certsSecretName:\n\n\n## \u914d\u7f6e\u6700\u5927\u5e76\u53d1\u4f5c\u4e1a\u6570\nconcurrent: 10\n\n## \u65b0\u4f5c\u4e1a\u68c0\u67e5\u95f4\u9694\ncheckInterval: 30\n\n## GitlabRunner\u65e5\u5fd7\u7ea7\u522b debug, info, warn, error, fatal, panic\nlogLevel: info\n\n## Configure GitLab Runner's logging format. Available values are: runner, text, json\n## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section\n##\n# logFormat:\n\n## For RBAC support:\nrbac:\n  create: true\n  ## Define specific rbac permissions.\n  resources: [\"pods\", \"pods/exec\", \"secrets\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"patch\", \"delete\"]\n\n  ## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs\n  ## cluster-wide or only within namespace\n  clusterWideAccess: false\n\n  ## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)\n  ##\n  # serviceAccountName: default\n\n  ## Specify annotations for Service Accounts, useful for annotations such as eks.amazonaws.com/role-arn\n  ##\n  ## ref: https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html\n  ##\n  # serviceAccountAnnotations: {}\n\n## Configure integrated Prometheus metrics exporter\n## ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server\nmetrics:\n  enabled: true\n\n## Configuration for the Pods that that the runner launches for each new job\n##\nrunners:\n  ## Default container image to use for builds when none is specified\n  ##\n  image: ubuntu:16.04\n\n  ## Specify one or more imagePullSecrets\n  ##\n  ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/\n  ##\n  # imagePullSecrets: []\n\n  ## Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.\n  ##\n  imagePullPolicy: \"if-not-present\"\n\n  ## Defines number of concurrent requests for new job from GitLab\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section\n  ## \u9650\u5236\u6765\u81eaGitLab\u7684\u5bf9\u65b0\u4f5c\u4e1a\u7684\u5e76\u53d1\u8bf7\u6c42\u6570\n  requestConcurrency: 1\n\n  ## Specify whether the runner should be locked to a specific project: true, false. Defaults to true.\n  ##\n  locked: false\n\n  ## Specify the tags associated with the runner. Comma-separated list of tags.\n  ##\n  ## ref: https://docs.gitlab.com/ce/ci/runners/#using-tags\n  ##\n  tags: \"kubernetes-runner,k8s\"\n\n  ## Specify if jobs without tags should be run.\n  ## If not specified, Runner will default to true if no tags were specified. In other case it will\n  ## default to false.\n  ##\n  ## ref: https://docs.gitlab.com/ce/ci/runners/#allowing-runners-with-tags-to-pick-jobs-without-tags\n  ##\n  runUntagged: true\n\n  ## Specify whether the runner should only run protected branches.\n  ## Defaults to False.\n  ##\n  ## ref: https://docs.gitlab.com/ee/ci/runners/#protected-runners\n  ##\n  protected: false\n\n  ## Run all containers with the privileged flag enabled\n  ## This will allow the docker:dind image to run if you need to run Docker\n  ## commands. Please read the docs before turning this on:\n  ## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind\n  ##\n  privileged: true\n\n  ## The name of the secret containing runner-token and runner-registration-token\n  # secret: gitlab-runner\n\n  ## Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)\n  ##\n  # namespace:\n\n  ## The amount of time, in seconds, that needs to pass before the runner will\n  ## timeout attempting to connect to the container it has just created.\n  ## ref: https://docs.gitlab.com/runner/executors/kubernetes.html\n  pollTimeout: 180\n\n  ## Set maximum build log size in kilobytes, by default set to 4096 (4MB)\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section\n  outputLimit: 4096\n\n  ## Distributed runners caching\n  ## ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching\n  ##\n  ## If you want to use s3 based distributing caching:\n  ## First of all you need to uncomment General settings and S3 settings sections.\n  ##\n  ## Create a secret 's3access' containing 'accesskey' &amp; 'secretkey'\n  ## ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/\n  ##\n  ## $ kubectl create secret generic s3access \\\n  ##   --from-literal=accesskey=\"YourAccessKey\" \\\n  ##   --from-literal=secretkey=\"YourSecretKey\"\n  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/\n  ##\n  ## If you want to use gcs based distributing caching:\n  ## First of all you need to uncomment General settings and GCS settings sections.\n  ##\n  ## Access using credentials file:\n  ## Create a secret 'google-application-credentials' containing your application credentials file.\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section\n  ## You could configure\n  ## $ kubectl create secret generic google-application-credentials \\\n  ##   --from-file=gcs-application-credentials-file=./path-to-your-google-application-credentials-file.json\n  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/\n  ##\n  ## Access using access-id and private-key:\n  ## Create a secret 'gcsaccess' containing 'gcs-access-id' &amp; 'gcs-private-key'.\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-cache-gcs-section\n  ## You could configure\n  ## $ kubectl create secret generic gcsaccess \\\n  ##   --from-literal=gcs-access-id=\"YourAccessID\" \\\n  ##   --from-literal=gcs-private-key=\"YourPrivateKey\"\n  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/\n  cache: {}\n    ## General settings\n    # cacheType: s3\n    # cachePath: \"gitlab_runner\"\n    # cacheShared: true\n\n    ## S3 settings\n    # s3ServerAddress: s3.amazonaws.com\n    # s3BucketName:\n    # s3BucketLocation:\n    # s3CacheInsecure: false\n    # secretName: s3access\n\n    ## GCS settings\n    # gcsBucketName:\n    ## Use this line for access using access-id and private-key\n    # secretName: gcsaccess\n    ## Use this line for access using google-application-credentials file\n    # secretName: google-application-credentials\n\n  ## Build Container specific configuration\n  ##\n  builds: {}\n    # cpuLimit: 200m\n    # memoryLimit: 256Mi\n    # cpuRequests: 100m\n    # memoryRequests: 128Mi\n\n  ## Service Container specific configuration\n  ##\n  services: {}\n    # cpuLimit: 200m\n    # memoryLimit: 256Mi\n    # cpuRequests: 100m\n    # memoryRequests: 128Mi\n\n  ## Helper Container specific configuration\n  ##\n  helpers: {}\n    # cpuLimit: 200m\n    # memoryLimit: 256Mi\n    # cpuRequests: 100m\n    # memoryRequests: 128Mi\n    # image: gitlab/gitlab-runner-helper:x86_64-latest\n\n  ## Service Account to be used for runners\n  ##\n  # serviceAccountName:\n\n  ## If Gitlab is not reachable through $CI_SERVER_URL\n  ##\n  # cloneUrl:\n\n  ## Specify node labels for CI job pods assignment\n  ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/\n  ##\n  # nodeSelector: {}\n\n  ## Specify pod labels for CI job pods\n  ##\n  # podLabels: {}\n\n  ## Specify annotations for job pods, useful for annotations such as iam.amazonaws.com/role\n  # podAnnotations: {}\n\n  ## Configure environment variables that will be injected to the pods that are created while\n  ## the build is running. These variables are passed as parameters, i.e. `--env \"NAME=VALUE\"`,\n  ## to `gitlab-runner register` command.\n  ##\n  ## Note that `envVars` (see below) are only present in the runner pod, not the pods that are\n  ## created for each build.\n  ##\n  ## ref: https://docs.gitlab.com/runner/commands/#gitlab-runner-register\n  ##\n  # env:\n  #   NAME: VALUE\n\n\n## Configure securitycontext\n## ref: http://kubernetes.io/docs/user-guide/security-context/\n##\nsecurityContext:\n  fsGroup: 65533\n  runAsUser: 100\n\n\n## Configure resource requests and limits\n## ref: http://kubernetes.io/docs/user-guide/compute-resources/\n##\nresources: {}\n  # limits:\n  #   memory: 256Mi\n  #   cpu: 200m\n  # requests:\n  #   memory: 128Mi\n  #   cpu: 100m\n\n## Affinity for pod assignment\n## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity\n##\naffinity: {}\n\n## Node labels for pod assignment\n## Ref: https://kubernetes.io/docs/user-guide/node-selection/\n##\nnodeSelector: {}\n  # Example: The gitlab runner manager should not run on spot instances so you can assign\n  # them to the regular worker nodes only.\n  # node-role.kubernetes.io/worker: \"true\"\n\n## List of node taints to tolerate (requires Kubernetes &gt;= 1.6)\n## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/\n##\ntolerations: []\n  # Example: Regular worker nodes may have a taint, thus you need to tolerate the taint\n  # when you assign the gitlab runner manager with nodeSelector or affinity to the nodes.\n  # - key: \"node-role.kubernetes.io/worker\"\n  #   operator: \"Exists\"\n\n## Configure environment variables that will be present when the registration command runs\n## This provides further control over the registration process and the config.toml file\n## ref: `gitlab-runner register --help`\n## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html\n##\n# envVars:\n#   - name: RUNNER_EXECUTOR\n#     value: kubernetes\n\n## list of hosts and IPs that will be injected into the pod's hosts file\nhostAliases: []\n  # Example:\n  # - ip: \"127.0.0.1\"\n  #   hostnames:\n  #   - \"foo.local\"\n  #   - \"bar.local\"\n  # - ip: \"10.1.2.3\"\n  #   hostnames:\n  #   - \"foo.remote\"\n  #   - \"bar.remote\"\n\n## Annotations to be added to manager pod\n##\npodAnnotations: {}\n  # Example:\n  # iam.amazonaws.com/role: &lt;my_role_arn&gt;\n\n## Labels to be added to manager pod\n##\npodLabels: {}\n  # Example:\n  # owner.team: &lt;my_cool_team&gt;\n\n## HPA support for custom metrics:\n## This section enables runners to autoscale based on defined custom metrics.\n## In order to use this functionality, Need to enable a custom metrics API server by\n## implementing \"custom.metrics.k8s.io\" using supported third party adapter\n## Example: https://github.com/directxman12/k8s-prometheus-adapter\n##\n#hpa: {}\n  # minReplicas: 1\n  # maxReplicas: 10\n  # metrics:\n  # - type: Pods\n  #   pods:\n  #     metricName: gitlab_runner_jobs\n  #     targetAverageValue: 400m\n</code></pre> <p>\u90e8\u7f72chart\u521b\u5efarunner</p> <pre><code>kubectl create ns gitlab-runner\nhelmi nstall gitlab-runner --namespace gitlab-runner ./gitlab-runner\n\n##\u66f4\u65b0\nhelm upgrade gitlab-runner --namespace gitlab-runner ./gitlab-runner\n</code></pre>"},{"location":"chap3/2gitlab_summary/#gitlabci-runner_1","title":"GitlabCI-Runner\u914d\u7f6e\u4f18\u5316","text":""},{"location":"chap3/2gitlab_summary/#runner","title":"runner\u90e8\u7f72\u4f18\u5316","text":"<ul> <li>\u6dfb\u52a0\u6784\u5efa\u7f13\u5b58PVC</li> <li>\u6dfb\u52a0\u5de5\u4f5c\u76ee\u5f55PVC</li> <li>\u5f00\u542f\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55</li> </ul> <p>\u51c6\u5907\u5de5\u4f5c</p> <p>runner\u914d\u7f6e\u4fe1\u606f\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570\u6307\u5b9a\uff0c\u4e5f\u53ef\u4ee5\u4ee5\u73af\u5883\u53d8\u91cf\u65b9\u5f0f\u8bbe\u7f6e\u3002\u8be6\u7ec6\u5185\u5bb9\u53ef\u4ee5\u901a\u8fc7 <code>gitlab-runner register -h</code> \u83b7\u53d6\u5230\u76f8\u5173\u53c2\u6570\u548c\u53d8\u91cf\u540d\u79f0\u3002</p> <p>\u5728\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684runner\u955c\u50cf\u6ce8\u518crunner\uff0c\u9ed8\u8ba4\u7684runner\u914d\u7f6e\u6587\u4ef6\u5728<code>/home/gitlab-runner/.gitlab-runner/config.toml</code></p>"},{"location":"chap3/2gitlab_summary/#_2","title":"\u89e3\u51b3\u6784\u5efa\u7f13\u5b58\u95ee\u9898","text":"<p>\u6240\u8c13\u7684\u6784\u5efa\u7f13\u5b58\u5c31\u662f\u6211\u4eec\u5728\u8fdb\u884cmaven/npm\u7b49\u6784\u5efa\u5de5\u5177\u6253\u5305\u65f6\u6240\u4f9d\u8d56\u7684\u5305\u3002\u9ed8\u8ba4\u4f1a\u5728\u79c1\u670d\u4e2d\u83b7\u53d6\uff0c\u52a0\u5feb\u6784\u5efa\u901f\u5ea6\u53ef\u4ee5\u5728\u672c\u5730\u7f13\u5b58\u4e00\u4efd\u3002</p> <p>\u5728\u6b64\uff0c\u9700\u8981\u521b\u5efaPVC\u6765\u6301\u4e45\u5316\u6784\u5efa\u7f13\u5b58\uff0c\u52a0\u901f\u6784\u5efa\u901f\u5ea6\u3002</p> <p>\u4e3a\u4e86\u8282\u7701\u5b58\u50a8\u7a7a\u95f4\u51b3\u5b9a\u4e0d\u5728\u6bcf\u4e2a\u9879\u76ee\u4e2d\u5b58\u50a8\u6784\u5efa\u7f13\u5b58\uff0c\u800c\u662f\u914d\u7f6e\u5168\u5c40\u7f13\u5b58\u3002</p> <p>\u51c6\u5907\u672c\u673a\u7f13\u5b58\u76ee\u5f55</p> <pre><code>/opt/ci-build-cache\n</code></pre> <p>\u9996\u5148\uff0c\u521b\u5efa\u4e00\u4e2aPVC\u7528\u4e8e\u6302\u8f7d\u5230pod\u4e2d\u4f7f\u7528\u3002</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: ci-build-cache-pv\n  namespace: gitlab-runner\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/opt/ci-build-cache\"\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: ci-build-cache-pvc\n  namespace: gitlab-runner\nspec:\n  storageClassName: manual\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n</code></pre> <p>\u4f7f\u7528\u547d\u4ee4\u67e5\u770b\u9a8c\u8bc1</p> <pre><code># kubectl get pvc -n gitlab-runner\nNAME                 STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nci-build-cache-pvc   Bound    ci-build-cache-pv   10Gi       RWO            manual     5h41m\n</code></pre> <p>pvc\u51c6\u5907\u597d\u4e86\uff0c\u8003\u8651\u5230\u4e0d\u80fd\u6bcf\u6b21\u90e8\u7f72runner\u90fd\u624b\u52a8\u6302\u8f7dpvc\uff0c\u9700\u8981\u81ea\u5b9a\u4e49<code>gitlab-runner chart</code>\uff0c\u4f18\u5316<code>runner</code>\u914d\u7f6e\u3002</p> <p>\u7b2c\u4e00\u6b65\uff1a\u7f16\u8f91value.yml\u6587\u4ef6\uff0c\u6dfb\u52a0\u6784\u5efa\u7f13\u5b58\u4fe1\u606f\u914d\u7f6e\u3002</p> <p><code>vim values.yaml</code></p> <pre><code>## configure build cache\ncibuild:\n  cache:\n    pvcName: ci-build-cache-pvc\n    mountPath: /home/gitlab-runner/ci-build-cache\n  builds:\n    pvcName: ci-build-dir-pve\n    mountPath:/home/gitlab-runner/ci-build-dir/builds\n</code></pre> <p>\u7b2c\u4e8c\u6b65\uff1a\u7f16\u8f91<code>templates/configmap.yml</code>\u6587\u4ef6\uff0c<code>entrypoint</code>\u90e8\u5206\u6dfb\u52a0<code>runner</code>\u914d\u7f6e\u3002</p> <p>\u5728start\u4e4b\u524d\u6dfb\u52a0\uff0c\u8fd9\u6837runner\u5728\u521b\u5efa\u6784\u5efapod\u7684\u65f6\u5019\u4f1a\u6839\u636e\u914d\u7f6e\u6302\u8f7dpvc\u3002</p> <pre><code>cd new-k8s-runner/\ncd gitlab-runner/\ncd templates/\nvim configmap.yaml\n</code></pre> <pre><code># add build cache\n    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF\n      [[runners.kubernetes.volumes.pvc]]\n      name = \"{{.Values.cibuild.cache.pvcName}}\"\n      mount_path = \"{{.Values.cibuild.cache.mountPath}}\"\n    EOF\n\n    # Start the runner\n    exec /entrypoint run --user=gitlab-runner \\\n      --working-directory=/home/gitlab-runner\n</code></pre> <p>\u5230\u6b64gitlab-runner chart\u90e8\u5206\u914d\u7f6e\u5c31\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u53ef\u4ee5\u901a\u8fc7Helm\u547d\u4ee4\u8fdb\u884c\u521b\u5efa\u548c\u66f4\u65b0\u4e86\u3002</p> <pre><code>helm install gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\nhelm upgrade gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0a\u547d\u4ee4\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5728gitlab admin\u9875\u9762\u548ck8s\u9762\u677f\u67e5\u770brunner\u7684\u72b6\u6001\uff0c\u786e\u4fdd\u90e8\u7f72\u6210\u529f\u3002\u67e5\u770bpod\u914d\u7f6e\u3002</p> <p></p> <p>\u90e8\u7f72\u5b8c\u6210\u4e86\uff0c\u540e\u7eed\u4f7f\u7528\u6784\u5efa\u5de5\u5177\u6253\u5305\u65f6\u6dfb\u52a0\u6307\u5b9a\u7f13\u5b58\u76ee\u5f55\u3002\u4f8b\u5982\uff1amaven</p> <pre><code>mvn clean package  -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  \n</code></pre> <p>\u53d1\u73b0\u6784\u5efa\u901f\u5ea6\u5f88\u5feb\u8bc1\u660e\u5df2\u7ecf\u5b8c\u6210\u6784\u5efa\u7f13\u5b58\u914d\u7f6e\u3002\u53ef\u4ee5\u914d\u5408\u67e5\u770b\u672c\u5730\u7f13\u5b58\u76ee\u5f55\u662f\u5426\u6709\u66f4\u65b0\uff08\u76ee\u5f55\u65f6\u95f4\uff09\u3002</p>"},{"location":"chap3/2gitlab_summary/#_3","title":"\u89e3\u51b3\u6784\u5efa\u5236\u54c1\u95ee\u9898","text":"<p>\u5728kubernetes\u4e2d\u5bf9cache\u652f\u6301\u4e00\u822c\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528artifacts\u8fdb\u884c\u4ee3\u66ff\u3002\u4f46\u662f\u8003\u8651\u5230artifacts\u6536\u96c6\u5236\u54c1\u4f1a\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\uff0c\u6240\u4ee5\u51c6\u5907\u7814\u7a76\u4e0b\u5982\u4f55\u914d\u7f6e\u7edf\u4e00\u7684\u7f13\u5b58\u3002\u5b9e\u9645\u4e0a\u6211\u4eec\u53ef\u4ee5\u5c06repo\u76ee\u5f55\u505a\u6210\u6301\u4e45\u5316\u3002</p> <p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u5728\u4f7f\u7528kubernetes\u6267\u884c\u5668\u521b\u5efa\u7684\u6784\u5efapod\u4f1a\u9ed8\u8ba4\u6302\u8f7d\u4e00\u4e2a\u7a7a\u76ee\u5f55\u3002</p> <p>\u6b64\u76ee\u5f55\u7528\u4e8e\u5b58\u50a8\u6bcf\u6b21\u4e0b\u8f7d\u7684\u4ee3\u7801\uff0c\u56e0\u4e3a\u662f\u7a7a\u76ee\u5f55\u7684\u539f\u56e0\u5bfc\u81f4\u540e\u7eed\u6d4b\u8bd5pod\u65e0\u6cd5\u83b7\u53d6\u9700\u8981\u91cd\u65b0\u4e0b\u8f7d\u4ee3\u7801\uff0c\u8fd9\u8fd8\u4e0d\u8981\u7d27\uff0c\u91cd\u8981\u7684\u662f\u6784\u5efa\u751f\u6210\u7684\u6587\u4ef6target\u76ee\u5f55\u90fd\u4e0d\u5b58\u5728\u4e86\u5bfc\u81f4\u540e\u7eed\u6b65\u9aa4\u63a5\u8fde\u5931\u8d25\u3002</p> <p></p> <p>\u76f4\u63a5\u5c06\u6301\u4e45\u5316\u7684pvc\u6302\u8f7d\u5230\u7a7a\u76ee\u5f55\u4e2d\u7684\u67d0\u4e2a\u76ee\u5f55\u4e2d\u3002\u9700\u8981\u914d\u7f6erunner\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\uff0c\u4f46\u662f\u6784\u5efa\u76ee\u5f55\u5fc5\u987b\u662f\u5728<code>$CI_BUILD_DIRS</code>\u76ee\u5f55\u91cc\u9762\u3002</p> <p></p> <p>\u51c6\u5907\u672c\u5730\u7684\u5de5\u4f5c\u76ee\u5f55</p> <pre><code>/opt/ci-build-dir\n</code></pre> <p>\u521b\u5efarepo\u6301\u4e45\u5316pvc</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: ci-build-dir-pv\n  namespace: gitlab-runner\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/opt/ci-build-dir\"\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: ci-build-dir-pvc\n  namespace: gitlab-runner\nspec:\n  storageClassName: manual\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n</code></pre> <p>\u4f7f\u7528\u547d\u4ee4\u9a8c\u8bc1</p> <pre><code># kubectl get pvc -n gitlab-runner\nNAME                 STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nci-build-cache-pvc   Bound    ci-build-cache-pv   10Gi       RWO            manual         6h41m\nci-build-dir-pvc     Bound    ci-build-dir-pv     10Gi       RWO            manual         3h11m\n</code></pre> <p>\u7f16\u8bd1<code>values.yaml</code>\u6587\u4ef6\u6dfb\u52a0\u6ce8\u518c\u914d\u7f6e\u53d8\u91cf\u3002<code>RUNNER_BUILDS_DIR</code>\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\u3002<code>CUSTOM_BUILD_DIR_ENABLED</code>\u5f00\u542f\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\u914d\u7f6e\u3002</p> <pre><code>envVars:\n  - name: RUNNER_BUILDS_DIR\n    value: \"/home/gitlab-runner/ci-build-dir/\"\n  - name: CUSTOM_BUILD_DIR_ENABLED\n    value: true\n</code></pre> <p>\u6dfb\u52a0repo\u76ee\u5f55\u7f13\u5b58\u914d\u7f6e\uff0c\u6211\u4eec\u628a\u81ea\u5b9a\u4e49\u7684\u6784\u5efa\u76ee\u5f55\u653e\u5230\u9ed8\u8ba4\u6784\u5efa\u76ee\u5f55\u7684\u4e0b\u9762builds\u76ee\u5f55\u4e2d\u3002</p> <pre><code>## configure build cache\ncibuild:\n  cache:\n    pvcName: ci-build-cache-pvc\n    mountPath: /home/gitlab-runner/ci-build-cache\n  builds:\n    pvcName: ci-build-dir-pvc\n    mountPath: /home/gitlab-runner/ci-build-dir/builds\n</code></pre> <p>\u7f16\u8f91<code>templates/configmap.yml</code></p> <pre><code># add build cache\ncat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF\n  [[runners.kubernetes.volumes.pvc]]\n  name = \"{{.Values.cibuild.cache.pvcName}}\"\n  mount_path = \"{{.Values.cibuild.cache.mountPath}}\"\n  [[runners.kubernetes.volumes.pvc]]\n  name = \"{{.Values.cibuild.builds.pvcName}}\"\n  mount_path = \"{{.Values.cibuild.builds.mountPath}}\"\nEOF\n</code></pre> <p>\u66f4\u65b0runner</p> <pre><code>helm install gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\nhelm upgrade gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\n</code></pre> <p>\u5728CI\u6587\u4ef6\u4e2d\u914d\u7f6e\uff0c\u5982\u679c\u4e0d\u5f00\u542f\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\u914d\u7f6e\u4f1a\u51fa\u73b0\u9519\u8bef\u3002</p> <pre><code>variables:\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID\n</code></pre> <p></p> <p>\u7ecf\u8fc7\u6d4b\u8bd5\u5728\u672c\u5730\u7684pv\u4e2d\u80fd\u591f\u770b\u5230\uff0c\u4e0b\u8f7d\u7684\u4ee3\u7801\u6587\u4ef6\u3002\u4f46\u662f\u9ed8\u8ba4\u6bcf\u6b21\u6bcf\u4e2ajob\u8fd0\u884c\u7684\u65f6\u5019\u90fd\u4f1a\u83b7\u53d6\u8fdc\u7a0b\u6700\u65b0\u7684\u4ee3\u7801\uff0c\u4f1a\u628a\u6784\u5efa\u76ee\u5f55\u5220\u9664\u6389\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u914d\u7f6egit checkout\u7b56\u7565\u4e86\u3002</p> <p>\u5176\u5b9e\u6309\u7167\u6211\u4eec\u76ee\u524d\u7684\u573a\u666f\uff0c\u4e0d\u9700\u8981\u6bcf\u4e2a\u4f5c\u4e1a\u90fd\u4e0b\u8f7d\u4ee3\u7801\u3002\u53ea\u8981\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u4e0b\u8f7d\u597d\u6700\u65b0\u7684\u4ee3\u7801\uff0c\u7136\u540e\u8fd0\u884c\u6d41\u6c34\u7ebf\u5373\u53ef\u3002\u5f53\u5728\u8fd0\u884c\u6d41\u6c34\u7ebf\u7684\u8fc7\u7a0b\u4e2d\u9047\u5230\u65b0\u4ee3\u7801\u63d0\u4ea4\u53ef\u4ee5\u653e\u5230\u4e0b\u6b21\u6d41\u6c34\u7ebf\u6267\u884c\u3002</p> <p>\u9700\u8981\u5728ci\u6587\u4ef6\u4e2d\u5b9a\u4e49<code>GIT_CHECKOUT</code>\u53d8\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3a<code>true</code>\uff0c\u5373\u6bcf\u6b21\u90fd\u9700\u8981\u4ee3\u7801\u4e0b\u8f7d\u3002\u6211\u4eec\u5c06\u5168\u5c40\u914d\u7f6e\u4e3afalse\u7136\u540e\u5728build\u4f5c\u4e1a\u4e2d\u914d\u7f6e\u4e3atrue\u3002\u4e5f\u5c31\u5b9e\u73b0\u4e86\u53ea\u5728build\u4f5c\u4e1a\u4e0b\u8f7d\u6700\u65b0\u4ee3\u7801\u4e86\u3002</p> <pre><code>GIT_CHECKOUT: \"false\" \n</code></pre>"},{"location":"chap3/3gitlab_config/","title":"3 \u914d\u7f6e\u590d\u6742\u7684 Gitlab CI/CD Pipeline","text":"<p>\u5047\u8bbe\u60a8\u9700\u8981\u90e8\u7f72\u591a\u4e2a\u590d\u6742\u73af\u5883\uff0c\u5e76\u4e14\u8ba1\u5212\u4f7f\u7528 Gitlab \u6d41\u6c34\u7ebf\uff0c\u8be5\u5982\u4f55\u64cd\u4f5c\uff1f\u5728 Padok\uff0c\u6211\u4eec\u5df2\u7ecf\u9047\u5230\u8fc7\u8fd9\u4e2a\u95ee\u9898\uff0c\u5e76\u901a\u8fc7\u7ed3\u5408\u591a\u9879\u76ee\u52a8\u6001\u6d41\u6c34\u7ebf\u3001\u5de5\u4ef6\u4ee5\u53ca Gitlab \u4f5c\u4e1a\u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u89e3\u51b3\u4e86\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>\u672c\u6587\u4ecb\u7ecd\u4e86\u6211\u4eec\u9488\u5bf9\u8be5\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\u3001\u6211\u4eec\u5f00\u53d1\u7684\u7ec4\u4ef6\u4ee5\u53ca\u5982\u4f55\u5b89\u6392\u5b83\u4eec\u534f\u540c\u5de5\u4f5c\u3002\u76ee\u6807\u662f\u521b\u5efa\u4ee5\u4e0b\u7ba1\u9053\u7ed3\u6784\uff1a</p> <p></p> <p>Gitlab\u662f\u4e00\u4e2a\u57fa\u4e8e Git \u7684 Web \u6e90\u4ee3\u7801\u63a7\u5236\u5b58\u50a8\u5e93\uff0c\u4e13\u4e3a\u56e2\u961f\u534f\u4f5c\u548c\u751f\u4ea7\u529b\u800c\u8bbe\u8ba1\u3002</p> <p>\u5b83\u662f\u4e00\u6b3e\u975e\u5e38\u5f3a\u5927\u7684\u5f00\u53d1\u5de5\u5177\uff0c\u53ef\u8ba9\u60a8\u7684\u56e2\u961f\u638c\u63a7\u5168\u5c40\uff0c\u4f18\u5316\u5de5\u4f5c\u6d41\u7a0b\u4ee5\u7b26\u5408\u90e8\u7f72 SLA\uff0c\u5e76\u63d0\u4f9b\u5927\u91cf\u9009\u9879\u6765\u521b\u5efa\u590d\u6742\u7684 CI/CD \u6d41\u6c34\u7ebf</p>"},{"location":"chap3/3gitlab_config/#gitlab","title":"\u5982\u4f55\u8bbe\u7f6e\u52a8\u6001 Gitlab \u7ba1\u9053\uff1f","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u80fd\u591f\u52a8\u6001\u8fd0\u884c\u4e0b\u6e38\u7ba1\u9053\u7684\u4e3b\u4f5c\u4e1a\u3002\u6211\u4eec\u5e0c\u671b\u6839\u636e\u7528\u6237\u5728\u8f93\u5165\u53c2\u6570\u4e2d\u7684\u9009\u62e9\u521b\u5efa\u4efb\u610f\u6570\u91cf\u7684\u73af\u5883\uff1a\u53ef\u4ee5\u662f 1 \u4e2a\uff0c\u4e5f\u53ef\u4ee5\u662f\u50cf\u672c\u4f8b\u4e2d\u90a3\u6837\u7684 3 \u4e2a\uff0c\u6216\u8005\u66f4\u591a\u3002</p> <p>\u95ee\u9898\u662f\uff1a\u5982\u4f55create-env\u591a\u6b21\u89e6\u53d1\u8be5\u4f5c\u4e1a\uff1f\u7b54\u6848\u662f\uff1a\u4f7f\u7528\u52a8\u6001 Gitlab \u7ba1\u9053</p> <p>GitLab CI \u4e2d\u7684\u52a8\u6001\u7ba1\u9053\u662f\u6839\u636e\u67d0\u4e9b\u6761\u4ef6\u6216\u53c2\u6570\u4ee5\u7f16\u7a0b\u65b9\u5f0f\u751f\u6210\u7684\u3002\u8fd9\u610f\u5473\u7740\u7ba1\u9053\u4e2d\u7684\u6b65\u9aa4\u548c\u4efb\u52a1\u4e0d\u662f\u56fa\u5b9a\u7684\uff0c\u800c\u662f\u53ef\u4ee5\u6839\u636e\u8f93\u5165\u6216\u4e0a\u4e0b\u6587\u8fdb\u884c\u66f4\u6539</p> <p>\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4eec\u81ea\u52a8\u8fd0\u884c\u4e00\u4e2a\u9700\u8981\u6267\u884c\u6570\u767e\u6b21\u76f8\u540c\u4efb\u52a1\u7684\u4f5c\u4e1a\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u51e0\u4e4e\u5b8c\u5168\u76f8\u540c\uff0c\u4f46\u53ea\u6709\u7ec6\u5fae\u7684\u5dee\u522b\u3002</p> <p>\u7f16\u5199\u540c\u4e00\u4f5c\u4e1a\u7684\u6bcf\u4e2a\u53d8\u4f53\u5c06\u975e\u5e38\u7e41\u7410\uff0c\u51e0\u4e4e\u4e0d\u53ef\u80fd\u3002\u60a8\u65e0\u9700\u7f16\u5199\u6570\u5343\u884c\u4ee3\u7801\uff0c\u800c\u662f\u53ef\u4ee5\u4f7f\u7528Gitlab CI\u4e2d\u7684\u52a8\u6001\u7ba1\u9053\u751f\u6210\u5b83\u4eec\u3002</p> <p>\u52a8\u6001\u7ba1\u9053\u6709\u52a9\u4e8e\u7ba1\u7406\u590d\u6742\u6216\u5927\u578b\u7684CI/CD \u7ba1\u9053\uff0c\u5176\u4e2d\u7684\u4efb\u52a1\u548c\u4f9d\u8d56\u5173\u7cfb\u53ef\u80fd\u56e0\u4e0a\u4e0b\u6587\u800c\u5f02\u3002\u5b83\u4eec\u5141\u8bb8\u56e2\u961f\u81ea\u52a8\u5316\u548c\u5b9a\u5236\u5176 CI/CD \u6d41\u7a0b\uff0c\u4ece\u800c\u63d0\u9ad8\u6548\u7387\u548c\u6548\u679c\u3002</p> <pre><code> bootstrap-env/.gitlab-ci.yml\n# boostrap-env\n# \u251c\u2500\u2500 .gitlab-ci.yml   &lt;--\n# \u251c\u2500\u2500 generate_templates.py\n# \u2514\u2500\u2500 requirements.txt\n\nvariables:\nENVIRONMENTS:\ndescription:\"User input: comma-separated list of environments\"\nvalue:\"dev,prod,staging\"\n\nstages:\n-templating\n-deployment\n\ngenerate-templates:\nstage:templating\nimage:python:3.10\nbefore_script:\n    -pipinstall-rrequirements.txt\nscript:\n    -pythongenerate_templates.py--env$ENVIRONMENTS\nartifacts:\n    paths:\n      -environments.yml\n\ndeploy-envs:\nstage:deployment\ntrigger:\n    include:\n      -artifact:environments.yml\n        job:generate-templates\nstrategy:depend\n</code></pre> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u81ea\u5b9a\u4e49 Python \u811a\u672c\u4e3a Gitlab CI/CD \u4f5c\u4e1a\u751f\u6210 YAML \u914d\u7f6e\u6587\u4ef6\u3002</p> <p>\u8fd9\u662f\u6d41\u6c34\u7ebf\u7684\u7b2c\u4e00\u9636\u6bb5\uff1atemplating\u3002</p> <p>\u5728\u7b2c\u4e8c\u9636\u6bb5deployment\uff0c\u6211\u4eec\u4f7f\u7528\u751f\u6210\u7684\u6587\u4ef6\u6765\u90e8\u7f72\u7528\u6237\u6700\u521d\u5728ENVIRONMENTS\u53d8\u91cf\u4e2d\u8bf7\u6c42\u7684\u6bcf\u4e2a\u73af\u5883</p> <p>\u56e0\u6b64\uff0cenvironments.yml \u914d\u7f6e\u6587\u4ef6\u5c06\u5305\u542b 3 \u4e2a\u4f5c\u4e1a\uff0c\u6bcf\u4e2a\u4f5c\u4e1a\u8d1f\u8d23\u521b\u5efa\u4e00\u4e2a\u73af\u5883\uff1adev\u3001prod \u548c staging\u3002</p> <p></p> <p>\u7528\u6237\u53ef\u4ee5\u8f93\u5165\u4ed6\u4eec\u9700\u8981\u7684\u73af\u5883\uff0c\u6a21\u677f\u9636\u6bb5\u5c06\u521b\u5efa\u4e0e\u9700\u8981\u5f15\u5bfc\u7684\u73af\u5883\u4e00\u6837\u591a\u7684\u4f5c\u4e1a\u3002</p> <p>\u77a7\uff01\u6211\u4eec\u6709\u4e86 3 \u4e2a\u5b50\u4f5c\u4e1a\uff0c\u5206\u522b\u5bf9\u5e94\u6211\u4eec\u8981\u6c42\u7684 3 \u4e2a\u73af\u5883\uff0c\u4f46\u662f\u5982\u4f55\u8ba9\u5b83\u4eec\u771f\u6b63\u521b\u5efa\u65b0\u7684\u73af\u5883\u5462\uff1f</p>"},{"location":"chap3/3gitlab_config/#gitlab_1","title":"\u5982\u4f55\u8bbe\u7f6e\u591a\u9879\u76ee\u4e0b\u6e38 Gitlab \u7ba1\u9053\uff1f","text":"<p>\u5176\u6b21\uff0c\u6211\u4eec\u5e0c\u671b\u76ee\u6807\u6d41\u6c34\u7ebf\u67b6\u6784\u7684\u6bcf\u4e2a\u6b65\u9aa4\u90fd\u4f4d\u4e8e\u4e00\u4e2a\u4e13\u95e8\u7684 Gitlab \u9879\u76ee\u4e2d\u3002\u95ee\u9898\u5728\u4e8e\u544a\u8bc9 Gitlab\uff1a\u201c\u60a8\u80fd\u5426\u89e6\u53d1\u53e6\u4e00\u4e2a\u9879\u76ee\u7684\u6d41\u6c34\u7ebf\u6765\u4e3a\u6211\u521b\u5efa\u4e00\u4e2a\u65b0\u73af\u5883\uff1f\u201d Gitlab \u5b9e\u9645\u4e0a\u63d0\u4f9b\u4e86\u4e24\u79cd\u4e0d\u540c\u7684\u65b9\u6cd5\u6765\u5b9e\u73b0\u8fd9\u4e00\u70b9\uff1a\u4f7f\u7528trigger\u6216\u8c03\u7528 API\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u4e24\u8005\uff0c\u56e0\u4e3a\u53ef\u4ee5\u89e6\u53d1\u7684\u4e0b\u6e38\u7ba1\u9053\u7684\u6700\u5927\u6df1\u5ea6\u4e3a 2\uff0c\u4f46\u5728\u8fd9\u91cc\u6211\u4eec\u81f3\u5c11\u9700\u8981 3\uff01\u5e0c\u671b\u4f7f\u7528 API \u89e6\u53d1\u5b83\u4eec\u4f1a\u91cd\u7f6e\u8ba1\u6570\u5668\uff0c\u8fd9\u6837\u60a8\u5c31\u53ef\u4ee5\u4f7f\u7528\u6b64\u6280\u672f\u5411\u4e0b\u79fb\u52a8\u4efb\u610f\u5c42\u7ea7\u3002\u8fd9\u662f\u4e00\u4e2a\u5f88\u9177\u7684\u6280\u5de7\uff0c\u4f46\u9700\u8981\u6743\u8861\u5229\u5f0a\u3002</p> <p>\u597d\u7684\u4e00\u9762\u662f\uff0c\u8fd9\u4e24\u79cd\u65b9\u6cd5\u5728\u7236\u5b50\u8868\u793a\u65b9\u9762\u5177\u6709\u7c7b\u4f3c\u7684\u884c\u4e3a\u3002\u6b63\u5982\u60a8\u5728trigger\u4f5c\u4e1a\u4e2d\u6240\u671f\u671b\u7684\u90a3\u6837\uff0c\u60a8\u53ef\u4ee5\u770b\u5230\u7236\u9879\u76ee\u4e2d\u8fd0\u884c\u7684\u7ba1\u9053\uff0c\u4ee5\u53ca\u5b50\u9879\u76ee\u4e2d\u8fd0\u884c\u7684\u7ba1\u9053\uff0c\u5e76\u5e26\u6709\u6307\u5411\u539f\u59cb\u9879\u76ee\u7684\u94fe\u63a5\u3002</p> <p>\u7136\u800c\uff0c\u4e0d\u5229\u7684\u4e00\u9762\u662f\uff0c\u5f53\u6d89\u53ca\u5927\u91cf\u53d8\u91cf\u5e76\u9700\u8981\u4f20\u9012\u7ed9\u5b50\u7ba1\u9053\u65f6\uff0cPOST \u547d\u4ee4\u8bed\u6cd5\u4f1a\u53d8\u5f97\u6709\u70b9\u96be\u4ee5\u7406\u89e3\u3002</p> <p>\u6b64\u5916\uff0c\u4f7f\u7528 API \u8c03\u7528\u5b50\u7ba1\u9053\u7684\u7236\u4f5c\u4e1a\u4e0d\u4f1a\u7b49\u5f85\u5176\u5b50\u7ba1\u9053\u7ec8\u6b62\u3002\u76f8\u53cd\uff0c\u53ea\u8981 curl \u547d\u4ee4\u6b63\u786e\u6267\u884c\uff0c\u5b83\u4eec\u5c31\u4f1a\u6210\u529f\u9000\u51fa\u3002\u5f53\u4f60\u9700\u8981\u540e\u7eed\u9636\u6bb5\u7684\u5176\u4ed6\u4f5c\u4e1a\u6267\u884c\u8fd9\u4e9b\u6b65\u9aa4\u65f6\uff0c\u8fd9\u53ef\u80fd\u4f1a\u6210\u4e3a\u4e00\u4e2a\u95ee\u9898\u3002\u4e00\u79cd\u89e3\u51b3\u65b9\u6cd5\u662f\u5728 API \u8c03\u7528\u540e\u6dfb\u52a0\u4e00\u4e2a\u7b49\u5f85\u5faa\u73af\u3002</p> <p>\u6211\u4eec\u7814\u7a76\u4e86\u591a\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u4e3b\u8981\u662f Shell \u811a\u672c\u4e2d\u7684\u5faa\u73af\uff0c\u8fd9\u4e9b\u5faa\u73af\u8c03\u7528 Gitlab API \u4e4b\u4e00\u6765\u5217\u51fa\u9879\u76ee\u4f5c\u4e1a\u3001\u5217\u51fa\u7ba1\u9053\u4f5c\u4e1a\u6216\u5217\u51fa\u7ba1\u9053\u6865\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u60a8\u7684\u9700\u8981\u3002</p> <pre><code># bootstrap-env/generated-template.yml\n\ndeploy-staging:\nenvironment:staging\nvariables:\n    GITLAB_PROJECT_ID:123456789# the project ID of 'create-env'\n    GITLAB_REF:main\nscript:\n    - &gt; \n      curl --request POST\n      --form \"token=$CI_JOB_TOKEN\"\n      --form \"ref=$GITLAB_REF\"\n      --form \"variables[ENVIRONMENT]=$CI_ENVIRONMENT_NAME\"\n      \"https://gitlab.com/api/v4/projects/$GITLAB_PROJECT_ID/trigger/pipeline\"\n</code></pre> <p>\u8fd9\u6837\uff0c\u6bcf\u4e2a\u751f\u6210\u7684\u4f5c\u4e1a\u90fd\u4f1a\u89e6\u53d1<code>create-env</code>\u7ba1\u9053\u3002</p> <p>\u6211\u4eec\u4f7f\u7528curl\u8c03\u7528Gitlab API\uff0c\u5e76\u6307\u5b9atoken\u89e6\u53d1\u591a\u9879\u76ee\u7ba1\u9053\u6240\u9700\u7684\u91cd\u8981\u53c2\u6570\uff0c</p> <p>\u4f8b\u5982 \u3002\u6b64\u5916\uff0c\u6211\u4eec\u4f20\u9012\u76f8\u5173\u53d8\u91cf\uff1a\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2aENVIRONMENT\u7528\u4e8e\u540e\u7eed\u9636\u6bb5\u7684\u53d8\u91cf\u3002</p> <p>\u53cd\u8fc7\u6765\uff0c<code>create-env</code>\u4f7f\u7528\u4ee5\u4e0b\u65b9\u5f0f\u89e6\u53d1<code>add-resources</code>\uff1a</p> <pre><code># create-env/.gitlab-ci.yml\n\nstages:\n-resources\n\nadd-env-resources:\nstage:resources\nrules:\n    -if:$CI_PIPELINE_SOURCE==\"pipeline\"\ntrigger:\n    project:\"$GITLAB_GROUP/add-resources\"\n    branch:main\n    strategy:depend\n\n# [ ... ]\n</code></pre> <p>\u5bf9\u4e8e\u591a\u9879\u76ee\u7ba1\u9053\uff0c\u8be5trigger\u5173\u952e\u5b57\u63a5\u53d7 </p> <p>Gitlab project \u4f5c\u4e3a\u53c2\u6570\uff0c\u53ef\u4ee5\u662f\u7b80\u5355\u5b57\u7b26\u4e32\uff0c\u4e5f\u53ef\u4ee5\u662f project \u5173\u952e\u5b57\u3002\u6b64\u5916\uff0c\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u8be5<code>trigger:project</code>\u8bed\u6cd5\u4ec5\u9002\u7528\u4e8e Gitlab Premium \u5e10\u6237\u3002\u8be5strategy: depend\u9009\u9879\u4f7f\u7236\u7ba1\u9053\u7684\u72b6\u6001\u53d6\u51b3\u4e8e\u5176\u5b50\u7ba1\u9053\u7684\u72b6\u6001\u3002</p> <p>\u53e6\u5916\uff0c\u8bf7\u6ce8\u610f\uff0crules\u53ea\u6709\u5f53\u53e6\u4e00\u4e2a\u7ba1\u9053\u89e6\u53d1\u65f6\uff0c\u4f5c\u4e1a\u624d\u4f1a\u8fd0\u884c\u3002\u8fd9\u6709\u52a9\u4e8e\u907f\u514d\u5728\u4ee3\u7801\u63a8\u9001\u548c\u5408\u5e76\u8bf7\u6c42\u65f6\u610f\u5916\u521b\u5efa\u73af\u5883\u2026\u2026\u8fd9\u4e9b\u73af\u5883\u53ef\u80fd\u4f1a\u8fc5\u901f\u6f14\u53d8\u6210\u975e\u5e38\u4e25\u91cd\u7684\u95ee\u9898\uff01</p> <p>\u5728\u67b6\u6784\u7684\u66f4\u6df1\u5904\uff0c\u591a\u9879\u76ee\u4e0b\u6e38\u7ba1\u9053\u5c06\u4ee5\u76f8\u540c\u7684\u65b9\u5f0f\u5de5\u4f5c\uff1aresource1\u4f7f\u7528trigger\u903b\u8f91\u8c03\u7528add-resource1\uff0c\u4f9d\u6b64\u7c7b\u63a8\u3002</p> <p>\u95ee\u9898\u89e3\u51b3\u4e86\u3002\u7136\u800c\uff0c\u5f53\u6d89\u53ca\u5230\u6587\u7269\u65f6\uff0c\u4e8b\u60c5\u5c31\u53d8\u5f97\u68d8\u624b\u4e86\u3002</p>"},{"location":"chap3/3gitlab_config/#gitlab_2","title":"\u5982\u4f55\u5728 Gitlab \u4f5c\u4e1a\u4e4b\u95f4\u4f20\u9012\u5de5\u4ef6\uff1f","text":"<p>\u6700\u540e\u662f\u5de5\u4ef6\u3002\u6211\u4eec\u4f7f\u7528\u5b83\u4eec\u6765\u4f20\u8fbe\u6709\u5173\u5728\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u521b\u5efa\u7684\u8d44\u6e90\u7684\u4fe1\u606f\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0cresource2\u9700\u8981\u6709\u5173 resource1\u7684\u4fe1\u606f\uff0c\u800cresource3\u9700\u8981\u6709\u5173resource1&amp; resource2\u7684\u4fe1\u606f\u3002</p> <p>\u6bcf\u4e2a\u7ba1\u9053\u7684\u672b\u5c3e\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u5de5\u4ef6add-resource#\uff0c\u6211\u4eec\u5728\u7236\u7ea7\u83b7\u53d6\u5b83\u4eec\uff0c\u4ee5\u4fbf\u5728\u521b\u5efa\u65b0\u8d44\u6e90\u65f6\u5c06\u53d8\u91cf\u4f20\u9012\u7ed9\u5176\u4ed6\u5b50\u7ea7\u3002</p> <p>\u8bf7\u6beb\u4e0d\u72b9\u8c6b\u5730\u67e5\u770b\u672c\u6587\u9876\u90e8\u7684\u7b2c\u4e00\u4e2a\u56fe\u8868\uff1a\u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u91cd\u70b9\u5173\u6ce8\u6700\u53f3\u4fa7\uff0c\u5305\u62ec\u6240\u6709\u4e0e\u8d44\u6e90\u76f8\u5173\u7684\u5b58\u50a8\u5e93\u548c\u7ba1\u9053\u3002</p> <p>\u4e3b\u8981\u6311\u6218\u4e4b\u4e00\u662f\u4f5c\u4e1a\u4e4b\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u56fe\uff1a\u7236\u4f5c\u4e1a\u5fc5\u987b\u7b49\u5f85\u5b50\u4f5c\u4e1a\u6210\u529f\u9000\u51fa\u3002\u7136\u540e\u5b83\u4eec\u624d\u80fd\u83b7\u53d6\u751f\u6210\u7684\u5de5\u4ef6\u3002stages\u5bf9\u4e8e\u540c\u4e00\u9879\u76ee\u4e2d\u7684\u4f5c\u4e1a\uff0c\u4f7f\u7528\u4f9d\u8d56\u7b56\u7565\u5b9e\u73b0\u8d77\u6765\u76f8\u5bf9\u5bb9\u6613\uff1a</p> <pre><code># add-resources/.gitlab-ci.yml\n# add-resources\n# \u251c\u2500\u2500 .gitlab-ci.yml   &lt;--\n# \u251c\u2500\u2500 resource1.yml\n# \u251c\u2500\u2500 resource2.yml\n# \u2514\u2500\u2500 resource3.yml\n\nvariables:\nARTIFACT_RESOURCE3:\"resource3-outputs.zip\"\nARTIFACT_RESOURCE2:\"resource2-outputs.zip\"\nARTIFACT_RESOURCE1:\"resource1-outputs.zip\"\n\nstages:\n-resource1\n-resource2\n-resource3\n\nadd-resource1:\nstage:resource1\ntrigger:\n    include:\n      -local:\"resource1.yml\"\n    strategy:depend\n\nadd-resource2:\nstage:resource2\ntrigger:\n    include:\n      -local:\"resource2.yml\"\n    strategy:depend\n\nadd-resource3:\nstage:resource3\ntrigger:\n    include:\n      -local:\"resource3.yml\"\n    strategy:depend\n ```\n\n\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cGitLab \u4e2d\u6240\u6709\u6765\u81ea\u5148\u524d\u9636\u6bb5\u7684\u5de5\u4ef6\u90fd\u4f1a\u4f20\u9012\u5230\u540e\u7eed\u9636\u6bb5\u3002\u8fd9\u4f1a\u5bfc\u81f4\u5b58\u50a8\u3001\u5b89\u5168\u6027\u548c\u6d41\u6c34\u7ebf\u901f\u5ea6\u65b9\u9762\u7684\u95ee\u9898\u3002\u4e3a\u4e86\u7f13\u89e3\u8fd9\u4e2a\u95ee\u9898\uff0c\u60a8\u8fd8\u53ef\u4ee5\u8003\u8651dependencies\u4f7f\u7528\u5b57\u6bb5\u6765\u7cbe\u786e\u6307\u5b9a\u4f5c\u4e1a\u6240\u9700\u7684\u5de5\u4ef6\u3002\n\n\u53e6\u4e00\u65b9\u9762\uff0c\u5f53\u5de5\u4f5c\u662f\u591a\u9879\u76ee\u4e0b\u6e38\u7ba1\u9053\u4e2d\u4e0d\u540c\u9879\u76ee\u7684\u4e00\u90e8\u5206\u65f6\uff0c\u8fd9\u79cdstage\u65b9\u6cd5\u662f\u4e0d\u591f\u7684\uff0c\u60a8\u5c06\u4e0d\u5f97\u4e0d\u4f7f\u7528needs\u5173\u952e\u5b57\u3002\n\n</code></pre>"},{"location":"chap3/3gitlab_config/#add-resourcesresource2yml","title":"add-resources/resource2.yml","text":""},{"location":"chap3/3gitlab_config/#add-resources","title":"add-resources","text":""},{"location":"chap3/3gitlab_config/#gitlab-ciyml","title":"\u251c\u2500\u2500 .gitlab-ci.yml","text":""},{"location":"chap3/3gitlab_config/#resource1yml","title":"\u251c\u2500\u2500 resource1.yml","text":""},{"location":"chap3/3gitlab_config/#resource2yml-","title":"\u251c\u2500\u2500 resource2.yml   &lt;--","text":""},{"location":"chap3/3gitlab_config/#resource3yml","title":"\u2514\u2500\u2500 resource3.yml","text":"<p>variables: GITLAB_PROJECT:add-resource2 GITLAB_REF:main</p>"},{"location":"chap3/3gitlab_config/#parse-artifacts-to-get-information-needed-for-resource2-pipeline","title":"Parse artifacts to get information needed for resource2 pipeline","text":"<p>parse-resource1-artifact: before_script:     -apt-getupdate&amp;&amp;apt-getinstall-yzipjq needs:     -project:\"$GITLAB_GROUP/add-resource1\"       job:add-resource1       ref:main       artifacts:true script:     -echo\"Parsing resource1 artifact from \\\"$ARTIFACT_RESOURCE1\\\"...\"     -&gt;       RESOURCE1_ID=$(unzip -p $ARTIFACT_RESOURCE1 resource1_information.json | jq -r '.id') &amp;&amp;       echo $RESOURCE1_ID</p>"},{"location":"chap3/3gitlab_config/#triggers-the-creation-of-a-new-resource2-resource","title":"Triggers the creation of a new resource2 resource","text":"<p>trigger-resource2-pipeline: variables:     RESOURCE1_ID:$RESOURCE1_ID trigger:     project:\"$GITLAB_GROUP/$GITLAB_PROJECT\"     branch:$GITLAB_REF     strategy:depend     forward:       pipeline_variables:true needs:     -parse-resource1-artifact ```</p> <p>\u903b\u8f91needs\u4f18\u5148\u4e8estage\u903b\u8f91\uff1a\u8fd9\u610f\u5473\u7740\u5982\u679c\u540c\u65f6\u8bbe\u7f6e\u4e86\u4e24\u4e2a\u5b57\u6bb5\uff0c\u7ba1\u9053\u5c06\u5ffd\u7565\u9636\u6bb5\u987a\u5e8f\uff0c\u53ea\u5173\u6ce8\u9700\u6c42\u3002</p> <p>\u6839\u636e\u5b98\u65b9\u6587\u6863\uff0c\u5bf9\u4e8e\u5de5\u4ef6\u4e5f\u662f\u5982\u6b64\uff1a</p> <p>\u201c\u5f53\u4e00\u9879\u5de5\u4f5c\u4f7f\u7528\u65f6needs\uff0c\u5b83\u4e0d\u518d\u9ed8\u8ba4\u4e0b\u8f7d\u6765\u81ea\u5148\u524d\u9636\u6bb5\u7684\u6240\u6709\u5de5\u4ef6\uff0c\u56e0\u4e3a\u5e26\u6709\u7684\u4f5c\u4e1a needs\u53ef\u4ee5\u5728\u5148\u524d\u9636\u6bb5\u5b8c\u6210\u4e4b\u524d\u5f00\u59cb\u201d\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u786e\u4fdd\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u5728\u8fd0\u884c\u5b9e\u9645\u7ba1\u9053\u4e4b\u524d\u4ece\u4e0a\u4e00\u6b65\u68c0\u7d22\u5de5\u4ef6\uff1a\u5728\u4e2dparse-resource1-artifact\uff0c\u6211\u4eec\u4e0b\u8f7d\u5de5\u4ef6\uff0c\u7136\u540e\u63d0\u53d6\u4e00\u4e9b\u4fe1\u606f\u3002</p> <p>\u4e3a\u4e86\u4e3e\u4f8b\uff0c\u6211\u4eec\u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u89e3\u6790\u903b\u8f91\uff0c\u4f46\u8f93\u51fa\u53ef\u4ee5\u662f\u81ea\u5b9a\u4e49 JSON \u6587\u4ef6\u3001\u65e5\u5fd7\u3001Terraform \u72b6\u6001\u3001Kubernetes API \u8c03\u7528\u2026\u2026\u60a8\u660e\u767d\u4e86\u3002</p>"},{"location":"chap4/1git_template/","title":"1 \u6a21\u677f\u5e93\u8bbe\u8ba1Maven+NPM","text":""},{"location":"chap4/1git_template/#macos-install-gitlab-runner","title":"MacOS install gitlab-runner","text":"<pre><code>sudo curl --output /usr/local/bin/gitlab-runner \"https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-darwin-amd64\"\n\nsudo chmod +x /usr/local/bin/gitlab-runner\n\nsu - &lt;username&gt;\n\ncd ~\n\ngitlab-runner install --working-directory=~/k8s_test/gitlab/gitlab-runner\n\ngitlab-runner start\n</code></pre> <pre><code>$ gitlab-runner start\nRuntime platform                                    arch=amd64 os=darwin pid=87643 revision=32fc1585 version=15.2.1\n\n</code></pre> <pre><code>gitlab-runner register --non-interactive --executor shell --url http://127.0.0.1:32220/ --registration-token \"nzTshoYwsnCttkyzZBxE\" --description \"local-runner\" --tag-list \"local\" --run-untagged=\"true\" --locked=\"false\" --access-level=\"not_protected\"\n</code></pre> <pre><code>$ gitlab-runner register --non-interactive --executor shell --url http://127.0.0.1:32220/ --registration-token \"nzTshoYwsnCttkyzZBxE\" --description \"local-runner\" --tag-list \"local\" --run-untagged=\"true\" --locked=\"false\" --access-level=\"not_protected\"\nRuntime platform                                    arch=amd64 os=darwin pid=88396 revision=32fc1585 version=15.2.1\nWARNING: Running in user-mode.                     \nWARNING: Use sudo for system-mode:                 \nWARNING: $ sudo gitlab-runner...                   \n\nRegistering runner... succeeded                     runner=nzTshoYw\nRunner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded!\n\nConfiguration (with the authentication token) was saved in \"/Users/i515190/.gitlab-runner/config.toml\" \n</code></pre> <pre><code>$ gitlab-runner verify\nRuntime platform                                    arch=amd64 os=darwin pid=88442 revision=32fc1585 version=15.2.1\nWARNING: Running in user-mode.                     \nWARNING: Use sudo for system-mode:                 \nWARNING: $ sudo gitlab-runner...                   \n\nVerifying runner... is alive                        runner=kj_hvL6s\n</code></pre>"},{"location":"chap4/1git_template/#install-maven-docker-gitlab-runner","title":"Install maven-docker  gitlab-runner","text":"<pre><code>gitlab-runner register  --non-interactive  \\\n--executor=\"docker\" \\\n--custom_build_dir-enabled=\"true\" \\\n--docker-image=\"maven:latest\" \\\n--url=\"http://127.0.0.1:32220/\" \\\n--registration-token=\"nzTshoYwsnCttkyzZBxE\" \\\n--description=\"docker-runner\" \\\n--tag-list=\"docker\" \\\n--run-untagged=\"true\" \\\n--locked=\"false\" \\\n--docker-network-mode=\"gitlabnetwork\" \\\n--cache-dir=\"/cache\" \\\n--docker-disable-cache=\"true\" \\\n--docker-volumes=\"gitlab-runner-builds:~/k8s_test/gitlab/gitlab-runner\" \\\n--docker-volumes=\"gitlab-runner-cache:~/k8s_test/gitlab/gitlab-runner\" \\\n--docker-privileged=\"true\" \\\n--docker-volumes=\"/var/run/docker.sock:/var/run/docker.sock\"\n</code></pre>"},{"location":"chap4/1git_template/#_1","title":"\u6a21\u677f\u5e93\u8bbe\u8ba1","text":"<p>\u4e3a\u4e86\u5b9e\u73b0\u6a21\u677f\u590d\u7528\uff0c\u51cf\u5c11\u91cd\u590d\u4ee3\u7801\u3002\u672c\u6b21\u8bfe\u7a0b\u5f00\u59cb\u6211\u4eec\u5c06\u4f7f\u7528\u6a21\u677f\u5e93\u6765\u5b8c\u6210\u6d41\u6c34\u7ebf\u3002\u5f00\u59cb\u4e4b\u524d\u8fd8\u662f\u8981\u628a\u8bed\u6cd5\u5b66\u597d\u4fbf\u4e8e\u8fdb\u4e00\u6b65\u5b9e\u65bd\u3002</p> <p>\u521b\u5efa\u4e00\u4e2agit\u4ed3\u5e93\u7528\u4e8e\u5b58\u653e\u6a21\u677f<code>demo/demo-gitlabci-service</code> \uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a<code>template</code>\u76ee\u5f55\u5b58\u653e\u6240\u6709<code>pipeline</code>\u7684\u6a21\u677f\uff0c\u521b\u5efa\u4e00\u4e2a<code>jobs</code>\u76ee\u5f55\u5b58\u653ejob\u6a21\u677f\u3002</p> <p></p> <p>\u8fd9\u6837\u6211\u4eec\u53ef\u4ee5\u5c06\u4e00\u4e9bmaven\u3001ant\u3001gradle\u3001npm\u5de5\u5177\u901a\u8fc7\u4e00\u4e2ajob\u6a21\u677f\u548c\u4e0d\u540c\u7684\u6784\u5efa\u547d\u4ee4\u5b9e\u73b0\u3002</p> <p>templates\u7684\u597d\u5904\u662f\u6211\u4eec\u5728\u5176\u4e2d\u5b9a\u4e49\u4e86\u6a21\u677f\u6d41\u6c34\u7ebf\uff0c\u8fd9\u4e9b\u6d41\u6c34\u7ebf\u53ef\u4ee5\u76f4\u63a5\u8ba9\u9879\u76ee\u4f7f\u7528\u3002\u5f53\u9047\u5230\u4e2a\u6027\u5316\u9879\u76ee\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u5728\u5f53\u524d\u9879\u76ee\u521b\u5efa<code>.gitlab-ci.yml</code>\u6587\u4ef6\u6765\u5f15\u7528\u6a21\u677f\u6587\u4ef6\uff0c\u518d\u8fdb\u4e00\u6b65\u5b9e\u73b0\u4e2a\u6027\u5316\u9700\u8981\u3002</p> <ul> <li>\u521b\u5efa\u4e00\u4e2agit\u4ed3\u5e93\u7528\u4e8e\u5b58\u653e\u6a21\u677f</li> <li>\u521b\u5efa\u4e00\u4e2atemplate\u76ee\u5f55\u5b58\u653e\u6240\u6709pipeline\u7684\u6a21\u677f</li> <li>\u521b\u5efa\u4e00\u4e2ajobs\u76ee\u5f55\u5b58\u653ejiob\u6a21\u677f\u3002</li> </ul>"},{"location":"chap4/1git_template/#project-url-project-slug","title":"\u521b\u5efa\u4e00\u4e2aProject URL / Project slug","text":"<ul> <li>cidevops</li> <li>cidevops-gitlabci-service</li> </ul>"},{"location":"chap4/1git_template/#-","title":"\u5de5\u5177\u94fe\u96c6\u6210-\u6784\u5efa\u5de5\u5177\u96c6\u6210","text":"<p>\u5185\u5bb9\u5927\u7eb2</p> <ul> <li>\u540e\u7aef\u9879\u76eeMaven\u96c6\u6210</li> <li>\u524d\u7aef\u9879\u76eeNpm\u96c6\u6210</li> </ul>"},{"location":"chap4/1git_template/#_2","title":"\u96c6\u6210\u6784\u5efa\u5de5\u8c9d","text":"<p>\u6784\u5efa\u5de5\u5177\u662f\u7528\u6765\u5c06\u4ee3\u7801\u7f16\u8bd1\u6253\u5305\u6210\u5236\u54c1\u7684\u5de5\u5177\u3002</p> <p>\u4f8b\u5982\u524d\u7aef\u9879\u76ee\u6211\u4eec\u4e00\u822c\u4f7f\u7528npm\u8fdb\u884c\u6253\u5305\uff0c\u540e\u7aefJava\u9879\u76ee\u6211\u4eec\u4e00\u822c\u4f7f\u7528maven\u3001gradle\u8fdb\u884c\u6253\u5305\u3002</p> <p>\u6784\u5efa\u5de5\u5177\u5f88\u591a\u5f88\u591a\uff0c\u4f46\u662f\u96c6\u6210\u5230gitlab\u4e2d\u662f\u4e00\u6837\u7684\u3002\u6240\u4ee5\u8fd9\u91cc\u7b80\u5355\u4ecb\u7ecd\u4f7f\u7528gitlabCI\u96c6\u6210npm/maven\u5b8c\u6210\u524d\u540e\u7aef\u9879\u76ee\u7684\u6784\u5efa\u3002</p> <p>\u8f6f\u4ef6\u5305\u4e0b\u8f7d</p> <ul> <li>maven\u8f6f\u4ef6\u5305\u4e0b\u8f7d</li> <li>gradle\u8f6f\u4ef6\u5305\u4e0b\u8f7d</li> <li>ant\u8f6f\u4f4f\u5305\u4e0b\u8f7d</li> <li>node\u8f6f\u4ef6\u5305\u4e0b\u8f7d</li> </ul>"},{"location":"chap4/1git_template/#_3","title":"\u73af\u5883\u914d\u7f6e","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u5728runner\u673a\u5668\u4e2d\u5b89\u88c5\u914d\u7f6e\u597dapache-maven\u3002</p> <pre><code>#\u89e3\u538b\ntar zxf apache-maven-xxxx.tar.qz -C /usr/local\ntar zxf gradle-xxxx.tar.gz -C /usr/local\ntar zxf node-xxxxx.tar.gz -C /usr/local\ntar zxf apache-ant-xxxx.tar.gz -C /usr/local\n\n#\u6dfb\u52a0\u73af\u5883\u53d8\u91cf\nvim /etc/profile\n\nexport MAVEN_HOME=/usr/local/apache-maven-3.6.0\nexport ANT_HOME=/usr/local/apache-ant-1.10.5\nexport GRADLE_HOME=/usr/local/gradle-5.3\nexport NODE_HOME=/usr/local/node-v10.15.3-linux-x64\nexport JAVA_HOME=/usr/local/jdk1.8.0_201\nexport PATH=$PATH:$MAVEN_HOME/bin:$ANT_HOME/bin:$GRADLE_HOME/bin:$NODE_HOME/bin\nexport PATH=$PATH:$JAVA_HOME/bin\n\n\uff03 \u751f\u6548\u5168\u5c40\u73af\u5883\u53d8\u91cf\nsource /etc/profile\n</code></pre> <pre><code>mvn -v\nApache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)\nMaven home: /usr/local/buildtools/apache-maven-3.6.3\n...\n</code></pre>"},{"location":"chap4/1git_template/#maven","title":"Maven\u96c6\u6210","text":"<ul> <li>\u73af\u5883\u57fa\u7840\u914d\u7f6e</li> <li>\u521b\u5efabuild\u4f5c\u4e1a\u6a21\u677f</li> </ul> <p>https://github.com/zeyangli/gitlabci-templates</p> <ul> <li>jobs  : \u4f5c\u4e1a\u6a21\u677f\u76ee\u5f55</li> <li>template : \u6d41\u6c34\u7ebf\u6a21\u677f\u76ee\u5f55</li> </ul> <pre><code>jobs/\n--- build.yml\n--- codeanalysis.yml\n--- test.yml\n</code></pre> <pre><code>templates/\n--- java-pipeline.yml\n--- k8s-java-pipeline.yml\nweb-pipeline.yml\n</code></pre> <p>\u4f7f\u7528\u65b9\u6cd5</p> <ul> <li>\u6807\u51c6\u6a21\u677f\uff1a \u7cfb\u7edf\u8bbe\u7f6e -&gt; CICD -&gt; General pipelines -&gt; Custom CI configuration path</li> <li>\u4e2a\u6027\u5316\uff1a \u4f7f\u7528include\u5f15\u5165\u6a21\u677f\u6587\u4ef6\uff0c\u8fdb\u884c\u81ea\u5b9a\u4e49\u53c2\u6570\u63a7\u5236\u3002</li> </ul> <p><code>gitlabci-templates/jobs/build.yml</code></p> <p>\u6211\u4eec\u9996\u5148\u5728jobs\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a<code>build.yml</code>\uff0c\u7136\u540e\u5728\u91cc\u9762\u7f16\u5199<code>build</code>\u4f5c\u4e1a\u6a21\u677f\u3002</p> <pre><code>.build:\n  stage: build\n  tags:\n    - build\n  script: \n    - $BUILD_SHELL\n    - ls\n</code></pre> <p><code>gitlabci-templates/jobs/test.yml</code></p> <p>\u6211\u4eec\u8ba1\u5212\u5c06\u6d4b\u8bd5\u76f8\u5173\u7684job\u90fd\u5b9a\u4e49\u5728jobs/test.yml\u4e2d\uff0c\u6211\u4eec\u5f00\u59cb\u521b\u5efa\u5e76\u7f16\u5199test\u4f5c\u4e1a\u3002\u8fd0\u884c\u6d4b\u8bd5shel\u5e76\u6536\u96c6\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\u3002</p> <pre><code>#\u5355\u5143\u6d4b\u8bd5\n.test:\n  stage: test\n  tags:\n    - build\n  script:\n    - $TEST_SHELL\n    - ls \n  artifacts:\n    reports:\n      junit: ${JUNIT_REPORT_PATH}\n</code></pre>"},{"location":"chap4/1git_template/#gitlabci-cidevops-java-service","title":"<code>gitlabci-cidevops-java-service</code>","text":"<p><code>demo-gitlabci-service/templates/java-pipeline.yml</code></p> <pre><code>include:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n\nvariables:\n  BUILD_SHELL: 'mvn clean package  -DskipTests'  ##\u6784\u5efa\u547d\u4ee4\n  CACHE_DIR: 'target/'\n  TEST_SHELL : 'mvn test'                                   ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n  # \u4ee3\u7801\u626b\u63cf\n  SCANNER_HOME : \"/usr/local/buildtools/sonar-scanner-3.2.0.1227-linux\"\n  SCAN_DIR : \"src\"\n  ARTIFACT_PATH : 'target/*.jar'                            ##\u5236\u54c1\u76ee\u5f55\n\n  #\u4e0a\u4f20\u5236\u54c1\u5e93\n  ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"\n  ARTIFACTORY_NAME: \"cidevops\"\n  TARGET_FILE_PATH: \"$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  TARGET_ARTIFACT_NAME: \"$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID.jar\"\n\n  #\u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\n  CI_REGISTRY_USER: '610556220zy'\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'\n  IMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  DOCKER_FILE_PATH: \"./Dockerfile\"\n\n\n\ncache:\n  paths:\n    - ${CACHE_DIR}\n\nstages:\n  - build\n  - test\n  - parallel01\n  - down_artifact\n\n\nbuild:\n  stage: build\n  extends: .build\n  rules:\n    - when: on_success\n\n\ntest:\n  stage: test\n  extends: .test\n  rules:\n    - when: on_success\n\n\ncode_analysis:\n  stage: parallel01\n  extends: .codeanalysis-java\n\ncodeanalysis_mr:\n  stage: parallel01\n  extends: .codeanalysis-mr\n\ndeploy_artifact:\n  stage: parallel01\n  extends: .deploy-artifact\n\ndown_artifact:  \n  stage: down_artifact\n  extends: .down-artifact\n\n\nbuild_image:\n  stage: parallel01\n  extends: .build-docker\n</code></pre> <p>https://github.com/zeyangli/gitlabci-cidevops-java-service</p> <p><code>gitlabci-cidevops-java-service/.gitlab-ci.yml</code></p> <pre><code>include:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n     #  file: 'templates/k8s-java-pipeline.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/test.yml'\n\n\nvariables:\n  BUILD_SHELL: 'mvn clean package  -DskipTests'  \n  CACHE_DIR: 'target/'\n  TEST_SHELL: 'mvn test'     ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'  #\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\ncache:\n    paths:\n        - ${CACHE_DIR}\nstages:\n    - build\n    - test\n\nbuild:\n  stage: build\n  extends: .build\n\nbuild:\n  stage: test\n  extends: .test\n</code></pre> <p></p> <p></p> <p></p>"},{"location":"chap4/1git_template/#yaml","title":"\u89e3\u51b3\u8fdc\u7a0b\u4f7f\u7528YAML\u7684\u95ee\u9898","text":"<p>\u5c06 Template \u7684 \u88ab\u5f15\u7528\u7684Repo \u6539\u4e3a Public</p> <p></p> <p>Building Processed </p> <p></p>"},{"location":"chap4/1git_template/#npm","title":"NPM \u6784\u5efa\u5de5\u5177\u96c6\u6210","text":""},{"location":"chap4/1git_template/#_4","title":"\u73af\u5883\u57fa\u7840\u914d\u7f6e","text":"<p>\u786e\u4fddNode\u5df2\u7ecf\u5b89\u88c5\u597d</p> <pre><code>npm -v\n6.13 4\n</code></pre>"},{"location":"chap4/1git_template/#_5","title":"\u6269\u5c55\u6a21\u677f\u5e93\u524d\u7aef\u4ee3\u7801","text":"<p><code>demo-gitlabci-service/templates/</code></p> <p><code>demo-gitlabci-service/templates/web-pipeline.yml</code></p> <pre><code>include:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n\nvariables:\n  BUILD_SHELL: 'npm run build'     ##\u6784\u5efa\u547d\u4ee4                                   \n  CACHE_DIR  : \"dist/\"             ##\u6784\u5efa\u7f13\u5b58\n\n\ncache:\n  paths:\n    - ${CACHE_DIR}\n    - node_modules/\n\nstages:\n  - install\n  - build\n\ninstall:\n  stage: install\n  script:\n    - 'npm install'\n\nbuild:\n  stage: build\n  extends: .build\n</code></pre>"},{"location":"chap4/1git_template/#pipeline","title":"\u8fd0\u884cPipeline","text":"<p>gitlabci-cidevops-npm-service</p> <pre><code>http://127.0.0.1: 32220/cidevops/cidevops-gitlabci-service/-/raw/master/templates/web-pipeline.yml\n</code></pre> <p></p>"},{"location":"chap4/2git_sonar_pr/","title":"2 Gitlab \u5de5\u5177\u94fe\u96c6\u6210-\u4ee3\u7801\u8d28\u91cf\u5e73\u53f0\u96c6\u6210","text":""},{"location":"chap4/2git_sonar_pr/#1-sonarqube","title":"1 \u96c6\u6210 SonarQube \u4ee3\u7801\u626b\u63cf","text":"<ul> <li>\u5b89\u88c5sonarscanner</li> <li>\u521b\u5efacodeanalysis.yml</li> <li>\u5b8c\u5584\u6d41\u6c34\u7ebf\u6a21\u677f</li> <li>\u8fd0\u884c\u6d4b\u8bd5</li> </ul>"},{"location":"chap4/2git_sonar_pr/#sonar-scanner","title":"sonar scanner","text":"<p>\u786e\u4fddSonarQube\u5728Runner\u5df2\u7ecf\u5b89\u88c5\u6210\u529f</p> <p><code>sonar-scanner-3.2.0.1227-linux</code></p> <pre><code>#\u6dfb\u52a0\u73af\u5883\u53d8\u91cf\nvim /etc/profile\n\n...\nexport SONAR_HOME=/usr/local/buildtools/sonar-scanner-3.2.0.1227-linux/\n...\n\n\uff03 \u751f\u6548\u5168\u5c40\u73af\u5883\u53d8\u91cf\nsource /etc/profile\n</code></pre> <p>Check sonar-scanner \u5b89\u88c5\u6210\u529f</p> <pre><code># sonar-scanner\nINFO: Scanner configuration file: /usr/local/buildtools/sonar-:\nnf/sonar-scanner.properties\nINFO: Project root configuration file: NONE\nINFO: SonarQube Scanner 3.2.0.1227\nINFO: Java 1.8.0_121 Oracle Corporation (64-bit)\nINFO: Linux 4.18.0-80.e18.x86_64 amd64\nINFO: User cache: /root/.sonar/cache\nINFO: SonarQube server 7.9.2   ***\nINFO: Default locale:\n\"en_US\", source code encoding:\n\"US-ASCII\" (analysis is platform dependent)\nNARN: SonarScanner will require Java 11 to run starting in SonarQube 8.x\nINFO: Load global settings\nINFO: Load global settings (done) I time=47ms\nINFO: Server id: BF41A1F2-AW9CCsOxWpKYgNGe87wL\nINFO: User cache: /root/.sonar/cache    ***\nINFO: Load/download plugins\nINFO: Load plugins index\nINFO: Load plugins index (done) I time=32ms\n</code></pre> <ul> <li>\u53c2\u8003\u94fe\u63a5: https://docs.sonarqube.org/latest/analysis/gitlab-cicd/</li> <li>\u6269\u5c55\u63d2\u4ef6\uff08sonarqube multiple branch\uff09\uff1a https://github.com/mc1arke/sonarqube-community-branch-plugin/releases</li> </ul>"},{"location":"chap4/2git_sonar_pr/#codeanalysisyml","title":"\u521b\u5efacodeanalysis.yml","text":"<ul> <li>jobs  : \u4f5c\u4e1a\u6a21\u677f\u76ee\u5f55</li> <li>template : \u6d41\u6c34\u7ebf\u6a21\u677f\u76ee\u5f55</li> </ul> <pre><code>jobs/\n--- build.yml\n--- codeanalysis.yml\n--- test.yml\n</code></pre> <pre><code>templates/\n--- java-pipeline.yml\n--- k8s-java-pipeline.yml\nweb-pipeline.yml\n</code></pre> <p><code>jobs/codeanalysis.yml</code></p> <pre><code>.codeanalysis-java:\n  stage: code_analysis\n  tags:\n    - build\n  script:\n    - echo $CI_MERGE_REQUEST_IID $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME\n    - \"$SCANNER_HOME/bin/sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectName=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \\\n                                      -Dsonar.ws.timeout=30 \\\n                                      -Dsonar.projectDescription=${CI_PROJECT_TITLE} \\\n                                      -Dsonar.links.homepage=${CI_PROJECT_URL} \\\n                                      -Dsonar.sources=${SCAN_DIR} \\\n                                      -Dsonar.sourceEncoding=UTF-8 \\\n                                      -Dsonar.java.binaries=target/classes \\\n                                      -Dsonar.java.test.binaries=target/test-classes \\\n                                      -Dsonar.java.surefire.report=target/surefire-reports \\\n                                      -Dsonar.branch.name=${CI_COMMIT_REF_NAME}\"\n  artifacts:\n    paths:\n      - \"$ARTIFACT_PATH\"\n</code></pre> <p>\u51c6\u5907\u5de5\u4f5c</p> <p>\u5728 SonarQube \u9879\u76ee\u7ec4\u6dfb\u52a0\u7528\u6237\uff0c\u4e3a\u7528\u6237\u5206\u914d\u6743\u9650\u3002\u4f7f\u7528\u7528\u6237token\u5206\u6790\u626b\u63cf\u9879\u76ee</p> <pre><code>cd sonar\ncd extensions/plugins/\n...\nsonarqube-community-branch-plugin-1.2.0. jar\n...\n</code></pre> <p>\u626b\u63cf\u53c2\u6570\u589e\u52a0  <code>-Dsonar.branch.name=</code></p> <p>Sonar \u5b9e\u73b0\u6548\u679c</p> <p></p> <p><code>templates/java-pipeline.yml</code></p> <pre><code>include:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n\nvariables:\n  BUILD_SHELL: 'mvn clean package  -DskipTests'  ##\u6784\u5efa\u547d\u4ee4\n  CACHE_DIR: 'target/'\n  TEST_SHELL : 'mvn test'                                   ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n  # \u4ee3\u7801\u626b\u63cf\n  SCANNER_HOME : \"/usr/local/buildtools/sonar-scanner-3.2.0.1227-linux\"\n  SCAN_DIR : \"src\"\n  ARTIFACT_PATH : 'target/*.jar'      \n\ncache:\n  paths:\n    - ${CACHE_DIR}\n\nstages:\n  - build\n  - test\n  - parallel01\n\nbuild:\n  stage: build\n  extends: .build\n  rules:\n    - when: on_success\n\ntest:\n  stage: test\n  extends: .test\n  rules:\n    - when: on_success\n\ncode_analysis:\n  stage: parallel01\n  extends: .codeanalysis-java\n</code></pre> <p>\u8bbe\u7f6eGitlab runner sonarQube\u767b\u5f55\u5bc6\u7801</p> <pre><code>sonar-scanner-3.2.0.1227-linux?# cd conf/\nconf# ls\nsonar-scanner.properties\n\nconf# vim sonar-scanner.properties\n\n\uff03- - - Default SonarQube server\nsonar.host.url=http://192.168.1.200:32220\nsonar.login=eezbcb37deeb6dfe3a07fe08fb529559b00c1b7b\n</code></pre> <p>\u6216\u8005\u5728setting\u91cc\u9762\u914d\u7f6e\u5bc6\u7801</p> <p></p> <p></p>"},{"location":"chap4/2git_sonar_pr/#2-gitlab-pull","title":"2 Gitlab Pull \u8bf7\u6c42\u96c6\u6210\u914d\u7f6e","text":"<p>\u7ed3\u679c Merge Request \u751f\u6210 code review \u62a5\u544a</p> <p></p> <p></p>"},{"location":"chap4/2git_sonar_pr/#sonarqube-gitlab-provider","title":"Sonarqube \u6dfb\u52a0 gitlab provider","text":"<p>\u914d\u7f6e SonarQube, \u6dfb\u52a0gitlabtoken \u548c\u670d\u52a1\u4fe1\u606f -&gt; pull request</p> <pre><code>com.github.mclarke.sonarqube.plugin.branch.pullrequest.gitlab.token=b&amp;Gs1quX5GSeHwyuMWyY\ncom.github.mclarke.sonarqube.plugin.branch.pullrequest.gitlab.url=http://192.168.1.200:32220\nsonar.pullrequest.provider=GitlabServer\n</code></pre> <p></p> <p>\u5982\u679c\u4f60\u60f3\u901a\u8fc7AP\u64cd\u4f5c\u53ef\u4ee5\u53c2\u8003\uff1a</p> <pre><code>curl -u  \"$ SONAR_API_TOKEN \" -X POST \"http://sonarqube.example.com/api/settings/set?key=sonar.pullrequest.provider&amp;value=GitlabServer\"\n\ncurl -u  \"$ SONAR_API_TOKEN \" -X POST \" http://sonarqube.example.com/api/settings/set?key=com.github.mc1arke.sonarqube.plugin.branch.pullrequest.gitlab.url&amp;value=http://gitlab.example.com\"\n\ncurl -u \" $ SONAR_API_TOKEN \" -X POST \" http: //sonarqube.example.com/api/settings/set?key=com.github.mc1arke.sonarqube.plugin.branch.pullrequest.gitlab.token&amp;value=GITLAB_TOKEN\"\n</code></pre> <p>\u6dfb\u52a0\u626b\u63cf\u5206\u6790\u53c2\u6570</p> <p><code>jobs/codeanalysis.yml</code></p> <pre><code>.codeanalysis-java:\n  stage: code_analysis\n  tags:\n    - build\n  script:\n    - echo $CI_MERGE_REQUEST_IID $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME\n    - \"$SCANNER_HOME/bin/sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectName=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \\\n                                      -Dsonar.ws.timeout=30 \\\n                                      -Dsonar.projectDescription=${CI_PROJECT_TITLE} \\\n                                      -Dsonar.links.homepage=${CI_PROJECT_URL} \\\n                                      -Dsonar.sources=${SCAN_DIR} \\\n                                      -Dsonar.sourceEncoding=UTF-8 \\\n                                      -Dsonar.java.binaries=target/classes \\\n                                      -Dsonar.java.test.binaries=target/test-classes \\\n                                      -Dsonar.java.surefire.report=target/surefire-reports \\\n                                      -Dsonar.branch.name=${CI_COMMIT_REF_NAME}\"\n  artifacts:\n    paths:\n      - \"$ARTIFACT_PATH\"\n\n\n.codeanalysis-mr:\n  stage: code_analysis\n  only:\n    - merge_requests\n  tags:\n    - build\n  script:\n    - echo $GIT_DEPTH\n    - echo $CI_MERGE_REQUEST_IID $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME\n    - echo \"$SCANNER_HOME/bin/sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectName=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \\\n                                      -Dsonar.ws.timeout=30 \\\n                                      -Dsonar.projectDescription=${CI_PROJECT_TITLE} \\\n                                      -Dsonar.links.homepage=${CI_PROJECT_URL} \\\n                                      -Dsonar.sources=${SCAN_DIR} \\\n                                      -Dsonar.sourceEncoding=UTF-8 \\\n                                      -Dsonar.java.binaries=target/classes \\\n                                      -Dsonar.java.test.binaries=target/test-classes \\\n                                      -Dsonar.java.surefire.report=target/surefire-reports \\\n                                      -Dsonar.pullrequest.key=${CI_MERGE_REQUEST_IID} \\\n                                      -Dsonar.pullrequest.branch=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} \\\n                                      -Dsonar.pullrequest.base=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME} \"\n    - \"$SCANNER_HOME/bin/sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectName=${CI_PROJECT_NAME} \\\n                                      -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \\\n                                      -Dsonar.ws.timeout=30 \\\n                                      -Dsonar.projectDescription=${CI_PROJECT_TITLE} \\\n                                      -Dsonar.links.homepage=${CI_PROJECT_URL} \\\n                                      -Dsonar.sources=${SCAN_DIR} \\\n                                      -Dsonar.sourceEncoding=UTF-8 \\\n                                      -Dsonar.java.binaries=target/classes \\\n                                      -Dsonar.java.test.binaries=target/test-classes \\\n                                      -Dsonar.java.surefire.report=target/surefire-reports \\\n                                      -Dsonar.pullrequest.key=${CI_MERGE_REQUEST_IID} \\\n                                      -Dsonar.pullrequest.branch=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} \\\n                                      -Dsonar.pullrequest.base=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}  \\\n                                      -Dsonar.gitlab.ref_name=${CI_COMMIT_REF_NAME} \\\n                                      -Dsonar.gitlab.commit_sha=${CI_COMMIT_SHA}  \\\n                                      -Dsonar.gitlab.project_id=${CI_PROJECT_PATH} \\\n                                      -Dsonar.pullrequest.gitlab.repositorySlug=$CI_PROJECT_ID \"\n\n                                      #-Dsonar.branch.name=${CI_COMMIT_REF_NAME} -X \"\n</code></pre> <p><code>templates/java-pipeline.yml</code></p> <pre><code>....\ncodeanalysis_mr:\n  stage: parallel01\n  extends: .codeanalysis-mr\n</code></pre> <p></p> <p></p>"},{"location":"chap4/3gitlab_artifact_docker/","title":"3 \u5de5\u5177\u94fe\u96c6\u6210-\u5236\u54c1\u5e93\u96c6\u6210","text":"<ul> <li>Artifactory\u4ed3\u5e93\u96c6\u6210</li> <li>\u4e91\u955c\u50cf\u4ed3\u5e93\u96c6\u6210</li> </ul>"},{"location":"chap4/3gitlab_artifact_docker/#artifactory","title":"Artifactory\u4ed3\u5e93\u96c6\u6210","text":"<p>Create JFrog Artifactory </p> <p></p> <p>Create one repo  <code>cidevops</code></p> <p></p> <p>Upload &amp; Download</p> <p></p>"},{"location":"chap4/3gitlab_artifact_docker/#artifactory-gitlabci-templatesjobsbuildyml","title":"artifactory: <code>gitlabci-templates/jobs/build.yml</code>","text":"<pre><code>.build:\n  stage: build\n  tags:\n    - build\n  script: \n    - $BUILD_SHELL\n    - ls\n\n\n\n.deploy-artifact:\n  stage: deploy-artifact\n  tags:\n    - build\n  script:\n    - curl -u${ARTIFACT_USER}:${ARTIFACT_PASSWD} -T ${ARTIFACT_PATH} \"$ARTIFACTORY_URL/$ARTIFACTORY_NAME/$TARGET_FILE_PATH/$TARGET_ARTIFACT_NAME\"\n\n\n\n.down-artifact:\n  stage: down-artifact\n  tags:\n    - build\n  script:\n    - curl -u${ARTIFACT_USER}:${ARTIFACT_PASSWD} -O \"$ARTIFACTORY_URL/$ARTIFACTORY_NAME/$TARGET_FILE_PATH/$TARGET_ARTIFACT_NAME\"\n    - ls\n\n.build-docker:\n  stage: buildimage\n  tags:\n    - build\n  script:\n    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWD  $CI_REGISTRY\n    - docker build -t ${IMAGE_NAME} -f ${DOCKER_FILE_PATH} .\n    - docker push ${IMAGE_NAME} \n    - docker rmi ${IMAGE_NAME} \n</code></pre>"},{"location":"chap4/3gitlab_artifact_docker/#cidevops-java-servicetemplatesjava-pipelineyml","title":"<code>cidevops-java-service/templates/java-pipeline.yml</code>","text":"<pre><code>include:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n\nvariables:\n  BUILD_SHELL: 'mvn clean package  -DskipTests'  ##\u6784\u5efa\u547d\u4ee4\n  CACHE_DIR: 'target/'\n  TEST_SHELL : 'mvn test'                                   ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n  # \u4ee3\u7801\u626b\u63cf\n  SCANNER_HOME : \"/usr/local/buildtools/sonar-scanner-3.2.0.1227-linux\"\n  SCAN_DIR : \"src\"\n  ARTIFACT_PATH : 'target/*.jar'                            ##\u5236\u54c1\u76ee\u5f55\n\n  #\u4e0a\u4f20\u5236\u54c1\u5e93\n  ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"\n  ARTIFACTORY_NAME: \"cidevops\"\n  TARGET_FILE_PATH: \"$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  TARGET_ARTIFACT_NAME: \"$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID.jar\"\n\n\ncache:\n  paths:\n    - ${CACHE_DIR}\n\nstages:\n  - build\n  - test\n  - parallel01\n  - down_artifact\n\n\nbuild:\n  stage: build\n  extends: .build\n  rules:\n    - when: on_success\n\n\ntest:\n  stage: test\n  extends: .test\n  rules:\n    - when: on_success\n\n\ncode_analysis:\n  stage: parallel01\n  extends: .codeanalysis-java\n\ncodeanalysis_mr:\n  stage: parallel01\n  extends: .codeanalysis-mr\n\ndeploy_artifact:\n  stage: parallel01\n  extends: .deploy-artifact\n\ndown_artifact:  \n  stage: down_artifact\n  extends: .down-artifact\n</code></pre> <p><code>cidevops-java-service</code>: Gitlab add jfrog <code>ARTIFACT_USER</code> and <code>ARTIFACT_PASSWD</code></p> <p></p> <p></p> <p></p> <p></p> <ul> <li>\u4e0a\u4f20\u5236\u54c1</li> </ul> <pre><code>.deploy-artifact:\n  stage: deploy-artifact\n  tags:\n    - build\n  script:\n    - curl -u${ARTIFACT_USER}:${ARTIFACT_PASSWD} -T ${ARTIFACT_PATH} \"$ARTIFACTORY_URL/$ARTIFACTORY_NAME/$TARGET_FILE_PATH/$TARGET_ARTIFACT_NAME\"\n</code></pre> <ul> <li>\u4e0b\u8f7d\u5236\u54c1</li> </ul> <pre><code>.down-artifact:\n  stage: down-artifact\n  tags:\n    - build\n  script:\n    - curl -u${ARTIFACT_USER}:${ARTIFACT_PASSWD} -O \"$ARTIFACTORY_URL/$ARTIFACTORY_NAME/$TARGET_FILE_PATH/$TARGET_ARTIFACT_NAME\"\n    - ls\n</code></pre> <p></p>"},{"location":"chap4/3gitlab_artifact_docker/#docker","title":"Docker\u955c\u50cf\u4ed3\u5e93\u96c6\u6210","text":"<p>https://cr.console.aliyun.com/cn-beijing/instances/repositories</p> <p></p> <p><code>cidevops-java-service</code>: Gitlab add jfrog <code>GIT_REGISTRY_PASSWD</code> </p> <p></p>"},{"location":"chap4/3gitlab_artifact_docker/#cidevops-java-servicetemplatesjava-pipelineyml_1","title":"<code>cidevops-java-service/templates/java-pipeline.yml</code>","text":"<pre><code>...\n\n#\u6784\u5efa\u955c\u50cf\nCI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\nCI_REGISTRY_USER: '610556220zy'\n#CI_REGISTRY_PASSWD: 'xxxxxxxx.'\nIMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\nDOCKER_FILE_PATH: \"./Dockerfile\"\n...\nbuild_image:\n  stage: parallel01\n  extends: .build-docker\n</code></pre> <p><code>cidevops-java-service/Dockerfile</code></p> <pre><code>FROM  openjdk:8-alpine\nMAINTAINER devops\n\nADD target/*.jar /app.jar\n\n# \u6267\u884c\u547d\u4ee4\nENTRYPOINT [\"java\",\"-jar\",\"/app.jar\"]\n</code></pre> <p></p> <p></p>"},{"location":"chap4/4gitlab_jemeter/","title":"4 Gitlab \u81ea\u52a8\u5316\u6d4b\u8bd5\u96c6\u6210","text":""},{"location":"chap4/4gitlab_jemeter/#1-ci-","title":"1 CI\u5de5\u5177\u94fe\u96c6\u6210-\u81ea\u52a8\u5316\u6d4b\u8bd5","text":"<ul> <li>Jmeter\u63a5\u53e3\u6d4b\u8bd5\u7b80\u4ecb</li> <li>GitlabCI\u96c6\u6210\u81ea\u52a8\u5316\u6d4b\u8bd5</li> </ul> <p>\u63a5\u53e3\u6d4b\u8bd5\u7b80\u4ecb</p> <ul> <li>jmeter\u8fd0\u884c\u63a5\u53e3\u6d4b\u8bd5</li> <li>ant + jmetert\u6279\u91cf\u63a5\u53e3\u6d4b\u8bd5</li> <li>\u96c6\u6210CI\u81ea\u52a8\u5316\u6d4b\u8bd5</li> <li>\u5c55\u793a\u6d4b\u8bd5\u62a5\u544a</li> </ul>"},{"location":"chap4/4gitlab_jemeter/#_1","title":"\u63a5\u53e3\u6d4b\u8bd5","text":"<p>\u63a5\u53e3</p> <ul> <li>\u63a5\u53e3\u6d4b\u8bd5\u5b9a\u4e49\u4e3a\u4e00\u79cd\u8f6f\u4ef6\u6d4b\u8bd5\u7c7b\u578b\uff0c\u7528\u4e8e\u9a8c\u8bc1\u4e24\u4e2a\u4e0d\u540c\u8f6f\u4ef6\u7cfb\u7edf\u4e4b\u95ee\u7684\u901a\u4fe1\u662f\u5426\u6b63\u786e\u5b8c\u6210</li> <li>\u96c6\u6210\u4e24\u4e2a\u7ec4\u4ef6\u7684\u8fde\u63a5\u79f0\u4e3a\u63a5\u53e3\u3002\u8ba1\u7b97\u673a\u4e16\u754c\u4e2d\u7684\u6b64\u63a5\u53e3\u53ef\u4ee5\u662fAPI\uff0cWeb\u670d\u52a1\u7b49\u4e4b\u7c7b\u7684\u4e1c\u897f\u3002\u8fd9\u4e9b\u8fde\u63a5\u670d\u52a1\u6216\u63a5\u53e3\u7684\u6d4b\u8bd5\u79f0\u4e3a\u63a5\u53e3\u6d4b\u8bd5</li> <li>\u63a5\u53e3\u5b9e\u9645\u4e0a\u662f\u7531\u4e00\u7ec4\u547d\u4ee4\uff0c\u6d88\u606f\u548c\u5176\u4ed6\u5141\u8bb8\u8bbe\u5907\u4e0e\u7528\u6237\u4e4b\u95ee\u8fdb\u884c\u901a\u4fe1\u7684\u5c5e\u6027\u7ec4\u6210\u7684\u8f6f\u4ef6\u3002</li> </ul>"},{"location":"chap4/4gitlab_jemeter/#jmeter","title":"jmeter","text":"<ul> <li>wget</li> <li>tar zxf</li> <li>export</li> <li>source</li> </ul>"},{"location":"chap4/4gitlab_jemeter/#jmeter_1","title":"Jmeter\u63a5\u53e3\u6d4b\u8bd5","text":"<pre><code># jmeter\n=============================================\nDon't use GUI mode for load testing !, only for Test creation and Test debugging.\nFor load testing, use CLI Mode (was NON GUI):\njmeter -n -t Ljmx file] -1 [results file] -e -o [Path to web report folder]\n&amp; increase Java Heap to meet your test requirements:\nModify current env variable HEAP=\"-Xms1g\n-Xmx1g -XX:MaxMetaspaceSize=256m\" in the jmeter batch file\nCheck: https://jmeter.apache.org/usermanual/best-practices.html\n=============================================\n</code></pre> <p>GUI\u6a21\u5f0f\u8fd0\u884c\u6d4b\u8bd5\u7528\u4f8b</p> <p></p> <p>\u975eGUI\u6a21\u5f0f\u8fd0\u884c\u6d4b\u8bd5\u7528\u4f8b</p> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li><code>-n</code>\uff1a\u975eGUI\u6a21\u5f0f\u6267\u884cJMeter</li> <li><code>-t</code>\uff1a\u6267\u884c\u6d4b\u8bd5\u6587\u4ef6\u6240\u5728\u7684\u4f4d\u7f6e</li> <li><code>-l</code>: \u6307\u5b9a\u751f\u6210\u6d4b\u8bd5\u7ed3\u679c\u7684\u4fdd\u5b58\u6587\u4ef6\uff0cjtl\u6587\u4ef6\u683c\u5f0f</li> <li><code>-e</code>\uff1a\u6d4b\u8bd5\u7ed3\u675f\u540e\uff0c\u751f\u6210\u6d4b\u8bd5\u62a5\u544a</li> <li><code>-o</code>\uff1a\u6307\u5b9a\u6d4b\u8bd5\u62a5\u544a\u7684\u5b58\u653e\u4f4d\u7f6e</li> </ul> <pre><code>Error in NonGUIDriver\njava. lang. IllegalArgumentException:\nReport generation requires csv output\nformat, check\n`jmeter. save. saveservice. output.format` property\n</code></pre> <pre><code>jmeter -n -t scripts/blog.jmx -l report.jtl -e -o report -J jmeter.save.saveservice.output_format=csv\n</code></pre> <p>Example gitlabci-cidevops-interfacetest-service</p> <pre><code>$ tree gitlabci-cidevops-interfacetest-service\ngitlabci-cidevops-interfacetest-service\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 build.xml\n\u251c\u2500\u2500 jmeter-results-detail-report_21.xsl\n\u251c\u2500\u2500 jmeter.results.shanhe.me.xsl\n\u251c\u2500\u2500 result\n\u2514\u2500\u2500 scripts\n    \u2514\u2500\u2500 testbaidu.jmx\n\n2 directories, 5 files\n</code></pre> <pre><code> jmeter -n -t testbaidu. jmx -l report.jtl -e -o report -Jjmeter.save.saveservice.output_format=csv\n\nCreating summariser &lt;summary&gt;\nCreated the tree successfully using testbaidu.jmx\nStarting the test @ Sat May 09 15:08:34 CST 2020 (1589008114686)\nWaiting for possible Shutdown/StopTestNow/HeapDump/ThreadDumpmessage on port 4445\n\nStarted: 2 Finished: 0\n\nStarted: 2 Finished: 2\nTidying up... @ Sat May 09 15:08:35 CST 2020 (1589008115639)\n... end of run\n</code></pre>"},{"location":"chap4/4gitlab_jemeter/#2-ant-jmeter","title":"2 Ant + Jmeter\u81ea\u52a8\u5316\u6d4b\u8bd5","text":"<p><code>Build. xmI</code>\u89e3\u6790</p> <pre><code>&lt;?xml version=\"1.0\" encoding=\"utf8\"?&gt;\n&lt;!-- \u62f7\u8d1d\u62a5\u544a\u6240\u9700\u7684\u56fe\u7247\u8d44\u6e90\u81f3\u76ee\u6807\u76ee\u5f55 --&gt;\n&lt;project name=\"ant-jmeter-test\" default=\"run\" basedir=\".\"&gt;\n    &lt;tstamp&gt;\n        &lt;format property=\"time\" pattern=\"yyyyMMddHHmm\" /&gt;\n    &lt;/tstamp&gt;\n    &lt;!-- \u9700\u8981\u6539\u6210\u81ea\u5df1\u672c\u5730\u7684jmeter\u76ee\u5f55--&gt;  \n    &lt;property name=\"jmeter.home\" value=\"/usr/local/apache-jmeter-5.1.1\" /&gt;\n    &lt;!-- jmeter\u751f\u6210\u7684jtl\u683c\u5f0f\u7684\u7ed3\u679c\u62a5\u544a\u7684\u8def\u5f84--&gt; \n    &lt;property name=\"jmeter.result.jtl.dir\" value=\"./result/jtlfile\" /&gt;\n    &lt;!-- jmeter\u751f\u6210\u7684html\u683c\u5f0f\u7684\u7ed3\u679c\u62a5\u544a\u7684\u8def\u5f84--&gt;\n    &lt;property name=\"jmeter.result.html.dir\" value=\"./result/htmlfile\" /&gt;\n    &lt;!-- \u02ba\u751f\u6210\u7684\u62a5\u544a\u7684\u524d\u7f00--&gt;  \n    &lt;property name=\"ReportName\" value=\"TestReport_\" /&gt;\n    &lt;property name=\"jmeter.result.jtlName\" value=\"${jmeter.result.jtl.dir}/${ReportName}${time}.jtl\" /&gt;\n    &lt;property name=\"jmeter.result.htmlName\" value=\"${jmeter.result.html.dir}/SummaryReport.html\" /&gt;\n    &lt;property name=\"jmeter.detail.result.jtlName\" value=\"${jmeter.result.jtl.dir}/${ReportName}${time}.jtl\" /&gt;\n    &lt;property name=\"jmeter.detail.result.htmlName\" value=\"${jmeter.result.html.dir}/DetailReport.html\" /&gt;\n    &lt;target name=\"run\"&gt;\n        &lt;antcall target=\"test\" /&gt;\n        &lt;antcall target=\"report\" /&gt;\n    &lt;/target&gt;\n\n    &lt;target name=\"test\"&gt;\n        &lt;taskdef name=\"jmeter\" classname=\"org.programmerplanet.ant.taskdefs.jmeter.JMeterTask\" /&gt;\n        &lt;jmeter jmeterhome=\"${jmeter.home}\" resultlog=\"${jmeter.result.jtlName}\"&gt;\n             &lt;!-- \u58f0\u660e\u8981\u8fd0\u884c\u7684\u811a\u672c\u201c*.jmx\u201d\u6307\u5305\u542b\u6b64\u76ee\u5f55\u4e0b\u7684\u6240\u6709jmeter\u811a\u672c--&gt;\n            &lt;testplans dir=\"./scripts\" includes=\"*.jmx\" /&gt;\n           &lt;property name=\"jmeter.save.saveservice.output_format\" value=\"xml\"/&gt;\n\n        &lt;/jmeter&gt;\n    &lt;/target&gt;\n    &lt;path id=\"xslt.classpath\"&gt;\n            &lt;fileset dir=\"${jmeter.home}/lib\" includes=\"xalan*.jar\"/&gt;\n            &lt;fileset dir=\"${jmeter.home}/lib\" includes=\"serializer*.jar\"/&gt;\n    &lt;/path&gt;\n\n    &lt;target name=\"report\"&gt;\n        &lt;tstamp&gt; \n                &lt;format property=\"report.datestamp\" pattern=\"yyyy/MM/dd HH:mm\" /&gt;\n        &lt;/tstamp&gt;\n        &lt;xslt \n            classpathref=\"xslt.classpath\"\n            force=\"true\"\n            in=\"${jmeter.detail.result.jtlName}\"\n            out=\"${jmeter.detail.result.htmlName}\"\n            style=\"./jmeter.results.shanhe.me.xsl\"&gt;\n            &lt;param name=\"dateReport\" expression=\"${report.datestamp}\"/&gt;\n        &lt;/xslt&gt;\n        &lt;xslt \n            classpathref=\"xslt.classpath\"\n            force=\"true\"\n            in=\"${jmeter.result.jtlName}\"\n            out=\"${jmeter.result.htmlName}\"\n            style=\"./jmeter-results-detail-report_21.xsl\"&gt;\n            &lt;param name=\"dateReport\" expression=\"${report.datestamp}\"/&gt;\n        &lt;/xslt&gt;\n        &lt;!-- \u62f7\u8d1d\u62a5\u544a\u6240\u9700\u7684\u56fe\u7247\u8d44\u6e90\u81f3\u76ee\u6807\u76ee\u5f55 --&gt; \n        &lt;copy todir=\"${jmeter.result.html.dir}\"&gt;\n            &lt;fileset dir=\"${jmeter.home}/extras\"&gt;\n                &lt;include name=\"collapse.png\" /&gt;\n                &lt;include name=\"expand.png\" /&gt;\n            &lt;/fileset&gt;\n        &lt;/copy&gt;\n    &lt;/target&gt;\n&lt;/project&gt;\n</code></pre> <pre><code>ant -v\n\nApache Ant(M) version 1.9.14 compiled on March 12 2019\n\n\n$ ant-f build.xml\n...\n&lt;h1 id=\"toc_0\"&gt;&lt;strong&gt;4 Gitlab \u81ea\u52a8\u5316\u6d4b\u8bd5\u96c6\u6210&lt;/strong&gt;&lt;/h1&gt;\n\n&lt;h2 id=\"toc_1\"&gt;&lt;strong&gt;1 CI\u5de5\u5177\u94fe\u96c6\u6210-\u81ea\u52a8\u5316\u6d4b\u8bd5&lt;/strong&gt;&lt;/h2&gt;\n\n&lt;ul&gt;\n&lt;li&gt;Jmeter\u63a5\u53e3\u6d4b\u8bd5\u7b80\u4ecb&lt;/li&gt;\n&lt;li&gt;GitlabCI\u96c6\u6210\u81ea\u52a8\u5316\u6d4b\u8bd5&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;blockquote&gt;\n&lt;p&gt;\u63a5\u53e3\u6d4b\u8bd5\u7b80\u4ecb&lt;/p&gt;\n&lt;/blockquote&gt;\n\n&lt;ul&gt;\n&lt;li&gt;jmeter\u8fd0\u884c\u63a5\u53e3\u6d4b\u8bd5&lt;/li&gt;\n&lt;li&gt;ant + jmetert\u6279\u91cf\u63a5\u53e3\u6d4b\u8bd5&lt;/li&gt;\n&lt;li&gt;\u96c6\u6210CI\u81ea\u52a8\u5316\u6d4b\u8bd5&lt;/li&gt;\n&lt;li&gt;\u5c55\u793a\u6d4b\u8bd5\u62a5\u544a&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;h3 id=\"toc_2\"&gt;&lt;strong&gt;\u63a5\u53e3\u6d4b\u8bd5&lt;/strong&gt;&lt;/h3&gt;\n\n&lt;p&gt;&lt;img src=\"../images/chap4_4_1.png\" alt=\"Alt Image Text\" title=\"Body image\"&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;\u63a5\u53e3&lt;/strong&gt;&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;\u63a5\u53e3\u6d4b\u8bd5\u5b9a\u4e49\u4e3a\u4e00\u79cd\u8f6f\u4ef6\u6d4b\u8bd5\u7c7b\u578b\uff0c\u7528\u4e8e\u9a8c\u8bc1\u4e24\u4e2a\u4e0d\u540c\u8f6f\u4ef6\u7cfb\u7edf\u4e4b\u95ee\u7684\u901a\u4fe1\u662f\u5426\u6b63\u786e\u5b8c\u6210&lt;/li&gt;\n&lt;li&gt;\u96c6\u6210\u4e24\u4e2a\u7ec4\u4ef6\u7684\u8fde\u63a5\u79f0\u4e3a\u63a5\u53e3\u3002&lt;strong&gt;\u8ba1\u7b97\u673a\u4e16\u754c\u4e2d\u7684\u6b64\u63a5\u53e3\u53ef\u4ee5\u662fAPI\uff0cWeb\u670d\u52a1\u7b49\u4e4b\u7c7b\u7684\u4e1c\u897f\u3002\u8fd9\u4e9b\u8fde\u63a5\u670d\u52a1\u6216\u63a5\u53e3\u7684\u6d4b\u8bd5\u79f0\u4e3a\u63a5\u53e3\u6d4b\u8bd5&lt;/strong&gt;&lt;/li&gt;\n&lt;li&gt;&lt;strong&gt;\u63a5\u53e3\u5b9e\u9645\u4e0a\u662f\u7531\u4e00\u7ec4\u547d\u4ee4\uff0c\u6d88\u606f\u548c\u5176\u4ed6\u5141\u8bb8\u8bbe\u5907\u4e0e\u7528\u6237\u4e4b\u95ee\u8fdb\u884c\u901a\u4fe1\u7684\u5c5e\u6027\u7ec4\u6210\u7684\u8f6f\u4ef6&lt;/strong&gt;\u3002&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;h3 id=\"toc_3\"&gt;jmeter&lt;/h3&gt;\n\n&lt;ul&gt;\n&lt;li&gt;wget&lt;/li&gt;\n&lt;li&gt;tar zxf&lt;/li&gt;\n&lt;li&gt;export&lt;/li&gt;\n&lt;li&gt;source&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;h3 id=\"toc_4\"&gt;&lt;strong&gt;Jmeter\u63a5\u53e3\u6d4b\u8bd5&lt;/strong&gt;&lt;/h3&gt;\n\n&lt;div&gt;&lt;pre&gt;&lt;code class=\"language-none\"&gt;# jmeter\n=============================================\nDon&amp;#39;t use GUI mode for load testing !, only for Test creation and Test debugging.\nFor load testing, use CLI Mode (was NON GUI):\njmeter -n -t Ljmx file] -1 [results file] -e -o [Path to web report folder]\n&amp;amp; increase Java Heap to meet your test requirements:\nModify current env variable HEAP=&amp;quot;-Xms1g\n-Xmx1g -XX:MaxMetaspaceSize=256m&amp;quot; in the jmeter batch file\nCheck: https://jmeter.apache.org/usermanual/best-practices.html\n=============================================&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;\n\n&lt;p&gt;&lt;img src=\"../images/chap4_4_2.png\" alt=\"Alt Image Text\" title=\"Body image\"&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;img src=\"../images/chap4_4_3.png\" alt=\"Alt Image Text\" title=\"Body image\"&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;img src=\"../images/chap4_4_4.png\" alt=\"Alt Image Text\" title=\"Body image\"&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;GUI\u6a21\u5f0f\u8fd0\u884c\u6d4b\u8bd5\u7528\u4f8b&lt;/strong&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;img src=\"../images/chap4_4_5.png\" alt=\"Alt Image Text\" title=\"Body image\"&gt;&lt;/p&gt;\n\n&lt;p&gt;&lt;strong&gt;\u975eGUI\u6a21\u5f0f\u8fd0\u884c\u6d4b\u8bd5\u7528\u4f8b&lt;/strong&gt;&lt;/p&gt;\n\n&lt;p&gt;\u53c2\u6570\u8bf4\u660e\uff1a&lt;/p&gt;\n\n&lt;ul&gt;\n&lt;li&gt;&lt;code&gt;-n&lt;/code&gt;\uff1a\u975eGUI\u6a21\u5f0f\u6267\u884cJMeter&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;-t&lt;/code&gt;\uff1a\u6267\u884c\u6d4b\u8bd5\u6587\u4ef6\u6240\u5728\u7684\u4f4d\u7f6e&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;-l&lt;/code&gt;: \u6307\u5b9a\u751f\u6210\u6d4b\u8bd5\u7ed3\u679c\u7684\u4fdd\u5b58\u6587\u4ef6\uff0cjtl\u6587\u4ef6\u683c\u5f0f&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;-e&lt;/code&gt;\uff1a\u6d4b\u8bd5\u7ed3\u675f\u540e\uff0c\u751f\u6210\u6d4b\u8bd5\u62a5\u544a&lt;/li&gt;\n&lt;li&gt;&lt;code&gt;-o&lt;/code&gt;\uff1a\u6307\u5b9a\u6d4b\u8bd5\u62a5\u544a\u7684\u5b58\u653e\u4f4d\u7f6e&lt;/li&gt;\n&lt;/ul&gt;\n\n&lt;div&gt;&lt;pre&gt;&lt;code class=\"language-none\"&gt;Error in NonGUIDriver\njava. lang. IllegalArgumentException:\nReport generation requires csv output\nformat, check\n`jmeter. save. saveservice. output.format` property&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;\n\n&lt;div&gt;&lt;pre&gt;&lt;code class=\"language-none\"&gt;jmeter -n -t scripts/blog.jmx -l report.jtl -e -o report -J jmeter.save.saveservice.output_format=csv&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;\n\n&lt;p&gt;&lt;strong&gt;Example&lt;/strong&gt;   &lt;a href=\"https://github.com/zeyangli/gitlabci-cidevops-interfacetest-service\"&gt;gitlabci-cidevops-interfacetest-service&lt;/a&gt;&lt;/p&gt;\n\n&lt;div&gt;&lt;pre&gt;&lt;code class=\"language-none\"&gt;$ tree gitlabci-cidevops-interfacetest-service\ngitlabci-cidevops-interfacetest-service\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 build.xml\n\u251c\u2500\u2500 jmeter-results-detail-report_21.xsl\n\u251c\u2500\u2500 jmeter.results.shanhe.me.xsl\n\u251c\u2500\u2500 result\n\u2514\u2500\u2500 scripts\n    \u2514\u2500\u2500 testbaidu.jmx\n\n2 directories, 5 files&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;\n\n&lt;div&gt;&lt;pre&gt;&lt;code class=\"language-none\"&gt; jmeter -n -t testbaidu. jmx -l report.jtl -e -o report -Jjmeter.save.saveservice.output_format=csv\n\nCreating summariser &amp;lt;summary&amp;gt;\nCreated the tree successfully using testbaidu.jmx\nStarting the test @ Sat May 09 15:08:34 CST 2020 (1589008114686)\nWaiting for possible Shutdown/StopTestNow/HeapDump/ThreadDumpmessage on port 4445\n\nStarted: 2 Finished: 0\n\nStarted: 2 Finished: 2\nTidying up... @ Sat May 09 15:08:35 CST 2020 (1589008115639)\n... end of run&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;\n\n&lt;h2 id=\"toc_5\"&gt;&lt;strong&gt;2 Ant + Jmeter\u81ea\u52a8\u5316\u6d4b\u8bd5&lt;/strong&gt;&lt;/h2&gt;\n\n&lt;p&gt;&lt;strong&gt;&lt;code&gt;Build. xmI&lt;/code&gt;\u89e3\u6790&lt;/strong&gt;&lt;/p&gt;\n\n&lt;div&gt;&lt;pre&gt;&lt;code class=\"language-none\"&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;utf8&amp;quot;?&amp;gt;\n&amp;lt;!-- \u62f7\u8d1d\u62a5\u544a\u6240\u9700\u7684\u56fe\u7247\u8d44\u6e90\u81f3\u76ee\u6807\u76ee\u5f55 --&amp;gt;\n&amp;lt;project name=&amp;quot;ant-jmeter-test&amp;quot; default=&amp;quot;run&amp;quot; basedir=&amp;quot;.&amp;quot;&amp;gt;\n    &amp;lt;tstamp&amp;gt;\n        &amp;lt;format property=&amp;quot;time&amp;quot; pattern=&amp;quot;yyyyMMddHHmm&amp;quot; /&amp;gt;\n    &amp;lt;/tstamp&amp;gt;\n    &amp;lt;!-- \u9700\u8981\u6539\u6210\u81ea\u5df1\u672c\u5730\u7684jmeter\u76ee\u5f55--&amp;gt;  \n    &amp;lt;property name=&amp;quot;jmeter.home&amp;quot; value=&amp;quot;/usr/local/apache-jmeter-5.1.1&amp;quot; /&amp;gt;\n    &amp;lt;!-- jmeter\u751f\u6210\u7684jtl\u683c\u5f0f\u7684\u7ed3\u679c\u62a5\u544a\u7684\u8def\u5f84--&amp;gt; \n    &amp;lt;property name=&amp;quot;jmeter.result.jtl.dir&amp;quot; value=&amp;quot;./result/jtlfile&amp;quot; /&amp;gt;\n    &amp;lt;!-- jmeter\u751f\u6210\u7684html\u683c\u5f0f\u7684\u7ed3\u679c\u62a5\u544a\u7684\u8def\u5f84--&amp;gt;\n    &amp;lt;property name=&amp;quot;jmeter.result.html.dir&amp;quot; value=&amp;quot;./result/htmlfile&amp;quot; /&amp;gt;\n    &amp;lt;!-- \u02ba\u751f\u6210\u7684\u62a5\u544a\u7684\u524d\u7f00--&amp;gt;  \n    &amp;lt;property name=&amp;quot;ReportName&amp;quot; value=&amp;quot;TestReport_&amp;quot; /&amp;gt;\n    &amp;lt;property name=&amp;quot;jmeter.result.jtlName&amp;quot; value=&amp;quot;${jmeter.result.jtl.dir}/${ReportName}${time}.jtl&amp;quot; /&amp;gt;\n    &amp;lt;property name=&amp;quot;jmeter.result.htmlName&amp;quot; value=&amp;quot;${jmeter.result.html.dir}/SummaryReport.html&amp;quot; /&amp;gt;\n    &amp;lt;property name=&amp;quot;jmeter.detail.result.jtlName&amp;quot; value=&amp;quot;${jmeter.result.jtl.dir}/${ReportName}${time}.jtl&amp;quot; /&amp;gt;\n    &amp;lt;property name=&amp;quot;jmeter.detail.result.htmlName&amp;quot; value=&amp;quot;${jmeter.result.html.dir}/DetailReport.html&amp;quot; /&amp;gt;\n    &amp;lt;target name=&amp;quot;run&amp;quot;&amp;gt;\n        &amp;lt;antcall target=&amp;quot;test&amp;quot; /&amp;gt;\n        &amp;lt;antcall target=&amp;quot;report&amp;quot; /&amp;gt;\n    &amp;lt;/target&amp;gt;\n\n    &amp;lt;target name=&amp;quot;test&amp;quot;&amp;gt;\n        &amp;lt;taskdef name=&amp;quot;jmeter&amp;quot; classname=&amp;quot;org.programmerplanet.ant.taskdefs.jmeter.JMeterTask&amp;quot; /&amp;gt;\n        &amp;lt;jmeter jmeterhome=&amp;quot;${jmeter.home}&amp;quot; resultlog=&amp;quot;${jmeter.result.jtlName}&amp;quot;&amp;gt;\n             &amp;lt;!-- \u58f0\u660e\u8981\u8fd0\u884c\u7684\u811a\u672c\u201c*.jmx\u201d\u6307\u5305\u542b\u6b64\u76ee\u5f55\u4e0b\u7684\u6240\u6709jmeter\u811a\u672c--&amp;gt;\n            &amp;lt;testplans dir=&amp;quot;./scripts&amp;quot; includes=&amp;quot;*.jmx&amp;quot; /&amp;gt;\n           &amp;lt;property name=&amp;quot;jmeter.save.saveservice.output_format&amp;quot; value=&amp;quot;xml&amp;quot;/&amp;gt;\n\n        &amp;lt;/jmeter&amp;gt;\n    &amp;lt;/target&amp;gt;\n    &amp;lt;path id=&amp;quot;xslt.classpath&amp;quot;&amp;gt;\n            &amp;lt;fileset dir=&amp;quot;${jmeter.home}/lib&amp;quot; includes=&amp;quot;xalan*.jar&amp;quot;/&amp;gt;\n            &amp;lt;fileset dir=&amp;quot;${jmeter.home}/lib&amp;quot; includes=&amp;quot;serializer*.jar&amp;quot;/&amp;gt;\n    &amp;lt;/path&amp;gt;\n\n    &amp;lt;target name=&amp;quot;report&amp;quot;&amp;gt;\n        &amp;lt;tstamp&amp;gt; \n                &amp;lt;format property=&amp;quot;report.datestamp&amp;quot; pattern=&amp;quot;yyyy/MM/dd HH:mm&amp;quot; /&amp;gt;\n        &amp;lt;/tstamp&amp;gt;\n        &amp;lt;xslt \n            classpathref=&amp;quot;xslt.classpath&amp;quot;\n            force=&amp;quot;true&amp;quot;\n            in=&amp;quot;${jmeter.detail.result.jtlName}&amp;quot;\n            out=&amp;quot;${jmeter.detail.result.htmlName}&amp;quot;\n            style=&amp;quot;./jmeter.results.shanhe.me.xsl&amp;quot;&amp;gt;\n            &amp;lt;param name=&amp;quot;dateReport&amp;quot; expression=&amp;quot;${report.datestamp}&amp;quot;/&amp;gt;\n        &amp;lt;/xslt&amp;gt;\n        &amp;lt;xslt \n            classpathref=&amp;quot;xslt.classpath&amp;quot;\n            force=&amp;quot;true&amp;quot;\n            in=&amp;quot;${jmeter.result.jtlName}&amp;quot;\n            out=&amp;quot;${jmeter.result.htmlName}&amp;quot;\n            style=&amp;quot;./jmeter-results-detail-report_21.xsl&amp;quot;&amp;gt;\n            &amp;lt;param name=&amp;quot;dateReport&amp;quot; expression=&amp;quot;${report.datestamp}&amp;quot;/&amp;gt;\n        &amp;lt;/xslt&amp;gt;\n        &amp;lt;!-- \u62f7\u8d1d\u62a5\u544a\u6240\u9700\u7684\u56fe\u7247\u8d44\u6e90\u81f3\u76ee\u6807\u76ee\u5f55 --&amp;gt; \n        &amp;lt;copy todir=&amp;quot;${jmeter.result.html.dir}&amp;quot;&amp;gt;\n            &amp;lt;fileset dir=&amp;quot;${jmeter.home}/extras&amp;quot;&amp;gt;\n                &amp;lt;include name=&amp;quot;collapse.png&amp;quot; /&amp;gt;\n                &amp;lt;include name=&amp;quot;expand.png&amp;quot; /&amp;gt;\n            &amp;lt;/fileset&amp;gt;\n        &amp;lt;/copy&amp;gt;\n    &amp;lt;/target&amp;gt;\n&amp;lt;/project&amp;gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;\n\n&lt;div&gt;&lt;pre&gt;&lt;code class=\"language-none\"&gt;\n</code></pre> <p>\u8fd0\u884cant\u6d4b\u8bd5</p> <pre><code>ant -v\n\nApache Ant(M) version 1.9.14 compiled on March 12 2019\n\n\n$ ant -f build.xml\n...\nBUILD SUCCESSFUL\nTotal time: 5 seconds\n</code></pre> <p>\u6d4b\u8bd5\u62a5\u544a</p> <p></p> <p></p> <p>\u975eGUI\u6a21\u5f0f\u8fd0\u884c\u6d4b\u8bd5\u7528\u4f8b</p> <p></p>"},{"location":"chap4/4gitlab_jemeter/#_2","title":"\u81ea\u52a8\u5316\u6d4b\u8bd5\u96c6\u6210","text":"<p>\u5f00\u542fgitlab pages for project <code>gitlabci-cidevops-interfacetest-service</code> </p> <p><code>vim /etc/gitlab/gitlab.rb</code></p> <pre><code>##! Define to enable GitLab Pages\npages_external_url = \"http://pages.gitlab.com/\"\ngitlab_pages['enable' ] = true\ngitlab_pages[ 'inplace_chroot'] = true\n</code></pre> <p></p> <pre><code>gitlab-ctl reconfigure\n</code></pre> <p>\u66f4\u65b0<code>gitlab.ymI</code>\u6587\u4ef6</p> <pre><code>containers:\n  - name: gitlab\n  image: qitlab/qitlab-ce:12.9.0-ce.0\n  imagePullPolicy: IfNotPresent\n  ports:\n    - containerPort: 30088\n        name: web\n        protocol: TCP\n    - containerPort: 22\n        name: agent\n        protocol: TCP\n  - containerPort: 80\n        name: page\n        protocol: TCP\n</code></pre> <p>\u5f00\u653e80\u7aef\u53e3</p> <pre><code>---\napiVersion: v1\nkind: Service\nmetadata:\n  name: gitlab\n  namespace: devops\n  labels:\n    name: gitlab\nspec:\n  ports:\n    - name: http\n      port: 80\n      targetPort: http\n      nodePort: 32220\n    - name: ssh\n      port: 22\n      targetPort: ssh\n      nodePort: 30022\n    - name: page\n      port: 80\n      targetPort: 80\n      nodePort: 30022\n  type: NodePort\n  selector:\n    name: gitlab\n</code></pre> <p></p> <p><code>.gitlab-ci.yaml</code></p> <pre><code>stages:\n  - tests\n  - deploy\n\ninterface_test:\n  stage: tests\n  tags:\n    - build\n  script:\n    - ant -Djmeter.home=/usr/local/buildtools/apache-jmeter-5.2.1\n  artifacts:\n    paths:\n      - result/htmlfile/\n\npages:\n  stage: deploy\n  dependencies:\n    - interface_test\n  script:\n    - mv result/htmlfile/ public/\n  artifacts:\n    paths:\n      - public\n    expire_in: 30 days\n  only:\n    - master\n</code></pre> <p></p> <p></p> <p></p> <p>\u6210\u679c\u5c55\u793a</p> <p></p> <p></p> <p></p>"},{"location":"chap4/4gitlab_jemeter/#3","title":"3 \u4e0a\u4e0b\u6e38\u9879\u76ee\u89e6\u53d1\u81ea\u52a8\u5316\u6d4b\u8bd5","text":"<p><code>gitlabci-templates/jobs/test.yml</code></p> <pre><code>#\u5355\u5143\u6d4b\u8bd5\n\n.test:\n  stage: test\n  tags:\n    - build\n  script:\n    - $TEST_SHELL\n    - ls \n  artifacts:\n    reports:\n      junit: ${JUNIT_REPORT_PATH}\n\n.interfacetest:\n    stage: interface_test\n    trigger:\n        project: cidevops/cidevops-interfacetest-service\n        branch: master\n        strategy: depend\n</code></pre> <p><code>cidevops-java-service/templates/java-pipeline.yml</code></p> <pre><code>nclude:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n\nvariables:\n  BUILD_SHELL: 'mvn clean package  -DskipTests'  ##\u6784\u5efa\u547d\u4ee4\n  CACHE_DIR: 'target/'\n  TEST_SHELL : 'mvn test'                                   ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n  # \u4ee3\u7801\u626b\u63cf\n  SCANNER_HOME : \"/usr/local/buildtools/sonar-scanner-3.2.0.1227-linux\"\n  SCAN_DIR : \"src\"\n  ARTIFACT_PATH : 'target/*.jar'                            ##\u5236\u54c1\u76ee\u5f55\n\n  #\u4e0a\u4f20\u5236\u54c1\u5e93\n  ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"\n  ARTIFACTORY_NAME: \"cidevops\"\n  TARGET_FILE_PATH: \"$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  TARGET_ARTIFACT_NAME: \"$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID.jar\"\n\n\ncache:\n  paths:\n    - ${CACHE_DIR}\n\nstages:\n  - build\n  - test\n  - parallel01\n  - down_artifact\n  - interface_test\n\n\nbuild:\n  stage: build\n  extends: .build\n  rules:\n    - when: on_success\n\n\ntest:\n  stage: test\n  extends: .test\n  rules:\n    - when: on_success\n\n\ncode_analysis:\n  stage: parallel01\n  extends: .codeanalysis-java\n\ncodeanalysis_mr:\n  stage: parallel01\n  extends: .codeanalysis-mr\n\ndeploy_artifact:\n  stage: parallel01\n  extends: .deploy-artifact\n\ndown_artifact:  \n  stage: down_artifact\n  extends: .down-artifact\n\ninterfact_test:\n    stage: interface_test\n    extends: .interfacetest\n</code></pre> <p></p> <p></p> <p></p> <p></p>"},{"location":"chap4/5gitlba_mon/","title":"5 GitLabCI/CD Prom\u6784\u5efa\u6570\u636e\u91c7\u96c6\u4e0e\u76d1\u63a7","text":""},{"location":"chap4/5gitlba_mon/#prometheusgitlab-runner","title":"\u4f7f\u7528Prometheus\u5bf9GitLab Runner\u76d1\u63a7","text":"<ul> <li>1.1 \u914d\u7f6eGitLab Runner\u76d1\u63a7</li> <li>1.2 \u914d\u7f6eGitLabCI \u6d41\u6c34\u7ebf\u76d1\u63a7</li> </ul> <p>\u672c\u6587\u4e3b\u8981\u9610\u8ff0\u5982\u4f55\u914d\u7f6eGitLabRunner\u548cGitLabCI/CD\u6d41\u6c34\u7ebf\u7684\u6570\u636e\u91c7\u96c6\u4e0e\u76d1\u63a7\u3002</p>"},{"location":"chap4/5gitlba_mon/#11-gitlab-runner","title":"1.1 \u914d\u7f6eGitLab Runner\u76d1\u63a7","text":"<p>GitLab Runner\u672c\u5730\u5177\u6709Prometheus\u6307\u6807\uff0c\u53ef\u4ee5\u8bbf\u95ee\u5d4c\u5165\u5f0fHTTP\u670d\u52a1\u5668\uff0c\u901a\u8fc7<code>/metrics</code> \u8def\u5f84\u516c\u5f00\u3002\u8be5\u670d\u52a1\u5668\uff08\u5982\u679c\u5df2\u542f\u7528\uff09\u53ef\u4ee5\u88ab<code>Prometheus</code>\u76d1\u89c6\u7cfb\u7edf\u6293\u53d6\uff0c\u6216\u901a\u8fc7\u4efb\u4f55\u5176\u4ed6HTTP\u5ba2\u6237\u7aef\u8fdb\u884c\u8bbf\u95ee\u3002</p> <p>\u516c\u5f00\u7684\u4fe1\u606f\u5305\u62ec\uff1a</p> <ul> <li>Runner\u4e1a\u52a1\u903b\u8f91\u6307\u6807\uff08\u4f8b\u5982\uff0c\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684\u4f5c\u4e1a\u6570\uff09</li> <li>Go\u7279\u5b9a\u7684\u6d41\u7a0b\u6307\u6807\uff08\u5783\u573e\u6536\u96c6\u7edf\u8ba1\u4fe1\u606f\uff0cgoroutines\uff0cmemstats\u7b49\uff09</li> <li>\u5e38\u89c4\u6307\u6807\uff08\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\uff0cCPU\u4f7f\u7528\u60c5\u51b5\uff0c\u6587\u4ef6\u63cf\u8ff0\u7b26\u4f7f\u7528\u60c5\u51b5\u7b49\uff09</li> </ul> <p>\u8fd9\u4e9b\u6307\u6807\u662f\u8fd0\u7ef4\u4eba\u5458\u76d1\u89c6\u548c\u4e86\u89e3GitLab Runners\u7684\u4e00\u79cd\u65b9\u5f0f\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u4f1a\u5bf9Runner\u4e3b\u673a\u4e0a\u7684\u5e73\u5747\u8d1f\u8f7d\u548c\u4f5c\u4e1a\u6570\u91cf\u611f\u5174\u8da3\u3002</p> <p>Runner\u9ed8\u8ba4\u662f\u6ca1\u6709\u5f00\u542f\u5185\u7f6e\u7684HTTP\u670d\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u914d\u7f6e\u6307\u6807HTTP\u670d\u52a1\u5668\uff1a</p> <ul> <li>\u5728<code>config.toml</code>\u6587\u4ef6\u4e2d\u914d\u7f6e\u5168\u5c40\u9009\u9879 <code>listen_address</code>\u3002</li> <li>\u5728Runner\u542f\u52a8\u7684\u65f6\u5019\u6dfb\u52a0<code>--listen-address</code>\u547d\u4ee4\u9009\u9879\u3002</li> </ul> <p>\u5728\u8fd9\u91cc\u6211\u76f4\u63a5\u4fee\u6539\u7684<code>config.toml</code>\u6587\u4ef6\uff0c\u5185\u5bb9\u53c2\u8003\u5982\u4e0b\uff1a</p> <pre><code>$ cat config.toml \nlisten_address = \"[::]:9252\"\nconcurrent = 10\ncheck_interval = 30\nlog_level = \"info\"\n</code></pre> <p>\u4fee\u6539Runner\u914d\u7f6e\u540e\u9700\u8981\u91cd\u542f, \u968f\u540e\u901a\u8fc7<code>netstat</code>\u67e5\u770b\u76d1\u542c\u7684\u7aef\u53e3\u3002</p> <pre><code>bash-5.0$ netstat -anlpt | grep 9252\ntcp        0      0 :::9252                 :::*                    LISTEN      1/gitlab-runner\ntcp        0      0 ::ffff:10.244.0.102:9252 ::ffff:10.244.0.1:35880 ESTABLISHED 1/gitlab-runner\ntcp        0      0 ::ffff:10.244.0.102:9252 ::ffff:10.244.0.107:36184 ESTABLISHED 1/gitlab-runner\ntcp        0      0 ::ffff:10.244.0.102:9252 ::ffff:10.244.0.103:57404 ESTABLISHED 1/gitlab-runner\n</code></pre> <p>\u5f539252\u7aef\u53e3\u88ab\u76d1\u542c\uff0c\u5185\u5bb9\u7684HTTP\u670d\u52a1\u5668\u5c31\u542f\u52a8\u4e86\u3002\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u6307\u6807\u6570\u636e\u3002</p> <pre><code>curl 127.0.0.1:9252/metrics\n\n# HELP gitlab_runner_api_request_statuses_total The total number of api requests, partitioned by runner, endpoint and status.\n# TYPE gitlab_runner_api_request_statuses_total counter\ngitlab_runner_api_request_statuses_total{endpoint=\"request_job\",runner=\"6i2MzLuX\",status=\"204\"} 178\n# HELP gitlab_runner_autoscaling_machine_creation_duration_seconds Histogram of machine creation time.\n# TYPE gitlab_runner_autoscaling_machine_creation_duration_seconds histogram\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"30\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"37.5\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"46.875\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"58.59375\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"73.2421875\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"91.552734375\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"114.44091796875\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"143.0511474609375\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"178.81393432617188\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"223.51741790771484\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker+machine\",le=\"+Inf\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_sum{executor=\"docker+machine\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_count{executor=\"docker+machine\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"30\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"37.5\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"46.875\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"58.59375\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"73.2421875\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"91.552734375\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"114.44091796875\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"143.0511474609375\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"178.81393432617188\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"223.51741790771484\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_bucket{executor=\"docker-ssh+machine\",le=\"+Inf\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_sum{executor=\"docker-ssh+machine\"} 0\ngitlab_runner_autoscaling_machine_creation_duration_seconds_count{executor=\"docker-ssh+machine\"} 0\n# HELP gitlab_runner_autoscaling_machine_states The current number of machines per state in this provider.\n</code></pre> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u914d\u7f6ePrometheus\u5bf9\u6570\u636e\u6536\u96c6\uff0c\u7136\u540e\u901a\u8fc7Grafana\u5c55\u793a\u3002\u66f4\u65b0Prometheus\u914d\u7f6e\u6587\u4ef6\u3002</p> <pre><code>- job_name: 'gitlab-runner'\n      metrics_path: '/metrics'\n      scheme: http\n      bearer_token: bearer_token\n      static_configs:\n          - targets: ['192.168.1.200:30092']\n</code></pre> <p>\u7136\u540e\uff0c\u8bbf\u95eehttp://192.168.1.200:30003/new/targets, \u76ee\u6807\u4e3aup\u3002</p> <p></p> <p>\u6700\u540e\uff0c\u6211\u4eec\u627e\u4e00\u4e2aGrafana\u6a21\u677f\u5c55\u793a\u6570\u636e\u3002https://grafana.com/grafana/dashboards/9631 \u4e0b\u8f7dJSON\u6587\u4ef6\uff0c\u5bfc\u5165\u3002</p> <p></p>"},{"location":"chap4/5gitlba_mon/#12-gitlabci","title":"1.2 \u914d\u7f6eGitLabCI \u6d41\u6c34\u7ebf\u76d1\u63a7","text":"<p>\u6709\u65f6\u5019\u5bf9\u4e8e\u8fd0\u7ef4\u7ba1\u7406\u4eba\u5458\u6765\u8bf4\uff0c\u6211\u4eec\u9700\u8981\u770b\u5230\u6574\u4e2a\u5e73\u53f0\u7684\u6d41\u6c34\u7ebf\u72b6\u6001\u3002\u7c7b\u4f3c\u4e8eJenkins\u4e00\u6837\u6709\u7edf\u4e00\u7684\u9762\u677f\u5c55\u793a\u3002\u5728GitLab\u4e2d\u6bcf\u4e2a\u9879\u76ee\u90fd\u6709CI/CD\u6570\u636e\u7684\u5c55\u793a\u3002\u9700\u8981\u8fdb\u5165\u6bcf\u4e2a\u9879\u76ee\u624d\u80fd\u770b\u5230\uff0c\u8fd9\u6837\u975e\u5e38\u4e0d\u4fbf\u3002\u5728\u8fd9\u91cc\u6211\u4eec\u5b89\u88c5\u914d\u7f6e\uff1a<code>gitlab-ci-pipelines-exporter</code>\u6765\u5b9e\u73b0\u5bf9GitLabCI\u6d41\u6c34\u7ebf\u72b6\u6001\u7684\u5c55\u793a\u3002</p> <p>\u9996\u5148\u6211\u4eec\u9700\u8981\u4e0b\u8f7d<code>chart</code>\u6e90\u7801\uff0c\u7136\u540e\u4fee\u6539<code>values.yaml</code>\u4e2d\u7684<code>GitLab</code>\u914d\u7f6e\u3002\u914d\u7f6eGitLab\u670d\u52a1\u5668\u7684\u5730\u5740\u548cToken\u3001\u9700\u8981\u540c\u6b65\u7684\u9879\u76ee\u3002</p> <pre><code>git clone https://github.com/mvisonneau/gitlab-ci-pipelines-exporter.git\n\n\nvim chart/values.yaml\n\n##\u5173\u952e\u914d\u7f6e\n## Actual configuration of the exporter\n##\nconfig:\n  # # Full configuration syntax reference available here:\n  # # https://github.com/mvisonneau/gitlab-ci-pipelines-exporter/blob/master/docs/configuration_syntax.md\n  gitlab:\n    url: http://192.168.1.200:30088\n  #   # You can also configure the token using --gitlab-token\n  #   # or the $GCPE_GITLAB_TOKEN environment variable\n    token: Z-smAyB8pFyttu6D2d_J\n  # projects:\n  #   - name: foo/project\n  #   - name: bar/project\n  wildcards:\n    - owner:\n      name: cidevops\n      kind: group\n\n\nhelm install gitlabci-pipline-exporter --namespace gitlab-runner ./chart\n</code></pre> <p>\u914d\u7f6ePrometheus\uff1a\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u6dfb\u52a0\u76ee\u6807\u3002</p> <pre><code> - job_name: 'gitlab-runner-ci-pipeline'\n      metrics_path: '/metrics'\n      scheme: http\n      bearer_token: bearer_token\n      static_configs:\n          - targets: ['10.1.234.132:80']\n</code></pre> <p>\u6dfb\u52a0Grafana\u9762\u677f<code>https://grafana.com/grafana/dashboards/10620</code>\u3002\u4e0b\u8f7dJSON\u6587\u4ef6\u7136\u540e\u5bfc\u5165\u3002\u6700\u7ec8\u6548\u679c\u5982\u4e0b\uff1a</p> <p></p>"},{"location":"chap5/1gitlab-runner-install/","title":"1 \u57fa\u4e8eK8S\u5b89\u88c5\u90e8\u7f72Runner","text":""},{"location":"chap5/1gitlab-runner-install/#chart","title":"\u914d\u7f6eChart\u5b58\u50a8\u5e93","text":"<pre><code>helm repo add gitlab https://charts.gitlab.io\n\nhelm repo list\n\n$ helm repo list | grep gitlab\ngitlab  https://charts.gitlab.io \n\n\nhelm search repo -l gitlab/gitlab-runner\n</code></pre> <pre><code>helm fetch gitlab/gitlab-runner --version=0.44.0\n\ntar zxvf gitlab-runner-0.44.0.tgz\n\n$ tree gitlab-runner\ngitlab-runner\n\u251c\u2500\u2500 CHANGELOG.md\n\u251c\u2500\u2500 CONTRIBUTING.md\n\u251c\u2500\u2500 Chart.yaml\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 NOTICE\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 templates\n\u2502   \u251c\u2500\u2500 NOTES.txt\n\u2502   \u251c\u2500\u2500 _cache.tpl\n\u2502   \u251c\u2500\u2500 _env_vars.tpl\n\u2502   \u251c\u2500\u2500 _helpers.tpl\n\u2502   \u251c\u2500\u2500 configmap.yaml\n\u2502   \u251c\u2500\u2500 deployment.yaml\n\u2502   \u251c\u2500\u2500 hpa.yaml\n\u2502   \u251c\u2500\u2500 role-binding.yaml\n\u2502   \u251c\u2500\u2500 role.yaml\n\u2502   \u251c\u2500\u2500 secrets.yaml\n\u2502   \u251c\u2500\u2500 service-account.yaml\n\u2502   \u251c\u2500\u2500 service-session-server.yaml\n\u2502   \u251c\u2500\u2500 service.yaml\n\u2502   \u2514\u2500\u2500 servicemonitor.yaml\n\u2514\u2500\u2500 values.yaml\n\n1 directory, 22 files\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#_1","title":"\u66f4\u65b0\u914d\u7f6e\u4fe1\u606f","text":"<p>values.yaml</p> <pre><code>image:\n  registry: registry.gitlab.com\n  image: gitlab-org/gitlab-runner\n  # tag: alpine-v11.6.0\n\n## \u955c\u50cf\u4e0b\u8f7d\u7b56\u7565\nimagePullPolicy: IfNotPresent\n\n## Gitlab\u670d\u52a1\u5668\u5730\u5740\ngitlabUrl: http://127.0.0.1:32220\n\n## runner\u6ce8\u518ctoken\nrunnerRegistrationToken: \"nzTshoYwsnCttkyzZBxE\"\n\n## \u7ec8\u6b62\u4e4b\u524d\u6ce8\u9500\u6240\u6709\u8dd1\u6b65\u8005\nunregisterRunner: true\n\n## \u5f53\u505c\u6b62\u7ba1\u9053\u65f6\u7b49\u5f85\u5176\u4f5c\u4e1a\u7ec8\u6b62\u65f6\u95f4\nterminationGracePeriodSeconds: 3600\n\n## \u914d\u7f6e\u6700\u5927\u4e95\u53d1\u4f5c\u4e1a\u6570\nconcurrent: 10\n\n## \u65b0\u4f5c\u4e1a\u68c0\u67e5\u95f4\u9694\ncheckInterval: 30\n\n## GitlabRunner\u65e5\u5fd7\u7ea7\u522b debug, info, warn, error, fatal, panic\nlogLevel: info\n\n\nsessionServer:\n  enabled: false\n\n## For RBAC support:\nrbac:\n  create: true\n  resources: [\"pods\", \"pods/exec\", \"secrets\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"patch\", \"delete\"]\n\n podSecurityPolicy:\n    enabled: false\n    resourceNames:\n    - gitlab-runner\n\nmetrics:\n  enabled: true\n\n  portName: metrics\n\n  port: 9252\n\n  serviceMonitor:\n    enabled: false\n\nservice:\n  enabled: false\n\n  type: ClusterIP\n  locked: false\n  tags: \"kubernetes-runner, k8s\"\n</code></pre> <p>\u672a\u521b\u5efarbac</p> <p>ERROR: Job failed (system failure): pods is forbidden: User \"system:serviceaccount:gitlab-runner:default\" cannot create resource \"pods\" in API group in the namespace \"gitlab-runner\"</p> <pre><code>$ kubectl create ns gitlab-runner\nnamespace/gitlab-runner created\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#chart_1","title":"\u90e8\u7f72  chart","text":"<pre><code>helm3 template --dry-run k8s-runner gitlab-runner/ -n devops\n\n$ helm3 install gitlab-runner gitlab-runner/ -n devops\n\nNAME: gitlab-runner\nLAST DEPLOYED: Fri Aug 26 23:21:45 2022\nNAMESPACE: devops\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYour GitLab Runner should now be registered against the GitLab instance reachable at: \"http://127.0.0.1:32220\"\n\nRunner namespace \"devops\" was found in runners.config template.\n</code></pre> <pre><code>helm upgrade gitlab-runner gitlab-runner -namespace devops\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#k8s","title":"\u53d1\u5e03\u5e94\u7528\u5230K8S\u73af\u5883","text":"<p>\u8fd0\u884c\u6d41\u6c34\u7ebf\u6d4b\u8bd5 </p> <pre><code>image: maven:3.6.3-jdk-8\n\nbefore_script:\n    - ls\n\nservices:\n    - name: mysql: latest\n    - alias: mysql-1\n\nbuild:\n    image: maven: 3.6.3-jdk-8\n    stage: build\n    tags:\n        - k8s\n    script:\n     - ls\n   - sleep 2\n   - echo \"mvn clean \"\n   - sleep 10\n\ndeploy:\n    stage: deploy\n    tags:\n        - k8s\n    script:\n        - echo \"deploy\"\n    environment:\n        name: production\n        url: http://www.baidu.com\n</code></pre> <p></p> <p></p>"},{"location":"chap5/1gitlab-runner-install/#2-k8s","title":"2 \u5728 K8S \u4e2d\u53d1\u5e03\u5e94\u7528","text":""},{"location":"chap5/1gitlab-runner-install/#_2","title":"\u51c6\u5907\u5de5\u4f5c","text":"<pre><code>kubectl create secret docker-registry cidevops\n    --docker-server=registry.cn-beijing.aliyuncs.com\\\n    --docker-username=XXXX \\\n    --docker-password=xxxx\\\n    --docker-email=test@test.com -n cidevops\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#_3","title":"\u51c6\u5907\u5de5\u4f5c","text":"<p>\u521b\u5efa\u540d\u79f0\u7a7a\u95f4</p> <pre><code>kubectl create ns cidevops\n</code></pre> <p><code>cidevops-gitlabci-service/jobs/deploy.yml</code></p> <pre><code>.deploy-k8s:\n  stage: deploy\n  tags:\n    - build\n  script:\n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" deployment.yaml \n    - sed -i \"s#__appname__#${APP_NAME}#g\" deployment.yaml \n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" deployment.yaml \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" deployment.yaml \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" deployment.yaml \n    - kubectl apply -f deployment.yaml\n  after_script:\n   - sleep 10\n   - kubectl get pod  -n $NAMESPACE\n</code></pre> <p><code>cidevops-gitlabci-service/templates/k8s-java-pipeline.yml</code></p> <ul> <li><code>stage: deploy</code></li> </ul> <pre><code>deploy_k8s:\n  stage: deploy\n  extends: .deploy-k8s\n  rules:\n    - if: \" $RUN_DEPLOY == 'no' \"\n      when: never\n    - if: \" $MANUAL_BRANCH  == 'master' \"\n      when: manual\n    - when: always\n  environment:\n    name: $ENV_NAME\n    url: $ENV_URL\n</code></pre> <ul> <li>\u5b8c\u6574\uff1a <code>k8s-java-pipeline.yml</code></li> </ul> <pre><code>include:\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n  - project: 'cidevops/cidevops-gitlabci-service'\n    ref: master\n    file: 'jobs/deploy.yml'\n\nvariables:\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID\n  GIT_CHECKOUT: \"false\"\n  MVN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/m2\"\n  BUILD_SHELL: 'mvn clean package  -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  --settings=./settings.xml'  ##\u6784\u5efa\u547d\u4ee4\n  TEST_SHELL : 'mvn test -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  --settings=./settings.xml'                        ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  # \u4ee3\u7801\u626b\u63cf\n  SCANNER_HOME : \"\"\n  SCAN_DIR : \"src\"\n  ARTIFACT_PATH : 'target/*.jar'                            ##\u5236\u54c1\u76ee\u5f55\n\n  #\u4e0a\u4f20\u5236\u54c1\u5e93\n  ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"\n  ARTIFACTORY_NAME: \"cidevops\"\n  TARGET_FILE_PATH: \"$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  TARGET_ARTIFACT_NAME: \"$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID.jar\"\n\n  #\u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\n  CI_REGISTRY_USER: '610556220zy'\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'\n  IMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA-$CI_PIPELINE_ID\"\n  DOCKER_FILE_PATH: \"./Dockerfile\"\n\n  #\u90e8\u7f72k8s\n  RUN_DEPLOY: \"yes\"\n  APP_NAME: \"$CI_PROJECT_NAME\"\n  CONTAINER_PORT: 8081\n  NODE_PORT: 30185\n  ENV_NAME: \"staging\"\n  ENV_URL: \"http://192.168.1.200:30185\"\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"\n\n\n\nimage: docker:latest\n\n\nstages:\n  - build\n  - test\n  - parallel01\n  - down_artifact\n  - deploy\n  - interface_test\n\nbefore_script:\n  - ls /home/gitlab-runner/ci-build-cache/builds/\n  - echo  $CI_BUILDS_DIR\n  - echo  $KUBE_URL $KUBE_TOKEN $KUBE_CA_PEM $KUBE_CA_PEM_FILE\n  - export\n\n\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  tags:\n    - k8s\n  image: maven:3.6.3-jdk-8\n  stage: build\n  extends: .build\n  rules:\n    - when: on_success\n  after_script:\n    - ls target/\n\ntest:\n  before_script:\n    - ls target/\n  tags:\n    - k8s\n  image: maven:3.6.3-jdk-8\n  stage: test\n  extends: .test\n  rules:\n    - when: on_success\n  after_script:\n    - ls target/\n\ncode_analysis:\n  tags:\n    - k8s\n  image: sonarsource/sonar-scanner-cli:latest\n  stage: parallel01\n  script:\n    - ls target/\n    - echo $CI_MERGE_REQUEST_IID $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME\n    - \"sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \\\n                  -Dsonar.projectName=${CI_PROJECT_NAME} \\\n                  -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \\\n                  -Dsonar.ws.timeout=30 \\\n                  -Dsonar.projectDescription=${CI_PROJECT_TITLE} \\\n                  -Dsonar.links.homepage=${CI_PROJECT_URL} \\\n                  -Dsonar.sources=${SCAN_DIR} \\\n                  -Dsonar.sourceEncoding=UTF-8 \\\n                  -Dsonar.java.binaries=target/classes \\\n                  -Dsonar.java.test.binaries=target/test-classes \\\n                  -Dsonar.java.surefire.report=target/surefire-reports \\\n                  -Dsonar.host.url=http://192.168.1.200:30090 \\\n                  -Dsonar.login=ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b \\\n                  -Dsonar.branch.name=${CI_COMMIT_REF_NAME}\" \n\nbuild_image:\n  before_script:\n    - ls target/\n  tags:\n    - k8s\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n\n\ndeploy_k8s:\n  image: lucj/kubectl:1.17.2\n  tags:\n    - k8s\n    - kubernetes-runner\n  stage: deploy\n  script:\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" deployment.yaml \n    - sed -i \"s#__appname__#${APP_NAME}#g\" deployment.yaml \n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" deployment.yaml \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" deployment.yaml \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" deployment.yaml \n    - sed -i \"s#__CI_ENVIRONMENT_SLUG__#${CI_ENVIRONMENT_SLUG}#g\" deployment.yaml \n    - sed -i \"s#__CI_PROJECT_PATH_SLUG__#${CI_PROJECT_PATH_SLUG}#g\" deployment.yaml\n    - cat deployment.yaml\n    - kubectl apply -f deployment.yaml  \n  environment:\n    name: $ENV_NAME\n    url: $ENV_URL\n\n\ninterfact_test:\n  inherit:\n    variables: false\n  stage: interface_test\n  extends: .interfacetest\n</code></pre> <p><code>gitlabci-cidevops-java-service/deployment.yaml</code></p> <pre><code>kind: Deployment\napiVersion: apps/v1\nmetadata:\n  labels:\n    k8s-app: __appname__\n    app.gitlab.com/env: __CI_ENVIRONMENT_SLUG__\n    app.gitlab.com/app: __CI_PROJECT_PATH_SLUG__\n  name: __appname__\n  namespace: __namespace__\n  annotations:\n    app.gitlab.com/env: __CI_ENVIRONMENT_SLUG__\n    app.gitlab.com/app: __CI_PROJECT_PATH_SLUG__\nspec:\n  replicas: 1\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      k8s-app: __appname__\n  template:\n    metadata:\n      labels:\n        k8s-app: __appname__\n        app.gitlab.com/env: __CI_ENVIRONMENT_SLUG__\n        app.gitlab.com/app: __CI_PROJECT_PATH_SLUG__\n      namespace: __namespace__\n      name: __appname__\n    spec:\n      containers:\n        - name: __appname__\n          image: __imagename__\n          imagePullPolicy: IfNotPresent\n          ports:\n            - containerPort: __containerport__\n              name: web\n              protocol: TCP\n      serviceAccountName: __appname__\n      imagePullSecrets:\n        - name: __namespace__\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    k8s-app: __appname__\n  name: __appname__\n  namespace: __namespace__\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    k8s-app: __appname__\n  name: __appname__\n  namespace: __namespace__\nspec:\n  type: NodePort\n  ports:\n    - name: web\n      port: __containerport__\n      targetPort: __containerport__\n      nodePort: __nodeport__\n  selector:\n    k8s-app: __appname__\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#gitlabci-cidevops-java-servicegitlab-ciyml","title":"<code>gitlabci-cidevops-java-service/.gitlab-ci.yml</code>","text":"<pre><code>include:\n    - project: 'cidevops/cidevops-gitlabci-service'\n      ref: master\n      file: 'templates/k8s-java-pipeline.yml'\n\n\nvariables:\n  BUILD_SHELL: 'mvn clean package  -DskipTests'  \n</code></pre> <p>\u6700\u7ec8\u6548\u679c</p> <p></p>"},{"location":"chap5/1gitlab-runner-install/#2-runner","title":"2 \u914d\u7f6eRunner \u6301\u4e45\u5316\u6784\u5efa\u7f13\u5b58","text":""},{"location":"chap5/1gitlab-runner-install/#_4","title":"\u51c6\u5907\u5de5\u4f5c","text":"<p>runner\u914d\u7f6e\u4fe1\u606f\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570\u6307\u5b9a\uff0c\u4e5f\u53ef\u4ee5\u4ee5\u73af\u5883\u53d8\u91cf\u65b9\u5f0f\u8bbe\u7f6e\u3002\u8be6\u7ec6\u5185\u5bb9\u53ef\u4ee5\u901a\u8fc7 <code>gitlab-runner register -h</code> \u83b7\u53d6\u5230\u76f8\u5173\u53c2\u6570\u548c\u53d8\u91cf\u540d\u79f0\u3002</p> <p>\u5728\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684runner\u955c\u50cf\u6ce8\u518crunner\uff0c\u9ed8\u8ba4\u7684runner\u914d\u7f6e\u6587\u4ef6\u5728<code>/home/gitlab-runner/.gitlab-runner/config.toml</code></p> <p></p> <p>\u53c2\u8003\u6587\u6863</p> <p>https://docs.gitlab.com/charts/advanced/persistent-volumes/#make-changes-to-the-persistentvolumeclaim</p>"},{"location":"chap5/1gitlab-runner-install/#gitlab-runner","title":"\u91cd\u5efagitlab-runner","text":"<p>values.yml</p> <pre><code>## GitLab Runner Image\n##\n## By default it's using gitlab/gitlab-runner:alpine-v{VERSION}\n## where {VERSION} is taken from Chart.yaml from appVersion field\n##\n## ref: https://hub.docker.com/r/gitlab/gitlab-runner/tags/\n##\nimage: gitlab/gitlab-runner:alpine-v12.9.0\n\n## \u955c\u50cf\u4e0b\u8f7d\u7b56\u7565\nimagePullPolicy: IfNotPresent\n\n## Gitlab\u670d\u52a1\u5668\u5730\u5740\ngitlabUrl: http://192.168.1.200:32220/\n\n## runner\u6ce8\u518ctoken\nrunnerRegistrationToken: \"JRzzw2j1Ji6aBjwvkxAv\"\n\n## \u7ec8\u6b62\u4e4b\u524d\u6ce8\u9500\u6240\u6709\u8dd1\u6b65\u8005\nunregisterRunners: true\n\n\n## \u5f53\u505c\u6b62\u7ba1\u9053\u65f6\u7b49\u5f85\u5176\u4f5c\u4e1a\u7ec8\u6b62\u65f6\u95f4\nterminationGracePeriodSeconds: 3600\n\n## Set the certsSecretName in order to pass custom certficates for GitLab Runner to use\n## Provide resource name for a Kubernetes Secret Object in the same namespace,\n## this is used to populate the /home/gitlab-runner/.gitlab-runner/certs/ directory\n## ref: https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates\n##\n# certsSecretName:\n\n\n## \u914d\u7f6e\u6700\u5927\u5e76\u53d1\u4f5c\u4e1a\u6570\nconcurrent: 10\n\n## \u65b0\u4f5c\u4e1a\u68c0\u67e5\u95f4\u9694\ncheckInterval: 30\n\n## GitlabRunner\u65e5\u5fd7\u7ea7\u522b debug, info, warn, error, fatal, panic\nlogLevel: info\n\n## Configure GitLab Runner's logging format. Available values are: runner, text, json\n## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-global-section\n##\n# logFormat:\n\n## For RBAC support:\nrbac:\n  create: true\n  ## Define specific rbac permissions.\n  resources: [\"pods\", \"pods/exec\", \"secrets\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"patch\", \"delete\"]\n\n  ## Run the gitlab-bastion container with the ability to deploy/manage containers of jobs\n  ## cluster-wide or only within namespace\n  clusterWideAccess: false\n\n  ## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)\n  ##\n  # serviceAccountName: default\n\n  ## Specify annotations for Service Accounts, useful for annotations such as eks.amazonaws.com/role-arn\n  ##\n  ## ref: https://docs.aws.amazon.com/eks/latest/userguide/specify-service-account-role.html\n  ##\n  # serviceAccountAnnotations: {}\n\n## Configure integrated Prometheus metrics exporter\n## ref: https://docs.gitlab.com/runner/monitoring/#configuration-of-the-metrics-http-server\nmetrics:\n  enabled: true\n\n## Configuration for the Pods that that the runner launches for each new job\n##\nrunners:\n  ## Default container image to use for builds when none is specified\n  ##\n  image: ubuntu:16.04\n\n  ## Specify one or more imagePullSecrets\n  ##\n  ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/\n  ##\n  # imagePullSecrets: []\n\n  ## Specify the image pull policy: never, if-not-present, always. The cluster default will be used if not set.\n  ##\n  imagePullPolicy: \"if-not-present\"\n\n  ## Defines number of concurrent requests for new job from GitLab\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section\n  ## \u9650\u5236\u6765\u81eaGitLab\u7684\u5bf9\u65b0\u4f5c\u4e1a\u7684\u5e76\u53d1\u8bf7\u6c42\u6570\n  requestConcurrency: 1\n\n  ## Specify whether the runner should be locked to a specific project: true, false. Defaults to true.\n  ##\n  locked: false\n\n  ## Specify the tags associated with the runner. Comma-separated list of tags.\n  ##\n  ## ref: https://docs.gitlab.com/ce/ci/runners/#using-tags\n  ##\n  tags: \"kubernetes-runner,k8s\"\n\n  ## Specify if jobs without tags should be run.\n  ## If not specified, Runner will default to true if no tags were specified. In other case it will\n  ## default to false.\n  ##\n  ## ref: https://docs.gitlab.com/ce/ci/runners/#allowing-runners-with-tags-to-pick-jobs-without-tags\n  ##\n  runUntagged: true\n\n  ## Specify whether the runner should only run protected branches.\n  ## Defaults to False.\n  ##\n  ## ref: https://docs.gitlab.com/ee/ci/runners/#protected-runners\n  ##\n  protected: false\n\n  ## Run all containers with the privileged flag enabled\n  ## This will allow the docker:dind image to run if you need to run Docker\n  ## commands. Please read the docs before turning this on:\n  ## ref: https://docs.gitlab.com/runner/executors/kubernetes.html#using-docker-dind\n  ##\n  privileged: true\n\n  ## The name of the secret containing runner-token and runner-registration-token\n  # secret: gitlab-runner\n\n  ## Namespace to run Kubernetes jobs in (defaults to the same namespace of this release)\n  ##\n  # namespace:\n\n  ## The amount of time, in seconds, that needs to pass before the runner will\n  ## timeout attempting to connect to the container it has just created.\n  ## ref: https://docs.gitlab.com/runner/executors/kubernetes.html\n  pollTimeout: 180\n\n  ## Set maximum build log size in kilobytes, by default set to 4096 (4MB)\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-section\n  outputLimit: 4096\n\n  ## Distributed runners caching\n  ## ref: https://gitlab.com/gitlab-org/gitlab-runner/blob/master/docs/configuration/autoscale.md#distributed-runners-caching\n  ##\n  ## If you want to use s3 based distributing caching:\n  ## First of all you need to uncomment General settings and S3 settings sections.\n  ##\n  ## Create a secret 's3access' containing 'accesskey' &amp; 'secretkey'\n  ## ref: https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/\n  ##\n  ## $ kubectl create secret generic s3access \\\n  ##   --from-literal=accesskey=\"YourAccessKey\" \\\n  ##   --from-literal=secretkey=\"YourSecretKey\"\n  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/\n  ##\n  ## If you want to use gcs based distributing caching:\n  ## First of all you need to uncomment General settings and GCS settings sections.\n  ##\n  ## Access using credentials file:\n  ## Create a secret 'google-application-credentials' containing your application credentials file.\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runnerscachegcs-section\n  ## You could configure\n  ## $ kubectl create secret generic google-application-credentials \\\n  ##   --from-file=gcs-application-credentials-file=./path-to-your-google-application-credentials-file.json\n  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/\n  ##\n  ## Access using access-id and private-key:\n  ## Create a secret 'gcsaccess' containing 'gcs-access-id' &amp; 'gcs-private-key'.\n  ## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html#the-runners-cache-gcs-section\n  ## You could configure\n  ## $ kubectl create secret generic gcsaccess \\\n  ##   --from-literal=gcs-access-id=\"YourAccessID\" \\\n  ##   --from-literal=gcs-private-key=\"YourPrivateKey\"\n  ## ref: https://kubernetes.io/docs/concepts/configuration/secret/\n  cache: {}\n    ## General settings\n    # cacheType: s3\n    # cachePath: \"gitlab_runner\"\n    # cacheShared: true\n\n    ## S3 settings\n    # s3ServerAddress: s3.amazonaws.com\n    # s3BucketName:\n    # s3BucketLocation:\n    # s3CacheInsecure: false\n    # secretName: s3access\n\n    ## GCS settings\n    # gcsBucketName:\n    ## Use this line for access using access-id and private-key\n    # secretName: gcsaccess\n    ## Use this line for access using google-application-credentials file\n    # secretName: google-application-credentials\n\n  ## Build Container specific configuration\n  ##\n  builds: {}\n    # cpuLimit: 200m\n    # memoryLimit: 256Mi\n    # cpuRequests: 100m\n    # memoryRequests: 128Mi\n\n  ## Service Container specific configuration\n  ##\n  services: {}\n    # cpuLimit: 200m\n    # memoryLimit: 256Mi\n    # cpuRequests: 100m\n    # memoryRequests: 128Mi\n\n  ## Helper Container specific configuration\n  ##\n  helpers: {}\n    # cpuLimit: 200m\n    # memoryLimit: 256Mi\n    # cpuRequests: 100m\n    # memoryRequests: 128Mi\n    # image: gitlab/gitlab-runner-helper:x86_64-latest\n\n  ## Service Account to be used for runners\n  ##\n  # serviceAccountName:\n\n  ## If Gitlab is not reachable through $CI_SERVER_URL\n  ##\n  # cloneUrl:\n\n  ## Specify node labels for CI job pods assignment\n  ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/\n  ##\n  # nodeSelector: {}\n\n  ## Specify pod labels for CI job pods\n  ##\n  # podLabels: {}\n\n  ## Specify annotations for job pods, useful for annotations such as iam.amazonaws.com/role\n  # podAnnotations: {}\n\n  ## Configure environment variables that will be injected to the pods that are created while\n  ## the build is running. These variables are passed as parameters, i.e. `--env \"NAME=VALUE\"`,\n  ## to `gitlab-runner register` command.\n  ##\n  ## Note that `envVars` (see below) are only present in the runner pod, not the pods that are\n  ## created for each build.\n  ##\n  ## ref: https://docs.gitlab.com/runner/commands/#gitlab-runner-register\n  ##\n  # env:\n  #   NAME: VALUE\n\n\n## Configure securitycontext\n## ref: http://kubernetes.io/docs/user-guide/security-context/\n##\nsecurityContext:\n  fsGroup: 65533\n  runAsUser: 100\n\n\n## Configure resource requests and limits\n## ref: http://kubernetes.io/docs/user-guide/compute-resources/\n##\nresources: {}\n  # limits:\n  #   memory: 256Mi\n  #   cpu: 200m\n  # requests:\n  #   memory: 128Mi\n  #   cpu: 100m\n\n## Affinity for pod assignment\n## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity\n##\naffinity: {}\n\n## Node labels for pod assignment\n## Ref: https://kubernetes.io/docs/user-guide/node-selection/\n##\nnodeSelector: {}\n  # Example: The gitlab runner manager should not run on spot instances so you can assign\n  # them to the regular worker nodes only.\n  # node-role.kubernetes.io/worker: \"true\"\n\n## List of node taints to tolerate (requires Kubernetes &gt;= 1.6)\n## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/\n##\ntolerations: []\n  # Example: Regular worker nodes may have a taint, thus you need to tolerate the taint\n  # when you assign the gitlab runner manager with nodeSelector or affinity to the nodes.\n  # - key: \"node-role.kubernetes.io/worker\"\n  #   operator: \"Exists\"\n\n## Configure environment variables that will be present when the registration command runs\n## This provides further control over the registration process and the config.toml file\n## ref: `gitlab-runner register --help`\n## ref: https://docs.gitlab.com/runner/configuration/advanced-configuration.html\n##\n# envVars:\n#   - name: RUNNER_EXECUTOR\n#     value: kubernetes\n\n## list of hosts and IPs that will be injected into the pod's hosts file\nhostAliases: []\n  # Example:\n  # - ip: \"127.0.0.1\"\n  #   hostnames:\n  #   - \"foo.local\"\n  #   - \"bar.local\"\n  # - ip: \"10.1.2.3\"\n  #   hostnames:\n  #   - \"foo.remote\"\n  #   - \"bar.remote\"\n\n## Annotations to be added to manager pod\n##\npodAnnotations: {}\n  # Example:\n  # iam.amazonaws.com/role: &lt;my_role_arn&gt;\n\n## Labels to be added to manager pod\n##\npodLabels: {}\n  # Example:\n  # owner.team: &lt;my_cool_team&gt;\n\n## HPA support for custom metrics:\n## This section enables runners to autoscale based on defined custom metrics.\n## In order to use this functionality, Need to enable a custom metrics API server by\n## implementing \"custom.metrics.k8s.io\" using supported third party adapter\n## Example: https://github.com/directxman12/k8s-prometheus-adapter\n##\n#hpa: {}\n  # minReplicas: 1\n  # maxReplicas: 10\n  # metrics:\n  # - type: Pods\n  #   pods:\n  #     metricName: gitlab_runner_jobs\n  #     targetAverageValue: 400m\n</code></pre> <pre><code>## \u66f4\u65b0\nhelm upgrade gitlab-runner --namespace gitlab-runner ./gitlab-runner\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#_5","title":"\u8dd1\u4e00\u4e2a\u4f20\u7edf\u7684\u6253\u5305\u6d41\u6c34\u7ebf","text":"<p><code>.gitlba-ci.yaml</code></p> <pre><code>image: maven:3.6.3-jdk-8\n\nbefore_script:\n    - ls\n\nservices:\n    - name: mysql:latest\n        alias: mysql-1\n\nbuild:\n    image: maven:3.6.3-jdk-8\n    stage: build\n    tags:\n        - k8s\n    script:\n        - ls\n        - sleep 2\n        - mvn clean package -DskipTests\n        - sleep 10\n\ndeploy:\n    stage: deploy\n    tags:\n        - k8s\n    script:\n        - echo \"deploy\"\n    environment:\n        name: production\n        ur: http://www.baidu.com\n</code></pre> <p>\u4e0b\u8f7d\u4f9d\u8d56\u5305\u5c06\u4f1a\u82b1\u8d39\u5927\u91cf\u7684\u65f6\u95f4</p> <p></p> <p></p>"},{"location":"chap5/1gitlab-runner-install/#_6","title":"\u89e3\u51b3\u6784\u5efa\u7f13\u5b58\u95ee\u9898","text":"<p>\u6240\u8c13\u7684\u6784\u5efa\u7f13\u5b58\u5c31\u662f\u6211\u4eec\u5728\u8fdb\u884cmaven/npm\u7b49\u6784\u5efa\u5de5\u5177\u6253\u5305\u65f6\u6240\u4f9d\u8d56\u7684\u5305\u3002\u9ed8\u8ba4\u4f1a\u5728\u79c1\u670d\u4e2d\u83b7\u53d6\uff0c\u52a0\u5feb\u6784\u5efa\u901f\u5ea6\u53ef\u4ee5\u5728\u672c\u5730\u7f13\u5b58\u4e00\u4efd\u3002</p> <p>\u5728\u6b64\uff0c\u6211\u4eec\u9700\u8981\u521b\u5efaPVC\u6765\u6301\u4e45\u5316\u6784\u5efa\u7f13\u5b58\uff0c\u52a0\u901f\u6784\u5efa\u901f\u5ea6\u3002\u4e3a\u4e86\u8282\u7701\u5b58\u50a8\u7a7a\u95f4\u51b3\u5b9a\u4e0d\u5728\u6bcf\u4e2a\u9879\u76ee\u4e2d\u5b58\u50a8\u6784\u5efa\u7f13\u5b58\uff0c\u800c\u662f\u914d\u7f6e\u5168\u5c40\u7f13\u5b58\u3002</p> <p>\u51c6\u5907\u672c\u673a\u7f13\u5b58\u76ee\u5f55</p> <pre><code>/opt/ci-build-cache\n[ci-build-cache]# ls\nbuilds    maven \n</code></pre> <p>\u9996\u5148\uff0c\u521b\u5efa\u4e00\u4e2aPVC\u7528\u4e8e\u6302\u8f7d\u5230pod\u4e2d\u4f7f\u7528\u3002</p> <p><code>buildcache-pvc.yml</code></p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: ci-build-cache-pv\n  namespace: gitlab-runner\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/opt/ci-build-cache\"\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: ci-build-cache-pvc\n  namespace: gitlab-runner\nspec:\n  storageClassName: manual\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n</code></pre> <p>\u4f7f\u7528\u547d\u4ee4\u67e5\u770b\u9a8c\u8bc1</p> <pre><code>kubect1 create -f buildcache-pvc.yml\n</code></pre> <pre><code># kubectl get pvc -n gitlab-runner\nNAME                 STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nci-build-cache-pvc   Bound    ci-build-cache-pv   10Gi       RWO            manual     5h41m\n</code></pre> <p>vc\u51c6\u5907\u597d\u4e86\uff0c\u8003\u8651\u5230\u4e0d\u80fd\u6bcf\u6b21\u90e8\u7f72runner\u90fd\u624b\u52a8\u6302\u8f7dpvc\uff0c\u9700\u8981\u81ea\u5b9a\u4e49gitlab-runner chart\uff0c\u4f18\u5316runner\u914d\u7f6e\u3002</p> <ul> <li>\u7b2c\u4e00\u6b65\uff1a\u7f16\u8f91value.yml\u6587\u4ef6\uff0c\u6dfb\u52a0\u6784\u5efa\u7f13\u5b58\u4fe1\u606f\u914d\u7f6e\u3002</li> </ul> <p><code>gitlab-runner/value.yml</code></p> <pre><code>## configure build cache\ncibuild:\n  cache:\n    pvcName: ci-build-cache-pvc\n    mountPath: /home/gitlab-runner/ci-build-cache\n</code></pre> <p>\u7b2c\u4e8c\u6b65\uff1a\u7f16\u8f91<code>templates/configmap.yml</code>\u6587\u4ef6\uff0c<code>entrypoint</code>\u90e8\u5206\u6dfb\u52a0<code>runner</code>\u914d\u7f6e\u3002\u5728start\u4e4b\u524d\u6dfb\u52a0\uff0c\u8fd9\u6837runner\u5728\u521b\u5efa\u6784\u5efapod\u7684\u65f6\u5019\u4f1a\u6839\u636e\u914d\u7f6e\u6302\u8f7dpvc\u3002</p> <pre><code>...\n\n# add build cache\ncat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF\n  [[runners.kubernetes.volumes.pvc]]\n  name = \"{{.Values.cibuild.cache.pvcName}}\"\n  mount_path = \"{{.Values.cibuild.cache.mountPath}}\"\nEOF\n\n# Start the runner\nexec /entrypoint run --user=gitlab-runner \\\n  --working-directory=/home/gitlab-runner\n</code></pre> <p>\u5230\u6b64gitlab-runner chart\u90e8\u5206\u914d\u7f6e\u5c31\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u53ef\u4ee5\u901a\u8fc7Helm\u547d\u4ee4\u8fdb\u884c\u521b\u5efa\u548c\u66f4\u65b0\u4e86\u3002</p> <pre><code>helm install gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\nhelm upgrade gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\n</code></pre> <p>\u4f7f\u7528\u4ee5\u4e0a\u547d\u4ee4\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5728gitlab admin\u9875\u9762\u548ck8s\u9762\u677f\u67e5\u770brunner\u7684\u72b6\u6001\uff0c\u786e\u4fdd\u90e8\u7f72\u6210\u529f\u3002\u67e5\u770bpod\u914d\u7f6e\u3002</p> <pre><code>cat /home/gitlab-runner/.gitlab-runner/config.toml\n\n....\n[[runners.kubernetes.volumes.pvc]]\nname =  \"ci-build-cache-pvc\"\nmount_path = \"/home/gitlab-runner/ci-build-cache\"\n</code></pre> <p></p> <p></p> <p></p> <p>\u90e8\u7f72\u5b8c\u6210\u4e86\uff0c\u540e\u7eed\u4f7f\u7528\u6784\u5efa\u5de5\u5177\u6253\u5305\u65f6\u6dfb\u52a0\u6307\u5b9a\u7f13\u5b58\u76ee\u5f55\u3002\u4f8b\u5982\uff1amaven</p> <pre><code>mvn clean package  -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  \n</code></pre> <p><code>.gitlba-ci.yaml</code></p> <pre><code>image: maven:3.6.3-jdk-8\n\nbefore_script:\n    - ls\n\nservices:\n    - name: mysql:latest\n        alias: mysql-1\n\nbuild:\n    image: maven:3.6.3-jdk-8\n    stage: build\n    tags:\n        - k8s\n    script:\n        - ls\n        - sleep 2\n        - mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  \n        - sleep 10\n\ndeploy:\n    stage: deploy\n    tags:\n        - k8s\n    script:\n        - echo \"deploy\"\n    environment:\n        name: production\n        ur: http://www.baidu.com\n</code></pre> <p>\u53d1\u73b0\u6784\u5efa\u901f\u5ea6\u5f88\u5feb\u8bc1\u660e\u5df2\u7ecf\u5b8c\u6210\u6784\u5efa\u7f13\u5b58\u914d\u7f6e\u3002\u53ef\u4ee5\u914d\u5408\u67e5\u770b\u672c\u5730\u7f13\u5b58\u76ee\u5f55\u662f\u5426\u6709\u66f4\u65b0\u3002</p> <p>\u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684runner \u800c\u975e\u539f\u6765\u7684gitlab-runner</p> <p></p> <p><code>cd  /ci-build-cache/maven</code></p> <p></p> <p>\u6253\u5305\u53ef\u4ee5\u5feb\u901f\u7ed3\u675f</p> <p></p>"},{"location":"chap5/1gitlab-runner-install/#3","title":"3 \u89e3\u51b3\u6784\u5efa\u5236\u54c1\u95ee\u9898","text":"<p>\u5728kubernetes\u4e2d\u5bf9cache\u652f\u6301\u4e00\u822c\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528artifacts\u8fdb\u884c\u4ee3\u66ff\u3002\u4f46\u662f\u8003\u8651\u5230artifacts\u6536\u96c6\u5236\u54c1\u4f1a\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\uff0c\u6240\u4ee5\u51c6\u5907\u7814\u7a76\u4e0b\u5982\u4f55\u914d\u7f6e\u7edf\u4e00\u7684\u7f13\u5b58\u3002\u5b9e\u9645\u4e0a\u6211\u4eec\u53ef\u4ee5\u5c06repo\u76ee\u5f55\u505a\u6210\u6301\u4e45\u5316\u3002</p> <pre><code>...\nbuild:\n    image: maven:3.6.3-jdk-8\n    stage: build\n    tags:\n        - k8s\n    script:\n        - ls\n        - sleep 2\n        - mvn clean package -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  \n        - ls target/\n\ntest:\n    image: maven:3.6.3-jdk-8\n    stage: test\n    tags:\n        - k8s\n    script:\n        - ls target/\n        - sleep 2\n        - mvn test -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  \n        - sleep 10\n</code></pre> <p>Test\u4e4b\u524d\u5df2\u7ecf\u88abclean\u6389\u4e86\uff0c test\u5931\u8d25</p> <p></p> <p></p> <p><code>demo-maven-service</code></p> <pre><code>test:\n    variables:\n        GIT_CHECKOUT: \"false\"\n    image: maven:3.6.3-jdk-8\n    stage: test\n    tags:\n        - k8s\n    script:\n        - ls target/\n        - sleep 2\n        - mvn test -DskipTests -Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven  \n        - sleep 10\n</code></pre> <p></p> <p>\u7ecf\u8fc7\u6d4b\u8bd5\uff0c\u5728\u4f7f\u7528kubernetes\u6267\u884c\u5668\u521b\u5efa\u7684\u6784\u5efapod\u4f1a\u9ed8\u8ba4\u6302\u8f7d\u4e00\u4e2a\u7a7a\u76ee\u5f55\u3002</p> <p>\u6b64\u76ee\u5f55\u7528\u4e8e\u5b58\u50a8\u6bcf\u6b21\u4e0b\u8f7d\u7684\u4ee3\u7801\uff0c\u56e0\u4e3a\u662f\u7a7a\u76ee\u5f55\u7684\u539f\u56e0\u5bfc\u81f4\u540e\u7eed\u6d4b\u8bd5pod\u65e0\u6cd5\u83b7\u53d6\u9700\u8981\u91cd\u65b0\u4e0b\u8f7d\u4ee3\u7801\uff0c\u8fd9\u8fd8\u4e0d\u8981\u7d27\uff0c\u91cd\u8981\u7684\u662f\u6784\u5efa\u751f\u6210\u7684\u6587\u4ef6target\u76ee\u5f55\u90fd\u4e0d\u5b58\u5728\u4e86\u5bfc\u81f4\u540e\u7eed\u6b65\u9aa4\u63a5\u8fde\u5931\u8d25\u3002</p> <p></p> <p>\u7531\u4e8eyaml\u6587\u4ef6\u90fd\u662f\u6709\u5b98\u65b9\u9ed8\u8ba4\u914d\u7f6e\u7684\uff0c\u95ee\u9898\u4e0d\u597d\u5b9a\u4f4d\u3002\u8fd9\u5176\u5b9e\u662f\u4e2a\u4e24\u5e74\u524d\u7684\u95ee\u9898\u4e86\u3002 https://gitlab.com/gitlab-org/gitlab-runner/-/issues/3148 \u3002\u6700\u540e\u7ecf\u8fc7\u5206\u6790\u76f4\u63a5\u5c06\u6301\u4e45\u5316\u7684pvc\u6302\u8f7d\u5230\u7a7a\u76ee\u5f55\u4e2d\u7684\u67d0\u4e2a\u76ee\u5f55\u4e2d\u3002</p> <p>\u9700\u8981\u914d\u7f6erunner\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\uff0c\u4f46\u662f\u6784\u5efa\u76ee\u5f55\u5fc5\u987b\u662f\u5728<code>$CI_BUILD_DIRS</code>\u76ee\u5f55\u91cc\u9762\u3002</p> <p></p> <p>\u51c6\u5907\u672c\u5730\u7684\u5de5\u4f5c\u76ee\u5f55</p> <pre><code>/opt/ci-build-dir\n</code></pre> <p>\u521b\u5efarepo\u6301\u4e45\u5316pvc</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: ci-build-dir-pv\n  namespace: gitlab-runner\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/opt/ci-build-dir\"\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: ci-build-dir-pvc\n  namespace: gitlab-runner\nspec:\n  storageClassName: manual\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n</code></pre> <p>\u4f7f\u7528\u547d\u4ee4\u9a8c\u8bc1</p> <pre><code># kubectl get pvc -n gitlab-runner\nNAME                 STATUS   VOLUME              CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nci-build-cache-pvc   Bound    ci-build-cache-pv   10Gi       RWO            manual         6h41m\nci-build-dir-pvc     Bound    ci-build-dir-pv     10Gi       RWO            manual         3h11m\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#valuesyaml","title":"<code>values.yaml</code>","text":"<ul> <li>\u7f16\u8bd1<code>values.yaml</code>\u6587\u4ef6\u6dfb\u52a0\u6ce8\u518c\u914d\u7f6e\u53d8\u91cf\u3002</li> <li><code>RUNNER_BUILDS_DIR</code>\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\u3002</li> <li><code>CUSTOM_BUILD_DIR_ENABLED</code>\u5f00\u542f\u81ea\u5b9a\u4e49\u6784\u5efa\u76ee\u5f55\u914d\u7f6e\u3002</li> </ul> <pre><code>envVars:\n  - name: RUNNER_BUILDS_DIR\n    value: \"/home/gitlab-runner/ci-build-dir/\"\n  - name: CUSTOM_BUILD_DIR_ENABLED\n    value: true\n</code></pre> <p>\u6dfb\u52a0repo\u76ee\u5f55\u7f13\u5b58\u914d\u7f6e\uff0c\u6211\u4eec\u628a\u81ea\u5b9a\u4e49\u7684\u6784\u5efa\u76ee\u5f55\u653e\u5230\u9ed8\u8ba4\u6784\u5efa\u76ee\u5f55\u7684\u4e0b\u9762builds\u76ee\u5f55\u4e2d\u3002</p> <pre><code>## configure build cache\ncibuild:\n  cache:\n    pvcName: ci-build-cache-pvc\n    mountPath: /home/gitlab-runner/ci-build-cache\n  builds:\n    pvcName: ci-build-dir-pvc\n    mountPath: /home/gitlab-runner/ci-build-dir/builds\n</code></pre>"},{"location":"chap5/1gitlab-runner-install/#templatesconfigmapyml","title":"\u7f16\u8f91<code>templates/configmap.yml</code>","text":"<p><code>gitlab-runner/templates/configmap.yaml</code></p> <pre><code>    # add build cache\n    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF\n      [[runners.kubernetes.volumes.pvc]]\n      name = \"{{.Values.cibuild.cache.pvcName}}\"\n      mount_path = \"{{.Values.cibuild.cache.mountPath}}\"\n      [[runners.kubernetes.volumes.pvc]]\n      name = \"{{.Values.cibuild.builds.pvcName}}\"\n      mount_path = \"{{.Values.cibuild.builds.mountPath}}\"\n    EOF\n</code></pre> <p>\u66f4\u65b0runner</p> <pre><code>helm install gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\nhelm upgrade gitlab-runner04 ./gitlab-runner --namespace gitlab-runner\n</code></pre> <pre><code>bash-5.0$ cat /home/gitlab-runner/.gitlab-runner/config.toml\n\n[[runners]]\n    name = \"gitlab-runner-gitlab-runner-7dcbd59\u20ac74-nxdnm\n    output limit = 4096\n    request_concurrency = 1\n    url = \"http://192.168.1.200:30088/\"\n    token = \"ywKfhgyp9AQkkc-bMjgC\"\n    executor = \"kubernetes\"\n    builds_dir = \"home/gitlab-runner/ci-build-dir/\"\n    [runners.custom_build_dir]\n        enabled = true\n    [runners.cache]\n        [runners.cache.s3]\n        [runners.cache.gcs]\n    ....\n    [[runners.kubernetes.volumes.pvc]]\n    name = \"ci-build-cache-pvc\"\n    mount_path =  \"/home/gitlab-runner/ci-build-cache\"\n    [[runners.kubernetes.volumes.pvc]]\n    name = \"ci-build-cache-pvc\"\n    mount_path =  \"/home/gitlab-runner/ci-build-dir/builds\"\n</code></pre> <p></p> <p><code>.gitlab-ci.yaml</code></p> <pre><code>variables:\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_I\n</code></pre> <p></p> <p></p> <p>\u7ecf\u8fc7\u6d4b\u8bd5\u5728\u672c\u5730\u7684pv\u4e2d\u80fd\u591f\u770b\u5230\uff0c\u4e0b\u8f7d\u7684\u4ee3\u7801\u6587\u4ef6\u3002\u4f46\u662f\u9ed8\u8ba4\u6bcf\u6b21\u6bcf\u4e2ajob\u8fd0\u884c\u7684\u65f6\u5019\u90fd\u4f1a\u83b7\u53d6\u8fdc\u7a0b\u6700\u65b0\u7684\u4ee3\u7801\uff0c\u4f1a\u628a\u6784\u5efa\u76ee\u5f55\u5220\u9664\u6389\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u914d\u7f6egit checkout\u7b56\u7565\u4e86\u3002\u5176\u5b9e\u6309\u7167\u6211\u4eec\u76ee\u524d\u7684\u573a\u666f\uff0c\u4e0d\u9700\u8981\u6bcf\u4e2a\u4f5c\u4e1a\u90fd\u4e0b\u8f7d\u4ee3\u7801\u3002\u53ea\u8981\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u4e0b\u8f7d\u597d\u6700\u65b0\u7684\u4ee3\u7801\uff0c\u7136\u540e\u8fd0\u884c\u6d41\u6c34\u7ebf\u5373\u53ef\u3002\u5f53\u5728\u8fd0\u884c\u6d41\u6c34\u7ebf\u7684\u8fc7\u7a0b\u4e2d\u9047\u5230\u65b0\u4ee3\u7801\u63d0\u4ea4\u53ef\u4ee5\u653e\u5230\u4e0b\u6b21\u6d41\u6c34\u7ebf\u6267\u884c\u3002</p> <p>\u9700\u8981\u5728ci\u6587\u4ef6\u4e2d\u5b9a\u4e49<code>GIT_CHECKOUT</code>\u53d8\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3atrue\uff0c\u5373\u6bcf\u6b21\u90fd\u9700\u8981\u4ee3\u7801\u4e0b\u8f7d\u3002\u6211\u4eec\u5c06\u5168\u5c40\u914d\u7f6e\u4e3afalse\u7136\u540e\u5728build\u4f5c\u4e1a\u4e2d\u914d\u7f6e\u4e3atrue\u3002\u4e5f\u5c31\u5b9e\u73b0\u4e86\u53ea\u5728build\u4f5c\u4e1a\u4e0b\u8f7d\u6700\u65b0\u4ee3\u7801\u4e86\u3002</p> <pre><code>GIT_CHECKOUT: \"false\" \n</code></pre> <p></p> <ul> <li>\u53c2\u8003\u94fe\u63a5\uff1ahttp://s0docs0gitlab0com.icopy.site/ee/ci/yaml/README.html#git-checkout</li> </ul>"},{"location":"chap5/2gitlab_k8s/","title":"2 Kubernetes \u5bb9\u5668\u6d41\u6c34\u7ebf","text":""},{"location":"chap5/2gitlab_k8s/#_1","title":"\u5bb9\u5668\u8fd0\u884c\u6d41\u6c34\u7ebf","text":"<ul> <li>build</li> </ul> <pre><code>build:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  tags:\n    - k8s\n  image: maven:3.6.3-jdk-8\n  stage: build\n  extends: .build\n  rules:\n    - when: on_success\n  after_script:\n    - ls target/\n</code></pre> <ul> <li>test</li> </ul> <pre><code>test:\n  before_script:\n    - ls target/\n  tags:\n    - k8s\n  image: maven:3.6.3-jdk-8\n  stage: test\n  extends: .test\n  rules:\n    - when: on_success\n  after_script:\n    - ls target/\n</code></pre> <ul> <li><code>code_analysis</code></li> </ul> <pre><code>code_analysis:\n  tags:\n    - k8s\n  image: sonarsource/sonar-scanner-cli:latest\n  stage: parallel01\n  script:\n    - ls target/\n    - echo $CI_MERGE_REQUEST_IID $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME\n    - \"sonar-scanner -Dsonar.projectKey=${CI_PROJECT_NAME} \\\n                  -Dsonar.projectName=${CI_PROJECT_NAME} \\\n                  -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \\\n                  -Dsonar.ws.timeout=30 \\\n                  -Dsonar.projectDescription=${CI_PROJECT_TITLE} \\\n                  -Dsonar.links.homepage=${CI_PROJECT_URL} \\\n                  -Dsonar.sources=${SCAN_DIR} \\\n                  -Dsonar.sourceEncoding=UTF-8 \\\n                  -Dsonar.java.binaries=target/classes \\\n                  -Dsonar.java.test.binaries=target/test-classes \\\n                  -Dsonar.java.surefire.report=target/surefire-reports \\\n                  -Dsonar.host.url=http://192.168.1.200:30090 \\\n                  -Dsonar.login=ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b \\\n                  -Dsonar.branch.name=${CI_COMMIT_REF_NAME}\" \n</code></pre> <ul> <li><code>build_image</code></li> </ul> <pre><code>build_image:\n  before_script:\n    - ls target/\n  tags:\n    - k8s\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n</code></pre>"},{"location":"chap5/2gitlab_k8s/#faq","title":"FAQ: \u53ef\u80fd\u9047\u5230\u7684\u95ee\u9898","text":"<pre><code>$ docker build -t ${IMAGE_NAME} -f ${DOCKER_FILE_PATH} .\n Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?\n time=\"2020-05-12T01:41:07Z\" level=error msg=\"failed to dial gRPC: cannot connect to the Docker daemon. Is 'docker daemon' running on this host?: dial unix /var/run/docker.sock: connect: no such file or directory\"\n</code></pre> <p>\u6dfb\u52a0 runner\u914d\u7f6e</p> <pre><code># add build cache \n    cat &gt;&gt;/home/gitlab-runner/.gitlab-runner/config.toml &lt;&lt;EOF\n      [[runners.kubernetes.volumes.pvc]]\n      name = \"{{.Values.cibuild.cache.pvcName}}\"\n      mount_path = \"{{.Values.cibuild.cache.mountPath}}\"\n      [[runners.kubernetes.volumes.pvc]]\n      name = \"{{.Values.cibuild.builds.pvcName}}\"\n      mount_path = \"{{.Values.cibuild.builds.mountPath}}\"\n      [[runners.kubernetes.volumes.host_path]]\n      name = \"docker\"\n      mount_path = \"/var/run/docker.sock\"\n    EOF\n</code></pre>"},{"location":"chap5/2gitlab_k8s/#k8s-deploy","title":"K8S deploy","text":"<pre><code>deploy_k8s:\n  image: lucj/kubectl:1.17.2\n  tags:\n    - k8s\n    - kubernetes-runner\n  stage: deploy\n  script:\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" deployment.yaml \n    - sed -i \"s#__appname__#${APP_NAME}#g\" deployment.yaml \n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" deployment.yaml \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" deployment.yaml \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" deployment.yaml \n    - cat deployment.yaml\n    - kubectl apply -f deployment.yaml  \n  environment:\n    name: $ENV_NAME\n    url: $ENV_URL\n</code></pre> <p><code>interface_test</code></p> <pre><code>interfact_test:\n  inherit:\n    variables: false\n  stage: interface_test\n  extends: .interfacetest\n</code></pre>"},{"location":"chap5/3gitlab_notification/","title":"3 Kubernetes \u6d41\u6c34\u7ebf\u6784\u5efa\u6d88\u606f\u901a\u77e5","text":""},{"location":"chap5/3gitlab_notification/#pipeline-email","title":"Pipeline email","text":"<p>\u7f16\u8f91<code>/etc/gitlab/gitlab.rb</code>\u6587\u4ef6\u5f00\u542fgitlab email\u3002\u8fd9\u91cc\u4ee5QQ\u90ae\u7bb1\u4e3a\u4f8b</p> <pre><code>### GitLab email server settings\n###! Docs: https://docs.gitlab.com/omnibus/settings/smtp.html\n###! **Use smtp instead of sendmail/postfix.**\n\ngitlab_rails['smtp_enable'] = true\ngitlab_rails['smtp_address'] = \"smtp.qq.com\"\ngitlab_rails['smtp_port'] = 465\ngitlab_rails['smtp_user_name'] = \"xxxxx@qq.com\"\ngitlab_rails['smtp_password'] = \"xxxxxx\"\ngitlab_rails['smtp_domain'] = \"smtp.qq.com\"\ngitlab_rails['smtp_authentication'] = \"login\"\ngitlab_rails['smtp_enable_starttls_auto'] = true\ngitlab_rails['smtp_tls'] = true\n\n### Email Settings\ngitlab_rails['gitlab_email_enabled'] = true\ngitlab_rails['gitlab_email_from'] = 'xxxxx@qq.com'\ngitlab_rails['gitlab_email_display_name'] = 'GitLab Admin'\n</code></pre> <p>\u91cd\u65b0\u914d\u7f6e</p> <pre><code>gitlab-ctl stop\ngitlab-ctl reconfigure\ngitlab-ctl start\ngitlab-ctl status\n</code></pre> <p>\u767b\u5f55<code>gitlab-rails</code>\u63a7\u5236\u53f0\uff0c\u53d1\u9001\u6d4b\u8bd5\u90ae\u4ef6\u3002</p> <pre><code>su - git\ngitlab-rails console\n\nirb(main):002:0&gt; Notify.test_email('2560350642@qq.com', 'test email', 'gitlab email test').deliver_now\n\n\nNotify#test_email: processed outbound mail in 0.5ms\nDelivered mail 5eba1b04de4e5_12903fe2ca0c79b0519ec@gitlab-995f97976-2nmb4.mail (1055.9ms)\nDate: Tue, 12 May 2020 03:41:56 +0000\nFrom: GitLab Admin &lt;xxxxxxxx@qq.com&gt;\nReply-To: GitLab Admin &lt;noreply@192.168.1.200&gt;\nTo: 2560350642@qq.com\nMessage-ID: &lt;5eba1b04de4e5_12903fe2ca0c79b0519ec@gitlab-995f97976-2nmb4.mail&gt;\nSubject: Message Subject\nMime-Version: 1.0\nContent-Type: text/html;\n charset=UTF-8\nContent-Transfer-Encoding: 7bit\nAuto-Submitted: auto-generated\nX-Auto-Response-Suppress: All\n\n&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\" \"http://www.w3.org/TR/REC-html40/loose.dtd\"&gt;\n&lt;html&gt;&lt;body&gt;&lt;p&gt;Message Body And Linuxea.com&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;\n\n=&gt; #&lt;Mail::Message:70243016426420, Multipart: false, Headers: &lt;Date: Tue, 12 May 2020 03:41:56 +0000&gt;, &lt;From: GitLab Admin &lt;2560350642@qq.com&gt;&gt;, &lt;Reply-To: GitLab Admin &lt;noreply@192.168.1.200&gt;&gt;, &lt;To: xxxxxx@qq.com&gt;, &lt;Message-ID: &lt;5eba1b04de4e5_12903fe2ca0c79b0519ec@gitlab-995f97976-2nmb4.mail&gt;&gt;, &lt;Subject: Message Subject&gt;, &lt;Mime-Version: 1.0&gt;, &lt;Content-Type: text/html; charset=UTF-8&gt;, &lt;Content-Transfer-Encoding: 7bit&gt;, &lt;Auto-Submitted: auto-generated&gt;, &lt;X-Auto-Response-Suppress: All&gt;&gt;\n</code></pre> <p></p> <p>\u8fdb\u5165\u9879\u76ee -&gt; settings -&gt; \u96c6\u6210</p> <p></p> <p>\u914d\u7f6e\u90ae\u4ef6\u901a\u77e5\u4eba\u3001\u901a\u77e5\u6761\u4ef6</p> <p></p> <p>\u8fd0\u884c\u6d41\u6c34\u7ebf\u6d4b\u8bd5</p> <p></p>"},{"location":"chap5/3gitlab_notification/#_1","title":"\u9489\u9489\u901a\u77e5","text":"<p>\u521b\u5efa\u7fa4\uff0c\u7fa4\u673a\u5668\u4eba\uff0c\u83b7\u53d6hookurl</p> <pre><code>dingding:\n  stage: .post\n  script:\n    - \" curl 'https://oapi.dingtalk.com/robot/send?access_token=46ccc==46580ea7619b108b179' \\\n        -H 'Content-Type: application/json' \\\n        -d '{\\\"msgtype\\\": \\\"text\\\",\\\"text\\\": {\\\"content\\\": \\\"CICD\u6211\u5c31\u662f\u6211, \u662f\u4e0d\u4e00\u6837\u7684\u70df\u706b @1xxxx2\\\"},\\\"at\\\": {\\\"atMobiles\\\": [\\\"15xxxxx72\\\"], \\\"isAtAll\\\": false}}'\"\n</code></pre> <p>\u53c2\u8003\u6587\u6863\uff1ahttps://ding-doc.dingtalk.com/doc#/serverapi2/qf2nxq</p> <p></p>"},{"location":"chap5/4gitlab_distri_storage/","title":"4 Gitlab + minio \u914d\u7f6e\u4f7f\u7528\u5206\u5e03\u5f0f\u7f13\u5b58","text":""},{"location":"chap5/4gitlab_distri_storage/#minio","title":"minio","text":"<p>MinIO \u662f\u4e00\u4e2a\u57fa\u4e8eApache License v2.0\u5f00\u6e90\u534f\u8bae\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\u3002</p> <p>\u5b83\u517c\u5bb9\u4e9a\u9a6c\u900aS3\u4e91\u5b58\u50a8\u670d\u52a1\u63a5\u53e3\uff0c\u975e\u5e38\u9002\u5408\u4e8e\u5b58\u50a8\u5927\u5bb9\u91cf\u975e\u7ed3\u6784\u5316\u7684\u6570\u636e\uff0c\u4f8b\u5982\u56fe\u7247\u3001\u89c6\u9891\u3001\u65e5\u5fd7\u6587\u4ef6\u3001\u5907\u4efd\u6570\u636e\u548c\u5bb9\u5668/\u865a\u62df\u673a\u955c\u50cf\u7b49\uff0c\u800c\u4e00\u4e2a\u5bf9\u8c61\u6587\u4ef6\u53ef\u4ee5\u662f\u4efb\u610f\u5927\u5c0f\uff0c\u4ece\u51e0kb\u5230\u6700\u59275T\u4e0d\u7b49\u3002</p> <p>MinIO\u662f\u4e00\u4e2a\u975e\u5e38\u8f7b\u91cf\u7684\u670d\u52a1,\u53ef\u4ee5\u5f88\u7b80\u5355\u7684\u548c\u5176\u4ed6\u5e94\u7528\u7684\u7ed3\u5408\uff0c\u7c7b\u4f3c NodeJS, Redis \u6216\u8005 MySQL\u3002</p> <p>\u5b98\u65b9\u6587\u6863\uff1ahttps://docs.min.io/cn/deploy-minio-on-kubernetes.html</p>"},{"location":"chap5/4gitlab_distri_storage/#kubernetes","title":"\u57fa\u4e8eKubernetes\u90e8\u7f72","text":"<p>\u51c6\u5907\u4e00\u4e2apv\u7528\u4e8e\u5b58\u50a8bucket\u6570\u636e\u3002\u8fd9\u91cc\u6211\u4f7f\u7528\u7684\u662f\u672c\u5730\u7684\u76ee\u5f55<code>\u201d/data/devops/minio-data\u201d</code>\uff0c\u6839\u636e\u5927\u5bb6\u4e0d\u540c\u7684\u73af\u5883\u6309\u9700\u8c03\u6574\u5373\u53ef\u3002</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: ci-minio-pv\n  namespace: devops\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 50Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/data/devops/minio-data\"\n---\n</code></pre> <pre><code>kubectl create -f pv.yaml\nkubectl get pv -n devops\n</code></pre>"},{"location":"chap5/4gitlab_distri_storage/#helm-install","title":"Helm Install","text":"<p>stable/minio 3.0.3 \u662f\u76ee\u524d\u6700\u65b0\u7684RELEASE\u7248\u672c</p> <p>\u4fee\u6539<code>minio/values.yml</code>\u4e2d\u7684service\u7aef\u53e3\u4e3a80\u3002(\u53ef\u9009)</p> <pre><code>service:\n  type: ClusterIP\n  clusterIP: ~\n  port: 80\n  nodePort: 31311\n  # externalIPs:\n  #   - externalIp1\n  annotations: {}\n</code></pre> <p>\u4fee\u6539minio/values.yml\u4e2d\u7684Ingress\u914d\u7f6e\u3002</p> <pre><code>ingress:\n  enabled: true\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    # kubernetes.io/tls-acme: \"true\"\n    # kubernetes.io/ingress.allow-http: \"false\"\n    # kubernetes.io/ingress.global-static-ip-name: \"\"\n    # nginx.ingress.kubernetes.io/secure-backends: \"true\"\n    # nginx.ingress.kubernetes.io/backend-protocol: \"HTTPS\"\n    # nginx.ingress.kubernetes.io/whitelist-source-range: 0.0.0.0/0\n  path: /\n  hosts:\n    - minio.devops.svc.cluster.local\n  tls: []\n</code></pre> <pre><code>helm install minio --namespace=devops --set persistence.size=50Gi,persistence.VolumeName=ci-minio-pv,persistence.storageClass=manual ./minio  \n</code></pre> <ul> <li><code>persistence.size=50Gi</code> \u914d\u7f6ePV\u7684\u5927\u5c0f\u4e3a50Gi</li> <li><code>persistence.VolumeName=ci-minio-pv</code> \u6307\u5b9a\u5df2\u5b58\u5728pv\u540d\u79f0</li> <li><code>persistence.storageClass=manual</code> \u6307\u5b9apv\u5b58\u50a8\u7684\u7c7b\u578b\u4e3amanual</li> </ul> <p>\u90e8\u7f72\u6210\u529f\u4f1a\u63d0\u793a\u7c7b\u4f3c\u4ee5\u4e0b\u4fe1\u606f</p> <pre><code>NOTES:\nMinio can be accessed via port 80 on the following DNS name from within your cluster:\nminio.devops.svc.cluster.local\n\nTo access Minio from localhost, run the below commands:\n\n  1. export POD_NAME=$(kubectl get pods --namespace devops -l \"release=minio\" -o jsonpath=\"{.items[0].metadata.name}\")\n\n  2. kubectl port-forward $POD_NAME 9000 --namespace devops\n\nRead more about port forwarding here: http://kubernetes.io/docs/user-guide/kubectl/kubectl_port-forward/\n\nYou can now access Minio server on http://localhost:9000. Follow the below steps to connect to Minio server with mc client:\n\n  1. Download the Minio mc client - https://docs.minio.io/docs/minio-client-quickstart-guide\n\n  2. mc config host add minio-local http://localhost:9000 AKIAIOSFODNN7EXAMPLE wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY S3v4\n\n  3. mc ls minio-local\n\nAlternately, you can use your browser or the Minio SDK to access the server - https://docs.minio.io/categories/17\n</code></pre>"},{"location":"chap5/4gitlab_distri_storage/#_1","title":"\u8bbf\u95ee\u9a8c\u8bc1","text":"<p>\u6dfb\u52a0hosts\u89e3\u6790\u6d4b\u8bd5</p> <pre><code>192.168.1.200 minio.devops.svc.cluster.local\n</code></pre> <p></p>"},{"location":"chap5/4gitlab_distri_storage/#bucket","title":"\u521b\u5efabucket","text":""},{"location":"chap5/4gitlab_distri_storage/#runners3","title":"\u914d\u7f6eRunner\u4f7f\u7528S3\u5b58\u50a8","text":"<p>\u5b98\u65b9\u7684runner \u914d\u7f6e examples\u662f\u8fd9\u6837\u914d\u7f6e\u7684\uff0c\u6307\u5b9aS3\u5b58\u50a8\u76f8\u5173\u4fe1\u606f\u3002</p> <p>\u53c2\u8003\u6587\u6863\uff1ahttps://docs.gitlab.com/runner/configuration/autoscale.html#distributed-runners-caching</p> <pre><code>[[runners]]\n  limit = 10\n  executor = \"docker+machine\"\n  [runners.cache]\n    Type = \"s3\"\n    Path = \"path/to/prefix\"\n    Shared = false\n    [runners.cache.s3]\n      ServerAddress = \"s3.example.com\"\n      AccessKey = \"access-key\"\n      SecretKey = \"secret-key\"\n      BucketName = \"runner\"\n      Insecure = false\n</code></pre> <p>\u5982\u679c\u60a8\u76f4\u63a5\u4f7f\u7528\u7684vm\u6216\u8005docker\u5b89\u88c5\u7684runner\uff0c\u53ef\u4ee5\u76f4\u63a5\u66f4\u65b0runner\u7684\u914d\u7f6e\u6587\u4ef6\u586b\u5199S3\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662fKuberntes\u73af\u5883\u90e8\u7f72\u7684runner\u5219\u9700\u8981\u6839\u636e\u4ee5\u4e0b\u914d\u7f6e\u6765\u4fee\u6539Helm chart\u3002</p> <p>\u6b65\u9aa41\uff1a\u521b\u5efa\u4e00\u4e2asecret\u4fdd\u5b58S3\u7684\u8ba4\u8bc1\u4fe1\u606f\uff0c\u7531\u4e8e\u6211\u7684runner\u5728gitlab-runner\u540d\u79f0\u7a7a\u95f4\uff0c\u6240\u4ee5\u8fd9\u91cc\u6307\u5b9a\u7684\u4e5f\u662f\u540c\u6837\u7684\u3002</p> <pre><code>kubectl create secret generic s3access --namespace=gitlab-runner --from-literal=accesskey=\"AKIAIOSFODNN7EXAMPLE\" --from-literal=secretkey=\"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY\"\n</code></pre> <p>\u6b65\u9aa42\uff1a \u7f16\u8f91helm chart \u4e2d\u7684values.yml\u6587\u4ef6\uff0c\u586b\u5199S3\u914d\u7f6e\u4fe1\u606f\u3002</p> <pre><code>cache:\n    ## General settings\n    cacheType: s3\n    cachePath: \"gitlab-runner\"\n    cacheShared: true\n\n    ## S3 settings\n    s3ServerAddress: minio.devops.svc.cluster.local\n    s3BucketName: gitlab-ci-runner-cache\n    s3BucketLocation:\n    s3CacheInsecure: false\n    secretName: s3access\n</code></pre> <ul> <li>cacheType\uff1a \u7f13\u5b58\u7684\u7c7b\u578b\uff0c\u6307\u5b9as3</li> <li>cachePath\uff1a\u7f13\u5b58\u8def\u5f84\uff0c\u503c\u5f97\u662fbucket\u4e2d\u7684\u76ee\u5f55\u3002\u53ef\u4ee5\u81ea\u5b9a\u4e49\u3002</li> <li>CacheShared\uff1a\u662f\u5426\u5171\u4eab\uff0c\u5982\u679c\u5b58\u5728\u591a\u4e2arunner\u5219\u9700\u8981\u5f00\u542f\u3002</li> <li>s3ServerAddress\uff1a S3\u670d\u52a1\u5668\u5730\u5740\uff0cminio\u57df\u540d\u3002</li> <li>s3BucketName\uff1a S3 bucket\u7684\u540d\u79f0\uff0c\u53c2\u8003\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684\u540d\u79f0\u3002</li> <li>s3BucketLocation\uff1a Location \u9ed8\u8ba4\u5373\u53ef\uff0c\u53ef\u9009\u3002</li> <li>s3CacheInsecure\uff1a\u662f\u5426\u4f7f\u7528https\u3002(\u8fd9\u91cc\u5b98\u65b9chart\u6709\u95ee\u9898\uff0c\u914d\u7f6e\u7684\u662f\u4e0d\u7ba1\u662ftrue\u8fd8\u662ffalse\u90fd\u662ftrue\uff0c\u540e\u9762\u4f1a\u4fee\u6539)</li> <li>secretName\uff1a\u51ed\u636e\u540d\u79f0\uff0c \u6211\u4eec\u5728\u4e0a\u9762\u521b\u5efa\u7684s3\u51ed\u636e\u3002</li> </ul> <p>\u5c0f\u95ee\u9898\uff1a \u53d1\u73b0s3CacheInsecure\u8bbe\u7f6erunner \u914d\u7f6e Insecure\u6ca1\u6709\u751f\u6548\uff0c\u89e3\u51b3\u65b9\u6cd5\u3002</p> <ul> <li>\u65b9\u5f0f\u4e00\uff1a \u58f0\u660e\u73af\u5883\u53d8\u91cf\uff08\u4e0d\u751f\u6548\uff0c\u653e\u5f03\uff09</li> </ul> <pre><code>--cache-s3-insecure       Use insecure mode (without https) [$CACHE_S3_INSECURE]\n</code></pre> <pre><code>envVars:\n  - name: CACHE_S3_INSECURE\n    value: false\n</code></pre> <ul> <li>\u65b9\u5f0f\u4e8c\uff1a\u4fee\u6539\u6587\u4ef6<code>templates/_cache.tpl</code></li> </ul> <p>\u5b98\u65b9\u914d\u7f6e\u7684\u662f \u8fd9\u4e2a\u503c\u5982\u679c\u4e3atrue \u5219\u4e3atrue \uff0c\u90a3\u5982\u679c\u6211\u4eec\u8981\u8bbe\u7f6efalse\u5462\uff1f \u5f88\u660e\u663e\u6ca1\u6709\u914d\u7f6e\u4e86~~~\u3002</p> <pre><code> 18 {{-       if .Values.runners.cache.s3CacheInsecure }}\n 19 - name: CACHE_S3_INSECURE\n 20   value: \"true\"\n 21 {{-       end }}\n</code></pre> <p>\u6539\u6210\u4e0b\u9762\u7684\u914d\u7f6e\uff0c\u5373\u4e0d\u52a0\u6761\u4ef6\u5224\u65ad\uff0c\u6839\u636e<code>s3CacheInsecure</code> \u5b9e\u9645\u7684\u53c2\u6570\u503c\u3002</p> <pre><code>- name: CACHE_S3_INSECURE\n  value: {{ default \"\" .Values.runners.cache.s3CacheInsecure | quote }}\n</code></pre> <p>ok\uff0c\u4e0a\u9762\u6211\u4eec\u9047\u5230\u4e86\u4e00\u4e9b\u5c0f\u95ee\u9898\uff0c\u4f46\u90fd\u901a\u8fc7\u81ea\u5b9a\u4e49helmchart \u89e3\u51b3\u4e86\u3002 \u63a5\u4e0b\u6765\u66f4\u65b0\u6211\u4eec\u7684runner \u914d\u7f6e\u3002</p> <pre><code>helm upgrade gitlab-runner ./gitlab-runner --namespace gitlab-runner\n</code></pre> <p>\u66f4\u65b0\u5b8c\u6210\uff0c\u6211\u4eec\u5728pod\u4e2d\u67e5\u770brunner\u914d\u7f6e\u6587\u4ef6\u662f\u5426\u6b63\u5e38\u3002\u5927\u5bb6\u53ef\u4ee5\u53c2\u8003\u4ee5\u4e0b\u56fe\u7247\u4e3a\u6b63\u5e38\u7684\u3002</p> <p></p>"},{"location":"chap5/4gitlab_distri_storage/#_2","title":"\u8fd0\u884c\u6d41\u6c34\u7ebf\u6d4b\u8bd5","text":"<p>\u8fd9\u6761\u6d41\u6c34\u7ebf\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u8fd9\u6837\u914d\u7f6e\uff1a \u8bbe\u8ba1\u4e24\u4e2a\u6b65\u9aa4\uff0cbuild\uff0ctest\u3002 build\u6253\u5305\u540e\u4f1a\u4ea7\u751ftarget\u76ee\u5f55\u3002\u9ed8\u8ba4\u5728\u4e0d\u914d\u7f6e\u5168\u5c40\u7f13\u5b58\u7684\u60c5\u51b5\u4e0btest\u4f5c\u4e1a\u6267\u884c\u7684\u65f6\u5019\u662f\u6ca1\u6709target\u76ee\u5f55\u7684\u3002</p> <pre><code>cache:\n  paths:\n    - target/\nbuild:\n  stage: build\n  script:\n    - mvn clean package\n    - ls \n\ntest:\n  stage: test\n  script:\n    - ls \n    - ls target/\n</code></pre> <p>build\u4f5c\u4e1a\u5f00\u59cb\u8fd0\u884c\uff0c\u83b7\u53d6\u7f13\u5b58\u3002\u53d1\u73b0\u7f13\u5b58\u4e0d\u5b58\u5728\uff0c\u8fd0\u884c\u4efb\u52a1\u3002</p> <p></p> <p>build\u4f5c\u4e1a\u6267\u884c\u5b8c\u6210\uff0c\u6536\u96c6\u7f13\u5b58\u5230S3\u3002</p> <p></p> <p>test\u4f5c\u4e1a\u5f00\u59cb\u8fd0\u884c\uff0c\u53d1\u73b0build\u4f5c\u4e1a\u4ea7\u751f\u7684\u7f13\u5b58\u3002</p> <p></p> <p>test\u4f5c\u4e1a\u8fd0\u884c\u5b8c\u6210\uff0c\u4e0a\u4f20\u7f13\u5b58\u5230S3\u3002</p> <p></p> <p>OK\uff0c\u5230\u8fd9\u91ccS3\u7f13\u5b58\u5df2\u7ecf\u914d\u7f6e\u5b8c\u6210\u4e86\u3002 \u6211\u4eec\u53ef\u4ee5\u5728minio\u670d\u52a1\u4e2d\u67e5\u770b\u751f\u6210\u7684\u6570\u636e\u3002</p> <p></p> <p></p> <p>\u8fde\u63a5\u8d85\u65f6\u95ee\u9898\uff0c\u8fd9\u4e2a\u95ee\u9898\u4e0erunners 3CacheInsecure\u914d\u7f6e\u53c2\u6570\u6709\u5173\u3002\u53ef\u4ee5\u53c2\u8003\u4e0a\u9762\u6b65\u9aa4\u89e3\u51b3\u3002\u4f7f\u7528http\u6a21\u5f0f\u5373\u53ef\u3002</p> <pre><code>Restoring cache\n Checking cache for default-1...\n WARNING: Retrying...                                error=Get https://minio.devops.svc.cluster.local/gitlab-ci-runner-cache/gitlab-runner/project/20/default-1?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAIOSFODNN7EXAMPLE%2F20200516%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20200516T061458Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=b604bdfdda3b26286e714ed3a4073c103f6216f13b4efb12a0c76734160b1fde: dial tcp 10.1.117.2:443: i/o timeout\n WARNING: Retrying...                                error=Get https://minio.devops.svc.cluster.local/gitlab-ci-runner-cache/gitlab-runner/project/20/default-1?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAIOSFODNN7EXAMPLE%2F20200516%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20200516T061458Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=b604bdfdda3b26286e714ed3a4073c103f6216f13b4efb12a0c76734160b1fde: dial tcp 10.1.117.2:443: i/o timeout\n FATAL: Get https://minio.devops.svc.cluster.local/gitlab-ci-runner-cache/gitlab-runner/project/20/default-1?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=[FILTERED]&amp;X-Amz-Date=20200516T061458Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=[FILTERED] dial tcp 10.1.117.2:443: i/o timeout \n</code></pre>"},{"location":"chap6/1pip_init/","title":"1 \u6d41\u6c34\u7ebf\u8bbe\u8ba1\u53ca\u63d0\u4ea4","text":""},{"location":"chap6/1pip_init/#1_1","title":"1 \u6d41\u6c34\u7ebf\u8bbe\u8ba1\u89c4\u5212","text":"<p>\u5de5\u4f5c\u6d41</p> <p></p> <p>\u521b\u5efaissue \u2013&gt; \u521b\u5efa\u7279\u6027\u5206\u652f \u2013&gt; \u7279\u6027\u5206\u652f\u63d0\u4ea4\u6d41\u6c34\u7ebf \u2013&gt; \u5408\u5e76\u5206\u652f\u6d41\u6c34\u7ebf \u2013&gt; \u53d1\u5e03\u5206\u652f\u6d41\u6c34\u7ebf</p> <ol> <li>\u521b\u5efaissues\u5173\u8054\u7279\u6027\u5206\u652f \uff08\u7279\u5f81\u4ee5\u6570\u5b57\u5f00\u5934\u7684\u5206\u652f\u4e3a\u7279\u6027\u5206\u652f\uff09</li> <li>\u7279\u6027\u5206\u652f\u63d0\u4ea4\u4ee3\u7801\uff0c\u89e6\u53d1\u63d0\u4ea4\u6d41\u6c34\u7ebf\uff08\u6784\u5efa\u9a8c\u8bc1\u90e8\u7f72\u5230\u7279\u6027\u73af\u5883\uff09</li> <li>\u7279\u6027\u73af\u5883\u9a8c\u8bc1\u5b8c\u6210\uff0c\u5408\u5e76\u5230RELEASE\u5206\u652f\u3002\uff08\u89e6\u53d1\u5408\u5e76\u6d41\u6c34\u7ebf\u8fdb\u884c\u4ee3\u7801\u626b\u63cf\uff0c\u6d41\u6c34\u7ebf\u6210\u529f\u624d\u80fd\u5408\u5e76\uff09</li> <li>RELEASE\u5206\u652f\u624b\u52a8\u53d1\u5e03 \uff08UAT\uff0cSTAG\uff0cPROD\uff09</li> <li>\u751f\u4ea7\u53d1\u5e03\u5b8c\u6210\u540eRELEASE\u5206\u652f\u5408\u5e76\u5230Master\u5206\u652f\uff0c\u5e76\u57fa\u4e8emaster\u5206\u652f\u521b\u5efaRelease tag\u3002</li> </ol>"},{"location":"chap6/1pip_init/#gitlab-flow","title":"GitLab Flow","text":"<ul> <li>http://dockone.io/article/2350 11\u4e2a\u539f\u5219</li> <li>https://www.jianshu.com/p/bb94ebfe883b gitlab\u4e0amilestone\u548cissues\u7684\u7b80\u5355\u4f7f\u7528</li> </ul>"},{"location":"chap6/1pip_init/#2","title":"2 \u9700\u6c42\u90e8\u5206\u51c6\u5907\u5de5\u4f5c","text":"<p>\u521b\u5efa\u91cc\u7a0b\u7891</p> <p></p> <p></p> <p>\u521b\u5efaissue</p> <p></p> <p></p>"},{"location":"chap6/1pip_init/#3","title":"3 \u6d41\u6c34\u7ebf\u8bbe\u8ba1\u51c6\u5907\u5de5\u4f5c","text":""},{"location":"chap6/1pip_init/#1-java","title":"1. \u51c6\u5907java\u9879\u76ee","text":"<p>github \uff1a https://github.com/zeyangli/gitlabci-cidevops-java-service</p>"},{"location":"chap6/1pip_init/#2_1","title":"2. \u51c6\u5907\u6a21\u677f\u5e93","text":"<p>https://github.com/zeyangli/gitlabci-templates</p> <p></p>"},{"location":"chap6/1pip_init/#3-runner","title":"3. \u51c6\u5907\u53ef\u7528\u7684runner","text":"<p>\u6839\u636e\u4e4b\u524d\u5185\u5bb9\u5b89\u88c5\u90e8\u7f72runner</p> <p>chart \uff1a https://github.com/zeyangli/gitlabci-runner-chart-k8s</p>"},{"location":"chap6/1pip_init/#4ci","title":"4.\u8bbe\u7f6e\u9879\u76eeCI\u6587\u4ef6","text":""},{"location":"chap6/2pip_design/","title":"2 \u63d0\u4ea4\u6d41\u6c34\u7ebf\u8bbe\u8ba1","text":"<p>\u5f00\u53d1\u4eba\u5458\u5728\u7279\u6027\u5206\u652f\u63d0\u4ea4\u4ee3\u7801\uff0c\u89e6\u53d1\u63d0\u4ea4\u6d41\u6c34\u7ebf\u8fdb\u884c\u4ee3\u7801\u9a8c\u8bc1\u5e76\u53d1\u5e03\u5230\u7279\u6027\u73af\u5883\u9a8c\u8bc1\uff08\u53ef\u624b\u52a8\u63a7\u5236\u53d1\u5e03\uff09\u3002</p> <p>\u9636\u6bb5\uff1a \u7f16\u8bd1\uff0c\u6d4b\u8bd5\uff0c\u626b\u63cf\uff0c\u6784\u5efa\u955c\u50cf\uff0c\u4e0a\u4f20\u955c\u50cf\uff0c\u53d1\u5e03\u7279\u6027\u73af\u5883</p> <p>\u7279\u6027\u73af\u5883\uff1a \u547d\u540d\u89c4\u8303\u4e3a\u9879\u76ee\u540d\u79f0-ID-\u5206\u652f\u540d\u79f0\uff0c\u6bcf\u4e2a\u7279\u6027\u5206\u652f\u53d1\u5e03\u5230\u5bf9\u5e94\u7684\u7279\u6027\u73af\u5883\u3002</p> <p>\u955c\u50cf\u540d\u79f0\uff1a</p> <pre><code>registry.cn-beijing.aliyuncs.com/cidevops/cidevops-java-service:3-input-error-a486c590-834\n</code></pre> <p>ingress\u57df\u540d\uff1a</p> <pre><code>\"http://${CI_COMMIT_REF_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n</code></pre>"},{"location":"chap6/2pip_design/#_1","title":"\u9636\u6bb5\u4efb\u52a1","text":""},{"location":"chap6/2pip_design/#build","title":"Build\u9636\u6bb5","text":"<p>\u5b9a\u4e49build\u4f5c\u4e1a\u6a21\u677f\uff0c\u53c2\u6570\u5316\u6784\u5efa\u547d\u4ee4\u3002</p> <pre><code>## build\u76f8\u5173\u4f5c\u4e1a\n##\n\n.build:\n  stage: build\n  script: \n    - ${BUILD_SHELL}\n</code></pre> <p>\u5728template\u4e2d\u5f15\u5165build\u4f5c\u4e1a\u6a21\u677f\uff0c\u7531\u4e8e\u4f7f\u7528\u5bb9\u5668\u6784\u5efa\u6240\u4ee5\u58f0\u660e<code>MAVEN_IMAGE</code>\u53d8\u91cf\u5b9a\u4e49\u955c\u50cf\u540d\u79f0\u3002</p> <p>\u7531\u4e8e\u4e4b\u524d\u5bf9\u6784\u5efa\u73af\u5883\u6784\u5efa\u76ee\u5f55\u6301\u4e45\u5316\uff0c</p> <ul> <li>\u6240\u4ee5\u5b9a\u4e49<code>GIT_CLONE_PATH</code>\u53c2\u6570\u8fdb\u5165\u6307\u5b9a\u7684\u6784\u5efa\u76ee\u5f55\u64cd\u4f5c\u3002</li> <li><code>GIT_CHECKOUT</code>\u8bbe\u7f6e\u5168\u5c40\u6bcf\u4e2a\u4f5c\u4e1a\u65e0\u9700\u91cd\u590d\u4e0b\u8f7d\u4ee3\u7801\u3002</li> <li><code>BUILD_SHELL</code>\u5b9a\u4e49\u6784\u5efa\u6240\u9700\u8981\u7684\u547d\u4ee4\u3002</li> </ul> <p>\u5b9a\u4e49\u53d8\u91cf\u80fd\u591f\u8db3\u591f\u7075\u6d3b\uff0c\u9002\u5408\u4e0d\u540c\u9879\u76ee\u4e0d\u540c\u6253\u5305\u547d\u4ee4\u7684\u573a\u666f\u4e0b\u3002</p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n\n\nvariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID    \n  GIT_CHECKOUT: \"false\"\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"maven:3.6.3-jdk-8\"\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven \"\n  BUILD_SHELL: 'mvn clean package  -DskipTests  --settings=./settings.xml '  ##\u6784\u5efa\u547d\u4ee4\n\n\n\n## \u8fd0\u884c\u9636\u6bb5  \nstages:\n  - build\n\ncache:\n  paths:\n    - target/\n\n################# Jobs Configure #####################\n## \u6784\u5efa\u4f5c\u4e1a\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  image: ${BUILD_IMAGE}\n  extends: .build\n</code></pre> <p>\u5b9a\u4e49build\u4f5c\u4e1a\uff0c\u8bbe\u7f6e\u4f5c\u4e1a\u53d8\u91cf<code>GIT_CHECKOUT: \"true\"</code>\u8868\u793a\u9700\u8981\u4e0b\u8f7d\u4ee3\u7801\uff0c\u9ed8\u8ba4build\u662f\u6211\u4eec\u6d41\u6c34\u7ebf\u4e2d\u7684\u7b2c\u4e00\u4e2a\u4f5c\u4e1a\u6240\u4ee5\u5fc5\u987b\u8bbe\u7f6e\u4e3a\u4e0b\u8f7d\u4ee3\u7801\uff0c\u5426\u5219\u6784\u5efa\u5931\u8d25\u3002</p> <p>\u4f5c\u4e1a\u4e2d\u7684\u53d8\u91cf\u4f18\u5148\u7ea7\u9ad8\u4e8e\u5168\u5c40\u3002image\u5b9a\u4e49\u6211\u4eec\u8981\u4f7f\u7528\u7684\u955c\u50cf\uff0c\u5982\u679c\u91c7\u7528\u975e\u5bb9\u5668\u6a21\u5f0f\u8fd0\u884c\u53ef\u4ee5\u5220\u9664image\u6807\u7b7e\u3002</p> <p>\u5269\u4e0b\u7684\u914d\u7f6e\u5168\u90e8\u96c6\u6210\u6a21\u677f\u4f5c\u4e1a<code>.build</code>\u3002</p> <p></p>"},{"location":"chap6/2pip_design/#test","title":"Test\u9636\u6bb5","text":"<p>\u8fd9\u91cc\u5b9a\u4e49\u7684\u662f\u5728\u8fd0\u884c\u7f16\u8bd1\u540e\u8fdb\u884c\u7684\u5355\u5143\u6d4b\u8bd5\u3002</p> <p>maven\u9879\u76ee\u4e00\u822c\u662f<code>mvn test</code>,npm\u9879\u76ee\u4e00\u822c\u662f<code>npm run test</code>\u7b49\u3002\u4e0d\u540c\u7684\u9879\u76ee\u8fd0\u884c\u5355\u5143\u6d4b\u8bd5\u7684\u6307\u4ee4\u4e0d\u901a\uff0c\u5176\u4ed6\u90e8\u5206\u90fd\u5dee\u4e0d\u591a\u3002\u8fd9\u91cc\u4ee5maven\u9879\u76ee\u4e3a\u4f8b\u3002\u5f00\u59cb\u8bbe\u8ba1maven\u9879\u76ee\u5355\u5143\u6d4b\u8bd5\u3002</p> <p>\u7f16\u8f91<code>jobs/test.yml</code>\u6587\u4ef6\u5b9a\u4e49<code>test</code>\u4f5c\u4e1a\u6a21\u677f\u3002(\u540e\u7eed\u81ea\u52a8\u5316\u6d4b\u8bd5\u7b49\u6d4b\u8bd5\u76f8\u5173\u4f5c\u4e1a\u653e\u5230\u6b64\u6587\u4ef6)</p> <pre><code>#\u5355\u5143\u6d4b\u8bd5\n.test:\n  stage: test\n  script:\n    - $TEST_SHELL\n  artifacts:\n    reports:\n      junit: ${JUNIT_REPORT_PATH}\n</code></pre> <p>\u7f16\u8f91\u6a21\u677f\u6587\u4ef6\uff0c\u6dfb\u52a0\u5bfc\u5165test\u4f5c\u4e1a\u6a21\u677f\u3002</p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/test.yml'\n</code></pre> <p>\u5728\u6a21\u677f\u6587\u4ef6\u4e2d\u6dfb\u52a0\u53d8\u91cf\u5b9a\u4e49\u3002</p> <pre><code>variables:\n  TEST_SHELL : 'mvn test  --settings=./settings.xml '      ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n\n## \u6d4b\u8bd5\u4f5c\u4e1a\ntest:\n  image: ${BUILD_IMAGE}\n  extends: .test\n  before_script:\n    - ls \n    - ls target/\n</code></pre> <p></p>"},{"location":"chap6/2pip_design/#_2","title":"\u4ee3\u7801\u626b\u63cf\u9636\u6bb5","text":"<pre><code>##\u4ee3\u7801\u626b\u63cf\n##\n##\n##\n\n.code_analysis:\n  variables:\n    GLOBAL_PROJECT_ARGS: \"-Dsonar.projectKey=${CI_PROJECT_NAME} \n                          -Dsonar.projectName=${CI_PROJECT_NAME} \n                          -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \n                          -Dsonar.projectDescription=${CI_PROJECT_TITLE}\"\n    GLOBAL_SERVER_ARGS:  \"-Dsonar.ws.timeout=30 \n                          -Dsonar.links.homepage=${CI_PROJECT_URL} \n                          -Dsonar.host.url=${SONAR_SERVER_URL} \n                          -Dsonar.login=${SONAR_SERVER_LOGIN}\n                          -Dsonar.sourceEncoding=UTF-8 \"\n    GLOBAL_MR_ARGS: \" -Dsonar.pullrequest.key=${CI_MERGE_REQUEST_IID} \n                      -Dsonar.pullrequest.branch=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} \n                      -Dsonar.pullrequest.base=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME} \n                      -Dsonar.gitlab.ref_name=${CI_COMMIT_REF_NAME} \n                      -Dsonar.gitlab.commit_sha=${CI_COMMIT_SHA} \n                      -Dsonar.gitlab.project_id=${CI_PROJECT_PATH} \n                      -Dsonar.pullrequest.gitlab.repositorySlug=${CI_PROJECT_ID} \"\n    MULTI_BRANCH_ARGS: \"-Dsonar.branch.name=${CI_COMMIT_REF_NAME}\"\n  stage: code_analysis\n  script:\n    - echo ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} ${GLOBAL_MR_ARGS}\n    #sonar-scanner $GLOBAL_PROJECT_ARGS $GLOBAL_SERVER_ARGS $SCAN_JAVA_ARGS\n    - |\n        if [ $CI_PIPELINE_SOURCE == 'merge_request_event' ] \n\n        then\n           echo \"sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} ${GLOBAL_MR_ARGS}\"\n           sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} ${GLOBAL_MR_ARGS}\n        else \n           echo \"sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS}\"\n           sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS}  ${MULTI_BRANCH_ARGS}\n        fi \n\n.get_analysis_result:\n  stage: get_analysis_result\n  script:\n    - |\n        SONAR_REPORT_URL=$(grep \"ceTaskUrl\" .scannerwork/report-task.txt  | awk -F = '{OFS=\"=\";print $2,$3}')\n        echo ${SONAR_REPORT_URL}\n\n\n        for i in {1..10}\n        do\n          curl -k -u \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\":\"\" ${SONAR_REPORT_URL}  -o sonar_result.txt -s\n          grep '\"status\":\"SUCCESS\"' sonar_result.txt  &amp;&amp; SONAR_SCAN_RESULT='SUCCESS'\n\n          if [ ${SONAR_SCAN_RESULT} == 'SUCCESS' ]\n            then\n              echo \"${SONAR_SCAN_RESULT}\"\n              SONAR_SCAN_RESULT=SUCCESS\n              break;\n          else\n            SONAR_SCAN_RESULT='ERROR'\n            echo \"\u7b2c$i\u6b21\u83b7\u53d6\u7ed3\u679c\u4fe1\u606f\uff0c\u4e0d\u662f\u6210\u529f\u72b6\u6001\uff0c\u7761\u772010\u79d2\uff01\"\n            cat sonar_result.txt\n            sleep 10\n          fi\n        done\n</code></pre> <p><code>templates/pipeline.yml</code></p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n\n\n\nvariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID    \n  GIT_CHECKOUT: \"false\"\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"maven:3.6.3-jdk-8\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven \"\n  BUILD_SHELL: 'mvn clean package  -DskipTests  --settings=./settings.xml '  ##\u6784\u5efa\u547d\u4ee4\n  TEST_SHELL : 'mvn test  --settings=./settings.xml '                        ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_PROJECT_LANG: \"JAVA\"\n  SONAR_SOURCE_DIR : \"src\" \n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\" \n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\" \n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR} \n                   -Dsonar.java.binaries=target/classes \n                   -Dsonar.java.test.binaries=target/test-classes \n                   -Dsonar.java.surefire.report=target/surefire-reports \"\n\n\n## \u8fd0\u884c\u9636\u6bb5  \nstages:\n  - build\n  - test\n  - parallel01\n\ncache:\n  paths:\n    - target/\n\n################# Jobs Configure #####################\n## \u6784\u5efa\u4f5c\u4e1a\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  image: ${BUILD_IMAGE}\n  extends: .build\n\n## \u6d4b\u8bd5\u4f5c\u4e1a\ntest:\n  image: ${BUILD_IMAGE}\n  extends: .test\n  before_script:\n    - ls \n    - ls target/\n\n## \u4ee3\u7801\u626b\u63cf\ncode_analysis:\n  stage: parallel01\n  image: ${SONAR_IMAGE}\n  extends: .code_analysis\n</code></pre> <p></p>"},{"location":"chap6/2pip_design/#_3","title":"\u6784\u5efa\u955c\u50cf\u9636\u6bb5","text":"<p>jobs/build.yml</p> <pre><code>.build-docker:\n  stage: buildimage\n  script:\n    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWD  $CI_REGISTRY\n    - docker build -t ${IMAGE_NAME} -f ${DOCKER_FILE_PATH} .\n    - docker push ${IMAGE_NAME} \n    - docker rmi ${IMAGE_NAME} \n</code></pre> <p>telmplate/pipeline.yml</p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n\n\n\nvariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID    \n  GIT_CHECKOUT: \"false\"\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"maven:3.6.3-jdk-8\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven \"\n  BUILD_SHELL: 'mvn clean package  -DskipTests  --settings=./settings.xml '  ##\u6784\u5efa\u547d\u4ee4\n  TEST_SHELL : 'mvn test  --settings=./settings.xml '                        ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_PROJECT_LANG: \"JAVA\"\n  SONAR_SOURCE_DIR : \"src\" \n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\" \n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\" \n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR} \n                   -Dsonar.java.binaries=target/classes \n                   -Dsonar.java.test.binaries=target/test-classes \n                   -Dsonar.java.surefire.report=target/surefire-reports \"\n\n  #\u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\n  CI_REGISTRY_USER: '610556220zy'\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'\n  IMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA\"\n  DOCKER_FILE_PATH: \"./Dockerfile\"\n\n\n\n\n## \u8fd0\u884c\u9636\u6bb5  \nstages:\n  - build\n  - test\n  - parallel01\n\ncache:\n  paths:\n    - target/\n\n################# Jobs Configure #####################\n## \u6784\u5efa\u4f5c\u4e1a\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  image: ${BUILD_IMAGE}\n  extends: .build\n\n## \u6d4b\u8bd5\u4f5c\u4e1a\ntest:\n  image: ${BUILD_IMAGE}\n  extends: .test\n  before_script:\n    - ls \n    - ls target/\n\n## \u4ee3\u7801\u626b\u63cf\ncode_analysis:\n  stage: parallel01\n  image: ${SONAR_IMAGE}\n  extends: .code_analysis\n\n## \u6784\u5efa\u955c\u50cf\nbuild_image:\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n</code></pre> <p></p> <p></p>"},{"location":"chap6/2pip_design/#k8s","title":"K8S\u90e8\u7f72\u9636\u6bb5","text":"<p>jobs/deploy.yml</p> <pre><code># \u5e94\u7528\u53d1\u5e03\n\n\n## \u4f7f\u7528kubectl\u955c\u50cf\u53d1\u5e03\n.deploy_k8s:\n  stage: deploy\n  script:\n    - echo $KUBE_TOKEN\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - ls -a \n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" deployment.yaml \n    - sed -i \"s#__appname__#${APP_NAME}#g\" deployment.yaml \n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" deployment.yaml \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" deployment.yaml \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" deployment.yaml \n    - sed -i \"s#__CI_ENVIRONMENT_SLUG__#${CI_ENVIRONMENT_SLUG}#g\" deployment.yaml \n    - sed -i \"s#__CI_PROJECT_PATH_SLUG__#${CI_PROJECT_PATH_SLUG}#g\" deployment.yaml\n    - sed -i \"s#__ingressdomain__#${ENV_URL}#g\" deployment.yaml\n    - cat deployment.yaml\n    - \"kubectl create secret docker-registry ${APP_NAME} \\\n            --docker-server=${CI_REGISTRY} \\\n            --docker-username=$CI_REGISTRY_USER \\\n            --docker-password=${CI_REGISTRY_PASSWD} \\\n            --docker-email=test@test.com -n ${NAMESPACE} || echo 'secrets already exists'\"\n    - kubectl apply -f deployment.yaml  \n  environment:\n    name: \"${CI_COMMIT_REF_NAME}\"\n    url: \"http://${CI_COMMIT_REF_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n    on_stop: rollout_k8s\n  when: manual\n\n## \u56de\u6eda\n.rollout_k8s:\n  stage: rollout\n  script:\n    - rm -rf $HOME/.kube\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - kubectl rollout history deployment ${APP_NAME} -n ${NAMESPACE}\n    - kubectl rollout undo deployment ${APP_NAME} -n ${NAMESPACE}\n  when: manual\n  environment:\n    name: \"${CI_COMMIT_REF_NAME}\"\n    action: stop\n</code></pre> <p>templates/pipeline.yml</p> <pre><code>nclude:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/deploy.yml'\n\n\n\nvariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID    \n  GIT_CHECKOUT: \"false\"\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"maven:3.6.3-jdk-8\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven \"\n  BUILD_SHELL: 'mvn clean package  -DskipTests  --settings=./settings.xml '  ##\u6784\u5efa\u547d\u4ee4\n  TEST_SHELL : 'mvn test  --settings=./settings.xml '                        ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_PROJECT_LANG: \"JAVA\"\n  SONAR_SOURCE_DIR : \"src\" \n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\" \n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\" \n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR} \n                   -Dsonar.java.binaries=target/classes \n                   -Dsonar.java.test.binaries=target/test-classes \n                   -Dsonar.java.surefire.report=target/surefire-reports \"\n\n  #\u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\n  CI_REGISTRY_USER: '610556220zy'\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'\n  IMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA\"\n  DOCKER_FILE_PATH: \"./Dockerfile\"\n\n  #\u90e8\u7f72\u5e94\u7528k8s\n  RUN_DEPLOY: \"yes\"\n  APP_NAME: \"$CI_PROJECT_NAME\"\n  CONTAINER_PORT: 8081\n  #NODE_PORT: 30185\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"\n\n\n\n\n\n\n## \u8fd0\u884c\u9636\u6bb5  \nstages:\n  - build\n  - test\n  - parallel01\n  - deploy\n  - rollout\n\n\ncache:\n  paths:\n    - target/\n\n################# Jobs Configure #####################\n## \u6784\u5efa\u4f5c\u4e1a\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  image: ${BUILD_IMAGE}\n  extends: .build\n\n## \u6d4b\u8bd5\u4f5c\u4e1a\ntest:\n  image: ${BUILD_IMAGE}\n  extends: .test\n  before_script:\n    - ls \n    - ls target/\n\n## \u4ee3\u7801\u626b\u63cf\ncode_analysis:\n  stage: parallel01\n  image: ${SONAR_IMAGE}\n  extends: .code_analysis\n\n## \u6784\u5efa\u955c\u50cf\nbuild_image:\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n\n## \u53d1\u5e03\u5e94\u7528\ndeploy_k8s:\n  stage: deploy\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n\n## \u5e94\u7528\u56de\u6eda\nrollout_k8s:\n  stage: rollout\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n</code></pre> <p></p> <p></p>"},{"location":"chap6/3pip_run/","title":"3 \u6d41\u6c34\u7ebf\u8fd0\u884c","text":""},{"location":"chap6/3pip_run/#1","title":"1 \u6d41\u6c34\u7ebf\u89e6\u53d1\u63a7\u5236","text":"<p>\u4f7f\u7528<code>workflow:rules</code> \u8fdb\u884c\u6d41\u6c34\u7ebf\u63a7\u5236\uff0c\u6211\u4eec\u4f1a\u7528\u5230Pipeline\u7684\u53d8\u91cf\uff0c\u901a\u8fc7\u53d8\u91cf\u9650\u5236\u6761\u4ef6\u3002</p> <ul> <li>\u9884\u5b9a\u4e49\u53d8\u91cf\u53c2\u8003\u6587\u6863\uff1ahttps://docs.gitlab.com//12.9/ee/ci/variables/predefined_variables.html</li> <li>\u53d8\u91cf\u5339\u914d\u8bed\u6cd5\uff1a https://docs.gitlab.com//12.9/ee/ci/variables/README.html#supported-syntax</li> <li>re2\u8bed\u6cd5\uff1ahttps://github.com/google/re2/wiki/Syntax</li> </ul>"},{"location":"chap6/3pip_run/#_1","title":"\u6392\u9664\u65b0\u5efa\u5206\u652f\u7684\u6d41\u6c34\u7ebf","text":"<p>\u8fd0\u884c\u6d41\u6c34\u7ebf\u60a8\u4f1a\u53d1\u73b0\uff0c\u6240\u6709\u65b0\u521b\u5efa\u7684\u5206\u652f\u7684<code>CI_COMMIT_BEFORE_SHA</code>\u4e3a40\u4e2a0\u3002</p> <pre><code> $ export\n\n declare -x CI_BUILD_BEFORE_SHA=\"0000000000000000000000000000000000000000\"\n declare -x CI_COMMIT_BEFORE_SHA=\"0000000000000000000000000000000000000000\"\n</code></pre> <pre><code>## \u6d41\u6c34\u7ebf\u63a7\u5236\nworkflow:\n  rules:\n    - if: $CI_COMMIT_BEFORE_SHA == \"0000000000000000000000000000000000000000\"\n      when: never\n    - when: always\n</code></pre> <pre><code>#$CI_COMMIT_REF_NAME =~ /\\d-*/\n#$CI_COMMIT_REF_NAME =~ /^RELEASE-*/  ||\n</code></pre>"},{"location":"chap6/3pip_run/#_2","title":"\u5408\u5e76\u6d41\u6c34\u7ebf\u518d\u8fdb\u884c\u6784\u5efa\u9a8c\u8bc1","text":"<p>\u5982\u679c\u662f\u4e00\u4e2a\u521a\u521a\u5f00\u59cb\u5173\u6ce8\u4ee3\u7801\u8d28\u91cf\u7684\u56e2\u961f\uff0c\u907f\u514d\u4e0d\u4e86\u51fa\u73b0\u4ee3\u7801\u626b\u63cf\u7684\u5931\u8d25\u3002 \u6539\u8fdb\u521d\u671f\u51fa\u73b0\u9519\u8bef\u5f88\u6b63\u5e38\uff0c\u5982\u679c\u5728\u521d\u671f\u5c31\u628a\u8d28\u91cf\u9608\u914d\u7f6e\u7684\u5f88\u4e25\u683c\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u6bcf\u6b21\u63d0\u4ea4\u4ee3\u7801\u90fd\u4f1a\u4ea7\u751f\u9519\u8bef\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u9002\u5f53\u7684\u653e\u5f00\u6d41\u6c34\u7ebf\u7684\u4ee3\u7801\u626b\u63cf\uff08\u4e5f\u5c31\u662f\u6d41\u6c34\u7ebf\u6682\u65f6\u4e0d\u8fdb\u884c\u8d28\u91cf\u9608\u68c0\u67e5\uff09\u3002</p> <p>\u5982\u679c\u4e0d\u626b\u63cf\u5c31\u65e0\u6cd5\u77e5\u9053\u4ee3\u7801\u7684\u51c6\u786e\u8d28\u91cf\uff0c\u6240\u4ee5\u6211\u4eec\u51c6\u5907\u6d41\u6c34\u7ebf\u4ec5\u626b\u63cf\u4e0d\u68c0\u67e5\u8d28\u91cf\u9608\uff0c\u800c\u5408\u5e76\u6d41\u6c34\u7ebf\u4f1a\u5c06\u4ee3\u7801\u8d28\u91cf\u5c55\u793a\u5728\u8bc4\u8bba\u533a\u3002\u7c7b\u4f3c\u4e8e\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u6d41\u6c34\u7ebf\u6210\u529f\u540e\u624d\u80fd\u5408\u5e76\u3002</p> <p>\u9ed8\u8ba4\u662f\u63d0\u4ea4\u89e6\u53d1\u6d41\u6c34\u7ebf\u8fd0\u884c\uff0c\u800c\u8bbe\u7f6e\u4e86\"\u6d41\u6c34\u7ebf\u6210\u529f\u540e\u5408\u5e76\"\u4f1a\u68c0\u67e5\u539f\u5206\u652f\u7684\u6700\u540e\u4e00\u6b21\u63d0\u4ea4\u7684\u72b6\u6001\u662f\u5426\u4e3asuccess\uff0c\u5982\u679c\u662fsuccess\u5219\u8fd0\u884c\u5408\u5e76\u3002 \u6211\u4eec\u914d\u7f6e\u6d41\u6c34\u7ebf\u5728\u51fa\u73b0\u5408\u5e76\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u8fdb\u884c\u4ee3\u7801\u9a8c\u8bc1\u3002</p> <pre><code>## \u6d41\u6c34\u7ebf\u63a7\u5236\nworkflow:\n  rules:\n    - if: $CI_MERGE_REQUEST_ID\n</code></pre>"},{"location":"chap6/3pip_run/#2","title":"2 \u90e8\u7f72\u6d41\u6c34\u7ebf\u5b9e\u8df5","text":"<p>\u6211\u4eec\u5c06\u5e94\u7528\u7684\u90e8\u7f72\u6587\u4ef6\u4e5f\u5b58\u50a8\u5728\u4ee3\u7801\u5e93\u4e2d\u7ba1\u7406\uff0c\u53ef\u80fd\u6bcf\u4e2a\u5e94\u7528\u5728\u5404\u4e2a\u73af\u5883\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\u4e0d\u4e00\u81f4\u3002\u6240\u6709\u5206\u4e3a\u4e09\u4e2a\u914d\u7f6e\u6587\u4ef6 <code>deployment-uat.yml</code>\u3001 <code>deployment-stag.yml</code>\u3001 <code>deployment-prod.yml</code></p> <p><code>jobs/deploy.yml</code></p> <pre><code>## \u5e94\u7528\u53d1\u5e03\n\n\n## \u4f7f\u7528kubectl\u955c\u50cf\u53d1\u5e03\n.deploy_k8s:\n  stage: deploy\n  script:\n    - echo $KUBE_TOKEN\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - ls -a \n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__appname__#${APP_NAME}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__CI_ENVIRONMENT_SLUG__#${CI_ENVIRONMENT_SLUG}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__CI_PROJECT_PATH_SLUG__#${CI_PROJECT_PATH_SLUG}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__ingressdomain__#${ENV_URL}#g\" ${DEPLOY_FILE}\n    - cat ${DEPLOY_FILE}\n    - \"kubectl create secret docker-registry ${APP_NAME} \\\n            --docker-server=${CI_REGISTRY} \\\n            --docker-username=$CI_REGISTRY_USER \\\n            --docker-password=${CI_REGISTRY_PASSWD} \\\n            --docker-email=test@test.com -n ${NAMESPACE} || echo 'secrets already exists'\"\n    - kubectl apply -f ${DEPLOY_FILE}\n  environment:\n    name: \"${ENV_NAME}\"\n    url: \"http://${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n    on_stop: \"${ROLL_NAME}\"\n\n## \u56de\u6eda\n.rollout_k8s:\n  stage: deploy\n  script:\n    - rm -rf $HOME/.kube\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - kubectl rollout history deployment ${APP_NAME} -n ${NAMESPACE}\n    - kubectl rollout undo deployment ${APP_NAME} -n ${NAMESPACE}\n  environment:\n    name: \"${ENV_NAME}\"\n    action: stop\n</code></pre> <p><code>templates/pipeline.yml</code></p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/deploy.yml'\n\n\n\nvariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID    \n  GIT_CHECKOUT: \"false\"\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"maven:3.6.3-jdk-8\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven \"\n  BUILD_SHELL: 'mvn clean package  -DskipTests  --settings=./settings.xml '  ##\u6784\u5efa\u547d\u4ee4\n  TEST_SHELL : 'mvn test  --settings=./settings.xml '                        ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_PROJECT_LANG: \"JAVA\"\n  SONAR_SOURCE_DIR : \"src\" \n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\" \n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\" \n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR} \n                   -Dsonar.java.binaries=target/classes \n                   -Dsonar.java.test.binaries=target/test-classes \n                   -Dsonar.java.surefire.report=target/surefire-reports \"\n\n  #\u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\n  CI_REGISTRY_USER: '610556220zy'\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'\n  IMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA\"\n  DOCKER_FILE_PATH: \"./Dockerfile\"\n\n  #\u90e8\u7f72\u5e94\u7528k8s\n  RUN_DEPLOY: \"yes\"\n  APP_NAME: \"$CI_PROJECT_NAME\"\n  CONTAINER_PORT: 8081\n  #NODE_PORT: 30185\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"\n\n\n## \u6d41\u6c34\u7ebf\u63a7\u5236\nworkflow:\n  rules:\n    - if: $CI_MERGE_REQUEST_ID\n    - if: $CI_PIPELINE_SOURCE == 'web'\n    - if: $CI_COMMIT_BEFORE_SHA == \"0000000000000000000000000000000000000000\"\n      when: never\n\n\n## \u8fd0\u884c\u9636\u6bb5  \nstages:\n  - build\n  - test\n  - parallel01\n  - get_analysis_result\n  - deploy\n  - rollout\n\n\ncache:\n  paths:\n    - target/\n\nbefore_script:\n  - export\n\n\n################# Jobs Configure #####################\n## \u6784\u5efa\u4f5c\u4e1a\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  image: ${BUILD_IMAGE}\n  extends: .build\n\n## \u6d4b\u8bd5\u4f5c\u4e1a\ntest:\n  image: ${BUILD_IMAGE}\n  extends: .test\n  before_script:\n    - ls \n    - ls target/\n\n## \u4ee3\u7801\u626b\u63cf\ncode_analysis:\n  stage: parallel01\n  image: ${SONAR_IMAGE}\n  extends: .code_analysis\n\n## \u83b7\u53d6\u6784\u5efa\u7ed3\u679c\nget_analysis_result:\n  image: curlimages/curl:7.70.0\n  extends: .get_analysis_result\n  needs:\n    - code_analysis\n\n## \u6784\u5efa\u955c\u50cf\nbuild_image:\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n\n## feature\u53d1\u5e03\u5e94\u7528\ndeploy_feature:\n  variables:\n    DEPLOY_FILE: 'deployment.yaml'\n    ENV_NAME: 'feature'\n  stage: deploy\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /\\d-*/\n      when: manual\n    - when: never\n\n## \u5e94\u7528\u56de\u6eda\nrollout_feature:\n  stage: rollout\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /\\d-*/\n      when: manual\n    - when: never\n\n## UAT\ndeploy_uat:\n  variables:\n    DEPLOY_FILE: 'config/deployment-uat.yaml'\n    ENV_NAME: 'uat'\n  stage: deploy\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n\n## UAT\u5e94\u7528\u56de\u6eda\nrollout_uat:\n  stage: rollout\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n\n## STAG\ndeploy_stag:\n  variables:\n    DEPLOY_FILE: 'config/deployment-stag.yaml'\n    ENV_NAME: 'stag'\n  stage: deploy\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n\n## STAG\u5e94\u7528\u56de\u6eda\nrollout_stag:\n  stage: rollout\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n\n## PROD\ndeploy_prod:\n  variables:\n    DEPLOY_FILE: 'config/deployment-prod.yaml'\n    ENV_NAME: 'prod'\n  stage: deploy\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n\n## PROD\u5e94\u7528\u56de\u6eda\nrollout_prod:\n  stage: rollout\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n</code></pre>"},{"location":"chap6/3pip_run/#_3","title":"\u6d41\u6c34\u7ebf\u56de\u6eda\u4f5c\u4e1a\u4f18\u5316","text":"<p><code>jobs/deploy.yml</code> \u57fa\u4e8e\u539f\u5148\u5185\u5bb9\u65e0\u592a\u5927\u53d8\u5316\uff0c\u79fb\u9664\u4e86enviroment\u5b9a\u4e49\u3002</p> <pre><code>## \u5e94\u7528\u53d1\u5e03\n\n\n## \u4f7f\u7528kubectl\u955c\u50cf\u53d1\u5e03\n.deploy_k8s:\n  stage: deploy\n  script:\n    - echo $KUBE_TOKEN\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - ls -a \n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__appname__#${APP_NAME}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__CI_ENVIRONMENT_SLUG__#${CI_ENVIRONMENT_SLUG}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__CI_PROJECT_PATH_SLUG__#${CI_PROJECT_PATH_SLUG}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__ingressdomain__#${ENV_URL}#g\" ${DEPLOY_FILE}\n    - cat ${DEPLOY_FILE}\n    - \"kubectl create secret docker-registry ${APP_NAME} \\\n            --docker-server=${CI_REGISTRY} \\\n            --docker-username=$CI_REGISTRY_USER \\\n            --docker-password=${CI_REGISTRY_PASSWD} \\\n            --docker-email=test@test.com -n ${NAMESPACE} || echo 'secrets already exists'\"\n    - kubectl apply -f ${DEPLOY_FILE}\n\n\n## \u56de\u6eda\n.rollout_k8s:\n  stage: deploy\n  script:\n    - rm -rf $HOME/.kube\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - kubectl rollout history deployment ${APP_NAME} -n ${NAMESPACE}\n    - kubectl rollout undo deployment ${APP_NAME} -n ${NAMESPACE}\n</code></pre> <p>template/pipeline.yml</p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/deploy.yml'\n\n\n\nvariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: $CI_BUILDS_DIR/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CI_PIPELINE_ID    \n  GIT_CHECKOUT: \"false\"\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"maven:3.6.3-jdk-8\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven \"\n  BUILD_SHELL: 'mvn clean package  -DskipTests  --settings=./settings.xml '  ##\u6784\u5efa\u547d\u4ee4\n  TEST_SHELL : 'mvn test  --settings=./settings.xml '                        ##\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   ##\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_PROJECT_LANG: \"JAVA\"\n  SONAR_SOURCE_DIR : \"src\" \n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\" \n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\" \n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR} \n                   -Dsonar.java.binaries=target/classes \n                   -Dsonar.java.test.binaries=target/test-classes \n                   -Dsonar.java.surefire.report=target/surefire-reports \"\n\n  #\u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'\n  CI_REGISTRY_USER: 'xxxxxx'\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'\n  IMAGE_NAME: \"$CI_REGISTRY/$CI_PROJECT_PATH:$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA\"\n  DOCKER_FILE_PATH: \"./Dockerfile\"\n\n  #\u90e8\u7f72\u5e94\u7528k8s\n  RUN_DEPLOY: \"yes\"\n  APP_NAME: \"$CI_PROJECT_NAME\"\n  CONTAINER_PORT: 8081\n  #NODE_PORT: 30185\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"\n\n\n## \u6d41\u6c34\u7ebf\u63a7\u5236\nworkflow:\n  rules:\n    #- if: $CI_MERGE_REQUEST_ID\n    - if: $CI_PIPELINE_SOURCE == 'web'\n    - if: $CI_COMMIT_BEFORE_SHA == \"0000000000000000000000000000000000000000\"\n      when: never\n\n\n## \u8fd0\u884c\u9636\u6bb5  \nstages:\n  - build\n  - test\n  - parallel01\n  - get_analysis_result\n  - deploy-feature\n  - rollout-feature\n  - deploy-uat\n  - rollout-uat\n  - deploy-stag\n  - rollout-stag\n  - deploy-prod\n  - rollout-prod\n\ncache:\n  paths:\n    - target/\n\nbefore_script:\n  - export\n\n\n################# Jobs Configure #####################\n## \u6784\u5efa\u4f5c\u4e1a\nbuild:\n  variables:\n    GIT_CHECKOUT: \"true\"\n  image: ${BUILD_IMAGE}\n  extends: .build\n\n## \u6d4b\u8bd5\u4f5c\u4e1a\ntest:\n  image: ${BUILD_IMAGE}\n  extends: .test\n  before_script:\n    - ls \n    - ls target/\n\n## \u4ee3\u7801\u626b\u63cf\ncode_analysis:\n  stage: parallel01\n  image: ${SONAR_IMAGE}\n  extends: .code_analysis\n\n## \u83b7\u53d6\u6784\u5efa\u7ed3\u679c\nget_analysis_result:\n  image: curlimages/curl:7.70.0\n  extends: .get_analysis_result\n  needs:\n    - code_analysis\n\n## \u6784\u5efa\u955c\u50cf\nbuild_image:\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n\n\n#################Deploy Feature Jobs Configure #####################\n## feature\u53d1\u5e03\u5e94\u7528\ndeploy_feature:\n  variables:\n    DEPLOY_FILE: 'deployment.yaml'\n    ENV_NAME: 'feature'\n  stage: deploy-feature\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: never\n    - when: manual\n  environment:\n    name: \"${ENV_NAME}\"\n    url: \"http://${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n    on_stop: \"rollout_feature\"\n\n## \u5e94\u7528\u56de\u6eda\nrollout_feature:\n  variables:\n    DEPLOY_FILE: 'deployment.yaml'\n    ENV_NAME: 'feature'\n  stage: rollout-feature\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /\\d-*/\n      when: manual\n    - when: never\n  environment:\n    name: \"${ENV_NAME}\"\n    action: stop\n\n#################Deploy UAT Jobs Configure #####################\n## UAT\ndeploy_uat:\n  variables:\n    DEPLOY_FILE: 'config/deployment-uat.yaml'\n    ENV_NAME: 'uat'\n  stage: deploy-uat\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n  environment:\n    name: \"${ENV_NAME}\"\n    url: \"http://${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n    on_stop: \"rollout_uat\"\n\n## UAT\u5e94\u7528\u56de\u6eda\nrollout_uat:\n  variables:\n    DEPLOY_FILE: 'config/deployment-uat.yaml'\n    ENV_NAME: 'uat'\n  stage: rollout-uat\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: on_failure\n    - when: never\n  environment:\n    name: \"${ENV_NAME}\"\n    action: stop\n\n#################Deploy STAG Jobs Configure #####################\n## STAG\ndeploy_stag:\n  variables:\n    DEPLOY_FILE: 'config/deployment-stag.yaml'\n    ENV_NAME: 'stag'\n  stage: deploy-stag\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n  environment:\n    name: \"${ENV_NAME}\"\n    url: \"http://${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n    on_stop: \"rollout_stag\"\n  needs:\n    - deploy_uat\n\n## STAG\u5e94\u7528\u56de\u6eda\nrollout_stag:\n  variables:\n    DEPLOY_FILE: 'config/deployment-stag.yaml'\n    ENV_NAME: 'stag'\n  stage: rollout-stag\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: on_failure\n    - when: never\n  environment:\n    name: \"${ENV_NAME}\"\n    action: stop\n  needs:\n    - deploy_stag\n\n#################Deploy PROD Jobs Configure #####################\n## PROD\ndeploy_prod:\n  variables:\n    DEPLOY_FILE: 'config/deployment-prod.yaml'\n    ENV_NAME: 'prod'\n  stage: deploy-prod\n  image: lucj/kubectl:1.17.2\n  extends: .deploy_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: manual\n    - when: never\n  environment:\n    name: \"${ENV_NAME}\"\n    url: \"http://${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n    on_stop: \"rollout_prod\"\n  needs:\n    - deploy_stag\n\n## PROD\u5e94\u7528\u56de\u6eda\nrollout_prod:\n  variables:\n    DEPLOY_FILE: 'config/deployment-prod.yaml'\n    ENV_NAME: 'prod'\n  stage: rollout-prod\n  image: lucj/kubectl:1.17.2\n  extends: .rollout_k8s\n  rules:\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ \n      when: on_failure\n    - when: never\n  environment:\n    name: \"${ENV_NAME}\"\n    action: stop\n  needs:\n    - deploy_prod\n</code></pre> <p></p>"},{"location":"chap6/3pip_run/#3_1","title":"3 \u53d1\u7248\u5b8c\u6210\u540e\u64cd\u4f5c","text":""},{"location":"chap6/3pip_run/#1master","title":"1.\u5c06\u7248\u672c\u5206\u652f\u5408\u5e76\u5230master\u5206\u652f","text":""},{"location":"chap6/3pip_run/#2master","title":"2.\u57fa\u4e8emaster\u5206\u652f\u521b\u5efa\u7248\u672c\u6807\u7b7e","text":""},{"location":"chap6/3pip_run/#3issues","title":"3.\u5173\u95edissues \u548c\u91cc\u7a0b\u7891","text":""},{"location":"chap6/4pip_secret/","title":"4 \u5982\u4f55\u5c06Secrets\u626b\u63cf\u52a0\u5165\u5230GitLab Pipeline","text":"<p>\u6982\u8ff0</p> <p>\u5982\u679c\u8981\u7ba1\u7406\u5e94\u7528\u7a0b\u5e8f\u5f00\u53d1\u7ba1\u9053\u4ee5\u4ea4\u4ed8\u8f6f\u4ef6\uff0c\u5219\u9700\u8981\u5b9e\u65bd\u4e00\u9879\u5173\u952e\u5b89\u5168\u63a7\u5236\u3002\u60a8\u9700\u8981\u786e\u4fdd\u60a8\u7684\u673a\u5bc6\u53d7\u5230\u4fdd\u62a4\u3002\u7b80\u5355\u5730\u8bf4\uff0c\u673a\u5bc6\u662f\u60a8\u9700\u8981\u4fdd\u62a4\u7684\u51ed\u636e\uff0c\u56e0\u4e3a\u8be5\u51ed\u636e\u5177\u6709\u7279\u6743\u529f\u80fd\u3002\u4f8b\u5982\uff1a</p> <ul> <li>\u7528\u6237\u540d\u548c\u5bc6\u7801\u7ec4\u5408</li> <li>\u63a5\u53e3\u5bc6\u94a5</li> <li>JSON \u7f51\u7edc\u4ee4\u724c</li> <li>\u79c1\u94a5</li> </ul> <p>\u5f00\u53d1\u4eba\u5458\u7ecf\u5e38\u610f\u5916\u5730\u5c06\u8fd9\u4e9b\u51ed\u636e\u4fdd\u5b58\u5230\u5b58\u50a8\u5e93\u4e2d\u3002\u5c06\u8fd9\u4e9b\u51ed\u636e\u6216\u673a\u5bc6\u6dfb\u52a0\u5230\u5b58\u50a8\u5e93\u540e\uff0c\u6e05\u7406\u53ef\u80fd\u4f1a\u5f88\u75db\u82e6\uff0c\u5e76\u4e14\u9700\u8981\u60a8\u66f4\u6539\u51ed\u636e\u3002\u66f4\u597d\u7684\u957f\u671f\u65b9\u6cd5\u662f\u4f7f\u7528\u201c\u63d0\u4ea4\u524d\u68c0\u67e5\u201d\u6765\u907f\u514d\u5b58\u50a8\u673a\u5bc6\u3002\u8be5\u4e3b\u9898\u5c06\u5728\u53e6\u4e00\u7bc7\u6587\u7ae0\u4e2d\u4ecb\u7ecd\u3002\u672c\u535a\u5ba2\u91cd\u70b9\u4ecb\u7ecd\u5982\u4f55\u626b\u63cf\u73b0\u6709\u5b58\u50a8\u5e93\u4ee5\u67e5\u627e Gitlab \u7ba1\u9053\u4e2d\u5b58\u50a8\u7684\u673a\u5bc6\u3002</p>"},{"location":"chap6/4pip_secret/#_1","title":"\u8bc6\u522b\u6216\u521b\u5efa\u5b58\u50a8\u5e93","text":"<p>\u5982\u679c\u60a8\u60f3\u7ee7\u7eed\u64cd\u4f5c\uff0c\u53ef\u4ee5\u5355\u51fb\u6b64\u94fe\u63a5\u83b7\u53d6\u516c\u5171\u4ed3\u5e93\u3002</p> <p><code>https://gitlab.com/cmg_public/secrets_scanning_test</code></p> <p>\u7b2c\u4e00\u6b65\u662f\u786e\u5b9a\u76ee\u6807\u5b58\u50a8\u5e93\u3002\u5982\u679c\u60a8\u6b63\u5728\u5165\u95e8\u4f46\u6ca1\u6709\uff0c\u53ea\u9700\u5728 Gitlab \u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u9879\u76ee\u5373\u53ef\u3002</p> <p>\u4ece\u83dc\u5355\u4e2d\u5355\u51fb\u201c\u9879\u76ee&gt;\u521b\u5efa\u65b0\u9879\u76ee&gt;\u5bfc\u5165\u4e0a\u9762\u9879\u76ee\u5730\u5740\u201d\u3002</p> <p></p> <p>\u626b\u63cf\u89c4\u5219\u914d\u7f6e\u6587\u4ef6</p> <p>\u6587\u4ef6\u8def\u5f84\uff1a<code>.gitlab/secret-detection-ruleset.toml</code></p> <pre><code>[secrets]\ndescription = 'CMG DevSecOps Crash Course, secrets custom rules configuration'\n\n[[secrets.passthrough]]\ntype = \"raw\"\ntarget = \"gitleaks.toml\"\nvalue = \"\"\"\\\ntitle = \"gitleaks config\"\n# Add regexes to the regex table\n[[rules]]\ndescription = \"Test for Raw Custom Rulesets\"\nregex = '''Custom Raw Ruleset T[est]{3}'''\n\n[[rules]]\ndescription = \"CMG Custom Generic Password\"\nregex = '''(?i)(password|passw)'''\ntags = [\"key\", \"Custom Password\", \"generic\"]\n\"\"\"\n</code></pre> <p>\u60a8\u4f1a\u6ce8\u610f\u5230\u6211\u6dfb\u52a0\u4e86\u4e00\u4e9b\u81ea\u5b9a\u4e49\u89c4\u5219\u3002\u8fd9\u4e9b\u5c06\u7528\u4e8e\u6807\u8bc6\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u672a\u542f\u7528\u7684\u67d0\u4e9b\u7c7b\u578b\u7684\u673a\u5bc6\u3002</p> <p>\u60a8\u53ef\u4ee5\u6839\u636e\u9700\u8981\u521b\u5efa\u4efb\u610f\u6570\u91cf\u7684\u89c4\u5219\uff0c\u4ee5\u67e5\u627e\u901a\u5e38\u51fa\u73b0\u5728\u5f00\u53d1\u4eba\u5458\u4ee3\u7801\u4e2d\u7684\u6a21\u5f0f\u3002</p> <p>\"CMG Generic JWT\" \u6b64\u6b63\u5219\u8868\u8fbe\u5f0f \uff08REGEX\uff09 \u67e5\u627e\u5b58\u50a8\u5728\u6587\u4ef6\u4e2d\u7684 JSON Web Token\u3002\u8bf8\u5982<code>\u201cJWT\u201d</code>\u3001<code>\u201cjwt_token\u201d</code>\u3001<code>\u201csecret\u201d</code>\u3001<code>\u201cbearer\u201d</code>\u7b49\u3002\u6b63\u5219\u8868\u8fbe\u5f0f\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u3002</p> <pre><code>[[rules]]\ndescription = \"CMG Generic JWT\"\nregex = '''(?i)(jwt|jwt_token|secret|bearer)'''\ntags = [\"key\", \"JWT\", \"generic\"]\n</code></pre> <p>\"CMG Custom Generic Password\" \u6b64\u6b63\u5219\u8868\u8fbe\u5f0f\u67e5\u627e\u5b58\u50a8\u5728\u6587\u4ef6\u4e2d\u7684\u5355\u8bcd\u201cpassword\u201d\u7684\u5e38\u89c1\u6d3e\u751f\u8bcd\u3002\u6b64\u6b63\u5219\u8868\u8fbe\u5f0f\u4e5f\u4e0d\u533a\u5206\u5927\u5c0f\u5199\u3002</p> <pre><code>[[rules]]\ndescription = \"CMG Custom Generic Password\"\nregex = '''(?i)(password|passw)'''\ntags = [\"key\", \"Custom Password\", \"generic\"]\n\"\"\"\n</code></pre> <p>Pipeline\u914d\u7f6e\u6587\u4ef6</p> <p>\u6b64\u6a21\u677f\u5c06\u7528\u4e8e\u6839\u636e\u9ed8\u8ba4\u8bbe\u7f6e\u548c\u4efb\u4f55\u81ea\u5b9a\u4e49\u6b63\u5219\u8868\u8fbe\u5f0f\u5b57\u7b26\u4e32\uff08\u5982\u6211\u4eec\u5728\u524d\u9762\u7684\u6b65\u9aa4\u4e2d\u6dfb\u52a0\u7684\u5b57\u7b26\u4e32\uff09\u626b\u63cf\u673a\u5bc6\u3002</p> <pre><code># This file is a template, and might need editing before it works on your project.\n# This template moved to Jobs/Secret-Detection.gitlab-ci.yml in GitLab 14.0\n# Issue: https://gitlab.com/gitlab-org/gitlab/-/issues/292977\ninclude:\n  template: Jobs/Secret-Detection.gitlab-ci.yml\n</code></pre> <p>\u6b64\u65f6\uff0c\u6211\u4eec\u5df2\u51c6\u5907\u597d\u8fd0\u884c\u7ba1\u9053;\u4f46\u662f\uff0c\u6211\u4eec\u5728\u5b58\u50a8\u5e93\u4e2d\u6ca1\u6709\u4efb\u4f55\u8981\u626b\u63cf\u7684\u5185\u5bb9\u3002\u5728\u4e0b\u4e00\u6b65\u4e2d\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e9b\u7528\u4e8e\u6d4b\u8bd5\u914d\u7f6e\u7684\u673a\u5bc6\u3002</p>"},{"location":"chap6/4pip_secret/#secret","title":"\u7528\u4e8e\u6d4b\u8bd5\u7684Secret\u6587\u4ef6","text":"<ul> <li><code>Fake.json</code>\uff1a\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u6d4b\u8bd5<code>JWT</code>\u3002</li> </ul> <pre><code>{\n  \"username\": \"SecurityBooBoo\",\n  \"password\": \"Oh-Y3aH_CmG_2022-123\"\n}\n</code></pre> <ul> <li>FakePrivKey.key\uff1a\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u6b64\u6587\u4ef6\u6765\u6d4b\u8bd5\u79c1\u94a5\u3002</li> </ul> <pre><code>-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAYEAvO5F4B+lb8YYXB6gCgqxlmuNLGwTC58f96TbYQxUV/yzZkBS1hIp\nH0WOba5ZKeULWh7B5KPrqpK3yfYitThw73wX+UQuBN8FCyFw41/dB5brApDLLdW+aYt9M2\nKU3XcKDfij3Rmw4dWvihvxeOWjp1WTNZj480O1+CB+oTOWdElWp7fmhw912itreRQcJso7\nrFnfgfvdCAJoRMwYtadKmm3f9I1UvUxaaBiy45vwo7ZbnMUBnEOMhoA9zqZDii7GVj80t+\n1WfbrMy/WRzibspxs4cMpUa+K9FLXoms1I35QQ+VYtFMQehjsXkZEMprfewCF0ZzmNAavL\nxoIW+ybzCZNeH8afWNQ0TmO4M9sPmhrorfenKU3mfo1yxW5P8WIyl4ee7aSYPGMQdqh0nV\nqAuyc2XU6YF2Qz0HpSz9qq4gQVKNS/a10QbS7KiyGtGCFyRmCV3UGHqZGo4QvGVGA20qwV\nDN+o+KnLjvrYcklPBogGtxUvrCcU34n7tFE4LQjHAAAFiOcpTkznKU5MAAAAB3NzaC1yc2\nEAAAGBALzuReAfpW/GGFweoAoKsZZrjSxsEwufH/ek22EMVFf8s2ZAUtYSKR9Fjm2uWSnl\nC1oeweSj66qSt8n2IrU4cO98F/lELgTfBQshcONf3QeW6wKQyy3VvmmLfTNilN13Cg34o9\n0ZsOHVr4ob8Xjlo6dVkzWY+PNDtfggfqEzlnRJVqe35ocPddora3kUHCbKO6xZ34H73QgC\naETMGLWnSppt3/SNVL1MWmgYsuOb8KO2W5zFAZxDjIaAPc6mQ4ouxlY/NLftVn26zMv1kc\n4m7KcbOHDKVGvivRS16JrNSN+UEPlWLRTEHoY7F5GRDKa33sAhdGc5jQGry8aCFvsm8wmT\nXh/Gn1jUNE5juDPbD5oa6K33pylN5n6NcsVuT/FiMpeHnu2kmDxjEHaodJ1agLsnNl1OmB\ndkM9B6Us/aquIEFSjUv2tdEG0uyoshrRghckZgld1Bh6mRqOELxlRgNtKsFQzfqPipy476\n2HJJTwaIBrcVL6wnFN+J+7RROC0IxwAAAAMBAAEAAAGADHxGm+Abg754n6Xad69rOwCSjM\nv7mjoC18/KO6if7kyh4nD/yGvc0dc76V2rQMyFKoh70ctPaK9Xe/5LHuTC+eCeiPeLfwDq\nCWlFV5FfPwAnOb0t4DKO6dSxCnNKWTRjsraqxZLMELCZcCwWkiHC5e0O1Gzujsz7upETLT\n4GhFrQYjcSAfzwkeFqsc61aY7V0LcDwUhOvBfEoj9GpsKOeJQoR7YLUpM4Kkbvk4EbrwX/\nGeYfDB+eqsjQzNZKAljC346B9J/7krlANZYd/2PtsHqzJrnws/08jSjkzit12RdgP5UPWK\nL1Z0et8In4vXnKUspEAagB4pGrTLdgec7s14s/RMPqkUuUv016hGzW8k14YRG9Z1e91OsA\nD/kJsyLButT262kemAC05p4LUrqaAjAzDqmASSMEXfR7BWo6geVfLkxv5yDExFTcOPATNQ\ntf9R62h9k+W8wHUfrxfDo8fshgOLtrSsux+ROg1tNlOsvrNrmdpPH8tZD5RQPss28xAAAA\nwAZk8IIU34nLTWUspzDyyiegyAXD5kO1r6dxZoAiudaCqGjNbRo82nzrg1ux8ZohnVbOQV\nt6qQkDjDQB37airXVo4/j/s7H0HthSctlEPe4EYWaouhmPk3v45LV8z8aq3QZY5chyTGB5\nN17I5QgoSBHEM42pf+gWTmNUX0N4bjwRL/a+HE7PnGC5ax+FNPY+fL9fHpBtz791SogNak\nfopIxmfSJJbTbBctw01F6eo67uikGOVxzk5MClJaP2jyLYFAAAAMEA6/ShdpzMCd5Oy5+O\nDtDV0v8lF9YCxKl6+Vaw1iQtdafvgZuy1Msr645o39IVbUWKEwNJsi0uokyxvojcQOgNp1\nhWZCVvkXXlBlTxKcxRlSBVj+6eB/nIgDLEcLKH7DYALfat+IBaEdtPiL4/+FiOmXrx/JWR\nE43yoYDkC59usOZKHVl8uM4YgOw7mhFx5I1W6qX2rXoT3toEDITRygjuMjreegzhf/oSUF\nT2IaGxNBpOf0yCBo6nCyFhk5f3g185AAAAwQDM+vwMD6/ToLy5roZoJ75CcVUNHMh3Sj/l\nf2AEe3ldM2VTtoV/nVOli6/N8jJOhF7tRm6RlR1CjYKDPALMuRgwg83dXqtr+jxuwrcV6t\ndeYr48HVdTgNooJ29SmYSB+7xWX7flPS+8gtpx95FXKnNqL+NFNEWxERjfe2oLQ+2/R7Jb\nXChNNNV04eIAWuCFhyl0wGBDALdo7biwsRJ/mYB7vkptfOSKTTP3zNd4qFKQsN3VBfPGmZ\nKQCdxFay/Lp/8AAAATYW5hbHlzdEBweXRob25kZXYwMQ==\n-----END OPENSSH PRIVATE KEY-----\n</code></pre> <ul> <li>FakeAPIKey.txt\uff1a\u6211\u4eec\u53ef\u4ee5\u7528\u5b83\u6765\u67e5\u627e\u548c\u6d4b\u8bd5 API \u5bc6\u94a5\u3002</li> </ul> <pre><code>Apikey=33219b16f39fc40d3a1be5e9e6f56abe\n</code></pre>"},{"location":"chap6/4pip_secret/#_2","title":"\u8fd0\u884c\u6d4b\u8bd5\u5e76\u89c2\u5bdf\u7ed3\u679c","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6bcf\u6b21\u6dfb\u52a0\u5e76\u63d0\u4ea4\u6587\u4ef6\u65f6\uff0c\u90fd\u4f1a\u89e6\u53d1\u6784\u5efa\u3002\u5982\u679c\u5355\u51fb Web \u754c\u9762\u5de6\u4fa7\u7a97\u683c\u4e2d\u7684\u201cCI/CD\u201d&gt;\u201c\u7ba1\u9053\u201d\u5bf9\u8c61\uff0c\u5219\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a\u4f5c\u4e1a\u7684\u7ed3\u679c\u3002</p> <p>\u5355\u51fb\u6bcf\u4e2a\u5c4f\u5e55\u4e0a\u7684\u201c\u8fd0\u884c\u7ba1\u9053\u201d\u6309\u94ae\u3002\u7cfb\u7edf\u5c06\u63d0\u793a\u60a8\u8f93\u5165\u5176\u4ed6\u53ef\u4ee5\u5ffd\u7565\u7684\u9009\u9879\u3002</p> <p></p> <p>\u51e0\u79d2\u949f\u540e\uff0c\u7ba1\u9053\u4f5c\u4e1a\u5c06\u5f00\u59cb\u3002\u4e00\u65e6\u5b83\u53d8\u6210\u84dd\u8272\uff0c\u60a8\u53ef\u4ee5\u5355\u51fb\u201csecret_detection\u201d\u9636\u6bb5\u5e76\u89c2\u770b\u8f93\u51fa\u3002</p> <p></p> <p>\u5982\u679c\u4e00\u5207\u6309\u8ba1\u5212\u8fdb\u884c\uff0c\u60a8\u5e94\u8be5\u4f1a\u770b\u5230\u7c7b\u4f3c\u7684\u6587\u672c\u3002</p> <p></p>"},{"location":"chap6/4pip_secret/#_3","title":"\u4e0b\u8f7d\u7ed3\u679c","text":"<p>\u51e0\u5206\u949f\u540e\uff0c\u7ed3\u679c\u5c06\u53ef\u4f9b\u4e0b\u8f7d\u5173\u8054\u4f5c\u4e1a\u3002\u5355\u51fb\u4f5c\u4e1a\u53f3\u4fa7\u7684\u201c\u4e0b\u8f7d\u6309\u94ae\u201d\uff0c\u7136\u540e\u9009\u62e9\u201c<code>secret_detection.secret_detection</code>\u201d\u6587\u4ef6\u3002</p> <p>\u5b83\u5c06\u4e0b\u8f7d\u4e3a JSON\u3002\u7136\u540e\uff0c\u60a8\u53ef\u4ee5\u5728\u81ea\u5df1\u559c\u6b22\u7684\u6587\u672c\u7f16\u8f91\u5668\u6216\u5728\u7ebf JSON \u683c\u5f0f\u5316\u5de5\u5177\u4e2d\u6253\u5f00\u5b83\u3002</p> <p></p> <p>\u67e5\u770b\u7ed3\u679c</p> <pre><code>{\n  \"version\":\"14.0.4\",\n  \"vulnerabilities\":[\n    {\n      \"id\":\"a70bbb54bc6faeadc71027dfb50203a1803cc10d221af9156b5393a211ccddd2\",\n      \"category\":\"secret_detection\",\n      \"name\":\"CMG Custom Generic Password\",\n      \"message\":\"CMG Custom Generic Password detected; please remove and revoke it if this is a leak.\",\n      \"description\":\"CMG Custom Generic Password\",\n      \"cve\":\".gitlab/secret-detection-ruleset.toml:5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8:CMG Custom Generic Password\",\n      \"severity\":\"Critical\",\n      \"confidence\":\"Unknown\",\n      \"raw_source_code_extract\":\"password\",\n      \"scanner\":{\n        \"id\":\"gitleaks\",\n        \"name\":\"Gitleaks\"\n      },\n      \"location\":{\n        \"file\":\".gitlab/secret-detection-ruleset.toml\",\n        \"commit\":{\n          \"sha\":\"0000000\"\n        },\n        \"start_line\":19\n      },\n      \"identifiers\":[\n        {\n          \"type\":\"gitleaks_rule_id\",\n          \"name\":\"Gitleaks rule ID CMG Custom Generic Password\",\n          \"value\":\"CMG Custom Generic Password\"\n        }\n      ]\n    },\n    {\n      \"id\":\"4d5f0e089322ca90db4e7b3baa58a3c3a68bf63af20ec9afe2e1120feea93a95\",\n      \"category\":\"secret_detection\",\n      \"name\":\"CMG Custom Generic Password\",\n      \"message\":\"CMG Custom Generic Password detected; please remove and revoke it if this is a leak.\",\n      \"description\":\"CMG Custom Generic Password\",\n      \"cve\":\".gitlab/secret-detection-ruleset.toml:e45d90957eec7387726c6a1b174da7b566a24ff4cb060dcbcdfebb931a93ffe3:CMG Custom Generic Password\",\n      \"severity\":\"Critical\",\n      \"confidence\":\"Unknown\",\n      \"raw_source_code_extract\":\"passw\",\n      \"scanner\":{\n        \"id\":\"gitleaks\",\n        \"name\":\"Gitleaks\"\n      },\n      \"location\":{\n        \"file\":\".gitlab/secret-detection-ruleset.toml\",\n        \"commit\":{\n          \"sha\":\"0000000\"\n        },\n        \"start_line\":19\n      },\n      \"identifiers\":[\n        {\n          \"type\":\"gitleaks_rule_id\",\n          \"name\":\"Gitleaks rule ID CMG Custom Generic Password\",\n          \"value\":\"CMG Custom Generic Password\"\n        }\n      ]\n    },\n    {\n      \"id\":\"95d9614ca06da0f4fc8f67319a44585ee6295a26060cd256655ae6f503e41ef2\",\n      \"category\":\"secret_detection\",\n      \"name\":\"CMG Custom Generic Password\",\n      \"message\":\"CMG Custom Generic Password detected; please remove and revoke it if this is a leak.\",\n      \"description\":\"CMG Custom Generic Password\",\n      \"cve\":\".gitlab/secret-detection-ruleset.toml:e7cf3ef4f17c3999a94f2c6f612e8a888e5b1026878e4e19398b23bd38ec221a:CMG Custom Generic Password\",\n      \"severity\":\"Critical\",\n      \"confidence\":\"Unknown\",\n      \"raw_source_code_extract\":\"Password\",\n      \"scanner\":{\n      \"id\":\"gitleaks\",\n      \"name\":\"Gitleaks\"\n    },\n      \"location\":{\n      \"file\":\".gitlab/secret-detection-ruleset.toml\",\n      \"commit\":{\n      \"sha\":\"0000000\"\n    },\n      \"start_line\":18\n    },\n      \"identifiers\":[\n      {\n      \"type\":\"gitleaks_rule_id\",\n      \"name\":\"Gitleaks rule ID CMG Custom Generic Password\",\n      \"value\":\"CMG Custom Generic Password\"\n    }\n      ]\n    },\n      {\n      \"id\":\"52256d01ca112c54e5ca22e982b096852bf279f206f425aebf4421cfc8ac426e\",\n      \"category\":\"secret_detection\",\n      \"name\":\"CMG Custom Generic Password\",\n      \"message\":\"CMG Custom Generic Password detected; please remove and revoke it if this is a leak.\",\n      \"description\":\"CMG Custom Generic Password\",\n      \"cve\":\".gitlab/secret-detection-ruleset.toml:e7cf3ef4f17c3999a94f2c6f612e8a888e5b1026878e4e19398b23bd38ec221a:CMG Custom Generic Password\",\n      \"severity\":\"Critical\",\n      \"confidence\":\"Unknown\",\n      \"raw_source_code_extract\":\"Password\",\n      \"scanner\":{\n      \"id\":\"gitleaks\",\n      \"name\":\"Gitleaks\"\n    },\n      \"location\":{\n      \"file\":\".gitlab/secret-detection-ruleset.toml\",\n      \"commit\":{\n      \"sha\":\"0000000\"\n    },\n      \"start_line\":20\n    },\n      \"identifiers\":[\n      {\n      \"type\":\"gitleaks_rule_id\",\n      \"name\":\"Gitleaks rule ID CMG Custom Generic Password\",\n      \"value\":\"CMG Custom Generic Password\"\n    }\n      ]\n    },\n      {\n      \"id\":\"f9c6b0ef5af1fb0298ff99fc6467e76fc44a4e6d1dc3699cfd8c7249eb293ad5\",\n      \"category\":\"secret_detection\",\n      \"name\":\"CMG Custom Generic Password\",\n      \"message\":\"CMG Custom Generic Password detected; please remove and revoke it if this is a leak.\",\n      \"description\":\"CMG Custom Generic Password\",\n      \"cve\":\"Fake.json:5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8:CMG Custom Generic Password\",\n      \"severity\":\"Critical\",\n      \"confidence\":\"Unknown\",\n      \"raw_source_code_extract\":\"password\",\n      \"scanner\":{\n      \"id\":\"gitleaks\",\n      \"name\":\"Gitleaks\"\n    },\n      \"location\":{\n      \"file\":\"Fake.json\",\n      \"commit\":{\n      \"sha\":\"0000000\"\n    },\n      \"start_line\":3\n    },\n      \"identifiers\":[\n      {\n      \"type\":\"gitleaks_rule_id\",\n      \"name\":\"Gitleaks rule ID CMG Custom Generic Password\",\n      \"value\":\"CMG Custom Generic Password\"\n    }\n      ]\n    }\n      ],\n      \"scan\":{\n      \"analyzer\":{\n      \"id\":\"secrets\",\n      \"name\":\"secrets\",\n      \"url\":\"https://gitlab.com/gitlab-org/security-products/analyzers/secrets\",\n      \"vendor\":{\n      \"name\":\"GitLab\"\n    },\n      \"version\":\"4.5.4\"\n    },\n      \"scanner\":{\n      \"id\":\"gitleaks\",\n      \"name\":\"Gitleaks\",\n      \"url\":\"https://github.com/zricethezav/gitleaks\",\n      \"vendor\":{\n      \"name\":\"GitLab\"\n    },\n      \"version\":\"8.15.0\"\n    },\n      \"type\":\"secret_detection\",\n      \"start_time\":\"2022-12-30T02:08:44\",\n      \"end_time\":\"2022-12-30T02:08:44\",\n      \"status\":\"success\"\n    }\n    }\n</code></pre> <p></p> <p>\u67e5\u770b\u6f0f\u6d1e\u62a5\u544a</p> <p></p> <p>\u8fd9\u4e2a\u4f8b\u5b50\u627e\u5230\u4e86\u6211\u4eec\u7684\u201cFake.Json\u201d\u6587\u4ef6\u3002\u5728\u8be6\u7ec6\u4fe1\u606f\u9875\u9762\u4e0a\uff0c\u5355\u51fb\"Fake.json:3\". \u8be5\u5de5\u5177\u4f1a\u5c06\u60a8\u5b9a\u5411\u5230\u627e\u5230\u7684\u7279\u5b9a\u6587\u4ef6\u548c\u51ed\u636e\uff1a</p> <p></p>"},{"location":"chap6/4pip_secret/#_4","title":"\u603b\u7ed3","text":"<p>\u603b\u4e4b\uff0c\u4ece\u5b89\u5168\u89d2\u5ea6\u6765\u770b\uff0c\u60a8\u53ef\u4ee5\u770b\u5230\u8fd9\u662f\u7b80\u5355\u4e14\u6709\u4ef7\u503c\u7684\u3002\u4e00\u65e6\u4f60\u7684\u79d8\u5bc6\u88ab\u63d0\u4ea4\uff0c\u4fee\u590d\u8d77\u6765\u5c31\u662f\u4e00\u4e2a\u75db\u82e6\u7684\u8fc7\u7a0b\u3002\u8fd9\u662f\u4e00\u79cd\u65b9\u6cd5\uff0c\u4f46\u4e0d\u4f1a\u5426\u5b9a\u5bf9\u51ed\u636e\u548c\u673a\u5bc6\u5b58\u50a8\u8fdb\u884c\u201c\u9884\u63d0\u4ea4\u626b\u63cf\u201d\u6216\u4f7f\u7528vault\u7684\u9700\u8981\u3002</p>"},{"location":"chap7/1deploy_pip/","title":"1 \u9879\u76ee\u4ea4\u4ed8\u6d41\u6c34\u7ebf\u4f18\u5316\u540e\u6a21\u677f\u5e93\u914d\u7f6e","text":""},{"location":"chap7/1deploy_pip/#_1","title":"\u76ee\u5f55\u7ed3\u6784","text":"<p>\u57fa\u672c\u4e0a\u8fd8\u662f\u6309\u7167\u4e4b\u524d\u7684\u76ee\u5f55\u7ed3\u6784\u5b8c\u6210\u7684\uff0cjobs\u76ee\u5f55\u7528\u4e8e\u5b58\u653e\u4f5c\u4e1a\u6a21\u677f\u3002templates\u76ee\u5f55\u7528\u4e8e\u5b58\u653e\u6d41\u6c34\u7ebf\u6a21\u677f\u3002 \u8fd9\u6b21\u4f7f\u7528<code>default-pipeline.yml</code>\u4f5c\u4e3a\u6240\u6709\u4f5c\u4e1a\u7684\u57fa\u7840\u6a21\u677f\u3002</p> <p></p>"},{"location":"chap7/1deploy_pip/#_2","title":"\u4f5c\u4e1a\u6a21\u677f","text":"<p>\u4f5c\u4e1a\u5206\u4e3aBuild\u3001test\u3001codeanalysis\u3001artifactory\u3001deploy\u90e8\u5206</p> <p><code>jobs/build.yml</code> \u5305\u542b\u4e24\u4e2a\u4f5c\u4e1a\u6a21\u677f\uff0c\u5206\u522b\u662f\u666e\u901a\u7684\u6784\u5efa\u6a21\u677f\u548cdocker \u955c\u50cf\u6784\u5efa\u6a21\u677f\u3002</p> <pre><code>## build\u76f8\u5173\u4f5c\u4e1a\n##\n\n.build:\n  stage: build\n  script: \n    - |\n      ${BUILD_SHELL}\n  variables:\n    GIT_CHECKOUT: \"true\"\n  rules:\n    - if: \" $RUN_PIPELINE_BUILD == 'no' \"\n      when: never\n    - when: always\n\n\n## \u6784\u5efa\u955c\u50cf\n.build-docker:\n  stage: buildimage\n  script:\n    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWD  $CI_REGISTRY\n    - docker build -t ${IMAGE_NAME} -f ${DOCKER_FILE_PATH} .\n    - docker push ${IMAGE_NAME} \n    - docker rmi ${IMAGE_NAME} \n  rules:\n    - if: \" $RUN_BUILD_IMAGE == 'no' \"\n      when: never\n    - when: always\n</code></pre> <p><code>jobs/test.yml</code> \u8bbe\u7f6e\u9879\u76ee\u5355\u5143\u6d4b\u8bd5</p> <pre><code>#\u5355\u5143\u6d4b\u8bd5\n.test:\n  stage: test\n  script:\n    - $TEST_SHELL\n  artifacts:\n    reports:\n      junit: ${JUNIT_REPORT_PATH}\n  rules:\n    - if: \" $RUN_PIPELINE_TEST == 'no' \"\n      when: never\n    - when: always\n</code></pre> <p><code>jobs/codeanalysis.yml</code>\u5305\u542b\u4e24\u4e2a\u4f5c\u4e1a\u6a21\u677f\uff0c\u5206\u522b\u4e3a\u626b\u63cf\u4f5c\u4e1a\u548c\u83b7\u53d6\u626b\u63cf\u7ed3\u679c\u3002</p> <pre><code>#\u4ee3\u7801\u626b\u63cf\n##\n##\n##\n\n.code_analysis:\n  variables:\n    GLOBAL_PROJECT_ARGS: \"-Dsonar.projectKey=${CI_PROJECT_NAME} \n                          -Dsonar.projectName=${CI_PROJECT_NAME} \n                          -Dsonar.projectVersion=${CI_COMMIT_REF_NAME} \n                          -Dsonar.projectDescription=${CI_PROJECT_TITLE}\"\n    GLOBAL_SERVER_ARGS:  \"-Dsonar.ws.timeout=30 \n                          -Dsonar.links.homepage=${CI_PROJECT_URL} \n                          -Dsonar.host.url=${SONAR_SERVER_URL} \n                          -Dsonar.login=${SONAR_SERVER_LOGIN}\n                          -Dsonar.sourceEncoding=UTF-8 \"\n    GLOBAL_MR_ARGS: \" -Dsonar.pullrequest.key=${CI_MERGE_REQUEST_IID} \n                      -Dsonar.pullrequest.branch=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} \n                      -Dsonar.pullrequest.base=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME} \n                      -Dsonar.gitlab.ref_name=${CI_COMMIT_REF_NAME} \n                      -Dsonar.gitlab.commit_sha=${CI_COMMIT_SHA} \n                      -Dsonar.gitlab.project_id=${CI_PROJECT_PATH} \n                      -Dsonar.pullrequest.gitlab.repositorySlug=${CI_PROJECT_ID} \"\n    MULTI_BRANCH_ARGS: \"-Dsonar.branch.name=${CI_COMMIT_REF_NAME}\"\n  stage: code_analysis\n  script:\n    - echo ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} ${GLOBAL_MR_ARGS}\n    #sonar-scanner $GLOBAL_PROJECT_ARGS $GLOBAL_SERVER_ARGS $SCAN_JAVA_ARGS\n    - |\n        if [ $CI_PIPELINE_SOURCE == 'merge_request_event' ] \n\n        then\n           echo \"sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} \" \n           sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} \n        else \n           echo \"sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS} ${MULTI_BRANCH_ARGS}\"\n           sonar-scanner ${GLOBAL_PROJECT_ARGS} ${GLOBAL_SERVER_ARGS} ${SONAR_SCAN_ARGS}  ${MULTI_BRANCH_ARGS}\n        fi \n  rules:\n    - if: \" $RUN_CODE_ANALYSIS == 'no' \"\n      when: never\n    - when: always\n\n\n#### \u83b7\u53d6\u4ee3\u7801\u626b\u63cf\u7ed3\u679c\n.get_analysis_result:\n  stage: get_analysis_result\n  script:\n    - |\n        SONAR_REPORT_URL=$(grep \"ceTaskUrl\" .scannerwork/report-task.txt  | awk -F = '{OFS=\"=\";print $2,$3}')\n        echo ${SONAR_REPORT_URL}\n\n\n        for i in {1..10}\n        do\n          curl -k -u \"${SONAR_SERVER_LOGIN}\":\"\" ${SONAR_REPORT_URL}  -o sonar_result.txt -s\n          grep '\"status\":\"SUCCESS\"' sonar_result.txt  &amp;&amp; SONAR_SCAN_RESULT='SUCCESS'\n\n          if [ ${SONAR_SCAN_RESULT} == 'SUCCESS' ]\n            then\n              echo \"${SONAR_SCAN_RESULT}\"\n              SONAR_SCAN_RESULT=SUCCESS\n\n              curl -k -u \"${SONAR_SERVER_LOGIN}\":\"\" \"${SONAR_SERVER_URL}/api/qualitygates/project_status?projectKey=$CI_PROJECT_NAME&amp;branch=$CI_COMMIT_REF_NAME\" -o result.txt  -s\n              echo \"result info ----&gt;&gt;&gt;&gt;&gt;\"\n              cat result.txt\n              result=`cat result.txt | awk -F ':' '{print $3}' | awk -F '\"' '{print$2}'`\n\n              echo $result\n\n              if [ $result == 'ERROR' ]                 \n                then \n                  echo \"${result}\"\n                  exit 122\n                  break;\n              else\n                  echo \"success!\"\n                  break;\n              fi\n\n          else\n            SONAR_SCAN_RESULT='ERROR'\n            echo \"\u7b2c$i\u6b21\u83b7\u53d6\u7ed3\u679c\u4fe1\u606f\uff0c\u4e0d\u662f\u6210\u529f\u72b6\u6001\uff0c\u7761\u772010\u79d2\uff01\"\n            cat sonar_result.txt\n            sleep 10\n          fi\n        done\n\n  rules:\n    - if: \" $RUN_CODE_ANALYSIS == 'no' \"\n      when: never\n    - when: always\n</code></pre> <p><code>jobs/artifactory.yml</code> \u5305\u542b\u4e24\u4e2a\u4f5c\u4e1a\uff0c\u5236\u54c1\u4e0a\u4f20\u4e0e\u4e0b\u8f7d\u3002</p> <pre><code>## \u5236\u54c1\u5e93\u76f8\u5173\n##\n\n.deploy-artifact:\n  stage: deploy-artifact\n  script:\n    - echo \"curl -u${ARTIFACT_USER}:${ARTIFACT_PASSWD} -T ${ARTIFACT_PATH} $ARTIFACTORY_URL/$ARTIFACTORY_NAME/$TARGET_FILE_PATH/$TARGET_ARTIFACT_NAME\"\n    - curl -u${ARTIFACT_USER}:${ARTIFACT_PASSWD} -T ${ARTIFACT_PATH} \"$ARTIFACTORY_URL/$ARTIFACTORY_NAME/$TARGET_FILE_PATH/$TARGET_ARTIFACT_NAME\"\n  rules:\n    - if: \" $RUN_DEPLOY_ARTIFACTS == 'no' \"\n      when: never\n    - when: always\n\n\n.down-artifact:\n  stage: down-artifact\n  script:\n    - curl -u${ARTIFACT_USER}:${ARTIFACT_PASSWD} -O \"$ARTIFACTORY_URL/$ARTIFACTORY_NAME/$TARGET_FILE_PATH/$TARGET_ARTIFACT_NAME\"\n    - ls\n</code></pre> <p><code>jobs/deploy.yml</code> \u53d1\u5e03\u57fa\u4e8ek8s\u7684\u53d1\u5e03\u548c\u56de\u6eda\u914d\u7f6e\u3002</p> <pre><code>## \u5e94\u7528\u53d1\u5e03\n\n\n## \u4f7f\u7528kubectl\u955c\u50cf\u53d1\u5e03\n.deploy_k8s:\n  stage: deploy\n  script:\n    - echo $KUBE_TOKEN\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - ls -a \n    - sed -i \"s#__namespace__#${NAMESPACE}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__appname__#${APP_NAME}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__containerport__#${CONTAINER_PORT}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__nodeport__#${NODE_PORT}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__imagename__#${IMAGE_NAME}#g\" ${DEPLOY_FILE} \n    - sed -i \"s#__CI_ENVIRONMENT_SLUG__#${CI_ENVIRONMENT_SLUG}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__CI_PROJECT_PATH_SLUG__#${CI_PROJECT_PATH_SLUG}#g\" ${DEPLOY_FILE}\n    - sed -i \"s#__ingressdomain__#${ENV_URL}#g\" ${DEPLOY_FILE}\n    - cat ${DEPLOY_FILE}\n    - \"kubectl create secret docker-registry ${APP_NAME} \\\n            --docker-server=${CI_REGISTRY} \\\n            --docker-username=$CI_REGISTRY_USER \\\n            --docker-password=${CI_REGISTRY_PASSWD} \\\n            --docker-email=test@test.com -n ${NAMESPACE} || echo 'secrets already exists'\"\n    - kubectl apply -f ${DEPLOY_FILE}\n  rules:\n    - if: \" $RUN_DEPLOY_K8S == 'no'\"\n      when: never\n    - when: manual\n  environment:\n    name: \"${ENV_NAME}\"\n    url: \"http://${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"\n\n\n\n\n## \u56de\u6eda\n.rollout_k8s:\n  stage: deploy\n  script:\n    - rm -rf $HOME/.kube\n    - kubectl config set-cluster my-cluster --server=${KUBE_URL} --certificate-authority=\"${KUBE_CA_PEM_FILE}\"\n    - kubectl config set-credentials admin --token=${KUBE_TOKEN}\n    - kubectl rollout history deployment ${APP_NAME} -n ${NAMESPACE}\n    - kubectl rollout undo deployment ${APP_NAME} -n ${NAMESPACE}\n  rules:\n    - if: \" $RUN_DEPLOY_K8S == 'no' \"\n      when: never\n    - when: manual\n  environment:\n    name: \"${ENV_NAME}\"\n    action: stop\n</code></pre>"},{"location":"chap7/1deploy_pip/#default","title":"default\u6d41\u6c34\u7ebf\u6a21\u677f","text":"<p><code>templates/default-pipeline.yml</code> \u6a21\u677f\u5206\u6210\u4e2a\u90e8\u5206</p> <ul> <li>include\u5bfc\u5165\u4f5c\u4e1a\u6a21\u677f</li> <li>variables \u5b9a\u4e49\u5168\u5c40\u53d8\u91cf</li> <li>workflow \u5b9a\u4e49\u6d41\u6c34\u7ebf\u63a7\u5236</li> <li>jobs \u6784\u5efa\u4e0e\u53d1\u5e03\u4f5c\u4e1a</li> </ul> <p>include\u5bfc\u5165\u4f5c\u4e1a\u6a21\u677f</p> <pre><code>Include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/build.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/test.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/codeanalysis.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/deploy.yml'\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'jobs/artifactory.yml'\n</code></pre>"},{"location":"chap7/1deploy_pip/#variables","title":"variables \u5b9a\u4e49\u5168\u5c40\u53d8\u91cf","text":"<pre><code>variables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: ${CI_BUILDS_DIR}/builds/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_PIPELINE_ID}    \n  GIT_CHECKOUT: \"false\"\n  CACHE_DIR: \"\"\n\n  ## \u4f5c\u4e1a\u63a7\u5236\n  RUN_PIPELINE_BUILD: \"\"     #\u662f\u5426\u8fd0\u884c\u6784\u5efa yes/no \n  RUN_PIPELINE_TEST: \"\"      #\u662f\u5426\u8fd0\u884c\u6d4b\u8bd5 yes/no \n  RUN_CODE_ANALYSIS: \"\"      #\u662f\u5426\u4ee3\u7801\u626b\u63cf yes/no \n  RUN_BUILD_IMAGE: \"\"        #\u662f\u5426\u751f\u6210\u955c\u50cf yes/no\n  RUN_DEPLOY_ARTIFACTS: \"\"   #\u662f\u5426\u4e0a\u4f20\u5236\u54c1 yes/no\n  RUN_DEPLOY_K8S: \"\"         #\u662f\u5426\u53d1\u5e03K8S yes/no\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"\"\n  CURL_IMAGE: \"curlimages/curl:7.70.0\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n  KUBECTL_IMAGE: \"lucj/kubectl:1.17.2\"\n\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"\"                #maven\u6784\u5efa\u53c2\u6570 \n  GRADLE_OPTS: \"\"               #gradle\u6784\u5efa\u53c2\u6570\n  BUILD_SHELL: ''               #\u6784\u5efa\u547d\u4ee4\n\n  ## \u5355\u5143\u6d4b\u8bd5\u53c2\u6570\n  TEST_SHELL : 'mvn test  --settings=./settings.xml '       #\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   #\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_SOURCE_DIR : \"src\"                                          #\u9879\u76ee\u6e90\u7801\u76ee\u5f55\n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\"                    #SonarQube\u670d\u52a1\u5668\u4fe1\u606f\n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\"    #Sonar Token\u6700\u597d\u5728\u9879\u76ee\u4e2d\u5b9a\u4e49\u3002\n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR}\"            #\u9879\u76ee\u626b\u63cf\u53c2\u6570\n\n  ## \u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'               #\u955c\u50cf\u4ed3\u5e93\u5730\u5740              \n  CI_REGISTRY_USER: 'xxxxxx'                               #\u4ed3\u5e93\u7528\u6237\u4fe1\u606f\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'                              #\u4ed3\u5e93\u7528\u6237\u5bc6\u7801\n  IMAGE_NAME: \"${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"     #\u955c\u50cf\u540d\u79f0\n  DOCKER_FILE_PATH: \"./Dockerfile\"                              #Dockerfile\u4f4d\u7f6e\n\n  ## \u4e0a\u4f20\u5236\u54c1\u5e93(artifactory)\n  ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"     #\u5236\u54c1\u5e93\u5730\u5740\n  ARTIFACTORY_NAME: \"${CI_PROJECT_NAMESPACE}\"                   #\u5236\u54c1\u5e93\u540d\u79f0\n  ARTIFACT_PACKAGE: \"jar\"                                       #\u5236\u54c1\u7c7b\u578b\n  ARTIFACT_PATH: \"target/*.${ARTIFACT_PACKAGE}\"                 #\u5236\u54c1\u4f4d\u7f6e\n  TARGET_FILE_PATH: \"${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"   #\u76ee\u6807\u5236\u54c1\u4f4d\u7f6e(\u76ee\u5f55\u7ed3\u6784)\n  TARGET_ARTIFACT_NAME: \"${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}.${ARTIFACT_PACKAGE}\"   #\u76ee\u6807\u5236\u54c1\u540d\u79f0\n\n  ## \u90e8\u7f72\u5e94\u7528k8s\n  APP_NAME: \"$CI_PROJECT_NAME\"                #\u5e94\u7528\u540d\u79f0 &lt;--&gt; deploymentName\n  CONTAINER_PORT: \"8081\"                      #\u670d\u52a1\u7aef\u53e3 &lt;--&gt; servicesPort\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"             #\u540d\u79f0\u7a7a\u95f4\n  ENV_URL: \"${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"  #IngressHosts\n</code></pre>"},{"location":"chap7/1deploy_pip/#_3","title":"\u6d41\u6c34\u7ebf\u8bbe\u7f6e","text":"<pre><code>## \u6d41\u6c34\u7ebf\u63a7\u5236\nworkflow:\n  rules:\n    - if: \"$CI_MERGE_REQUEST_ID\"          #\u8fc7\u6ee4\u5408\u5e76\u8bf7\u6c42\n      when: never\n    - if: \"$CI_PIPELINE_SOURCE == 'web'\"    #\u5141\u8bb8\u5728web\u9875\u9762\u53d1\u5e03\n    - if: \"$CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ \"  #\u8fc7\u6ee4\u7248\u672c\u5206\u652f\u548c\u4e3b\u5e72\u5206\u652f\u63d0\u4ea4\u4ee3\u7801\u89e6\u53d1\n      when: never\n    - if: \"$CI_COMMIT_BEFORE_SHA == '0000000000000000000000000000000000000000'\"     #\u8fc7\u6ee4\u5206\u652f\u521b\u5efa\u8bf7\u6c42\n      when: never\n    ### \u9ed8\u8ba4\u7b56\u7565\n    - when: always\n\n\n## \u8fd0\u884c\u9636\u6bb5  \nstages:\n  - build\n  - test\n  - parallel01\n  - get_analysis_result\n  - deploy-artifact\n  - deploy-feature\n  - rollout-feature\n  - deploy-uat\n  - rollout-uat\n  - deploy-stag\n  - rollout-stag\n  - deploy-prod\n  - rollout-prod\n\ncache:\n  paths:\n    - ${CACHE_DIR}\n\nbefore_script:\n  - export\n</code></pre>"},{"location":"chap7/1deploy_pip/#_4","title":"\u6784\u5efa\u4f5c\u4e1a\u914d\u7f6e","text":"<pre><code>################# Jobs Configure #####################\n## \u6784\u5efa\u4f5c\u4e1a\nbuild:\n  image: ${BUILD_IMAGE}\n  extends: .build\n\n## \u6d4b\u8bd5\u4f5c\u4e1a\ntest:\n  image: ${BUILD_IMAGE}\n  extends: .test\n  before_script:\n    - ls \n    - ls ${CACHE_DIR}\n\n## \u4ee3\u7801\u626b\u63cf\ncode_analysis:\n  stage: parallel01\n  image: ${SONAR_IMAGE}\n  extends: .code_analysis\n\n## \u83b7\u53d6\u6784\u5efa\u7ed3\u679c\nget_analysis_result:\n  image: ${CURL_IMAGE}\n  extends: .get_analysis_result\n  needs:\n    - code_analysis\n\n\n## \u6784\u5efa\u955c\u50cf\nbuild_image:\n  image: docker:latest\n  services:\n    - name: docker:dind\n  stage: parallel01\n  extends: .build-docker\n\n\n## \u4e0a\u4f20\u5236\u54c1\ndeploy_artifact:\n  image: ${CURL_IMAGE}\n  stage: deploy-artifact\n  extends: .deploy-artifact\n\n## \u4e0b\u8f7d\u5236\u54c1  \n#down_artifact:  \n#  image: ${CURL_IMAGE}\n#  stage: down_artifact\n#  extends: .down-artifact\n</code></pre>"},{"location":"chap7/1deploy_pip/#_5","title":"\u53d1\u5e03\u90e8\u7f72\u4f5c\u4e1a\u914d\u7f6e","text":"<pre><code>#################Deploy Feature Jobs Configure #####################\n## feature\u53d1\u5e03\u5e94\u7528\ndeploy_feature:\n  variables:\n    DEPLOY_FILE: 'deployment.yaml'\n    ENV_NAME: 'feature'\n  stage: deploy-feature\n  image: ${KUBECTL_IMAGE}\n  extends: .deploy_k8s\n  environment:\n    on_stop: \"rollout_feature\"\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: never\n    - when: manual\n\n## \u5e94\u7528\u56de\u6eda\nrollout_feature:\n  variables:\n    DEPLOY_FILE: 'deployment.yaml'\n    ENV_NAME: 'feature'\n  stage: rollout-feature\n  image: ${KUBECTL_IMAGE}\n  extends: .rollout_k8s\n  needs:\n    - deploy_feature\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: never\n    - when: on_failure\n\n\n#################Deploy UAT Jobs Configure #####################\n## UAT\ndeploy_uat:\n  variables:\n    DEPLOY_FILE: 'config/deployment-uat.yaml'\n    ENV_NAME: 'uat'\n  stage: deploy-uat\n  image: ${KUBECTL_IMAGE}\n  extends: .deploy_k8s\n  environment:\n    on_stop: \"rollout_uat\"\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: manual\n    - when: never\n\n## UAT\u5e94\u7528\u56de\u6eda\nrollout_uat:\n  variables:\n    DEPLOY_FILE: 'config/deployment-uat.yaml'\n    ENV_NAME: 'uat'\n  stage: rollout-uat\n  image: ${KUBECTL_IMAGE}\n  extends: .rollout_k8s\n  needs:\n    - deploy_uat\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: on_failure\n    - when: never\n\n#################Deploy STAG Jobs Configure #####################\n## STAG\ndeploy_stag:\n  variables:\n    DEPLOY_FILE: 'config/deployment-stag.yaml'\n    ENV_NAME: 'stag'\n  stage: deploy-stag\n  image: ${KUBECTL_IMAGE}\n  extends: .deploy_k8s\n  environment:\n    on_stop: \"rollout_stag\"\n  needs:\n    - deploy_uat\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: manual\n    - when: never\n\n## STAG\u5e94\u7528\u56de\u6eda\nrollout_stag:\n  variables:\n    DEPLOY_FILE: 'config/deployment-stag.yaml'\n    ENV_NAME: 'stag'\n  stage: rollout-stag\n  image: ${KUBECTL_IMAGE}\n  extends: .rollout_k8s\n  needs:\n    - deploy_stag\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: on_failure\n    - when: never\n\n#################Deploy PROD Jobs Configure #####################\n## PROD\ndeploy_prod:\n  variables:\n    DEPLOY_FILE: 'config/deployment-prod.yaml'\n    ENV_NAME: 'prod'\n  stage: deploy-prod\n  image: ${KUBECTL_IMAGE}\n  extends: .deploy_k8s\n  environment:\n    on_stop: \"rollout_prod\"\n  needs:\n    - deploy_stag\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: manual\n    - when: never\n\n## PROD\u5e94\u7528\u56de\u6eda\nrollout_prod:\n  variables:\n    DEPLOY_FILE: 'config/deployment-prod.yaml'\n    ENV_NAME: 'prod'\n  stage: rollout-prod\n  image: ${KUBECTL_IMAGE}\n  extends: .rollout_k8s\n  needs:\n    - deploy_prod\n  rules:\n    - if: $RUN_DEPLOY_K8S == 'no'\n      when: never\n    - if: $CI_COMMIT_REF_NAME =~ /^RELEASE-*/ || $CI_COMMIT_REF_NAME =~ /master/ || $CI_COMMIT_TAG\n      when: on_failure\n    - when: never\n</code></pre>"},{"location":"chap7/2deploy_projs/","title":"2 \u9879\u76ee\u6d41\u6c34\u7ebf(JAVA+NPM+\u5b89\u5353)","text":""},{"location":"chap7/2deploy_projs/#1-java","title":"1 \u540e\u7aefJava\u9879\u76ee\u6d41\u6c34\u7ebf","text":"<p><code>templates/java-pipeline.yml</code></p> <p>\u5bfc\u5165\u4f5c\u4e1a\u6a21\u677f</p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'templates/default-pipeline.yml'\n</code></pre> <p>\u914d\u7f6e\u9879\u76ee\u53c2\u6570</p> <pre><code>variables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: ${CI_BUILDS_DIR}/builds/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_PIPELINE_ID}    \n  GIT_CHECKOUT: \"false\"\n  CACHE_DIR: \"target/\"\n\n  ## \u4f5c\u4e1a\u63a7\u5236\n  RUN_PIPELINE_BUILD:   \"yes\"     #\u662f\u5426\u8fd0\u884c\u6784\u5efa yes/no \n  RUN_PIPELINE_TEST:    \"yes\"      #\u662f\u5426\u8fd0\u884c\u6d4b\u8bd5 yes/no \n  RUN_CODE_ANALYSIS:    \"yes\"     #\u662f\u5426\u4ee3\u7801\u626b\u63cf yes/no \n  RUN_BUILD_IMAGE:      \"yes\"     #\u662f\u5426\u751f\u6210\u955c\u50cf yes/no\n  RUN_DEPLOY_ARTIFACTS: \"no\"      #\u662f\u5426\u4e0a\u4f20\u5236\u54c1 yes/no\n  RUN_DEPLOY_K8S:       \"yes\"     #\u662f\u5426\u53d1\u5e03K8S yes/no\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"maven:3.6.3-jdk-8\"\n  CURL_IMAGE: \"curlimages/curl:7.70.0\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n  KUBECTL_IMAGE: \"lucj/kubectl:1.17.2\"\n\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"-Dmaven.repo.local=/home/gitlab-runner/ci-build-cache/maven \"  #maven\u6784\u5efa\u53c2\u6570\n  BUILD_SHELL: 'mvn clean package  -DskipTests  --settings=./settings.xml '   #\u6784\u5efa\u547d\u4ee4\n  #GRADLE_OPTS: \"\"               #gradle\u6784\u5efa\u53c2\u6570\n\n  ## \u5355\u5143\u6d4b\u8bd5\u53c2\u6570\n  TEST_SHELL : 'mvn test  --settings=./settings.xml   '       #\u6d4b\u8bd5\u547d\u4ee4\n  JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   #\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_SOURCE_DIR : \"src\"                                          #\u9879\u76ee\u6e90\u7801\u76ee\u5f55\n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\"                    #SonarQube\u670d\u52a1\u5668\u4fe1\u606f\n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\"    #Sonar Token\u6700\u597d\u5728\u9879\u76ee\u4e2d\u5b9a\u4e49\u3002\n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR} \n                   -Dsonar.java.binaries=target/classes \n                   -Dsonar.java.test.binaries=target/test-classes \n                   -Dsonar.java.surefire.report=target/surefire-reports \"                                     #\u9879\u76ee\u626b\u63cf\u53c2\u6570\n\n  ## \u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'               #\u955c\u50cf\u4ed3\u5e93\u5730\u5740              \n  CI_REGISTRY_USER: 'xxxxxx'                               #\u4ed3\u5e93\u7528\u6237\u4fe1\u606f\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'                              #\u4ed3\u5e93\u7528\u6237\u5bc6\u7801\n  IMAGE_NAME: \"${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"     #\u955c\u50cf\u540d\u79f0\n  DOCKER_FILE_PATH: \"./Dockerfile\"                              #Dockerfile\u4f4d\u7f6e\n\n  ## \u4e0a\u4f20\u5236\u54c1\u5e93(artifactory)\n  #ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"     #\u5236\u54c1\u5e93\u5730\u5740\n  #ARTIFACTORY_NAME: \"${CI_PROJECT_NAMESPACE}\"                   #\u5236\u54c1\u5e93\u540d\u79f0\n  #ARTIFACT_PACKAGE: \"jar\"                                       #\u5236\u54c1\u7c7b\u578b\n  #ARTIFACT_PATH: \"target/*.${ARTIFACT_PACKAGE}\"                 #\u5236\u54c1\u4f4d\u7f6e\n  #TARGET_FILE_PATH: \"${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"   #\u76ee\u6807\u5236\u54c1\u4f4d\u7f6e(\u76ee\u5f55\u7ed3\u6784)\n  #TARGET_ARTIFACT_NAME: \"${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}.${ARTIFACT_PACKAGE}\"   #\u76ee\u6807\u5236\u54c1\u540d\u79f0\n\n  ## \u90e8\u7f72\u5e94\u7528k8s\n  APP_NAME: \"$CI_PROJECT_NAME\"                #\u5e94\u7528\u540d\u79f0 &lt;--&gt;deploymentName\n  CONTAINER_PORT: \"8081\"                      #\u670d\u52a1\u7aef\u53e3 &lt;--&gt; servicesPort\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"             #\u540d\u79f0\u7a7a\u95f4\n  ENV_URL: \"${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"  #IngressHosts\n</code></pre> <p>\u9879\u76ee\u6307\u5b9aci\u6587\u4ef6</p> <p></p> <p>\u8fd0\u884c\u6d41\u6c34\u7ebf\u6d4b\u8bd5</p> <p></p> <p>docker\u955c\u50cf\u4ed3\u5e93</p> <p></p> <p>\u90e8\u7f72\u73af\u5883\u6f14\u793a</p> <p></p>"},{"location":"chap7/2deploy_projs/#2","title":"2 \u524d\u7aef\u9879\u76ee\u6d41\u6c34\u7ebf\u5b9e\u8df5","text":"<ul> <li>\u4f7f\u7528npm\u6253\u5305\uff08\u9700\u8981\u7528\u5230npm\u955c\u50cf\uff09</li> <li>\u7f16\u5199Dockerfile \uff08\u9700\u8981\u7528\u5230nginx\u955c\u50cf\uff09</li> <li>\u7f16\u5199Deployment\u90e8\u7f72\u6587\u4ef6</li> </ul> <p>\u57fa\u4e8e\u9ed8\u8ba4\u5bb9\u5668\u6d41\u6c34\u7ebf\u6a21\u677f\uff0c\u6539\u9020\u6210\u524d\u7aef\u6d41\u6c34\u7ebf\u3002</p> <p><code>templates/web-pipeline.yml</code></p> <p></p> <p>\u5bfc\u5165\u4f5c\u4e1a\u6a21\u677f</p> <pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'templates/default-pipeline.yml'\n</code></pre> <p>\u914d\u7f6e\u5168\u5c40\u53c2\u6570</p> <pre><code>ariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: ${CI_BUILDS_DIR}/builds/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_PIPELINE_ID}    \n  GIT_CHECKOUT: \"false\"\n  CACHE_DIR: \"dist/\"\n\n  ## \u4f5c\u4e1a\u63a7\u5236\n  RUN_PIPELINE_BUILD:   \"yes\"     #\u662f\u5426\u8fd0\u884c\u6784\u5efa yes/no \n  RUN_PIPELINE_TEST:    \"no\"      #\u662f\u5426\u8fd0\u884c\u6d4b\u8bd5 yes/no \n  RUN_CODE_ANALYSIS:    \"yes\"     #\u662f\u5426\u4ee3\u7801\u626b\u63cf yes/no \n  RUN_BUILD_IMAGE:      \"yes\"     #\u662f\u5426\u751f\u6210\u955c\u50cf yes/no\n  RUN_DEPLOY_ARTIFACTS: \"no\"      #\u662f\u5426\u4e0a\u4f20\u5236\u54c1 yes/no\n  RUN_DEPLOY_K8S:       \"yes\"     #\u662f\u5426\u53d1\u5e03K8S yes/no\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"node:14.3.0-alpine3.11\"\n  CURL_IMAGE: \"curlimages/curl:7.70.0\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n  KUBECTL_IMAGE: \"lucj/kubectl:1.17.2\"\n\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"\"                #maven\u6784\u5efa\u53c2\u6570 \n  GRADLE_OPTS: \"\"               #gradle\u6784\u5efa\u53c2\u6570\n  BUILD_SHELL: \" npm config set prefix /home/gitlab-runner/ci-build-cache/npm\n                npm config set cache  /home/gitlab-runner/ci-build-cache/npm\n                npm config set registry https://registry.npm.taobao.org\n                npm install  \n                npm run build \"            #\u6784\u5efa\u547d\u4ee4\n\n  ## \u5355\u5143\u6d4b\u8bd5\u53c2\u6570\n  #TEST_SHELL : 'echo npm run test  '       #\u6d4b\u8bd5\u547d\u4ee4\n  #JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   #\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_SOURCE_DIR : \"src\"                                          #\u9879\u76ee\u6e90\u7801\u76ee\u5f55\n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\"                    #SonarQube\u670d\u52a1\u5668\u4fe1\u606f\n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\"    #Sonar Token\u6700\u597d\u5728\u9879\u76ee\u4e2d\u5b9a\u4e49\u3002\n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR}\"                                               #\u9879\u76ee\u626b\u63cf\u53c2\u6570\n\n  ## \u6784\u5efa\u955c\u50cf\n  CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'               #\u955c\u50cf\u4ed3\u5e93\u5730\u5740              \n  CI_REGISTRY_USER: 'xxxxxx'                               #\u4ed3\u5e93\u7528\u6237\u4fe1\u606f\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'                              #\u4ed3\u5e93\u7528\u6237\u5bc6\u7801\n  IMAGE_NAME: \"${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"     #\u955c\u50cf\u540d\u79f0\n  DOCKER_FILE_PATH: \"./Dockerfile\"                              #Dockerfile\u4f4d\u7f6e\n\n  ## \u4e0a\u4f20\u5236\u54c1\u5e93(artifactory)\n  #ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"     #\u5236\u54c1\u5e93\u5730\u5740\n  #ARTIFACTORY_NAME: \"${CI_PROJECT_NAMESPACE}\"                   #\u5236\u54c1\u5e93\u540d\u79f0\n  #ARTIFACT_PACKAGE: \"jar\"                                       #\u5236\u54c1\u7c7b\u578b\n  #ARTIFACT_PATH: \"target/*.${ARTIFACT_PACKAGE}\"                 #\u5236\u54c1\u4f4d\u7f6e\n  #TARGET_FILE_PATH: \"${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"   #\u76ee\u6807\u5236\u54c1\u4f4d\u7f6e(\u76ee\u5f55\u7ed3\u6784)\n  #TARGET_ARTIFACT_NAME: \"${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}.${ARTIFACT_PACKAGE}\"   #\u76ee\u6807\u5236\u54c1\u540d\u79f0\n\n  ## \u90e8\u7f72\u5e94\u7528k8s\n  APP_NAME: \"$CI_PROJECT_NAME\"                #\u5e94\u7528\u540d\u79f0 &lt;--&gt;deploymentName\n  CONTAINER_PORT: \"80\"                      #\u670d\u52a1\u7aef\u53e3 &lt;--&gt; servicesPort\n  NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"             #\u540d\u79f0\u7a7a\u95f4\n  ENV_URL: \"${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"  #IngressHosts\n\n\n## \u7f13\u5b58\ncache:\n  paths:\n    - ${CACHE_DIR}\n    - node_modules/\n</code></pre> <p>\u6307\u5b9aCI\u6587\u4ef6</p> <p></p> <p>\u8fd0\u884c\u6d41\u6c34\u7ebf\u6d4b\u8bd5</p> <p></p> <p>docker\u955c\u50cf\u4ed3\u5e93</p> <p></p> <p>\u90e8\u7f72\u73af\u5883\u6f14\u793a</p> <p></p> <p></p>"},{"location":"chap7/2deploy_projs/#3","title":"3 \u79fb\u52a8\u7aef\u5b89\u5353\u9879\u76ee\u6d41\u6c34\u7ebf\u5b9e\u8df5","text":""},{"location":"chap7/2deploy_projs/#1-android","title":"1. \u67e5\u627eandroid \u5f00\u53d1\u73af\u5883\u955c\u50cf","text":"<pre><code>thedrhax/android-sdk:4333796-5.6.1\n</code></pre>"},{"location":"chap7/2deploy_projs/#2_1","title":"2. \u4fee\u6539\u9879\u76ee\u4e2d\u4f9d\u8d56\u5e93\u4e3a\u963f\u91cc\u4e91","text":"<p><code>build.gradle</code></p> <p>\u963f\u91cc\u4e91\u955c\u50cf\u4ed3\u5e93\u6e90 https://maven.aliyun.com/mvn/view</p> <pre><code>buildscript {\n    repositories {\n       //google()\n       // jcenter()\n       maven { url 'https://maven.aliyun.com/repository/public/' }\n       maven { url 'https://maven.aliyun.com/repository/google' }\n       maven { url 'https://maven.aliyun.com/repository/jcenter' }\n    }\n    dependencies {\n        classpath 'com.android.tools.build:gradle:3.0.0'\n    }\n}\nallprojects {\n    repositories {\n       maven { url 'https://maven.aliyun.com/repository/public/' }\n       maven { url 'https://maven.aliyun.com/repository/google' }\n       maven { url 'https://maven.aliyun.com/repository/jcenter' }\n    }\n}\n\ntask clean(type: Delete) {\n    delete rootProject.buildDir\n}\n</code></pre>"},{"location":"chap7/2deploy_projs/#3_1","title":"3. \u6d41\u6c34\u7ebf\u6a21\u677f","text":"<pre><code>include:\n  - project: 'cidevops/cidevops-newci-service'\n    ref: master\n    file: 'templates/default-pipeline.yml'\n\nvariables:\n  ## \u5168\u5c40\u914d\u7f6e\n  GIT_CLONE_PATH: ${CI_BUILDS_DIR}/builds/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_PIPELINE_ID}    \n  GIT_CHECKOUT: \"false\"\n  CACHE_DIR: \"app/build/outputs/apk/release\"\n\n  ## \u4f5c\u4e1a\u63a7\u5236\n  RUN_PIPELINE_BUILD:   \"yes\"     #\u662f\u5426\u8fd0\u884c\u6784\u5efa yes/no \n  RUN_PIPELINE_TEST:    \"no\"      #\u662f\u5426\u8fd0\u884c\u6d4b\u8bd5 yes/no \n  RUN_CODE_ANALYSIS:    \"yes\"     #\u662f\u5426\u4ee3\u7801\u626b\u63cf yes/no \n  RUN_BUILD_IMAGE:      \"no\"     #\u662f\u5426\u751f\u6210\u955c\u50cf yes/no\n  RUN_DEPLOY_ARTIFACTS: \"yes\"      #\u662f\u5426\u4e0a\u4f20\u5236\u54c1 yes/no\n  RUN_DEPLOY_K8S:       \"no\"     #\u662f\u5426\u53d1\u5e03K8S yes/no\n\n  ## \u4f9d\u8d56\u5bb9\u5668\u955c\u50cf\n  BUILD_IMAGE: \"thedrhax/android-sdk:4333796-5.6.1\"\n  CURL_IMAGE: \"curlimages/curl:7.70.0\"\n  SONAR_IMAGE: \"sonarsource/sonar-scanner-cli:latest\"\n  KUBECTL_IMAGE: \"lucj/kubectl:1.17.2\"\n\n\n  ## \u6784\u5efa\u6d4b\u8bd5\u53c2\u6570\n  MAVEN_OPTS: \"\"                #maven\u6784\u5efa\u53c2\u6570 \n  GRADLE_OPTS: \"-Dgradle.user.home=/home/gitlab-runner/ci-build-cache/gradle\"               #gradle\u6784\u5efa\u53c2\u6570\n  BUILD_SHELL: \" gradle clean build  \"            #\u6784\u5efa\u547d\u4ee4\n\n  ## \u5355\u5143\u6d4b\u8bd5\u53c2\u6570\n  #TEST_SHELL : 'echo npm run test  '       #\u6d4b\u8bd5\u547d\u4ee4\n  #JUNIT_REPORT_PATH: 'target/surefire-reports/TEST-*.xml'   #\u5355\u5143\u6d4b\u8bd5\u62a5\u544a\n\n  ## \u4ee3\u7801\u626b\u63cf\n  SONAR_SOURCE_DIR : \"app/src\"                                          #\u9879\u76ee\u6e90\u7801\u76ee\u5f55\n  SONAR_SERVER_URL: \"http://192.168.1.200:30090\"                    #SonarQube\u670d\u52a1\u5668\u4fe1\u606f\n  SONAR_SERVER_LOGIN: \"ee2bcb37deeb6dfe3a07fe08fb529559b00c1b7b\"    #Sonar Token\u6700\u597d\u5728\u9879\u76ee\u4e2d\u5b9a\u4e49\u3002\n  SONAR_SCAN_ARGS: \"-Dsonar.sources=${SONAR_SOURCE_DIR} -Dsonar.java.binaries=app/build/intermediates/classes/release/ \" #\u9879\u76ee\u626b\u63cf\u53c2\u6570\n\n  ## \u6784\u5efa\u955c\u50cf\n  #CI_REGISTRY: 'registry.cn-beijing.aliyuncs.com'               #\u955c\u50cf\u4ed3\u5e93\u5730\u5740              \n  #CI_REGISTRY_USER: 'xxxxxx'                               #\u4ed3\u5e93\u7528\u6237\u4fe1\u606f\n  #CI_REGISTRY_PASSWD: 'xxxxxxxx.'                              #\u4ed3\u5e93\u7528\u6237\u5bc6\u7801\n  #IMAGE_NAME: \"${CI_REGISTRY}/${CI_PROJECT_PATH}:${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"     #\u955c\u50cf\u540d\u79f0\n  #DOCKER_FILE_PATH: \"./Dockerfile\"                              #Dockerfile\u4f4d\u7f6e\n\n  ## \u4e0a\u4f20\u5236\u54c1\u5e93(artifactory)\n  ARTIFACTORY_URL: \"http://192.168.1.200:30082/artifactory\"     #\u5236\u54c1\u5e93\u5730\u5740\n  ARTIFACTORY_NAME: \"${CI_PROJECT_NAMESPACE}\"                   #\u5236\u54c1\u5e93\u540d\u79f0\n  ARTIFACT_PACKAGE: \"apk\"                                       #\u5236\u54c1\u7c7b\u578b\n  ARTIFACT_PATH: \"app/build/outputs/apk/release/*.${ARTIFACT_PACKAGE}\"                 #\u5236\u54c1\u4f4d\u7f6e\n  TARGET_FILE_PATH: \"${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}/${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}\"   #\u76ee\u6807\u5236\u54c1\u4f4d\u7f6e(\u76ee\u5f55\u7ed3\u6784)\n  TARGET_ARTIFACT_NAME: \"${CI_PROJECT_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}.${ARTIFACT_PACKAGE}\"   #\u76ee\u6807\u5236\u54c1\u540d\u79f0\n\n  ## \u90e8\u7f72\u5e94\u7528k8s\n  #APP_NAME: \"$CI_PROJECT_NAME\"                #\u5e94\u7528\u540d\u79f0 &lt;--&gt;deploymentName\n  #CONTAINER_PORT: \"80\"                      #\u670d\u52a1\u7aef\u53e3 &lt;--&gt; servicesPort\n  #NAMESPACE: \"$CI_PROJECT_NAME-$CI_PROJECT_ID-$CI_ENVIRONMENT_SLUG\"             #\u540d\u79f0\u7a7a\u95f4\n  #ENV_URL: \"${ENV_NAME}.${CI_PROJECT_NAMESPACE}.${CI_PROJECT_NAME}.devops.com\"  #IngressHosts\n</code></pre> <p>FAQ</p> <p>\u7531\u4e8e\u6211\u4eec\u914d\u7f6e\u4e86<code>gradle.user.home</code>\u7f13\u5b58\u5230\u6301\u4e45\u5316\u5b58\u50a8\u4e2d\uff0c\u6240\u4ee5\u8fd9\u4e2a\u7f13\u5b58\u76ee\u5f55\u8981\u6709\u6743\u9650\u624d\u884c\u3002\u5426\u5219\u4f1a\u51fa\u73b0\u4ee5\u4e0b\u9519\u8bef\u3002</p> <pre><code>$ gradle -v\n\nFAILURE: Build failed with an exception.\n\n* What went wrong:\nFailed to load native library 'libnative-platform.so' for Linux amd64.\n\n* Try:\nRun with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output. Run with --scan to get full insights.\n\n* Get more help at https://help.gradle.org\n</code></pre> <pre><code>chmod 777 -R /opt/ci-build-cache/gradle \n</code></pre>"},{"location":"chap8/1cer_prep1/","title":"1 GitLab Certified CI/CD Specialist Training","text":"<p>GitLab aims to replace multiple tools across the lifecycle</p> <p></p>"},{"location":"chap8/1cer_prep1/#gitlab-cicd","title":"Gitlab CICD","text":""},{"location":"chap8/1cer_prep1/#10-different-devops-stages-all-with-different-features","title":"10 Different DevOps Stages- All with Different Features","text":"<ul> <li> <p>Manage</p> <ul> <li>Audit Management</li> <li>Authentication and Authorization</li> <li>Cycle Analytics</li> <li>DevOps Score</li> <li>Code Analytics</li> <li>Value Stream Management</li> <li>Workflow Policies</li> </ul> </li> <li> <p>Plan </p> <ul> <li>Project Management</li> <li>Kanban Boards</li> <li>Time Tracking</li> <li>Agile Portfolio Management</li> <li>Service Desk</li> <li>Reguirements Management</li> <li>Quality Management</li> </ul> </li> <li> <p>Create</p> <ul> <li>Source Code Management</li> <li>Code Review</li> <li>Wiki</li> <li>Web IDE</li> <li>Snippets</li> <li>Design Management</li> <li>Live Coding</li> </ul> </li> <li> <p>Verify</p> <ul> <li>Continuous Integration (CI)</li> <li>Code Quality</li> <li>Performance Testing</li> <li>Usability Testing</li> <li>System Testing</li> <li>Accessibility Testing</li> </ul> </li> <li> <p>Package</p> <ul> <li>Package Registry</li> <li>Container Registry</li> <li>Dependency Proxy</li> <li>Helm Chart Registry</li> </ul> </li> <li> <p>Secure</p> <ul> <li>SAST</li> <li>Secret Detection</li> <li>DAST</li> <li>Dependency Scanning</li> <li>Container Scanning</li> <li>License Management</li> <li>IAST</li> <li>Fuzzing</li> </ul> </li> <li> <p>Release</p> <ul> <li>Continuous Delivery (CD)</li> <li>Release Orchestration</li> <li>Pages</li> <li>Review apps</li> <li>Incremental Rollout</li> <li>Feature Flags</li> <li>Release Governance</li> <li>Secrets Management</li> </ul> </li> <li> <p>Configure</p> <ul> <li>Auto DevOps</li> <li>Kubernetes Configuration</li> <li>ChatOps</li> <li>Runbook Configuration</li> <li>Serverless</li> <li>PaaS</li> <li>Chaos Engineering</li> <li>Cluster Cost Optimization</li> </ul> </li> <li> <p>Monitor</p> <ul> <li>Metrics</li> <li>Logging</li> <li>Tracing</li> <li>Cluster Monitoring</li> <li>Error Tracking</li> <li>Incident Management</li> <li>Synthetic Monitoring</li> <li>Status Page</li> </ul> </li> <li> <p>Defend</p> <ul> <li>Runtime Application Self Protection</li> <li>Web Application Firewall</li> <li>Threat Detection</li> <li>Behavior Analytics</li> <li>Vulnerability Management</li> <li>Data Loss Prevention</li> <li>Container Network Security</li> </ul> </li> </ul> <p>What we will focus on for CI/CD</p> <p></p> <p>Single Conversation / Single Data Store  / Single Permission Model  /  Single Interface / Governance and Security / Team Collaboration / Lifecycle Analytics</p>"},{"location":"chap8/1cer_prep1/#gitlab-flow","title":"GitLab Flow","text":"<p>GitLab Workflow\u2014Example</p> <p></p> <ul> <li> <p>Create and Discuss a New Issue</p> <ul> <li>Team creates an issue</li> <li>Team applies \"Discussion\" label</li> <li>Team discusses using Comments</li> </ul> </li> <li> <p>Code Creation</p> <ul> <li>Backend team starts work and developer starts writing code</li> <li>Developer assigns issue to themselves</li> <li>Developer adds  \u201cWorking on\u201d label</li> </ul> </li> <li> <p>Commit and Merge Request</p> <ul> <li>Developer creates Commits.</li> <li>Developer pushes commits to a feature-branch</li> <li>Developer creates a Merge Request (MR)</li> <li>Backend team changes labels to  \u201cFrontend\u201d</li> </ul> </li> <li> <p>Deploy to Staging</p> <ul> <li>Frontend  developer starts working on issue</li> <li>Developer assigns issue to themselves</li> <li>Developer adds  \u201cWorking on\u201d label</li> <li>Team reviews and refines code</li> <li>Team stages code</li> <li>Team changes label to \u201cStaging\u201d</li> <li>After successful implementation team changes label to \u201cReady\u201c</li> </ul> </li> <li> <p>Ready</p> <ul> <li>Technical documentation team adds Docs label</li> <li>Marketing team adds \u201cMarketing\" label</li> <li>Technical team removes Docs label when done.</li> <li>When done marketing team removes \u201cMarketing\u201d label and adds \u201cProduction\u201d label</li> </ul> </li> <li> <p>Deploy to Production</p> <ul> <li>Release team merges MR and deploys feature to production</li> <li>Release team closes issue</li> </ul> </li> </ul>"},{"location":"chap8/1cer_prep1/#what-is-continuous-integrationcontinuous-delivery","title":"What is Continuous Integration/Continuous Delivery?","text":"<ul> <li>Continuous Integration is the practice of integrating code into a shared repository and building/testing each change automatically, as early as possible usually several times a day</li> <li>Continuous Delivery adds that the software can be released to production at any time, often by automatically pushing changes to a staging system.</li> <li>Continuous Deployment goes further and pushes changes to production automatically</li> </ul>"},{"location":"chap8/1cer_prep1/#gitlab-basic-cicd-workflow","title":"GitLab Basic CI/CD Workflow","text":"<p>https://docs.gitlab.com/ee/ci/introduction/index.html</p> <p></p> <p>A deeper look into the CI/CD workflow</p> <p></p>"},{"location":"chap8/1cer_prep1/#why-use-cicd","title":"Why use CI/CD?","text":"<p>CI/CD encourages collaboration across all departments and makes code creation and management easy, as well as provides the following specific benefits.</p> <ul> <li>CI Detects Errors Quickly: Fix errors while they are fresh in your mind</li> <li>CI Reduces Integration Problems: Smaller problems are easier to digest and it ensures the problems don\u2019t compound</li> <li> <p>CI Allows Teams to Develop Faster: More confidence among the developers allows for less bottlenecking</p> </li> <li> <p>CD Delivers Value Quickly and More Often</p> </li> </ul> <p>Get fast feedback on what your end users care about</p> <ul> <li>CD Ensures Every Change is Releasable</li> </ul> <p>This lowers the risk of each release allows releases  to be \u201cboring\u201d</p>"},{"location":"chap8/1cer_prep1/#2-architecture-runners","title":"2 Architecture &amp; Runners","text":"<p>Configuration File + Runner (eg. agent, pet, bastion)</p> <ul> <li> <p><code>.gitlab-ci.yml</code></p> <ul> <li>I need to run the job \u201cbuild\u201d before \u201ctest\u201d</li> </ul> </li> <li> <p><code>GitLab Runner</code></p> </li> </ul>"},{"location":"chap8/1cer_prep1/#runner-architecture","title":"Runner Architecture","text":"<p>A GitLab Runner is a lightweight, highly-scalable agent that picks up a CI job through the coordinator API of  GitLab CI/CD, runs the job, and sends the result back to the GitLab instance.</p> <p>These are typically created by your admin and made visible in the GitLab UI for certain tasks and jobs. They  will have the following architecture:</p> <p></p>"},{"location":"chap8/1cer_prep1/#shared-vs-specific-runners","title":"Shared vs. Specific Runners","text":"<p>Shared Runners\uff1a Can be used by any project</p> <ul> <li>Included in the pool for all projects</li> <li>Managed by GitLab Admin</li> <li>Typically autoscaling or otherwise scaled</li> </ul> <p>Specific Runners\uff1a Tied to one or more specific projects</p> <ul> <li>In the pool for ONLY specific projects</li> <li>Managed by Runner Owner(s)</li> <li>Typically for specialized builds, or if an org needs to do so for billing</li> </ul>"},{"location":"chap8/1cer_prep1/#tagged-vs-untagged","title":"Tagged vs. Untagged","text":""},{"location":"chap8/1cer_prep1/#protected-vs-non-protected","title":"Protected vs. Non-Protected","text":"<p>Protected</p> <ul> <li>ONLY runs jobs from  Protected Branches  / Protected Tags</li> <li>Typically used for runners containing deploy keys or other sensitive capabilities</li> </ul> <p>Non-Protected</p> <ul> <li>Runs jobs from ANY branch</li> <li>Used for ANY build</li> </ul>"},{"location":"chap8/1cer_prep1/#additional-runner-options","title":"Additional Runner Options","text":""},{"location":"chap8/1cer_prep1/#executors-common","title":"Executors: Common","text":"<ul> <li>Shell: Directly run commands as if writing them into terminal  (bash or sh) or command prompt (cmd) or powershell</li> <li>Docker Machine: \u201cMaster\u201d machine scales up runners with any executor on demand Typical in cloud deployments</li> <li>Docker: Execute inside of a docker image Most common!</li> <li>Kubernetes: Runs as a pod in a K8s cluster Can also feature auto-scaling</li> </ul>"},{"location":"chap8/1cer_prep1/#executors-less-common","title":"Executors: Less Common","text":"<ul> <li>VirtualBox: Base VM for runner Main \u201cmaster\u201d creates a new VM for each needed runner</li> <li>Parallels: Hint: Parallels is a nice platform on top of VirtualBox</li> <li>SSH: <ul> <li>Similar to shell, but not as many features (bash only, no caching)</li> <li>Does allow you to SSH and execute commands on a machine you might not want to install runner on</li> </ul> </li> </ul>"},{"location":"chap8/1cer_prep1/#configtoml-global-settings","title":"<code>config.toml</code>: Global Settings","text":""},{"location":"chap8/2pip_prep1/","title":"2 Anatomy of a Pipeline","text":"<ul> <li>Basic Pipeline</li> <li>Directed Acyclic Graph Pipelines</li> <li>Child / Parent Pipelines</li> </ul> <p>GitLab Pipeline Graph</p> <p></p> <ul> <li>Pipeline graph</li> <li>Shows how jobs are executed in stages</li> <li>Stages are run in serial to each other</li> <li>Jobs in each stage executed in parallel</li> <li>If one job in a stage fails, the next stage is not (usually) executed</li> </ul> <p><code>.gitlab-ci.yml</code> Example</p> <pre><code>image: registry.gitlab.com/gitlab-examples/kubernetes-deploy\n\nstages: \n    - build \n    - deploy\nvariables:\n    KUBE_DOMAIN: example.com\n\nbuild:\n    stage: build\n    script: \n        - command build\n    only: \n        - master\n\ndeploy: \n    stage: deploy\n    script: \n        - command deploy \n    environment:\n        name: production\n        url: http://production.example.com \n    variables:\n        DISABLE_POSTGRES: \"yes\" \n        only: \n            - master\n</code></pre> <p></p>"},{"location":"chap8/2pip_prep1/#basic-parameters","title":"Basic Parameters","text":"<pre><code>- image\n- services\n- script\n- before_script &amp; after_script\n- variables\n- environment\n</code></pre> <pre><code>- cache\n- artifacts\n- rules\n- tags\n- when\n</code></pre>"},{"location":"chap8/2pip_prep1/#basic-parameters_1","title":"Basic Parameters","text":"<pre><code>test:\n    script:\n        - apt-get update -qy\n        - bundle install --path /cache\n        - bundle exec rake test\n\nstaging:\n    stage: deploy\n    script:\n        - gem install dpl\n        - dpl --provider=heroku --app=ruby-test-staging --api-key=$HEROKU_KEY\n    only:\n    - master\n\nproduction:\n    stage: deploy\n    script:\n    - gem install dpl\n    - dpl --provider=heroku --app=ruby-prod --api-key=$HEROKU_PROD_KEY\n    only:\n    - tags\n</code></pre>"},{"location":"chap8/2pip_prep1/#image","title":"Image","text":"<ul> <li>Images are pulled from Docker Hub by default</li> </ul> <p>Use of a public image:</p> <pre><code>image: ruby:2.3\n</code></pre> <ul> <li>Images stored in the GitLab Container Registry</li> </ul> <p>Use of a custom image:</p> <pre><code>image: 'registry.gitlab.com/gitlab-org/ci-trainingsample:latest'\n</code></pre> <p><code>image: registry.example.com/k8-deploy:latest</code></p>"},{"location":"chap8/2pip_prep1/#services-variables","title":"Services &amp; Variables","text":"<p>Services: Services lines tell the Runner that additional images are needed</p> <pre><code>services:\n    - postgres\n</code></pre> <p>Variables: Variables also defined in <code>Project &gt;  Settings &gt; CI/CD &gt; Variables</code></p> <pre><code>variables:\n    POSTGRES_DB: rails-sample-1_test\n    POSTGRES_USER: root\n    POSTGRES_PASSWORD: \u201dxyzzy\u201d\n</code></pre> <p><code>.gitlab-ci.yml</code></p> <pre><code>image: registry.example.com/k8-deploy:latest\nservices:\n    - postgres\nvariables:\n    POSTGRES_DB: rails-sample-1_test\n</code></pre>"},{"location":"chap8/2pip_prep1/#stages","title":"Stages","text":"<p>Default Stages: Build, Test, Deploy</p> <p>User can define custom stages &amp; any number of jobs per  stage</p> <pre><code>stages:\n    - build\n    - test\n    - review\n    - deploy\n</code></pre> <ul> <li>Build: Source code and other dependencies are combined and built</li> <li>Test: Automated tests are run to validate the  code and behavior</li> <li>Review: The code is put through review apps for peer review and final approvals</li> <li>Deploy: The final product is deployed to a designated environment</li> </ul> <p>Stages seperate jobs into logical sections while Jobs perform the actual tasks</p>"},{"location":"chap8/2pip_prep1/#jobs-and-scripts","title":"Jobs and Scripts","text":"<ul> <li>Each Stage Can Have Multiple Jobs</li> <li>Jobs Run In Parallel</li> <li>Scripts Can Be Defined Several Different Ways</li> <li>Script Examples</li> </ul> <pre><code>build-code:\n    stage: build\n    script: build-it.sh\n\nbuild-other-code:\n    stage: build\n    script: src/other/code/build-it.sh\n</code></pre> <p><code>script: command build</code></p> <pre><code>script: \n    - npm install\n    - npm build\n</code></pre> <pre><code>script: scripts/build_script.sh\n</code></pre> <pre><code>image: registry.example.com/k8-deploy:latest\nservices: \n    - postgres\n\nvariables: \n    - POSTGRES_DB: rails-sample-1_test\n\nstages:\n    - build\n    - test\n    - deploy\n\ndeploy-code:\n    stage: deploy\n    script:\n    - command deploy\n</code></pre>"},{"location":"chap8/2pip_prep1/#environments","title":"Environments","text":"<p>The environment keyword defines where the app is deployed and is defined by 3 parts.</p> <pre><code>environment: \n    name: prod\n    url: http://$CI_PROJECT_NAME.$KUBE_DOMAIN\nwhen: manual\n</code></pre> <p>When triggers jobs &amp; stages manually (e.g. deploy to  production)</p>"},{"location":"chap8/2pip_prep1/#only-except-restricting-when-a-job-is-executed","title":"Only &amp; Except- Restricting When a Job is Executed","text":"<pre><code>pseudo-deploy:\n    stage: deploy\n    script:\n    - command deploy_review\n    only:\n    - branches\n    except:\n    - master\n    environment: \n        name: review\n        url: http://$CI_PROJECT_NAME-review.$KUBE_DOMAIN\n</code></pre> <ul> <li>Only: The name of branch to execute on (in this case all branches)</li> <li>Except: Branches NOT to execute on with exception to the Master Branch</li> </ul> <p>The rules syntax is an improved, more powerful solution for defining when jobs should run or not. Consider using rules instead of only/except to get the most out of your pipelines.</p>"},{"location":"chap8/2pip_prep1/#before_script-after_script","title":"<code>before_script</code> &amp; <code>after_script</code>","text":"<p>Run before and after the script defined in each job</p> <ul> <li>Can update the image with the latest version of components</li> <li>They run within the job and can interact with the job</li> </ul> <p><code>before_script</code></p> <p>is used to define a command that should be run before each job, including deploy jobs, but after the restoration of any artifacts</p> <pre><code>before_script:\n    - echo $CI_BUILD_STAGE\n    - apt-get update\n    - apt-get install node-js -y \n    - bundle install\n    - npm install\nafter_script:\n    - rm temp/*.tmp\n</code></pre> <p><code>after_script</code></p> <p>is used to define the command that will be run  after each job, including failed ones.</p>"},{"location":"chap8/2pip_prep1/#cache-artifacts","title":"Cache &amp; Artifacts","text":"<p>Cache is used to pass information between jobs &amp; stages by storing project dependencies</p> <pre><code>cache:\n    paths: \n        - binary/\n        - .config\n</code></pre> <p>There may be build artifacts you want to save</p> <pre><code>artifacts:\n    when: on_success\n    paths: \n        - bin/target\n</code></pre> <pre><code>image: registry.example.com/k8-deploy:latest\nservices: \n    - postgres\n\nvariables: \n    - POSTGRES_DB: rails-sample-1_test\n\ncache:\n    paths: \n    - binary/\n\nstages:\n    - build\n    - test\n    - deploy\n\nbuild-it:\n    stage: build\n    script:\n    - command build\n    only:\n    - master\n    artifacts:\n        when: on_success\n        paths:\n        - bin/target\n\ndeploy-code:\n    stage: deploy\n    script:\n    - command deploy\n    environment:\n        name: production\n        url: http://$CI_PROJECT_NAME.$KUBE_DOMAIN\n    when: manual\n    only:\n    - master\n</code></pre>"},{"location":"chap8/2pip_prep1/#tags","title":"Tags","text":"<p>Only execute on runners with the \u2018ruby\u2019 and \u2018test\u2019 tags</p> <pre><code>job-name:\n    tags: \n        - ruby\n        - test\n</code></pre> <pre><code>build-it:\n    stage: build\n    script:\n    - command build\n    only:\n    - master\n    tags: \n        - ruby\n        - test\n    artifacts:\n        when: on_success\n        paths:\n        - bin/target\n</code></pre>"},{"location":"chap8/2pip_prep1/#advanced-keywords-and-dry","title":"Advanced Keywords and DRY","text":""},{"location":"chap8/2pip_prep1/#advanced-parameters","title":"Advanced Parameters","text":"<pre><code>- dependencies\n- needs\n- parallel\n- trigger\n- include\n- extends\n- \u201c.\u201d anchors &amp; &lt;\n</code></pre> <p>dependencies</p> <pre><code>build:osx:\n    stage: build\n    script: make build:osx\n    artifacts:\n        paths: \n            - binaries/\n\nbuild:linux:\n    stage: build\n    script: make build:linux\n    artifacts:\n        paths: \n            - binaries/\n\ntest:osx:\n    stage: test\n    script: make test:osx\n    dependencies: \n        - build:osx\n\ntest:linux:\n    stage: test\n    script: make test:linux\n    dependencies: \n        - build:linux\n\ndeploy:\n    stage: deploy \n    script: make deploy\n</code></pre> <ul> <li>paths</li> <li>dependencies</li> </ul> <p>Scenario</p> <p>By default, all artifacts from all previous stages are  passed, but you can use the dependencies parameter to define a limited list of jobs (or no jobs) to fetch artifacts from.</p> <p>Example</p> <p>In the following example, we define two jobs with  artifacts, <code>build:osx</code> and <code>build:linux</code>. When the  <code>test:osx</code> is executed, the artifacts from <code>build:osx</code>  will be downloaded and extracted in the context of  the build. The same happens for <code>test:linux</code> and  artifacts from <code>build:linux</code>.</p> <p>The job deploy will download artifacts from all  previous jobs because of the stage precedence.</p>"},{"location":"chap8/2pip_prep1/#needs","title":"needs","text":"<pre><code>linux:build:\n    stage: build\n\nmac:build:\n    stage: build\n\nlint:\n    stage: test\n    needs: []\n\nlinux:rspec:\n    stage: test\n    needs: [\"linux:build\"]\n\nlinux:rubocop:\n    stage: test\n    needs: [\"linux:build\"]\n\nmac:rspec:\n    stage: test\n    needs: [\"mac:build\"]\n\nmac:rubocop:\n    stage: test\n    needs: [\"mac:build\"]\n\nproduction: \n    stage: deploy\n</code></pre> <p>Scenario: </p> <p>The <code>needs:</code> keyword enables executing jobs out-of-order, allowing you to implement a directed acyclic  graph in your CI configuration.</p> <p></p> <p>This lets you run some jobs without waiting for  other ones, disregarding stage ordering so you can  have multiple stages running concurrently.</p> <p>Example: Linux path: the <code>linux:rspec</code> and <code>linux:rubocop</code> jobs  will be run as soon as the <code>linux:build</code> job finishes  without waiting for mac:build to finish.</p> <p>macOS <code>path:</code> the <code>mac:rspec</code> and <code>mac:rubocop</code> jobs  will be run as soon as the <code>mac:build</code> job finishes,  without waiting for <code>linux:build</code> to finish.</p>"},{"location":"chap8/2pip_prep1/#parallel","title":"parallel","text":"<pre><code># Gemfile\nsource 'https://rubygems.org'\ngem 'rspec'\ngem 'semaphore_test_boosters'\n\n++++++\n# .gitlab-ci.yml\ntest:\n    parallel: 3\n    script: \n        - bundle \n        - bundle exec rspec_booster --job $CI_NODE_INDEX/$CI_NODE_TOTAL\n</code></pre> <p>Scenario</p> <p>parallel allows you to configure how many  instances of a job to run in parallel. This value has  to be greater than or equal to two (2) and less than  or equal to 50.</p> <p>Example</p> <p>A simple example using Semaphore Test Boosters  and RSpec to run some Ruby tests.</p>"},{"location":"chap8/2pip_prep1/#trigger","title":"trigger","text":"<pre><code>rspec:\n    stage: test\n    script: bundle exec rspec\n\nstaging:\n    stage: deploy \n    trigger:\n        project: my/deployment \n        branch: stable\n</code></pre> <p>Scenario</p> <p>trigger allows you to start a downstream pipeline. When a job created from trigger definition is started by GitLab, a downstream pipeline gets created.</p> <p>Example</p> <p>It is possible to configure a branch name that GitLab will use to create a downstream pipeline with.</p>"},{"location":"chap8/2pip_prep1/#variable-precedence-scoping","title":"Variable Precedence &amp; Scoping","text":""},{"location":"chap8/2pip_prep1/#variable-priority","title":"Variable Priority","text":"<p>The order of precedence for variables is (from  highest to lowest):</p> <ol> <li>Trigger variables, scheduled pipeline  variables, or manual pipeline run variables</li> <li>Project-level variables or protected variables.</li> <li>Group-level variables or protected variables.</li> <li>Inherited environment variables.</li> <li>YAML-defined job-level variables.</li> <li>YAML-defined global variables</li> <li>Deployment variables.</li> <li>Predefined environment variables</li> </ol> <p>Scenario</p> <ul> <li><code>API_TOKEN=secure</code> as a project variable.</li> <li><code>API_TOKEN=yaml</code> in your <code>.gitlab-ci.yml</code>.</li> </ul> <p><code>API_TOKEN</code> will take the value secure as the project variables take precedence over those defined in <code>.gitlab-ci.yml</code>.</p>"},{"location":"chap8/2pip_prep1/#registry-deployments","title":"Registry &amp; Deployments","text":""},{"location":"chap8/2pip_prep1/#what-are-package-and-container-registries","title":"What are Package and Container Registries?","text":"<ul> <li>Package Registry</li> </ul> <p>GitLab Packages allows organizations to utilize GitLab as a private repository for a variety of common package managers. Users are able to build and publish packages, which can be easily consumed as a dependency in downstream projects.</p> <ul> <li>Container Registry</li> </ul> <p>A secure and private registry for Docker images built-in to GitLab. Creating, pushing, and retrieving images works out of the box with GitLab CI/CD.</p>"},{"location":"chap8/2pip_prep1/#security-scanning-reports","title":"Security Scanning &amp; Reports","text":""},{"location":"chap8/2pip_prep1/#gitlab-application-security","title":"GitLab Application Security","text":"<p>GitLab can check your application for security vulnerabilities that may lead to unauthorized access, data leaks, denial of services, and more. GitLab reports vulnerabilities in the merge request so you can fix them before merging.</p> <p>The Security Dashboard provides a high-level view of vulnerabilities detected in your projects, pipeline, and groups.</p> <p></p>"},{"location":"chap8/2pip_prep1/#security-configuration","title":"Security Configuration","text":"<p>The security configuration page displays the configuration state of each of the security features and can be accessed through a project\u2019s sidebar nav.</p> <p></p>"},{"location":"chap8/2pip_prep1/#static-application-security-testing-sast","title":"Static Application Security Testing (SAST)","text":"<p>Static Application Security Testing (SAST) is used to analyze your source code for known vulnerabilities.</p> <p>GitLab checks the SAST report, compares the found vulnerabilities between the source and target branches, and shows the information right on the merge request.</p> <p></p>"},{"location":"chap8/2pip_prep1/#configuration","title":"Configuration","text":"<p>Enabling Docker-in-Docker</p> <pre><code>include:\n    - template: SAST.gitlab-ci.yml\n\nvariables:\n    SAST_DISABLE_DIND: \"false\"\n</code></pre> <p>Enabling Kubesec analyzer</p> <pre><code>include:\n    - template: SAST.gitlab-ci.yml\n\nvariables:\n    SCAN_KUBERNETES_MANIFESTS: \"true\"\n</code></pre>"},{"location":"chap8/2pip_prep1/#code-quality-overview","title":"Code Quality Overview","text":"<p>With the help of GitLab CI/CD, you can analyze your source code quality using GitLab Code Quality.</p> <p>Code Quality:</p> <ul> <li>Uses Code Climate Engines, which are free and open source. Code Quality doesn\u2019t require a Code Climate subscription.</li> <li>Runs in pipelines using an Docker image built in GitLab Code Quality project.</li> <li>Can make use of a template. </li> <li>Is available with Auto DevOps.</li> </ul> <p></p>"},{"location":"chap8/2pip_prep1/#how-code-quality-works","title":"How Code Quality Works","text":"<p>First, you need GitLab Runner configured:</p> <ul> <li>Information on the built-in GitLab Code Quality template.</li> <li>Examples of manual GitLab configuration for earlier GitLab versions</li> </ul> <p>Once you setup the Runner, include the Code Quality template in your CI configuration:</p> <pre><code>include:\n    - template: Code-Quality.gitlab-ci.yml\n\ncode_quality:\n    artifacts:\n        paths: [gl-code-quality-report.json]\n</code></pre> <p>Code Quality Reports</p> <p>Once the Code Quality job has completed:</p> <ul> <li>The full list of code quality violations generated by a pipeline is available in the Code Quality tab of the  Pipeline Details page.</li> <li>Potential changes to code quality are shown directly in the merge request. The Code Quality widget in  the merge request compares the reports from the base and head of the branch, then lists any violations that will be resolved or created when the branch is merged.</li> <li>The full JSON report is available as a downloadable artifact for the <code>code_quality</code> job</li> </ul>"},{"location":"chap8/2pip_prep1/#container-scanning","title":"Container Scanning","text":"<p>Your application\u2019s Docker image may itself be based on Docker images that contain known vulnerabilities.By including an extra job in your pipeline that scans for those vulnerabilities and displays them in a merge request, you can use GitLab to audit your Docker-based apps.</p> <p>You can enable container scanning by doing one of the following:</p> <ul> <li>Include the CI job in your existing <code>.gitlab-ci.yml</code> file</li> <li>Implicitly use Auto Container Scanning provided by Auto DevOps.</li> </ul> <p></p>"},{"location":"chap8/2pip_prep1/#junit-testing","title":"Junit Testing","text":"<p>It is very common that a CI/CD pipeline contains a test job that will verify your code. If the tests fail, the pipeline fails and users get notified. The person that works on the merge request will have to check the job logs and see where the tests failed so that  they can fix them.</p> <p>You can configure your job to use JUnit test reports, and GitLab will display a report on the merge request so that it\u2019s easier and faster to identify the failure without having to check the entire log</p> <p></p>"},{"location":"chap8/3Gitlab_pip/","title":"Gitlab Pipeline \u590d\u4e60","text":""},{"location":"chap8/3Gitlab_pip/#job","title":"job","text":"<ul> <li>\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u6216\u591a\u4e2a\u4f5c\u4e1a(job)\u3002</li> <li>\u6bcf\u4e2a\u4f5c\u4e1a\u5fc5\u987b\u5177\u6709\u552f\u4e00\u7684\u540d\u79f0\uff08\u4e0d\u80fd\u4f7f\u7528\u5173\u952e\u5b57\uff09\u3002</li> <li>\u6bcf\u4e2a\u4f5c\u4e1a\u662f\u72ec\u7acb\u6267\u884c\u7684\u3002</li> <li>\u6bcf\u4e2a\u4f5c\u4e1a\u81f3\u5c11\u8981\u5305\u542b\u4e00\u4e2ascript\u3002</li> </ul> <pre><code>job1:\n  script: \"execute-script-for-job1\"\n\njob2:\n  script: \"execute-script-for-job2\"\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#script","title":"script","text":"<pre><code>script:\n  - uname -a\n  -  bundle exec rspec\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#before_script","title":"<code>before_script</code>","text":"<ul> <li>\u7528\u4e8e\u5b9a\u4e49\u4e00\u4e2a\u547d\u4ee4\uff0c\u8be5\u547d\u4ee4\u5728\u6bcf\u4e2a\u4f5c\u4e1a\u4e4b\u524d\u8fd0\u884c\u3002</li> <li><code>before_script</code>\u5931\u8d25\u5bfc\u81f4\u6574\u4e2a\u4f5c\u4e1a\u5931\u8d25\uff0c\u5176\u4ed6\u4f5c\u4e1a\u5c06\u4e0d\u518d\u6267\u884c\u3002\u4f5c\u4e1a\u5931\u8d25\u4e0d\u4f1a\u5f71\u54cd<code>after_script</code>\u8fd0\u884c\u3002</li> </ul>"},{"location":"chap8/3Gitlab_pip/#after_script","title":"<code>after_script</code>","text":"<ul> <li>\u7528\u4e8e\u5b9a\u4e49\u5c06\u5728\u6bcf\u4e2a\u4f5c\u4e1a\uff08\u5305\u62ec\u5931\u8d25\u7684\u4f5c\u4e1a\uff09\u4e4b\u540e\u8fd0\u884c\u7684\u547d\u4ee4\u3002</li> <li>\u8fd9\u5fc5\u987b\u662f\u4e00\u4e2a\u6570\u7ec4\u3002</li> <li>\u6307\u5b9a\u7684\u811a\u672c\u5728\u65b0\u7684shell\u4e2d\u6267\u884c\uff0c\u4e0e\u4efb\u4f55<code>before_script</code>\u6216script\u811a\u672c\u5206\u5f00\u3002</li> </ul> <p>\u53ef\u4ee5\u5728\u5168\u5c40\u5b9a\u4e49\uff0c\u4e5f\u53ef\u4ee5\u5728job\u4e2d\u5b9a\u4e49\u3002\u5728job\u4e2d\u5b9a\u4e49\u4f1a\u8986\u76d6\u5168\u5c40</p>"},{"location":"chap8/3Gitlab_pip/#stages","title":"stages","text":"<p>\u7528\u4e8e\u5b9a\u4e49\u4f5c\u4e1a\u53ef\u4ee5\u4f7f\u7528\u7684\u9636\u6bb5\uff0c\u5e76\u4e14\u662f\u5168\u5c40\u5b9a\u4e49\u7684\u3002\u540c\u4e00\u9636\u6bb5\u7684\u4f5c\u4e1a\u5e76\u884c\u8fd0\u884c\uff0c\u4e0d\u540c\u9636\u6bb5\u6309\u987a\u5e8f\u6267\u884c\u3002</p> <pre><code>stages\uff1a\n  - build\n  - test\n  - codescan\n  - deploy\n</code></pre> <p>\u672a\u5b9a\u4e49stages: \u5982\u679cjob\u6ca1\u6709\u5b9a\u4e49stage\u5219\u9ed8\u8ba4\u662ftest\u9636\u6bb5\u3002\u5982\u679c\u5168\u5c40\u672a\u5b9a\u4e49stages,\u5219\u6309\u987a\u5e8f\u8fd0\u884c build,test,deploy\u3002</p>"},{"location":"chap8/3Gitlab_pip/#pre-post","title":"<code>. pre</code> &amp; <code>.post</code>","text":"<ul> <li><code>.pre</code> \u59cb\u7ec8\u662f\u6574\u4e2a\u7ba1\u9053\u7684\u7b2c\u4e00\u4e2a\u8fd0\u884c\u9636\u6bb5\uff0c</li> <li><code>.post</code> \u59cb\u7ec8\u662f\u6574\u4e2a\u7ba1\u9053\u7684\u6700\u540e\u4e00\u4e2a\u8fd0\u884c\u9636\u6bb5\u3002</li> </ul> <p>\u7528\u6237\u5b9a\u4e49\u7684\u9636\u6bb5\u90fd\u5728\u4e24\u8005\u4e4b\u95f4\u8fd0\u884c\u3002<code>.pre</code>\u548c<code>.post</code>\u7684\u987a\u5e8f\u65e0\u6cd5\u66f4\u6539\u3002\u5982\u679c\u7ba1\u9053\u4ec5\u5305\u542b<code>.pre</code>\u6216<code>.post</code>\u9636\u6bb5\u7684\u4f5c\u4e1a\uff0c\u5219\u4e0d\u4f1a\u521b\u5efa\u7ba1\u9053\u3002</p> <pre><code>codescan:\n  stage: .pre\n  script:\n    - echo \"codescan\"\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#stage","title":"stage","text":"<p>\u53ef\u80fd\u9047\u5230\u7684\u95ee\u9898\uff1a\u9636\u6bb5\u5e76\u6ca1\u6709\u5e76\u884c\u8fd0\u884c\u3002</p> <p>\u5728\u8fd9\u91cc\u6211\u628a\u8fd9\u4e24\u4e2a\u9636\u6bb5\u5728\u540c\u4e00\u4e2arunner\u8fd0\u884c\u4e86\uff0c\u6240\u4ee5\u9700\u8981\u4fee\u6539runner\u6bcf\u6b21\u8fd0\u884c\u7684\u4f5c\u4e1a\u6570\u91cf\u3002\u9ed8\u8ba4\u662f1\uff0c\u6539\u4e3a10.</p>"},{"location":"chap8/3Gitlab_pip/#variables","title":"variables","text":"<p>\u5b9a\u4e49\u53d8\u91cf\uff0cpipeline\u53d8\u91cf\u3001job\u53d8\u91cf\u3001Runner\u53d8\u91cf\u3002job\u53d8\u91cf\u4f18\u5148\u7ea7\u6700\u5927\u3002</p>"},{"location":"chap8/3Gitlab_pip/#tags-runner","title":"tags-\u6307\u5b9arunner","text":"<p>tags\u53ef\u8ba9\u60a8\u4f7f\u7528\u6307\u5b9a\u4e86\u6807\u7b7e\u7684\u8dd1\u6b65\u8005\u6765\u8fd0\u884c\u4f5c\u4e1a,\u6b64runner\u5177\u6709ruby\u548cpostgres\u6807\u7b7e\u3002</p> <pre><code>job:\n  tags:\n    - ruby\n    - postgres\n</code></pre> <p><code>allow_failure</code></p> <p><code>allow_failure</code> \u5141\u8bb8\u4f5c\u4e1a\u5931\u8d25\uff0c\u9ed8\u8ba4\u503c\u4e3afalse \u3002</p> <p>\u542f\u7528\u540e\uff0c\u5982\u679c\u4f5c\u4e1a\u5931\u8d25\uff0c\u8be5\u4f5c\u4e1a\u5c06\u5728\u7528\u6237\u754c\u9762\u4e2d\u663e\u793a\u6a59\u8272\u8b66\u544a. \u4f46\u662f\uff0c\u7ba1\u9053\u7684\u903b\u8f91\u6d41\u7a0b\u5c06\u8ba4\u4e3a\u4f5c\u4e1a\u6210\u529f/\u901a\u8fc7\uff0c\u5e76\u4e14\u4e0d\u4f1a\u88ab\u963b\u585e\u3002</p> <p>\u5047\u8bbe\u6240\u6709\u5176\u4ed6\u4f5c\u4e1a\u5747\u6210\u529f\uff0c\u5219\u8be5\u4f5c\u4e1a\u7684\u9636\u6bb5\u53ca\u5176\u7ba1\u9053\u5c06\u663e\u793a\u76f8\u540c\u7684\u6a59\u8272\u8b66\u544a\u3002\u4f46\u662f\uff0c\u5173\u8054\u7684\u63d0\u4ea4\u5c06\u88ab\u6807\u8bb0\u4e3a\"\u901a\u8fc7\"\uff0c\u800c\u4e0d\u4f1a\u53d1\u51fa\u8b66\u544a\u3002</p> <pre><code>job1:\n  stage: test\n  script:\n    - execute_script_that_will_fail\n  allow_failure: true\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#when-","title":"when-\u63a7\u5236\u4f5c\u4e1a\u8fd0\u884c","text":"<ul> <li><code>on_success</code>\u524d\u9762\u9636\u6bb5\u4e2d\u7684\u6240\u6709\u4f5c\u4e1a\u90fd\u6210\u529f\uff08\u6216\u7531\u4e8e\u6807\u8bb0\u4e3a<code>allow_failure</code>\u800c\u88ab\u89c6\u4e3a\u6210\u529f\uff09\u65f6\u624d\u6267\u884c\u4f5c\u4e1a\u3002\u8fd9\u662f\u9ed8\u8ba4\u503c\u3002</li> <li><code>on_failure</code>\u5f53\u524d\u9762\u9636\u6bb5\u51fa\u73b0\u5931\u8d25\u5219\u6267\u884c\u3002</li> <li><code>always</code> \u6267\u884c\u4f5c\u4e1a\uff0c\u800c\u4e0d\u7ba1\u5148\u524d\u9636\u6bb5\u7684\u4f5c\u4e1a\u72b6\u6001\u5982\u4f55\uff0c\u653e\u5230\u6700\u540e\u6267\u884c\u3002\u603b\u662f\u6267\u884c\u3002</li> <li><code>on_failure</code> \u5f53\u524d\u9762\u9636\u6bb5\u51fa\u73b0\u5931\u8d25\u65f6\u6267\u884c\u3002</li> <li><code>manual</code> \u624b\u52a8\u6267\u884c\u4f5c\u4e1a\u3002</li> <li> <p><code>delayed</code> \u5ef6\u8fdf\u6267\u884c\u4f5c\u4e1a\u3002</p> </li> <li> <p>manual \u624b\u52a8</p> </li> </ul> <pre><code>codescan:\n  stage: codescan\n  tags:\n    - build\n  script:\n    - echo \"codescan\"\n  when: on_success\n</code></pre> <pre><code>unittest:\n  stage: test\n  script:\n    - echo \"run test\"  \n  when: delayed\n  start_in: '5'\n</code></pre> <ul> <li>delayed \u5ef6\u8fdf</li> </ul> <p>delayed \u5ef6\u8fdf\u4e00\u5b9a\u65f6\u95f4\u540e\u6267\u884c\u4f5c\u4e1a</p> <ul> <li>retry</li> </ul> <p>\u914d\u7f6e\u5728\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\u91cd\u8bd5\u4f5c\u4e1a\u7684\u6b21\u6570\u3002</p> <pre><code>unittest:\n  stage: test\n  retry: 2\n  script:\n</code></pre> <p>\u4e3a\u4e86\u66f4\u597d\u5730\u63a7\u5236retry\u54ea\u4e9b\u5931\u8d25\uff0c\u53ef\u4ee5\u662f\u5177\u6709\u4ee5\u4e0b\u952e\u7684\u54c8\u5e0c\u503c\uff1a </p> <p>max \uff1a\u6700\u5927\u91cd\u8bd5\u6b21\u6570 / when \uff1a\u91cd\u8bd5\u5931\u8d25\u7684\u6848\u4f8b.</p> <pre><code>always \uff1a\u5728\u53d1\u751f\u4efb\u4f55\u6545\u969c\u65f6\u91cd\u8bd5\uff08\u9ed8\u8ba4\uff09.\nunknown_failure \uff1a\u5f53\u5931\u8d25\u539f\u56e0\u672a\u77e5\u65f6\u3002\nscript_failure \uff1a\u811a\u672c\u5931\u8d25\u65f6\u91cd\u8bd5\u3002\napi_failure \uff1aAPI\u5931\u8d25\u91cd\u8bd5\u3002\nstuck_or_timeout_failure \uff1a\u4f5c\u4e1a\u5361\u4f4f\u6216\u8d85\u65f6\u65f6\u3002\nrunner_system_failure \uff1a\u8fd0\u884c\u7cfb\u7edf\u53d1\u751f\u6545\u969c\u3002\nmissing_dependency_failure: \u5982\u679c\u4f9d\u8d56\u4e22\u5931\u3002\nrunner_unsupported \uff1aRunner\u4e0d\u53d7\u652f\u6301\u3002\nstale_schedule \uff1a\u65e0\u6cd5\u6267\u884c\u5ef6\u8fdf\u7684\u4f5c\u4e1a\u3002\njob_execution_timeout \uff1a\u811a\u672c\u8d85\u51fa\u4e86\u4e3a\u4f5c\u4e1a\u8bbe\u7f6e\u7684\u6700\u5927\u6267\u884c\u65f6\u95f4\u3002\narchived_failure \uff1a\u4f5c\u4e1a\u5df2\u5b58\u6863\u4e14\u65e0\u6cd5\u8fd0\u884c\u3002\nunmet_prerequisites \uff1a\u4f5c\u4e1a\u672a\u80fd\u5b8c\u6210\u5148\u51b3\u6761\u4ef6\u4efb\u52a1\u3002\nscheduler_failure \uff1a\u8c03\u5ea6\u7a0b\u5e8f\u672a\u80fd\u5c06\u4f5c\u4e1a\u5206\u914d\u7ed9\u8fd0\u884cscheduler_failure\u3002\ndata_integrity_failure \uff1a\u68c0\u6d4b\u5230\u7ed3\u6784\u5b8c\u6574\u6027\u95ee\u9898\u3002\n</code></pre> <pre><code>...\nwhen: delayed\nretry:\n  max: 2\n  when: script_failure\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#timeout","title":"timeout \u8d85\u65f6","text":"<pre><code>test:\n  script: rspec\n  timeout: 3h 30m\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#parallel","title":"parallel","text":"<p>\u914d\u7f6e\u8981\u5e76\u884c\u8fd0\u884c\u7684\u4f5c\u4e1a\u5b9e\u4f8b\u6570,\u6b64\u503c\u5fc5\u987b\u5927\u4e8e\u6216\u7b49\u4e8e2\u5e76\u4e14\u5c0f\u4e8e\u6216\u7b49\u4e8e50\u3002</p> <pre><code>parallel: 5\n</code></pre> <pre><code>unittest:\n  stage: test\n  tags:\n    - build\n  script:\n    - ech \"run test\"  \n  when: delayed\n  start_in: '5'\n  allow_failure: true\n  retry:\n    max: 2\n    when: \n      - script_failure\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#only-except","title":"only &amp; except (\u9010\u6b65\u9000\u51fa\uff09","text":"<p>only\u548cexcept\u662f\u4e24\u4e2a\u53c2\u6570\u7528\u5206\u652f\u7b56\u7565\u6765\u9650\u5236jobs\u6784\u5efa\uff1a</p> <ul> <li>only\u5b9a\u4e49\u54ea\u4e9b\u5206\u652f\u548c\u6807\u7b7e\u7684git\u9879\u76ee\u5c06\u4f1a\u88abjob\u6267\u884c\u3002</li> <li>except\u5b9a\u4e49\u54ea\u4e9b\u5206\u652f\u548c\u6807\u7b7e\u7684git\u9879\u76ee\u5c06\u4e0d\u4f1a\u88abjob\u6267\u884c</li> </ul> <pre><code>job:\n  only:\n    - main\n</code></pre> <pre><code>job:\n  # use regexp\n  only:\n    - /issue-.*$/\n  # use special keyword\n  except:\n    - branches\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#rules","title":"rules","text":"<ul> <li>rules\u5141\u8bb8\u6309\u987a\u5e8f\u8bc4\u4f30\u5355\u4e2a\u89c4\u5219\u5bf9\u8c61\u7684\u5217\u8868\uff0c\u76f4\u5230\u4e00\u4e2a\u5339\u914d\u5e76\u4e3a\u4f5c\u4e1a\u52a8\u6001\u63d0\u4f9b\u5c5e\u6027.</li> <li>\u8bf7\u6ce8\u610f\uff0c rules\u4e0d\u80fdonly/except\u4e0eonly/except\u7ec4\u5408\u4f7f\u7528\u3002</li> </ul> <p>\u53ef\u7528\u7684\u89c4\u5219\u6761\u6b3e\u5305\u62ec\uff1a</p> <ul> <li>if \uff08\u7c7b\u4f3c\u4e8eonly:variables \uff09</li> <li>changes \uff08 only:changes \u76f8\u540c\uff09</li> <li>exists</li> </ul> <p>if</p> <ul> <li>\u5982\u679cDOMAIN\u7684\u503c\u5339\u914d\uff0c\u5219\u9700\u8981\u624b\u52a8\u8fd0\u884c\u3002</li> <li>\u4e0d\u5339\u914d<code>on_succes</code>s\u3002</li> <li>\u6761\u4ef6\u5224\u65ad\u4ece\u4e0a\u5230\u4e0b\uff0c\u5339\u914d\u5373\u505c\u6b62\u3002</li> <li>\u591a\u6761\u4ef6\u5339\u914d\u53ef\u4ee5\u4f7f\u7528&amp;&amp; ||</li> </ul> <pre><code>rules:\n  - if: '$DOMAIN == \"example.com\"'\n     when: manual\n  - when: on_success\n</code></pre> <pre><code>rules:\n  - if: '$DOMAIN == \"example.com\"'\n    when: manual\n  - if: '$DOMAIN == \"example.com\"'\n    when: delayed\n    start_in: '5'\n  - when: on_success\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#rules-changes-","title":"<code>rules-changes</code>-\u6587\u4ef6\u53d8\u5316","text":"<ul> <li>\u63a5\u53d7\u6587\u4ef6\u8def\u5f84\u6570\u7ec4\u3002</li> <li>\u5982\u679c\u63d0\u4ea4\u4e2d<code>*file</code>\u6587\u4ef6\u53d1\u751f\u7684\u53d8\u5316\u5219\u4e3a<code>true</code></li> </ul> <pre><code>rules:\n    - changes:\n      - Dockerfile\n      when: manual\n</code></pre> <ul> <li><code>rules:exists</code> </li> </ul> <p>\u63a5\u53d7\u6587\u4ef6\u8def\u5f84\u6570\u7ec4\u3002\u5f53\u4ed3\u5e93\u4e2d\u5b58\u5728\u6307\u5b9a\u7684\u6587\u4ef6\u65f6\u64cd\u4f5c\u3002</p> <pre><code>rules:\n    - exists:\n      - Dockerfile\n      when: manual \n    - changes:\n      - Dockerfile\n      when: on_success\n    - if: '$DOMAIN == \"example.com\"'\n      when: on_success\n    - when: on_success\n</code></pre> <ul> <li> <p>rules-<code>allow_failure</code></p> </li> <li> <p>\u4f7f\u7528<code>allow_failure: true</code></p> </li> <li>rules:\u5728\u4e0d\u505c\u6b62\u7ba1\u9053\u672c\u8eab\u7684\u60c5\u51b5\u4e0b\u5141\u8bb8\u4f5c\u4e1a\u5931\u8d25\u6216\u624b\u52a8\u4f5c\u4e1a\u7b49\u5f85\u64cd\u4f5c\u3002</li> </ul> <pre><code>rules:\n - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == \"main\"'\n   when: manual\n   allow_failure: true\n</code></pre> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u89c4\u5219\u5339\u914d\uff0c\u5219\u4f5c\u4e1a\u5c06\u5177\u6709\u4ee5\u4e0b<code>when: manual</code>\u548c<code>allow_failure: true</code>\u3002</p>"},{"location":"chap8/3Gitlab_pip/#workflowrules","title":"workflow:rules\u521b\u5efa\u7ba1\u9053","text":"<ul> <li>\u9876\u7ea7workf1ow\u5173\u952e\u5b57\u9002\u7528\u4e8e\u6574\u4e2a\u7ba1\u9053\uff0c\u5e76\u5c06\u786e\u5b9a\u662f\u5426\u521b\u5efa\u7ba1\u9053\u3002</li> <li> <p>when\uff1a\u53ef\u4ee5\u8bbe\u7f6e\u4e3aalways\u6216never\uff0c \u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5219\u9ed8\u8ba4\u503calways\u3002</p> </li> <li> <p>\u9876\u7ea7<code>workflow</code>\u5173\u952e\u5b57\u9002\u7528\u4e8e\u6574\u4e2a\u7ba1\u9053\uff0c\u5e76\u5c06\u786e\u5b9a\u662f\u5426\u521b\u5efa\u7ba1\u9053\u3002</p> </li> <li>when\uff1a\u53ef\u4ee5\u8bbe\u7f6e\u4e3aalways\u6216never\uff0c \u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5219\u9ed8\u8ba4\u503calways</li> </ul> <pre><code>workflow:\n  rules:\n    - if: '$DOMAIN == \"example.com\"'\n    - when: always\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#cache","title":"cache \u5173\u952e\u5b57","text":"<p>\u4e0d\u8981\u4f7f\u7528\u7f13\u5b58\u5728\u9636\u6bb5\u4e4b\u95f4\u4f20\u9012\u5de5\u4ef6\uff0c\u56e0\u4e3a\u7f13\u5b58\u4e3b\u8981\u662f\u5b58\u50a8\u7f16\u8bd1\u9879\u76ee\u6240\u9700\u7684\u8fd0\u884c\u65f6\u4f9d\u8d56\u9879\u3002</p> <p>\u5982\u679c\u5728job\u8303\u56f4\u4e4b\u5916\u5b9a\u4e49\u4e86cache \uff0c\u5219\u610f\u5473\u7740\u5b83\u662f\u5168\u5c40\u8bbe\u7f6e\uff0c\u6240\u6709job\u90fd\u5c06\u4f7f\u7528\u8be5\u5b9a\u4e49\u3002\u5982\u679c\u672a\u5168\u5c40\u5b9a\u4e49\u6216\u672a\u6309job\u5b9a\u4e49\u5219\u7981\u7528\u8be5\u529f\u80fd\u3002</p> <ul> <li>\u5b58\u50a8\u7f16\u8bd1\u9879\u76ee\u6240\u9700\u7684\u8fd0\u884c\u65f6\u4f9d\u8d56\u9879\uff0c\u6307\u5b9a\u9879\u76ee\u5de5\u4f5c\u7a7a\u95f4\u4e2d\u9700\u8981\u5728job\u4e4b\u95f4\u7f13\u5b58\u7684\u6587\u4ef6\u6216\u76ee\u5f55</li> <li> <p>\u5168\u5c40cache\u5b9a\u4e49\u5728job\u4e4b\u5916\uff0c\u9488\u5bf9\u6240\u6709job\u751f\u6548\u3002job\u4e2dcache\u4f18\u5148\u4e8e\u5168\u5c40\u3002</p> </li> <li> <p><code>cache:paths</code></p> </li> </ul> <p><code>$CI_PROJECT_DIR</code> \u9879\u76ee\u76ee\u5f55\u3002\u5728job build\u4e2d\u5b9a\u4e49\u7f13\u5b58\uff0c\u5c06\u4f1a\u7f13\u5b58target\u76ee\u5f55\u4e0b\u7684\u6240\u6709<code>.jar</code>\u6587\u4ef6\u3002</p> <pre><code>build:\n  script: test\n  cache:\n    paths:\n      - target/*.jar\n</code></pre> <p>\u5f53\u5728\u5168\u5c40\u5b9a\u4e49\u4e86<code>cache:paths</code>\u4f1a\u88abjob\u4e2d\u8986\u76d6\u3002\u4ee5\u4e0b\u5b9e\u4f8b\u5c06\u7f13\u5b58<code>binaries</code>\u76ee\u5f55\u3002</p> <pre><code>cache:\n  paths:\n    - my/files\n\nbuild:\n  script: echo \"hello\"\n  cache:\n    key: build\n    paths:\n      - target/\n</code></pre> <p>\u5982\u4f55\u8ba9\u4e0d\u540c\u7684job\u7f13\u5b58\u4e0d\u540c\u7684cache\u5462\uff1f\u8bbe\u7f6e\u4e0d\u540c\u7684<code>cache:key</code>\u3002</p> <ul> <li>cache:key \u7f13\u5b58\u6807\u8bb0</li> </ul> <p>\u4e3a\u7f13\u5b58\u505a\u4e2a\u6807\u8bb0\uff0c\u53ef\u4ee5\u914d\u7f6ejob\u3001\u5206\u652f\u4e3akey\u6765\u5b9e\u73b0\u5206\u652f\u3001\u4f5c\u4e1a\u7279\u5b9a\u7684\u7f13\u5b58\u3002</p> <p>\u4e3a\u4e0d\u540c job \u5b9a\u4e49\u4e86\u4e0d\u540c\u7684 <code>cache:key</code> \u65f6\uff0c \u4f1a\u4e3a\u6bcf\u4e2a job \u5206\u914d\u4e00\u4e2a\u72ec\u7acb\u7684 cache\u3002</p> <p>cache:key \u53d8\u91cf\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u9884\u5b9a\u4e49\u53d8\u91cf\uff0c\u9ed8\u8ba4default \uff0c\u4eceGitLab 9.0\u5f00\u59cb\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6240\u6709\u5185\u5bb9\u90fd\u5728\u7ba1\u9053\u548c\u4f5c\u4e1a\u4e4b\u95f4\u5171\u4eab\u3002</p> <p>\u6309\u7167\u5206\u652f\u8bbe\u7f6e\u7f13\u5b58</p> <pre><code>cache:\n  key: ${CI_COMMIT_REF_SLUG}\n</code></pre> <ul> <li><code>cache:key:fles</code> \u2014\u2014 \u6587\u4ef6\u53d8\u5316\u81ea\u52a8\u521b\u5efa\u7f13\u5b58</li> </ul> <p>files\uff1a\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u81ea\u52a8\u91cd\u65b0\u751f\u6210\u7f13\u5b58(files\u6700\u591a\u6307\u5b9a\u4e24\u4e2a\u6587\u4ef6)\uff0c\u63d0\u4ea4\u7684\u65f6\u5019\u68c0\u67e5\u6307\u5b9a\u7684\u6587\u4ef6\u3002</p> <p>\u6839\u636e\u6307\u5b9a\u7684\u6587\u4ef6\u751f\u6210\u5bc6\u94a5\u8ba1\u7b97SHA\u6821\u9a8c\u548c\uff0c\u5982\u679c\u6587\u4ef6\u672a\u6539\u53d8\u503c\u4e3adefault\u3002</p> <pre><code>cache:\n  key:\n    files:\n      - Gemfile.lock\n      - package.json\n  paths:\n    - vendor/ruby\n    - node_modules\n</code></pre> <ul> <li><code>cache: key:prefix</code> -\u7ec4\u5408\u751f\u6210SHA\u6821\u9a8c\u548c</li> </ul> <p>prefix: \u5141\u8bb8\u7ed9\u5b9aprefix\u7684\u503c\u4e0e\u6307\u5b9a\u6587\u4ef6\u751f\u6210\u7684\u79d8\u94a5\u7ec4\u5408\u3002</p> <p>\u5728\u8fd9\u91cc\u5b9a\u4e49\u4e86\u5168\u5c40\u7684cache\uff0c\u5982\u679c\u6587\u4ef6\u53d1\u751f\u53d8\u5316\u5219\u503c\u4e3a <code>rspec-xxx111111111222222</code> \uff0c\u672a\u53d1\u751f\u53d8\u5316\u4e3arspec-default\u3002</p> <pre><code>cache:\n  key:\n    files:\n      - Gemfile.lock\n    prefix: ${CI_JOB_NAME}\n  paths:\n    - vendor/ruby\n</code></pre> <p>\u4f8b\u5982\uff0c\u6dfb\u52a0<code>$CI_JOB_NAME prefix</code>\u5c06\u4f7f\u5bc6\u94a5\u770b\u8d77\u6765\u50cf\uff1a</p> <p><code>rspec-feef9576d21ee9b6a32e30c5c79d0a0ceb68d1e5</code></p> <ul> <li><code>cache:policy</code>\u7b56\u7565<ul> <li>\u9ed8\u8ba4\uff1a\u5728\u6267\u884c\u5f00\u59cb\u65f6\u4e0b\u8f7d\u6587\u4ef6\uff0c\u5e76\u5728\u7ed3\u675f\u65f6\u91cd\u65b0\u4e0a\u4f20\u6587\u4ef6\u3002\u79f0\u4e3a<code>pull-push</code>\u7f13\u5b58\u7b56\u7565</li> <li><code>policy: pull</code> \u8df3\u8fc7\u4e0b\u8f7d\u6b65\u9aa4</li> <li><code>policy: push</code> \u8df3\u8fc7\u4e0a\u4f20\u6b65\u9aa4</li> </ul> </li> </ul> <pre><code>rspec:\n  stage: test\n  cache:\n    key: gems\n    paths:\n      - vendor/bundle\n    policy: pull\n  script:\n    - bundle exec rspec ...\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#artifactsdependencies","title":"artifacts/dependencies","text":"<ul> <li><code>artifacts:paths</code></li> </ul> <pre><code>artifacts:\n  paths:\n    - target/\n</code></pre> <ul> <li><code>artifacts:expose_as</code> -MR\u5c55\u793a\u5236\u54c1</li> </ul> <p>\u5173\u952e\u5b57<code>expose_as</code>\u53ef\u7528\u4e8e\u5728\u5408\u5e76\u8bf7\u6c42 UI\u4e2d\u516c\u5f00\u4f5c\u4e1a\u5de5\u4ef6\u3002</p> <pre><code>artifacts:\n    expose_as: 'artifact 1'\n    paths: \n      - path/to/file.txt\n</code></pre> <ul> <li><code>artifacts:name</code></li> </ul> <p>\u901a\u8fc7name\u6307\u4ee4\u5b9a\u4e49\u6240\u521b\u5efa\u7684\u5de5\u4ef6\u5b58\u6863\u7684\u540d\u79f0\u3002\u53ef\u4ee5\u4e3a\u6bcf\u4e2a\u6863\u6848\u4f7f\u7528\u552f\u4e00\u7684\u540d\u79f0\u3002</p> <p><code>artifacts:name</code>\u53d8\u91cf\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u9884\u5b9a\u4e49\u53d8\u91cf\u3002\u9ed8\u8ba4\u540d\u79f0\u662fartifacts\uff0c\u4e0b\u8f7dartifacts\u6539\u4e3aartifacts.zip\u3002</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_JOB_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u4f7f\u7528\u5185\u90e8\u5206\u652f\u6216\u6807\u8bb0\u7684\u540d\u79f0\uff08\u4ec5\u5305\u62ecbinaries\u76ee\u5f55\uff09\u521b\u5efa\u5b58\u6863\uff0c</p> <pre><code>job:\n  artifacts:\n    name: \"$CI_COMMIT_REF_NAME\"\n    paths:\n      - binaries/\n</code></pre> <p>\u4f7f\u7528\u5f53\u524d\u4f5c\u4e1a\u7684\u540d\u79f0\u548c\u5f53\u524d\u5206\u652f\u6216\u6807\u8bb0\uff08\u4ec5\u5305\u62ec\u4e8c\u8fdb\u5236\u6587\u4ef6\u76ee\u5f55\uff09\u521b\u5efa\u5b58\u6863</p> <p><code>name: \"$CI_JOB_STAGE-$CI_COMMIT_REF_NAME\"</code></p> <ul> <li> <p><code>artifacts:when</code>  \u7528\u4e8e\u5728\u4f5c\u4e1a\u5931\u8d25\u65f6\u6216\u6210\u529f\u800c\u4e0a\u4f20\u5de5\u4ef6\u3002</p> <ul> <li><code>on_success</code> \u4ec5\u5728\u4f5c\u4e1a\u6210\u529f\u65f6\u4e0a\u8f7d\u5de5\u4ef6\u9ed8\u8ba4\u503c\u3002</li> <li><code>on_failure</code>\u4ec5\u5728\u4f5c\u4e1a\u5931\u8d25\u65f6\u4e0a\u8f7d\u5de5\u4ef6\u3002</li> <li>always \u4e0a\u8f7d\u5de5\u4ef6\uff0c\u65e0\u8bba\u4f5c\u4e1a\u72b6\u6001\u5982\u4f55\u3002</li> </ul> </li> <li> <p><code>artifacts: expire_in</code> \u5236\u54c1\u4fdd\u7559\u65f6\u95f4,\u5b9a\u4e49\u8fc7\u671f\u65f6\u95f4\uff0c\u5219\u9ed8\u8ba4\u4e3a30\u5929\u3002</p> </li> <li><code>artifacts:reports</code>  artifacts:reports:junit \u2014\u2014 \u5355\u5143\u6d4b\u8bd5\u62a5\u544a</li> </ul> <pre><code> artifacts:\n    name: \"$CI_JOB_NAME-$CI_COMMIT_REF_NAME\"\n    when: on_success\n    #expose_as: 'artifact 1'\n    paths:\n      - target/*.jar\n      #- target/surefire-reports/TEST*.xml\n    reports:\n      junit: target/surefire-reports/TEST-*.xml\n      cobertura: target/site/cobertura/coverage.xml\n  coverage: '/Code coverage: \\d+\\.\\d+/'\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#dependencies","title":"dependencies","text":"<p>\u5b9a\u4e49\u8981\u83b7\u53d6\u5de5\u4ef6\u7684\u4f5c\u4e1a\u5217\u8868\uff0c\u53ea\u80fd\u4ece\u5f53\u524d\u9636\u6bb5\u4e4b\u524d\u6267\u884c\u7684\u9636\u6bb5\u5b9a\u4e49\u4f5c\u4e1a\u3002\u5b9a\u4e49\u4e00\u4e2a\u7a7a\u6570\u7ec4\u5c06\u8df3\u8fc7\u4e0b\u8f7d\u8be5\u4f5c\u4e1a\u7684\u4efb\u4f55\u5de5\u4ef6\u4e0d\u4f1a\u8003\u8651\u5148\u524d\u4f5c\u4e1a\u7684\u72b6\u6001\uff0c\u56e0\u6b64\uff0c\u5982\u679c\u5b83\u5931\u8d25\u6216\u662f\u672a\u8fd0\u884c\u7684\u624b\u52a8\u4f5c\u4e1a\uff0c\u5219\u4e0d\u4f1a\u53d1\u751f\u9519\u8bef\u3002</p> <pre><code>unittest:\n  dependencies:\n    - build\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#needsartifacts","title":"needs/artifacts","text":"<ul> <li>needs \u5e76\u884c\u9636\u6bb5</li> </ul> <p>\u53ef\u65e0\u5e8f\u6267\u884c\u4f5c\u4e1a\uff0c\u65e0\u9700\u6309\u7167\u9636\u6bb5\u987a\u5e8f\u8fd0\u884c\u67d0\u4e9b\u4f5c\u4e1a\uff0c\u53ef\u4ee5\u8ba9\u591a\u4e2a\u9636\u6bb5\u540c\u65f6\u8fd0\u884c\u3002</p> <pre><code>module-a-test:\n  stage: test\n  script: \n    - echo \"hello3a\"\n    - sleep 10\n  needs: [\"module-a-build\"]\n</code></pre> <p>\u5236\u54c1\u4e0b\u8f7d</p> <p>\u5728\u4f7f\u7528needs\uff0c\u53ef\u901a\u8fc7<code>artifacts: true</code>\u6216<code>artifacts: false</code>\u6765\u63a7\u5236\u5de5\u4ef6\u4e0b\u8f7d\u3002\u9ed8\u8ba4\u4e0d\u6307\u5b9a\u4e3atrue\u3002</p> <pre><code> needs: \n    - job: \"module-a-build\"\n      artifacts: true\n</code></pre> <p>\u76f8\u540c\u9879\u76ee\u4e2d\u7684\u7ba1\u9053\u5236\u54c1\u4e0b\u8f7d,\u901a\u8fc7\u5c06project\u5173\u952e\u5b57\u8bbe\u7f6e\u4e3a\u5f53\u524d\u9879\u76ee\u7684\u540d\u79f0\uff0c\u5e76\u6307\u5b9a\u5f15\u7528\uff0c\u53ef\u4ee5\u4f7f\u7528needs\u4ece\u5f53\u524d\u9879\u76ee\u7684\u4e0d\u540c\u7ba1\u9053\u4e2d\u4e0b\u8f7d\u5de5\u4ef6</p> <pre><code>needs:\n  - project: group/same-project-name\n     job: build-1\n     ref: other-ref\n     artifacts: true\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#includelocal","title":"include/local","text":"<pre><code>include:\n  local: 'ci/localci.yml'\n</code></pre> <p>include: local-\u5f15\u5165\u672c\u5730\u914d\u7f6e</p> <ul> <li>file</li> </ul> <p>\u5f15\u5165 <code>demo/demo-java-service</code>\u9879\u76ee main \u5206\u652f .<code>gitlab-ci.yml</code> \u914d\u7f6e</p> <pre><code>include:\n  - project: demo/demo-java-service\n    ref: main\n    file: '.gitlab-ci.yml'\n</code></pre> <ul> <li>include: template-\u5f15\u5165\u5b98\u65b9\u914d\u7f6e</li> </ul> <pre><code>include:\n  - template: Auto-DevOps.gitlab-ci.yml\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#extends-","title":"extends - \u7ee7\u627f\u4f5c\u4e1a\u914d\u7f6e","text":"<pre><code>testjob:\n  extends: .tests\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#trigger","title":"trigger \u7ba1\u9053\u89e6\u53d1","text":"<p>\u5f53Gitlab\u4ecetrigger\u5b9a\u4e49\u521b\u5efa\u7684\u4f5c\u4e1a\u542f\u52a8\u65f6\uff0c\u5c06\u521b\u5efa\u4e00\u4e2a\u4e0b\u6e38\u7ba1\u9053\u3002\u5141\u8bb8\u521b\u5efa\u591a\u9879\u76ee\u7ba1\u9053\u548c\u5b50\u7ba1\u9053\u3002\u5c06trigger\u4e0ew<code>hen:manual</code>\u4e00\u8d77\u4f7f\u7528\u4f1a\u5bfc\u81f4\u9519\u8bef</p> <ul> <li>\u591a\u9879\u76ee\u7ba1\u9053\uff1a\u8de8\u591a\u4e2a\u9879\u76ee\u8bbe\u7f6e\u6d41\u6c34\u7ebf\uff0c\u4ee5\u4fbf\u4e00\u4e2a\u9879\u76ee\u4e2d\u7684\u7ba1\u9053\u53ef\u4ee5\u89e6\u53d1\u53e6\u4e00\u4e2a\u9879\u76ee\u4e2d\u7684\u7ba1\u9053\u3002[\u5fae\u670d\u52a1\u67b6\u6784]</li> <li>\u7236\u5b50\u7ba1\u9053\uff1a\u5728\u540c\u4e00\u9879\u76ee\u4e2d\u7ba1\u9053\u53ef\u4ee5\u89e6\u53d1\u4e00\u7ec4\u540c\u65f6\u8fd0\u884c\u7684\u5b50\u7ba1\u9053\uff0c\u5b50\u7ba1\u9053\u4ecd\u7136\u6309\u7167\u9636\u6bb5\u987a\u5e8f\u6267\u884c\u5176\u6bcf\u4e2a\u4f5c\u4e1a\uff0c\u4f46\u662f\u53ef\u4ee5\u81ea\u7531\u5730\u7ee7\u7eed\u6267\u884c\u5404\u4e2a\u9636\u6bb5\uff0c\u800c\u4e0d\u5fc5\u7b49\u5f85\u7236\u7ba1\u9053\u4e2d\u65e0\u5173\u7684\u4f5c\u4e1a\u5b8c\u6210\u3002</li> </ul> <pre><code>staging:\n  variables:\n      ENVIRONMENT: staging\n  stage: deploy\n  trigger:\n      project: gitlab-instance-8f6af96c/demo-java-service\n      branch: main\n      # strategy: depend\n</code></pre> <ul> <li>project\u5173\u952e\u5b57\uff0c\u7528\u4e8e\u6307\u5b9a\u4e0b\u6e38\u9879\u76ee\u7684\u5b8c\u6574\u8def\u5f84\u3002\u8be5branch\u5173\u952e\u5b57\u6307\u5b9a\u7531\u6307\u5b9a\u7684\u9879\u76ee\u5206\u652f\u7684\u540d\u79f0\u3002</li> <li>\u4f7f\u7528variables\u5173\u952e\u5b57\u5c06\u53d8\u91cf\u4f20\u9012\u5230\u4e0b\u6e38\u7ba1\u9053\u3002\u5168\u5c40\u53d8\u91cf\u4e5f\u4f1a\u4f20\u9012\u7ed9\u4e0b\u6e38\u9879\u76ee\u3002</li> <li>\u4e0a\u6e38\u7ba1\u9053\u4f18\u5148\u4e8e\u4e0b\u6e38\u7ba1\u9053\u3002\u5982\u679c\u5728\u4e0a\u6e38\u548c\u4e0b\u6e38\u9879\u76ee\u4e2d\u5b9a\u4e49\u4e86\u4e24\u4e2a\u5177\u6709\u76f8\u540c\u540d\u79f0\u7684\u53d8\u91cf\uff0c\u5219\u5728\u4e0a\u6e38\u9879\u76ee\u4e2d\u5b9a\u4e49\u7684\u53d8\u91cf\u5c06\u4f18\u5148\u3002</li> <li>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e00\u65e6\u521b\u5efa\u4e0b\u6e38\u7ba1\u9053\uff0ctrigger\u4f5c\u4e1a\u5c31\u4f1a\u4ee5success\u72b6\u6001\u5b8c\u6210\u3002</li> <li>strategy: depend\u5c06\u81ea\u8eab\u72b6\u6001\u4ece\u89e6\u53d1\u7684\u7ba1\u9053\u5408\u5e76\u5230\u6e90\u4f5c\u4e1a\u3002</li> </ul>"},{"location":"chap8/3Gitlab_pip/#include","title":"\u7236\u5b50\u7ba1\u9053 \u7c7b\u4f3c\u4e8e Include","text":"<p>\u7236\u5b50\u6d41\u6c34\u7ebf\u5728\u4e00\u4e2a\u9879\u76ee\u4e2d</p> <pre><code>staging2:\n  variables:\n    ENVIRONMENT: staging\n  stage: deploy\n  trigger: \n    include: ci/child01.yml  \n    strategy: depend\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#services","title":"services","text":"<p>\u5de5\u4f5c\u671f\u95f4\u8fd0\u884c\u7684\u53e6\u4e00\u4e2aDocker\u6620\u50cf\uff0c\u5e76link\u5230image\u5173\u952e\u5b57\u5b9a\u4e49\u7684Docker\u6620\u50cf\u3002\u8fd9\u6837\uff0c\u60a8\u5c31\u53ef\u4ee5\u5728\u6784\u5efa\u671f\u95f4\u8bbf\u95ee\u670d\u52a1\u6620\u50cf.</p> <p>\u670d\u52a1\u6620\u50cf\u53ef\u4ee5\u8fd0\u884c\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\uff0c\u4f46\u662f\u6700\u5e38\u89c1\u7684\u7528\u4f8b\u662f\u8fd0\u884c\u6570\u636e\u5e93\u5bb9\u5668\uff0c\u4f8b\u5982mysql \u3002\u4e0e\u6bcf\u6b21\u5b89\u88c5\u9879\u76ee\u65f6\u90fd\u5b89\u88c5mysql\u76f8\u6bd4\uff0c\u4f7f\u7528\u73b0\u6709\u6620\u50cf\u5e76\u5c06\u5176\u4f5c\u4e3a\u9644\u52a0\u5bb9\u5668\u8fd0\u884c\u66f4\u5bb9\u6613\uff0c\u66f4\u5feb\u6377</p> <pre><code>services:\n  - name: mysql:latest\n    alias: mysql-1\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#environment","title":"environment","text":"<p>\u58f0\u660e\u6240\u90e8\u7f72\u7684\u73af\u5883\u540d\u79f0\u548c\u8bbf\u95ee\u5730\u5740\uff0c\u540e\u7eed\u53ef\u4ee5\u76f4\u63a5\u5728gitlab \u73af\u5883\u53d8\u91cf\u4e2d\u67e5\u770b\u3002\u975e\u5e38\u65b9\u4fbf\u3002</p> <pre><code>environment:\n    name: production\n    url: https://prod.example.com\n</code></pre>"},{"location":"chap8/3Gitlab_pip/#inherit","title":"inherit","text":"<p>\u4f7f\u7528\u6216\u7981\u7528\u5168\u5c40\u5b9a\u4e49\u7684\u73af\u5883\u53d8\u91cf\uff08variables\uff09\u6216\u9ed8\u8ba4\u503c(default)\u3002</p> <p>\u4f7f\u7528true\u3001false\u51b3\u5b9a\u662f\u5426\u4f7f\u7528\uff0c\u9ed8\u8ba4\u4e3atrue</p> <pre><code>inherit:\n  default: false\n  variables: false\n</code></pre> <p>\u7ee7\u627f\u5176\u4e2d\u7684\u4e00\u90e8\u5206\u53d8\u91cf\u6216\u9ed8\u8ba4\u503c\u4f7f\u7528list</p> <pre><code>inherit:\n  default:\n    - parameter1\n    - parameter2\n  variables:\n    - VARIABLE1\n    - VARIABLE2\n</code></pre>"},{"location":"chap8/4Final_test/","title":"Gitlab \u8ba4\u8bc1\u8003\u9898","text":""},{"location":"chap8/4Final_test/#_1","title":"\u7b14\u8bd5\u8003\u9898","text":"<ol> <li>True/False: Continuous Delivery and Continuous Deployment are interchangeable terms with the same definition<ul> <li>False</li> </ul> </li> <li>What type of runner can be used by any project?<ul> <li>Shared</li> </ul> </li> <li>Which GitLab tiers have access to the Operations Dashboard? (check all that apply)<ul> <li>GitLab Premium</li> <li>GitLab Ultimate</li> </ul> </li> <li>What parameter is used to tell the pipeline which runners to execute on?<ul> <li>Tags</li> </ul> </li> <li>What allows you to start a downstream pipeline?<ul> <li>Trigger</li> </ul> </li> <li>Which of the following keywords are able to be used for Job names?<ul> <li>test</li> </ul> </li> <li>True/False: The two main foundations of a CI/CD Pipeline at GitLab are a <code>.gitlab-ci.yml</code> file and a GitLab Runner.<ul> <li>True</li> </ul> </li> <li> <p>Which executor directly run commands as if writing them into terminal (bash or sh) or command prompt (cmd)? </p> <ul> <li>Shell</li> </ul> </li> <li> <p>Which of the following benefits of Artifacts does not apply when using GitLab?</p> <ul> <li>Can be used on subsequent jobs if they have been added to the current active pipeline</li> <li>Can have an expiration value to control disk usage</li> <li>Used for stage results that will be passed between stages</li> <li>All of the above</li> </ul> </li> <li>What parameter determines where an app is deployed?<ul> <li>Environments</li> </ul> </li> <li>What GitLab stage houses Source Code Management and Web IDE?<ul> <li>Create</li> </ul> </li> <li>What GitLab feature allows you to publish static websites directly from a repository in GitLab?<ul> <li>GitLab Pages</li> </ul> </li> <li>Which of the following is always a component of a gitlab-ci.yml?<ul> <li>build</li> </ul> </li> <li>Which of the following is NOT needed to run a CI/CD Pipeline in GitLab?<ul> <li>Wiki</li> </ul> </li> <li>True/False: The rules keyword is a way to set job policies that determine whether or not jobs are added to pipelines.<ul> <li>True</li> </ul> </li> </ol>"},{"location":"chap8/4Final_test/#gitlab-cicd","title":"Gitlab CI/CD\u8003\u8bd5\u9898","text":"<p>1.\u5982\u679cRunner\u670d\u52a1\u5668\u53d1\u751f\u5207\u6362\uff0c\u524d\u9762\u9636\u6bb5\u6253\u5305\u597d\u7684\u6587\u4ef6\u5728\u4e0b\u4e00\u9636\u6bb5\u627e\u4e0d\u5230\uff0c\u5e94\u8be5\u5982\u4f55\u5904\u7406 \uff1f</p> <ul> <li>\u7528artifacts\u7f13\u5b58\u4f5c\u4e1a\u4ea7\u7269\uff0c\u4f7f\u7528needs\u83b7\u53d6\u4f5c\u4e1a\u4ea7\u7269</li> </ul> <p>\u5404\u9636\u6bb5\u53ef\u4ee5\u901a\u8fc7artifacts\u5c06\u4f5c\u4e1a\u4ea7\u7269\u7f13\u5b58\u81f3\u9636\u6bb5\uff0c\u540e\u7eed\u9636\u6bb5\u53ef\u901a\u8fc7needs\u4ece\u9636\u6bb5\u7f13\u5b58\u4e2d\u83b7\u53d6\u4f5c\u4e1a\u4ea7\u7269\uff0c\u9002\u7528\u4e8e\u8de8runner\u6267\u884c\u6d41\u6c34\u7ebf\u7684\u573a\u666f</p> <p>Cache\u9002\u7528\u4e8e\u5355runner\u6267\u884c\u7684\u573a\u666f</p> <p>2.\u4ee5\u4e0a\u811a\u672c\uff0c\u8868\u793a\u6267\u884c\u4ec0\u4e48\u64cd\u4f5c \uff1f</p> <pre><code>script:\n- mvn compile -e sonar:sonar\n-Dsonar.projectKey=${SONAR_PROJECT_KEY}\n-Dsonar.projectName=${SONAR_PROJECT_NAME}\n-Dsonar.host.url=${SONAR_HOST_URL}\n-Dsonar.login=${SONAR_LOGIN_TOKEN}\n</code></pre> <ul> <li>\u4ee3\u7801\u626b\u63cf</li> </ul> <p>maven\u9879\u76ee\u7684\u4ee3\u7801\u626b\u63cf\u811a\u672c</p> <p>3.\u6839\u636e\u4ee5\u4e0a\u914d\u7f6e\uff0c\u53ef\u4ee5\u770b\u51fa\u6d41\u6c34\u7ebf\u6709\u51e0\u4e2a\u9636\u6bb5\uff1f</p> <pre><code>stages:\n- build\n- test\n- sonarscan\n- package\n- deploy\n- release\n</code></pre> <p>6</p> <p>4.<code>docker push ${IMAGE_NAME}</code>  \u4ee5\u4e0a\u914d\u7f6e\uff0c\u5728\u505a\u4ec0\u4e48\u64cd\u4f5c\uff1f</p> <p>\u63a8\u9001\u955c\u50cf</p> <p>5.\u4ee5\u4e0a\u914d\u7f6e\uff0cSONAR_PROJECT_PATH \u662f\u4ec0\u4e48\u610f\u601d\uff1f</p> <pre><code>variables:\nSONAR_PROJECT_KEY: \"JK-jobpoint-employee\"\nSONAR_PROJECT_NAME: \"JK-\u79ef\u5206\u7cfb\u7edf-\u5458\u5de5\u7aef\"\nSONAR_PROJECT_PATH: \"./src\"\n</code></pre> <p>\u4ee5\u4e0a\u914d\u7f6e\uff0c<code>SONAR_PROJECT_PATH</code> \u662f\u4ec0\u4e48\u610f\u601d\uff1f</p> <p>\u6307\u5b9a\u4ee3\u7801\u626b\u63cf\u8def\u5f84</p> <p>6.\u5e38\u89c1\u7684\u6d41\u6c34\u7ebf\u7684\u89e6\u53d1\u65b9\u5f0f\u6709\u54ea\u51e0\u79cd </p> <ul> <li>A \u63d0\u4ea4\u4ee3\u7801</li> <li>B \u5b9a\u65f6\u89e6\u53d1</li> <li>C URL\u89e6\u53d1</li> <li>D \u624b\u52a8\u89e6\u53d1</li> </ul> <p>7.\u5173\u4e8e<code>Gitlab-Runner-Tag</code>\u5206\u5e03\u4f5c\u7528\u8bf4\u660e\uff0c\u54ea\u4e9b\u662f\u6b63\u786e\u7684\uff1f</p> <ul> <li>A <code>$CI_PROJECT_NAME</code></li> <li>B <code>$CI_PROJECT_PATH</code></li> </ul> <p>CI\u5f00\u5934\u7684\u53d8\u91cf\u4e3agitlab\u7cfb\u7edf\u53d8\u91cf</p> <p>8.\u4ee5\u4e0a\u914d\u7f6e\uff0c\u8868\u793a\u7f13\u5b58\u4f5c\u4e1a\u4ea7\u7269</p> <pre><code> needs:\n- job: \"package-job\"\n   artifacts: true\n</code></pre> <p>\u4ee5\u4e0a\u914d\u7f6e\uff0c\u8868\u793a\u7f13\u5b58\u4f5c\u4e1a\u4ea7\u7269</p> <p>\u83b7\u53d6\u4f5c\u4e1a\u4ea7\u7269</p> <p>9.<code>sonar-tag</code>\u7528\u4e8e\u9759\u6001\u626b\u63cf\u7684\u4f5c\u4e1a </p> <ul> <li>\u5bf9</li> </ul> <p>10.\u4f7f\u7528tag\u7684\u4e3b\u8981\u76ee\u7684\u662f\u5bf9\u4e0d\u540c\u7684jobs\u8fdb\u884c\u5206\u6d41\uff0c\u5728\u6709\u591a\u4e2a\u4e0d\u540c\u7c7b\u578bjob\u540c\u65f6\u9700\u8981\u6267\u884c\u65f6\uff0ctags\u8ba9\u4e0d\u540c\u670d\u52a1\u5668\u8d1f\u8d23\u4e0d\u540c\u7684\u4efb\u52a1\u3002</p> <ul> <li>\u5bf9</li> </ul> <p>11.docker\u4e0eshell\u7c7b\u578brunner\u7684\u4e3b\u8981\u533a\u522b\u5728\u4e8eshell\u65e0\u6cd5\u4f7f\u7528image\u548cservices </p> <ul> <li>\u5bf9</li> </ul> <p>12.<code>docker build -t ${IMAGE_NAME} -f ${DOCKER_FILE_PATH} .</code> \u8868\u793a\u6839\u636edockerfile\u6587\u4ef6\u63a8\u9001\u955c\u50cf\u81f3harbor\u670d\u52a1\u5668 </p> <ul> <li>\u9519</li> </ul> <p>\u6839\u636edockerfile\u6587\u4ef6\u6784\u5efa\u672c\u5730\u955c\u50cf</p> <p>13.\u8868\u793a\uff1a\u63d0\u4ea4\u4ee3\u7801\u89e6\u53d1\u6d41\u6c34</p> <pre><code>rules:\n- if: $CI_COMMIT_TAG\n</code></pre> <ul> <li>\u9519</li> </ul> <p>\u6253tag\u89e6\u53d1\u6d41\u6c34\u7ebf</p> <p>14.\u5728Gitlab CI/CD\u4e2d\uff0c\u4e0d\u53ef\u4ee5\u5c06\u7528\u6237\u540d\u3001\u5bc6\u7801\u7b49\u79c1\u5bc6\u4fe1\u606f\u8bbe\u7f6e\u6210\u53d8\u91cf </p> <ul> <li>\u9519</li> </ul> <p>15.\u8f6f\u4ef6\u5305\u6ce8\u518c\u8868\uff0c\u53ef\u7528\u6765\u5b58\u653e\u5f52\u6863\u5236\u54c1</p> <ul> <li>\u5bf9</li> </ul> <p>16.Gitlab\u90e8\u7f72CI\u9ed8\u8ba4\u4f7f\u7528<code>.gitlab-ci.yml</code></p> <ul> <li>\u5bf9</li> </ul>"},{"location":"chap8/4Final_test/#gitlab-certified-cicd-associate-hands-on-assessment","title":"GitLab Certified CI/CD Associate Hands On Assessment","text":"<ul> <li>GitLab Docs- https://docs.gitlab.com/ee/README.html </li> <li>Add a <code>gitlab-ci.yml</code> file with test, build, review, and deploy stages</li> <li>Add an image tag to your pipeline</li> <li>Define a default environment parameter for your pipeline</li> <li>Add environment variables to your pipeline</li> <li>Scaffold out a job policy pattern that uses feature branches and tags to gate review, release, and staging/production job execution</li> <li>Dockerize the application and publish a Docker image to the built-in GitLab Docker Registry.</li> <li>Enable SAST on your pipeline</li> </ul> <pre><code>image: registry.gitlab.com/gitlab-org/cluster-integration/auto-deploy-image:latest\n\nvariables:\n  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID\n  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY\n\nstages:         # List of stages for jobs, and their order of execution\n  - build\n  - test\n  - sast \n  - review\n  - deploy\n  - release\n\n\nbuild-job:       # This job runs in the build stage, which runs first.\n  stage: build\n  script:\n    - echo $AWS_ACCESS_KEY_ID\n    - echo \"Compiling the code...\"\n    - echo \"Compile complete.\"\n\nbuild-docker:\n  image: docker:20.10.17\n  stage: build\n  services:\n    - name: docker:20.10.17-dind\n      alias: thedockerhost\n  variables:\n    IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG\n    DOCKER_HOST: tcp://thedockerhost:2375/\n    DOCKER_DRIVER: overlay2\n    DOCKER_TLS_CERTDIR: \"\"\n  script:\n    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY\n    - docker build -t $IMAGE_TAG .\n    - docker push $IMAGE_TAG\n\nunit-test-job:   # This job runs in the test stage.\n  stage: test    # It only starts when the job in the build stage completes successfully.\n  script:\n    - echo \"Running unit tests... This will take about 60 seconds.\"\n    - sleep 10\n    - echo \"Code coverage is 90%\"\n\nlint-test-job:   # This job also runs in the test stage.\n  stage: test    # It can run at the same time as unit-test-job (in parallel).\n  script:\n    - echo \"Linting code... This will take about 10 seconds.\"\n    - sleep 10\n    - echo \"No lint issues found.\"\n\nreview-job:       \n  stage: review\n  script:\n    - echo \"Reviewing the code...\"\n    - echo \"Review complete.\"\n  only:\n  - feature*\n  - tags\n\ndeploy-job:      # This job runs in the deploy stage.\n  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.\n  script:\n    - echo \"Deploying application...\"\n    - echo \"Application successfully deployed.\"\n  environment:\n    name: production\n    url: https://gitlab.cn/\n\nrelease-job:       \n  stage: release\n  script:\n    - echo \"Releasing the code...\"\n    - echo \"Release successfully complete.\"\n  only:\n  - feature*\n  - tags\n\nproduction-job:       \n  stage: release\n  script:\n    - echo \"Releasing the code on production\"\n    - echo \"Release successfully complete.\"\n  only:\n  - feature*\n  - tags\n\nstaging-job:       \n  stage: release\n  script:\n    - echo \"Releasing the code on stage\"\n    - echo \"Release successfully complete.\"\n  only:\n  - feature*\n  - tags\n\nsast-job:\n  stage: sast\n  image: docker:20.10.17-dind\n  variables:\n    DOCKER_DRIVER: overlay2\n    DOCKER_HOST: tcp://thedockerhost:2375/\n    DOCKER_TLS_CERTDIR: \"\"\n  allow_failure: true\n  artifacts:\n    reports:\n      sast: gl-sast-report.json\n  services:\n    - name: docker:20.10.17-dind\n      alias: thedockerhost\n  script:\n    # - export SAST_VERSION=$(echo \"$CI_SERVER_VERSION\" | sed 's/^\\([0-9]*\\)\\.\\([0-9]*\\).*/\\1-\\2-stable/')\n    - docker run \n        --env SAST_CONFIDENCE_LEVEL=\"${SAST_CONFIDENCE_LEVEL:-3}\" \n        --env SAST_DISABLE_REMOTE_CHECKS=\"${SAST_DISABLE_REMOTE_CHECKS:-false}\" \n        --volume \"$PWD:/code\" \n        --volume /var/run/docker.sock:/var/run/docker.sock \n        \"registry.gitlab.com/gitlab-org/security-products/sast:latest\" /app/bin/run /code\n</code></pre>"},{"location":"chap9/1Gitlab_branch/","title":"L1 Gitlab branch Strategy","text":"<p>https://docs.gitlab.com/ee/topics/gitlab_flow.html</p>"},{"location":"chap9/1Gitlab_branch/#1-requirement","title":"1 Requirement","text":"<p>Once develop has acquired enough features for a release (or a predetermined release date is approaching), you fork a release branch off of develop. </p> <p>Creating this branch starts the next release cycle, so no new features can be added after this point. Only bug fixes, documentation generation, and other release-oriented tasks should go in this branch(which includes testing also). </p> <p>Once it's ready to ship, the release gets merged into master and tagged with a version number. In addition, it should be merged back into develop, which may have progressed since the release was initiated. </p> <p>Using a dedicated branch to prepare releases makes it possible for one team to polish the current release while another team continues working on features for the next release. </p> <p>It also creates well-defined phases of development (e.g., it's easy to say, 'this week we're preparing for version 4.0\" and to actually see it in the structure of the repository). </p>"},{"location":"chap9/1Gitlab_branch/#basic-description","title":"Basic Description","text":"<p>It suggests a main branch and a separate develop branch, with supporting branches for features, releases, and hotfixes. </p> <ul> <li> <p>The development happens on the develop branch, moves to a release branch, and is finally merged into the main branch.</p> </li> <li> <p>master\uff1aThe official version that can be provided to users\uff1b</p> </li> <li>develop\uff1aVersion used to generate code(nightly\uff09\uff1b</li> <li>feature\uff1aFor developing a function\uff1b</li> <li>hotfix\uff1aUsed to fix bugs in online code\uff1b</li> <li>release\uff1aRelease branch, integrate feature branch for release\u3002</li> </ul>"},{"location":"chap9/1Gitlab_branch/#the-first-problem","title":"The first problem","text":"<ul> <li>The first problem is that developers must use the develop branch and not main.  <ul> <li>main is reserved for code that is released to production. </li> <li>It is a convention to call your default branch main and to mostly branch from and merge to this. Because most tools automatically use the main branch as the default, it is annoying to have to switch to another branch.</li> </ul> </li> </ul>"},{"location":"chap9/1Gitlab_branch/#the-second-problem","title":"The second problem","text":"<p>Git flow is the complexity introduced by the hotfix and release branches\u3002</p> <p>Frequently, developers make mistakes such as merging changes only into main and not into the develop branch. The reason for these errors is that Git flow is too complicated for most use cases. For example, many projects do releases but don\u2019t need to do hotfixes.</p>"},{"location":"chap9/1Gitlab_branch/#release-branches-with-gitlab-flow","title":"Release branches with GitLab flow","text":"<p>You should work with release branches only if you need to release software to the outside world. In this case, each branch contains a minor version, such as <code>2.3-stable</code> or <code>2.4-stable</code>:</p> <p></p> <p>After announcing a release branch, only add serious bug fixes to the branch. </p> <p>If possible, first merge these bug fixes into main, and then cherry-pick them into the release branch. If you start by merging into the release branch, you might forget to cherry-pick them into main, and then you\u2019d encounter the same bug in subsequent releases. </p> <p>Merging into main and then cherry-picking into release is called an \u201cupstream first\u201d policy, </p>"},{"location":"chap9/1Gitlab_branch/#squashing-commits-with-rebase","title":"Squashing commits with rebase","text":"<p>With Git, you can use an interactive rebase (<code>rebase -i</code>) to squash multiple commits into one or reorder them. This feature helps you replace a couple of small commits with a single commit, or if you want to make the order more logical:</p> <pre><code>pick c6ee4d3 add a new file to the repo\npick c3c130b change readme\n\n# Rebase 168afa0..c3c130b onto 168afa0\n#\n# Commands:\n# p, pick = use commit\n# r, reword = use commit, but edit the commit message\n# e, edit = use commit, but stop for amending\n# s, squash = use commit, but meld into previous commit\n# f, fixup = like \"squash\", but discard this commit's log message\n# x, exec = run command (the rest of the line) using shell\n#\n# These lines can be re-ordered; they are executed from top to bottom.\n#\n# If you remove a line here THAT COMMIT WILL BE LOST.\n#\n# However, if you remove everything, the rebase will be aborted.\n#\n# Note that empty commits are commented out\n~\n</code></pre>"},{"location":"chap9/1Gitlab_branch/#gitlab-flow-with-environment-branches","title":"Gitlab Flow with     Environment Branches","text":""},{"location":"chap9/2gitlab_workflow/","title":"L2 Gitflow Workflow","text":"<p>Reference:</p> <p>https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow</p> <p>Giflow is an alternative Git branching model that involves the use of feature branches and multiple primary branches.</p> <p>Gitflow can be used for projects that have a scheduled release cycle.  it assigns very specific roles to different branches and defines how and when they should interact. In addition to feature branches, it uses individual branches for preparing, maintaining, and recording releases.</p>"},{"location":"chap9/2gitlab_workflow/#how-doest-it-work","title":"How doest it work","text":""},{"location":"chap9/2gitlab_workflow/#develop-and-main-branches","title":"Develop and main branches","text":"<ul> <li>The main branch stores the official release history</li> <li>The develop branch serves as an integration branch for features.</li> <li>Tag all commits in the main branch with a version number.</li> </ul> <p>The first step is to complement the default main with a develop branch. A simple way to do this is for one developer to create an empty develop branch locally and push it to the server:</p> <pre><code>git branch develop\ngit push -u origin develop\n</code></pre> <p>Develop branch will contain the complete history of the project, whereas main will contain an abridged version.</p> <p>Other developers should now clone the central repository(develop) and create a tracking branch for develop.</p> <p>When using the <code>git-flow</code>extension library, executing <code>git flow init</code> on an existing repo will create the develop branch:</p> <pre><code>$ git flow init\n\n\nInitialized empty Git repository in ~/project/.git/\nNo branches exist yet. Base branches must be created now.\nBranch name for production releases: [main]\nBranch name for \"next release\" development: [develop]\n\n\nHow to name your supporting branch prefixes?\nFeature branches? [feature/]\nRelease branches? [release/]\nHotfix branches? [hotfix/]\nSupport branches? [support/]\nVersion tag prefix? []\n\n\n$ git branch\n* develop\n main\n</code></pre>"},{"location":"chap9/2gitlab_workflow/#feature-branches","title":"Feature branches","text":"<ul> <li>Each new feature should reside in its own branch, which can be pushed to the central repository for backup/collaboration(Develop).</li> <li>Instead of branching off of main, feature branches use develop as their parent branch.</li> <li>When a feature is complete, it gets merged back into develop.</li> <li>Features should never interact directly with main.</li> </ul> <p>Feature branches are generally created off to the latest develop branch.</p> <p>Creating a feature branch</p> <ul> <li>Without the git-flow extensions:</li> </ul> <pre><code>git checkout develop\ngit checkout -b feature_branch\n</code></pre> <ul> <li>When using the git-flow extension:</li> </ul> <pre><code>git flow feature start feature_branch\n</code></pre> <p>When you\u2019re done with the development work on the feature, the next step is to merge the <code>feature_branch</code> into <code>develop</code>.</p> <ul> <li>Without the git-flow extensions:</li> </ul> <pre><code>git checkout develop\ngit merge feature_branch\n</code></pre> <ul> <li>Using the git-flow extensions:</li> </ul> <pre><code>git flow feature finish feature_branch\n</code></pre>"},{"location":"chap9/2gitlab_workflow/#release-branches","title":"Release branches","text":"<ul> <li>Once develop has acquired enough features for a release (or a predetermined release date is approaching), you fork a release branch off of develop.</li> <li>Creating this branch starts the next release cycle, so no new features can be added after this point\u2014only bug fixes, documentation generation, and other release-oriented tasks should go in this branch.</li> <li>Once it's ready to ship, the release branch gets merged into main and tagged with a version number.</li> <li>In addition, it should be merged back into develop, which may have progressed since the release was initiated.</li> </ul> <p>Like feature branches, release branches are based on the develop branch.</p> <p>A new release branch can be created using the following methods.</p> <ul> <li>Without the git-flow extensions:</li> </ul> <pre><code>git checkout develop\ngit checkout -b release/0.1.0\n</code></pre> <p>When using the git-flow extensions:</p> <pre><code>$ git flow release start 0.1.0\nSwitched to a new branch 'release/0.1.0''\n</code></pre> <p>Once the release is ready to ship, it will get merged it into main and develop, then the release branch will be deleted.</p> <p>It\u2019s important to merge back into develop because critical updates may have been added to the release branch and they need to be accessible to new features.</p> <p>To finish a release branch, use the following methods:</p> <pre><code>git checkout main\ngit merge release/0.1.0\n</code></pre> <pre><code>git flow release finish '0.1.0'\n</code></pre>"},{"location":"chap9/2gitlab_workflow/#hotfix-branches","title":"Hotfix branches","text":"<p>Maintenance or \u201chotfix\u201d branches are used to quickly patch production releases.</p> <p>Hotfix branches are a lot like release branches and feature branches except they're based on main instead of develop.</p> <p>This is the only branch that should fork directly off of main.</p> <p>As soon as the fix is complete, it should be merged into both main and develop (or the current release branch), and main should be tagged with an updated version number.</p> <pre><code>git checkout main\ngit checkout -b hotfix_branch\n</code></pre> <pre><code>$ git flow hotfix start hotfix_branch\n</code></pre> <p>Similar to finishing a release branch, a hotfix branch gets merged into both main and develop.</p> <pre><code>git checkout main\ngit merge hotfix_branch\ngit checkout develop\ngit merge hotfix_branch\ngit branch -D hotfix_branch\n</code></pre> <pre><code>$ git flow hotfix finish hotfix_branch\n</code></pre>"},{"location":"chap9/2gitlab_workflow/#example","title":"Example","text":"<p>A complete example demonstrating a Feature Branch Flow is as follows. Assuming we have a repo setup with a main branch.</p> <pre><code>git checkout main\ngit checkout -b develop\ngit checkout -b feature_branch\n\n\n# work happens on feature branch\ngit checkout develop\ngit merge feature_branch\n\ngit checkout main\ngit merge develop\n\n# purge the the feature branch\ngit branch -d feature_branch\n</code></pre> <p>In addition to the feature and release flow, a hotfix example is as follows:</p> <pre><code>git checkout main\ngit checkout -b hotfix_branch\n# work is done commits are added to the hotfix_branch\n\n# hotfix branch gets merged into both main and develop\ngit checkout develop\ngit merge hotfix_branch\ngit checkout main\ngit merge hotfix_branch\n</code></pre>"},{"location":"chap9/2gitlab_workflow/#summary","title":"Summary","text":"<ul> <li>The workflow is great for a release-based software workflow.</li> <li>Gitflow offers a dedicated channel for hotfixes to production.</li> </ul> <p>The overall flow of Gitflow is:</p> <ul> <li>A develop branch is created from main</li> <li>A release branch is created from develop</li> <li>Feature branches are created from develop</li> <li>When a feature is complete it is merged into the develop branch</li> <li>When the release branch is done it is merged into develop and main</li> <li>If an issue in main is detected a hotfix branch is created from main</li> <li>Once the hotfix is complete it is merged to both develop and main</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/","title":"L3 Gitlab branch Setup Action","text":""},{"location":"chap9/3Gitlab_branch_action/#1-default-branch","title":"1 Default branch","text":"<p>A default branch has special configuration options not shared by other branches:</p> <ul> <li>It cannot be deleted.</li> <li>It\u2019s initially protected against forced pushes.</li> <li>When a merge request uses an issue closing pattern to close an issue, the work is merged into this branch.</li> </ul> <p>Protect initial default branches</p> <ul> <li>Not protected - Both developers and maintainers can push new commits and force push.</li> <li>Protected against pushes - Developers cannot push new commits, but are allowed to accept merge requests to the branch. Maintainers can push to the branch.</li> <li>Partially protected - Both developers and maintainers can push new commits, but cannot force push.</li> <li>Fully protected - Developers cannot push new commits, but maintainers can. No one can force push.</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#2-protected-branches","title":"2 Protected branches","text":""},{"location":"chap9/3Gitlab_branch_action/#who-can-modify-a-protected-branch","title":"Who can modify a protected branch","text":"Action Who can do it Protect a branch At least the Maintainer role. Push to the branch GitLab administrators and anyone with Allowed permission. (1) Force push to the branch No one. Delete the branch No one. (2)"},{"location":"chap9/3Gitlab_branch_action/#configure-multiple-protected-branches-by-using-a-wildcard","title":"Configure multiple protected branches by using a wildcard","text":"<p>If both a specific rule and a wildcard rule apply to the same branch, the most permissive rule controls how the branch behaves.</p> <p>For merge controls to work properly, set Allowed to push to a broader set of users than Allowed to merge.</p>"},{"location":"chap9/3Gitlab_branch_action/#prerequisite","title":"Prerequisite:","text":"<p>You must have at least the Maintainer role.</p> <p>To protect multiple branches at the same time:</p> Wildcard protected branch Matching branches <code>*-stable</code> <code>production-stable, staging-stable</code> <code>production/*</code> <code>production/app-server</code>, <code>production/load-balancer</code> <code>*gitlab*</code> <code>gitlab</code>, <code>gitlab/staging</code>, <code>master/gitlab/production</code>"},{"location":"chap9/3Gitlab_branch_action/#create-a-protected-branch","title":"Create a protected branch","text":"<p>Users with at least the Developer role can create a protected branch.</p> <ul> <li>Allowed to push is set to No one</li> <li>Allowed to merge is set to Developers.</li> </ul> <p>You can create a protected branch by using the UI or API only.</p>"},{"location":"chap9/3Gitlab_branch_action/#require-everyone-to-submit-merge-requests-for-a-protected-branch","title":"Require everyone to submit merge requests for a protected branch","text":"<p>You can force everyone to submit a merge request, rather than allowing them to check in directly to a protected branch.</p> <ul> <li>Settings &gt; Repository</li> <li>Expand Protected branches.</li> <li>From the Allowed to merge list, select Developers + Maintainers.</li> <li>From the Allowed to push list, select No one.</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#allow-everyone-to-push-directly-to-a-protected-branch","title":"Allow everyone to push directly to a protected branch","text":"<ul> <li>Settings &gt; Repository.</li> <li>Expand Protected branches.</li> <li>From the Allowed to push list, select Developers + Maintainers.</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#require-code-owner-approval-on-a-protected-branch-premium","title":"Require Code Owner approval on a protected branch \uff08PREMIUM\uff09","text":"<ul> <li>Expand Protected branches.</li> <li>From the Allowed to push and Allowed to merge lists, select the settings you want.</li> <li>To allow all users with push access to force push, turn on the Allowed to force push toggle.</li> <li>To reject code pushes that change files listed in the CODEOWNERS file, turn on the Require approval from code owners toggle</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#3-protected-tags","title":"3 Protected tags","text":"<p>Protected tags:</p> <ul> <li>Allow control over who has permission to create tags.</li> <li>Prevent accidental update or deletion once created.</li> </ul> <p>Each rule allows you to match either:</p>"},{"location":"chap9/3Gitlab_branch_action/#configuring-protected-tags","title":"Configuring protected tags","text":"<ul> <li>Settings &gt; Repository.</li> <li>From the Tag dropdown list, select the tag you want to protect or type and select Create wildcard. In the screenshot below, we chose to protect all tags matching <code>v*</code></li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#wildcard-protected-tags","title":"Wildcard protected tags","text":"Wildcard Protected Tag Matching Tags <code>v*</code> <code>v1.0.0, version-9.1</code> <code>*-deploy</code> <code>march-deploy, 1.0-deploy</code> <code>*gitlab*</code> <code>gitlab, gitlab/v1</code> <code>*</code> <code>v1.0.1rc2, accidental-tag</code> <p>Two different wildcards can potentially match the same tag. For example, <code>*-stable</code> and <code>production-*</code> would both match a <code>production-stable</code> tag.</p> <p>In that case, if any of these protected tags have a setting like Allowed to create, then <code>production-stable</code> also inherit this setting.</p> <p>If you select a protected tag\u2019s name, GitLab displays a list of all matching tags:</p> <p></p>"},{"location":"chap9/3Gitlab_branch_action/#push-rules","title":"Push rules","text":"<p>Push rules give you more control over what can and can\u2019t be pushed to your repository. While GitLab offers protected branches, you may need more specific rules, such as:</p> <ul> <li>Evaluating the contents of a commit.</li> <li>Confirming commit messages match expected formats.</li> <li>Enforcing branch name rules.</li> <li>Evaluating the details of files.</li> <li>Preventing Git tag removal.</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#enable-global-push-rules","title":"Enable global push rules","text":"<p>You can create push rules for all new projects to inherit, but they can be overridden at the project level or the group level. All projects created after you configure global push rules inherit this configuration.</p> <p>Prerequisite:</p> <p>You must be an administrator.</p>"},{"location":"chap9/3Gitlab_branch_action/#override-global-push-rules-per-project","title":"Override global push rules per project","text":"<p>The push rule of an individual project overrides the global push rule.</p> <p>To override global push rules for a specific project, or to update the rules for an existing project to match new global push rules:</p>"},{"location":"chap9/3Gitlab_branch_action/#verify-users","title":"Verify users","text":"<p>Use these rules to validate users who make commits.</p> <ul> <li>Reject unverified users: Users must have a confirmed email address.</li> <li>Check whether the commit author is a GitLab user: The commit author and committer must have an email address that\u2019s been verified by GitLab.</li> <li>Commit author\u2019s email: Both the author\u2019s and committer\u2019s email addresses must match the regular expression. To allow any email address, leave empty.</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#validate-commit-messages","title":"Validate commit messages","text":"<ul> <li>Require expression in commit messages: Messages must match the expression. To allow any commit message, leave empty. Uses multiline mode, which can be disabled by using (?-m).</li> </ul> <p>For example, if every commit should reference a Jira issue (like Refactored css. Fixes JIRA-123.), the regular expression would be JIRA-\\d+.</p> <ul> <li>Reject expression in commit messages: Commit messages must not match the expression. To allow any commit message, leave empty. Uses multiline mode, which can be disabled by using (?-m).</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#validate-branch-names","title":"Validate branch names","text":"<p>To validate your branch names, enter a regular expression for Branch name. To allow any branch name, leave empty.</p> <p>Your default branch is always allowed. Certain formats of branch names are restricted by default for security purposes.</p> <p>Some validation examples:</p> <ul> <li>Branches must start with JIRA-.</li> </ul> <pre><code>`^JIRA-`\n\n</code></pre> <ul> <li>Branches must end with -JIRA.</li> </ul> <pre><code>`-JIRA$`\n</code></pre> <ul> <li>Branches must be between 4 and 15 characters long, accepting only lowercase letters, numbers and dashes.</li> </ul> <pre><code>`^[a-z0-9\\\\-]{4,15}$`\n</code></pre>"},{"location":"chap9/3Gitlab_branch_action/#prevent-unintended-consequences","title":"Prevent unintended consequences","text":"<ul> <li>Reject unsigned commits: Commit must be signed through GPG</li> <li>Do not allow users to remove Git tags with git push: Users cannot use git push to remove Git tags. Users can still delete tags in the UI.</li> </ul>"},{"location":"chap9/3Gitlab_branch_action/#validate-files","title":"Validate files","text":"<ul> <li>Prevent pushing secret files:</li> <li>Prohibited file names: Files that do not exist in the repository must not match the regular expression</li> <li>Maximum file size: Added or updated files must not exceed this file size (in MB)</li> </ul>"},{"location":"chap9/4gitlab_project/","title":"L4 GitLab Project Management: Agile Planning with GitLab","text":""},{"location":"chap9/4gitlab_project/#agile-planning-with-gitlab","title":"Agile planning with GitLab","text":"<p>Large enterprises have adopted Agile at enterprise scale through a variety of frameworks, including Scaled Agile Framework (SAFe), Spotify, and Large Scale Scrum (LeSS).</p> <p>GitLab enables teams to apply Agile practices and principles to organize and manage their work, whatever their chosen methodology.</p>"},{"location":"chap9/4gitlab_project/#gitlab-benefits","title":"GitLab Benefits","text":"<p>As a single application for the complete DevOps lifecycle, GitLab is:</p> <ul> <li>Seamless: GitLab supports collaboration and visibility for Agile teams</li> <li>From planning to deployment and beyond</li> <li>With a single user experience and a common set of tools.</li> <li>Integrated: Manage projects in the same system where you perform your work.</li> <li>Scalable: Organize multiple Agile teams to achieve enterprise Agile scalability.</li> <li>Flexible: Customize out-of-the-box functionality to the needs of your methodology, whether you\u2019re rolling your own flavor of Agile or adopting a formal framework.</li> <li>Easy to learn: See our Quick Start guide on setting up Agile teams.</li> </ul>"},{"location":"chap9/4gitlab_project/#3-manage-agile-projects","title":"3 Manage Agile projects","text":"<p>GitLab enables lean and Agile project management from basic issue tracking to Scrum and Kanban-style project management. Whether you\u2019re simply tracking a few issues or managing the complete DevOps lifecycle across a team of developers, GitLab has your team covered.</p> <ul> <li>Plan, assign, and track with issues.</li> <li>Organize work with labels , iterations and milestones.</li> <li>Visualize work with boards.</li> <li>Correlate work with output using merge requests\u3001</li> </ul>"},{"location":"chap9/4gitlab_project/#4-mapping-agile-artifacts-to-gitlab-features","title":"4 Mapping Agile artifacts to GitLab features","text":"Agile artifact GitLab feature User story Issues Task Task lists Epic Epics Points and estimation Weights Product backlog Issue lists and prioritized labels Sprint/iteration Milestones Burndown chart Burndown charts Agile board Issue boards"},{"location":"chap9/4gitlab_project/#features","title":"Features","text":"<ul> <li>Issues: Start with an issue that captures a single feature that delivers business value for users.</li> <li>Tasks: Often, a user story is further separated into individual tasks. You can create a task list within an issue\u2019s description in GitLab, to further identify those individual tasks.</li> <li>Issue boards: Everything is in one place. Track issues and communicate progress without switching between products. One interface to follow your issues from backlog to done.</li> <li>Epics: Manage your portfolio of projects more efficiently and with less effort by tracking groups of issues that share a theme, across projects and milestones with epics.</li> <li>Milestones: Track issues and merge requests created to achieve a broader goal in a certain period of time with GitLab milestones.</li> <li>Roadmaps: Start date and/or due date can be visualized in a form of a timeline. The epics roadmap page shows such a visualization for all the epics which are under a group and/or its subgroups.</li> <li>Labels: Create and assigned to individual issues, which then allows you to filter the issue lists by a single label or multiple labels.</li> <li>Burndown Chart: Track work in real time, and mitigate risks as they arise. Burndown charts allow teams to visualize the work scoped in a current sprint as they are being completed.</li> <li>Points and Estimation: Indicate the estimated effort with issues by assigning weight attributes and indicate estimated effort</li> <li>Collaboration: The ability to contribute conversationally is offered throughout GitLab in issues, epics, merge requests, commits, and more!</li> <li>Traceability: Align your team\u2019s issues with subsequent merge requests that give you complete traceability from issue creation to end once the related pipeline passes.</li> <li>Wikis: A system for documentation called Wiki, if you are wanting to keep your documentation in the same project where your code resides.</li> <li>Enterprise Agile Frameworks: Large enterprises have adopted Agile at enterprise scale using a variety of frameworks. GitLab can support SAFe, Spotify, Disciplined Agile Delivery and more.</li> </ul>"},{"location":"chap9/4gitlab_project/#an-agile-iteration-with-gitlab","title":"An Agile iteration with GitLab","text":""},{"location":"chap9/4gitlab_project/#projects","title":"Projects","text":"<p>GitLab projects are used to organize your work and host your codebase. You can create a project to track issues, plan work, collaborate on code, and continuously build, test, and use built-in CI/CD to deploy your app.</p> <p>Projects can be made available publicly, internally, or privately, with no limit on the number of private projects that can be created.</p> <p></p>"},{"location":"chap9/4gitlab_project/#groups","title":"Groups","text":"<p>In order to manage multiple projects (portfolios of projects), the GitLab Group is the entity that enables strategic planning and tracking of business initiatives through delivery.</p> <p>At the Group Level, you can manage sub-groups, projects, epics, milestones, roadmaps and group level boards.</p> <p></p>"},{"location":"chap9/4gitlab_project/#user-stories-gitlab-issues","title":"User stories \u2192 GitLab issues","text":"<p>The issue in Gitlab is the fundamental planning object.</p> <p>It is where the team documents the use case in the description, discusses the approach, estimates the size/effort (issue weight), tracks actual time/effort, assigns work, and tracks progress. Labels enable the team to tag issues, track status, and associate issues with different initiatives.</p> <p>You can use issues for many purposes, customized to your needs and workflow.</p> <ul> <li>Discuss the implementation of an idea.</li> <li>Track tasks and work status.</li> <li>Accept feature proposals, questions, support requests, or bug reports.</li> <li>Elaborate on code implementations.</li> </ul> <p>When creating an issue you can set its due dates, importance, confidentiality, dependencies on other issues, link it to another issue, and add task lists.</p> <p>You can also create issues via email to receive issue tickets from people without access to your GitLab instance.</p> <p></p> <p></p>"},{"location":"chap9/4gitlab_project/#task-gitlab-task-lists","title":"Task \u2192 GitLab task lists","text":"<p>Often, a user story is further separated into individual tasks. You can create a task list within an issue\u2019s description in GitLab, to further identify those individual tasks.</p> <p></p> <pre><code>- [x] Completed task\n- [ ] Incomplete task\n  - [ ] Sub-task 1\n  - [x] Sub-task 2\n  - [ ] Sub-task 3\n\n1. [x] Completed task\n2. [ ] Incomplete task\n   1. [ ] Sub-task 1\n   2. [x] Sub-task 2\n</code></pre>"},{"location":"chap9/4gitlab_project/#epics-gitlab-epics","title":"Epics \u2192 GitLab epics","text":"<p>In order to track groups of related projects and issues, the GitLab epic gives product owners and leaders the ability to link and manage work over an extended time frame. An epic can span multiple milestones and makes it easier to manage the overall flow and priority of work.</p> <p>GitLab epics allow you to group issues that share a common theme across projects and milestones; this enables you to manage your portfolio of projects more efficiently.</p> <p>Example epics could include Security, GraphQL upgrades, or User Onboarding.</p> <p>GitLab recommends using epics for the following scenarios:</p> <ul> <li>When your team is working on a large feature involving multiple discussions in different issues on different projects in a group.</li> <li>To track when work for a group of issues is targeted to begin and end.</li> <li>To discuss and collaborate on feature ideas and scope at a high level.</li> </ul> <p></p>"},{"location":"chap9/4gitlab_project/#labels","title":"Labels","text":"<p>GitLab labels make it easier to keep track of your issues and projects within GitLab, especially as your organization grows and you use GitLab for longer.</p> <p>Labels allow you to tag your work in a flexible way, which allows you to easily track and find items you\u2019re interested in.</p> <p>GitLab recommends these use cases for labels:</p> <ul> <li>Categorize epics, issues, and merge requests using colors and descriptive titles like bug, feature request, or docs.</li> <li>Dynamically filter and manage epics, issues, and merge requests.</li> <li>Search lists of issues, merge requests, and epics\u2014as well as issue boards.</li> </ul> <p></p>"},{"location":"chap9/4gitlab_project/#points-and-estimation-gitlab-issue-weights","title":"Points and estimation \u2192 GitLab issue weights","text":"<p>Also in this meeting, user stories are communicated, and the level of technical effort is estimated for each in-scope user story. In GitLab, issues have a weight attribute, which you would use to indicate the estimated effort.</p> <p>In this meeting (or in subsequent ones), user stories are further broken down to technical deliverables, sometimes documenting technical plans and architecture.</p> <p>In GitLab, this information can be documented in the issue, or in the merge request description, as the merge request is often the place where technical collaboration happens.</p> <p>During the sprint (GitLab milestone), development team members pick up user stories to work on, one by one.</p> <p>In GitLab, issues have assignees. So you would assign yourself to an issue to reflect that you are now working on it. We\u2019d recommend that you create an empty and linked-to-issue merge request right away to start the technical collaboration process, even before creating a single line of code.</p> <p></p>"},{"location":"chap9/4gitlab_project/#product-backlog-gitlab-issue-lists-and-prioritized-labels","title":"Product backlog \u2192 GitLab issue lists and prioritized labels","text":"<p>Issue lists and prioritized labels</p> <p>The product or business owners typically create these user stories to reflect the needs of the business and customers. They are prioritized in a product backlog to capture urgency and desired order of development.</p> <p>The product owner communicates with stakeholders to determine the priorities and constantly refines the backlog. In GitLab, there are dynamically generated issue lists which users can view to track their backlog. Labels can be created and assigned to individual issues, which then allows you to filter the issue lists by a single label or multiple labels. This allows for further flexibility. Priority labels can even be used to also order the issues in those lists.</p>"},{"location":"chap9/4gitlab_project/#sprintiteration-milestones","title":"Sprint/iteration \u2192 Milestones","text":"<p>While milestones at the project level often align to sprints, at the group level, milestones can be created for all the projects and sub-groups within the group. This way, teams can stay in synch with each other and focus on common release targets.</p> <p>In practice, you give a milestone a title, with an optional start date and optional due date. Milestones can be used to track Agile sprints or releases.</p> <p></p>"},{"location":"chap9/4gitlab_project/#burndown-charts","title":"Burndown Charts","text":"<p>GitLab burndown charts allow you to see your completion progress of a milestone.</p> <p>GitLab plots this for you in a clear and well-presented chart. You will be able to track your work in real-time and identify any risk of delays much earlier.</p> <p></p>"},{"location":"chap9/4gitlab_project/#agile-board","title":"Agile board","text":"<p>A GitLab board allows you to organize a workflow your team can use to easily manage their work.</p> <p>Boards show you the issues being worked on, who is assigned to each issue, and where issues are in the workflow.</p> <p>On your board, issues appear as cards in vertical lists which teams can move across lanes to reflect where work currently is in the workflow. Boards work seamlessly with Scrum and Kanban methodologies, and multiple boards can be created within the same project.</p> <p></p>"},{"location":"chap9/4gitlab_project/#roadmaps","title":"Roadmaps","text":"<p>A roadmap visualizes upcoming work in your product development workflow. They allow everyone to have the same understanding and improve communication for projects currently in progress.</p> <p>Teams use roadmaps to outline future product functionality, as well as the release of new features.</p> <p>GitLab\u2019s roadmap displays epics and milestones in a group containing a start date or due date\u2014visualized in the form of a timeline. On each epic in the roadmap, you can view the epic\u2019s title, start date, due date, and completed weight percentage.</p> <p></p>"},{"location":"chap9/4gitlab_project/#wikis","title":"Wikis","text":"<p>GitLab\u2019s wiki is a documentation tool that allows you to keep documentation in the same project as your codebase. Each GitLab project has its own wiki. Every wiki is a separate Git repository, so you can create wiki pages in the web interface, or locally using Git. Agile teams can also use a wiki to store their cycle\u2019s retrospective meetings history.</p>"},{"location":"chap9/4gitlab_project/#traceability","title":"Traceability","text":"<p>GitLab provides automated linking of issues to the current state of your code through merge requests where developers implement and deliver the code changes. This is a powerful project management feature for visibility.</p> <p>In the description of a merge request, developers can link to an issue using its ID. They can then use helpers that let GitLab know the merge request is part of the work for the issue. Alternatively, it could be the final piece of work required and the issue will automatically close once the merge request is released. This automated project management ensures boards are always reflecting work progress accurately.</p> <p></p>"},{"location":"chap9/4gitlab_project/#merge-request","title":"Merge Request","text":"<p>The Merge Request is the linkage between the issue and the actual code changes. The merge request captures the design, implementation details (code changes), discussions (code reviews), approvals, testing (CI Pipeline), and security scans.</p> <p></p>"},{"location":"chap9/4gitlab_project/#larger-organizations","title":"Larger Organizations","text":"<p>GitLab\u2019s project management tools support large organizations too; they can organize multiple Agile teams to achieve enterprise Agile scalability. Scaled Agile methodologies that large organizations might be using include: Scaled Agile Framework (SAFe), Spotify, Disciplined Agile Delivery , and more. All of these can be supported with GitLab\u2019s project management solutions.</p>"},{"location":"chap9/5git-commit/","title":"L5 Using Git Commit Message Templates","text":""},{"location":"chap9/5git-commit/#template-file","title":"Template File","text":"<p>Here is my template*, which i put in a file called <code>.gitmessage</code> in my home directory:</p> <pre><code># Title: Summary, imperative, start upper case, don't end with a period\n# No more than 50 chars. #### 50 chars is here:  #\n\n# Remember blank line between title and body.\n\n# Body: Explain *what* and *why* (not *how*). Include task ID (Jira issue).\n# Wrap at 72 chars. ################################## which is here:  #\n\n\n# At the end: Include Co-authored-by for all contributors. \n# Include at least one empty line before it. Format: \n# Co-authored-by: name &lt;user@users.noreply.github.com&gt;\n#\n# How to Write a Git Commit Message:\n# https://chris.beams.io/posts/git-commit/\n#\n# 1. Separate subject from body with a blank line\n# 2. Limit the subject line to 50 characters\n# 3. Capitalize the subject line\n# 4. Do not end the subject line with a period\n# 5. Use the imperative mood in the subject line\n# 6. Wrap the body at 72 characters\n# 7. Use the body to explain what and why vs. how\n</code></pre>"},{"location":"chap9/5git-commit/#git-configuration","title":"Git Configuration","text":"<p>To tell Git to use the template file (globally, not just in the current repo), I used the following command:</p> <pre><code>git config --global commit.template ~/.gitmessage\n</code></pre>"},{"location":"chap9/5git-commit/#git-push-rule","title":"Git push rule","text":"<pre><code>^(feature|hotfix)\\/(([a-z,A-Z]+))(-)(\\d*)(:)([a-z,0\u20139])\n</code></pre> <pre><code>e.g. feature/JIR-124:test commit message\n</code></pre> <pre><code>(^(I|i)ssue)(-)(\\d*)(:)([a-z,0\u20139])\n\n(^(I|i)ssue)(-)(\\d*)(:)\\/*\n</code></pre> <p>Merge Request Template: </p> <pre><code>- **[Project-name(exp: FA|PFM)] - [Issue No.] :** [commit summay]&lt;br /&gt;\n- **Issue ID:**\n- **What and how:**[high level overview of the implementation]&lt;br /&gt;\n- **Reviewed by:** [name(s)]&lt;br /&gt;\n- **QA Validate:** [Whether the code is pass the QA test]&lt;br /&gt;\n- **Related Info:** [Is there any other info related like similar external tickets, commit]&lt;br /&gt;\n- **Possible Impact:** [does the change have impact on other modules]&lt;br /&gt;\n- **Testing Suggestion:** [Add if there is]&lt;br /&gt;\n</code></pre>"}]}